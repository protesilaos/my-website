---
layout: page
title: 'GNU Emacs configuration'
subtitle: 'An advanced literate configuration that produces modular code'
excerpt: "Protesilaos Stavrou's customisations for Emacs. These contribute to a consistent computing experience on top of GNU/Linux."
permalink: /emacs/dotemacs
redirect_from:
  - /dotemacs
---

<p>
<b>Last revised and exported on 2025-01-30 10:45:47 +0200 with a word
count of 106369.</b>
</p>

<p>
This is my literate Emacs configuration file. It is a combination of
prose and code. You can either read this page or check my dotfiles to
find everything related to my Emacs setup.
</p>

<p>
What you are now reading is not a common literate configuration of
Emacs. In most such cases, you have a generic <code>init.el</code> with a call to
the <code>org-babel-load-file</code> function that gets an Org document as its
value. That method works but is very slow, because we have to load Org
before starting Emacs (and Org loads a bunch of other things we do not
need at such an early stage).
</p>

<p>
Whereas this Org document serves as (i) a single point of entry to my
Emacs setup and (ii) the origin of all of my Emacs configurations.
While I am defining everything in a single Org file, I am not actually
starting Emacs by reading this file. Rather, I am instructing Org to
put the code blocks defined herein in standalone files, organised by
scope. The end result is something where you cannot tell whether a
literate program was executed or not.
</p>

<p>
This is the beauty of it. I can keep editing a single file as the
&ldquo;source of truth&rdquo;, though I can still handle each of the files
individually (e.g. someone wants to see how I do a specific thing, so
I share only that file as an email attachment&#x2014;no need to send over
this massive document).
</p>

<p>
When I want to modify my Emacs setup, I edit this file and then
evaluate the following code block or do <code>C-c C-v C-t</code>. All files will
be updated accordingly.
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(org-babel-tangle)
</pre>
</div>

<p>
Note that I always build Emacs from source because I maintain lots of
packages and need to be on the bleeding edge (<a href="#h:64c1c9f5-1218-4ff3-8e35-41e56c74f038">Details of my Emacs build</a>).
This means that my code may not necessarily work with your version of
Emacs.
</p>

<ul class="org-ul">
<li>Website: <a href="https://protesilaos.com/emacs/dotemacs">https://protesilaos.com/emacs/dotemacs</a></li>
<li>Git repositories:
<ul class="org-ul">
<li>GitHub: <a href="https://github.com/protesilaos/dotfiles">https://github.com/protesilaos/dotfiles</a></li>
<li>GitLab: <a href="https://gitlab.com/protesilaos/dotfiles">https://gitlab.com/protesilaos/dotfiles</a></li>
</ul></li>
<li>Video demo: <a href="https://protesilaos.com/codelog/2023-12-18-emacs-org-advanced-literate-conf/">https://protesilaos.com/codelog/2023-12-18-emacs-org-advanced-literate-conf/</a></li>
<li>Backronyms: Do Observe, Transpose, Examine, or Mirror All
Configurations, Stranger (dotemacs); Dotfiles Operate Transparently
For the Included Linux and Emacs Setups (dotfiles).</li>
</ul>

<div id="table-of-contents" role="doc-toc">
<h2>Table of Contents</h2>
<div id="text-table-of-contents" role="doc-toc">
<ul>
<li><a href="#h:64c1c9f5-1218-4ff3-8e35-41e56c74f038">1. Details of my Emacs build</a></li>
<li><a href="#h:103d6f5a-bdb1-4b49-946a-708a83c79a7d">2. Anatomy of my Emacs configuration</a></li>
<li><a href="#h:7b7b5898-09f7-4128-8af0-4041f67cb729">3. The early initialisation of Emacs (<code>early-init.el</code>)</a>
<ul>
<li><a href="#h:1e1b1503-0952-43f9-8bfe-4252fe874cd1">3.1. The <code>early-init.el</code> macro to run code only in a Desktop Environment</a></li>
<li><a href="#h:0403b581-142b-4613-bc81-51c5dccd831d">3.2. The <code>early-init.el</code> code to set frame parameters</a></li>
<li><a href="#h:a1288a07-93f6-4e14-894e-707d5ad8b6dc">3.3. The <code>early-init.el</code> basic frame settings</a></li>
<li><a href="#h:50d28f3c-3ada-4db5-b830-bbbbee7fec4e">3.4. The <code>early-init.el</code> tweaks to startup time and garbage collection</a></li>
<li><a href="#h:7a037504-8a2f-4df0-8482-ce6476354440">3.5. The <code>early-init.el</code> initialises the package cache</a></li>
<li><a href="#h:7d3a283e-1595-4692-8124-e0d683cb15b2">3.6. The <code>early-init.el</code> defines general theme-related functions</a></li>
<li><a href="#h:a18a059d-4e62-4fd7-8c0b-1135a771a7aa">3.7. The <code>early-init.el</code> takes care to avoid the initial flash of light</a></li>
<li><a href="#h:ad227f7e-b0a7-43f8-91d6-b50db82da9ad">3.8. The <code>early-init.el</code> gives a name to the default frame</a></li>
</ul>
</li>
<li><a href="#h:dae63bd9-93a8-41c4-af1b-d0f39ba50974">4. The main initialisation of Emacs (<code>init.el</code>)</a>
<ul>
<li><a href="#h:5a41861f-4c38-45ac-8da2-51d77c0b4a73">4.1. The <code>init.el</code> user options</a>
<ul>
<li><a href="#h:5612b5b8-45a5-4a79-a25b-6fa3d9146c39">4.1.1. The <code>init.el</code> user option to load a theme family</a></li>
<li><a href="#h:f012a254-2716-4c29-a64b-c2b3df34f57f">4.1.2. The <code>init.el</code> user option to load a minibuffer user interface</a></li>
<li><a href="#h:91477890-49d5-48c3-9627-62295d2ab35d">4.1.3. The <code>init.el</code> user option to load extras for minibuffer completion</a></li>
<li><a href="#h:32703a47-edff-47a8-b275-3cb5b9f9e244">4.1.4. The <code>init.el</code> user option to load treesitter extras</a></li>
<li><a href="#h:24324854-1f8c-4d8b-aa7c-291de968cbf4">4.1.5. The <code>init.el</code> user option to enable <code>which-key</code></a></li>
<li><a href="#h:a75444e3-527e-4525-84f8-0a43771966a6">4.1.6. The <code>init.el</code> user option to load icons (<code>nerd-icons.el</code>)</a></li>
</ul>
</li>
<li><a href="#h:63d74507-0318-4c02-ad30-484abcb8f78e">4.2. The <code>init.el</code> basic configurations to disable backups and lockfiles</a></li>
<li><a href="#h:3563ceb5-b70c-4191-9c81-f2f5a202c4da">4.3. The <code>init.el</code> tweaks to make native compilation silent</a></li>
<li><a href="#h:f2ffe0e9-a58d-4bba-9831-cc35940ea83f">4.4. The <code>init.el</code> setting to send <code>custom-file</code> to oblivion</a></li>
<li><a href="#h:805e0539-c46d-4f03-b152-cefc635f945c">4.5. The <code>init.el</code> settings for multilingual editing (input methods)</a></li>
<li><a href="#h:4ed6593f-6f55-4258-a1c2-ddb50e9e2465">4.6. The <code>init.el</code> settings to enable certain commands and disable others</a></li>
<li><a href="#h:96878899-f712-4900-8ee1-de8c40a634ce">4.7. The <code>init.el</code> setting to always start with the <code>*scratch*</code> buffer</a></li>
<li><a href="#h:e289a614-4f17-4d6c-a028-42fe45aebe66">4.8. The <code>init.el</code> arrangements for my own modules and custom libraries</a></li>
<li><a href="#h:424340cc-f3d7-4083-93c9-d852d40dfd40">4.9. The <code>init.el</code> settings for packages (<code>package.el</code>)</a></li>
<li><a href="#h:00213452-3671-4de6-b4ce-ca1b65f79413">4.10. The <code>init.el</code> option to declare all themes as safe</a></li>
<li><a href="#h:3b14faa6-83fd-4d5f-b3bc-85f72fd572d4">4.11. The <code>init.el</code> macro to do nothing with Elisp code (<code>prot-emacs-comment</code>)</a></li>
<li><a href="#h:d3684ec0-a972-4033-a4d6-41ee16e891d9">4.12. The <code>init.el</code> macro to bind keys (<code>prot-emacs-keybind</code>)</a></li>
<li><a href="#h:e7a12825-7848-42bd-b99b-b87903012814">4.13. The <code>init.el</code> macro to define abbreviations (<code>prot-emacs-abbrev</code>)</a></li>
<li><a href="#h:d168edaa-426f-4bd0-8275-3ec3d66bf126">4.14. The <code>init.el</code> addition of highlighting for my macros</a></li>
<li><a href="#h:e6c4acf5-5b51-4b38-a86a-bf3f698ac872">4.15. The <code>init.el</code> final part to load the individual modules</a></li>
</ul>
</li>
<li><a href="#h:dc3e88c8-4def-4a3f-b63c-9e845b0f98ef">5. The modules of my Emacs configuration</a>
<ul>
<li><a href="#h:8cf67c82-1ebb-4be8-b0e7-161bbf5419ce">5.1. The <code>prot-emacs-theme.el</code> module</a>
<ul>
<li><a href="#h:3f1a33e4-762e-4cf3-a0ae-4c2954d9cbb8">5.1.1. The <code>prot-emacs-theme.el</code> section to load a theme (<code>prot-emacs-load-theme-family</code>)</a>
<ul>
<li><a href="#h:36af519a-67e1-42b6-a38a-2052638108f9">5.1.1.1. The <code>prot-emacs-modus-themes.el</code> module</a></li>
<li><a href="#h:2b2a27a1-6d2e-4b59-bf60-94682e173f2f">5.1.1.2. The <code>prot-emacs-ef-themes.el</code> module</a></li>
<li><a href="#h:0c7a240c-211f-4571-a5ba-433e510f487f">5.1.1.3. The <code>prot-emacs-standard-themes.el</code> module</a></li>
</ul>
</li>
<li><a href="#h:7f2b317d-a70e-44e6-a93c-fa4c4b4b8e2e">5.1.2. The <code>prot-emacs-theme.el</code> section for <code>pulsar</code></a></li>
<li><a href="#h:bf5b4d08-8f33-4a8c-8ecd-fca19bf2497a">5.1.3. The <code>prot-emacs-theme.el</code> section for <code>lin</code></a></li>
<li><a href="#h:6c118185-fcb1-4c9a-93af-71814cb84279">5.1.4. The <code>prot-emacs-theme.el</code> section for <code>spacious-padding</code></a></li>
<li><a href="#h:9438236e-a8a4-45e0-8c61-8268c634d50b">5.1.5. The <code>prot-emacs-theme.el</code> section for <code>rainbow-mode</code></a></li>
<li><a href="#h:34ce98fe-0b57-44d9-b5f3-0224632114a5">5.1.6. The <code>prot-emacs-theme.el</code> section for <code>cursory</code></a></li>
<li><a href="#h:2af10314-c8c2-4946-bf9c-a5b0f5fe881b">5.1.7. The <code>prot-emacs-theme.el</code> section for <code>theme-buffet</code></a></li>
<li><a href="#h:cb41fef0-41a5-4a85-9552-496d96290258">5.1.8. The <code>prot-emacs-theme.el</code> section about <code>fontaine</code></a></li>
<li><a href="#h:60a005be-77bd-49f1-a865-78d7cf75bd2a">5.1.9. The <code>prot-emacs-theme.el</code> section about <code>show-font</code></a></li>
<li><a href="#h:60d6aae2-6e4b-402c-b6a8-411fc49a6857">5.1.10. The <code>prot-emacs-theme.el</code> section about <code>variable-pitch-mode</code> and font resizing</a>
<ul>
<li><a href="#h:3b989679-7e3f-4f03-b4bb-611006ea01ce">5.1.10.1. Information about my Iosevka Comfy fonts</a></li>
</ul>
</li>
<li><a href="#h:bac0ce0a-db68-42e7-ba2c-f350f91f80ef">5.1.11. The <code>prot-emacs-theme.el</code> call to <code>provide</code></a></li>
</ul>
</li>
<li><a href="#h:0ef52ed9-7b86-4329-ae4e-eff9ab8d07f2">5.2. The <code>prot-emacs-essentials.el</code> module</a>
<ul>
<li><a href="#h:713ede33-3802-40c6-a8e3-7e1fc0d0a924">5.2.1. The <code>prot-emacs-essentials.el</code> block with basic configurations</a></li>
<li><a href="#h:116854fa-2e31-4d23-ae6f-72f57ed571bc">5.2.2. The <code>prot-emacs-essentials.el</code> section about <code>prot-common.el</code> (custom basic functions)</a></li>
<li><a href="#h:f15bc843-2dd1-4792-95ec-9b7b6e561804">5.2.3. The <code>prot-emacs-essentials.el</code> section about <code>prot-simple.el</code> (custom basic commands)</a></li>
<li><a href="#h:45b4fffa-2ce3-4119-b8c9-081a75135d98">5.2.4. The <code>prot-emacs-essentials.el</code> section about <code>prot-scratch.el</code> (scratch buffer per major mode)</a></li>
<li><a href="#h:48d2bab5-241f-49dd-9554-8a4dcedce75e">5.2.5. The <code>prot-emacs-essentials.el</code> section about <code>prot-pair.el</code> (insert character pairs)</a></li>
<li><a href="#h:85755648-bf1f-408b-bc65-4db357fbf1dd">5.2.6. The <code>prot-emacs-essentials.el</code> section for comments</a></li>
<li><a href="#h:15ad94b3-f714-4b39-973e-b68c76b38be3">5.2.7. The <code>prot-emacs-essentials.el</code> section about <code>prot-prefix.el</code> (prefix nested keymaps)</a></li>
<li><a href="#h:f9aa7523-d88a-4080-add6-073f36cb8b9a">5.2.8. The <code>prot-emacs-essentials.el</code> configuration to track recently visited files</a></li>
<li><a href="#h:982ad7cd-01b9-4178-be58-0e24251d3608">5.2.9. The <code>prot-emacs-essentials.el</code> mouse configurations</a></li>
<li><a href="#h:fbe6f9da-25ee-46a3-bb03-8fa7c1d48dab">5.2.10. The <code>prot-emacs-essentials.el</code> settings for <code>repeat-mode</code></a></li>
<li><a href="#h:581aa0ff-b136-4099-a321-3b86edbfbccb">5.2.11. The <code>prot-emacs-essentials.el</code> settings for bookmarks</a></li>
<li><a href="#h:5685df62-4484-42ad-a062-d55ab19022e3">5.2.12. The <code>prot-emacs-essentials.el</code> settings for registers</a></li>
<li><a href="#h:7753549e-806d-4140-b72d-5460a4a14b3e">5.2.13. The <code>prot-emacs-essentials.el</code> settings for auto revert</a></li>
<li><a href="#h:d551b90d-d730-4eb5-976a-24b010fd4db3">5.2.14. The <code>prot-emacs-essentials.el</code> section for <code>delete-selection-mode</code></a></li>
<li><a href="#h:26afeb95-7920-45ed-8ff6-3648256c280b">5.2.15. The <code>prot-emacs-essentials.el</code> settings for tooltips</a></li>
<li><a href="#h:d4e30bcb-2f90-445f-a5ca-856e2576483a">5.2.16. The <code>prot-emacs-essentials.el</code> configurations for the date and time (<code>display-time-mode</code>)</a></li>
<li><a href="#h:42866cf3-d6ad-4431-b321-204f91e17d72">5.2.17. The <code>prot-emacs-essentials.el</code> settings for the <code>world-clock</code></a></li>
<li><a href="#h:5eb16d63-ce21-4e76-8789-eef6ddbd7c00">5.2.18. The <code>prot-emacs-essentials.el</code> settings for manpages</a></li>
<li><a href="#h:14d40e5a-327e-453e-861c-3ece24351d62">5.2.19. The <code>prot-emacs-essentials.el</code> settings for <code>proced</code></a></li>
<li><a href="#h:7709b7e9-844f-49f3-badf-784aacec4bca">5.2.20. The <code>prot-emacs-essentials.el</code> arrangement to run Emacs as a server</a></li>
<li><a href="#h:b4b3c8b7-e35c-4a56-bfb9-0c8bb33b2423">5.2.21. The <code>prot-emacs-essentials.el</code> section about <code>substitute</code></a></li>
<li><a href="#h:1cbb0a14-a2d4-49d1-88e9-688115445810">5.2.22. The <code>prot-emacs-essentials.el</code> section about <code>goto-chg</code> (go to change)</a></li>
<li><a href="#h:ceb193bf-0de3-4c43-8ab7-6daa50817754">5.2.23. The <code>prot-emacs-essentials.el</code> section about <code>expreg</code> (tree-sitter mark syntactically)</a></li>
<li><a href="#h:6dce278e-86c7-4620-9271-d5af5499f0cc">5.2.24. The <code>prot-emacs-essentials.el</code> section about <code>tmr</code> (set timers)</a></li>
<li><a href="#h:aac21cc5-19eb-4a6c-a8ab-01b829df0d64">5.2.25. The <code>prot-emacs-essentials.el</code> section about <code>password-store</code></a></li>
<li><a href="#h:7c25e281-d92e-4605-b5d6-18fe1f280a73">5.2.26. The <code>prot-emacs-essentials.el</code> section about <code>shell</code></a></li>
<li><a href="#h:080aa291-95b4-4d54-8783-d156b13190e9">5.2.27. The <code>prot-emacs-essentials.el</code> section about the laptop-specific settings</a></li>
<li><a href="#h:c8b2f021-fe5a-4f6b-944c-20340f764fb2">5.2.28. The <code>prot-emacs-essentials.el</code> call to <code>provide</code></a></li>
</ul>
</li>
<li><a href="#h:41ee38d0-9099-4444-85e4-cc8dce00fb9a">5.3. The <code>prot-emacs-modeline.el</code> module</a>
<ul>
<li><a href="#h:ba833ed8-f9d4-4693-bfd5-30452167137e">5.3.1. The <code>prot-emacs-modeline.el</code> section about <code>keycast</code></a></li>
<li><a href="#h:be07591f-6130-4641-9f06-a634f21bb2f6">5.3.2. The <code>prot-emacs-essentials.el</code> call to <code>provide</code></a></li>
</ul>
</li>
<li><a href="#h:15edf2c3-4419-4101-928a-6e224958a741">5.4. The <code>prot-emacs-completion.el</code> module</a>
<ul>
<li><a href="#h:14b09958-279e-4069-81e3-5a16c9b69892">5.4.1. The <code>prot-emacs-completion.el</code> settings for completion styles</a></li>
<li><a href="#h:7cc77fd0-8f98-4fc0-80be-48a758fcb6e2">5.4.2. The <code>prot-emacs-completion.el</code> for the <code>orderless</code> completion style</a></li>
<li><a href="#h:7fe1787d-dba3-46fe-82a9-5dc5f8ea6217">5.4.3. The <code>prot-emacs-completion.el</code> settings to ignore letter casing</a></li>
<li><a href="#h:4299825a-db51-49fe-b415-fb1749eed289">5.4.4. The <code>prot-emacs-completion.el</code> settings for recursive minibuffers</a></li>
<li><a href="#h:aebbdd4c-6e5b-4773-9f0a-c69f0d3c7158">5.4.5. The <code>prot-emacs-completion.el</code> settings for default values</a></li>
<li><a href="#h:b640f032-ad11-413e-ad8f-63408671d500">5.4.6. The <code>prot-emacs-completion.el</code> settings for common interactions</a></li>
<li><a href="#h:de61a607-0bdf-462b-94cd-c0898319590e">5.4.7. The <code>prot-emacs-completion.el</code> generic minibuffer UI settings</a></li>
<li><a href="#h:25765797-27a5-431e-8aa4-cc890a6a913a">5.4.8. The <code>prot-emacs-completion.el</code> settings for saving the history (<code>savehist-mode</code>)</a></li>
<li><a href="#h:567bb00f-1d82-4746-93e5-e0f60721728a">5.4.9. The <code>prot-emacs-completion.el</code> settings for dynamic text expansion (<code>dabbrev</code>)</a></li>
<li><a href="#h:fd84b79a-351e-40f0-b383-bf520d77834b">5.4.10. The <code>prot-emacs-completion.el</code> settings for static text expansion (<code>abbrev</code>)</a></li>
<li><a href="#h:804b858f-7913-47ef-aaf4-8eef5b59ecb4">5.4.11. The <code>prot-emacs-completion.el</code> for in-buffer completion popup (<code>corfu</code>)</a></li>
<li><a href="#h:22e97b4c-d88d-4deb-9ab3-f80631f9ff1d">5.4.12. The <code>prot-emacs-completion.el</code> settings for <code>consult</code></a></li>
<li><a href="#h:61863da4-8739-42ae-a30f-6e9d686e1995">5.4.13. The <code>prot-emacs-completion.el</code> section about <code>embark</code></a></li>
<li><a href="#h:bd3f7a1d-a53d-4d3e-860e-25c5b35d8e7e">5.4.14. The <code>prot-emacs-completion.el</code> section to configure completion annotations (<code>marginalia</code>)</a></li>
<li><a href="#h:db620e44-fc8f-45b8-a7fd-ae1d0b7ce86c">5.4.15. The <code>prot-emacs-completion.el</code> setting to load a minibuffer UI submodule</a>
<ul>
<li><a href="#h:e9fb09f0-f2e6-4943-83bf-e5fadcfa530a">5.4.15.1. The <code>prot-emacs-completion.el</code> submodule for <code>mct</code> (<code>prot-emacs-mct.el</code>)</a></li>
<li><a href="#h:cff33514-d3ac-4c16-a889-ea39d7346dc5">5.4.15.2. The <code>prot-emacs-completion.el</code> submodule for <code>vertico</code> (<code>prot-emacs-vertico.el</code>)</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#h:e0f9c30e-3a98-4479-b709-7008277749e4">5.5. The <code>prot-emacs-search.el</code> module</a>
<ul>
<li><a href="#h:95947b37-2071-4ee7-a201-8e19bf3322e9">5.5.1. The <code>prot-emacs-search.el</code> on isearch lax space</a></li>
<li><a href="#h:ed1307e7-f8a0-4b0a-8d91-2de9c1e2479c">5.5.2. The <code>prot-emacs-search.el</code> settings for isearch highlighting</a></li>
<li><a href="#h:acfdc17f-7ffb-48d3-90ff-49bd00463934">5.5.3. The <code>prot-emacs-search.el</code> on isearch match counter</a></li>
<li><a href="#h:e6fd4ff0-86c7-423b-9cf3-0a9061505136">5.5.4. The <code>prot-emacs-search.el</code> tweaks to the isearch motion behaviour</a></li>
<li><a href="#h:85aca4da-b89b-4fbe-89e9-3ec536ad7b0d">5.5.5. The <code>prot-emacs-search.el</code> tweaks for the occur buffer</a></li>
<li><a href="#h:5ce6216d-f318-4191-9d4f-9681c92f7582">5.5.6. The <code>prot-emacs-search.el</code> modified isearch and occur key bindings</a></li>
<li><a href="#h:b902e6a3-cdd2-420f-bc99-3d973c37cd20">5.5.7. The <code>prot-emacs-search.el</code> extras provided by the <code>prot-search.el</code> library</a></li>
<li><a href="#h:ceb286c5-a5f7-4cc8-b883-89d20a75ea02">5.5.8. The <code>prot-emacs-search.el</code> tweaks to <code>xref</code>, <code>re-builder</code> and <code>grep</code></a></li>
<li><a href="#h:9a3581df-ab18-4266-815e-2edd7f7e4852">5.5.9. The <code>prot-emacs-search.el</code> setup for editable grep buffers (<code>grep-edit-mode</code> or <code>wgrep</code>)</a></li>
<li><a href="#h:c8b2f021-fe5a-4f6b-944c-20340f764fb2">5.5.10. The <code>prot-emacs-search.el</code> call to <code>provide</code></a></li>
</ul>
</li>
<li><a href="#h:f8b08a77-f3a8-42fa-b1a9-f940348889c3">5.6. The <code>prot-emacs-dired.el</code> module</a>
<ul>
<li><a href="#h:39fb0eab-54bb-4e5b-8e38-9443dbe5c5ee">5.6.1. The <code>prot-emacs-dired.el</code> settings for common operations</a></li>
<li><a href="#h:679e4460-b306-450f-aa20-497243057e02">5.6.2. The <code>prot-emacs-dired.el</code> switches for <code>ls</code> (how files are listed)</a></li>
<li><a href="#h:8225364c-3856-48bc-bf64-60d40ddd3320">5.6.3. The <code>prot-emacs-dired.el</code> setting for dual-pane Dired</a></li>
<li><a href="#h:d7d5e619-3d50-4d9e-a951-7262462a60c9">5.6.4. The <code>prot-emacs-dired.el</code> settings to open files externally</a></li>
<li><a href="#h:6327e6ba-a468-416f-ad26-b530c32fe235">5.6.5. The <code>prot-emacs-dired.el</code> miscellaneous tweaks</a></li>
<li><a href="#h:6758bf16-e47e-452e-b39d-9d67c2b9aa4b">5.6.6. The <code>prot-emacs-dired.el</code> section about various conveniences</a></li>
<li><a href="#h:933b156a-3be2-4025-96e9-e14687c8dcf1">5.6.7. The <code>prot-emacs-dired.el</code> section about my extras (<code>prot-dired.el</code>)</a></li>
<li><a href="#h:3a4a29bc-3491-4d01-9d64-1cef63b3116a">5.6.8. The <code>prot-emacs-dired.el</code> section about <code>dired-subtree</code></a></li>
<li><a href="#h:1b53bc10-8b1b-4f68-bbec-165909761e43">5.6.9. The <code>prot-emacs-dired.el</code> section about <code>wdired</code> (writable Dired)</a></li>
<li><a href="#h:198cdda8-fc3f-4672-8fd6-dfc795cea9e0">5.6.10. The <code>prot-emacs-dired.el</code> section about <code>image-dired</code></a></li>
<li><a href="#h:c345ff72-d905-482a-a885-fc111252aacf">5.6.11. The <code>prot-emacs-dired.el</code> section about <code>dired-preview</code></a></li>
<li><a href="#h:8a92d9db-b35a-4ec3-8b37-f42a80a67854">5.6.12. The <code>prot-emacs-dired.el</code> section about multimedia previews (<code>ready-player</code>)</a></li>
<li><a href="#h:2e005bd1-d098-426d-91f9-2a31a6e55caa">5.6.13. The <code>prot-emacs-dired.el</code> section about <code>trashed.el</code></a></li>
<li><a href="#h:bdea93a8-f420-400c-ac3a-9663cb10dbd2">5.6.14. The <code>prot-emacs-dired.el</code> section about <code>mandoura</code> (<code>mpv</code> media player)</a></li>
<li><a href="#h:c8b2f021-fe5a-4f6b-944c-20340f764fb2">5.6.15. The <code>prot-emacs-dired.el</code> call to <code>provide</code></a></li>
</ul>
</li>
<li><a href="#h:b5fa481d-8549-4424-869e-91091cdf730b">5.7. The <code>prot-emacs-window.el</code> module</a>
<ul>
<li><a href="#h:bf93a881-e885-4b83-bd30-35bd888fe199">5.7.1. The <code>prot-emacs-window.el</code> section about running commands in popup frames</a></li>
<li><a href="#h:cfbea29c-3290-4fd1-a02a-d7e887c15674">5.7.2. The <code>prot-emacs-window.el</code> section about uniquifying buffer names</a></li>
<li><a href="#h:ec156866-3d25-42e7-8247-b190103b6f17">5.7.3. The <code>prot-emacs-window.el</code> section about line highlighting (<code>hl-line-mode</code>)</a></li>
<li><a href="#h:ad2945c5-992d-4c82-a8b8-652f47ebdbea">5.7.4. The <code>prot-emacs-window.el</code> section about negative space highlighting (<code>whitespace-mode</code>)</a></li>
<li><a href="#h:f45ea51c-8129-41bd-8d6e-4b66e7f35a49">5.7.5. The <code>prot-emacs-window.el</code> section about line numbers (<code>display-line-numbers-mode</code>)</a></li>
<li><a href="#h:50f8b1e4-b14e-453f-a37e-1c0e495ab80f">5.7.6. The <code>prot-emacs-window.el</code> rules for displaying buffers (<code>display-buffer-alist</code>)</a></li>
<li><a href="#h:bf3f50d5-c5db-4704-9498-9e8bfe1b45a8">5.7.7. The <code>prot-emacs-window.el</code> setting to enable <code>visual-line-mode</code> in some contexts</a></li>
<li><a href="#h:b6754236-3d08-4448-9c86-3e5923737e4b">5.7.8. The <code>prot-emacs-window.el</code> settings to truncate some buffers silently</a></li>
<li><a href="#h:49ad5448-2ccd-4f47-82fd-17819ffdbdf3">5.7.9. The <code>prot-emacs-window.el</code> section key bindings</a></li>
<li><a href="#h:77e4f174-0c86-460d-8a54-47545f922ae9">5.7.10. The <code>prot-emacs-window.el</code> section about <code>beframe</code></a></li>
<li><a href="#h:2df15080-77f9-45f8-a3b5-1adddc70a512">5.7.11. The <code>prot-emacs-window.el</code> configuration of <code>undelete-frame-mode</code> and <code>winner-mode</code></a></li>
<li><a href="#h:84a0d366-d4d7-42f4-a8b7-2ec1af08cee4">5.7.12. The <code>prot-emacs-window.el</code> keys for window motions (<code>windmove</code>)</a></li>
<li><a href="#h:29ced61b-4b5a-4f63-af00-fe311468d1cd">5.7.13. The <code>prot-emacs-window.el</code> use of contextual header line (<code>breadcrumb</code>)</a></li>
<li><a href="#h:2124c200-734d-49c4-aeb1-513caaf957ae">5.7.14. The <code>prot-emacs-window.el</code> <code>provide</code> form</a></li>
</ul>
</li>
<li><a href="#h:65e3eff5-0bff-4e1f-b6c5-0d3aa1a0d232">5.8. The <code>prot-emacs-git.el</code> module</a>
<ul>
<li><a href="#h:89edea05-4d94-4ea1-b2a8-5ad01422618c">5.8.1. The <code>prot-emacs-git.el</code> section about ediff</a></li>
<li><a href="#h:7dcbcadf-8af6-487d-b864-e4ce56d69530">5.8.2. The <code>prot-emacs-git.el</code> section about <code>project.el</code></a></li>
<li><a href="#h:8b426a69-e3cd-42ac-8788-f41f6629f879">5.8.3. The <code>prot-emacs-git.el</code> section about <code>diff-mode</code></a></li>
<li><a href="#h:50add1d8-f0f4-49be-9e57-ab280a4aa300">5.8.4. The <code>prot-emacs-git.el</code> section about <code>vc.el</code> and related</a></li>
<li><a href="#h:257b9118-4407-410e-a56a-134fd5d1a3b4">5.8.5. The <code>prot-emacs-git.el</code> section about <code>agitate</code></a></li>
<li><a href="#h:b08af527-9ebf-4425-ac3a-24b4f371a4fd">5.8.6. The <code>prot-emacs-git.el</code> section about <code>magit</code> (great Git client)</a></li>
<li><a href="#h:4e7035c5-9350-4c51-be85-85f2539ed295">5.8.7. The <code>prot-emacs-git.el</code> call to <code>provide</code></a></li>
</ul>
</li>
<li><a href="#h:d799c3c0-bd6a-40bb-bd1a-ba4ea5367840">5.9. The <code>prot-emacs-org.el</code> module</a>
<ul>
<li><a href="#h:94d48381-1711-4d6b-8449-918bc1e3836c">5.9.1. The <code>prot-emacs-org.el</code> section on the <code>calendar</code></a></li>
<li><a href="#h:bd4b0dcb-a925-4bd7-90db-6379a7ca6f5e">5.9.2. The <code>prot-emacs-org.el</code> section about appointment reminders (<code>appt.el</code>)</a></li>
<li><a href="#h:e03df1e0-b43e-49b5-978e-6a511165617c">5.9.3. The <code>prot-emacs-org.el</code> section with basic Org settings</a></li>
<li><a href="#h:024dd541-0061-4a10-b10b-b17dcd4794b9">5.9.4. The <code>prot-emacs-org.el</code> Org to-do and refile settings</a></li>
<li><a href="#h:81de4e32-a1af-4e1f-9e10-90eb0c90afa2">5.9.5. The <code>prot-emacs-org.el</code> Org heading tags</a></li>
<li><a href="#h:0884658e-9eb5-47e3-9338-66e09004a1a0">5.9.6. The <code>prot-emacs-org.el</code> Org time/state logging</a></li>
<li><a href="#h:da8ce883-7f21-4a6e-a41f-d668ad762b41">5.9.7. The <code>prot-emacs-org.el</code> Org link settings</a></li>
<li><a href="#h:1f5a0d46-5202-48dd-8048-b48ce17f3df8">5.9.8. The <code>prot-emacs-org.el</code> Org code block settings</a></li>
<li><a href="#h:bd11d4d8-6e9f-4536-87a4-4018783bf8f5">5.9.9. The <code>prot-emacs-org.el</code> Org export settings</a></li>
<li><a href="#h:f8f06938-0dfe-45c3-b4cf-996d36cba82d">5.9.10. The <code>prot-emacs-org.el</code> Org capture templates (<code>org-capture</code>)</a></li>
<li><a href="#h:7fe87b83-2815-4617-a5f9-d3417dd9d248">5.9.11. The <code>prot-emacs-org.el</code> Org agenda settings</a></li>
<li><a href="#h:62eb7ca3-2f79-45a6-a018-38238b486e98">5.9.12. The <code>prot-emacs-org.el</code> call to <code>provide</code></a></li>
</ul>
</li>
<li><a href="#h:f44afb76-a1d7-4591-934d-b698cc79a792">5.10. The <code>prot-emacs-langs.el</code> module</a>
<ul>
<li><a href="#h:559713c8-0e1e-44aa-bca8-0caae01cc8bb">5.10.1. The <code>prot-emacs-langs.el</code> settings for TAB</a></li>
<li><a href="#h:ebbc4e05-3654-4fc4-9948-d29dffeb6356">5.10.2. The <code>prot-emacs-langs.el</code> settings for &ldquo;electric&rdquo; behaviour</a></li>
<li><a href="#h:7cd21ea6-c5d8-4258-999d-ad94cac2d8bf">5.10.3. The <code>prot-emacs-langs.el</code> settings <code>show-paren-mode</code></a></li>
<li><a href="#h:c5fbd6dd-2982-4fca-aeed-d0e750d399bd">5.10.4. The <code>prot-emacs-langs.el</code> settings for plain text (no double spaces, <code>auto-fill-mode</code>)</a></li>
<li><a href="#h:1a132701-9487-4af0-8759-a8d64d02bf1f">5.10.5. The <code>prot-emacs-langs.el</code> settings for common file types</a></li>
<li><a href="#h:a5773a39-a78f-43fa-8feb-669492c1d5a9">5.10.6. The <code>prot-emacs-langs.el</code> settings for <code>eldoc</code></a></li>
<li><a href="#h:92258aa8-0d8c-4c12-91b4-5f44420435ce">5.10.7. The <code>prot-emacs-langs.el</code> settings for <code>eglot</code> (LSP client)</a></li>
<li><a href="#h:20948a81-858d-4b21-b221-3b24833f5ad8">5.10.8. The <code>prot-emacs-langs.el</code> settings for very long lines</a></li>
<li><a href="#h:c9063898-07ae-4635-8853-bb5f4bbab421">5.10.9. The <code>prot-emacs-langs.el</code> settings for <code>markdown-mode</code></a></li>
<li><a href="#h:bae58479-86c1-410f-867e-c548def65b1c">5.10.10. The <code>prot-emacs-langs.el</code> settings for <code>csv-mode</code></a></li>
<li><a href="#h:88e36f15-4c74-4b7c-9ba6-cf5fb112ffd9">5.10.11. The <code>prot-emacs-langs.el</code> settings for <code>sxhkdrc-mode</code></a></li>
<li><a href="#h:115806c4-88b0-43c1-8db2-d9d8d20a5c17">5.10.12. The <code>prot-emacs-langs.el</code> settings for spell checking</a></li>
<li><a href="#h:df6d1b52-0306-4ace-9099-17dded11fbed">5.10.13. The <code>prot-emacs-langs.el</code> settings for code linting (<code>flymake</code>)</a></li>
<li><a href="#h:ffff5f7b-a62b-4d4a-ae29-af75402e5c35">5.10.14. The <code>prot-emacs-langs.el</code> settings for <code>outline-minor-mode</code></a></li>
<li><a href="#h:f91563d8-f176-4555-b45b-ece56de03279">5.10.15. The <code>prot-emacs-langs.el</code> settings for <code>dictionary</code></a></li>
<li><a href="#h:2a2728a9-e392-4fbe-bf2a-83e883387857">5.10.16. The <code>prot-emacs-langs.el</code> settings for <code>altcaps</code> (alternating letter casing)</a></li>
<li><a href="#h:e86a66dc-7ef9-4f09-ad7e-946de2034e8d">5.10.17. The <code>prot-emacs-langs.el</code> settings for <code>denote</code> (notes and file-naming)</a>
<ul>
<li><a href="#h:ee82e629-fb05-4c75-9175-48a760a25691">5.10.17.1. The <code>prot-emacs-langs.el</code> integration between Consult and Denote (<code>consult-denote</code>)</a></li>
</ul>
</li>
<li><a href="#h:137c67f1-b112-42b7-aec9-c44ef4a6241a">5.10.18. The <code>prot-emacs-langs.el</code> settings for <code>logos</code> (writing extras and buffer navigation)</a></li>
</ul>
</li>
<li><a href="#h:755e195b-9471-48c7-963b-33055969b4e2">5.11. The <code>prot-emacs-email.el</code> module</a>
<ul>
<li><a href="#h:24f17614-ee3d-4cd1-bbe3-f53e4f39c281">5.11.1. The <code>prot-emacs-email.el</code> basic settings (including <code>authinfo</code>)</a></li>
<li><a href="#h:49815c07-737f-4f10-95ee-63640f9ae18b">5.11.2. The <code>prot-emacs-email.el</code> message composition and encryption settings (<code>message.el</code>)</a></li>
<li><a href="#h:deccd4f1-c1bd-4b02-993e-914f57ea0fac">5.11.3. The <code>prot-emacs-email.el</code> integration with Dired for email attachments (<code>gnus-dired-mode</code>)</a></li>
<li><a href="#h:c7c9815c-e259-4810-816a-9ebc1a146004">5.11.4. The <code>prot-emacs-email.el</code> settings for <code>sendmail</code></a></li>
<li><a href="#h:200bc618-678a-4dc8-9d30-876d89e1edae">5.11.5. The <code>prot-emacs-email.el</code> loading of the email client and call to <code>provide</code></a></li>
<li><a href="#h:b26c6297-ebe8-4f99-b069-df53cfd90520">5.11.6. The <code>prot-emacs-email.el</code> submodule for <code>notmuch</code> (<code>prot-emacs-notmuch.el</code>)</a>
<ul>
<li><a href="#h:2fca749c-a84e-415c-9ac0-b1518d06fa51">5.11.6.1. The <code>prot-emacs-notmuch.el</code> section about the account settings</a></li>
<li><a href="#h:2c9a555f-d3ec-4d0e-bad6-6c26b576a49a">5.11.6.2. The <code>prot-emacs-notmuch.el</code> section about the general user interface</a></li>
<li><a href="#h:eddc38d8-d1c1-48a4-8fa1-ce9ab2820ee3">5.11.6.3. The <code>prot-emacs-notmuch.el</code> section about the presentation of search buffers</a></li>
<li><a href="#h:f19e7ef2-9a90-4fbd-879b-8ee0acfa1b5a">5.11.6.4. The <code>prot-emacs-notmuch.el</code> section about tag settings</a></li>
<li><a href="#h:b91c062d-add7-42e6-b425-4fa287763b1b">5.11.6.5. The <code>prot-emacs-notmuch.el</code> section about email composition settings</a></li>
<li><a href="#h:f2b7a39e-fb10-4886-9765-4be8a1701c67">5.11.6.6. The <code>prot-emacs-notmuch.el</code> section about reading messages</a></li>
<li><a href="#h:6148eea6-7859-4b53-95ce-7e198fc831e0">5.11.6.7. The <code>prot-emacs-notmuch.el</code> section about hooks and key bindings</a></li>
<li><a href="#h:dbd2b775-8f51-451a-8e24-9c8424fd2e89">5.11.6.8. The <code>prot-emacs-notmuch.el</code> custom extensions (per <code>prot-notmuch.el</code>)</a></li>
<li><a href="#h:49890997-448e-408d-bebe-2003259bb125">5.11.6.9. The <code>prot-emacs-notmuch.el</code> glue code for <code>org-capture</code> (<code>ol-notmuch.el</code>)</a></li>
<li><a href="#h:0f12f144-ca9f-4d07-8563-c33b3521bfb5">5.11.6.10. The <code>prot-emacs-notmuch.el</code> section about the <code>notmuch-indicator</code></a></li>
<li><a href="#h:340e745d-544c-4473-969e-ade21ae7710d">5.11.6.11. The <code>prot-emacs-notmuch.el</code> call to <code>provide</code></a></li>
</ul>
</li>
<li><a href="#h:97282c11-475c-4ad3-9399-cb2cd12f93b7">5.11.7. The deprecated <code>prot-emacs-mail.el</code> submodule for <code>mu4e</code> (<code>prot-emacs-mu4e.el</code>)</a></li>
<li><a href="#h:ae0a1c85-8412-48d3-94a9-7d6dbd801126">5.11.8. The deprecated <code>prot-emacs-mail.el</code> submodule for Gnus (<code>prot-emacs-gnus.el</code>)</a></li>
<li><a href="#h:33151014-3621-4be6-9185-aacc34ee2d2c">5.11.9. Overview of my email setup (<code>mbsync</code>, <code>msmtp</code>, mail indexer, and MUA)</a>
<ul>
<li><a href="#h:bf540a85-12a6-4005-bf00-2ff3370e5adb">5.11.9.1. Contents of my <code>.mbsyncrc</code></a></li>
<li><a href="#h:c7b8940b-7452-429e-ba2d-dd39da5e9cd9">5.11.9.2. Contents of my <code>msmtp</code> configuration file</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#h:f23d9cef-ab7b-4486-a070-9c7ae664eadf">5.12. <span class="todo TODO">TODO</span> The <code>prot-emacs-web.el</code> module</a>
<ul>
<li><a href="#h:edb70963-d590-4959-bc59-1e5435c8e78a">5.12.1. <span class="todo TODO">TODO</span> The <code>prot-emacs-web.el</code> settings about following links (<code>browse-url</code>)</a></li>
<li><a href="#h:7639683b-4b6f-42ee-9ae0-76eeec6fee9a">5.12.2. <span class="todo TODO">TODO</span> The <code>prot-emacs-web.el</code> settings about buttonising links (<code>goto-addr</code>)</a></li>
<li><a href="#h:60483672-aeb6-427b-bbef-54a5c31e39ab">5.12.3. <span class="todo TODO">TODO</span> The <code>prot-emacs-web.el</code> settings about the Simple HTML Renderer (<code>shr</code>)</a></li>
<li><a href="#h:399f1ec8-30e6-40c3-931b-e7c7409716c8">5.12.4. <span class="todo TODO">TODO</span> The <code>prot-emacs-web.el</code> settings about browser cookies</a></li>
<li><a href="#h:b09b4fce-31fe-4381-a49a-6a7206ac5f1b">5.12.5. <span class="todo TODO">TODO</span> The <code>prot-emacs-web.el</code> settings about the web browser (<code>eww</code>)</a></li>
<li><a href="#h:1fcd7008-b7ed-4441-8a7b-82db43a05775">5.12.6. <span class="todo TODO">TODO</span> The <code>prot-emacs-web.el</code> extras for <code>eww</code> (<code>prot-eww.el</code>)</a></li>
<li><a href="#h:adc258d3-f444-4bb5-8a8d-43025a689167">5.12.7. <span class="todo TODO">TODO</span> The <code>prot-emacs-web.el</code> RSS/Atom reader (<code>elfeed</code>)</a></li>
<li><a href="#h:b9e6834b-e636-414e-8c50-9e04ba77a0a3">5.12.8. <span class="todo TODO">TODO</span> The <code>prot-emacs-web.el</code> settings for the IRC client</a></li>
</ul>
</li>
<li><a href="#h:ddb1070d-2f91-4224-ad43-ef03f038f787">5.13. The <code>prot-emacs-which-key.el</code> module</a></li>
<li><a href="#h:4efde779-3ef0-40b7-82e4-70f71b321428">5.14. The <code>prot-emacs-icons.el</code> module (<code>nerd-icons</code> for various packages)</a></li>
</ul>
</li>
<li><a href="#h:fc1ea247-5ef6-4c4e-a807-6c7b2482af90">6. The custom libraries of my configuration</a>
<ul>
<li><a href="#h:ddb9c32c-2114-4347-9f76-5160e590b5dc">6.1. The <code>prot-abbrev.el</code> library</a></li>
<li><a href="#h:7affcbca-0808-4159-8eab-faa7973aefc7">6.2. The <code>prot-comment.el</code> library</a></li>
<li><a href="#h:3fccfadf-22e9-457f-b9fd-ed1b48600d23">6.3. The <code>prot-common.el</code> library</a></li>
<li><a href="#h:92cfefcf-8c20-43cd-b47c-ffe0c5fe1887">6.4. The <code>prot-dired.el</code> library</a></li>
<li><a href="#h:98c313d7-62c2-48c1-b6ad-28cc25f22092">6.5. The <code>prot-elfeed.el</code> library</a></li>
<li><a href="#h:fb034be5-c316-4c4f-a46f-cebcab332a47">6.6. The <code>prot-embark.el</code> library</a></li>
<li><a href="#h:abc20037-7a4f-4555-809a-dc4165c5db6a">6.7. The <code>prot-eww.el</code> library</a></li>
<li><a href="#h:92085a6d-213f-400d-be83-763eb80a3877">6.8. The <code>prot-marginalia.el</code> library</a></li>
<li><a href="#h:935adc09-abaa-4413-a5ab-a7a562081c20">6.9. The <code>prot-modeline.el</code> library</a></li>
<li><a href="#h:92ee86b8-0ead-4080-963f-3fbc9f931e3e">6.10. The <code>prot-notmuch.el</code> library</a></li>
<li><a href="#h:114c6e8c-697a-43e9-8fd9-52872997e1c9">6.11. The <code>prot-orderless.el</code> library</a></li>
<li><a href="#h:9974eac8-2167-45c4-90e0-12dd877403da">6.12. The <code>prot-org.el</code> library</a></li>
<li><a href="#h:0a3f076d-386d-47e6-8af9-f17d02d507cf">6.13. The <code>prot-pair.el</code> library</a></li>
<li><a href="#h:f860bd85-671e-477e-8233-23a8ba43e1c6">6.14. The <code>prot-prefix.el</code> library</a></li>
<li><a href="#h:654cfe49-f59d-4a0d-84ee-094ddce06848">6.15. The <code>prot-project.el</code> library</a></li>
<li><a href="#h:efebaec4-7273-4c5a-a4c4-9f99df0e46bb">6.16. The <code>prot-scratch.el</code> library</a></li>
<li><a href="#h:0cab525d-fcbc-478c-b914-bbd69e33c635">6.17. The <code>prot-search.el</code> library</a></li>
<li><a href="#h:32f6fe0f-23c4-44cc-97cc-3e5372bd484e">6.18. The <code>prot-shell.el</code> library</a></li>
<li><a href="#h:5f78e837-0d27-4390-bd9a-6d0bca57fa50">6.19. The <code>prot-simple.el</code> library</a></li>
<li><a href="#h:551718b7-fb2d-4a4a-804e-3118001b96ec">6.20. The <code>prot-spell.el</code> library</a></li>
<li><a href="#h:3796a4c9-8659-4782-8aaa-3cf4e950927d">6.21. The <code>prot-vertico.el</code> library</a></li>
<li><a href="#h:35b8a0a5-c447-4301-a404-bc274596238d">6.22. The <code>prot-window.el</code> library</a></li>
</ul>
</li>
<li><a href="#h:cc8b8fac-b9d4-4a61-a69b-a0c93efa254d">7. Frequently Asked Questions (FAQ)</a>
<ul>
<li><a href="#h:74c3a9e1-6852-4307-b7ba-925d8d2f61ff">7.1. Why many modules instead of one init.el?</a></li>
<li><a href="#h:2d28a65c-bef6-4829-89d9-aef3581da7cd">7.2. Why use Org when you can have an outline in Elisp?</a></li>
<li><a href="#h:b35ab88e-3ce7-4412-a8ec-135eed9262d0">7.3. Why do you use multiple <code>setq</code> instead of one?</a></li>
<li><a href="#h:6b6778af-8bd2-4f97-a794-e23774aa6cf3">7.4. Why don&rsquo;t you remap keys?</a></li>
<li><a href="#h:893f3735-ecb9-4e50-bb24-8389872aa650">7.5. Why not use Org block arguments in the properties drawer?</a></li>
<li><a href="#h:5668958c-2fc0-4a38-bd1f-3e0c6484977d">7.6. What hardware and software do you use?</a></li>
<li><a href="#h:2d3c8fb5-f29b-4740-8f66-3055701d9baf">7.7. What is your desktop setup?</a></li>
</ul>
</li>
</ul>
</div>
</div>
<div id="outline-container-h:64c1c9f5-1218-4ff3-8e35-41e56c74f038" class="outline-2">
<h2 id="h:64c1c9f5-1218-4ff3-8e35-41e56c74f038"><span class="section-number-2">1.</span> Details of my Emacs build</h2>
<div class="outline-text-2" id="text-h:64c1c9f5-1218-4ff3-8e35-41e56c74f038">
<p>
I track the emacs.git trunk, as I am the maintainer of several Emacs
packages and a contributor to Emacs core. Here are my current settings
(2025-01-30 10:45:47 +0200):
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">system-configuration-options
</pre>
</div>

<pre class="example">
--prefix=/usr/local --with-x-toolkit=lucid --disable-gc-mark-trace --with-native-compilation=aot --without-gif --without-tiff --without-selinux --without-xinput2 --without-gpm --without-compress-install --without-xft --with-cairo --with-harfbuzz --with-tree-sitter=ifavailable --without-gsettings --without-gconf
</pre>


<p>
Users of Arch Linux can refer to this <code>PKGBUILD</code> I maintain for my
purposes:
</p>

<ul class="org-ul">
<li>Git repositories:
<ul class="org-ul">
<li>GitHub: <a href="https://github.com/protesilaos/emacs-arch-linux-pkgbuild">https://github.com/protesilaos/emacs-arch-linux-pkgbuild</a></li>
<li>GitLab: <a href="https://gitlab.com/protesilaos/emacs-arch-linux-pkgbuild">https://gitlab.com/protesilaos/emacs-arch-linux-pkgbuild</a></li>
</ul></li>
<li>Backronym for &ldquo;PKGBUILD &#x2026; of Emacs&rdquo;: Package Knowhow Germane to
Building Unapologetically Individuated Local Design &#x2026; of Emacs.</li>
</ul>
</div>
</div>
<div id="outline-container-h:103d6f5a-bdb1-4b49-946a-708a83c79a7d" class="outline-2">
<h2 id="h:103d6f5a-bdb1-4b49-946a-708a83c79a7d"><span class="section-number-2">2.</span> Anatomy of my Emacs configuration</h2>
<div class="outline-text-2" id="text-h:103d6f5a-bdb1-4b49-946a-708a83c79a7d">
<p>
[ Also read: <a href="#h:74c3a9e1-6852-4307-b7ba-925d8d2f61ff">Why many modules instead of one init.el?</a> and
  <a href="#h:2d28a65c-bef6-4829-89d9-aef3581da7cd">Why use Org when you can have an outline in Elisp?</a> ]
</p>

<p>
What you are now reading is the <code>prot-emacs.org</code> file. It is the
document that generates&#x2014;and thus controls&#x2014;every other file that
underpins my Emacs configuration.
</p>

<p>
This Org file is not loaded directly. Its sole purpose is to produce
the files that do the actual work. These files are organised by their
purpose and function:
</p>

<dl class="org-dl">
<dt>The standard <code>early-init.el</code></dt><dd>It includes optimisations for
starting up Emacs and sets some basics in place, such as to avoid
the flash of light when starting Emacs while in a dark environment.</dd>

<dt>The standard <code>init.el</code></dt><dd>It contains foundational blocks of my
system, i.e. Lisp macros I define, and loads the individual
configuration modules.</dd>

<dt>The <code>prot-emacs-modules</code> directory</dt><dd>It includes all my
configuration modules. Each module is about a specific type of
functionality, such a <code>prot-emacs-theme.el</code> for themes and
<code>prot-emacs-essentials.el</code> for basic tools. These configuration
modules tweak packages and are not meant to define extra
functionality.</dd>

<dt>The <code>prot-lisp</code> directory</dt><dd>Here are the custom libraries I
maintain as part of my Emacs setup. They are written in accordance
with the best practices for packaging Emacs Lisp, though are only
meant to be used as part of my setup. As such, they are not
necessarily up to par with the public-facing packages I maintain for
Emacs: <a href="https://protesilaos.com/emacs">https://protesilaos.com/emacs</a>.</dd>

<dt>The <code>prot-emacs-pre-custom</code> file</dt><dd>It is evaluated <i>before</i>
the modules are loaded. It is intended for users of my configuration
who want to make use of the options I provide (<a href="#h:5a41861f-4c38-45ac-8da2-51d77c0b4a73">The init.el user options</a>).</dd>

<dt>The <code>prot-emacs-post-custom</code> file</dt><dd>Like the above, this file is
meant for users of my setup. It is evaluated <i>after</i> the rest of my
setup is loaded. Users can include whatever code they want in this
file to either override existing functionality of define new one.</dd>

<dt>The <code>prot-emacs.org</code> file</dt><dd>The source of what you are currently
reading.</dd>
</dl>

<p>
Here is a schematic representation of this directory structure (files
shown here may not reflect the latest state of the project):
</p>

<pre class="example" id="org1cf03c8">
~/Git/Projects/dotfiles/emacs/.emacs.d $ tree -aF
./
├── early-init.el
├── init.el
├── prot-emacs-modules/
│   ├── prot-emacs-completion.el
│   ├── prot-emacs-dired.el
│   ├── prot-emacs-ef-themes.el
│   ├── prot-emacs-email.el
│   ├── prot-emacs-essentials.el
│   ├── prot-emacs-git.el
│   ├── prot-emacs-gnus.el
│   ├── prot-emacs-icons.el
│   ├── prot-emacs-langs.el
│   ├── prot-emacs-mct.el
│   ├── prot-emacs-modeline.el
│   ├── prot-emacs-modus-themes.el
│   ├── prot-emacs-mu4e.el
│   ├── prot-emacs-notmuch.el
│   ├── prot-emacs-org.el
│   ├── prot-emacs-search.el
│   ├── prot-emacs-standard-themes.el
│   ├── prot-emacs-theme.el
│   ├── prot-emacs-vertico.el
│   ├── prot-emacs-web.el
│   ├── prot-emacs-which-key.el
│   └── prot-emacs-window.el
├── prot-emacs.org
├── prot-emacs-post-custom.el
├── prot-emacs-pre-custom.el
└── prot-lisp/
    ├── prot-abbrev.el
    ├── prot-coach.el
    ├── prot-comment.el
    ├── prot-common.el
    ├── prot-dired.el
    ├── prot-elfeed.el
    ├── prot-embark.el
    ├── prot-eww.el
    ├── prot-marginalia.el
    ├── prot-modeline.el
    ├── prot-notmuch.el
    ├── prot-orderless.el
    ├── prot-org.el
    ├── prot-pair.el
    ├── prot-prefix.el
    ├── prot-project.el
    ├── prot-scratch.el
    ├── prot-search.el
    ├── prot-shell.el
    ├── prot-simple.el
    ├── prot-spell.el
    ├── prot-vertico.el
    └── prot-window.el

3 directories, 50 files
</pre>

<p>
The reason I have this modular setup is because it is easier to debug
it but also to share individual snippets with others. The
<code>prot-emacs.org</code> file is not a hindrance in this regard: it provides
an additional way of sharing my work in the form of this consolidated
view you are now seeing.
</p>

<p>
When I want to make a change to my Emacs setup, I do the edits in this
<code>prot-emacs.org</code> and then type <code>C-c C-v C-t</code> (<code>M-x org-babel-tangle</code>)
to propagate the changes to the relevant files.
</p>

<p>
On a new computer, I put all my Emacs files where they are meant to
be (inside the <code>~/.emacs.d</code> directory) with this command, which uses
the <code>stow</code> system package (all my dotfiles are stowed in place with
this program):
</p>

<pre class="example" id="orge3e0dbd">
~/Git/Projects/dotfiles $ stow -t $HOME emacs
</pre>

<p>
If I ever add/remove files, I do this instead:
</p>

<pre class="example" id="org884e3b1">
~/Git/Projects/dotfiles $ stow -t $HOME -R emacs
</pre>

<p>
I have built my setup from scratch and am observing best practices
with regard to how Emacs expects things to run. I do not use the Emacs
daemon, as I have encountered instabilities with it. Instead, I run a
single instance of Emacs and then configure it to act as the server.
This means that I can still connect to the running session via
<code>emacsclient</code>, which is useful when I want to evaluate Elisp code from
outside of Emacs (e.g. with my <code>delight.sh</code> shell script that switches
the entire &ldquo;environment&rdquo; theme of my tiling window manager or desktop
environment&#x2014;see my dotfiles for the technicalities).
</p>
</div>
</div>
<div id="outline-container-h:7b7b5898-09f7-4128-8af0-4041f67cb729" class="outline-2">
<h2 id="h:7b7b5898-09f7-4128-8af0-4041f67cb729"><span class="section-number-2">3.</span> The early initialisation of Emacs (<code>early-init.el</code>)</h2>
<div class="outline-text-2" id="text-h:7b7b5898-09f7-4128-8af0-4041f67cb729">
<p>
This is the first file that Emacs reads when starting up. It should
contain code that does not depend on any package or the proportions of
the Emacs frame. In general, this early initialisation file is meant
to set up a few basic things before Emacs produces the initial frame
by delegating to the <code>init.el</code> (<a href="#h:103d6f5a-bdb1-4b49-946a-708a83c79a7d">Anatomy of my Emacs configuration</a>).
</p>
</div>
<div id="outline-container-h:1e1b1503-0952-43f9-8bfe-4252fe874cd1" class="outline-3">
<h3 id="h:1e1b1503-0952-43f9-8bfe-4252fe874cd1"><span class="section-number-3">3.1.</span> The <code>early-init.el</code> macro to run code only in a Desktop Environment</h3>
<div class="outline-text-3" id="text-h:1e1b1503-0952-43f9-8bfe-4252fe874cd1">
<p>
There are a few parts of my setup where I need to run code based on
whether I am using a regular desktop environment. This is not the
norm, as I default to a tiling window manager (check my dotfiles for
their specifics). What I have here is a macro which I can then use to
wrap any code that should only be evaluated when I am not in one of my
tiling window managers.
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(defvar prot-emacs-tiling-window-manager-regexp "bspwm\\|herbstluftwm\\|i3"
  "Regular expression to  tiling window managers.
See definition of `prot-emacs-with-desktop-session'.")

(defmacro prot-emacs-with-desktop-session (&amp;rest body)
  "Expand BODY if desktop session is not a tiling window manager.
See `prot-emacs-tiling-window-manager-regexp' for what
constitutes a matching tiling window manager."
  (declare (indent 0))
  `(when-let* ((session (getenv "DESKTOP_SESSION"))
               ((not (string-match-p session prot-emacs-tiling-window-manager-regexp))))
     ,@body))
</pre>
</div>
</div>
</div>
<div id="outline-container-h:0403b581-142b-4613-bc81-51c5dccd831d" class="outline-3">
<h3 id="h:0403b581-142b-4613-bc81-51c5dccd831d"><span class="section-number-3">3.2.</span> The <code>early-init.el</code> code to set frame parameters</h3>
<div class="outline-text-3" id="text-h:0403b581-142b-4613-bc81-51c5dccd831d">
<p>
Here I am setting parameters for the size of the Emacs frame: the
first as well as any future one. In a tiling window manager, these
parameters are not relevant, since all windows are forcibly made to
fit into rectangles (tiles) that fill up the entire screen. So I use
the <code>prot-emacs-with-desktop-session</code> macro that I described above to
set these parameters only when I am in a regular desktop environment
(<a href="#h:1e1b1503-0952-43f9-8bfe-4252fe874cd1">The early-init.el macro to run code only in a Desktop Environment</a>).
</p>

<p>
The <code>initial-frame-alist</code> is about the first frame that is produced
when starting Emacs. The <code>default-frame-alist</code> is for all frames after
that.
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(defun prot-emacs-add-to-list (list element)
  "Add to symbol of LIST the given ELEMENT.
Simplified version of `add-to-list'."
  (set list (cons element (symbol-value list))))

(prot-emacs-with-desktop-session
  (mapc
   (lambda (var)
     (prot-emacs-add-to-list var '(width . (text-pixels . 800)))
     (prot-emacs-add-to-list var '(height . (text-pixels . 900)))
     (prot-emacs-add-to-list var '(scroll-bar-width  . 10)))
   '(default-frame-alist initial-frame-alist)))
</pre>
</div>
</div>
</div>
<div id="outline-container-h:a1288a07-93f6-4e14-894e-707d5ad8b6dc" class="outline-3">
<h3 id="h:a1288a07-93f6-4e14-894e-707d5ad8b6dc"><span class="section-number-3">3.3.</span> The <code>early-init.el</code> basic frame settings</h3>
<div class="outline-text-3" id="text-h:a1288a07-93f6-4e14-894e-707d5ad8b6dc">
<p>
These are some general settings for frames and the basics of the
toolkit. In short, I want to keep things minimal. Notice the
<code>frame-resize-pixelwise</code> and <code>frame-inhibit-implied-resize</code>: by
default Emacs will resize the frame if you adjust the font size, which
I never want.
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(setq frame-resize-pixelwise t
      frame-inhibit-implied-resize t
      frame-title-format '("%b")
      ring-bell-function 'ignore
      use-dialog-box t ; only for mouse events, which I seldom use
      use-file-dialog nil
      use-short-answers t
      inhibit-splash-screen t
      inhibit-startup-screen t
      inhibit-x-resources t
      inhibit-startup-echo-area-message user-login-name ; read the docstring
      inhibit-startup-buffer-menu t)

;; I do not use those graphical elements by default, but I do enable
;; them from time-to-time for testing purposes or to demonstrate
;; something.  NEVER tell a beginner to disable any of these.  They
;; are helpful.
(menu-bar-mode -1)
(scroll-bar-mode -1)
(tool-bar-mode -1)
</pre>
</div>
</div>
</div>
<div id="outline-container-h:50d28f3c-3ada-4db5-b830-bbbbee7fec4e" class="outline-3">
<h3 id="h:50d28f3c-3ada-4db5-b830-bbbbee7fec4e"><span class="section-number-3">3.4.</span> The <code>early-init.el</code> tweaks to startup time and garbage collection</h3>
<div class="outline-text-3" id="text-h:50d28f3c-3ada-4db5-b830-bbbbee7fec4e">
<p>
I do not have a deep understanding of &ldquo;garbage collection&rdquo;, though I
have learnt through trial and error that I can maximise the threshold
during startup to make Emacs boot a bit faster. What I am doing here
is to arrange for the relevant values to be set to very high values
during startup and then be brought down to something more practical
once Emacs is done loading.
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">;; Temporarily increase the garbage collection threshold.  These
;; changes help shave off about half a second of startup time.  The
;; `most-positive-fixnum' is DANGEROUS AS A PERMANENT VALUE.  See the
;; `emacs-startup-hook' a few lines below for what I actually use.
(setq gc-cons-threshold most-positive-fixnum
      gc-cons-percentage 0.5)

;; Same idea as above for the `file-name-handler-alist' and the
;; `vc-handled-backends' with regard to startup speed optimisation.
;; Here I am storing the default value with the intent of restoring it
;; via the `emacs-startup-hook'.
(defvar prot-emacs--file-name-handler-alist file-name-handler-alist)
(defvar prot-emacs--vc-handled-backends vc-handled-backends)

(setq file-name-handler-alist nil
      vc-handled-backends nil)

(add-hook 'emacs-startup-hook
          (lambda ()
            (setq gc-cons-threshold (* 1000 1000 8)
                  gc-cons-percentage 0.1
                  file-name-handler-alist prot-emacs--file-name-handler-alist
                  vc-handled-backends prot-emacs--vc-handled-backends)))
</pre>
</div>
</div>
</div>
<div id="outline-container-h:7a037504-8a2f-4df0-8482-ce6476354440" class="outline-3">
<h3 id="h:7a037504-8a2f-4df0-8482-ce6476354440"><span class="section-number-3">3.5.</span> The <code>early-init.el</code> initialises the package cache</h3>
<div class="outline-text-3" id="text-h:7a037504-8a2f-4df0-8482-ce6476354440">
<p>
I use the standard <code>package.el</code> to manage my Emacs packages. It works
for me and I never had a need for more (<a href="#h:424340cc-f3d7-4083-93c9-d852d40dfd40">The init.el settings for packages (<code>package.el</code>)</a>).
If I have to tinker with a package&rsquo;s source code, I use Git
ordinarily&#x2014;no need for a package manager to also be a development
tool.
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">;; Initialise installed packages at this early stage, by using the
;; available cache.  I had tried a setup with this set to nil in the
;; early-init.el, but (i) it ended up being slower and (ii) various
;; package commands, like `describe-package', did not have an index of
;; packages to work with, requiring a `package-refresh-contents'.
(setq package-enable-at-startup t)
</pre>
</div>
</div>
</div>
<div id="outline-container-h:7d3a283e-1595-4692-8124-e0d683cb15b2" class="outline-3">
<h3 id="h:7d3a283e-1595-4692-8124-e0d683cb15b2"><span class="section-number-3">3.6.</span> The <code>early-init.el</code> defines general theme-related functions</h3>
<div class="outline-text-3" id="text-h:7d3a283e-1595-4692-8124-e0d683cb15b2">
<p>
Here I am defining helper functions that check what theme I should be
using. I then rely on these functions to load a light or dark theme
accordingly. This is done in the sections about themes:
</p>

<ul class="org-ul">
<li><a href="#h:36af519a-67e1-42b6-a38a-2052638108f9">The <code>prot-emacs-modus-themes.el</code> module</a></li>
<li><a href="#h:2b2a27a1-6d2e-4b59-bf60-94682e173f2f">The <code>prot-emacs-ef-themes.el</code> module</a></li>
<li><a href="#h:0c7a240c-211f-4571-a5ba-433e510f487f">The <code>prot-emacs-standard-themes.el</code> module</a></li>
</ul>

<div class="org-src-container">
<pre class="src src-emacs-lisp">;;;; General theme code

(defun prot-emacs-theme-gsettings-dark-p ()
  "Return non-nil if gsettings (GNOME) has a dark theme.
Return nil if the DESKTOP_SESSION is either bspwm or
herbstluftwm, per the configuration of my dotfiles.  Also check
the `delight.sh' shell script."
  (prot-emacs-with-desktop-session
    (string-match-p
     "dark"
     (shell-command-to-string "gsettings get org.gnome.desktop.interface color-scheme"))))

(defun prot-emacs-theme-twm-dark-p ()
  "Return non-nil if my custom setup has a dark theme.
I place a file in ~/.config/prot-xtwm-active-theme which contains
a single word describing my system-wide theme.  This is part of
my dotfiles.  Check my `delight.sh' shell script for more."
  (when-let* ((file "~/.config/prot-xtwm-active-theme")
              ((file-exists-p file)))
    (string-match-p
     "dark"
     (with-temp-buffer
       (insert-file-contents file)
       (buffer-string)))))

(defun prot-emacs-theme-environment-dark-p ()
  "Return non-nil if environment theme is dark."
  (or (prot-emacs-theme-twm-dark-p)
      (prot-emacs-theme-gsettings-dark-p)))

(defun prot-emacs-re-enable-frame-theme (_frame)
  "Re-enable active theme, if any, upon FRAME creation.
Add this to `after-make-frame-functions' so that new frames do
not retain the generic background set by the function
`prot-emacs-avoid-initial-flash-of-light'."
  (when-let* ((theme (car custom-enabled-themes)))
    (enable-theme theme)))
</pre>
</div>
</div>
</div>
<div id="outline-container-h:a18a059d-4e62-4fd7-8c0b-1135a771a7aa" class="outline-3">
<h3 id="h:a18a059d-4e62-4fd7-8c0b-1135a771a7aa"><span class="section-number-3">3.7.</span> The <code>early-init.el</code> takes care to avoid the initial flash of light</h3>
<div class="outline-text-3" id="text-h:a18a059d-4e62-4fd7-8c0b-1135a771a7aa">
<p>
Since I put in the effort to define the above theme-related functions,
I can now benefit by having Emacs set an appropriate set of basic
colour values at startup to eliminate the flash of light it normally
displays (<a href="#h:7d3a283e-1595-4692-8124-e0d683cb15b2">The early-init.el defines general theme-related functions</a>).
By default, Emacs loads a light theme, but this is terrible if I am in
a fairly dark environment. Whereas my arrangement here makes sure that
Emacs uses a black background if the environment is dark.
</p>

<p>
Note that in the snippet below I hardcode the black colour (<code>#000000</code>)
to avoid any extra calculations at this early stage. Otherwise, I
would have to check which theme will be loaded and then set its
background here. That would be too slow for what we need in the early
initialisation file, thus defeating the purpose of not having a flash
of light at startup.
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">;; NOTE 2023-02-05: The reason the following works is because (i) the
;; `mode-line-format' is specified again and (ii) the
;; `prot-emacs-theme-gsettings-dark-p' will load a dark theme.
(defun prot-emacs-avoid-initial-flash-of-light ()
  "Avoid flash of light when starting Emacs, if needed.
New frames are instructed to call `prot-emacs-re-enable-frame-theme'."
  (when (prot-emacs-theme-environment-dark-p)
    (setq mode-line-format nil)
    (set-face-attribute 'default nil :background "#000000" :foreground "#ffffff")
    (set-face-attribute 'mode-line nil :background "#000000" :foreground "#ffffff" :box 'unspecified)
    (add-hook 'after-make-frame-functions #'prot-emacs-re-enable-frame-theme)))

(prot-emacs-avoid-initial-flash-of-light)
</pre>
</div>
</div>
</div>
<div id="outline-container-h:ad227f7e-b0a7-43f8-91d6-b50db82da9ad" class="outline-3">
<h3 id="h:ad227f7e-b0a7-43f8-91d6-b50db82da9ad"><span class="section-number-3">3.8.</span> The <code>early-init.el</code> gives a name to the default frame</h3>
<div class="outline-text-3" id="text-h:ad227f7e-b0a7-43f8-91d6-b50db82da9ad">
<p>
Finally, I like to call my default frame <code>home</code>. This is because I use
my <code>beframe</code> package to group the list of buffers on a per-frame basis
(<a href="#h:77e4f174-0c86-460d-8a54-47545f922ae9">The <code>prot-emacs-window.el</code> section about <code>beframe</code></a>). The multi-frame
arrangement is the best thing I ever did to boost my productivity:
bonus points when used in tandem with a tiling window manager.
</p>

<p>
Naming frames allows you to select them using completion. Emacs can do
this (<code>M-x select-frame-by-name</code>), though it is not always reliable as
it depends on the window manager (it works fine on GNOME, from what I
can tell). For minimalist window managers on Linux, something like the
<code>rofi</code> program can select system windows based on their name.
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(add-hook 'after-init-hook (lambda () (set-frame-name "home")))
</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-h:dae63bd9-93a8-41c4-af1b-d0f39ba50974" class="outline-2">
<h2 id="h:dae63bd9-93a8-41c4-af1b-d0f39ba50974"><span class="section-number-2">4.</span> The main initialisation of Emacs (<code>init.el</code>)</h2>
<div class="outline-text-2" id="text-h:dae63bd9-93a8-41c4-af1b-d0f39ba50974">
<p>
This is where I define the Lisp macros used in my setup and load all
the invidiual modules.
</p>
</div>
<div id="outline-container-h:5a41861f-4c38-45ac-8da2-51d77c0b4a73" class="outline-3">
<h3 id="h:5a41861f-4c38-45ac-8da2-51d77c0b4a73"><span class="section-number-3">4.1.</span> The <code>init.el</code> user options</h3>
<div class="outline-text-3" id="text-h:5a41861f-4c38-45ac-8da2-51d77c0b4a73">
<p>
I define several user options for my Emacs. These are useful to me if
I need to quickly test some aspect of my setup, though I provide them
mostly for those who use my files as a basis for their configuration.
</p>

<p>
All user options must be set in a <code>prot-emacs-pre-custom.el</code> file in
the same directory as the <code>init.el</code> (<a href="#h:103d6f5a-bdb1-4b49-946a-708a83c79a7d">Anatomy of my Emacs configuration</a>).
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">;; For those who use my dotfiles and need an easy way to write their
;; own extras on top of what I already load: search below for the files
;; prot-emacs-pre-custom.el and prot-emacs-post-custom.el
(defgroup prot-emacs nil
  "User options for my dotemacs.
These produce the expected results only when set in a file called
prot-emacs-pre-custom.el.  This file must be in the same
directory as the init.el."
  :group 'file)
</pre>
</div>
</div>
<div id="outline-container-h:5612b5b8-45a5-4a79-a25b-6fa3d9146c39" class="outline-4">
<h4 id="h:5612b5b8-45a5-4a79-a25b-6fa3d9146c39"><span class="section-number-4">4.1.1.</span> The <code>init.el</code> user option to load a theme family</h4>
<div class="outline-text-4" id="text-h:5612b5b8-45a5-4a79-a25b-6fa3d9146c39">
<p>
I am the developer/maintainer of three distinct theme packages. You
can read more about them (and see pictures) on their respective web
pages:
</p>

<ul class="org-ul">
<li><a href="https://protesilaos.com/emacs/modus-themes">https://protesilaos.com/emacs/modus-themes</a></li>
<li><a href="https://protesilaos.com/emacs/ef-themes">https://protesilaos.com/emacs/ef-themes</a></li>
<li><a href="https://protesilaos.com/emacs/standard-themes">https://protesilaos.com/emacs/standard-themes</a></li>
</ul>

<p>
In short:
</p>

<dl class="org-dl">
<dt>Modus themes</dt><dd>They conform with the highest accessibility standard
for colour contrast (WCAG AAA). They are elegant and designed with
attention to detail. I consider the <code>modus-operandi</code> and
<code>modus-vivendi</code> themes to be the standard of what a default
accessible theme should be like.</dd>
<dt>Ef themes</dt><dd>Highly legible (WCAG AA or WCAG AAA) and more colourful
than the Modus themes. The collection of palettes is also wider to
match a broad variety of preferences.</dd>
<dt>Standard themes</dt><dd>A re-imagination of the default Emacs looks. They
bring consistency and customisability to those who like how Emacs
is out-of-the-box.</dd>
</dl>

<p>
Here we specify which module to load at startup. Remember to read how
these options come into effect (<a href="#h:5a41861f-4c38-45ac-8da2-51d77c0b4a73">The init.el user options</a>).
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(defcustom prot-emacs-load-theme-family 'modus
  "Set of themes to load.
Valid values are the symbols `ef', `modus', and `standard', which
reference the `ef-themes', `modus-themes', and `standard-themes',
respectively.

A nil value does not load any of the above (use Emacs without a
theme).

This user option must be set in the `prot-emacs-pre-custom.el'
file.  If that file exists in the Emacs directory, it is loaded
before all other modules of my setup."
  :group 'prot-emacs
  :type '(choice :tag "Set of themes to load" :value modus
                 (const :tag "The `ef-themes' module" ef)
                 (const :tag "The `modus-themes' module" modus)
                 (const :tag "The `standard-themes' module" standard)
                 (const :tag "Do not load a theme module" nil)))
</pre>
</div>
</div>
</div>
<div id="outline-container-h:f012a254-2716-4c29-a64b-c2b3df34f57f" class="outline-4">
<h4 id="h:f012a254-2716-4c29-a64b-c2b3df34f57f"><span class="section-number-4">4.1.2.</span> The <code>init.el</code> user option to load a minibuffer user interface</h4>
<div class="outline-text-4" id="text-h:f012a254-2716-4c29-a64b-c2b3df34f57f">
<p>
I normally use <code>vertico</code> with my own custom extensions to it (<a href="#h:3796a4c9-8659-4782-8aaa-3cf4e950927d">The <code>prot-vertico.el</code> library</a>),
though I also maintain the <code>mct</code> package for those who want to use the
built-in completion framework with a few extras for better movement
and the like. I think <code>mct</code> will eventually be replaced by built-in
facilities, given there are developments on that front for Emacs 30.
It still has its place in the meantime.
</p>

<p>
Here we specify which module to load at startup. Remember to read how
these options come into effect (<a href="#h:5a41861f-4c38-45ac-8da2-51d77c0b4a73">The init.el user options</a>).
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(defcustom prot-emacs-completion-ui 'vertico
  "Choose minibuffer completion UI between `mct' or `vertico'.
If the value is nil, the default completion user interface is
used.  On Emacs 30, this is close the experience with `mct'.

This user option must be set in the `prot-emacs-pre-custom.el'
file.  If that file exists in the Emacs directory, it is loaded
before all other modules of my setup."
  :group 'prot-emacs
  :type '(choice :tag "Minibuffer user interface"
                 (const :tag "Default user interface" nil)
                 (const :tag "The `mct' module" mct)
                 (const :tag "The `vertico' module" vertico)))
</pre>
</div>
</div>
</div>
<div id="outline-container-h:91477890-49d5-48c3-9627-62295d2ab35d" class="outline-4">
<h4 id="h:91477890-49d5-48c3-9627-62295d2ab35d"><span class="section-number-4">4.1.3.</span> The <code>init.el</code> user option to load extras for minibuffer completion</h4>
<div class="outline-text-4" id="text-h:91477890-49d5-48c3-9627-62295d2ab35d">
<p>
I normally load some packages that enhance the experience with the
minibuffer. The upside is that we get more power out of Emacs. The
downside is that they have a learning curve. Users who do not need
these features can set the option to nil.
</p>

<ul class="org-ul">
<li><a href="#h:22e97b4c-d88d-4deb-9ab3-f80631f9ff1d">The <code>prot-emacs-completion.el</code> settings for <code>consult</code></a></li>
<li><a href="#h:61863da4-8739-42ae-a30f-6e9d686e1995">The <code>prot-emacs-completion.el</code> section about <code>embark</code></a></li>
</ul>

<p>
Remember to read how these options come into effect (<a href="#h:5a41861f-4c38-45ac-8da2-51d77c0b4a73">The init.el user options</a>).
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(defcustom prot-emacs-completion-extras t
  "When non-nil load extras for minibuffer completion.
These include packages such as `consult' and `embark'."
  :group 'prot-emacs
  :type 'boolean)
</pre>
</div>
</div>
</div>
<div id="outline-container-h:32703a47-edff-47a8-b275-3cb5b9f9e244" class="outline-4">
<h4 id="h:32703a47-edff-47a8-b275-3cb5b9f9e244"><span class="section-number-4">4.1.4.</span> The <code>init.el</code> user option to load treesitter extras</h4>
<div class="outline-text-4" id="text-h:32703a47-edff-47a8-b275-3cb5b9f9e244">
<p>
I configure Emacs to support the <code>tree-sitter</code> program, though I do
not use anything that leverages it. I either code in Emacs Lisp or
write prose. This user option is in place for those who want to use my
configuration as a basis for their own setup.
</p>

<p>
Remember to read how these options come into effect (<a href="#h:5a41861f-4c38-45ac-8da2-51d77c0b4a73">The init.el user options</a>).
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(defcustom prot-emacs-treesitter-extras t
  "When non-nil load extras for tree-sitter integration
These include packages such as `expreg' and generally anything
that adds functionality on top of what the major mode provides."
  :group 'prot-emacs
  :type 'boolean)
</pre>
</div>
</div>
</div>
<div id="outline-container-h:24324854-1f8c-4d8b-aa7c-291de968cbf4" class="outline-4">
<h4 id="h:24324854-1f8c-4d8b-aa7c-291de968cbf4"><span class="section-number-4">4.1.5.</span> The <code>init.el</code> user option to enable <code>which-key</code></h4>
<div class="outline-text-4" id="text-h:24324854-1f8c-4d8b-aa7c-291de968cbf4">
<p>
The <code>which-key</code> package provides hints for keys that complete the
currently incomplete sequence. Here we determine whether to load the
module or not. I personally never rely on <code>which-key</code> even if I enable
its mode. If I ever need to review which key bindings are available I
will either type <code>C-h</code> to complete a key sequence (produces a Help
buffer with relevant keys) or I will do <code>C-h m</code> (<code>M-x describe-mode</code>
to get information about the current major mode).
</p>

<p>
Remember to read how these options come into effect (<a href="#h:5a41861f-4c38-45ac-8da2-51d77c0b4a73">The init.el user options</a>).
</p>

<p>
Also check <a href="#h:ddb1070d-2f91-4224-ad43-ef03f038f787">the <code>prot-emacs-which-key.el</code> module</a>.
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(defcustom prot-emacs-load-which-key nil
  "When non-nil, display key binding hints after a short delay.
This user option must be set in the `prot-emacs-pre-custom.el'
file.  If that file exists in the Emacs directory, it is loaded
before all other modules of my setup."
  :group 'prot-emacs
  :type 'boolean)
</pre>
</div>
</div>
</div>
<div id="outline-container-h:a75444e3-527e-4525-84f8-0a43771966a6" class="outline-4">
<h4 id="h:a75444e3-527e-4525-84f8-0a43771966a6"><span class="section-number-4">4.1.6.</span> The <code>init.el</code> user option to load icons (<code>nerd-icons.el</code>)</h4>
<div class="outline-text-4" id="text-h:a75444e3-527e-4525-84f8-0a43771966a6">
<p>
Here we check whether to load decorative icons in a number of places,
such as Dired buffers and the completion user interface (where
relevant). My setup does not try to install the font files: the user
must do this manually with <code>M-x nerd-icons-install-fonts</code>.
</p>

<p>
Remember to read how these options come into effect (<a href="#h:5a41861f-4c38-45ac-8da2-51d77c0b4a73">The init.el user options</a>).
</p>

<p>
Also check <a href="#h:4efde779-3ef0-40b7-82e4-70f71b321428">the <code>prot-emacs-icons.el</code> module</a>.
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(defcustom prot-emacs-load-icons nil
  "When non-nil, enable iconography in various contexts.
This installs and uses the `nerd-icons' package and its variants.
NOTE that you still need to invoke `nerd-icons-install-fonts'
manually to first get the icon files.

This user option must be set in the `prot-emacs-pre-custom.el'
file.  If that file exists in the Emacs directory, it is loaded
before all other modules of my setup."
  :group 'prot-emacs
  :type 'boolean)
</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-h:63d74507-0318-4c02-ad30-484abcb8f78e" class="outline-3">
<h3 id="h:63d74507-0318-4c02-ad30-484abcb8f78e"><span class="section-number-3">4.2.</span> The <code>init.el</code> basic configurations to disable backups and lockfiles</h3>
<div class="outline-text-3" id="text-h:63d74507-0318-4c02-ad30-484abcb8f78e">
<p>
By default, Emacs tries to lock down files so that they are not
modified by other programs. It also keeps backups. These are features
I do not need because (i) if I am ever modifying my files externally,
then I know what I am doing and (ii) all the files I care about are
either under version control or backed up to a flash drive.
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(setq make-backup-files nil)
(setq backup-inhibited nil) ; Not sure if needed, given `make-backup-files'
(setq create-lockfiles nil)
</pre>
</div>
</div>
</div>
<div id="outline-container-h:3563ceb5-b70c-4191-9c81-f2f5a202c4da" class="outline-3">
<h3 id="h:3563ceb5-b70c-4191-9c81-f2f5a202c4da"><span class="section-number-3">4.3.</span> The <code>init.el</code> tweaks to make native compilation silent</h3>
<div class="outline-text-3" id="text-h:3563ceb5-b70c-4191-9c81-f2f5a202c4da">
<p>
The <code>--with-native-compilation=yes</code> build option of Emacs is very
nice: it enables the &ldquo;native compilation&rdquo; of Emacs Lisp, translating
it down to machine code. However, the default setting for reporting
errors is set to a verbose value which, in my coaching experience,
confuses users: it produces warnings for compilation issues that only
the developer of the given package needs to deal with. These include
innocuous facts like docstrings being wider than a certain character
count. To make things even worse, the buffer that shows these warnings
uses the stop sign character, resulting in a long list of lines with
red spots everywhere, as if we have totally broken Emacs.
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">;; Make native compilation silent and prune its cache.
(when (native-comp-available-p)
  (setq native-comp-async-report-warnings-errors 'silent) ; Emacs 28 with native compilation
  (setq native-compile-prune-cache t)) ; Emacs 29
</pre>
</div>
</div>
</div>
<div id="outline-container-h:f2ffe0e9-a58d-4bba-9831-cc35940ea83f" class="outline-3">
<h3 id="h:f2ffe0e9-a58d-4bba-9831-cc35940ea83f"><span class="section-number-3">4.4.</span> The <code>init.el</code> setting to send <code>custom-file</code> to oblivion</h3>
<div class="outline-text-3" id="text-h:f2ffe0e9-a58d-4bba-9831-cc35940ea83f">
<p>
By default, Emacs writes persistent customisations to the end of the
user&rsquo;s init file. These are encapsulated in a &ldquo;custom&rdquo; block. Emacs
writes those whenever the user does something with <code>M-x customize</code> or
related.
</p>

<p>
I personally prefer writing the actual Elisp over using the interface
of <code>M-x customize</code>. I also want my init file to only ever contain what
I wrote and to never&#x2014;ever!&#x2014;evaluate code I have not called myself.
</p>

<p>
As such, I want to set the <code>custom-file</code> variable to tell Emacs to
write its persistent variables to that file instead of my <code>init.el</code>.
Though since I have no intent to ever use this file, I choose to make
it disposable by placing it inside of the <code>/tmp</code> directory (this is
what the <code>make-temp-file</code> function does). So when I close the
computer, the file is gone. Finally, I do not invoke the <code>load</code>
function because I will never rely on the <code>custom-file</code>. I would
prefer to just have an option to avoid the Custom infrastructure
altogether, but this is not possible. So here we are&#x2026;
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">;; Disable the damn thing by making it disposable.
(setq custom-file (make-temp-file "emacs-custom-"))
</pre>
</div>
</div>
</div>
<div id="outline-container-h:805e0539-c46d-4f03-b152-cefc635f945c" class="outline-3">
<h3 id="h:805e0539-c46d-4f03-b152-cefc635f945c"><span class="section-number-3">4.5.</span> The <code>init.el</code> settings for multilingual editing (input methods)</h3>
<div class="outline-text-3" id="text-h:805e0539-c46d-4f03-b152-cefc635f945c">
<p>
This sets up Emacs for me to be able to type in Greek while still
using Emacs key bindings involving modifier keys (I don&rsquo;t get this if
I switch keyboard layouts at the system level).
</p>

<p>
Watch my video about multilingual editing:
<a href="https://protesilaos.com/codelog/2023-12-12-emacs-multilingual-editing/">https://protesilaos.com/codelog/2023-12-12-emacs-multilingual-editing/</a>.
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(setq default-input-method "greek") ; also check "greek-postfix"
(setq default-transient-input-method "greek")
</pre>
</div>
</div>
</div>
<div id="outline-container-h:4ed6593f-6f55-4258-a1c2-ddb50e9e2465" class="outline-3">
<h3 id="h:4ed6593f-6f55-4258-a1c2-ddb50e9e2465"><span class="section-number-3">4.6.</span> The <code>init.el</code> settings to enable certain commands and disable others</h3>
<div class="outline-text-3" id="text-h:4ed6593f-6f55-4258-a1c2-ddb50e9e2465">
<p>
Some Emacs commands are disabled by default. This means that Emacs
will produce a warning when we try to invoke them and will ask us for
confirmation. Here I define which commands I want to have enabled and
then put some on the disabled list.
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">;; Enable these
(mapc
 (lambda (command)
   (put command 'disabled nil))
 '(list-timers narrow-to-region narrow-to-page upcase-region downcase-region))

;; And disable these
(mapc
 (lambda (command)
   (put command 'disabled t))
 '(eshell project-eshell overwrite-mode iconify-frame diary))
</pre>
</div>
</div>
</div>
<div id="outline-container-h:96878899-f712-4900-8ee1-de8c40a634ce" class="outline-3">
<h3 id="h:96878899-f712-4900-8ee1-de8c40a634ce"><span class="section-number-3">4.7.</span> The <code>init.el</code> setting to always start with the <code>*scratch*</code> buffer</h3>
<div class="outline-text-3" id="text-h:96878899-f712-4900-8ee1-de8c40a634ce">
<p>
I like starting with a scratch buffer. I know that a lot of users
specify a dashboard or an Org agenda view, but I prefer to keep things
generic in this regard.
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(setq initial-buffer-choice t)
(setq initial-major-mode 'lisp-interaction-mode)
(setq initial-scratch-message
      (format ";; This is `%s'.  Use `%s' to evaluate and print results.\n\n"
              'lisp-interaction-mode
              (propertize
               (substitute-command-keys "\\&lt;lisp-interaction-mode-map&gt;\\[eval-print-last-sexp]")
               'face 'help-key-binding)))
</pre>
</div>
</div>
</div>
<div id="outline-container-h:e289a614-4f17-4d6c-a028-42fe45aebe66" class="outline-3">
<h3 id="h:e289a614-4f17-4d6c-a028-42fe45aebe66"><span class="section-number-3">4.8.</span> The <code>init.el</code> arrangements for my own modules and custom libraries</h3>
<div class="outline-text-3" id="text-h:e289a614-4f17-4d6c-a028-42fe45aebe66">
<p>
I use a literate configuration as the &ldquo;source of truth&rdquo; for my Emacs
configuration. What I do is to specify everything in one file and
provide instructions for where things should go. The end product
consists of a large set of files, encompassing the <code>early-init.el</code>
(<a href="#h:7b7b5898-09f7-4128-8af0-4041f67cb729">The early initialisation of Emacs (<code>early-init.el</code>)</a>), the <code>init.el</code>
(<a href="#h:dae63bd9-93a8-41c4-af1b-d0f39ba50974">The main initialisation of Emacs (<code>init.el</code>)</a>), the modules of my
init, and the custom libraries I wrote.
</p>

<p>
In the code snippet further below, I add two directories to the
<code>load-path</code>. Concretely, any Emacs Lisp file inside these directories
is thus declared to Emacs and we can load it properly. Here is what
these two directories are about:
</p>

<dl class="org-dl">
<dt>The <code>prot-emacs-modules</code> directory</dt><dd><p>
This is where I store all the
individual components of my Emacs setup. When I run Emacs, the
directory is a subdirectory of <code>~/.emacs.d/</code>. All files are prefixed
with <code>prot-emacs-</code>, followed by a word that broadly describes their
scope of application, such as <code>prot-emacs-font</code>, <code>prot-emacs-window</code>&#x2026;
</p>

<p>
Each module consists of ordinary Elisp and a final call to <code>provide</code>
the set of configurations as a <i>feature</i> that can then be loaded via
<code>require</code> from the <code>init.el</code>. What Emacs calls a &ldquo;feature&rdquo; is, in
essence, a variable whose value is the entirety of the file that has
a <code>provide</code> call in it. Features are symbols that are named after
the file name minus its file type extension: <code>prot-emacs-theme</code> is
the feature provided by <code>prot-emacs-theme.el</code>.
</p>

<p>
Modules are intended only for configuration purposes.  They do not
define any major variables/functions, unless those are too
small/specific to be extracted into their own library.
</p></dd>

<dt>The <code>prot-lisp</code> directory</dt><dd><p>
As with the aforementioned modules,
this directory is a subdirectory of <code>~/.emacs.d/</code>. This is where I
keep all my custom code that individual modules configure. The
contents of this directory can be understood as fully fledged
&ldquo;packages&rdquo; and, in fact, many of my actual packages started out as
<code>prot-lisp</code> experiments.
</p>

<p>
Each file is written in accordance with the conventions on Emacs
packaging, even though they are only intended for use in my setup
and are not polished to the level of my actual public-facing
packages (meaning the ones listed here: <a href="https://protesilaos.com/emacs">https://protesilaos.com/emacs</a>).
</p></dd>
</dl>

<p>
All this may not matter to you if you are reading either the
<code>prot-emacs.org</code> file or its web page version. Still, this arrangement
gives me maximum flexbility, as I can still share my code the way it
would look. Plus, if I ever decide to stop using the literate config,
I can simply stop editing it and perfom the edits directly in the
files that are already placed where I need them to be.
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(mapc
 (lambda (string)
   (add-to-list 'load-path (locate-user-emacs-file string)))
 '("prot-lisp" "prot-emacs-modules"))
</pre>
</div>
</div>
</div>
<div id="outline-container-h:424340cc-f3d7-4083-93c9-d852d40dfd40" class="outline-3">
<h3 id="h:424340cc-f3d7-4083-93c9-d852d40dfd40"><span class="section-number-3">4.9.</span> The <code>init.el</code> settings for packages (<code>package.el</code>)</h3>
<div class="outline-text-3" id="text-h:424340cc-f3d7-4083-93c9-d852d40dfd40">
<p>
The <code>package.el</code> is built into Emacs and is perfectly fine for my
use-case. We do not need to load it explicitly, as it will be called
by <code>use-package</code> when it needs it. Since the introduction of the
<code>early-init.el</code> file, we also do not need to initialise the packages
at this point: we activate the cache instead (<a href="#h:7a037504-8a2f-4df0-8482-ce6476354440">The <code>early-init.el</code> initialises the package cache</a>).
</p>

<p>
With regard to the settings here, make sure to read my article about
package archives, pinning packages, and setting priorities:
<a href="https://protesilaos.com/codelog/2022-05-13-emacs-elpa-devel/">https://protesilaos.com/codelog/2022-05-13-emacs-elpa-devel/</a>.
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">;;;; Packages

(setq package-vc-register-as-project nil) ; Emacs 30

(add-hook 'package-menu-mode-hook #'hl-line-mode)

;; Also read: &lt;https://protesilaos.com/codelog/2022-05-13-emacs-elpa-devel/&gt;
(setq package-archives
      '(("gnu-elpa" . "https://elpa.gnu.org/packages/")
        ("gnu-elpa-devel" . "https://elpa.gnu.org/devel/")
        ("nongnu" . "https://elpa.nongnu.org/nongnu/")
        ("melpa" . "https://melpa.org/packages/")))

;; Highest number gets priority (what is not mentioned has priority 0)
(setq package-archive-priorities
      '(("gnu-elpa" . 3)
        ("melpa" . 2)
        ("nongnu" . 1)))

;; NOTE 2023-08-21: I build Emacs from source, so I always get the
;; latest version of built-in packages.  However, this is a good
;; solution to set to non-nil if I ever switch to a stable release.
(setq package-install-upgrade-built-in nil)
</pre>
</div>

<p>
I want to use my own packages from the GNU-devel ELPA. I am thus
pinning them to that archive by setting the value of
<code>package-pinned-packages</code>. This way, I get to run the latest version
while also making sure the actual package works properly. All other
packages will rely on <code>package-archive-priorities</code>.
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(defvar prot-emacs-my-packages
  '(agitate
    altcaps
    beframe
    cursory
    denote
    dired-preview
    ef-themes
    fontaine
    lin
    logos
    mct
    modus-themes
    notmuch-indicator
    pulsar
    show-font
    spacious-padding
    standard-themes
    substitute
    sxhkdrc-mode
    theme-buffet
    tmr)
  "List of symbols representing the packages I develop/maintain.")

;; Also read: &lt;https://protesilaos.com/codelog/2022-05-13-emacs-elpa-devel/&gt;
(setq package-pinned-packages
      `(,@(mapcar
           (lambda (package)
             (cons package "gnu-elpa-devel"))
           prot-emacs-my-packages)))
</pre>
</div>
</div>
</div>
<div id="outline-container-h:00213452-3671-4de6-b4ce-ca1b65f79413" class="outline-3">
<h3 id="h:00213452-3671-4de6-b4ce-ca1b65f79413"><span class="section-number-3">4.10.</span> The <code>init.el</code> option to declare all themes as safe</h3>
<div class="outline-text-3" id="text-h:00213452-3671-4de6-b4ce-ca1b65f79413">
<p>
When loading a theme, Emacs will produce a warning explaining how
themes are ordinary Elisp and thus can run harmful code. I understand
why this message is there, but I do not need to be reminded about it.
Setting this to non-nil saves me from the occasional warning if I
ever run <code>load-theme</code> without a <code>NO-CONFIRM</code> argument (like this:
<code>(load-theme 'modus-operandi :no-confirm)</code>).
</p>

<p>
[ Note that Emacs considers the built-in themes &ldquo;safe&rdquo;. This includes my
  <code>modus-themes</code>. ]
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(setq custom-safe-themes t)
</pre>
</div>
</div>
</div>
<div id="outline-container-h:3b14faa6-83fd-4d5f-b3bc-85f72fd572d4" class="outline-3">
<h3 id="h:3b14faa6-83fd-4d5f-b3bc-85f72fd572d4"><span class="section-number-3">4.11.</span> The <code>init.el</code> macro to do nothing with Elisp code (<code>prot-emacs-comment</code>)</h3>
<div class="outline-text-3" id="text-h:3b14faa6-83fd-4d5f-b3bc-85f72fd572d4">
<p>
This is something I learnt while studying Clojure: a <code>comment</code> macro
that wraps some code, effectively commenting it out, while keeping
indentation and syntax highlighting intact.
</p>

<p>
What I have here is technically not commenting out the code, because
the expansion of the macro is nil, not the actual code with comments
around it.
</p>

<pre class="example" id="orga94118e">
(defmacro prot-emacs-comment (&amp;rest body)
  "Do nothing with BODY and return nil, with no side effects."
  (declare (indent defun))
  nil)
</pre>

<p>
The above is an example. What I actually use is the following. It
behaves the same as above, except when it reads a plist of the form
<code>(:eval t)</code>. The idea is for me to quickly activate something I want
to test by passing that to the macro. So here we have it:
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(defmacro prot-emacs-comment (&amp;rest body)
  "Determine what to do with BODY.

If BODY contains an unquoted plist of the form (:eval t) then
return BODY inside a `progn'.

Otherwise, do nothing with BODY and return nil, with no side
effects."
  (declare (indent defun))
  (let ((eval))
    (dolist (element body)
      (when-let* (((plistp element))
                  (key (car element))
                  ((eq key :eval))
                  (val (cadr element)))
        (setq eval val
              body (delq element body))))
    (when eval `(progn ,@body))))
</pre>
</div>

<p>
And here is a function I might develop further to quickly insert
<code>prot-emacs-comment</code> (though another is needed to also remove it and
then a Do-What-I-Mean wrapper to switch between the two):
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">;; Sample use of `prot-emacs-comment'.  The function
;; `prot-emacs-insert-comment-macro' is never evaluated.
(prot-emacs-comment
  (defun prot-emacs-insert-comment-macro (beg end)
    "Wrap region between BEG and END in `prot-emacs-comment'."
    (interactive "r")
    (if (region-active-p)
        (let ((text (buffer-substring beg end)))
          (delete-region beg end)
          (insert (format "(prot-emacs-comment\n%s)" text))
          (indent-region beg end))
      (user-error "No active region; will not insert `prot-emacs-comment' here"))))
</pre>
</div>
</div>
</div>
<div id="outline-container-h:d3684ec0-a972-4033-a4d6-41ee16e891d9" class="outline-3">
<h3 id="h:d3684ec0-a972-4033-a4d6-41ee16e891d9"><span class="section-number-3">4.12.</span> The <code>init.el</code> macro to bind keys (<code>prot-emacs-keybind</code>)</h3>
<div class="outline-text-3" id="text-h:d3684ec0-a972-4033-a4d6-41ee16e891d9">
<p>
[ Watch: <a href="https://protesilaos.com/codelog/2024-01-29-emacs-prefix-map/">define prefix/leader key (nested key maps)</a> (2024-01-29). ]
</p>

<p>
This Lisp macro does not try to be too smart. It simply reduces the
typing we have to do to define key bindings. As with the underlying
<code>define-key</code> function, it can bind a key sequence to a command, a nil
value, or even a keymap. The constraint it imposes is that the
arguments supplied to it as an even number and the odd ones are key
bindings (strings that can be passed to the <code>kbd</code> function). This
means that it does not try to cover the case of <code>[remap COMMAND]</code> (I
am not a fan of it because the code alone does not tell us which key
we end up using (<a href="#h:6b6778af-8bd2-4f97-a794-e23774aa6cf3">Why don&rsquo;t you remap keys?</a>)).
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(defmacro prot-emacs-keybind (keymap &amp;rest definitions)
  "Expand key binding DEFINITIONS for the given KEYMAP.
DEFINITIONS is a sequence of string and command pairs."
  (declare (indent 1))
  (unless (zerop (% (length definitions) 2))
    (error "Uneven number of key+command pairs"))
  (let ((keys (seq-filter #'stringp definitions))
        ;; We do accept nil as a definition: it unsets the given key.
        (commands (seq-remove #'stringp definitions)))
    `(when-let* (((keymapp ,keymap))
                 (map ,keymap))
       ,@(mapcar
          (lambda (pair)
            (let* ((key (car pair))
                   (command (cdr pair)))
              (unless (and (null key) (null command))
                `(define-key map (kbd ,key) ,command))))
          (cl-mapcar #'cons keys commands)))))

;; Sample of `prot-emacs-keybind'

;; (prot-emacs-keybind global-map
;;   "C-z" nil
;;   "C-x b" #'switch-to-buffer
;;   "C-x C-c" nil
;; ;; Notice the -map as I am binding keymap here, not a command:
;;   "C-c b" beframe-prefix-map
;;   "C-x k" #'kill-buffer)
</pre>
</div>
</div>
</div>
<div id="outline-container-h:e7a12825-7848-42bd-b99b-b87903012814" class="outline-3">
<h3 id="h:e7a12825-7848-42bd-b99b-b87903012814"><span class="section-number-3">4.13.</span> The <code>init.el</code> macro to define abbreviations (<code>prot-emacs-abbrev</code>)</h3>
<div class="outline-text-3" id="text-h:e7a12825-7848-42bd-b99b-b87903012814">
<p>
[ Watch: <a href="https://protesilaos.com/codelog/2024-02-03-emacs-abbrev-mode/">abbreviations with abbrev-mode (quick text expansion)</a> (2024-02-03). ]
</p>

<p>
This is the same idea as <code>prot-emacs-keybind</code>, adjusted to work with
the <code>define-abbrev</code> function (<a href="#h:d3684ec0-a972-4033-a4d6-41ee16e891d9">The init.el macro to bind keys (<code>prot-emacs-keybind</code>)</a>).
I probably do not need this, as I only write a small number of
abbreviations. Though it is good to practice some programming.
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(defmacro prot-emacs-abbrev (table &amp;rest definitions)
  "Expand abbrev DEFINITIONS for the given TABLE.
DEFINITIONS is a sequence of (i) string pairs mapping the
abbreviation to its expansion or (ii) a string and symbol pair
making an abbreviation to a function."
  (declare (indent 1))
  (unless (zerop (% (length definitions) 2))
    (error "Uneven number of key+command pairs"))
  `(if (abbrev-table-p ,table)
       (progn
         ,@(mapcar
            (lambda (pair)
              (let ((abbrev (nth 0 pair))
                    (expansion (nth 1 pair)))
                (if (stringp expansion)
                    `(define-abbrev ,table ,abbrev ,expansion)
                  `(define-abbrev ,table ,abbrev "" ,expansion))))
            (seq-split definitions 2)))
     (error "%s is not an abbrev table" ,table)))
</pre>
</div>
</div>
</div>
<div id="outline-container-h:d168edaa-426f-4bd0-8275-3ec3d66bf126" class="outline-3">
<h3 id="h:d168edaa-426f-4bd0-8275-3ec3d66bf126"><span class="section-number-3">4.14.</span> The <code>init.el</code> addition of highlighting for my macros</h3>
<div class="outline-text-3" id="text-h:d168edaa-426f-4bd0-8275-3ec3d66bf126">
<p>
In the previous sections, I define a few Lisp macros that I use
throughout my setup. The following makes these known to Emacs and
specifies how they should be colourised.
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(defvar prot-emacs-package-form-regexp
  "^(\\(prot-emacs-keybind\\|prot-emacs-abbrev\\) +'?\\([0-9a-zA-Z-]+\\)"
  "Regexp to add packages to `lisp-imenu-generic-expression'.")

(eval-after-load 'lisp-mode
  `(add-to-list 'lisp-imenu-generic-expression
                (list "Packages" ,prot-emacs-package-form-regexp 2)))

(defconst prot-emacs-font-lock-keywords
  '(("(\\(prot-emacs-\\(keybind\\|abbrev\\)\\)\\_&gt;[ \t']*\\(\\(\\sw\\|\\s_\\)+\\)?"
     (3 font-lock-variable-name-face nil t))
    ("(\\(prot-emacs-comment\\)\\_&gt;[ \t']*"
     (1 font-lock-preprocessor-face nil t))))

(font-lock-add-keywords 'emacs-lisp-mode prot-emacs-font-lock-keywords)
</pre>
</div>
</div>
</div>
<div id="outline-container-h:e6c4acf5-5b51-4b38-a86a-bf3f698ac872" class="outline-3">
<h3 id="h:e6c4acf5-5b51-4b38-a86a-bf3f698ac872"><span class="section-number-3">4.15.</span> The <code>init.el</code> final part to load the individual modules</h3>
<div class="outline-text-3" id="text-h:e6c4acf5-5b51-4b38-a86a-bf3f698ac872">
<p>
My configuration is split into several modules
(<a href="#h:e289a614-4f17-4d6c-a028-42fe45aebe66">The init.el arrangements for my own modules and custom libraries</a>).
This makes it easier for me to share parts of my code but also to
review it as code without delving into a large Org file (though the
one Org file has its advantages, which is why you are reading this).
</p>

<p>
All I do here is load the modules. Note that some of these are subject
to user options (<a href="#h:5a41861f-4c38-45ac-8da2-51d77c0b4a73">The init.el user options</a>). Those who need to set
those options must have the <code>prot-emacs-pre-custom.el</code> file in place,
as I have already explained in the section about these user options.
</p>

<p>
The individual modules are documented in a section of their own under
<a href="#h:dc3e88c8-4def-4a3f-b63c-9e845b0f98ef">the modules of my Emacs configuration</a>.
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">;; For those who use my dotfiles and need an easy way to write their
;; own extras on top of what I already load.  The file must exist at
;; ~/.emacs.d/prot-emacs-pre-custom.el
;;
;; The purpose of this file is for the user to define their
;; preferences BEFORE loading any of the modules.
(load (locate-user-emacs-file "prot-emacs-pre-custom.el") :no-error :no-message)

(require 'prot-emacs-theme)
(require 'prot-emacs-essentials)
(require 'prot-emacs-modeline)
(require 'prot-emacs-completion)
(require 'prot-emacs-search)
(require 'prot-emacs-dired)
(require 'prot-emacs-window)
(require 'prot-emacs-git)
(require 'prot-emacs-org)
(require 'prot-emacs-langs)
(require 'prot-emacs-email)
(require 'prot-emacs-web)
(when prot-emacs-load-which-key
  (require 'prot-emacs-which-key))
(when prot-emacs-load-icons
  (require 'prot-emacs-icons))

;; For those who use my dotfiles and need an easy way to write their
;; own extras on top of what I already load.  The file must exist at
;; ~/.emacs.d/prot-emacs-post-custom.el
;;
;; The purpose of the "post customisations" is to make tweaks to what
;; I already define, such as to change the default theme.  See above
;; for the `prot-emacs-pre-custom.el' to make changes BEFORE loading
;; any of my other configurations.
(load (locate-user-emacs-file "prot-emacs-post-custom.el") :no-error :no-message)
</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-h:dc3e88c8-4def-4a3f-b63c-9e845b0f98ef" class="outline-2">
<h2 id="h:dc3e88c8-4def-4a3f-b63c-9e845b0f98ef"><span class="section-number-2">5.</span> The modules of my Emacs configuration</h2>
<div class="outline-text-2" id="text-h:dc3e88c8-4def-4a3f-b63c-9e845b0f98ef">
<p>
In my <code>init.el</code> I have a section where I add my modules to the
<code>load-path</code> so that Emacs can run their code (<a href="#h:e289a614-4f17-4d6c-a028-42fe45aebe66">The init.el arrangements for my own modules and custom libraries</a>).
The subheadings of this chapter define modules, each of which is
loaded at the end of my <code>init.el</code> (<a href="#h:e6c4acf5-5b51-4b38-a86a-bf3f698ac872">The init.el final part to load the individual modules</a>).
</p>
</div>
<div id="outline-container-h:8cf67c82-1ebb-4be8-b0e7-161bbf5419ce" class="outline-3">
<h3 id="h:8cf67c82-1ebb-4be8-b0e7-161bbf5419ce"><span class="section-number-3">5.1.</span> The <code>prot-emacs-theme.el</code> module</h3>
<div class="outline-text-3" id="text-h:8cf67c82-1ebb-4be8-b0e7-161bbf5419ce">
<p>
In this module I define everything broadly related to the aesthetics
of Emacs.
</p>
</div>
<div id="outline-container-h:3f1a33e4-762e-4cf3-a0ae-4c2954d9cbb8" class="outline-4">
<h4 id="h:3f1a33e4-762e-4cf3-a0ae-4c2954d9cbb8"><span class="section-number-4">5.1.1.</span> The <code>prot-emacs-theme.el</code> section to load a theme (<code>prot-emacs-load-theme-family</code>)</h4>
<div class="outline-text-4" id="text-h:3f1a33e4-762e-4cf3-a0ae-4c2954d9cbb8">
<p>
We start by loading one of my themes (<a href="#h:5612b5b8-45a5-4a79-a25b-6fa3d9146c39">The init.el option to load a theme family</a>).
These are actually defined in modules of their own, though this is the
only place where they are used.
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">;;; Theme setup and related

;;;; Load the desired theme module
;; These all reference my packages: `modus-themes', `ef-themes',
;; `standard-themes'.
(when prot-emacs-load-theme-family
  (require
   (pcase prot-emacs-load-theme-family
     ('ef 'prot-emacs-ef-themes)
     ('modus 'prot-emacs-modus-themes)
     ('standard 'prot-emacs-standard-themes))))
</pre>
</div>
</div>
<div id="outline-container-h:36af519a-67e1-42b6-a38a-2052638108f9" class="outline-5">
<h5 id="h:36af519a-67e1-42b6-a38a-2052638108f9"><span class="section-number-5">5.1.1.1.</span> The <code>prot-emacs-modus-themes.el</code> module</h5>
<div class="outline-text-5" id="text-h:36af519a-67e1-42b6-a38a-2052638108f9">
<p>
This is one of the components of the <code>prot-emacs-theme.el</code> module
(<a href="#h:3f1a33e4-762e-4cf3-a0ae-4c2954d9cbb8">The <code>prot-emacs-theme.el</code> section to load a theme (<code>prot-emacs-load-theme-family</code>)</a>).
It defines some theme settings and also includes code I use when I
need to test things.
</p>

<p>
The <code>modus-themes</code> are highly accessible themes, conforming with the
highest standard for colour contrast between background and foreground
values (WCAG AAA). They also are optimised for users with red-green or
blue-yellow colour deficiency.
</p>

<p>
The themes are very customisable and provide support for a wide range
of packages.  Their manual is detailed so that new users can get
started, while it also provides custom code for all sorts of more
advanced customisations.
</p>

<p>
Since August 2020, the original Modus themes (<code>modus-operandi</code>,
<code>modus-vivendi</code>) are built into Emacs version 28 or higher.  Emacs 28
ships with <code>modus-themes</code> version <code>1.6.0</code>.  Emacs 29 includes version
<code>3.0.0</code>.  Emacs 30 provides a newer, refactored version that
thoroughly refashions how the themes are implemented and customized.
Such major versions are not backward-compatible due to the limited
resources at my disposal to support multiple versions of Emacs and of
the themes across the years.
</p>

<ul class="org-ul">
<li>Package name (GNU ELPA): <code>modus-themes</code></li>
<li>Official manual: <a href="https://protesilaos.com/emacs/modus-themes">https://protesilaos.com/emacs/modus-themes</a></li>
<li>Change log: <a href="https://protesilaos.com/emacs/modus-themes-changelog">https://protesilaos.com/emacs/modus-themes-changelog</a></li>
<li>Colour palette: <a href="https://protesilaos.com/emacs/modus-themes-colors">https://protesilaos.com/emacs/modus-themes-colors</a></li>
<li>Sample pictures: <a href="https://protesilaos.com/emacs/modus-themes-pictures">https://protesilaos.com/emacs/modus-themes-pictures</a></li>
<li>Git repositories:
<ul class="org-ul">
<li>GitHub: <a href="https://github.com/protesilaos/modus-themes">https://github.com/protesilaos/modus-themes</a></li>
<li>GitLab: <a href="https://gitlab.com/protesilaos/modus-themes">https://gitlab.com/protesilaos/modus-themes</a></li>
</ul></li>
<li>Backronym: My Old Display Unexpectedly Sharpened &#x2026; themes</li>
</ul>

<p>
Note that the <code>prot-emacs-comment</code> is there for my testing purposes
(<a href="#h:3b14faa6-83fd-4d5f-b3bc-85f72fd572d4">The <code>init.el</code> macro to do nothing with Elisp code (<code>prot-emacs-comment</code>)</a>).
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">;;; The Modus themes

;; The themes are highly customisable.  Read the manual:
;; &lt;https://protesilaos.com/emacs/modus-themes&gt;.
(use-package modus-themes
  :ensure t
  :demand t
  :bind (("&lt;f5&gt;" . modus-themes-toggle)
         ("C-&lt;f5&gt;" . modus-themes-select)
         ("M-&lt;f5&gt;" . modus-themes-rotate))
  :config
  (setq modus-themes-custom-auto-reload nil
        modus-themes-to-toggle '(modus-operandi modus-vivendi)
        ;; modus-themes-to-toggle '(modus-operandi-tinted modus-vivendi-tinted)
        ;; modus-themes-to-toggle '(modus-operandi-deuteranopia modus-vivendi-deuteranopia)
        ;; modus-themes-to-toggle '(modus-operandi-tritanopia modus-vivendi-tritanopia)
        modus-themes-to-rotate modus-themes-items
        modus-themes-mixed-fonts t
        modus-themes-variable-pitch-ui t
        modus-themes-italic-constructs t
        modus-themes-bold-constructs nil
        modus-themes-completions '((t . (extrabold)))
        modus-themes-prompts '(extrabold)
        modus-themes-headings
        '((agenda-structure . (variable-pitch light 2.2))
          (agenda-date . (variable-pitch regular 1.3))
          (t . (regular 1.15))))

  (setq modus-themes-common-palette-overrides nil)

  (if (prot-emacs-theme-environment-dark-p)
      (modus-themes-load-theme (cadr modus-themes-to-toggle))
    (modus-themes-load-theme (car modus-themes-to-toggle))))

;; NOTE: For testing purposes
(prot-emacs-comment
  (:eval nil)
  (progn
    (mapc #'disable-theme custom-enabled-themes)

    (add-to-list 'load-path "/home/prot/Git/Projects/modus-themes/")

    (require 'modus-themes)

    (setq modus-themes-custom-auto-reload nil
          modus-themes-to-toggle '(modus-operandi modus-vivendi)
          ;; modus-themes-to-toggle '(modus-operandi-tinted modus-vivendi-tinted)
          ;; modus-themes-to-toggle '(modus-operandi-deuteranopia modus-vivendi-deuteranopia)
          ;; modus-themes-to-toggle '(modus-operandi-tritanopia modus-vivendi-tritanopia)
          modus-themes-mixed-fonts t
          modus-themes-variable-pitch-ui nil
          modus-themes-italic-constructs t
          modus-themes-bold-constructs t
          modus-themes-completions '((t . (extrabold)))
          modus-themes-prompts nil
          modus-themes-headings
          '((agenda-structure . (variable-pitch light 2.2))
            (agenda-date . (variable-pitch regular 1.3))
            (t . (regular 1.15))))

    ;; (setq modus-themes-common-palette-overrides nil)

    (setq modus-themes-common-palette-overrides
          `((fringe unspecified)
            ;; (bg-mode-line-active bg-lavender)
            ;; (border-mode-line-active unspecified)
            ;; (border-mode-line-inactive unspecified)
            (bg-line-number-active bg-hl-line)
            (bg-line-number-inactive unspecified)
            (fg-line-number-active fg-main)
            ;; ,@modus-themes-preset-overrides-warmer
            ))

    ;; ;; For testing purposes I only want the overrides for those two
    ;; ;; Modus themes.  The rest have their own styles already.
    ;;
    ;; (let ((overrides '((cursor blue-intense)
    ;;                    (keybind green-cooler)
    ;;                    (comment red-faint)
    ;;                    (bg-paren-match unspecified)
    ;;                    (fg-paren-match magenta-intense)
    ;;                    (underline-paren-match magenta-intense))))
    ;;   (setq modus-operandi-palette-overrides overrides
    ;;         modus-vivendi-palette-overrides overrides))


    ;; ;; Make the active mode line have a pseudo 3D effect (this assumes
    ;; ;; you are using the default mode line and not an extra package).
    ;; (custom-set-faces
    ;;  '(mode-line ((t :box (:style unspecified)))))

    (if (prot-emacs-theme-environment-dark-p)
        (modus-themes-load-theme (cadr modus-themes-to-toggle))
      (modus-themes-load-theme (car modus-themes-to-toggle)))

    ;; Also check `modus-themes-select'.  To list the palette's colours,
    ;; use `modus-themes-list-colors', `modus-themes-list-colors-current'.
    (define-key global-map (kbd "&lt;f5&gt;") #'modus-themes-toggle)))

(provide 'prot-emacs-modus-themes)
</pre>
</div>
</div>
</div>
<div id="outline-container-h:2b2a27a1-6d2e-4b59-bf60-94682e173f2f" class="outline-5">
<h5 id="h:2b2a27a1-6d2e-4b59-bf60-94682e173f2f"><span class="section-number-5">5.1.1.2.</span> The <code>prot-emacs-ef-themes.el</code> module</h5>
<div class="outline-text-5" id="text-h:2b2a27a1-6d2e-4b59-bf60-94682e173f2f">
<p>
This is one of the components of the <code>prot-emacs-theme.el</code> module
(<a href="#h:3f1a33e4-762e-4cf3-a0ae-4c2954d9cbb8">The <code>prot-emacs-theme.el</code> section to load a theme (<code>prot-emacs-load-theme-family</code>)</a>).
It defines some theme settings and also includes code I use when I
need to test things.
</p>

<p>
The <code>ef-themes</code> are a collection of light and dark themes for GNU
Emacs that provide colourful (&ldquo;pretty&rdquo;) yet legible options for users
who want something with a bit more flair than the <code>modus-themes</code> (also
designed by me).
</p>

<ul class="org-ul">
<li>Package name (GNU ELPA): <code>ef-themes</code></li>
<li>Official manual: <a href="https://protesilaos.com/emacs/ef-themes">https://protesilaos.com/emacs/ef-themes</a></li>
<li>Change log: <a href="https://protesilaos.com/emacs/ef-themes-changelog">https://protesilaos.com/emacs/ef-themes-changelog</a></li>
<li>Sample pictures: <a href="https://protesilaos.com/emacs/ef-themes-pictures">https://protesilaos.com/emacs/ef-themes-pictures</a></li>
<li>Git repositories:
<ul class="org-ul">
<li>GitHub: <a href="https://github.com/protesilaos/ef-themes">https://github.com/protesilaos/ef-themes</a></li>
<li>GitLab: <a href="https://gitlab.com/protesilaos/ef-themes">https://gitlab.com/protesilaos/ef-themes</a></li>
</ul></li>
<li>Backronym: Eclectic Fashion in Themes Hides Exaggerated Markings,
Embellishments, and Sparkles.</li>
</ul>

<p>
Note that the <code>prot-emacs-comment</code> is there for my testing purposes
(<a href="#h:3b14faa6-83fd-4d5f-b3bc-85f72fd572d4">The <code>init.el</code> macro to do nothing with Elisp code (<code>prot-emacs-comment</code>)</a>).
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">;;; The Ef (εὖ) themes

;; The themes are customisable.  Read the manual:
;; &lt;https://protesilaos.com/emacs/ef-themes&gt;.
(use-package ef-themes
  :ensure t
  :demand t
  :bind
  (("&lt;f5&gt;" . ef-themes-rotate)
   ("C-&lt;f5&gt;" . ef-themes-select))
  :config
  (setq ef-themes-variable-pitch-ui t
        ef-themes-mixed-fonts t
        ef-themes-rotate ef-themes-items
        ef-themes-headings ; read the manual's entry of the doc string
        '((0 . (variable-pitch light 1.9))
          (1 . (variable-pitch light 1.8))
          (2 . (variable-pitch regular 1.7))
          (3 . (variable-pitch regular 1.6))
          (4 . (variable-pitch regular 1.5))
          (5 . (variable-pitch 1.4)) ; absence of weight means `bold'
          (6 . (variable-pitch 1.3))
          (7 . (variable-pitch 1.2))
          (agenda-date . (semilight 1.5))
          (agenda-structure . (variable-pitch light 1.9))
          (t . (variable-pitch 1.1))))

  ;; The `ef-themes' provide lots of themes.  I want to pick one at
  ;; random when I start Emacs: the `ef-themes-load-random' does just
  ;; that (it can be called interactively as well).  I just check with
  ;; my desktop environment to determine if the choice should be about
  ;; a light or a dark theme.  Those functions are in my init.el.
  (if (prot-emacs-theme-environment-dark-p)
      (ef-themes-load-random 'dark)
    (ef-themes-load-random 'light)))

;; NOTE: For testing purposes
(prot-emacs-comment
  (:eval nil)
  (progn
    (mapc #'disable-theme custom-enabled-themes)

    (add-to-list 'load-path "/home/prot/Git/Projects/ef-themes/")

    (require 'ef-themes)
    (load-theme 'ef-arbutus t t)
    (load-theme 'ef-autumn t t)
    (load-theme 'ef-bio t t)
    (load-theme 'ef-cherie t t)
    (load-theme 'ef-cyprus t t)
    (load-theme 'ef-dark t t)
    (load-theme 'ef-day t t)
    (load-theme 'ef-deuteranopia-dark t t)
    (load-theme 'ef-deuteranopia-light t t)
    (load-theme 'ef-duo-dark t t)
    (load-theme 'ef-duo-light t t)
    (load-theme 'ef-eagle t t)
    (load-theme 'ef-frost t t)
    (load-theme 'ef-kassio t t)
    (load-theme 'ef-light t t)
    (load-theme 'ef-melissa-dark t t)
    (load-theme 'ef-melissa-light t t)
    (load-theme 'ef-night t t)
    (load-theme 'ef-owl t t)
    (load-theme 'ef-rosa t t)
    (load-theme 'ef-spring t t)
    (load-theme 'ef-summer t t)
    (load-theme 'ef-symbiosis t t)
    (load-theme 'ef-trio-dark t t)
    (load-theme 'ef-trio-light t t)
    (load-theme 'ef-tritanopia-dark t t)
    (load-theme 'ef-tritanopia-light t t)
    (load-theme 'ef-winter t t)

    (setq ef-themes-headings ; read the manual's entry or the doc string
          '((0 . (variable-pitch light 1.9))
            (1 . (variable-pitch light 1.8))
            (2 . (variable-pitch light 1.7))
            (3 . (variable-pitch semilight 1.6))
            (4 . (variable-pitch semilight 1.5))
            (5 . (variable-pitch regular 1.4))
            (6 . (variable-pitch regular 1.3))
            (7 . (variable-pitch regular 1.2))    ; absence of weight means `bold'
            (agenda-date . (semilight 1.5))
            (agenda-structure . (variable-pitch light 1.9))
            (t . (variable-pitch regular 1.1))))

    ;; They are nil by default...
    (setq ef-themes-mixed-fonts t
          ef-themes-variable-pitch-ui nil)

    (mapcar (lambda (theme)
              (add-to-list
               'custom-theme-load-path
               (concat "/home/prot/Git/Projects/ef-themes/" (symbol-name theme) "-theme.el")))
            (ef-themes--list-enabled-themes))

    (if (prot-emacs-theme-environment-dark-p)
        (ef-themes-load-random 'dark)
      (ef-themes-load-random 'light))

    (define-key global-map (kbd "&lt;f5&gt;") #'ef-themes-rotate)
    (define-key global-map (kbd "C-&lt;f5&gt;") #'ef-themes-select)))

(provide 'prot-emacs-ef-themes)
</pre>
</div>
</div>
</div>
<div id="outline-container-h:0c7a240c-211f-4571-a5ba-433e510f487f" class="outline-5">
<h5 id="h:0c7a240c-211f-4571-a5ba-433e510f487f"><span class="section-number-5">5.1.1.3.</span> The <code>prot-emacs-standard-themes.el</code> module</h5>
<div class="outline-text-5" id="text-h:0c7a240c-211f-4571-a5ba-433e510f487f">
<p>
This is one of the components of the <code>prot-emacs-theme.el</code> module
(<a href="#h:3f1a33e4-762e-4cf3-a0ae-4c2954d9cbb8">The <code>prot-emacs-theme.el</code> section to load a theme (<code>prot-emacs-load-theme-family</code>)</a>).
It defines some theme settings and also includes code I use when I
need to test things.
</p>

<p>
The <code>standard-themes</code> are a collection of light and dark themes for
GNU Emacs. The <code>standard-light</code> and <code>standard-dark</code> emulate the
out-of-the-box looks of Emacs (which technically do NOT constitute a
theme) while bringing to them thematic consistency, customizability,
and extensibility. Other themes are stylistic variations of those.
</p>

<p>
In practice, the Standard themes take the default style of the
font-lock and Org faces, complement it with a wider and harmonious
colour palette, address many inconsistencies, and apply established
semantic patterns across all interfaces by supporting a large number
of packages.
</p>

<p>
Note that the <code>prot-emacs-comment</code> is there for my testing purposes
(<a href="#h:3b14faa6-83fd-4d5f-b3bc-85f72fd572d4">The <code>init.el</code> macro to do nothing with Elisp code (<code>prot-emacs-comment</code>)</a>).
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">;;; The Standard themes

;; The themes are customisable.  Read the manual:
;; &lt;https://protesilaos.com/emacs/standard-themes&gt;.

(use-package standard-themes
  :ensure t
  :demand t
  :bind (("&lt;f5&gt;" . standard-themes-toggle)
         ("M-&lt;f5&gt;" . standard-themes-rotate))
  :config
  (setq standard-themes-bold-constructs t
        standard-themes-italic-constructs t
        standard-themes-mixed-fonts t
        standard-themes-variable-pitch-ui t

        ;; more complex alist to set weight, height, and optional
        ;; `variable-pitch' per heading level (t is for any level not
        ;; specified)
        standard-themes-headings
        '((0 . (variable-pitch light 1.9))
          (1 . (variable-pitch light 1.8))
          (2 . (variable-pitch light 1.7))
          (3 . (variable-pitch semilight 1.6))
          (4 . (variable-pitch semilight 1.5))
          (5 . (variable-pitch 1.4))
          (6 . (variable-pitch 1.3))
          (7 . (variable-pitch 1.2))
          (agenda-date . (1.3))
          (agenda-structure . (variable-pitch light 1.8))
          (t . (variable-pitch 1.1))))

  ;; Load a theme that is consistent with my session's theme.  Those
  ;; functions are defined in my init.el.
  (standard-themes-load-theme
   (if (prot-emacs-theme-environment-dark-p)
       'standard-dark
     'standard-light)))

;; NOTE: For testing purposes
(prot-emacs-comment
  (:eval nil)
  (progn
    (mapc #'disable-theme custom-enabled-themes)

    (add-to-list 'load-path "/home/prot/Git/Projects/standard-themes/")

    (require 'standard-themes)
    (load-theme 'standard-dark t t)
    (load-theme 'standard-light t t)
    (load-theme 'standard-dark-tinted t t)
    (load-theme 'standard-light-tinted t t)

    (setq standard-themes-bold-constructs t
          standard-themes-italic-constructs t
          standard-themes-disable-other-themes t
          standard-themes-mixed-fonts t
          standard-themes-variable-pitch-ui t

          ;; more complex alist to set weight, height, and optional
          ;; `variable-pitch' per heading level (t is for any level not
          ;; specified)
          standard-themes-headings
          '((0 . (variable-pitch light 1.9))
            (1 . (variable-pitch light 1.8))
            (2 . (variable-pitch light 1.7))
            (3 . (variable-pitch semilight 1.6))
            (4 . (variable-pitch semilight 1.5))
            (5 . (variable-pitch 1.4))
            (6 . (variable-pitch 1.3))
            (7 . (variable-pitch 1.2))
            (agenda-date . (1.3))
            (agenda-structure . (variable-pitch light 1.8))
            (t . (variable-pitch 1.1))))

    (mapcar (lambda (theme)
              (add-to-list
               'custom-theme-load-path
               (concat "/home/prot/Git/Projects/standard-themes/" (symbol-name theme) "-theme.el")))
            (standard-themes--list-enabled-themes))

    (standard-themes-load-theme
     (if (prot-emacs-theme-environment-dark-p)
         'standard-dark
       'standard-light))

    (define-key global-map (kbd "&lt;f5&gt;") #'standard-themes-toggle)
    (define-key global-map (kbd "M-&lt;f5&gt;") #'standard-themes-rotate)))

(provide 'prot-emacs-standard-themes)
</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-h:7f2b317d-a70e-44e6-a93c-fa4c4b4b8e2e" class="outline-4">
<h4 id="h:7f2b317d-a70e-44e6-a93c-fa4c4b4b8e2e"><span class="section-number-4">5.1.2.</span> The <code>prot-emacs-theme.el</code> section for <code>pulsar</code></h4>
<div class="outline-text-4" id="text-h:7f2b317d-a70e-44e6-a93c-fa4c4b4b8e2e">
<p>
This is a small package of mine that temporarily highlights the
current line after a given function is invoked. The affected functions
are defined in the user option <code>pulsar-pulse-functions</code>. What Pulsar
does is set up an advice so that those functions run a hook after they
are called. The pulse effect is added there (<code>pulsar-after-function-hook</code>).
</p>

<ul class="org-ul">
<li>Package name (GNU ELPA): <code>pulsar</code></li>
<li>Official manual: <a href="https://protesilaos.com/emacs/pulsar">https://protesilaos.com/emacs/pulsar</a></li>
<li>Change log: <a href="https://protesilaos.com/emacs/pulsar-changelog">https://protesilaos.com/emacs/pulsar-changelog</a></li>
<li>Git repositories:
<ul class="org-ul">
<li>GitHub: <a href="https://github.com/protesilaos/pulsar">https://github.com/protesilaos/pulsar</a></li>
<li>GitLab: <a href="https://gitlab.com/protesilaos/pulsar">https://gitlab.com/protesilaos/pulsar</a></li>
</ul></li>
<li>Backronym: Pulsar Unquestionably Luminates, Strictly Absent the Radiation</li>
</ul>

<div class="org-src-container">
<pre class="src src-emacs-lisp">;;;; Pulsar
;; Read the pulsar manual: &lt;https://protesilaos.com/emacs/pulsar&gt;.
(use-package pulsar
  :ensure t
  :config
  (setopt pulsar-pulse t
          pulsar-delay 0.055
          pulsar-iterations 10
          pulsar-face 'pulsar-green
          pulsar-highlight-face 'pulsar-magenta)

  (pulsar-global-mode 1)
  :hook
  ;; There are convenience functions/commands which pulse the line using
  ;; a specific colour: `pulsar-pulse-line-red' is one of them.
  ((next-error . (pulsar-pulse-line-red pulsar-recenter-top pulsar-reveal-entry))
   (minibuffer-setup . pulsar-pulse-line-red))
  :bind
  ;; pulsar does not define any key bindings.  This is just my personal
  ;; preference.  Remember to read the manual on the matter.  Evaluate:
  ;;
  ;; (info "(elisp) Key Binding Conventions")
  (("C-x l" . pulsar-pulse-line) ; override `count-lines-page'
   ("C-x L" . pulsar-highlight-dwim))) ; or use `pulsar-highlight-line'
</pre>
</div>
</div>
</div>
<div id="outline-container-h:bf5b4d08-8f33-4a8c-8ecd-fca19bf2497a" class="outline-4">
<h4 id="h:bf5b4d08-8f33-4a8c-8ecd-fca19bf2497a"><span class="section-number-4">5.1.3.</span> The <code>prot-emacs-theme.el</code> section for <code>lin</code></h4>
<div class="outline-text-4" id="text-h:bf5b4d08-8f33-4a8c-8ecd-fca19bf2497a">
<p>
My <code>lin</code> package is a stylistic enhancement for Emacs&rsquo; built-in
<code>hl-line-mode</code>. It remaps the <code>hl-line</code> face (or equivalent)
buffer-locally to a style that is optimal for major modes where line
selection is the primary mode of interaction.
</p>

<p>
The idea is that <code>hl-line-mode</code> cannot work equally well for contexts
with competing priorities: (i) line selection, or (ii) simple line
highlight. In the former case, the current line needs to be made
prominent because it carries a specific meaning of some significance
in the given context: the user has to select a line. Whereas in the
latter case, the primary mode of interaction does not revolve around
the line highlight itself: it may be because the focus is on editing
text or reading through the buffer&rsquo;s contents, so the current line
highlight is more of a reminder of the point&rsquo;s location on the
vertical axis.
</p>

<ul class="org-ul">
<li>Package name (GNU ELPA): <code>lin</code></li>
<li>Official manual: <a href="https://protesilaos.com/emacs/lin">https://protesilaos.com/emacs/lin</a></li>
<li>Change log: <a href="https://protesilaos.com/emacs/lin-changelog">https://protesilaos.com/emacs/lin-changelog</a></li>
<li>Git repositories:
<ul class="org-ul">
<li>GitHub: <a href="https://github.com/protesilaos/lin">https://github.com/protesilaos/lin</a></li>
<li>GitLab: <a href="https://gitlab.com/protesilaos/lin">https://gitlab.com/protesilaos/lin</a></li>
</ul></li>
<li>Backronym: LIN Is Noticeable</li>
</ul>

<div class="org-src-container">
<pre class="src src-emacs-lisp">;;;; Lin
;; Read the lin manual: &lt;https://protesilaos.com/emacs/lin&gt;.
(use-package lin
  :ensure t
  :hook (after-init . lin-global-mode) ; applies to all `lin-mode-hooks'
  :config
  ;; You can use this to live update the face:
  ;;
  ;; (customize-set-variable 'lin-face 'lin-green)
  ;;
  ;; Or `setopt' on Emacs 29: (setopt lin-face 'lin-yellow)
  ;;
  ;; I still prefer `setq' for consistency.
  (setq lin-face 'lin-cyan))
</pre>
</div>
</div>
</div>
<div id="outline-container-h:6c118185-fcb1-4c9a-93af-71814cb84279" class="outline-4">
<h4 id="h:6c118185-fcb1-4c9a-93af-71814cb84279"><span class="section-number-4">5.1.4.</span> The <code>prot-emacs-theme.el</code> section for <code>spacious-padding</code></h4>
<div class="outline-text-4" id="text-h:6c118185-fcb1-4c9a-93af-71814cb84279">
<p>
This package provides a global minor mode to increase the
spacing/padding of Emacs windows and frames. The idea is to make
editing and reading feel more comfortable. Enable the mode with <code>M-x
spacious-padding-mode</code>. Adjust the exact spacing values by modifying
the user option <code>spacious-padding-widths</code>.
</p>

<p>
Inspiration for this package comes from <a href="https://github.com/rougier">Nicolas Rougier&rsquo;s impressive designs</a>
and <a href="https://github.com/minad/org-modern">Daniel Mendler&rsquo;s <code>org-modern</code> package</a>.
</p>

<ul class="org-ul">
<li>Package name (GNU ELPA): <code>spacious-padding</code></li>
<li>Official manual: <a href="https://protesilaos.com/emacs/spacious-padding">https://protesilaos.com/emacs/spacious-padding</a></li>
<li>Git repositories:
<ul class="org-ul">
<li>GitHub: <a href="https://github.com/protesilaos/spacious-padding">https://github.com/protesilaos/spacious-padding</a></li>
<li>GitLab: <a href="https://gitlab.com/protesilaos/spacious-padding">https://gitlab.com/protesilaos/spacious-padding</a></li>
</ul></li>
<li>Sample images:
<ul class="org-ul">
<li><a href="https://protesilaos.com/codelog/2023-06-03-emacs-spacious-padding/">https://protesilaos.com/codelog/2023-06-03-emacs-spacious-padding/</a></li>
<li><a href="https://protesilaos.com/codelog/2023-11-15-spacious-padding-extra-ui-dev/">https://protesilaos.com/codelog/2023-11-15-spacious-padding-extra-ui-dev/</a></li>
</ul></li>
<li>Backronyms: Space Perception Adjusted Consistently Impacts Overall
Usability State &#x2026; padding; Spacious &#x2026; Precise Adjustments to
Desktop Divider Internals Neatly Generated.</li>
</ul>

<p>
I also take care to make it work with my customised mode line
(<a href="#h:41ee38d0-9099-4444-85e4-cc8dce00fb9a">The <code>prot-emacs-modeline.el</code> module</a>).
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">;;;; Increase padding of windows/frames
;; Yet another one of my packages:
;; &lt;https://protesilaos.com/codelog/2023-06-03-emacs-spacious-padding/&gt;.
(use-package spacious-padding
  :ensure t
  :if (display-graphic-p)
  :hook (after-init . spacious-padding-mode)
  :bind ("&lt;f8&gt;" . spacious-padding-mode)
  :init
  ;; These are the defaults, but I keep it here for visiibility.
  (setq spacious-padding-widths
        '( :internal-border-width 30
           :header-line-width 4
           :mode-line-width 6
           :tab-width 4
           :right-divider-width 30
           :scroll-bar-width 8
           :left-fringe-width 20
           :right-fringe-width 20))

  ;; Read the doc string of `spacious-padding-subtle-mode-line' as
  ;; it is very flexible.
  (setq spacious-padding-subtle-mode-line
        '( :mode-line-active spacious-padding-subtle-mode-line-active
           :mode-line-inactive spacious-padding-subtle-mode-line-inactive)))
</pre>
</div>
</div>
</div>
<div id="outline-container-h:9438236e-a8a4-45e0-8c61-8268c634d50b" class="outline-4">
<h4 id="h:9438236e-a8a4-45e0-8c61-8268c634d50b"><span class="section-number-4">5.1.5.</span> The <code>prot-emacs-theme.el</code> section for <code>rainbow-mode</code></h4>
<div class="outline-text-4" id="text-h:9438236e-a8a4-45e0-8c61-8268c634d50b">
<p>
This package produces an in-buffer preview of a colour value. I use
those while developing my themes, hence the <code>prot/rainbow-mode-in-themes</code>
to activate <code>rainbow-mode</code> if I am editing a theme file.
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">;;;; Rainbow mode for colour previewing (rainbow-mode.el)
(use-package rainbow-mode
  :ensure t
  :init
  (setq rainbow-ansi-colors nil)
  (setq rainbow-x-colors nil)

  (defun prot/rainbow-mode-in-themes ()
    (when-let* ((file (buffer-file-name))
                ((derived-mode-p 'emacs-lisp-mode))
                ((string-match-p "-theme" file)))
      (rainbow-mode 1)))
  :bind ( :map ctl-x-x-map
          ("c" . rainbow-mode)) ; C-x x c
  :hook (emacs-lisp-mode . prot/rainbow-mode-in-themes))
</pre>
</div>
</div>
</div>
<div id="outline-container-h:34ce98fe-0b57-44d9-b5f3-0224632114a5" class="outline-4">
<h4 id="h:34ce98fe-0b57-44d9-b5f3-0224632114a5"><span class="section-number-4">5.1.6.</span> The <code>prot-emacs-theme.el</code> section for <code>cursory</code></h4>
<div class="outline-text-4" id="text-h:34ce98fe-0b57-44d9-b5f3-0224632114a5">
<p>
My <code>cursory</code> package provides a thin wrapper around built-in variables
that affect the style of the Emacs cursor on graphical terminals. The
intent is to allow the user to define preset configurations such as
&ldquo;block with slow blinking&rdquo; or &ldquo;bar with fast blinking&rdquo; and set them on
demand. The use-case for such presets is to adapt to evolving
interface requirements and concomitant levels of expected comfort,
such as in the difference between writing and reading.
</p>

<ul class="org-ul">
<li>Package name (GNU ELPA): <code>cursory</code></li>
<li>Official manual: <a href="https://protesilaos.com/emacs/cursory">https://protesilaos.com/emacs/cursory</a></li>
<li>Change log: <a href="https://protesilaos.com/emacs/cursory-changelog">https://protesilaos.com/emacs/cursory-changelog</a></li>
<li>Git repositories:
<ul class="org-ul">
<li>GitHub: <a href="https://github.com/protesilaos/cursory">https://github.com/protesilaos/cursory</a></li>
<li>GitLab: <a href="https://gitlab.com/protesilaos/cursory">https://gitlab.com/protesilaos/cursory</a></li>
</ul></li>
<li>Backronym: Cursor Usability Requires Styles Objectively Rated Yearlong</li>
</ul>

<div class="org-src-container">
<pre class="src src-emacs-lisp">;;; Cursor appearance (cursory)
;; Read the manual: &lt;https://protesilaos.com/emacs/cursory&gt;.
(use-package cursory
  :ensure t
  :demand t
  :if (display-graphic-p)
  :config
  (setq cursory-presets
        '((box
           :blink-cursor-interval 1.2)
          (box-no-blink
           :blink-cursor-mode -1)
          (bar
           :cursor-type (bar . 2)
           :blink-cursor-interval 0.8)
          (bar-no-other-window
           :inherit bar
           :cursor-in-non-selected-windows nil)
          (bar-no-blink
           :cursor-type (bar . 2)
           :blink-cursor-mode -1)
          (underscore
           :cursor-type (hbar . 3)
           :blink-cursor-interval 0.3
           :blink-cursor-blinks 50)
          (underscore-no-other-window
           :inherit underscore
           :cursor-in-non-selected-windows nil)
          (underscore-thick
           :cursor-type (hbar . 8)
           :blink-cursor-interval 0.3
           :blink-cursor-blinks 50
           :cursor-in-non-selected-windows (hbar . 3))
          (underscore-thick-no-blink
           :blink-cursor-mode -1
           :cursor-type (hbar . 8)
           :cursor-in-non-selected-windows (hbar . 3))
          (t ; the default values
           :cursor-type box
           :cursor-in-non-selected-windows hollow
           :blink-cursor-mode 1
           :blink-cursor-blinks 10
           :blink-cursor-interval 0.2
           :blink-cursor-delay 0.2)))

  ;; I am using the default values of `cursory-latest-state-file'.

  ;; Set last preset or fall back to desired style from `cursory-presets'.
  (cursory-set-preset (or (cursory-restore-latest-preset) 'box))

  (cursory-mode 1)
  :bind
  ;; We have to use the "point" mnemonic, because C-c c is often the
  ;; suggested binding for `org-capture' and is the one I use as well.
  ("C-c p" . cursory-set-preset))
</pre>
</div>
</div>
</div>
<div id="outline-container-h:2af10314-c8c2-4946-bf9c-a5b0f5fe881b" class="outline-4">
<h4 id="h:2af10314-c8c2-4946-bf9c-a5b0f5fe881b"><span class="section-number-4">5.1.7.</span> The <code>prot-emacs-theme.el</code> section for <code>theme-buffet</code></h4>
<div class="outline-text-4" id="text-h:2af10314-c8c2-4946-bf9c-a5b0f5fe881b">
<p>
The <code>theme-buffet</code> package arranges to automatically change themes
during specific times of the day or at fixed intervals. The collection
of themes is customisable, with the default options covering the
built-in Emacs themes as well as my <code>modus-themes</code> and <code>ef-themes</code>.
</p>

<p>
Bruno Boal is the lead developer and I am a co-maintainer.
</p>

<ul class="org-ul">
<li>Package name (GNU ELPA): <code>theme-buffet</code></li>
<li>Git repo on SourceHut: <a href="https://git.sr.ht/~bboal/theme-buffet">https://git.sr.ht/~bboal/theme-buffet</a>
<ul class="org-ul">
<li>Mirrors:
<ul class="org-ul">
<li>GitHub: <a href="https://github.com/BBoal/theme-buffet">https://github.com/BBoal/theme-buffet</a></li>
<li>Codeberg: <a href="https://codeberg.org/BBoal/theme-buffet">https://codeberg.org/BBoal/theme-buffet</a></li>
</ul></li>
</ul></li>
<li>Mailing list: <a href="https://lists.sr.ht/~bboal/general-issues">https://lists.sr.ht/~bboal/general-issues</a></li>
<li>Backronym: Themes Harmoniously Exchanged Mid Evening Beget
Understandable Feelings of Fascination, Excitement, and Thrill.</li>
</ul>

<div class="org-src-container">
<pre class="src src-emacs-lisp">;;;; Theme buffet
(use-package theme-buffet
  :ensure t
  :after (:any modus-themes ef-themes)
  :defer 1
  :config
  (let ((modus-themes-p (featurep 'modus-themes))
        (ef-themes-p (featurep 'ef-themes)))
    (setq theme-buffet-menu 'end-user)
    (setq theme-buffet-end-user
          (cond
           ((and modus-themes-p ef-themes-p)
            '( :night     (modus-vivendi ef-dark ef-winter ef-autumn ef-night ef-duo-dark ef-symbiosis)
               :morning   (modus-operandi ef-light ef-cyprus ef-spring ef-frost ef-duo-light)
               :afternoon (modus-operandi-tinted ef-arbutus ef-day ef-kassio ef-summer ef-elea-light ef-maris-light ef-melissa-light ef-trio-light ef-reverie)
               :evening   (modus-vivendi-tinted ef-rosa ef-elea-dark ef-maris-dark ef-melissa-dark ef-trio-dark ef-dream)))
           (ef-themes-p
            '( :night     (ef-dark ef-winter ef-autumn ef-night ef-duo-dark ef-symbiosis ef-owl)
               :morning   (ef-light ef-cyprus ef-spring ef-frost ef-duo-light ef-eagle)
               :afternoon (ef-arbutus ef-day ef-kassio ef-summer ef-elea-light ef-maris-light ef-melissa-light ef-trio-light ef-reverie)
               :evening   (ef-rosa ef-elea-dark ef-maris-dark ef-melissa-dark ef-trio-dark ef-dream)))
           (modus-themes-p
            '( :night     (modus-vivendi modus-vivendi-tinted modus-vivendi-tritanopia modus-vivendi-deuteranopia)
               :morning   (modus-operandi modus-operandi-tinted modus-operandi-tritanopia modus-operandi-deuteranopia)
               :afternoon (modus-operandi modus-operandi-tinted modus-operandi-tritanopia modus-operandi-deuteranopia)
               :evening   (modus-vivendi modus-vivendi-tinted modus-vivendi-tritanopia modus-vivendi-deuteranopia)))))

    (when (or modus-themes-p ef-themes-p)
      (theme-buffet-timer-hours 1))))
</pre>
</div>
</div>
</div>
<div id="outline-container-h:cb41fef0-41a5-4a85-9552-496d96290258" class="outline-4">
<h4 id="h:cb41fef0-41a5-4a85-9552-496d96290258"><span class="section-number-4">5.1.8.</span> The <code>prot-emacs-theme.el</code> section about <code>fontaine</code></h4>
<div class="outline-text-4" id="text-h:cb41fef0-41a5-4a85-9552-496d96290258">
<p>
[ Watch: <a href="https://protesilaos.com/codelog/2024-01-16-customize-emacs-fonts/">Customise Emacs fonts</a> (2024-01-16) ]
</p>

<p>
My <code>fontaine</code> package allows the user to define detailed font
configurations and set them on demand. For example, one can have a
<code>regular-editing</code> preset and another for <code>presentation-mode</code> (these
are arbitrary, user-defined symbols): the former uses small fonts
which are optimised for writing, while the latter applies typefaces
that are pleasant to read at comfortable point sizes.
</p>

<ul class="org-ul">
<li>Package name (GNU ELPA): <code>fontaine</code></li>
<li>Official manual: <a href="https://protesilaos.com/emacs/fontaine">https://protesilaos.com/emacs/fontaine</a></li>
<li>Change log: <a href="https://protesilaos.com/emacs/fontaine-changelog">https://protesilaos.com/emacs/fontaine-changelog</a></li>
<li>Git repositories:
<ul class="org-ul">
<li>GitHub: <a href="https://github.com/protesilaos/fontaine">https://github.com/protesilaos/fontaine</a></li>
<li>GitLab: <a href="https://gitlab.com/protesilaos/fontaine">https://gitlab.com/protesilaos/fontaine</a></li>
</ul></li>
<li>Backronym: Fonts, Ornaments, and Neat Typography Are Irrelevant in
Non-graphical Emacs</li>
</ul>

<p>
You will notice that all my fonts are Iosevka Comfy variants. I
explain what this is about (<a href="#h:3b989679-7e3f-4f03-b4bb-611006ea01ce">Information about my Iosevka Comfy fonts</a>).
</p>

<p>
Another section defines some complementary functionality
(<a href="#h:60d6aae2-6e4b-402c-b6a8-411fc49a6857">The <code>prot-emacs-theme.el</code> section about <code>variable-pitch-mode</code> and font resizing</a>).
</p>

<p>
Also check my <code>show-font</code> package (<a href="#h:60a005be-77bd-49f1-a865-78d7cf75bd2a">The <code>prot-emacs-theme.el</code> section about <code>show-font</code></a>).
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">;;;; Fontaine (font configurations)
;; Read the manual: &lt;https://protesilaos.com/emacs/fontaine&gt;
(use-package fontaine
  :ensure t
  :hook
  ;; Persist the latest font preset when closing/starting Emacs.
  ((after-init . fontaine-mode)
   (after-init . (lambda ()
                   ;; Set last preset or fall back to desired style from `fontaine-presets'.
                   (fontaine-set-preset (or (fontaine-restore-latest-preset) 'regular)))))
  :bind (("C-c f" . fontaine-set-preset)
         ("C-c F" . fontaine-toggle-preset))
  :config
  ;; This is defined in Emacs C code: it belongs to font settings.
  (setq x-underline-at-descent-line nil)

  ;; And this is for Emacs28.
  (setq-default text-scale-remap-header-line t)

  ;; This is the default value.  Just including it here for
  ;; completeness.
  (setq fontaine-latest-state-file (locate-user-emacs-file "fontaine-latest-state.eld"))

  (setq fontaine-presets
        '((tiny
           :default-family "Iosevka Comfy Wide"
           :default-height 70
           :default-weight light
           :fixed-pitch-family "Iosevka Comfy Wide"
           :variable-pitch-family "Iosevka Comfy Wide Motion Duo"
           :bold-weight extrabold)
          (small
           :default-height 80)
          (regular) ; like this it uses all the fallback values and is named `regular'
          (medium
           :default-weight semilight
           :default-height 115
           :bold-weight extrabold)
          (live-stream
           :default-family "Iosevka Comfy Wide Motion"
           :default-height 130
           :default-weight light
           :fixed-pitch-family "Iosevka Comfy Wide Motion"
           :variable-pitch-family "Iosevka Comfy Wide Duo"
           :bold-weight extrabold)
          (large
           :inherit medium
           :default-height 150)
          (presentation
           :default-height 180)
          (jumbo
           :default-height 260)
          (t
           ;; I keep all properties for didactic purposes, but most can be
           ;; omitted.  See the fontaine manual for the technicalities:
           ;; &lt;https://protesilaos.com/emacs/fontaine&gt;.
           :default-family "Iosevka Comfy"
           :default-weight regular
           :default-slant normal
           :default-width normal
           :default-height 100

           :fixed-pitch-family "Iosevka Comfy"
           :fixed-pitch-weight nil
           :fixed-pitch-slant nil
           :fixed-pitch-width nil
           :fixed-pitch-height 1.0

           :fixed-pitch-serif-family nil
           :fixed-pitch-serif-weight nil
           :fixed-pitch-serif-slant nil
           :fixed-pitch-serif-width nil
           :fixed-pitch-serif-height 1.0

           :variable-pitch-family "Iosevka Comfy Motion Duo"
           :variable-pitch-weight nil
           :variable-pitch-slant nil
           :variable-pitch-width nil
           :variable-pitch-height 1.0

           :mode-line-active-family nil
           :mode-line-active-weight nil
           :mode-line-active-slant nil
           :mode-line-active-width nil
           :mode-line-active-height 1.0

           :mode-line-inactive-family nil
           :mode-line-inactive-weight nil
           :mode-line-inactive-slant nil
           :mode-line-inactive-width nil
           :mode-line-inactive-height 1.0

           :header-line-family nil
           :header-line-weight nil
           :header-line-slant nil
           :header-line-width nil
           :header-line-height 1.0

           :line-number-family nil
           :line-number-weight nil
           :line-number-slant nil
           :line-number-width nil
           :line-number-height 1.0

           :tab-bar-family nil
           :tab-bar-weight nil
           :tab-bar-slant nil
           :tab-bar-width nil
           :tab-bar-height 1.0

           :tab-line-family nil
           :tab-line-weight nil
           :tab-line-slant nil
           :tab-line-width nil
           :tab-line-height 1.0

           :bold-family nil
           :bold-slant nil
           :bold-weight bold
           :bold-width nil
           :bold-height 1.0

           :italic-family nil
           :italic-weight nil
           :italic-slant italic
           :italic-width nil
           :italic-height 1.0

           :line-spacing nil)))

  (with-eval-after-load 'pulsar
    (add-hook 'fontaine-set-preset-hook #'pulsar-pulse-line)))
</pre>
</div>
</div>
</div>
<div id="outline-container-h:60a005be-77bd-49f1-a865-78d7cf75bd2a" class="outline-4">
<h4 id="h:60a005be-77bd-49f1-a865-78d7cf75bd2a"><span class="section-number-4">5.1.9.</span> The <code>prot-emacs-theme.el</code> section about <code>show-font</code></h4>
<div class="outline-text-4" id="text-h:60a005be-77bd-49f1-a865-78d7cf75bd2a">
<p>
This is yet another package of mine. It lets you preview a font inside
of Emacs. It does so in three ways:
</p>

<ul class="org-ul">
<li>Prompt for a font on the system and display it in a buffer.</li>
<li>List all known fonts in a buffer, with a short preview for each.</li>
<li>Provide a major mode to preview a font whose file is among the
installed ones.</li>
</ul>

<p>
Check out its sources:
</p>

<ul class="org-ul">
<li>Package name (GNU ELPA): <code>show-font</code></li>
<li>Official manual: <a href="https://protesilaos.com/emacs/show-font">https://protesilaos.com/emacs/show-font</a></li>
<li>Change log: <a href="https://protesilaos.com/emacs/show-font-changelog">https://protesilaos.com/emacs/show-font-changelog</a></li>
<li>Git repository: <a href="https://github.com/protesilaos/show-font">https://github.com/protesilaos/show-font</a></li>
<li>Sample pictures: <a href="https://protesilaos.com/codelog/2024-09-10-emacs-show-font-0-1-0/">https://protesilaos.com/codelog/2024-09-10-emacs-show-font-0-1-0/</a></li>
<li>Backronym: Show How Outlines Will Feature Only in Non-TTY.</li>
</ul>

<p>
To actually set fonts, I use my <code>fontaine</code> package (<a href="#h:cb41fef0-41a5-4a85-9552-496d96290258">The <code>prot-emacs-theme.el</code> section about <code>fontaine</code></a>).
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">;;;; Show Font (preview fonts)
;; Read the manual: &lt;https://protesilaos.com/emacs/show-font&gt;
(use-package show-font
  :ensure t
  :if (display-graphic-p)
  :commands (show-font-select-preview show-font-list show-font-tabulated)
  :config
  ;; These are the defaults, but I keep them here for easier access.
  (setq show-font-pangram 'prot)
  (setq show-font-character-sample
        "
ABCDEFGHIJKLMNOPQRSTUVWXYZ
abcdefghijklmnopqrstuvwxyz
0123456789   !@#$¢%^&amp;*~|
`'\"‘’“”.,;:  ()[]{}—-_+=&lt;&gt;

()[]{}&lt;&gt;«»‹› 6bB8&amp;0ODdoa 1tiIlL|\/
!ij c¢ 5$Ss 7Z2z 9gqp nmMNNMW uvvwWuuw
x×X .,·°;:¡!¿?`'‘’   ÄAÃÀ TODO
"))
</pre>
</div>
</div>
</div>
<div id="outline-container-h:60d6aae2-6e4b-402c-b6a8-411fc49a6857" class="outline-4">
<h4 id="h:60d6aae2-6e4b-402c-b6a8-411fc49a6857"><span class="section-number-4">5.1.10.</span> The <code>prot-emacs-theme.el</code> section about <code>variable-pitch-mode</code> and font resizing</h4>
<div class="outline-text-4" id="text-h:60d6aae2-6e4b-402c-b6a8-411fc49a6857">
<p>
[ Watch: <a href="https://protesilaos.com/codelog/2024-01-16-customize-emacs-fonts/">Customise Emacs fonts</a> (2024-01-16) ]
</p>

<p>
The built-in <code>variable-pitch-mode</code> makes the current buffer use a
proportionately spaced font. In technical terms, it remaps the
<code>default</code> face to <code>variable-pitch</code>, so whatever applies to the latter
takes effect over the former. I take care of their respective font
families in my <code>fontaine</code> setup (<a href="#h:cb41fef0-41a5-4a85-9552-496d96290258">The <code>prot-emacs-theme.el</code> section about <code>fontaine</code></a>).
</p>

<p>
I want to activate <code>variable-pitch-mode</code> in all buffers where I
normally focus on prose. The exact mode hooks are specified in the
variable <code>prot/enable-variable-pitch-in-hooks</code>. Exceptions to these
are major modes that I do not consider related to prose (and which in
my opinion should not be derived from <code>text-mode</code>): these are excluded
in the function <code>prot/enable-variable-pitch</code>.
</p>

<p>
Then I also arrange the key bindings that resize text on-the-fly. I
want those to have a global effect, meaning that they affect all
buffers and the minibuffer, instead of the default behaviour to only
adjust the current buffer&rsquo;s text size (<a href="#h:6b6778af-8bd2-4f97-a794-e23774aa6cf3">Why don&rsquo;t you remap keys?</a>).
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">;;;;; `variable-pitch-mode' setup
(use-package face-remap
  :ensure nil
  :functions prot/enable-variable-pitch
  :bind ( :map ctl-x-x-map
          ("v" . variable-pitch-mode))
  :hook ((text-mode notmuch-show-mode elfeed-show-mode) . prot/enable-variable-pitch)
  :config
  ;; NOTE 2022-11-20: This may not cover every case, though it works
  ;; fine in my workflow.  I am still undecided by EWW.
  (defun prot/enable-variable-pitch ()
    (unless (derived-mode-p 'mhtml-mode 'nxml-mode 'yaml-mode)
      (variable-pitch-mode 1)))
;;;;; Resize keys with global effect
  :bind
  ;; Emacs 29 introduces commands that resize the font across all
  ;; buffers (including the minibuffer), which is what I want, as
  ;; opposed to doing it only in the current buffer.  The keys are the
  ;; same as the defaults.
  (("C-x C-=" . global-text-scale-adjust)
   ("C-x C-+" . global-text-scale-adjust)
   ("C-x C-0" . global-text-scale-adjust)))
</pre>
</div>
</div>
<div id="outline-container-h:3b989679-7e3f-4f03-b4bb-611006ea01ce" class="outline-5">
<h5 id="h:3b989679-7e3f-4f03-b4bb-611006ea01ce"><span class="section-number-5">5.1.10.1.</span> Information about my Iosevka Comfy fonts</h5>
<div class="outline-text-5" id="text-h:3b989679-7e3f-4f03-b4bb-611006ea01ce">
<p>
<i>Iosevka Comfy</i> is a customised build of the Iosevka typeface, with a
consistent rounded style and overrides for almost all individual
glyphs in both roman (upright) and italic (slanted) variants. Many
font families are available, covering a broad range of typographic
weights. The README file in the git repository covers all the
technicalities.
</p>

<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="org-left" />

<col  class="org-left" />

<col  class="org-left" />

<col  class="org-left" />

<col  class="org-left" />
</colgroup>
<thead>
<tr>
<th scope="col" class="org-left">Family</th>
<th scope="col" class="org-left">Shapes</th>
<th scope="col" class="org-left">Spacing</th>
<th scope="col" class="org-left">Style</th>
<th scope="col" class="org-left">Ligatures</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left">Iosevka Comfy</td>
<td class="org-left">Sans</td>
<td class="org-left">Compact</td>
<td class="org-left">Monospaced</td>
<td class="org-left">Yes</td>
</tr>

<tr>
<td class="org-left">Iosevka Comfy Fixed</td>
<td class="org-left">Sans</td>
<td class="org-left">Compact</td>
<td class="org-left">Monospaced</td>
<td class="org-left">No</td>
</tr>

<tr>
<td class="org-left">Iosevka Comfy Duo</td>
<td class="org-left">Sans</td>
<td class="org-left">Compact</td>
<td class="org-left">Duospaced</td>
<td class="org-left">Yes</td>
</tr>
</tbody>
<tbody>
<tr>
<td class="org-left">Iosevka Comfy Motion</td>
<td class="org-left">Slab</td>
<td class="org-left">Compact</td>
<td class="org-left">Monospaced</td>
<td class="org-left">Yes</td>
</tr>

<tr>
<td class="org-left">Iosevka Comfy Motion Fixed</td>
<td class="org-left">Slab</td>
<td class="org-left">Compact</td>
<td class="org-left">Monospaced</td>
<td class="org-left">No</td>
</tr>

<tr>
<td class="org-left">Iosevka Comfy Motion Duo</td>
<td class="org-left">Slab</td>
<td class="org-left">Compact</td>
<td class="org-left">Duospaced</td>
<td class="org-left">Yes</td>
</tr>
</tbody>
<tbody>
<tr>
<td class="org-left">Iosevka Comfy Wide</td>
<td class="org-left">Sans</td>
<td class="org-left">Wide</td>
<td class="org-left">Monospaced</td>
<td class="org-left">Yes</td>
</tr>

<tr>
<td class="org-left">Iosevka Comfy Wide Fixed</td>
<td class="org-left">Sans</td>
<td class="org-left">Wide</td>
<td class="org-left">Monospaced</td>
<td class="org-left">No</td>
</tr>

<tr>
<td class="org-left">Iosevka Comfy Wide Duo</td>
<td class="org-left">Sans</td>
<td class="org-left">Wide</td>
<td class="org-left">Duospaced</td>
<td class="org-left">Yes</td>
</tr>
</tbody>
<tbody>
<tr>
<td class="org-left">Iosevka Comfy Wide Motion</td>
<td class="org-left">Slab</td>
<td class="org-left">Wide</td>
<td class="org-left">Monospaced</td>
<td class="org-left">Yes</td>
</tr>

<tr>
<td class="org-left">Iosevka Comfy Wide Motion Fixed</td>
<td class="org-left">Slab</td>
<td class="org-left">Wide</td>
<td class="org-left">Monospaced</td>
<td class="org-left">No</td>
</tr>

<tr>
<td class="org-left">Iosevka Comfy Wide Motion Duo</td>
<td class="org-left">Slab</td>
<td class="org-left">Wide</td>
<td class="org-left">Duospaced</td>
<td class="org-left">Yes</td>
</tr>
</tbody>
</table>

<ul class="org-ul">
<li>Git repositories:
<ul class="org-ul">
<li>GitHub: <a href="https://github.com/protesilaos/iosevka-comfy">https://github.com/protesilaos/iosevka-comfy</a></li>
<li>GitLab: <a href="https://gitlab.com/protesilaos/iosevka-comfy">https://gitlab.com/protesilaos/iosevka-comfy</a></li>
</ul></li>
<li>Sample pictures: <a href="https://protesilaos.com/emacs/iosevka-comfy-pictures">https://protesilaos.com/emacs/iosevka-comfy-pictures</a></li>
<li>Backronym: Iosevka &#x2026; Could Only Modify a Font, Yes</li>
</ul>
</div>
</div>
</div>
<div id="outline-container-h:bac0ce0a-db68-42e7-ba2c-f350f91f80ef" class="outline-4">
<h4 id="h:bac0ce0a-db68-42e7-ba2c-f350f91f80ef"><span class="section-number-4">5.1.11.</span> The <code>prot-emacs-theme.el</code> call to <code>provide</code></h4>
<div class="outline-text-4" id="text-h:bac0ce0a-db68-42e7-ba2c-f350f91f80ef">
<p>
Finally, we <code>provide</code> the module. This is the mirror function of
<code>require</code> (<a href="#h:e6c4acf5-5b51-4b38-a86a-bf3f698ac872">The init.el final part to load the individual modules</a>).
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(provide 'prot-emacs-theme)
</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-h:0ef52ed9-7b86-4329-ae4e-eff9ab8d07f2" class="outline-3">
<h3 id="h:0ef52ed9-7b86-4329-ae4e-eff9ab8d07f2"><span class="section-number-3">5.2.</span> The <code>prot-emacs-essentials.el</code> module</h3>
<div class="outline-text-3" id="text-h:0ef52ed9-7b86-4329-ae4e-eff9ab8d07f2">
<p>
This module load basic configurations that apply to most facets of
Emacs. Many of my own custom libraries are loaded here
(<a href="#h:e289a614-4f17-4d6c-a028-42fe45aebe66">The init.el arrangements for my own modules and custom libraries</a>).
</p>
</div>
<div id="outline-container-h:713ede33-3802-40c6-a8e3-7e1fc0d0a924" class="outline-4">
<h4 id="h:713ede33-3802-40c6-a8e3-7e1fc0d0a924"><span class="section-number-4">5.2.1.</span> The <code>prot-emacs-essentials.el</code> block with basic configurations</h4>
<div class="outline-text-4" id="text-h:713ede33-3802-40c6-a8e3-7e1fc0d0a924">
<p>
Better use <code>C-h v</code> (<code>M-x describe-variable</code>) to learn about each of
these variables. Since I am here, I also unbind or repurpose some of the default
key bindings.
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">;;; Essential configurations
(use-package emacs
  :ensure nil
  :demand t
  :config
;;;; General settings and common custom functions (prot-simple.el)
  (setq blink-matching-paren nil)
  (setq delete-pair-blink-delay 0.1) ; Emacs28 -- see `prot-simple-delete-pair-dwim'
  (setq delete-pair-push-mark t) ; Emacs 31
  (setq help-window-select t)
  (setq next-error-recenter '(4)) ; center of the window
  (setq find-library-include-other-files nil) ; Emacs 29
  (setq remote-file-name-inhibit-delete-by-moving-to-trash t) ; Emacs 30
  (setq remote-file-name-inhibit-auto-save t)                 ; Emacs 30
  (setq tramp-connection-timeout (* 60 10)) ; seconds
  (setq save-interprogram-paste-before-kill t)
  (setq mode-require-final-newline 'visit-save)
  (setq-default truncate-partial-width-windows nil)
  (setq eval-expression-print-length nil)
  (setq kill-do-not-save-duplicates t)
  (setq duplicate-line-final-position -1 ; both are Emacs 29
        duplicate-region-final-position -1)
  (setq scroll-error-top-bottom t)
  (setq echo-keystrokes-help nil) ; Emacs 30
  (setq epa-keys-select-method 'minibuffer) ; Emacs 30
  (setq trusted-content '("~/Git/Projects/")) ; Emacs 30

  ;; Keys I unbind here are either to avoid accidents or to bind them
  ;; elsewhere later in the configuration.
  :bind
  ( :map global-map
    ("&lt;f2&gt;" . toggle-input-method)  ; F2 overrides that two-column gimmick.  Sorry, but no!
    ("&lt;insert&gt;" . nil)
    ("&lt;menu&gt;" . nil)
    ("C-x C-d" . nil) ; never use it
    ("C-x C-v" . nil) ; never use it
    ("C-z" . nil) ; I have a window manager, thanks!
    ("C-x C-z" . nil) ; same idea as above
    ("C-x C-c" . nil) ; avoid accidentally exiting Emacs
    ("C-x C-c C-c" . save-buffers-kill-emacs) ; more cumbersome, less error-prone
    ("C-x C-r" . restart-emacs) ; override `find-file-read-only'
    ("C-h h" . nil) ; Never show that "hello" file
    ("M-`" . nil)
    ("M-o" . delete-blank-lines) ; alias for C-x C-o
    ("M-SPC" . cycle-spacing)
    ("M-z" . zap-up-to-char) ; NOT `zap-to-char'
    ("M-c" . capitalize-dwim)
    ("M-l" . downcase-dwim) ; "lower" case
    ("M-u" . upcase-dwim)
    ("M-=" . count-words)
    ("C-x O" . next-multiframe-window)
    ("C-h K" . describe-keymap) ; overrides `Info-goto-emacs-key-command-node'
    ("C-h u" . apropos-user-option)
    ("C-h F" . apropos-function) ; lower case is `describe-function'
    ("C-h V" . apropos-variable) ; lower case is `describe-variable'
    ("C-h L" . apropos-library) ; lower case is `view-lossage'
    ("C-h c" . describe-char) ; overrides `describe-key-briefly'

    :map prog-mode-map
    ("C-M-d" . up-list) ; confusing name for what looks like "down" to me
    ("&lt;C-M-backspace&gt;" . backward-kill-sexp)

    ;; Keymap for buffers (Emacs28)
    :map ctl-x-x-map
    ("f" . follow-mode)  ; override `font-lock-update'
    ("r" . rename-uniquely)
    ("l" . visual-line-mode)))
</pre>
</div>
</div>
</div>
<div id="outline-container-h:116854fa-2e31-4d23-ae6f-72f57ed571bc" class="outline-4">
<h4 id="h:116854fa-2e31-4d23-ae6f-72f57ed571bc"><span class="section-number-4">5.2.2.</span> The <code>prot-emacs-essentials.el</code> section about <code>prot-common.el</code> (custom basic functions)</h4>
<div class="outline-text-4" id="text-h:116854fa-2e31-4d23-ae6f-72f57ed571bc">
<p>
<a href="#h:3fccfadf-22e9-457f-b9fd-ed1b48600d23">The <code>prot-common.el</code> library</a> contains custom snippets that I use in
various other parts of my setup, notably my custom libraries
(&ldquo;packages&rdquo;). All I do here is load it, so that others will have it
available by the time they need it.
</p>

<p>
Since the <code>prot-common.el</code> defines some basic functions that can be
used outside the narrow confines of my custom code, I set them up
here:
</p>

<ol class="org-ol">
<li>Truncate lines by default in a number of places and do not produce
a message about the fact. Note that the function used to achieve
this, i.e. <code>prot-common-truncate-lines-silently</code>, may also be set
up elsewhere and described in that context. Here I only cover the
basic parent modes.</li>

<li>Make <code>M-x</code> not produce any message about how such and such command
can also be called via this or that key binding. If I am doing
something with <code>M-x</code> instead of a key binding, I have a good reason
for it and do not want the extra noise.</li>
</ol>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(use-package prot-common
  :ensure nil
  :functions (prot-common-truncate-lines-silently)
  :hook ((text-mode prog-mode dired-mode prot/fundamental-mode) . prot-common-truncate-lines-silently)
  :init
  (defvar prot/fundamental-mode-hook nil
    "Normal hook for `fundamental-mode' (which is missing by default).")

  (defun prot/fundamental-mode-run-hook (&amp;rest args)
    "Apply ARGS and then run `prot/fundamental-mode-hook'."
    (apply args)
    (run-hooks 'prot/fundamental-mode-hook))

  (advice-add #'fundamental-mode :around #'prot/fundamental-mode-run-hook)
  :config
  ;; NEVER tell me which key can call a command that I specifically
  ;; invoked with M-x: I have a good reason to use it that way.
  (advice-add #'execute-extended-command--describe-binding-msg :override #'prot-common-ignore))
</pre>
</div>
</div>
</div>
<div id="outline-container-h:f15bc843-2dd1-4792-95ec-9b7b6e561804" class="outline-4">
<h4 id="h:f15bc843-2dd1-4792-95ec-9b7b6e561804"><span class="section-number-4">5.2.3.</span> The <code>prot-emacs-essentials.el</code> section about <code>prot-simple.el</code> (custom basic commands)</h4>
<div class="outline-text-4" id="text-h:f15bc843-2dd1-4792-95ec-9b7b6e561804">
<p>
<a href="#h:5f78e837-0d27-4390-bd9a-6d0bca57fa50">The <code>prot-simple.el</code> library</a> is done in the same spirit as the
built-in <code>simple.el</code>: it is a file with a collection of little
commands that are useful for everyday tasks. I bind these commands to
keys.
</p>

<p>
The <code>prot-simple-display-unsaved-buffers-on-exit</code> produces a list of
unsaved, file-visiting buffers before closing Emacs. I am doing this
using the advice mechanism to redefine the behaviour of the original
command (<code>save-buffers-kill-emacs</code>), since I cannot find a way to do
this via some hook.
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(use-package prot-simple
  :ensure nil
  :demand t
  :config
  (setq prot-simple-date-specifier "%F")
  (setq prot-simple-time-specifier "%R %z")

  (advice-add #'save-buffers-kill-emacs :before #'prot-simple-display-unsaved-buffers-on-exit)

  (with-eval-after-load 'pulsar
    (add-hook 'prot-simple-file-to-register-jump-hook #'pulsar-recenter-center)
    (add-hook 'prot-simple-file-to-register-jump-hook #'pulsar-reveal-entry))
  :bind
  ( ("ESC ESC" . prot-simple-keyboard-quit-dwim)
    ("C-g" . prot-simple-keyboard-quit-dwim)
    ("C-M-SPC" . prot-simple-mark-sexp)   ; will be overriden by `expreg' if tree-sitter is available
    ;; Commands for lines
    ("M-k" . prot-simple-kill-line-backward)
    ("M-j" . delete-indentation)
    ("M-w" . prot-simple-kill-ring-save)
    ("C-S-d" . prot-simple-duplicate-line-or-region)
    ("C-S-w" . prot-simple-copy-line)
    ("C-S-y" . prot-simple-yank-replace-line-or-region)
    ("C-v" . prot-simple-multi-line-below) ; overrides `scroll-up-command'
    ("&lt;next&gt;" . prot-simple-multi-line-below) ; overrides `scroll-up-command'
    ("M-v" . prot-simple-multi-line-above) ; overrides `scroll-down-command'
    ("&lt;prior&gt;" . prot-simple-multi-line-above) ; overrides `scroll-down-command'
    ("&lt;C-return&gt;" . prot-simple-new-line-below)
    ("&lt;C-S-return&gt;" . prot-simple-new-line-above)
    ("C-x x a" . prot-simple-auto-fill-visual-line-mode) ; auto-fill/visual-line toggle
    ;; Commands for text insertion or manipulation
    ("C-=" . prot-simple-insert-date)
    ("C-&lt;" . prot-simple-escape-url-dwim)
    ;; "C-&gt;" prot-simple-insert-line-prefix-dwim
    ("M-Z" . prot-simple-zap-to-char-backward)
    ;; Commands for object transposition
    ("C-S-p" . prot-simple-move-above-dwim)
    ("C-S-n" . prot-simple-move-below-dwim)
    ("C-t" . prot-simple-transpose-chars)
    ("C-x C-t" . prot-simple-transpose-lines)
    ("C-S-t" . prot-simple-transpose-paragraphs)
    ("C-x M-t" . prot-simple-transpose-sentences)
    ("C-M-t" . prot-simple-transpose-sexps)
    ("M-t" . prot-simple-transpose-words)
    ;; Commands for paragraphs
    ("M-Q" . prot-simple-unfill-region-or-paragraph)
    ;; Commands for windows and pages
    ("C-x o" . prot-simple-other-window)
    ("C-x n k" . prot-simple-delete-page-delimiters)
    ("C-x M-r" . prot-simple-swap-window-buffers)
    ;; Commands for buffers
    ("&lt;C-f2&gt;" . prot-simple-rename-file-and-buffer)
    ("C-x k" . prot-simple-kill-buffer-current)
    ("C-x K" . kill-buffer) ; leaving this here to contrast with the above
    ("M-s b" . prot-simple-buffers-major-mode)
    ("M-s v" . prot-simple-buffers-vc-root)
    ;; Commands for files
    ("C-x r ." . prot-simple-file-to-register)))
</pre>
</div>
</div>
</div>
<div id="outline-container-h:45b4fffa-2ce3-4119-b8c9-081a75135d98" class="outline-4">
<h4 id="h:45b4fffa-2ce3-4119-b8c9-081a75135d98"><span class="section-number-4">5.2.4.</span> The <code>prot-emacs-essentials.el</code> section about <code>prot-scratch.el</code> (scratch buffer per major mode)</h4>
<div class="outline-text-4" id="text-h:45b4fffa-2ce3-4119-b8c9-081a75135d98">
<p>
<a href="#h:efebaec4-7273-4c5a-a4c4-9f99df0e46bb">The <code>prot-scratch.el</code> library</a> provides the means to create a scratch
buffer for a given major mode. It has the option to set a default
major mode to use. It can also copy the active region into the scratch
buffer. Read the doc string of the command <code>prot-scratch-buffer</code>.
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">;;;; Scratch buffers per major mode (prot-scratch.el)
(use-package prot-scratch
  :ensure nil
  :bind ("C-c s" . prot-scratch-buffer)
  :config
  (setq prot-scratch-default-mode 'text-mode))
</pre>
</div>
</div>
</div>
<div id="outline-container-h:48d2bab5-241f-49dd-9554-8a4dcedce75e" class="outline-4">
<h4 id="h:48d2bab5-241f-49dd-9554-8a4dcedce75e"><span class="section-number-4">5.2.5.</span> The <code>prot-emacs-essentials.el</code> section about <code>prot-pair.el</code> (insert character pairs)</h4>
<div class="outline-text-4" id="text-h:48d2bab5-241f-49dd-9554-8a4dcedce75e">
<p>
<a href="#h:0a3f076d-386d-47e6-8af9-f17d02d507cf">The <code>prot-pair.el</code> library</a> defines a mechanism to insert character
pairs around the symbol at point or the active region. There is a user
option called <code>prot-pair-pairs</code>, which specifies which characters form
pairs. This can also run a function to set a pair according to some
context, environment, or any such condition. I use it to insert
quotation marks specific to natural languages I have set up.
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">;;;; Insert character pairs (prot-pair.el)
(use-package prot-pair
  :ensure nil
  :bind
  (("C-'" . prot-pair-insert)
   ("M-'" . prot-pair-insert)
   ("M-\\" . prot-pair-delete)))
</pre>
</div>
</div>
</div>
<div id="outline-container-h:85755648-bf1f-408b-bc65-4db357fbf1dd" class="outline-4">
<h4 id="h:85755648-bf1f-408b-bc65-4db357fbf1dd"><span class="section-number-4">5.2.6.</span> The <code>prot-emacs-essentials.el</code> section for comments</h4>
<div class="outline-text-4" id="text-h:85755648-bf1f-408b-bc65-4db357fbf1dd">
<p>
<a href="#h:7affcbca-0808-4159-8eab-faa7973aefc7">The <code>prot-comment.el</code> library</a> expands the built-in commenting
facilities with what makes sense to me. The <code>prot-comment</code> command is
like the built-in <code>comment-dwim</code>, but toggles linewise commenting
instead of appending to them by default. While the <code>prot-comment-timestamp-keyword</code>
prompts for a keyword among <code>prot-comment-keywords</code> and formats it as
a comment with a timestamp next to it. The format of the latter is
controlled by the user option <code>prot-comment-timestamp-format-concise</code>
or <code>prot-comment-timestamp-format-verbose</code> (the verbose is set when
the command is called with a prefix argument (<code>C-u</code> by default)).
</p>

<p>
A big part of writing code is the ability to quickly insert comments.
I have a custom library that builds on what Emacs makes available by
default (<a href="#h:7affcbca-0808-4159-8eab-faa7973aefc7">The <code>prot-comment.el</code> library</a>). While I use this section of
the module to set my desired configurations.
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">;;;; Comments (prot-comment.el)
(use-package prot-comment
  :ensure nil
  :init
  (setq comment-empty-lines t)
  (setq comment-fill-column nil)
  (setq comment-multi-line t)
  (setq comment-style 'multi-line)
  (setq-default comment-column 0)

  (setq prot-comment-comment-keywords '("TODO" "NOTE" "XXX" "REVIEW" "FIXME"))
  (setq prot-comment-timestamp-format-concise "%F")
  (setq prot-comment-timestamp-format-verbose "%F %T %z")
  :bind
  (("C-;" . prot-comment)
   ("C-x C-;" . prot-comment-timestamp-keyword)))
</pre>
</div>
</div>
</div>
<div id="outline-container-h:15ad94b3-f714-4b39-973e-b68c76b38be3" class="outline-4">
<h4 id="h:15ad94b3-f714-4b39-973e-b68c76b38be3"><span class="section-number-4">5.2.7.</span> The <code>prot-emacs-essentials.el</code> section about <code>prot-prefix.el</code> (prefix nested keymaps)</h4>
<div class="outline-text-4" id="text-h:15ad94b3-f714-4b39-973e-b68c76b38be3">
<p>
[ Watch: <a href="https://protesilaos.com/codelog/2024-01-29-emacs-prefix-map/">define prefix/leader key (nested key maps)</a> (2024-01-29). ]
</p>

<p>
<a href="#h:f860bd85-671e-477e-8233-23a8ba43e1c6">The <code>prot-prefix.el</code> library</a> defines a set of keymaps with commonly
used commands and puts them behind a prefix map. The idea is to hit a
series of keys to get to the desired command. Keymaps are organised
thematically and rely on strong mnemonics, such as <code>b</code> for buffers,
<code>w</code> for windows, and so on. The <code>which-key</code> package is a nice addition
for this purpose, as it visualises incomplete key bindings after a
configurable amount of time (<a href="#h:ddb1070d-2f91-4224-ad43-ef03f038f787">The <code>prot-emacs-which-key.el</code> module</a>).
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">;;;; Prefix keymap (prot-prefix.el)
(use-package prot-prefix
  :ensure nil
  :bind-keymap
  (("&lt;insert&gt;" . prot-prefix)
   ("C-z" . prot-prefix)))
</pre>
</div>
</div>
</div>
<div id="outline-container-h:f9aa7523-d88a-4080-add6-073f36cb8b9a" class="outline-4">
<h4 id="h:f9aa7523-d88a-4080-add6-073f36cb8b9a"><span class="section-number-4">5.2.8.</span> The <code>prot-emacs-essentials.el</code> configuration to track recently visited files</h4>
<div class="outline-text-4" id="text-h:f9aa7523-d88a-4080-add6-073f36cb8b9a">
<p>
Emacs can keep track of recently visited files. Then we can revisit
them with the command <code>recent-open</code>, which provides minibuffer
completion (<a href="#h:15edf2c3-4419-4101-928a-6e224958a741">The <code>prot-emacs-completion.el</code> module</a>).
</p>

<p>
Recent files are also available in the <code>consult-buffer</code> interface,
which makes it a one-stop-shop for opening buffers, recent files, or
bookmarks (<a href="#h:22e97b4c-d88d-4deb-9ab3-f80631f9ff1d">The <code>prot-emacs-completion.el</code> settings for <code>consult</code></a>).
This can be better than having to remember if something is a buffer or
is stored by bookmarks/recentf. Same idea for using one command
instead of three (or more).
</p>

<p>
I generally do not rely on <code>recentf-mode</code>, as most of my work is done
in projects, which I switch to directly. Though I sometimes need to
revisit a file that I do not need to keep track of.
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(use-package recentf
  :ensure nil
  :hook (after-init . recentf-mode)
  :config
  (setq recentf-max-saved-items 100)
  (setq recentf-max-menu-items 25) ; I don't use the `menu-bar-mode', but this is good to know
  (setq recentf-save-file-modes nil)
  (setq recentf-keep nil)
  (setq recentf-auto-cleanup nil)
  (setq recentf-initialize-file-name-history nil)
  (setq recentf-filename-handlers nil)
  (setq recentf-show-file-shortcuts-flag nil))
</pre>
</div>
</div>
</div>
<div id="outline-container-h:982ad7cd-01b9-4178-be58-0e24251d3608" class="outline-4">
<h4 id="h:982ad7cd-01b9-4178-be58-0e24251d3608"><span class="section-number-4">5.2.9.</span> The <code>prot-emacs-essentials.el</code> mouse configurations</h4>
<div class="outline-text-4" id="text-h:982ad7cd-01b9-4178-be58-0e24251d3608">
<p>
I do use the mouse on occasion. More so when I am doing a video
demonstration.
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">;;;; Mouse and mouse wheel behaviour
(use-package mouse
  :ensure nil
  :hook (after-init . mouse-wheel-mode)
  :config
  ;; Some of these variables are defined in places other than
  ;; mouse.el, but this is fine.
  (setq mouse-autoselect-window t) ; complements the auto-selection of my tiling window manager

  ;; In Emacs 27+, use Control + mouse wheel to scale text.
  (setq mouse-wheel-scroll-amount
        '(1
          ((shift) . 5)
          ((meta) . 0.5)
          ((control) . text-scale))
        mouse-drag-copy-region nil
        make-pointer-invisible t
        mouse-wheel-progressive-speed t
        mouse-wheel-follow-mouse t)

  ;; Scrolling behaviour
  (setq-default scroll-preserve-screen-position t
                scroll-conservatively 1 ; affects `scroll-step'
                scroll-margin 0
                next-screen-context-lines 0))
</pre>
</div>
</div>
</div>
<div id="outline-container-h:fbe6f9da-25ee-46a3-bb03-8fa7c1d48dab" class="outline-4">
<h4 id="h:fbe6f9da-25ee-46a3-bb03-8fa7c1d48dab"><span class="section-number-4">5.2.10.</span> The <code>prot-emacs-essentials.el</code> settings for <code>repeat-mode</code></h4>
<div class="outline-text-4" id="text-h:fbe6f9da-25ee-46a3-bb03-8fa7c1d48dab">
<p>
The <code>repeat-mode</code> is designed to find when a &ldquo;repeatable&rdquo; command is
called and arrange so that it can be called again with single key
press. A case in point is the <code>other-window</code> command, bound to <code>C-x o</code>
by default. With <code>repeat-mode</code> enabled, we can type <code>C-x o</code> to invoke
the command and then type <code>o</code> to call it again. So <code>C-x o o o</code> runs
<code>other-window</code> three times. This is quite convenient.
</p>

<p>
I think repeatable commands are not easy to define because (i) we have
to put a property to their symbol and (ii) have them in a keymap that
<code>repeat-mode</code> knows about. The <code>defvar-keymap</code> of Emacs 29 makes this
a bit easier for users, though it still is a rather advanced feature.
</p>

<p>
In most cases, just know that <code>repeat-mode</code> is nice to have, though
you can probably use Emacs just fine without it.
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">;;;; Repeatable key chords (repeat-mode)
(use-package repeat
  :ensure nil
  :hook (after-init . repeat-mode)
  :config
  (setq repeat-on-final-keystroke t
        repeat-exit-timeout 5
        repeat-exit-key "&lt;escape&gt;"
        repeat-keep-prefix nil
        repeat-check-key t
        repeat-echo-function 'ignore
        ;; Technically, this is not in repeal.el, though it is the
        ;; same idea.
        set-mark-command-repeat-pop t))
</pre>
</div>
</div>
</div>
<div id="outline-container-h:581aa0ff-b136-4099-a321-3b86edbfbccb" class="outline-4">
<h4 id="h:581aa0ff-b136-4099-a321-3b86edbfbccb"><span class="section-number-4">5.2.11.</span> The <code>prot-emacs-essentials.el</code> settings for bookmarks</h4>
<div class="outline-text-4" id="text-h:581aa0ff-b136-4099-a321-3b86edbfbccb">
<p>
Bookmarks are compartments that store arbitrary information about a
file or buffer. The records are used to recreate that file/buffer
inside of Emacs. Put differently, we can easily jump back to a file or
directory (or anything that has a bookmark recorder+handler, really).
Use the <code>bookmark-set</code> command (<code>C-x r m</code> by default) to record a
bookmark and then visit one of your bookmarks with <code>bookmark-jump</code>
(<code>C-x r b</code> by default).
</p>

<p>
Also see <a href="#h:5685df62-4484-42ad-a062-d55ab19022e3">the <code>prot-emacs-essentials.el</code> settings for registers</a>.
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">;;;; Built-in bookmarking framework (bookmark.el)
(use-package bookmark
  :ensure nil
  :commands (bookmark-set bookmark-jump bookmark-bmenu-list)
  :hook (bookmark-bmenu-mode . hl-line-mode)
  :config
  (setq bookmark-use-annotations nil)
  (setq bookmark-automatically-show-annotations nil)
  (setq bookmark-fringe-mark nil) ; Emacs 29 to hide bookmark fringe icon
  ;; Write changes to the bookmark file as soon as 1 modification is
  ;; made (addition or deletion).  Otherwise Emacs will only save the
  ;; bookmarks when it closes, which may never happen properly
  ;; (e.g. power failure).
  (setq bookmark-save-flag 1))
</pre>
</div>
</div>
</div>
<div id="outline-container-h:5685df62-4484-42ad-a062-d55ab19022e3" class="outline-4">
<h4 id="h:5685df62-4484-42ad-a062-d55ab19022e3"><span class="section-number-4">5.2.12.</span> The <code>prot-emacs-essentials.el</code> settings for registers</h4>
<div class="outline-text-4" id="text-h:5685df62-4484-42ad-a062-d55ab19022e3">
<p>
[ Watch: <a href="https://protesilaos.com/codelog/2023-06-28-emacs-mark-register-basics/">Mark and register basics</a> (2023-06-28). ]
</p>

<p>
Much like bookmarks, registers store data that we can reinstate
quickly (<a href="#h:581aa0ff-b136-4099-a321-3b86edbfbccb">The <code>prot-emacs-essentials.el</code> settings for bookmarks</a>). A
common use-case is to write some text to a register and then insert
that text by calling the given register. This is much better than
relying on the <code>kill-ring</code>, because registers are meant to be
overwritten by the user, whereas the <code>kill-ring</code> accumulates lots of
text that we do not necessarily need.
</p>

<p>
To me, registers are essential for keyboard macros. By default,
registers do not persist between Emacs sessions, though I do need to
re-use them from time to time, hence the arrangement to record them
with <code>savehist-mode</code> (<a href="#h:25765797-27a5-431e-8aa4-cc890a6a913a">The <code>prot-emacs-completion.el</code> settings for saving the history (<code>savehist-mode</code>)</a>).
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">;;;; Registers (register.el)
(use-package register
  :ensure nil
  :defer t ; its commands are autoloaded, so this will be loaded then
  :config
  (setq register-preview-delay 0.8
        register-preview-function #'register-preview-default)

  (with-eval-after-load 'savehist
    (add-to-list 'savehist-additional-variables 'register-alist)))
</pre>
</div>
</div>
</div>
<div id="outline-container-h:7753549e-806d-4140-b72d-5460a4a14b3e" class="outline-4">
<h4 id="h:7753549e-806d-4140-b72d-5460a4a14b3e"><span class="section-number-4">5.2.13.</span> The <code>prot-emacs-essentials.el</code> settings for auto revert</h4>
<div class="outline-text-4" id="text-h:7753549e-806d-4140-b72d-5460a4a14b3e">
<p>
The &ldquo;auto revert&rdquo; facility makes Emacs update the contents of a saved
buffer when its underlying file is changed externally. This can happen,
for example, when a <code>git pull</code> modifies the file we are already
displaying in a buffer. Emacs thus automatically reverts the buffer to
reflect the new file contents.
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">;;;; Auto revert mode
(use-package autorevert
  :ensure nil
  :hook (after-init . global-auto-revert-mode)
  :config
  (setq auto-revert-verbose t))
</pre>
</div>
</div>
</div>
<div id="outline-container-h:d551b90d-d730-4eb5-976a-24b010fd4db3" class="outline-4">
<h4 id="h:d551b90d-d730-4eb5-976a-24b010fd4db3"><span class="section-number-4">5.2.14.</span> The <code>prot-emacs-essentials.el</code> section for <code>delete-selection-mode</code></h4>
<div class="outline-text-4" id="text-h:d551b90d-d730-4eb5-976a-24b010fd4db3">
<p>
Every graphical application I have ever used will delete the selected
text upon the insertion of new text. Emacs does not do this by
default. With <code>delete-selection-mode</code> we get it.
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">;;;; Delete selection
(use-package delsel
  :ensure nil
  :hook (after-init . delete-selection-mode))
</pre>
</div>
</div>
</div>
<div id="outline-container-h:26afeb95-7920-45ed-8ff6-3648256c280b" class="outline-4">
<h4 id="h:26afeb95-7920-45ed-8ff6-3648256c280b"><span class="section-number-4">5.2.15.</span> The <code>prot-emacs-essentials.el</code> settings for tooltips</h4>
<div class="outline-text-4" id="text-h:26afeb95-7920-45ed-8ff6-3648256c280b">
<p>
With these settings in place, Emacs will use its own faces and frame
infrastructure to display tooltips. I prefer it this way because then
we can benefit from the text properties that can be added to these
messages (e.g. a different colour or a slant).
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">;;;; Tooltips (tooltip-mode)
(use-package tooltip
  :ensure nil
  :hook (after-init . tooltip-mode)
  :config
  (setq tooltip-delay 0.5
        tooltip-short-delay 0.5
        x-gtk-use-system-tooltips t
        tooltip-frame-parameters
        '((name . "tooltip")
          (internal-border-width . 10)
          (border-width . 0)
          (no-special-glyphs . t))))
</pre>
</div>
</div>
</div>
<div id="outline-container-h:d4e30bcb-2f90-445f-a5ca-856e2576483a" class="outline-4">
<h4 id="h:d4e30bcb-2f90-445f-a5ca-856e2576483a"><span class="section-number-4">5.2.16.</span> The <code>prot-emacs-essentials.el</code> configurations for the date and time (<code>display-time-mode</code>)</h4>
<div class="outline-text-4" id="text-h:d4e30bcb-2f90-445f-a5ca-856e2576483a">
<p>
I like to display the current date and time on the mode line(<a href="#h:41ee38d0-9099-4444-85e4-cc8dce00fb9a">The <code>prot-emacs-modeline.el</code> module</a>).
This is what <code>display-time-mode</code> does. Note that my custom modeline
shows the time only in the active/selected window. Otherwise, the
default is to show the time on all mode lines, which is annoying.
</p>

<p>
The <code>time.el</code> library which provides the <code>display-time-mode</code> also
defines functions to get the load average and check a directory for
new emails. I have no use for the load avergae, while emails counters
are best handled by my <code>notmuch-indicator</code> package
(<a href="#h:b26c6297-ebe8-4f99-b069-df53cfd90520">The <code>prot-emacs-email.el</code> submodule for <code>notmuch</code> (<code>prot-emacs-notmuch.el</code>)</a>).
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">;;;; Display current time
(use-package time
  :ensure nil
  :hook (after-init . display-time-mode)
  :config
  (setq display-time-format " %a %e %b, %H:%M ")
  ;;;; Covered by `display-time-format'
  ;; (setq display-time-24hr-format t)
  ;; (setq display-time-day-and-date t)
  (setq display-time-interval 60)
  (setq display-time-default-load-average nil)
  ;; NOTE 2022-09-21: For all those, I have implemented my own solution
  ;; that also shows the number of new items, although it depends on
  ;; notmuch: the `notmuch-indicator' package.
  (setq display-time-mail-directory nil)
  (setq display-time-mail-function nil)
  (setq display-time-use-mail-icon nil)
  (setq display-time-mail-string nil)
  (setq display-time-mail-face nil)

  ;; I don't need the load average and the mail indicator, so let this
  ;; be simple:
  (setq display-time-string-forms
        '((propertize
           (format-time-string display-time-format now)
           'face 'display-time-date-and-time
           'help-echo (format-time-string "%a %b %e, %Y" now))
          " ")))
</pre>
</div>
</div>
</div>
<div id="outline-container-h:42866cf3-d6ad-4431-b321-204f91e17d72" class="outline-4">
<h4 id="h:42866cf3-d6ad-4431-b321-204f91e17d72"><span class="section-number-4">5.2.17.</span> The <code>prot-emacs-essentials.el</code> settings for the <code>world-clock</code></h4>
<div class="outline-text-4" id="text-h:42866cf3-d6ad-4431-b321-204f91e17d72">
<p>
I communicate with people from across the globe. Knowing their local
time is of paramount importance. With <code>M-x world-clock</code> we get a
buffer with all cities and concomitant time zones specified in
<code>zoneinfo-style-world-list</code>. The contents are displayed according to
the <code>world-clock-time-format</code>. Note that I control the placement of
these and many other buffers by configuring the <code>display-buffer-alist</code>
(<a href="#h:b5fa481d-8549-4424-869e-91091cdf730b">The <code>prot-emacs-window.el</code> module</a>).
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">;;;; World clock (M-x world-clock)
(use-package time
  :ensure nil
  :commands (world-clock)
  :config
  (setq display-time-world-list t)
  (setq zoneinfo-style-world-list ; M-x shell RET timedatectl list-timezones
        '(("America/Los_Angeles" "Los Angeles")
          ("America/Vancouver" "Vancouver")
          ("Canada/Pacific" "Canada/Pacific")
          ("America/Chicago" "Chicago")
          ("Brazil/Acre" "Rio Branco")
          ("America/Toronto" "Toronto")
          ("America/New_York" "New York")
          ("Canada/Atlantic" "Canada/Atlantic")
          ("Brazil/East" "Brasília")
          ("UTC" "UTC")
          ("Europe/Lisbon" "Lisbon")
          ("Europe/Brussels" "Brussels")
          ("Europe/Athens" "Athens")
          ("Asia/Riyadh" "Riyadh")
          ("Asia/Tehran" "Tehran")
          ("Asia/Tbilisi" "Tbilisi")
          ("Asia/Yekaterinburg" "Yekaterinburg")
          ("Asia/Kolkata" "Kolkata")
          ("Asia/Singapore" "Singapore")
          ("Asia/Shanghai" "Shanghai")
          ("Asia/Seoul" "Seoul")
          ("Asia/Tokyo" "Tokyo")
          ("Asia/Vladivostok" "Vladivostok")
          ("Australia/Brisbane" "Brisbane")
          ("Australia/Sydney" "Sydney")
          ("Pacific/Auckland" "Auckland")))

  ;; All of the following variables are for Emacs 28
  (setq world-clock-list t)
  (setq world-clock-time-format "%R %z (%Z)	%A %d %B")
  (setq world-clock-buffer-name "*world-clock*") ; Placement handled by `display-buffer-alist'
  (setq world-clock-timer-enable t)
  (setq world-clock-timer-second 60))
</pre>
</div>
</div>
</div>
<div id="outline-container-h:5eb16d63-ce21-4e76-8789-eef6ddbd7c00" class="outline-4">
<h4 id="h:5eb16d63-ce21-4e76-8789-eef6ddbd7c00"><span class="section-number-4">5.2.18.</span> The <code>prot-emacs-essentials.el</code> settings for manpages</h4>
<div class="outline-text-4" id="text-h:5eb16d63-ce21-4e76-8789-eef6ddbd7c00">
<p>
Most buffers conform with rules we define in the <code>display-buffer-alist</code>
(<a href="#h:b5fa481d-8549-4424-869e-91091cdf730b">The <code>prot-emacs-window.el</code> module</a>). However, <code>M-x man</code> does not do
this because it has its own behaviour. At least, it is customisable.
The <code>Man-notify-method</code> is a very old option, according to what the
Help buffer is telling me (check its documentation with <code>C-h v</code> or
<code>M-x describe-variable</code>), so I suspect this was never updated to
conform with the newer <code>display-buffer-alist</code>&#x2026;
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">;;;; `man' (manpages)
(use-package man
  :ensure nil
  :commands (man)
  :config
  (setq Man-notify-method 'pushy)) ; does not obey `display-buffer-alist'
</pre>
</div>
</div>
</div>
<div id="outline-container-h:14d40e5a-327e-453e-861c-3ece24351d62" class="outline-4">
<h4 id="h:14d40e5a-327e-453e-861c-3ece24351d62"><span class="section-number-4">5.2.19.</span> The <code>prot-emacs-essentials.el</code> settings for <code>proced</code></h4>
<div class="outline-text-4" id="text-h:14d40e5a-327e-453e-861c-3ece24351d62">
<p>
The <code>M-x proced</code> command produces a listing of all running processes
on the system. This is like the <code>top</code> program on the command-line.
While inside the <code>*Proced*</code> buffer, type <code>C-h m</code> (<code>M-x describe-mode</code>)
to learn about keys/commands you can use therein. Personally, I mostly
use this interface to check if some process is doing more than it should.
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">;;;; `proced' (process monitor, similar to `top')
(use-package proced
  :ensure nil
  :commands (proced)
  :config
  (setq proced-auto-update-flag 'visible) ; Emacs 30 supports more the `visible' value
  (setq proced-enable-color-flag t) ; Emacs 29
  (setq proced-auto-update-interval 5)
  (setq proced-descend t)
  (setq proced-filter 'user))
</pre>
</div>
</div>
</div>
<div id="outline-container-h:7709b7e9-844f-49f3-badf-784aacec4bca" class="outline-4">
<h4 id="h:7709b7e9-844f-49f3-badf-784aacec4bca"><span class="section-number-4">5.2.20.</span> The <code>prot-emacs-essentials.el</code> arrangement to run Emacs as a server</h4>
<div class="outline-text-4" id="text-h:7709b7e9-844f-49f3-badf-784aacec4bca">
<p>
The &ldquo;server&rdquo; is functionally like the daemon, except it is run by the
first Emacs frame we launch. With a running server, we can connect to
it through a new <code>emacsclient</code> call. This is useful if we want to
launch new frames that share resources with the existing running
process. Though the <code>emacsclient</code> can be used to simply evaluate code
outside of an Emacs frame (e.g. to load a new theme, as I do with my
<code>delight.sh</code> shell script as part of my dotfiles).
</p>

<p>
When we close the last frame, the server is terminated. Whereas the
daemon remains active even if all Emacs frames are closed. For me, the
server is easier to work with, as I know for sure when its life cycle
starts and ends. Beside that, I did give the daemon an honest try.
Emacs would crash whenever I would encounter an error in some Lisp
evaluation. Whereas the server works just fine.
</p>

<p>
Note that I only ever <code>server-start</code> if there is no server running.
One is enough.
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">;;;; Emacs server (allow emacsclient to connect to running session)
(use-package server
  :ensure nil
  :defer 1
  :config
  (setq server-client-instructions nil)
  (unless (server-running-p)
    (server-start)))
</pre>
</div>
</div>
</div>
<div id="outline-container-h:b4b3c8b7-e35c-4a56-bfb9-0c8bb33b2423" class="outline-4">
<h4 id="h:b4b3c8b7-e35c-4a56-bfb9-0c8bb33b2423"><span class="section-number-4">5.2.21.</span> The <code>prot-emacs-essentials.el</code> section about <code>substitute</code></h4>
<div class="outline-text-4" id="text-h:b4b3c8b7-e35c-4a56-bfb9-0c8bb33b2423">
<p>
I use <code>substitute</code> to efficiently replace targets in the buffer or
context. The <code>substitute</code> package provides a set of commands that
perform text replacement (i) throughout the buffer, (ii) limited to
the current definition (per `narrow-to-defun`), (iii) from point to
the end of the buffer, and (iv) from point to the beginning of the
buffer.
</p>

<p>
These substitutions are meant to be as quick as possible and to not
move the point. As such, they differ from the standard <code>query-replace</code>
(which I still use where relevant). The provided commands prompt for
substitute text and perform the substitution outright, without moving
the point. Better check the video I did on the matter:
<a href="https://protesilaos.com/codelog/2023-01-16-emacs-substitute-package-demo/">https://protesilaos.com/codelog/2023-01-16-emacs-substitute-package-demo/</a>.
</p>

<ul class="org-ul">
<li>Package name (GNU ELPA): <code>substitute</code></li>
<li>Official manual: <a href="https://protesilaos.com/emacs/substitute">https://protesilaos.com/emacs/substitute</a></li>
<li>Git repositories:
<ul class="org-ul">
<li>GitHub: <a href="https://github.com/protesilaos/substitute">https://github.com/protesilaos/substitute</a></li>
<li>GitLab: <a href="https://gitlab.com/protesilaos/substitute">https://gitlab.com/protesilaos/substitute</a></li>
</ul></li>
<li>Backronym: Some Utilities Built to Substitute Targets Independent of
Their Utterances, Thoroughly and Easily.</li>
</ul>

<div class="org-src-container">
<pre class="src src-emacs-lisp">;;; Substitute
;; Another package of mine... Video demo:
;; &lt;https://protesilaos.com/codelog/2023-01-16-emacs-substitute-package-demo/&gt;.
(use-package substitute
  :ensure t
  :defer 1
  ;; Produce a message after the substitution that reports on what
  ;; happened.  It is a single line, like "Substituted `TARGET' with
  ;; `SUBSTITUTE' N times across the buffer.
  :hook (substitute-post-replace . substitute-report-operation)
  :commands
  (substitute-target-below-point ; Forward motion like isearch (C-s)
   substitute-target-above-point ; Backward motion like isearch (C-r)
   substitute-target-in-defun    ; inside of the current definition
   substitute-target-in-buffer)  ; throughout the buffer
  :config
  ;; Set this to non-nil to highlight all occurrences of the current
  ;; target.
  (setopt substitute-highlight t)

  ;; Set this to t if you want to always treat the letter casing
  ;; literally.  Otherwise each command accepts a `C-u' prefix
  ;; argument to do this on-demand.
  (setq substitute-fixed-letter-case nil)

  ;; C-c s is occupied by `prot-scratch-buffer'.
  (define-key global-map (kbd "C-c r") #'substitute-prefix-map))
</pre>
</div>
</div>
</div>
<div id="outline-container-h:1cbb0a14-a2d4-49d1-88e9-688115445810" class="outline-4">
<h4 id="h:1cbb0a14-a2d4-49d1-88e9-688115445810"><span class="section-number-4">5.2.22.</span> The <code>prot-emacs-essentials.el</code> section about <code>goto-chg</code> (go to change)</h4>
<div class="outline-text-4" id="text-h:1cbb0a14-a2d4-49d1-88e9-688115445810">
<p>
The <code>goto-chg</code> package, authored by David Andersson and maintained by
Vasilij Schneidermann, moves the cursor to the point where the last
change happened. Calling the command again cycles to the point before
that and so on. Simple and super effective.
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(use-package goto-chg
  :ensure t
  :bind
  (("C-(" . goto-last-change)
   ("C-)" . goto-last-change-reverse)))
</pre>
</div>
</div>
</div>
<div id="outline-container-h:ceb193bf-0de3-4c43-8ab7-6daa50817754" class="outline-4">
<h4 id="h:ceb193bf-0de3-4c43-8ab7-6daa50817754"><span class="section-number-4">5.2.23.</span> The <code>prot-emacs-essentials.el</code> section about <code>expreg</code> (tree-sitter mark syntactically)</h4>
<div class="outline-text-4" id="text-h:ceb193bf-0de3-4c43-8ab7-6daa50817754">
<p>
The <code>expreg</code> package by Yuan Fu (aka casouri) uses the tree-sitter
framework to incrementally expand the region from the smallest to the
largest syntactic unit in the given context. This is a powerful
feature, though it (i) requires Emacs to be built with tree-sitter
support and (ii) for the user to be running a major mode that is
designed for tree-sitter (Lisp seems to work regardless).
</p>

<p>
The package offers the <code>expreg-expand</code> and <code>expreg-contract</code> commands.
I believe I have never used the latter. I find it easier to just abort
and start again than to have a special key for the rare scenario where
I widened the selection more than I should. For that case, we can
always exchange point and mark. I have explained this in my video
about mark and register basics:
<a href="https://protesilaos.com/codelog/2023-06-28-emacs-mark-register-basics/">https://protesilaos.com/codelog/2023-06-28-emacs-mark-register-basics/</a>.
</p>

<p>
If tree-sitter functionality is not available, then the <code>C-M-SPC</code>
binding is taken by <code>prot-simple-mark-sexp</code> which is similar in spirit
(<a href="#h:f15bc843-2dd1-4792-95ec-9b7b6e561804">The <code>prot-emacs-essentials.el</code> section about <code>prot-simple.el</code> (custom basic commands)</a>).
</p>

<p>
For me, <code>expreg</code> is mostly an investment into the future, as I am
monitoring developments on the tree-sitter front. My setup provides a
user option to not load such tree-sitter extras (<a href="#h:32703a47-edff-47a8-b275-3cb5b9f9e244">The <code>init.el</code> user option to load treesitter extras</a>).
</p>

<p>
Note that in the code block below I define two small commands. Custom
code belong in libraries, though not in cases where it is ad-hoc like
this (<a href="#h:fc1ea247-5ef6-4c4e-a807-6c7b2482af90">The custom libraries of my configuration</a>).
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">;;; Mark syntactic constructs efficiently if tree-sitter is available (expreg)
(when (and (treesit-available-p) prot-emacs-treesitter-extras)
  (use-package expreg
    :ensure t
    :functions (prot/expreg-expand prot/expreg-expand-dwim)
    ;; There is also an `expreg-contract' command, though I have no use for it.
    :bind ("C-M-SPC" . prot/expreg-expand-dwim) ; overrides `mark-sexp'
    :config
    (defun prot/expreg-expand (n)
      "Expand to N syntactic units, defaulting to 1 if none is provided interactively."
      (interactive "p")
      (dotimes (_ n)
        (expreg-expand)))

    (defun prot/expreg-expand-dwim ()
      "Do-What-I-Mean `expreg-expand' to start with symbol or word.
If over a real symbol, mark that directly, else start with a
word.  Fall back to regular `expreg-expand'."
      (interactive)
      (let ((symbol (bounds-of-thing-at-point 'symbol)))
        (cond
         ((equal (bounds-of-thing-at-point 'word) symbol)
          (prot/expreg-expand 1))
         (symbol (prot/expreg-expand 2))
         (t (expreg-expand)))))))
</pre>
</div>
</div>
</div>
<div id="outline-container-h:6dce278e-86c7-4620-9271-d5af5499f0cc" class="outline-4">
<h4 id="h:6dce278e-86c7-4620-9271-d5af5499f0cc"><span class="section-number-4">5.2.24.</span> The <code>prot-emacs-essentials.el</code> section about <code>tmr</code> (set timers)</h4>
<div class="outline-text-4" id="text-h:6dce278e-86c7-4620-9271-d5af5499f0cc">
<p>
This is a package that I wrote and for which I received substantial
code contributions from Damien Cassou and Daniel Mendler. With <code>tmr</code>
we set timers using a convenient notation. The point of entry is the
<code>tmr</code> command (or <code>tmr-with-description</code> if you want to describe what
the timer is about).
</p>

<p>
Set  a timer by specifying one of these:
</p>

<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="org-left" />

<col  class="org-left" />
</colgroup>
<thead>
<tr>
<th scope="col" class="org-left">Input</th>
<th scope="col" class="org-left">Meaning</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left">5</td>
<td class="org-left">5 Minutes from now</td>
</tr>

<tr>
<td class="org-left">5m</td>
<td class="org-left">Same as abovre</td>
</tr>

<tr>
<td class="org-left">1h</td>
<td class="org-left">1 hour from now</td>
</tr>

<tr>
<td class="org-left">06:35</td>
<td class="org-left">From now until 06:35</td>
</tr>
</tbody>
</table>

<p>
To view the running timers in a tabulated list, invoke the command
<code>tmr-tabulated-view</code>. From there, type <code>C-h m</code> (or <code>M-x describe-mode</code>)
to learn about all the available commands and their respective key bindings.
</p>

<ul class="org-ul">
<li>Package name (GNU ELPA): <code>tmr</code></li>
<li>Official manual: <a href="https://protesilaos.com/emacs/tmr">https://protesilaos.com/emacs/tmr</a></li>
<li>Change log: <a href="https://protesilaos.com/emacs/tmr-changelog">https://protesilaos.com/emacs/tmr-changelog</a></li>
<li>Git repositories:
<ul class="org-ul">
<li>GitHub: <a href="https://github.com/protesilaos/tmr">https://github.com/protesilaos/tmr</a></li>
<li>GitLab: <a href="https://gitlab.com/protesilaos/tmr">https://gitlab.com/protesilaos/tmr</a></li>
</ul></li>
<li>Backronym: TMR May Ring; Timer Must Run</li>
</ul>

<div class="org-src-container">
<pre class="src src-emacs-lisp">;;; TMR May Ring (tmr is used to set timers)
;; Read the manual: &lt;https://protesilaos.com/emacs/tmr&gt;.
(use-package tmr
  :ensure t
  :bind
  (("C-c t t" . tmr)
   ("C-c t T" . tmr-with-description)
   ("C-c t l" . tmr-tabulated-view) ; "list timers" mnemonic
   ("C-c t c" . tmr-clone)
   ("C-c t k" . tmr-cancel)
   ("C-c t s" . tmr-reschedule)
   ("C-c t e" . tmr-edit-description)
   ("C-c t r" . tmr-remove)
   ("C-c t R" . tmr-remove-finished))
  :config
  (setq tmr-sound-file "/usr/share/sounds/freedesktop/stereo/alarm-clock-elapsed.oga"
        tmr-notification-urgency 'normal
        tmr-description-list 'tmr-description-history))
</pre>
</div>
</div>
</div>
<div id="outline-container-h:aac21cc5-19eb-4a6c-a8ab-01b829df0d64" class="outline-4">
<h4 id="h:aac21cc5-19eb-4a6c-a8ab-01b829df0d64"><span class="section-number-4">5.2.25.</span> The <code>prot-emacs-essentials.el</code> section about <code>password-store</code></h4>
<div class="outline-text-4" id="text-h:aac21cc5-19eb-4a6c-a8ab-01b829df0d64">
<p>
The <code>pass</code> program (aka <code>password-store</code>) is a Unix-style password
manager. Each password entry is its own encrypted file, stored in a
local directory (<code>~/.password-store</code>, by default). Encryption is done
with GPG, though I believe Age can also be used. It can generate
strong passwords and allows us to quickly retrieve the password
associated with a given file.
</p>

<p>
The Emacs interface makes it easy to access passowrds with <code>M-x pass</code>.
The resulting buffer shows a tree representation of the <code>~/.password-store</code>
and provides an overview of the available key bindings. From here we
can write a new entry, generate a password for an existing one, and so
on.
</p>

<p>
My most common interaction with it is via the command <code>password-store-copy</code>
which uses minibuffer completion to match an entry and get the
password from it. On this note, I have a convention of naming password
files based on their scope, like <code>username@website</code>. This makes it
easy to retrieve what I need.
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">;;; Pass interface (password-store)
(use-package password-store
  :ensure t
  ;; Mnemonic is the root of the "code" word (κώδικας).  But also to add
  ;; the password to the kill-ring.  Other options are already taken.
  :bind ("C-c k" . password-store-copy)
  :config
  (setq password-store-time-before-clipboard-restore 30))

(use-package pass
 :ensure t
 :commands (pass))
</pre>
</div>
</div>
</div>
<div id="outline-container-h:7c25e281-d92e-4605-b5d6-18fe1f280a73" class="outline-4">
<h4 id="h:7c25e281-d92e-4605-b5d6-18fe1f280a73"><span class="section-number-4">5.2.26.</span> The <code>prot-emacs-essentials.el</code> section about <code>shell</code></h4>
<div class="outline-text-4" id="text-h:7c25e281-d92e-4605-b5d6-18fe1f280a73">
<p>
Before using Emacs, I did not have a clear idea of what the
distinction between a &ldquo;shell&rdquo; and a &ldquo;terminal&rdquo; is. But I quickly
learnt that a terminal (&ldquo;terminal emulator&rdquo;) is an application that
provides a text-centric interface and handles all the technicalities
of presenting text accordingly. Whereas the &ldquo;shell&rdquo; (or &ldquo;command-line
shell&rdquo;) is the program that runs inside the terminal whose job is to
interpret the user&rsquo;s input and communicate with the computer.
Something like <code>xterm</code> or <code>gnome-terminal</code> is a terminal. While the
likes of <code>bash</code>, <code>zsh</code>, and <code>fish</code> are shells.
</p>

<p>
In Emacs we can have both. Emacs can run a process that constitutes a
fully fledged terminal emulator, such as with the <code>vterm</code> package, or
it can provide the interface necessary for a mere shell to handle the
command-line interactivity.
</p>

<p>
A terminal emulator is only needed if we use programs that require
Terminal User Interface (TUI) capabilities, such as <code>htop</code>. I do not
run any of those, in large part because Emacs has better or equally
capable alternatives like <code>M-x proced</code> to do what <code>htop</code> does in the
terminal (<a href="#h:14d40e5a-327e-453e-861c-3ece24351d62">The <code>prot-emacs-essentials.el</code> settings for <code>proced</code></a>).
</p>

<p>
With the TUI out of the way, we can have <code>M-x shell</code> run a native Unix
shell for us. Mine is <code>bash</code> because I am a simpleton, but also
because my <code>prot-shell.el</code> provides a few niceties that improve the
user experience (<a href="#h:32f6fe0f-23c4-44cc-97cc-3e5372bd484e">The <code>prot-shell.el</code> library</a>).
</p>

<p>
I run a shell to do things like interface with my system&rsquo;s package
manager or run a program with some flags. <code>M-x shell</code> is more than
enough for this purpose. To make it a bit easier to work with multiple
shells that need to be named after the directory they are in, I use
the command <code>prot-shell</code>: it not only uses a unique and informative
buffer name, but it also keeps track of <code>cd</code> commands to update the
buffer name accordingly.
</p>

<p>
Note that there also exists a shell implemented in Emacs Lisp. It is
called <code>eshell</code>. Unlike <code>shell</code>, it does not read the <code>~/.bashrc</code> and
is its own little Emacs-only thing with its own command-line syntax.
In short, it is &ldquo;okay&rdquo; in a vacuum but I have no use for it beside
tinkering with Elisp, while I prefer to have a reliable <code>~/.bashrc</code> at
all times. As such, the <code>eshell</code> command is on the list of disabled
commands (<a href="#h:4ed6593f-6f55-4258-a1c2-ddb50e9e2465">The <code>init.el</code> settings to enable certain commands and disable others</a>).
</p>

<p>
My <code>prot-shell-mode</code> defines a few extra key bindings (per the
<code>prot-shell-mode-map</code>) and also implements a bookmark handler for
shell buffers (<a href="#h:581aa0ff-b136-4099-a321-3b86edbfbccb">The <code>prot-emacs-essentials.el</code> settings for bookmarks</a>).
The bookmarking functionality is a wonderful extra, as it leverages
Emacs&rsquo; TRAMP infrastructure to re-establish the connection to the
given host. For example, if I do <code>M-x find-file</code> and then input
<code>/sudo::/usr/share/</code> to go to <code>/usr/share/</code> with <code>sudo</code> privileges,
then I can open a shell there and bookmark it. When I jump back to the
bookmark, Emacs will automatically handle the <code>sudo</code> part while taking
me to that shell in its directory. Relevant note from my source code:
</p>

<pre class="example" id="org7c2eccf">
;; NOTE 2023-08-18: I sent this to the Emacs maintainers as a patch
;; (bug#65039).  I received approval to proceed with the change, but I
;; did not do it because a user reported an issue with SSH (TRAMP).  I
;; do not have access to SSH and am not familiar with such workflows.
;; If/when that changes, I will try again.  In the meantime, this is
;; good code and it works for me.
</pre>

<p>
Now the actual configurations:
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">;;; Shell (M-x shell)
(use-package shell
  :ensure nil
  :bind
  ( :map shell-mode-map
    ("C-c C-k" . comint-clear-buffer)
    ("C-c C-w" . comint-write-output))
  :config
  ;; Check my .bashrc which handles `comint-terminfo-terminal':
  ;;
  ;; # Default pager.  The check for the terminal is useful for Emacs with
  ;; # M-x shell (which is how I usually interact with bash these days).
  ;; #
  ;; # The COLORTERM is documented in (info "(emacs) General Variables").
  ;; # I found the reference to `dumb-emacs-ansi' in (info "(emacs)
  ;; # Connection Variables").
  ;; if [ "$TERM" = "dumb" ] &amp;&amp; [ "$INSIDE_EMACS" ] || [ "$TERM" = "dumb-emacs-ansi" ] &amp;&amp; [ "$INSIDE_EMACS" ]
  ;; then
  ;;     export PAGER="cat"
  ;;     alias less="cat"
  ;;     export TERM=dumb-emacs-ansi
  ;;     export COLORTERM=1
  ;; else
  ;;     # Quit once you try to scroll past the end of the file.
  ;;     export PAGER="less --quit-at-eof"
  ;; fi

  (setq shell-command-prompt-show-cwd t) ; Emacs 27.1
  (setq ansi-color-for-comint-mode t)
  (setq shell-input-autoexpand 'input)
  (setq shell-highlight-undef-enable t) ; Emacs 29.1
  (setq shell-has-auto-cd nil) ; Emacs 29.1
  (setq shell-get-old-input-include-continuation-lines t) ; Emacs 30.1
  (setq shell-kill-buffer-on-exit t) ; Emacs 29.1
  (setq shell-completion-fignore '("~" "#" "%"))
  (setq-default comint-scroll-to-bottom-on-input t)
  (setq-default comint-scroll-to-bottom-on-output nil)
  (setq-default comint-input-autoexpand 'input)
  (setq comint-prompt-read-only t)
  (setq comint-buffer-maximum-size 9999)
  (setq comint-completion-autolist t)
  (setq comint-input-ignoredups t)
  (setq tramp-default-remote-shell "/bin/bash")

  (setq shell-font-lock-keywords
        '(("[ \t]\\([+-][^ \t\n]+\\)" 1 font-lock-builtin-face)
          ("^[^ \t\n]+:.*" . font-lock-string-face)
          ("^\\[[1-9][0-9]*\\]" . font-lock-constant-face)))

  ;; Support for OS-specific escape sequences such as what `ls
  ;; --hyperlink' uses.  I normally don't use those, but I am checking
  ;; this to see if there are any obvious advantages/disadvantages.
  (add-hook 'comint-output-filter-functions 'comint-osc-process-output))

(use-package prot-shell
  :ensure nil
  :bind (("&lt;f1&gt;" . prot-shell)) ; I don't use F1 for help commands
  :hook (shell-mode . prot-shell-mode))
</pre>
</div>
</div>
</div>
<div id="outline-container-h:080aa291-95b4-4d54-8783-d156b13190e9" class="outline-4">
<h4 id="h:080aa291-95b4-4d54-8783-d156b13190e9"><span class="section-number-4">5.2.27.</span> The <code>prot-emacs-essentials.el</code> section about the laptop-specific settings</h4>
<div class="outline-text-4" id="text-h:080aa291-95b4-4d54-8783-d156b13190e9">
<p>
Due to my limited electricity setup, I spend about half my computer
time on the laptop (<a href="#h:5668958c-2fc0-4a38-bd1f-3e0c6484977d">What hardware and software do you use?</a>). It does
not add to the load that my solar-powered batteries have to handle and
I can thus keep the lights on until ~21:00.
</p>

<p>
When I am working on my laptop, I want to make a few tweaks to the
default dimensions of Emacs frames (<a href="#h:0403b581-142b-4613-bc81-51c5dccd831d">The <code>early-init.el</code> code to set frame parameters</a>).
I also arrange for the battery indicator to be displayed on the mode
line.
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">;;; Laptop settings
(unless (directory-empty-p "/sys/class/power_supply/")
  (add-to-list 'default-frame-alist '(width . (text-pixels . 800)))
  (add-to-list 'default-frame-alist '(height . (text-pixels . 600)))

  (use-package battery
    :ensure nil
    :hook (after-init . display-battery-mode)
    :config
;;;; Show battery status on the mode line (battery.el)
    (setq battery-mode-line-format
          (cond
           ((eq battery-status-function #'battery-linux-proc-acpi)
	        "⏻%b%p%%,%d°C ")
	       (battery-status-function
	        "⏻%b%p%% ")))))
</pre>
</div>
</div>
</div>
<div id="outline-container-h:c8b2f021-fe5a-4f6b-944c-20340f764fb2" class="outline-4">
<h4 id="h:c8b2f021-fe5a-4f6b-944c-20340f764fb2"><span class="section-number-4">5.2.28.</span> The <code>prot-emacs-essentials.el</code> call to <code>provide</code></h4>
<div class="outline-text-4" id="text-h:c8b2f021-fe5a-4f6b-944c-20340f764fb2">
<p>
Finally, we <code>provide</code> the module. This is the mirror function of
<code>require</code> (<a href="#h:e6c4acf5-5b51-4b38-a86a-bf3f698ac872">The init.el final part to load the individual modules</a>).
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(provide 'prot-emacs-essentials)
</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-h:41ee38d0-9099-4444-85e4-cc8dce00fb9a" class="outline-3">
<h3 id="h:41ee38d0-9099-4444-85e4-cc8dce00fb9a"><span class="section-number-3">5.3.</span> The <code>prot-emacs-modeline.el</code> module</h3>
<div class="outline-text-3" id="text-h:41ee38d0-9099-4444-85e4-cc8dce00fb9a">
<p>
[ Watch: <a href="https://protesilaos.com/codelog/2023-07-29-emacs-custom-modeline-tutorial/">write a custom mode line</a> (2023-07-29) and <a href="https://protesilaos.com/codelog/2024-01-13-customize-emacs-mode-line/">customise mode line colours</a> (2024-01-13). ]
</p>

<p>
I use a custom mode line that is close in spirit to the default one.
The main difference is that I design most of the components to only
appear in the focused window. This way, I get a minimal view while
also avoid the repetition of global indicators, such as for the time
(<a href="#h:d4e30bcb-2f90-445f-a5ca-856e2576483a">The <code>prot-emacs-essentials.el</code> configurations for the date and time (<code>display-time-mode</code>)</a>)
or the <code>notmuch-indicator</code> (<a href="#h:0f12f144-ca9f-4d07-8563-c33b3521bfb5">The <code>prot-emacs-notmuch.el</code> section about the <code>notmuch-indicator</code></a>).
</p>

<p>
Most items that go into the <code>mode-line-format</code> are defined in
<a href="#h:935adc09-abaa-4413-a5ab-a7a562081c20">the <code>prot-modeline.el</code> library</a>.
</p>

<p>
Notice the use of <code>setq-default</code>. This is like <code>setq</code> but sets the
default value of variable that normally are buffer-local. You will
only find a few cases where this is needed.
</p>

<p>
In this section I also take care to provide integration with my
<code>spacious-padding</code> package (<a href="#h:6c118185-fcb1-4c9a-93af-71814cb84279">The <code>prot-emacs-theme.el</code> section for <code>spacious-padding</code></a>).
It adds, among others, a box effect to mode line constructs.
To make the faces of <code>prot-modeline.el</code> look right in this scenario, I
add a box to them as well. They then adopt whatever padding is there.
The <code>with-eval-after-load</code> pattern is how to evaluate some code
as soon as the given package/feature is loaded.
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">;;; Mode line
(use-package prot-modeline
  :ensure nil
  :config
  (setq mode-line-compact nil) ; Emacs 28
  (setq mode-line-right-align-edge 'right-margin) ; Emacs 30
  (setq-default mode-line-format
                '("%e"
                  prot-modeline-kbd-macro
                  prot-modeline-narrow
                  prot-modeline-buffer-status
                  prot-modeline-window-dedicated-status
                  prot-modeline-input-method
                  "  "
                  prot-modeline-buffer-identification
                  "  "
                  prot-modeline-major-mode
                  prot-modeline-process
                  "  "
                  prot-modeline-vc-branch
                  "  "
                  prot-modeline-eglot
                  "  "
                  prot-modeline-flymake
                  "  "
                  mode-line-format-right-align ; Emacs 30
                  prot-modeline-notmuch-indicator
                  "  "
                  prot-modeline-misc-info))

  (with-eval-after-load 'spacious-padding
    (defun prot/modeline-spacious-indicators ()
      "Set box attribute to `'prot-modeline-indicator-button' if spacious-padding is enabled."
      (if (bound-and-true-p spacious-padding-mode)
          (set-face-attribute 'prot-modeline-indicator-button nil :box t)
        (set-face-attribute 'prot-modeline-indicator-button nil :box 'unspecified)))

    ;; Run it at startup and then afterwards whenever
    ;; `spacious-padding-mode' is toggled on/off.
    (prot/modeline-spacious-indicators)

    (add-hook 'spacious-padding-mode-hook #'prot/modeline-spacious-indicators)))
</pre>
</div>
</div>
<div id="outline-container-h:ba833ed8-f9d4-4693-bfd5-30452167137e" class="outline-4">
<h4 id="h:ba833ed8-f9d4-4693-bfd5-30452167137e"><span class="section-number-4">5.3.1.</span> The <code>prot-emacs-modeline.el</code> section about <code>keycast</code></h4>
<div class="outline-text-4" id="text-h:ba833ed8-f9d4-4693-bfd5-30452167137e">
<p>
This is a helpful package by Jonas Bernoulli that echoes the key
presses and corresponding commands  on the mode line, tab bar, header
line, or a special buffer.
</p>

<p>
I usually enable <code>keycast-mode-line-mode</code> when I do a presentation. It
shows an indicator on the focused mode line.
</p>

<p>
Note that the value of <code>keycast-mode-line-insert-after</code> only works
with my customised mode line (<a href="#h:41ee38d0-9099-4444-85e4-cc8dce00fb9a">The <code>prot-emacs-modeline.el</code> module</a>).
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">;;; Keycast mode
(use-package keycast
  :ensure t
  :after prot-modeline
  :commands (keycast-mode-line-mode keycast-header-line-mode keycast-tab-bar-mode keycast-log-mode)
  :init
  (setq keycast-mode-line-format "%2s%k%c%R")
  (setq keycast-mode-line-insert-after 'prot-modeline-vc-branch)
  (setq keycast-mode-line-window-predicate 'mode-line-window-selected-p)
  (setq keycast-mode-line-remove-tail-elements nil)
  :config
  (dolist (input '(self-insert-command org-self-insert-command))
    (add-to-list 'keycast-substitute-alist `(,input "." "Typing…")))

  (dolist (event '( mouse-event-p mouse-movement-p mwheel-scroll handle-select-window
                    mouse-set-point mouse-drag-region))
    (add-to-list 'keycast-substitute-alist `(,event nil))))
</pre>
</div>
</div>
</div>
<div id="outline-container-h:be07591f-6130-4641-9f06-a634f21bb2f6" class="outline-4">
<h4 id="h:be07591f-6130-4641-9f06-a634f21bb2f6"><span class="section-number-4">5.3.2.</span> The <code>prot-emacs-essentials.el</code> call to <code>provide</code></h4>
<div class="outline-text-4" id="text-h:be07591f-6130-4641-9f06-a634f21bb2f6">
<p>
Finally, we <code>provide</code> the module. This is the mirror function of
<code>require</code> (<a href="#h:e6c4acf5-5b51-4b38-a86a-bf3f698ac872">The init.el final part to load the individual modules</a>).
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(provide 'prot-emacs-modeline)
</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-h:15edf2c3-4419-4101-928a-6e224958a741" class="outline-3">
<h3 id="h:15edf2c3-4419-4101-928a-6e224958a741"><span class="section-number-3">5.4.</span> The <code>prot-emacs-completion.el</code> module</h3>
<div class="outline-text-3" id="text-h:15edf2c3-4419-4101-928a-6e224958a741">
<p>
The term &ldquo;completion&rdquo; describes a process where user input is assisted
by pattern matching algorithms to type out incomplete terms. The most
basic way of this model of interaction is what we get in a
command-line prompt, where we can hit <code>TAB</code> to expand the word before
point to something the program already knows about (e.g <code>ema</code> followed
by <code>TAB</code> may complete to <code>emacs</code>).
</p>

<p>
In Emacs, completion encompasses user interfaces that show the
available candidates (the likely options) right away, as well as
provide more advanced capabilities for storing the history of previous
inputs, displaying helpful annotations next to each candidate, and
&ldquo;completion styles&rdquo; to control how user input is matched to
candidates. Because we use the minibuffer for most common
interactions, completion is an integral part of any setup.
</p>
</div>
<div id="outline-container-h:14b09958-279e-4069-81e3-5a16c9b69892" class="outline-4">
<h4 id="h:14b09958-279e-4069-81e3-5a16c9b69892"><span class="section-number-4">5.4.1.</span> The <code>prot-emacs-completion.el</code> settings for completion styles</h4>
<div class="outline-text-4" id="text-h:14b09958-279e-4069-81e3-5a16c9b69892">
<p>
The <code>completion-styles</code> are pattern matching algorithms. They
interpret user input and match candidates accordingly.
</p>

<dl class="org-dl">
<dt>emacs22</dt><dd>Prefix completion that only operates on the text before
point. If we are in <code>prefix|suffix</code>, with <code>|</code> representing the
cursor, it will consider everything that expands <code>prefix</code> and then
add back to it the <code>suffix</code>.</dd>

<dt>basic</dt><dd>Prefix completion that also accounts for the text after
point. Using the above example, this one will consider patterns that
match all of <code>emacs22</code> as well as anything that completes <code>suffix</code>.</dd>

<dt>partial-completion</dt><dd>This is used for file navigation. Instead of
typing out a full path like <code>~/.local/share/fonts</code>, we do <code>~/.l/s/f</code>
or variants thereof to make the matches unique such as <code>~/.l/sh/fon</code>.
It is a joy to navigate the file system in this way.</dd>

<dt>substring</dt><dd>Matches the given sequence of characters literally
regardless of where it is in a word. So <code>pro</code> will match
<code>professional</code> as well as <code>reproduce</code>.</dd>

<dt>flex</dt><dd>Completion of an in-order subset of characters. It does not
matter where the charactes are in the word, so long as they are
encountered in the given order. The input <code>lad</code> will thus match
<code>list-faces-display</code> as well as <code>pulsar-highlight-dwim</code>.</dd>

<dt>initials</dt><dd>Completion of acronyms and initialisms. Typing <code>lfd</code>
will thus match <code>list-faces-display</code>. This completion style can also
be used for file system navigation, though I prefer to only have
<code>partial-completion</code> handle that task.</dd>

<dt>orderless</dt><dd>This is the only completion style I use which is not
built into Emacs and which I tweak further in a separate section
(<a href="#h:7cc77fd0-8f98-4fc0-80be-48a758fcb6e2">The <code>prot-emacs-completion.el</code> for the <code>orderless</code> completion style</a>).
It matches patterns out-of-order. Patterns are typically words
separated by spaces, though they can also be regular expressions,
and even styles that are the same as the aforementioned <code>flex</code> and
<code>initials</code>.</dd>
</dl>

<p>
Now that you know about the completion styles I use, take a look at
the value of my <code>completion-styles</code>. You will notice that <code>orderless</code>,
which is the most powerful/flexible is placed last. I do this because
Emacs tries the styles in the given order from left to right, moving
the next one until it finds a match. As such, I usually want to start
with tight matches (e.g. <code>li-fa-di</code> for <code>list-faces-display</code>) and only
widen the scope of the search as I need to. This is easy to do because
none of the built-in completion styles parses the empty space, so as
soon as I type a space after some characters I am using <code>orderless</code>.
</p>

<p>
Notice that this is not all, as we still have to consider what happens
when the minibuffer prompt we are using defines a specific completion
category whose pattern matching styles differ from what we have in the
<code>completion-styles</code>. To that end, we also set up a more fine-grained
set of completion styles on a per-category basis using overrides.
</p>

<p>
The <code>completion-styles</code> is the fallback option in case there is no
provision for the given completion category. The completion category
is a piece of metadata that is associated with the completion table we
are matching against while using the minibuffer. For example, the
<code>find-file</code> command has the <code>file</code> category, while the
<code>switch-to-buffer</code> command uses the <code>buffer</code> category. The defaults
for those are specified in the variable
<code>completion-category-defaults</code>, while overrides for them can be set in
the <code>completion-category-overrides</code>.
</p>

<p>
While we can override only the categories we care about, the presence
of those <code>completion-category-defaults</code> will surprise us in some cases
because we will not be using what we specified in the <code>completion-styles</code>.
As such, I set <code>completion-category-defaults</code> to nil, to always fall
back to my preferred <code>completion-styles</code> and then I further configure
overrides where those make sense to me.
</p>

<p>
We can opt for per-category styles by configuring the user option
<code>completion-category-overrides</code>. Notice, for example, how I arrange
for <code>partial-completion</code> to be set only for the <code>file</code> completion
category, as I only ever need it there. Also bear in mind what I
described above about why <code>orderless</code> is placed last on the list:
Emacs uses the completion styles from left to right until something
matches the given input. So I do not need to have <code>partial-completion</code>
first as <code>basic</code> will never match something like <code>~/.l/s/fo</code> for
<code>~/.local/share/fonts</code>.
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">;;; General minibuffer settings
(use-package minibuffer
  :ensure nil
  :config
;;;; Completion styles
  (setq completion-styles '(basic substring initials flex orderless)) ; also see `completion-category-overrides'
  (setq completion-pcm-leading-wildcard t) ; Emacs 31: make `partial-completion' behave like `substring'

  ;; Reset all the per-category defaults so that (i) we use the
  ;; standard `completion-styles' and (ii) can specify our own styles
  ;; in the `completion-category-overrides' without having to
  ;; explicitly override everything.
  (setq completion-category-defaults nil)

  ;; A non-exhaustve list of known completion categories:
  ;;
  ;; - `bookmark'
  ;; - `buffer'
  ;; - `charset'
  ;; - `coding-system'
  ;; - `color'
  ;; - `command' (e.g. `M-x')
  ;; - `customize-group'
  ;; - `environment-variable'
  ;; - `expression'
  ;; - `face'
  ;; - `file'
  ;; - `function' (the `describe-function' command bound to `C-h f')
  ;; - `info-menu'
  ;; - `imenu'
  ;; - `input-method'
  ;; - `kill-ring'
  ;; - `library'
  ;; - `minor-mode'
  ;; - `multi-category'
  ;; - `package'
  ;; - `project-file'
  ;; - `symbol' (the `describe-symbol' command bound to `C-h o')
  ;; - `theme'
  ;; - `unicode-name' (the `insert-char' command bound to `C-x 8 RET')
  ;; - `variable' (the `describe-variable' command bound to `C-h v')
  ;; - `consult-grep'
  ;; - `consult-isearch'
  ;; - `consult-kmacro'
  ;; - `consult-location'
  ;; - `embark-keybinding'
  ;;
  (setq completion-category-overrides
        ;; NOTE 2021-10-25: I am adding `basic' because it works better as a
        ;; default for some contexts.  Read:
        ;; &lt;https://debbugs.gnu.org/cgi/bugreport.cgi?bug=50387&gt;.
        ;;
        ;; `partial-completion' is a killer app for files, because it
        ;; can expand ~/.l/s/fo to ~/.local/share/fonts.
        ;;
        ;; If `basic' cannot match my current input, Emacs tries the
        ;; next completion style in the given order.  In other words,
        ;; `orderless' kicks in as soon as I input a space or one of its
        ;; style dispatcher characters.
        '((file (styles . (basic partial-completion orderless)))
          (bookmark (styles . (basic substring)))
          (library (styles . (basic substring)))
          (embark-keybinding (styles . (basic substring)))
          (imenu (styles . (basic substring orderless)))
          (consult-location (styles . (basic substring orderless)))
          (kill-ring (styles . (emacs22 orderless)))
          (eglot (styles . (emacs22 substring orderless))))))
</pre>
</div>
</div>
</div>
<div id="outline-container-h:7cc77fd0-8f98-4fc0-80be-48a758fcb6e2" class="outline-4">
<h4 id="h:7cc77fd0-8f98-4fc0-80be-48a758fcb6e2"><span class="section-number-4">5.4.2.</span> The <code>prot-emacs-completion.el</code> for the <code>orderless</code> completion style</h4>
<div class="outline-text-4" id="text-h:7cc77fd0-8f98-4fc0-80be-48a758fcb6e2">
<p>
The <code>orderless</code> package by Omar Antolín Camarena provides one of the
completion styles that I use (<a href="#h:14b09958-279e-4069-81e3-5a16c9b69892">The <code>prot-emacs-completion.el</code> settings for completion styles</a>).
It is a powerful pattern matching algorithm that parses user input and
interprets it out-of-order, so that <code>in pa</code> will cover <code>insert-pair</code>
as well as <code>package-install</code>. Components of the search are
space-separated, by default, though we can modify the user option
<code>orderless-component-separator</code> to have something else (but I cannot
think of a better value). In the section about completion styles, I
explain how I use <code>orderless</code> and why its power does not result in
lots of false positives.
</p>

<p>
With <code>orderless</code> we can also define so-called &ldquo;style dispatchers&rdquo;.
These are characters attached to the input which instruct <code>orderless</code>
to use a specific pattern for that component. My <code>prot-orderless.el</code>
defines such style dispatchers as postfix operators: they are added to
the end of the input (<a href="#h:114c6e8c-697a-43e9-8fd9-52872997e1c9">The <code>prot-orderless.el</code> library</a>). The equals
sign takes the input literally, the dot interprets it as a file type
extension, while the tilde means to match the input either at the
beginning or the end. Granted, these are overkill most of the time. It
is easier to just continue typing to narrow the list of candidates.
Still, they do have their uses.
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">;;; Orderless completion style (and prot-orderless.el)
(use-package orderless
  :ensure t
  :demand t
  :after minibuffer
  :config
  ;; Remember to check my `completion-styles' and the
  ;; `completion-category-overrides'.
  (setq orderless-matching-styles '(orderless-prefixes orderless-regexp))

  ;; SPC should never complete: use it for `orderless' groups.
  ;; The `?' is a regexp construct.
  :bind ( :map minibuffer-local-completion-map
          ("SPC" . nil)
          ("?" . nil)))

(use-package prot-orderless
  :ensure nil
  :config
  (setq orderless-style-dispatchers
        '(prot-orderless-literal
          prot-orderless-file-ext
          prot-orderless-beg-or-end)))
</pre>
</div>
</div>
</div>
<div id="outline-container-h:7fe1787d-dba3-46fe-82a9-5dc5f8ea6217" class="outline-4">
<h4 id="h:7fe1787d-dba3-46fe-82a9-5dc5f8ea6217"><span class="section-number-4">5.4.3.</span> The <code>prot-emacs-completion.el</code> settings to ignore letter casing</h4>
<div class="outline-text-4" id="text-h:7fe1787d-dba3-46fe-82a9-5dc5f8ea6217">
<p>
I never really need to match letters case-sensitively in the
minibuffer. Let&rsquo;s have everything ignore casing by default.
</p>

<p>
[ In some Elisp that I write there is a <code>let</code> binding for
  <code>case-fold-search</code> to make the search case-sensitive. But those are
  the exceptions. ]
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(setq completion-ignore-case t)
(setq read-buffer-completion-ignore-case t)
(setq-default case-fold-search t)   ; For general regexp
(setq read-file-name-completion-ignore-case t)
</pre>
</div>
</div>
</div>
<div id="outline-container-h:4299825a-db51-49fe-b415-fb1749eed289" class="outline-4">
<h4 id="h:4299825a-db51-49fe-b415-fb1749eed289"><span class="section-number-4">5.4.4.</span> The <code>prot-emacs-completion.el</code> settings for recursive minibuffers</h4>
<div class="outline-text-4" id="text-h:4299825a-db51-49fe-b415-fb1749eed289">
<p>
&ldquo;Recursive minibuffers&rdquo; are of those advanced features that you don&rsquo;t
need frequently, but when you do, it is an excellent addition to your
workflow. The concept describes the use of a minibuffer while another
minibuffer is already open.
</p>

<p>
The need to have multiple (i.e. &ldquo;recursive&rdquo;) minibuffers arises when
you initiate a command, such as <code>M-x</code> followed by some incomplete
command where you remember that you forgot to perform another command
before confirming the first one. I mostly use this as a combination of
<code>M-x</code> (<code>execute-extended-command</code>) and <code>M-:</code> (<code>eval-expression</code>).
</p>

<p>
The <code>read-minibuffer-restore-windows</code> restores the window layout that
was in place when the minibuffer recursion started. I personally do
not want that: just leave me where I am.
</p>

<p>
The <code>minibuffer-depth-indicate-mode</code> shows a number next to the
minibuffer prompt, indicating the level of depth in the recursion,
starting with <code>2</code>.
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(use-package mb-depth
  :ensure nil
  :hook (after-init . minibuffer-depth-indicate-mode)
  :config
  (setq read-minibuffer-restore-windows nil) ; Emacs 28
  (setq enable-recursive-minibuffers t))
</pre>
</div>
</div>
</div>
<div id="outline-container-h:aebbdd4c-6e5b-4773-9f0a-c69f0d3c7158" class="outline-4">
<h4 id="h:aebbdd4c-6e5b-4773-9f0a-c69f0d3c7158"><span class="section-number-4">5.4.5.</span> The <code>prot-emacs-completion.el</code> settings for default values</h4>
<div class="outline-text-4" id="text-h:aebbdd4c-6e5b-4773-9f0a-c69f0d3c7158">
<p>
Minibuffer prompts often have a default value. This is used when the
user types <code>RET</code> without inputting anything. The out-of-the-box
behaviour of Emacs is to append informative text to the prompt like
<code>(default some-default-value)</code>. With the tweak to <code>minibuffer-default-prompt-format</code>
we get a more compact style of <code>[some-default-value]</code>, which looks
better to me.
</p>

<p>
The <code>minibuffer-electric-default-mode</code> displays the default value next
to the prompt only if <code>RET</code> will actually use the default in that
situation. This means that while you start typing in the minibuffer,
the <code>[some-default-value]</code> indicator disappears, since it is no longer
applicable. Without this mode, the indicator stays there at all times,
which can be confusing or distracting.
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(use-package minibuf-eldef
  :ensure nil
  :hook (after-init . minibuffer-electric-default-mode)
  :config
  (setq minibuffer-default-prompt-format " [%s]")) ; Emacs 29
</pre>
</div>
</div>
</div>
<div id="outline-container-h:b640f032-ad11-413e-ad8f-63408671d500" class="outline-4">
<h4 id="h:b640f032-ad11-413e-ad8f-63408671d500"><span class="section-number-4">5.4.6.</span> The <code>prot-emacs-completion.el</code> settings for common interactions</h4>
<div class="outline-text-4" id="text-h:b640f032-ad11-413e-ad8f-63408671d500">
<p>
Here I combine several small tweaks to improve the overall minibuffer
experience.
</p>

<ul class="org-ul">
<li>The need to <code>resize-mini-windows</code> arises on some occasions where
Emacs has to show text spanning multiple lines in the &ldquo;mini
windows&rdquo;. A common scenario for me is in Org mode buffers where I
set the <code>TODO</code> keyword of a task with <code>C-c C-t</code> (<code>M-x org-todo</code>) and
have this as my setting: <code>(setq org-use-fast-todo-selection 'expert)</code>
Otherwise, this is not an issue anyway and I may also like other
options for <code>org-use-fast-todo-selection</code>.</li>

<li>The <code>read-answer-short</code> is complementary to <code>use-short-answers</code>.
This is about providing the shorter version to some confirmation
prompt, such as <code>y</code> instead of <code>yes</code>.</li>

<li>The <code>echo-keystrokes</code> is set to a low value to show in the echo area
the incomplete key sequence I have just typed. This is especially
helpful for demonstration purposes but also to double check that I
did not mistype something (I cannot touch-type, so this happens a lot).</li>

<li><p>
The <code>minibuffer-prompt-properties</code> and advice to <code>completing-read-multiple</code>
make it so that (i) the minibuffer prompt is not accessible with
regular motions to avoid mistakes and (ii) prompts that complete
multiple targets show an indicator about this fact. With regard to
the latter in particular, we have prompts like that of Org to set
tags for a heading (with <code>C-c C-q</code> else <code>M-x org-set-tags-command</code>)
where more than one candidate can be provided using completion,
provided each candidate is separated by the <code>crm-separator</code> (a comma
by default, though Org uses <code>:</code> in that scenario).
</p>

<p>
Remember that when using completion in the minibuffer, you can hit
<code>TAB</code> to expand the selected choice without exiting with it. For
cases when multiple candidates can be selected, you select the
candidate, <code>TAB</code>, then input the <code>crm-separator</code>, and repeat until
you are done selecting at which point you type <code>RET</code>.
</p></li>

<li>Finally the <code>file-name-shadow-mode</code> is a neat little feature to
remove the &ldquo;shadowed&rdquo; part of a file prompt while using something
like <code>C-x C-f</code> (<code>M-x find-file</code>). File name shadowing happens when
we invoke <code>find-file</code> and instead of first deleting the contents of
the minibuffer, we start typing out the file system path we wish to
visit. For example, I am in <code>~/Git/Projects/</code> and type directly
after it something like <code>~/.local/share/fonts/</code>, so Emacs displays
<code>~/Git/Projects/~/.local/share/fonts/</code> with the original part greyed
out. With <code>file-name-shadow-mode</code> the &ldquo;shadowed&rdquo; part is removed
altogether. This is especially nice when combined with the
completion style called <code>partial-completion</code>
(<a href="#h:14b09958-279e-4069-81e3-5a16c9b69892">The <code>prot-emacs-completion.el</code> settings for completion styles</a>).</li>
</ul>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(use-package rfn-eshadow
  :ensure nil
  :hook (minibuffer-setup . cursor-intangible-mode)
  :config
  ;; Not everything here comes from rfn-eshadow.el, but this is fine.

  (setq resize-mini-windows t)
  (setq read-answer-short t) ; also check `use-short-answers' for Emacs28
  (setq echo-keystrokes 0.25)
  (setq kill-ring-max 60) ; Keep it small

  ;; Do not allow the cursor to move inside the minibuffer prompt.  I
  ;; got this from the documentation of Daniel Mendler's Vertico
  ;; package: &lt;https://github.com/minad/vertico&gt;.
  (setq minibuffer-prompt-properties
        '(read-only t cursor-intangible t face minibuffer-prompt))

  ;; MCT has a variant of this built-in.
  (unless (eq prot-emacs-completion-ui 'mct)
    ;; Add prompt indicator to `completing-read-multiple'.  We display
    ;; [`completing-read-multiple': &lt;separator&gt;], e.g.,
    ;; [`completing-read-multiple': ,] if the separator is a comma.  This
    ;; is adapted from the README of the `vertico' package by Daniel
    ;; Mendler.  I made some small tweaks to propertize the segments of
    ;; the prompt.
    (defun crm-indicator (args)
      (cons (format "[`completing-read-multiple': %s]  %s"
                    (propertize
                     (replace-regexp-in-string
                      "\\`\\[.*?]\\*\\|\\[.*?]\\*\\'" ""
                      crm-separator)
                     'face 'error)
                    (car args))
            (cdr args)))

    (advice-add #'completing-read-multiple :filter-args #'crm-indicator))

  (file-name-shadow-mode 1))
</pre>
</div>
</div>
</div>
<div id="outline-container-h:de61a607-0bdf-462b-94cd-c0898319590e" class="outline-4">
<h4 id="h:de61a607-0bdf-462b-94cd-c0898319590e"><span class="section-number-4">5.4.7.</span> The <code>prot-emacs-completion.el</code> generic minibuffer UI settings</h4>
<div class="outline-text-4" id="text-h:de61a607-0bdf-462b-94cd-c0898319590e">
<p>
These are some settings for the default completion user interface.
These do not come into effect unless <code>prot-emacs-completion-ui</code> is set
to a <code>nil</code> value or when we are not using any package for in-buffer
completion (such as the <code>corfu</code> package).
</p>

<ul class="org-ul">
<li><a href="#h:f012a254-2716-4c29-a64b-c2b3df34f57f">The <code>init.el</code> option to load a minibuffer user interface</a></li>
<li><a href="#h:cff33514-d3ac-4c16-a889-ea39d7346dc5">The <code>prot-emacs-completion.el</code> submodule for <code>vertico</code> (<code>prot-emacs-vertico.el</code>)</a></li>
<li><a href="#h:e9fb09f0-f2e6-4943-83bf-e5fadcfa530a">The <code>prot-emacs-completion.el</code> submodule for <code>mct</code> (<code>prot-emacs-mct.el</code>)</a></li>
</ul>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(use-package minibuffer
  :ensure nil
  :demand t
  :config
  (setq completions-format 'one-column)
  (setq completion-show-help nil)
  (setq completion-auto-help 'always)
  (setq completion-auto-select nil)
  (setq completions-detailed t)
  (setq completion-show-inline-help nil)
  (setq completions-max-height 6)
  (setq completions-header-format (propertize "%s candidates:\n" 'face 'bold-italic))
  (setq completions-highlight-face 'completions-highlight)
  (setq minibuffer-completion-auto-choose t)
  (setq minibuffer-visible-completions t) ; Emacs 30
  (setq completions-sort 'historical)

  (unless prot-emacs-completion-ui
    (prot-emacs-keybind minibuffer-local-completion-map
      "&lt;up&gt;" #'minibuffer-previous-line-completion
      "&lt;down&gt;" #'minibuffer-next-line-completion)

    (add-hook 'completion-list-mode-hook #'prot-common-truncate-lines-silently)))
</pre>
</div>
</div>
</div>
<div id="outline-container-h:25765797-27a5-431e-8aa4-cc890a6a913a" class="outline-4">
<h4 id="h:25765797-27a5-431e-8aa4-cc890a6a913a"><span class="section-number-4">5.4.8.</span> The <code>prot-emacs-completion.el</code> settings for saving the history (<code>savehist-mode</code>)</h4>
<div class="outline-text-4" id="text-h:25765797-27a5-431e-8aa4-cc890a6a913a">
<p>
Minibuffer prompts can have their own history. When they do not, they
share a common history of user inputs. Emacs keeps track of that
history in the current session, but loses it as soon as we close it.
With <code>savehist-mode</code> enabled, all minibuffer histories are written to
a file and are restored when we start Emacs again.
</p>

<p>
Histories are useful in two ways:
</p>

<ol class="org-ol">
<li>Recent choices appear at the top, so we can find them more easily.</li>
<li>The <code>M-p</code> (<code>previous-history-element</code>) and <code>M-n</code> (<code>next-history-element</code>)
commands in the minibuffer will be useful right away upon
restoring Emacs (all my packages make good use of minibuffer
histories per prompt, so <code>M-p</code> and <code>M-n</code> only show relevant values).</li>
</ol>

<p>
Since we are already recording minibuffer histories, we can instruct
<code>savehist-mode</code> to also keep track of additional variables and restore
them next time we use Emacs. Hence <code>savehist-additional-variables</code>. I
do this in a few of places:
</p>

<ul class="org-ul">
<li><a href="#h:804b858f-7913-47ef-aaf4-8eef5b59ecb4">The <code>prot-emacs-completion.el</code> for in-buffer completion popup and preview (<code>corfu</code>)</a></li>
<li><a href="#h:5685df62-4484-42ad-a062-d55ab19022e3">The <code>prot-emacs-essentials.el</code> settings for registers</a></li>
<li><a href="#h:32f6fe0f-23c4-44cc-97cc-3e5372bd484e">The <code>prot-shell.el</code> library</a></li>
</ul>

<p>
Note that the user option <code>history-length</code> applies to each individual
history variable: it is not about all histories combined.
</p>

<p>
Overall, I am happy with this feature and benefit from it on a daily
basis.
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">;;;; `savehist' (minibuffer and related histories)
(use-package savehist
  :ensure nil
  :hook (after-init . savehist-mode)
  :config
  (setq savehist-file (locate-user-emacs-file "savehist"))
  (setq history-length 100)
  (setq history-delete-duplicates t)
  (setq savehist-save-minibuffer-history t)
  (add-to-list 'savehist-additional-variables 'kill-ring))
</pre>
</div>
</div>
</div>
<div id="outline-container-h:567bb00f-1d82-4746-93e5-e0f60721728a" class="outline-4">
<h4 id="h:567bb00f-1d82-4746-93e5-e0f60721728a"><span class="section-number-4">5.4.9.</span> The <code>prot-emacs-completion.el</code> settings for dynamic text expansion (<code>dabbrev</code>)</h4>
<div class="outline-text-4" id="text-h:567bb00f-1d82-4746-93e5-e0f60721728a">
<p>
The built-in <code>dabbrev</code> package provides a text completion method that
reads the contents of a buffer and expands the text before the cursor
to match possible candidates. This is done with <code>M-/</code> (<code>dabbrev-expand</code>)
which is what I use most of the time to perform in-buffer completions.
</p>

<p>
I like <code>dabbrev</code> because it is minimal. It does not produce any popup
or affect the window layout and so it is keeping me focused on what I
am doing. I wish it had a behaviour where we could initiate it and at
any point demand a fully fledged minibuffer presentation of what it is
trying to match, instead of cycling through the candidates with
repeated <code>M-/</code>. Granted, I normally do not cycle in that way, as I
typically type out enough to get an exact match or be one <code>M-/</code> away
from it.
</p>

<p>
Apart from the <code>dabbrev-expand</code> command, we have <code>dabbrev-completion</code>.
I do not use it because it does not feel natural while typing to stop,
check the minibuffer for some text, select it, and go back to typing.
Perhaps this is because I have a style of writing without
interruptions and without going back to immediately edit what I wrote
(unless I am doing a demonstration, where the viewer needs to follow
along).
</p>

<p>
The term &ldquo;dabbrev&rdquo; stands for &ldquo;dynamic abbreviation&rdquo;. Emacs also has
static, user-defined abbreviations (<a href="#h:fd84b79a-351e-40f0-b383-bf520d77834b">The <code>prot-emacs-completion.el</code> settings for static text expansion (<code>abbrev</code>)</a>).
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(use-package dabbrev
  :ensure nil
  :commands (dabbrev-expand dabbrev-completion)
  :config
;;;; `dabbrev' (dynamic word completion (dynamic abbreviations))
  (setq dabbrev-abbrev-char-regexp "\\sw\\|\\s_")
  (setq dabbrev-abbrev-skip-leading-regexp "[$*/=~']")
  (setq dabbrev-backward-only nil)
  (setq dabbrev-case-distinction 'case-replace)
  (setq dabbrev-case-fold-search nil)
  (setq dabbrev-case-replace 'case-replace)
  (setq dabbrev-check-other-buffers t)
  (setq dabbrev-eliminate-newlines t)
  (setq dabbrev-upcase-means-case-search t)
  (setq dabbrev-ignored-buffer-modes
        '(archive-mode image-mode docview-mode pdf-view-mode)))
</pre>
</div>
</div>
</div>
<div id="outline-container-h:fd84b79a-351e-40f0-b383-bf520d77834b" class="outline-4">
<h4 id="h:fd84b79a-351e-40f0-b383-bf520d77834b"><span class="section-number-4">5.4.10.</span> The <code>prot-emacs-completion.el</code> settings for static text expansion (<code>abbrev</code>)</h4>
<div class="outline-text-4" id="text-h:fd84b79a-351e-40f0-b383-bf520d77834b">
<p>
[ Watch: <a href="https://protesilaos.com/codelog/2024-02-03-emacs-abbrev-mode/">abbreviations with abbrev-mode (quick text expansion)</a> (2024-02-03). ]
</p>

<p>
Unlike &ldquo;dynamic abbreviations&rdquo; that depend on the text already
available in a buffer, we can define abbreviations that always expand
to what we have specified (<a href="#h:567bb00f-1d82-4746-93e5-e0f60721728a">The <code>prot-emacs-completion.el</code> settings for dynamic text expansion (<code>dabbrev</code>)</a>).
</p>

<p>
Abbreviations, else the <code>abbrev</code> mechanism, are strings of characters
that when typed out are replaced by another string. For example, if I
want to type in my website&rsquo;s URL, I insert <code>meweb</code> and continue
typing. Emacs will expand that word into <code>https://protesilaos.com</code>.
</p>

<p>
Unless you are documenting what your abbreviation does or have abbrevs
that are easy to mistype, you will never need to tell Emacs not to
expand the given input. Note that the command <code>unexpand-abbrev</code> is
there if you need it. I had to use it in the above paragraph to first
type out the abbrev I used as an example.
</p>

<p>
Similarly, we can expand an abbrev anywhere with the command
<code>expand-abbrev</code>, though we normally do not have to do this because it
happens automatically as we type.
</p>

<p>
Emacs is smart about how we define and use abbrevs. Each major mode
has its own abbrev table, to which we add our definitions. When we are
in a buffer that has that major mode, we gain access to the relevant
abbreviations. A <code>global-abbrev-table</code> is also available. In case of a
conflict between a major-mode-specific table and the global one, the
former takes precedence. Furthermore, abbrev tables conform with the
same inheritence principle as major modes at-large, meaning that
something like Org mode will inherit the <code>text-mode-abbrev-table</code>
because <code>org-mode</code> is derived from <code>text-mode</code>. Abbrev tables are thus
consistent with how hooks and keymaps work in terms of precedence and
inheritence.
</p>

<p>
As you will notice below, I use the <code>prot-emacs-abbrev</code> macro to make
it easier to define these (<a href="#h:e7a12825-7848-42bd-b99b-b87903012814">The <code>init.el</code> macro to define abbreviations (<code>prot-emacs-abbrev</code>)</a>).
Most of my abbrevs are simple letter casing tweaks. Though keep in
mind that the underlying mechanism is powerful and can evaluate
arbitrary Elisp code (I played around with it, though I don&rsquo;t use
templates to have a real need for it&#x2014;but it works).
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">;;;; `abbrev' (Abbreviations, else Abbrevs)
(use-package abbrev
  :ensure nil
  ;; message-mode derives from text-mode, so we don't need a separate
  ;; hook for it.
  :hook ((text-mode prog-mode git-commit-mode) . abbrev-mode)
  :config
  (setq only-global-abbrevs nil)

  (prot-emacs-abbrev global-abbrev-table
    "meweb"   "https://protesilaos.com"
    "megit"   "https://github.com/protesilaos"
    "mehub"   "https://github.com/protesilaos"
    "meclone" "git@github.com/protesilaos/"
    "melab"   "https://gitlab.com/protesilaos"
    "medrive" "hyper://5cr7mxac8o8aymun698736tayrh1h4kbqf359cfk57swjke716gy/"
    ";web"   "https://protesilaos.com"
    ";git"   "https://github.com/protesilaos"
    ";hub"   "https://github.com/protesilaos"
    ";clone" "git@github.com/protesilaos/"
    ";lab"   "https://gitlab.com/protesilaos"
    ";drive" "hyper://5cr7mxac8o8aymun698736tayrh1h4kbqf359cfk57swjke716gy/")

  (prot-emacs-abbrev text-mode-abbrev-table
    "asciidoc"       "AsciiDoc"
    "auctex"         "AUCTeX"
    "cafe"           "café"
    "cliche"         "cliché"
    "clojurescript"  "ClojureScript"
    "emacsconf"      "EmacsConf"
    "github"         "GitHub"
    "gitlab"         "GitLab"
    "javascript"     "JavaScript"
    "latex"          "LaTeX"
    "libreplanet"    "LibrePlanet"
    "linkedin"       "LinkedIn"
    "paypal"         "PayPal"
    "sourcehut"      "SourceHut"
    "texmacs"        "TeXmacs"
    "typescript"     "TypeScript"
    "visavis"        "vis-à-vis"
    "deja"           "déjà"
    "youtube"        "YouTube"
    ";up"            "🙃"
    ";uni"           "🦄"
    ";laugh"         "🤣"
    ";smile"         "😀"
    ";sun"           "☀️")

  ;; Allow abbrevs with a prefix colon, semicolon, or underscore.  I demonstrated
  ;; this here: &lt;https://protesilaos.com/codelog/2024-02-03-emacs-abbrev-mode/&gt;.
  (abbrev-table-put global-abbrev-table :regexp "\\(?:^\\|[\t\s]+\\)\\(?1:[:;_].*\\|.*\\)")

  (with-eval-after-load 'text-mode
    (abbrev-table-put text-mode-abbrev-table :regexp "\\(?:^\\|[\t\s]+\\)\\(?1:[:;_].*\\|.*\\)"))

  (with-eval-after-load 'org
    (prot-emacs-abbrev org-mode-abbrev-table
      ";dev" "{{{development-version}}}")
    (abbrev-table-put org-mode-abbrev-table :regexp "\\(?:^\\|[\t\s]+\\)\\(?1:[:;_].*\\|.*\\)"))

  (with-eval-after-load 'message
    (prot-emacs-abbrev message-mode-abbrev-table
      "bestregards"  "Best regards,\nProtesilaos (or simply \"Prot\")"
      "allthebest"   "All the best,\nProtesilaos (or simply \"Prot\")"
      "niceday"      "Have a nice day,\nProtesilaos (or simply \"Prot\")"
      "abest"        "All the best,\nProt"
      "bregards"     "Best regards,\nProt"
      "nday"         "Have a nice day,\nProt"
      "nosrht"       "P.S. I am phasing out SourceHut: &lt;https://protesilaos.com/codelog/2024-01-27-sourcehut-no-more/&gt;.
Development continues on GitHub with GitLab as a mirror."))

  ;; The `prot-emacs-abbrev' macro, which simplifies how we use
  ;; `define-abbrev', does not only expand a static text.  It can take
  ;; a pair of string and function to trigger the latter when the
  ;; former is inserted.  Think of it like the basis of a simplistic
  ;; templating system.
  (require 'prot-abbrev)
  (prot-emacs-abbrev global-abbrev-table
    "metime" #'prot-abbrev-current-time
    "medate" #'prot-abbrev-current-date
    "mejitsi" #'prot-abbrev-jitsi-link
    ";time" #'prot-abbrev-current-time
    ";date" #'prot-abbrev-current-date
    ";jitsi" #'prot-abbrev-jitsi-link)

  (prot-emacs-abbrev text-mode-abbrev-table
    ";update" #'prot-abbrev-update-html)

  ;; Because the *scratch* buffer is produced before we load this, we
  ;; have to explicitly activate the mode there.
  (when-let* ((scratch (get-buffer "*scratch*")))
    (with-current-buffer scratch
      (abbrev-mode 1)))

  ;; By default, abbrev asks for confirmation on whether to use
  ;; `abbrev-file-name' to save abbrevations.  I do not need that, nor
  ;; do I want it.
  (remove-hook 'save-some-buffers-functions #'abbrev--possibly-save))
</pre>
</div>
</div>
</div>
<div id="outline-container-h:804b858f-7913-47ef-aaf4-8eef5b59ecb4" class="outline-4">
<h4 id="h:804b858f-7913-47ef-aaf4-8eef5b59ecb4"><span class="section-number-4">5.4.11.</span> The <code>prot-emacs-completion.el</code> for in-buffer completion popup (<code>corfu</code>)</h4>
<div class="outline-text-4" id="text-h:804b858f-7913-47ef-aaf4-8eef5b59ecb4">
<p>
I generally do not rely on in-buffer text completion. I feel it slows
me down and distracts me. When I do, however, need to rely on it, I
have the <code>corfu</code> package by Daniel Mendler: it handles the task
splendidly as it works with Emacs&rsquo; underlying infrastructure for
<code>completion-at-point-functions</code>.
</p>

<p>
Completion is triggered with the <code>TAB</code> key, which produces a popup
where the cursor is. The companion <code>corfu-popupinfo-mode</code> will show a
secondary documentation popup if we move over a candidate but do not
do anything with it.
</p>

<p>
Also see <a href="#h:567bb00f-1d82-4746-93e5-e0f60721728a">the <code>prot-emacs-completion.el</code> settings for dynamic text expansion (<code>dabbrev</code>)</a>.
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">;;; Corfu (in-buffer completion popup)
(use-package corfu
  :ensure t
  :if (display-graphic-p)
  :hook (after-init . global-corfu-mode)
  ;; I also have (setq tab-always-indent 'complete) for TAB to complete
  ;; when it does not need to perform an indentation change.
  :bind (:map corfu-map ("&lt;tab&gt;" . corfu-complete))
  :config
  (setq corfu-preview-current nil)
  (setq corfu-min-width 20)

  (setq corfu-popupinfo-delay '(1.25 . 0.5))
  (corfu-popupinfo-mode 1) ; shows documentation after `corfu-popupinfo-delay'

  ;; Sort by input history (no need to modify `corfu-sort-function').
  (with-eval-after-load 'savehist
    (corfu-history-mode 1)
    (add-to-list 'savehist-additional-variables 'corfu-history)))
</pre>
</div>
</div>
</div>
<div id="outline-container-h:22e97b4c-d88d-4deb-9ab3-f80631f9ff1d" class="outline-4">
<h4 id="h:22e97b4c-d88d-4deb-9ab3-f80631f9ff1d"><span class="section-number-4">5.4.12.</span> The <code>prot-emacs-completion.el</code> settings for <code>consult</code></h4>
<div class="outline-text-4" id="text-h:22e97b4c-d88d-4deb-9ab3-f80631f9ff1d">
<p>
[ This feature is subject to <a href="#h:91477890-49d5-48c3-9627-62295d2ab35d">The <code>init.el</code> user option to load extras for minibuffer completion</a>. ]
</p>

<p>
<code>consult</code> is another wonderful package by Daniel Mendler. It provides
a number of commands that turbocharge the minibuffer with advanced
capabilities for filtering, asynchronous input, and previewing of the
current candidate&rsquo;s context.
</p>

<ul class="org-ul">
<li>A case where filtering is in use is the <code>consult-buffer</code> command,
which many users have as a drop-in replacement to the generic <code>C-x b</code>
(<code>M-x switch-to-buffer</code>). It is a one-stop-shop for buffers,
recently visited files (if <code>recentf-mode</code> is used&#x2014;I don&rsquo;t),
bookmarks (<a href="#h:581aa0ff-b136-4099-a321-3b86edbfbccb">The <code>prot-emacs-essentials.el</code> settings for bookmarks</a>),
and, in principle, anything else that defines a source for this
interface. To filter those source, we can type at the empty
minibuffer <code>b SPC</code>, which will insert a filter specific to buffers.
Delete back to remove the <code>[Buffer]</code> filter and insert another
filter. Available filters are displayed by typing <code>?</code> at the prompt
(I define it this way to call the command <code>consult-narrow-help</code>).
Every multi-source command from <code>consult</code> relies on this paradigm.</li>

<li>Asynchronous input pertains to the intersection between Emacs and
external search programs. A case in point is <code>consult-grep</code>, which
calls the system&rsquo;s <code>grep</code> program. The prompt distinguishes between
what is sent to the external program and what is only shown to Emacs
by wrapping the former inside of <code>#</code>. So the input <code>#prot-#completion</code>
will send <code>prot-</code> to the <code>grep</code> program and then use <code>completion</code>
inside of the minibuffer to perform the subsequent pattern-matching
(e.g. with help from <code>orderless</code> (<a href="#h:7cc77fd0-8f98-4fc0-80be-48a758fcb6e2">The <code>prot-emacs-completion.el</code> for the <code>orderless</code> completion style</a>).
The part that is sent to the external program does not block Emacs.
It is handled asynchronously, so everything stays responsive.</li>

<li>As for previewing, <code>consult</code> commands show the context of the
current match and update the window as we move between completion
candidates in the minibuffer. For example, the <code>consult-line</code>
command performs an in-buffer search and lets us move between
matches in the minibuffer while seeing in the window above what the
surrounding text looks like. This is an excellent feature when we
are trying to find something and do not quite remember all the
search terms to narrow down to it simply by typing at the minibuffer
prompt.</li>
</ul>

<p>
Also check: <a href="#h:e0f9c30e-3a98-4479-b709-7008277749e4">The <code>prot-emacs-search.el</code> module</a>.
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">;;; Enhanced minibuffer commands (consult.el)
(when prot-emacs-completion-extras
  (use-package consult
    :ensure t
    :hook (completion-list-mode . consult-preview-at-point-mode)
    :bind
    ( :map global-map
      ("M-g M-g" . consult-goto-line)
      ("M-K" . consult-keep-lines) ; M-S-k is similar to M-S-5 (M-%)
      ("M-F" . consult-focus-lines) ; same principle
      ("M-s M-b" . consult-buffer)
      ("M-s M-f" . consult-find)
      ("M-s M-g" . consult-grep)
      ("M-s M-h" . consult-history)
      ("M-s M-i" . consult-imenu)
      ("M-s M-l" . consult-line)
      ("M-s M-m" . consult-mark)
      ("M-s M-y" . consult-yank-pop)
      ("M-s M-s" . consult-outline)
      :map consult-narrow-map
      ("?" . consult-narrow-help))
    :config
    (setq consult-line-numbers-widen t)
    ;; (setq completion-in-region-function #'consult-completion-in-region)
    (setq consult-async-min-input 3)
    (setq consult-async-input-debounce 0.5)
    (setq consult-async-input-throttle 0.8)
    (setq consult-narrow-key nil)
    (setq consult-find-args
          (concat "find . -not ( "
                  "-path */.git* -prune "
                  "-or -path */.cache* -prune )"))
    (setq consult-preview-key 'any)
    (setq consult-project-function nil) ; always work from the current directory (use `cd' to switch directory)

    (add-to-list 'consult-mode-histories '(vc-git-log-edit-mode . log-edit-comment-ring))

    (require 'consult-imenu) ; the `imenu' extension is in its own file

    (with-eval-after-load 'pulsar
      ;; see my `pulsar' package: &lt;https://protesilaos.com/emacs/pulsar&gt;
      (setq consult-after-jump-hook nil) ; reset it to avoid conflicts with my function
      (dolist (fn '(pulsar-recenter-top pulsar-reveal-entry))
        (add-hook 'consult-after-jump-hook fn)))))
</pre>
</div>
</div>
</div>
<div id="outline-container-h:61863da4-8739-42ae-a30f-6e9d686e1995" class="outline-4">
<h4 id="h:61863da4-8739-42ae-a30f-6e9d686e1995"><span class="section-number-4">5.4.13.</span> The <code>prot-emacs-completion.el</code> section about <code>embark</code></h4>
<div class="outline-text-4" id="text-h:61863da4-8739-42ae-a30f-6e9d686e1995">
<p>
[ This feature is subject to <a href="#h:91477890-49d5-48c3-9627-62295d2ab35d">The <code>init.el</code> user option to load extras for minibuffer completion</a>. ]
</p>

<p>
The <code>embark</code> package by Omar Antolín Camarena provides a mechanism to
perform relevant actions in the given context. What constitutes &ldquo;the
given context&rdquo; depends on where the cursor is, such as if it is at the
end of a symbolic expression in Lisp code or inside the minibuffer.
The single point of entry is the <code>embark-act</code> command or variants like
<code>embark-dwim</code>.
</p>

<p>
With <code>embark-act</code> we gain access to a customisable list of commands
for the given context. If we are over a Lisp symbol, one possible
action is to describe it (i.e. produce documentation about it). If we
are browsing files in the minibuffer, possible actions include file
operations such as to delete or rename the file. And so on for
everything.
</p>

<p>
The <code>embark-dwim</code> command always performs the default action for the
given context. It is like invoking <code>embark-act</code> and then typing the
<code>RET</code> key.
</p>

<p>
A killer feature of <code>embark</code> is the concepts of &ldquo;collect&rdquo; and
&ldquo;export&rdquo;. These are used in the minibuffer to produce a dedicated
buffer that contains all the completion candidates. For example, if we
are reading documentation about <code>embark-</code> and have 10 items there, we
can &ldquo;collect&rdquo; the results in their own buffer and then navigate it as
if it were the minibuffer: <code>RET</code> will perform the action that the
actual minibuffer would have carried out (to show documentation, in
this case). Similarly, the export mechanism takes the completion
candidates out of the minibuffer, though it also puts them in a major
mode that is appropriate for them. Files, for instance, will be placed
in a Dired buffer (<a href="#h:f8b08a77-f3a8-42fa-b1a9-f940348889c3">The <code>prot-emacs-dired.el</code> module</a>).
</p>

<p>
Depending on the configurations about the &ldquo;indicator&rdquo;, the <code>embark-act</code>
command will display an informative buffer with keys and their
corresponding commands. We can control its placement the same way we
do with all well-behaved buffers (<a href="#h:50f8b1e4-b14e-453f-a37e-1c0e495ab80f">The <code>prot-emacs-window.el</code> rules for displaying buffers (<code>display-buffer-alist</code>)</a>).
</p>

<p>
One downside of <code>embark</code> is that it is hard to know what the context
is. I have had this experience myself several times, where I though I
was targeting the URL at point while the actions were about Org source
blocks, headings, and whatnot. Embark is probably correct in such a
case, though I cannot make my brain think the way it expects.
</p>

<p>
Another downside, which is also true for <code>which-key</code> (<a href="#h:ddb1070d-2f91-4224-ad43-ef03f038f787">The <code>prot-emacs-which-key.el</code> module</a>),
is the sheer number of options for each context. I feel that the
defaults should be more conservative, to have 3-4 actions per context
to make it easier to find stuff. Those who need more, can add them.
Documentation can also be provided to that end. Adding commands to
such a list is not a trivial task, because the user must modify
keymaps and thus understand the relevant concepts. Sure, we can all
learn, but this is not your usual <code>setq</code> tweak.
</p>

<p>
All things considered, I do not recommend <code>embark</code> to new users as I
know for a fact that people have trouble using it effectively. Power
users can benefit from it, though you will notice in the following
code block and in <code>prot-embark.el</code> how even power users need to put in
some work (<a href="#h:fb034be5-c316-4c4f-a46f-cebcab332a47">The <code>prot-embark.el</code> library</a>). Whether it is worth it or
not depends on one&rsquo;s use-case.
</p>

<p>
Karthik Chikmagalur has an excellently written and presented essay on
<a href="https://karthinks.com/software/fifteen-ways-to-use-embark/">Fifteen ways to use Embark</a>. If you plan on becoming an <code>embark</code> power
user, this will help you. Quote from Karthik:
</p>

<blockquote>
<p>
Despite what these examples suggest, I estimate that I use less than a
third of what Embark provides. Even so, in allowing me to change or
chain actions at any time, it lets me pilot Emacs by the seat of my
pants. A second, unforeseen benefit is that it makes commands and
listings that I would never use available in a frictionless way:
commands like <code>transpose-regions</code> and <code>apply-macro-to-region-lines</code>,
or custom <code>dired</code>, <code>ibuffer</code> and <code>package-menu</code> listings that are
interactively inaccessible otherwise. The ability to quickly whip up
such buffers makes knowing how to use dired or ibuffer pay off
several fold. In composing such features seamlessly with minibuffer
interaction or with text-regions, Embark acts as a lever to amplify
the power of Emacs’ myriad built in commands and libraries.
</p>
</blockquote>

<p>
I have been using Emacs since 2019 and not once did I have a use for
<code>transpose-regions</code> or <code>apply-macro-to-region-lines</code>. To run a
keyboard macro in a region, narrow to it, and call the kmacro with a
<code>0</code> argument (run until you encounter an error or the end of the
buffer). Why remember such a specialised function when the general
pattern is getting the job done? And why be presented with the option
of that same function every single time you <code>embark-act</code> on a region?
</p>

<p>
Personally, I would be content with a package that does the equivalent
of &ldquo;collect&rdquo; and &ldquo;export&rdquo;. The rest is about organising keybindings
and how you approach a given task (workflow as opposed to core
functionality).
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">;;; Extended minibuffer actions and more (embark.el and prot-embark.el)
(when prot-emacs-completion-extras
  (use-package embark
    :ensure t
    :defer 1
    :config
    (setq embark-confirm-act-all nil)
    ;; The prot-embark.el has an advice to further simplify the
    ;; minimal indicator.  It shows cycling, which I never want to see
    ;; or do.
    (setq embark-mixed-indicator-both nil)
    (setq embark-mixed-indicator-delay 1.0)
    (setq embark-indicators '(embark-mixed-indicator embark-highlight-indicator))
    (setq embark-verbose-indicator-nested nil) ; I think I don't have them, but I do not want them either
    (setq embark-verbose-indicator-buffer-sections '(bindings))
    (setq embark-verbose-indicator-excluded-actions
          '(embark-cycle embark-act-all embark-collect embark-export embark-insert))

    ;; I never cycle and want to disable the damn thing.  Normally, a
    ;; nil value disables a key binding but here that value is
    ;; interpreted as the binding for `embark-act'.  So I just add
    ;; some obscure key that I do not have.  I absolutely do not want
    ;; to cycle!
    (setq embark-cycle-key "&lt;XF86Travel&gt;")

    ;; I do not want `embark-org' and am not sure what is loading it.
    ;; So I just unsert all the keymaps... This is the nuclear option
    ;; but here we are.
    (with-eval-after-load 'embark-org
      (defvar prot/embark-org-keymaps
        '(embark-org-table-cell-map
          embark-org-table-map
          embark-org-link-copy-map
          embark-org-link-map
          embark-org-src-block-map
          embark-org-item-map
          embark-org-plain-list-map
          embark-org-export-in-place-map)
        "List of Embark keymaps for Org.")

      ;; Reset `prot/embark-org-keymaps'.
      (seq-do
       (lambda (keymap)
         (set keymap (make-sparse-keymap)))
       prot/embark-org-keymaps)))

  ;; I define my own keymaps because I only use a few functions in a
  ;; limited number of contexts.
  (use-package prot-embark
    :ensure nil
    :after embark
    :bind
    ( :map global-map
      ("C-," . prot-embark-act-no-quit)
      ("C-." . prot-embark-act-quit)
      :map embark-collect-mode-map
      ("C-," . prot-embark-act-no-quit)
      ("C-." . prot-embark-act-quit)
      :map minibuffer-local-filename-completion-map
      ("C-," . prot-embark-act-no-quit)
      ("C-." . prot-embark-act-quit))
    :config
    (setq embark-keymap-alist
          '((buffer prot-embark-buffer-map)
            (command prot-embark-command-map)
            (expression prot-embark-expression-map)
            (file prot-embark-file-map)
            (function prot-embark-function-map)
            (identifier prot-embark-identifier-map)
            (package prot-embark-package-map)
            (region prot-embark-region-map)
            (symbol prot-embark-symbol-map)
            (url prot-embark-url-map)
            (variable prot-embark-variable-map)
            (t embark-general-map))))

  ;; Needed for correct exporting while using Embark with Consult
  ;; commands.
  (use-package embark-consult
    :ensure t
    :after (embark consult)))
</pre>
</div>
</div>
</div>
<div id="outline-container-h:bd3f7a1d-a53d-4d3e-860e-25c5b35d8e7e" class="outline-4">
<h4 id="h:bd3f7a1d-a53d-4d3e-860e-25c5b35d8e7e"><span class="section-number-4">5.4.14.</span> The <code>prot-emacs-completion.el</code> section to configure completion annotations (<code>marginalia</code>)</h4>
<div class="outline-text-4" id="text-h:bd3f7a1d-a53d-4d3e-860e-25c5b35d8e7e">
<p>
The <code>marginalia</code> package, co-authored by Daniel Mendler and Omar
Antolín Camarena, provides helpful annotations to the side of
completion candidates. We see its effect, for example, when we call <code>M-x</code>:
each command has a brief description next to it (taken from its doc
string) as well as a key binding, if it has one.
</p>

<p>
Annotations are provided on a per-category basis. Categories are
metadata associated with the completion table, which describe what the
candidates are about. I cover this concept also in my section on
completion styles where I configure pattern-matching algorithms
accordingly (<a href="#h:14b09958-279e-4069-81e3-5a16c9b69892">The <code>prot-emacs-completion.el</code> settings for completion styles</a>).
</p>

<p>
The out-of-the-box settings of <code>marginalia</code> are perfectly usable.
Though there are some categories that I either do not want to annotate
(like <code>file</code>) or that I want to tweak their presentation of. You will
thus notice how my <code>prot-marginalia.el</code> configures the user option
<code>marginalia-annotator-registry</code> (<a href="#h:92085a6d-213f-400d-be83-763eb80a3877">The <code>prot-marginalia.el</code> library</a>).
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">;;; Detailed completion annotations (marginalia.el)
(use-package marginalia
  :ensure t
  :hook (after-init . marginalia-mode)
  :config
  (setq marginalia-max-relative-age 0)) ; absolute time

;;;; Custom completion annotations
(use-package prot-marginalia
  :ensure nil
  :after marginalia
  :config
  (setq marginalia-annotator-registry
        '((bookmark prot-marginalia-bookmark)
          (buffer prot-marginalia-buffer)
          (command marginalia-annotate-command)
          (function prot-marginalia-symbol)
          (symbol prot-marginalia-symbol)
          (variable prot-marginalia-symbol)
          (face marginalia-annotate-face)
          (imenu marginalia-annotate-imenu)
          (package prot-marginalia-package)
          (unicode-name marginalia-annotate-char))))
</pre>
</div>
</div>
</div>
<div id="outline-container-h:db620e44-fc8f-45b8-a7fd-ae1d0b7ce86c" class="outline-4">
<h4 id="h:db620e44-fc8f-45b8-a7fd-ae1d0b7ce86c"><span class="section-number-4">5.4.15.</span> The <code>prot-emacs-completion.el</code> setting to load a minibuffer UI submodule</h4>
<div class="outline-text-4" id="text-h:db620e44-fc8f-45b8-a7fd-ae1d0b7ce86c">
<p>
In my <code>init.el</code> I define a user option to select a user interface for
the minibuffer (<a href="#h:f012a254-2716-4c29-a64b-c2b3df34f57f">The <code>init.el</code> option to load a minibuffer user interface</a>).
The choice is between my <code>mct</code> package and <code>vertico</code> by Daniel
Mendler. I think <code>vertico</code> is the better choice overall and that is why I
set it as the default. Whereas <code>mct</code> is for users who are more
familiar with the default minibuffer interface and want a bit more
interactivity or convenience on top.
</p>

<p>
Newer versions of Emacs keep receiving MCT-like tweaks to the default
UI, which means that <code>mct</code> will eventually be superseded by built-in
options. Until then, I keep it around in a maintenance-only state for
those who need it.
</p>

<p>
Note that due to my particular needs to not display the minibuffer
eagerly (I do not wish to accidentaly share private details when doing
a presentation), I configure <code>vertico</code> to be more &ldquo;private&rdquo; and thus
function as close to <code>mct</code> as possible.
</p>

<ul class="org-ul">
<li><a href="#h:e9fb09f0-f2e6-4943-83bf-e5fadcfa530a">The <code>prot-emacs-completion.el</code> submodule for <code>mct</code> (<code>prot-emacs-mct.el</code>)</a></li>
<li><a href="#h:cff33514-d3ac-4c16-a889-ea39d7346dc5">The <code>prot-emacs-completion.el</code> submodule for <code>vertico</code> (<code>prot-emacs-vertico.el</code>)</a></li>
</ul>

<div class="org-src-container">
<pre class="src src-emacs-lisp">;;; The minibuffer user interface (mct, vertico, or none)
(when prot-emacs-completion-ui
  (require
   (pcase prot-emacs-completion-ui
     ('mct 'prot-emacs-mct)
     ('vertico 'prot-emacs-vertico))))

(provide 'prot-emacs-completion)
</pre>
</div>
</div>
<div id="outline-container-h:e9fb09f0-f2e6-4943-83bf-e5fadcfa530a" class="outline-5">
<h5 id="h:e9fb09f0-f2e6-4943-83bf-e5fadcfa530a"><span class="section-number-5">5.4.15.1.</span> The <code>prot-emacs-completion.el</code> submodule for <code>mct</code> (<code>prot-emacs-mct.el</code>)</h5>
<div class="outline-text-5" id="text-h:e9fb09f0-f2e6-4943-83bf-e5fadcfa530a">
<p>
[ This is subject to a user option: <a href="#h:db620e44-fc8f-45b8-a7fd-ae1d0b7ce86c">The <code>prot-emacs-completion.el</code> setting to load a minibuffer UI submodule</a>. ]
</p>

<p>
The <code>mct</code> package is my set of tweaks on top of the default minibuffer
and <code>*Completions*</code> interface to make them work as part of a
contiguous space. It all starts by providing cycling motions from the
minibuffer to the <code>*Completions*</code> and back, as well as a few extras to
perform the necessary actions. Candidates are updated live to match
the user input.
</p>

<p>
With <code>mct</code> we can specify a passlist of commands or completion
categories that eagerly display the <code>*Completions*</code>. Or we can have a
blocklist to never display that buffer, unless explicitly requested.
Overall, <code>mct</code> is a capable tool with a minimal aesthetic.
</p>

<p>
Newer versions of Emacs keep gaining MCT-like capabilities, so I
expect the out-of-the-box experience to eventually supersede my
package. Until then, I keep it around for those who like it.
</p>

<p>
Note that I normally use <code>vertico</code> in my setup, but configure it to
behave similar to what I have here for <code>mct</code>, meaning that it does not
pop up the minibuffer eagerly (<a href="#h:cff33514-d3ac-4c16-a889-ea39d7346dc5">The <code>prot-emacs-completion.el</code> submodule for <code>vertico</code> (<code>prot-emacs-vertico.el</code>)</a>).
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">;;; Minibuffer and Completions in Tandem or Minibuffer Confines Transcended (mct)
;; Read the manual: &lt;https://protesilaos.com/emacs/mct&gt;.
(use-package mct
  :ensure t
  :hook (after-init . mct-mode)
  :config
  (setq mct-hide-completion-mode-line t)
  (setq mct-completing-read-multiple-indicator t)
  ;; The blocklist and passlist accept either commands/functions or
  ;; completion categories.
  (setq mct-completion-blocklist '(notmuch-mua-new-mail notmuch-mua-prompt-for-sender))
  (setq mct-completion-passlist
        '(;; Some commands
          prot-search-outline
          select-frame-by-name
          Info-goto-node
          Info-index
          Info-menu
          vc-retrieve-tag
          ;; Some completion categories
          consult-buffer
          consult-location
          embark-keybinding
          imenu
          file
          project-file
          buffer
          kill-ring
          consult-location))
  (setq mct-remove-shadowed-file-names t)
  (setq mct-completion-window-size (cons #'mct-frame-height-third 1))
  (setq mct-live-completion 'visible)
  (setq completions-sort #'mct-sort-multi-category)

  ;; Adaptation of `icomplete-fido-backward-updir'.
  (defun prot/mct-backward-updir ()
    "Delete char before point or go up a directory."
    (interactive nil mct-mode)
    (cond
     ((and (eq (char-before) ?/)
           (eq (mct--completion-category) 'file))
      (when (string-equal (minibuffer-contents) "~/")
        (delete-minibuffer-contents)
        (insert (expand-file-name "~/"))
        (goto-char (line-end-position)))
      (save-excursion
        (goto-char (1- (point)))
        (when (search-backward "/" (minibuffer-prompt-end) t)
          (delete-region (1+ (point)) (point-max)))))
     (t (call-interactively 'backward-delete-char))))

  (define-key minibuffer-local-filename-completion-map (kbd "DEL") #'prot/mct-backward-updir))

(provide 'prot-emacs-mct)
</pre>
</div>
</div>
</div>
<div id="outline-container-h:cff33514-d3ac-4c16-a889-ea39d7346dc5" class="outline-5">
<h5 id="h:cff33514-d3ac-4c16-a889-ea39d7346dc5"><span class="section-number-5">5.4.15.2.</span> The <code>prot-emacs-completion.el</code> submodule for <code>vertico</code> (<code>prot-emacs-vertico.el</code>)</h5>
<div class="outline-text-5" id="text-h:cff33514-d3ac-4c16-a889-ea39d7346dc5">
<p>
[ This is subject to a user option: <a href="#h:db620e44-fc8f-45b8-a7fd-ae1d0b7ce86c">The <code>prot-emacs-completion.el</code> setting to load a minibuffer UI submodule</a>. ]
</p>

<p>
The <code>vertico</code> package by Daniel Mendler displays the minibuffer in a
vertical layout. Under the hood, it takes care to be responsive and to
handle even massive completion tables gracefully. Whereas, say, the
built-in completion user interface (and thus <code>mct</code>) will suffer from a
noticeable performance penalty.
</p>

<p>
All we need to get a decent experience with <code>vertico</code> is to enable the
<code>vertico-mode</code>. For most users this is enough. In my case though, I
have to use the &ldquo;multiform&rdquo; mechanism of this package to make it not
show up eagerly. I do this frequently to control what I am displaying
while doing a presentation. As such, the overall experience I get with
<code>vertico</code> is the same as with <code>mct</code>, albeit with better performance
(<a href="#h:e9fb09f0-f2e6-4943-83bf-e5fadcfa530a">The <code>prot-emacs-completion.el</code> submodule for <code>mct</code> (<code>prot-emacs-mct.el</code>)</a>).
</p>

<p>
Beside what I am using it for, the &ldquo;multiform&rdquo; mechanism allows us to
change the layout of <code>vertico</code> on a per-command or per-category basis.
We can, for instance, have a horizontal presentation for some items. I
have tried this for a while, but ultimately decided to go with a more
predictable scheme.
</p>

<p>
The extras I provide for <code>vertico</code> are in <a href="#h:3796a4c9-8659-4782-8aaa-3cf4e950927d">the <code>prot-vertico.el</code> library</a>.
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">;;; Vertical completion layout (vertico)
(use-package vertico
  :ensure t
  :hook (after-init . vertico-mode)
  :config
  (setq vertico-scroll-margin 0)
  (setq vertico-count 5)
  (setq vertico-resize t)
  (setq vertico-cycle t)

  (with-eval-after-load 'rfn-eshadow
    ;; This works with `file-name-shadow-mode' enabled.  When you are in
    ;; a sub-directory and use, say, `find-file' to go to your home '~/'
    ;; or root '/' directory, Vertico will clear the old path to keep
    ;; only your current input.
    (add-hook 'rfn-eshadow-update-overlay-hook #'vertico-directory-tidy)))

;;; Custom tweaks for vertico (prot-vertico.el)
(use-package prot-vertico
  :ensure nil
  :demand t
  :after vertico
  :bind
  ( :map vertico-map
    ("&lt;left&gt;" . backward-char)
    ("&lt;right&gt;" . forward-char)
    ("TAB" . prot-vertico-private-complete)
    ("DEL" . vertico-directory-delete-char)
    ("M-DEL" . vertico-directory-delete-word)
    ("M-," . vertico-quick-insert)
    ("M-." . vertico-quick-exit)
    :map vertico-multiform-map
    ("RET" . prot-vertico-private-exit)
    ("&lt;return&gt;" . prot-vertico-private-exit)
    ("C-n" . prot-vertico-private-next)
    ("&lt;down&gt;" . prot-vertico-private-next)
    ("C-p" . prot-vertico-private-previous)
    ("&lt;up&gt;" . prot-vertico-private-previous)
    ("C-l" . vertico-multiform-vertical))
  :config
  (setq vertico-multiform-commands
        `(("consult-\\(.*\\)?\\(find\\|grep\\|ripgrep\\)" ,@prot-vertico-multiform-maximal)))
  (setq vertico-multiform-categories
        `(;; Maximal
          (embark-keybinding ,@prot-vertico-multiform-maximal)
          (multi-category ,@prot-vertico-multiform-maximal)
          (consult-location ,@prot-vertico-multiform-maximal)
          (imenu ,@prot-vertico-multiform-maximal)
          (unicode-name ,@prot-vertico-multiform-maximal)
          ;; Minimal
          (file ,@prot-vertico-multiform-minimal
                (vertico-sort-function . prot-vertico-sort-directories-first))
          (t ,@prot-vertico-multiform-minimal)))

  (vertico-multiform-mode 1))

(provide 'prot-emacs-vertico)
</pre>
</div>
</div>
</div>
</div>
</div>
<div id="outline-container-h:e0f9c30e-3a98-4479-b709-7008277749e4" class="outline-3">
<h3 id="h:e0f9c30e-3a98-4479-b709-7008277749e4"><span class="section-number-3">5.5.</span> The <code>prot-emacs-search.el</code> module</h3>
<div class="outline-text-3" id="text-h:e0f9c30e-3a98-4479-b709-7008277749e4">
<p>
[ Watch: <a href="https://protesilaos.com/codelog/2023-06-10-emacs-search-replace-basics/">Emacs: basics of search and replace</a> (2023-06-10). ]
</p>

<p>
Emacs provides lots of useful facilities to search the contents of
buffers or files. The most common scenario is to type <code>C-s</code>
(<code>isearch-forward</code>) to perform a search forward from point or <code>C-r</code>
(<code>isearch-backward</code>) to do so in reverse. These commands pack a ton of
functionality and they integrate nicely with related facilities, such
as those of (i) permanently highlighting the thing being searched,
(ii) putting all results in a buffer that is useful for navigation
purposes, among others, and (iii) replacing the given matching items
with another term.
</p>

<p>
Here I summarise the functionality, though do check the video I did on
the basics of search and replace:
</p>

<dl class="org-dl">
<dt><code>C-s</code> (<code>isearch-forward</code>)</dt><dd>Search forward from point (incremental
search); retype <code>C-s</code> to move forth.</dd>

<dt><code>C-r</code> (<code>isearch-backward</code>)</dt><dd>Search backward from point
(incremental); retype <code>C-r</code> to move back. While using either <code>C-s</code>
and <code>C-r</code> you can move in the opposite direction with either of
those keys when performing a repeat.</dd>

<dt><code>C-M-s</code> (<code>isearch-forward-regexp</code>)</dt><dd>Same as <code>C-s</code> but matches a
regular expression. The <code>C-s</code> and <code>C-r</code> motions are the same after
matches are found.</dd>

<dt><code>C-M-r</code> (<code>isearch-backward-regexp</code>)</dt><dd>The counterpart of the above
<code>C-M-s</code> for starting in reverse.</dd>

<dt><code>C-s C-w</code> (<code>isearch-yank-word-or-char</code>)</dt><dd>Search forward for
word-at-point. Again, <code>C-s</code> and <code>C-r</code> move forth and back,
respectively.</dd>

<dt><code>C-r C-w</code> (<code>isearch-yank-word-or-char</code>)</dt><dd>Same as above, but
backward.</dd>

<dt><code>M-s o</code> (<code>occur</code>)</dt><dd>Search for the given regular expression
throughout the buffer and collect the matches in an <code>*occur*</code>
buffer. Also check what I am doing with this in my custom
extensions: <a href="#h:b902e6a3-cdd2-420f-bc99-3d973c37cd20">The <code>prot-emacs-search.el</code> extras provided by the <code>prot-search.el</code> library</a>.</dd>

<dt><code>C-u 5 M-s o</code> (<code>occur</code>)</dt><dd>Like the above, but give it N lines of
context when N is the prefix numeric argument  (5 in
this example).</dd>

<dt><code>C-s SEARCH</code> followed by <code>M-s o</code>  (<code>isearch-forward</code> &#x2013;&gt; <code>occur</code>)</dt><dd>Like <code>C-s</code> but then put the matches in an <b>occur</b> buffer.</dd>

<dt>(no term)</dt><dd><code>C-s SEARCH</code> followed by <code>C-u 5 M-s o</code> (<code>isearch-forward</code> &#x2013;&gt;
<code>occur</code>) :: Same as above, but now with N lines of context (5 in
this example).</dd>

<dt><code>M-%</code> (<code>query-replace</code>)</dt><dd>Prompt for target to replace and then
prompt for its replacement (see explanation)</dd>

<dt><code>C-M-%</code> (<code>query-replace-regexp</code>)</dt><dd>Same as above, but for REGEXP</dd>

<dt><code>C-s SEARCH</code> followed by <code>M-%</code> (<code>isearch-forward</code> &#x2013;&gt; <code>query-replace</code>)</dt><dd>Search
with <code>C-s</code> and then perform a query-replace for the following
matches.</dd>

<dt>(no term)</dt><dd><code>C-M-s SEARCH M-%</code> (<code>isearch-forward-regexp</code> &#x2013;&gt;
<code>query-replace-regexp</code>) :: As above, but regexp-aware.</dd>

<dt><code>C-s SEARCH C-M-%</code> (<code>isearch-forward</code> &#x2013;&gt; <code>query-replace-regexp</code>)</dt><dd>Same
as above.</dd>

<dt><code>M-s h r</code> (<code>highlight-regexp</code>)</dt><dd>Prompt for a face (like
<code>hi-yellow</code>) to highlight the given regular expression.</dd>

<dt><code>M-s h u</code> (<code>unhighlight-regexp</code>)</dt><dd>Prompt for an already
highlighted regular expression to unhighlight (do it after the
above).</dd>
</dl>

<p>
For starters, just learn:
</p>

<ul class="org-ul">
<li><code>C-s</code></li>
<li><code>C-r</code></li>
<li><code>M-s o</code></li>
<li><code>M-%</code></li>
</ul>

<p>
Now on to the configurations.
</p>
</div>
<div id="outline-container-h:95947b37-2071-4ee7-a201-8e19bf3322e9" class="outline-4">
<h4 id="h:95947b37-2071-4ee7-a201-8e19bf3322e9"><span class="section-number-4">5.5.1.</span> The <code>prot-emacs-search.el</code> on isearch lax space</h4>
<div class="outline-text-4" id="text-h:95947b37-2071-4ee7-a201-8e19bf3322e9">
<p>
As noted in the introduction to this module, the built-in Isearch
mechanism is at the centre of lots of useful patterns of interaction
(<a href="#h:e0f9c30e-3a98-4479-b709-7008277749e4">The <code>prot-emacs-search.el</code> module</a>).
</p>

<p>
The first thing I want to do for Isearch, is make it more convenient
for me to match words that occur in sequence but are not necessarily
following each other. By default, we can do that with something like
<code>C-M-s</code> (<code>isearch-forward-regexp</code>) followed by <code>one.*two</code>. Though it
is inconvenient to be a regexp-aware search mode when all we want is
to just type <code>one two</code> and have the space be interpreted as
&ldquo;intermediate characters&rdquo; rather than a literal space. The following
do exactly this for regular <code>C-s</code> (<code>isearch-forward</code>) and <code>C-r</code>
(<code>isearch-backward</code>).
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">;;; Isearch, occur, grep, and extras (prot-search.el)
(use-package isearch
  :ensure nil
  :demand t
  :config
  (setq search-whitespace-regexp ".*?" ; one `setq' here to make it obvious they are a bundle
        isearch-lax-whitespace t
        isearch-regexp-lax-whitespace nil))
</pre>
</div>
</div>
</div>
<div id="outline-container-h:ed1307e7-f8a0-4b0a-8d91-2de9c1e2479c" class="outline-4">
<h4 id="h:ed1307e7-f8a0-4b0a-8d91-2de9c1e2479c"><span class="section-number-4">5.5.2.</span> The <code>prot-emacs-search.el</code> settings for isearch highlighting</h4>
<div class="outline-text-4" id="text-h:ed1307e7-f8a0-4b0a-8d91-2de9c1e2479c">
<p>
Here I am just tweaking the delay that affects when deferred
highlights are applied. The current match is highlighted immediately.
The rest are done after <code>lazy-highlight-initial-delay</code> unless they are
longer in character count than <code>lazy-highlight-no-delay-length</code>.
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(use-package isearch
  :ensure nil
  :demand t
  :config
  (setq search-highlight t)
  (setq isearch-lazy-highlight t)
  (setq lazy-highlight-initial-delay 0.5)
  (setq lazy-highlight-no-delay-length 4))
</pre>
</div>
</div>
</div>
<div id="outline-container-h:acfdc17f-7ffb-48d3-90ff-49bd00463934" class="outline-4">
<h4 id="h:acfdc17f-7ffb-48d3-90ff-49bd00463934"><span class="section-number-4">5.5.3.</span> The <code>prot-emacs-search.el</code> on isearch match counter</h4>
<div class="outline-text-4" id="text-h:acfdc17f-7ffb-48d3-90ff-49bd00463934">
<p>
I think the following options should be enabled by default. They
produce a counter next to the isearch prompt that shows the position
of the current match relative to the total count (like <code>5/20</code>). As we
move to the next/previous match, the counter is updated accordingly.
We have the option to place this information after the search terms,
though I prefer to have them as a prefix so as not to interfere with
what I am typing.
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(use-package isearch
  :ensure nil
  :demand t
  :config
  (setq isearch-lazy-count t)
  (setq lazy-count-prefix-format "(%s/%s) ")
  (setq lazy-count-suffix-format nil))
</pre>
</div>
</div>
</div>
<div id="outline-container-h:e6fd4ff0-86c7-423b-9cf3-0a9061505136" class="outline-4">
<h4 id="h:e6fd4ff0-86c7-423b-9cf3-0a9061505136"><span class="section-number-4">5.5.4.</span> The <code>prot-emacs-search.el</code> tweaks to the isearch motion behaviour</h4>
<div class="outline-text-4" id="text-h:e6fd4ff0-86c7-423b-9cf3-0a9061505136">
<p>
With the default settings, when we are repeating an isearch in the
opposite direction, Emacs does not move directly to the next/previous
match. Instead, it places the cursor at the opposite end of the
current match. So, if we start with <code>C-s</code> and search for <code>word</code> we now
see <code>word|</code> where the bar represents the cursor. With <code>C-r</code> we now
have <code>|word</code> on the same match we were on. I do not like this
behaviour so I configure <code>isearch-repeat-on-direction-change</code>
accordingly. Furthermore, I can always control where the cursor is
left after exiting the search either by performing the given motion
(e.g. <code>M-f</code> (<code>forward-word</code>)) or by using my custom command to exit on
the opposite end with <code>C-RET</code> while in an isearch (<code>prot-search-isearch-other-end</code>).
</p>

<p>
[ See: <a href="#h:b902e6a3-cdd2-420f-bc99-3d973c37cd20">The <code>prot-emacs-search.el</code> extras provided by the <code>prot-search.el</code> library</a>. ]
</p>

<p>
If you are using keyboard macros that rely on isearch, DO NOT set
<code>isearch-wrap-pause</code> to the <code>no-ding</code> value. That disables the error
isearch produces when it reaches the end of the matches. This error
exits the keyboard macro, which is exactly what you want if you are
calling it with a <code>0</code> numeric argument (to run from point until the
end of the buffer).
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(use-package isearch
  :ensure nil
  :demand t
  :config
  (setq isearch-wrap-pause t) ; `no-ding' makes keyboard macros never quit
  (setq isearch-repeat-on-direction-change t))
</pre>
</div>
</div>
</div>
<div id="outline-container-h:85aca4da-b89b-4fbe-89e9-3ec536ad7b0d" class="outline-4">
<h4 id="h:85aca4da-b89b-4fbe-89e9-3ec536ad7b0d"><span class="section-number-4">5.5.5.</span> The <code>prot-emacs-search.el</code> tweaks for the occur buffer</h4>
<div class="outline-text-4" id="text-h:85aca4da-b89b-4fbe-89e9-3ec536ad7b0d">
<p>
Here I am making some minor tweaks to <code>*occur*</code> buffer (remember to
read the introduction to this section (<a href="#h:e0f9c30e-3a98-4479-b709-7008277749e4">The <code>prot-emacs-search.el</code> module</a>)).
I always want (i) the cursor to be at the top of the buffer, (ii) the
current line to be highlighted, as it is easier for selection
purposes, and (iii) for long lines to be truncated, meaning to stretch
beyond the visible portion of the window without wrapping below, and
for this to be done silently without messaging me about it.
</p>

<p>
The latter depends on my <code>prot-common.el</code> library, which is loaded
early at startup (<a href="#h:713ede33-3802-40c6-a8e3-7e1fc0d0a924">The <code>prot-emacs-essentials.el</code> block that loads my custom libraries</a>).
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(use-package isearch
  :ensure nil
  :demand t
  :config
  (setq list-matching-lines-jump-to-current-line nil) ; do not jump to current line in `*occur*' buffers
  (add-hook 'occur-mode-hook #'prot-common-truncate-lines-silently) ; from `prot-common.el'
  (add-hook 'occur-mode-hook #'hl-line-mode))
</pre>
</div>
</div>
</div>
<div id="outline-container-h:5ce6216d-f318-4191-9d4f-9681c92f7582" class="outline-4">
<h4 id="h:5ce6216d-f318-4191-9d4f-9681c92f7582"><span class="section-number-4">5.5.6.</span> The <code>prot-emacs-search.el</code> modified isearch and occur key bindings</h4>
<div class="outline-text-4" id="text-h:5ce6216d-f318-4191-9d4f-9681c92f7582">
<p>
These are some minor tweaks to the key maps for isearch and occur. I
don&rsquo;t feel strongly about the rest, but the change to <code>C-g</code> is
important for me as I want to exit the search altogether, not resume
the search of the previous succesful match.
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(use-package isearch
  :ensure nil
  :demand t
  :bind
  ( :map minibuffer-local-isearch-map
    ("M-/" . isearch-complete-edit)
    :map occur-mode-map
    ("t" . toggle-truncate-lines)
    :map isearch-mode-map
    ("C-g" . isearch-cancel) ; instead of `isearch-abort'
    ("M-/" . isearch-complete)))
</pre>
</div>
</div>
</div>
<div id="outline-container-h:b902e6a3-cdd2-420f-bc99-3d973c37cd20" class="outline-4">
<h4 id="h:b902e6a3-cdd2-420f-bc99-3d973c37cd20"><span class="section-number-4">5.5.7.</span> The <code>prot-emacs-search.el</code> extras provided by the <code>prot-search.el</code> library</h4>
<div class="outline-text-4" id="text-h:b902e6a3-cdd2-420f-bc99-3d973c37cd20">
<p>
My <code>prot-search.el</code> provides lots of useful extras that I use on a
regular basis (<a href="#h:0cab525d-fcbc-478c-b914-bbd69e33c635">The <code>prot-search.el</code> library</a>).
</p>

<p>
For isearch, I have:
</p>

<ul class="org-ul">
<li>Move to next/previous match in isearch with the down/up arrow keys
(<code>C-s</code> or <code>C-r</code> still work though).</li>

<li>Place the cursor on the opposite end of an isearch when exiting. Do
it with <code>C-RET</code> while in isearch (<a href="#h:e6fd4ff0-86c7-423b-9cf3-0a9061505136">The <code>prot-emacs-search.el</code> tweaks to the isearch motion behaviour</a>).</li>

<li>Delete the non-matching portion of a query in isearch with a single
backspace instead of doing it character-by-character.</li>

<li>Type <code>M-s M-&lt;</code> (<code>prot-search-isearch-beginning-of-buffer</code>) or <code>M-s
  M-&gt;</code> (<code>prot-search-isearch-end-of-buffer</code>) to search for the symbol
at point starting from the beginning/end of the buffer.</li>
</ul>

<p>
For variants of <code>occur</code> or <code>grep</code>, which also benefit from the rules I have on
where windows/buffers are displayed (<a href="#h:50f8b1e4-b14e-453f-a37e-1c0e495ab80f">The <code>prot-emacs-window.el</code> rules for displaying buffers (<code>display-buffer-alist</code>)</a>):
</p>

<ul class="org-ul">
<li>Type <code>M-s s</code> (<code>prot-search-outline</code>) to use minibuffer completion
to match an entry across the buffer&rsquo;s outline. This is probably my
most used command. What I like about it is that it benefits from the
extensive customisations I make to the completion mechanism and the
minibuffer user interface (<a href="#h:15edf2c3-4419-4101-928a-6e224958a741">The <code>prot-emacs-completion.el</code> module</a>).
Concretely, I can benefit from the visualisation produced by the
<code>vertico</code> or <code>mct</code> packages and match the heading with an
out-of-order pattern using <code>orderless</code>. Simple and super effective!
Note that the <code>consult</code> package provides the <code>consult-outline</code>
command, which was the basis for my variant. Unlike mine, it shows a
preview of the current match. I find previews disorienting when I
type quickly and do not want to experience any motion sickness while
using Emacs (this is not the fault of <code>consult</code>, just me needing to
have a more static interface). Though there are times I am slowing
down the search and need the preview, at which point I call the
Consult command on <code>M-s M-s</code> (<a href="#h:22e97b4c-d88d-4deb-9ab3-f80631f9ff1d">The <code>prot-emacs-completion.el</code> settings for <code>consult</code></a>).</li>

<li>Type <code>M-s M-o</code> (<code>prot-search-occur-outline</code>) to produce an outline
of the given buffer. What constitutes an outline is defined in the
user option <code>prot-search-outline-regexp-alist</code>. I only configure it
for the major modes I care about, though the mechanism should work
for every buffer that has an outline.</li>

<li>Type <code>M-s M-t</code> (<code>prot-search-grep-todo-keywords</code>) to produce an
<code>*occur*</code> buffer that matches keywords like <code>TODO</code>. The full regular
expression is specified in the user option <code>prot-search-todo-keywords</code>.</li>

<li>Type <code>C-u M-s M-t</code> or <code>M-s M-T</code> (<code>prot-search-git-grep-todo-keywords</code>)
to do the same as above but with the <code>git-grep</code> program instead of
Emacs&rsquo; <code>occur</code>. This will match the keywords throughout the current
Git repository. Grep buffers are editable, like those of <code>occur</code>
(<a href="#h:9a3581df-ab18-4266-815e-2edd7f7e4852">The <code>prot-emacs-search.el</code> setup for editable grep buffers (<code>wgrep</code>)</a>).</li>

<li>Type <code>M-s g</code> (<code>prot-search-grep</code>) to perform a &ldquo;local grep&rdquo; across
the current directory. Do <code>C-u M-s g</code> to perform a &ldquo;recursive grep&rdquo;
from the current directory and into all subdirectories. This is
basically a streamlined version of <code>M-x lgrep</code> and <code>M-x rgrep</code> and
is one of my favourite commands.</li>
</ul>

<p>
Note that the <code>consult</code> package provides lots of useful commands that
perform a search while also displaying a preview of what you are
matching (<a href="#h:22e97b4c-d88d-4deb-9ab3-f80631f9ff1d">The <code>prot-emacs-completion.el</code> settings for <code>consult</code></a>).
Depending on your workflow, this is better, though I seldom need the
preview as I know what to expect or otherwise peruse contents either
by visiting individual files or by using a grep buffer as an index.
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(use-package prot-search
  :ensure nil
  :bind
  ( :map global-map
    ("M-s M-%" . prot-search-replace-markup) ; see `prot-search-markup-replacements'
    ("M-s M-&lt;" . prot-search-isearch-beginning-of-buffer)
    ("M-s M-&gt;" . prot-search-isearch-end-of-buffer)
    ("M-s g" . prot-search-grep)
    ("M-s u" . prot-search-occur-urls)
    ("M-s t" . prot-search-occur-todo-keywords)
    ("M-s M-t" . prot-search-grep-todo-keywords) ; With C-u it runs `prot-search-git-grep-todo-keywords'
    ("M-s M-T" . prot-search-git-grep-todo-keywords)
    ("M-s s" . prot-search-outline)
    ("M-s M-o" . prot-search-occur-outline)
    ("M-s M-u" . prot-search-occur-browse-url)
    :map isearch-mode-map
    ("&lt;up&gt;" . prot-search-isearch-repeat-backward)
    ("&lt;down&gt;" . prot-search-isearch-repeat-forward)
    ("&lt;backspace&gt;" . prot-search-isearch-abort-dwim)
    ("&lt;C-return&gt;" . prot-search-isearch-other-end))
  :config
  (setq prot-search-outline-regexp-alist
        '((emacs-lisp-mode . "^\\((\\|;;;+ \\)")
          (org-mode . "^\\(\\*+ +\\|#\\+[Tt][Ii][Tt][Ll][Ee]:\\)")
          (outline-mode . "^\\*+ +")
          (emacs-news-view-mode . "^\\*+ +")
          (conf-toml-mode . "^\\[")
          (markdown-mode . "^#+ +")))
  (setq prot-search-todo-keywords
        (concat "TODO\\|FIXME\\|NOTE\\|REVIEW\\|XXX\\|KLUDGE"
                "\\|HACK\\|WARN\\|WARNING\\|DEPRECATED\\|BUG"))

  (with-eval-after-load 'pulsar
    (add-hook 'prot-search-outline-hook #'pulsar-recenter-center)
    (add-hook 'prot-search-outline-hook #'pulsar-reveal-entry)))
</pre>
</div>
</div>
</div>
<div id="outline-container-h:ceb286c5-a5f7-4cc8-b883-89d20a75ea02" class="outline-4">
<h4 id="h:ceb286c5-a5f7-4cc8-b883-89d20a75ea02"><span class="section-number-4">5.5.8.</span> The <code>prot-emacs-search.el</code> tweaks to <code>xref</code>, <code>re-builder</code> and <code>grep</code></h4>
<div class="outline-text-4" id="text-h:ceb286c5-a5f7-4cc8-b883-89d20a75ea02">
<p>
The <code>xref.el</code> provides the infrastructure to jump to and from a
definition. For example, with point over a function call,
<code>xref-find-definitions</code> will jump to the file and location where the
function is defined or provide an option to pick one among multiple
definitions, where applicable. The <code>grep.el</code> is a wrapper for the Unix
program of the same name. Not much to add there. While <code>re-builder.el</code>
defines a command that lets us write a regexp that matches against the
current buffer, allowing us to test it live.
</p>

<p>
Note the use of the <code>let</code> to decide whether I use the <code>grep</code> or <code>rg</code>
(<code>ripgrep</code>) program: this covers Xref as well.
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">;;; grep and xref
(use-package re-builder
  :ensure nil
  :commands (re-builder regexp-builder)
  :config
  (setq reb-re-syntax 'read))

(use-package xref
  :ensure nil
  :commands (xref-find-definitions xref-go-back)
  :config
  ;; All those have been changed for Emacs 28
  (setq xref-show-definitions-function #'xref-show-definitions-completing-read) ; for M-.
  (setq xref-show-xrefs-function #'xref-show-definitions-buffer) ; for grep and the like
  (setq xref-file-name-display 'project-relative))

(use-package grep
  :ensure nil
  :commands (grep lgrep rgrep)
  :config
  (setq grep-save-buffers nil)
  (setq grep-use-headings t) ; Emacs 30

  (let ((executable (or (executable-find "rg") "grep"))
        (rgp (string-match-p "rg" grep-program)))
    (setq grep-program executable)
    (setq grep-template
          (if rgp
              "/usr/bin/rg -nH --null -e &lt;R&gt; &lt;F&gt;"
            "/usr/bin/grep &lt;X&gt; &lt;C&gt; -nH --null -e &lt;R&gt; &lt;F&gt;"))
    (setq xref-search-program (if rgp 'ripgrep 'grep))))
</pre>
</div>
</div>
</div>
<div id="outline-container-h:9a3581df-ab18-4266-815e-2edd7f7e4852" class="outline-4">
<h4 id="h:9a3581df-ab18-4266-815e-2edd7f7e4852"><span class="section-number-4">5.5.9.</span> The <code>prot-emacs-search.el</code> setup for editable grep buffers (<code>grep-edit-mode</code> or <code>wgrep</code>)</h4>
<div class="outline-text-4" id="text-h:9a3581df-ab18-4266-815e-2edd7f7e4852">
<p>
Starting with Emacs 31, buffers using <code>grep-mode</code> can now be edited
directly. The idea is to collect the results of a search in one place
and quickly apply a change across all or some of them. We have the
same concept with occur (<code>M-x occur</code>) as well as with Dired buffers
(<a href="#h:1b53bc10-8b1b-4f68-bbec-165909761e43">The <code>prot-emacs-dired.el</code> section about <code>wdired</code> (writable Dired)</a>).
I use this in tandem with my <code>prot-search-grep</code> command.
</p>

<p>
For older versions of Emacs, we have the <code>wgrep</code> package by Masahiro
Hayashi. I configure it to have key bindings like those of the <code>occur</code>
edit mode, which <code>grep-edit-mode</code> also uses.
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">;;; wgrep (writable grep)
;; See the `grep-edit-mode' for the new built-in feature.
(unless (&gt;= emacs-major-version 31)
  (use-package wgrep
    :ensure t
    :after grep
    :bind
    ( :map grep-mode-map
      ("e" . wgrep-change-to-wgrep-mode)
      ("C-x C-q" . wgrep-change-to-wgrep-mode)
      ("C-c C-c" . wgrep-finish-edit))
    :config
    (setq wgrep-auto-save-buffer t)
    (setq wgrep-change-readonly-file t)))
</pre>
</div>
</div>
</div>
<div id="outline-container-h:c8b2f021-fe5a-4f6b-944c-20340f764fb2" class="outline-4">
<h4 id="h:c8b2f021-fe5a-4f6b-944c-20340f764fb2"><span class="section-number-4">5.5.10.</span> The <code>prot-emacs-search.el</code> call to <code>provide</code></h4>
<div class="outline-text-4" id="text-h:c8b2f021-fe5a-4f6b-944c-20340f764fb2">
<p>
Finally, we <code>provide</code> the module. This is the mirror function of
<code>require</code> (<a href="#h:e6c4acf5-5b51-4b38-a86a-bf3f698ac872">The init.el final part to load the individual modules</a>).
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(provide 'prot-emacs-search)
</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-h:f8b08a77-f3a8-42fa-b1a9-f940348889c3" class="outline-3">
<h3 id="h:f8b08a77-f3a8-42fa-b1a9-f940348889c3"><span class="section-number-3">5.6.</span> The <code>prot-emacs-dired.el</code> module</h3>
<div class="outline-text-3" id="text-h:f8b08a77-f3a8-42fa-b1a9-f940348889c3">
<p>
[ Watch: <a href="https://protesilaos.com/codelog/2023-06-26-emacs-file-dired-basics/">https://protesilaos.com/codelog/2023-06-26-emacs-file-dired-basics/</a> (2023-06-26) ]
</p>

<p>
Dired is probably my favourite Emacs tool. It exemplifies how I see
Emacs as a whole: a layer of interactivity on top of Unix. The <code>dired</code>
interface wraps&#x2014;and puts to synergy&#x2014;standard commands like <code>ls</code>,
<code>cp</code>, <code>mv</code>, <code>rm</code>, <code>mkdir</code>, <code>chmod</code>, and related. All while granting
access to many other conveniences, such as (i) marking files to
operate on (individually, with a regexp, etc.), (ii) bulk renaming
files by making the buffer writable and editing it like a regular
file, (iii) showing only files you want, (iv) listing the contents of
any subdirectory, such as to benefit from the bulk-renaming
capability, (v) running a keyboard macro that edits file contents
while using Dired to navigate the file listing, (vi) open files in an
external application, and more.
</p>

<p>
Dired lets us work with our files in a way that still feels close to
the command-line, yet has more powerful interactive features than even
fully fledged, graphical file managers.
</p>
</div>
<div id="outline-container-h:39fb0eab-54bb-4e5b-8e38-9443dbe5c5ee" class="outline-4">
<h4 id="h:39fb0eab-54bb-4e5b-8e38-9443dbe5c5ee"><span class="section-number-4">5.6.1.</span> The <code>prot-emacs-dired.el</code> settings for common operations</h4>
<div class="outline-text-4" id="text-h:39fb0eab-54bb-4e5b-8e38-9443dbe5c5ee">
<p>
I add two settings which make all copy, rename/move, and delete
operations more intuitive. I always want to perform those actions in a
recursive manner, as this is the intent I have when I am targeting
directories.
</p>

<p>
The <code>delete-by-moving-to-trash</code> is a deviation from the behaviour of
the <code>rm</code> program, as it sends the file into the virtual trash folder.
Depending on the system, files in the trash are either removed
automatically after a few days, or we still have to permanently delete
them manually. I prefer this extra layer of safety. Plus, we have the
<code>trashed</code> package to navigate the trash folder in a Dired-like way
(<a href="#h:2e005bd1-d098-426d-91f9-2a31a6e55caa">The <code>prot-emacs-dired.el</code> section about <code>trashed.el</code></a>).
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">;;; Dired file manager and prot-dired.el extras
(use-package dired
  :ensure nil
  :commands (dired)
  :config
  (setq dired-recursive-copies 'always)
  (setq dired-recursive-deletes 'always)
  (setq delete-by-moving-to-trash t))
</pre>
</div>
</div>
</div>
<div id="outline-container-h:679e4460-b306-450f-aa20-497243057e02" class="outline-4">
<h4 id="h:679e4460-b306-450f-aa20-497243057e02"><span class="section-number-4">5.6.2.</span> The <code>prot-emacs-dired.el</code> switches for <code>ls</code> (how files are listed)</h4>
<div class="outline-text-4" id="text-h:679e4460-b306-450f-aa20-497243057e02">
<p>
As I already explained, Dired is a layer of interactivity on top of
standard Unix tools (<a href="#h:f8b08a77-f3a8-42fa-b1a9-f940348889c3">The <code>prot-emacs-dired.el</code> module</a>). We can see
this in how Dired produces the file listing and how we can affect it.
The <code>ls</code> program accepts an <code>-l</code> flag for a &ldquo;long&rdquo;, detailed list of
files. This is what Dired uses. But we can pass more flags by setting
the value of <code>dired-listing-switches</code>. Do <code>M-x man</code> and then search
for the <code>ls</code> manpage to learn about what I have here. In short:
</p>

<dl class="org-dl">
<dt><code>-A</code></dt><dd>Show hidden files (&ldquo;dotfiles&rdquo;), such as <code>.bashrc</code>, but omit
the implied <code>.</code> and <code>..</code> targets. The latter two refer to the
present and parent directory, respectively.</dd>

<dt><code>-G</code></dt><dd>Do not show the group name in the long listing. Only show
the owner of the file.</dd>

<dt><code>-F</code></dt><dd>Differentiate regular from special files by appending a
character to them. The <code>*</code> is for executables, the <code>/</code> is for
directories, the <code>|</code> is for a named pipe, the <code>=</code> is for a socket,
the <code>@</code> and the <code>&gt;</code> are for stuff I have never seen.</dd>

<dt><code>-h</code></dt><dd>Make file sizes easier to read, such as <code>555k</code> instead of
<code>568024</code> (the size of <code>prot-emacs.org</code> as of this writing).</dd>

<dt><code>-l</code></dt><dd>Produce a long, detailed listing. Dired requires this.</dd>

<dt><code>-v</code></dt><dd>Sort files by version numbers, such that <code>file1</code>, <code>file2</code>,
and <code>file10</code> appear in this order instead of 1, 10, 2. The latter is
called &ldquo;lexicograhic&rdquo; and I have not found a single case where it is
useful to me.</dd>

<dt><code>--group-directories-first</code></dt><dd>Does what it says to place all
directories before files in the listing. I prefer this over a strict
sorting that does not differentiate between files and directories.</dd>

<dt><code>--time-style=long-iso</code></dt><dd>Uses the international standard for time
representation in the file listing. So we have something like
<code>2023-12-30 06:38</code> to show the last modified time.</dd>
</dl>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(use-package dired
  :ensure nil
  :commands (dired)
  :config
  (setq dired-listing-switches
        "-AGFhlv --group-directories-first --time-style=long-iso"))
</pre>
</div>
</div>
</div>
<div id="outline-container-h:8225364c-3856-48bc-bf64-60d40ddd3320" class="outline-4">
<h4 id="h:8225364c-3856-48bc-bf64-60d40ddd3320"><span class="section-number-4">5.6.3.</span> The <code>prot-emacs-dired.el</code> setting for dual-pane Dired</h4>
<div class="outline-text-4" id="text-h:8225364c-3856-48bc-bf64-60d40ddd3320">
<p>
I often have two Dired buffers open side-by-side and want to move
files between them. By setting <code>dired-dwim-target</code> to a <code>t</code> value,
we get the other buffer as the default target of the current rename or
copy operation. This is exactly what I want.
</p>

<p>
If there are more than two windows showing Dired buffers, the default
target is the previously visited window.
</p>

<p>
Note that this only affects how quickly we can access the default
value, as we can always type <code>M-p</code> (<code>previous-history-element</code>) and
<code>M-n</code> (<code>next-history-element</code>) to cycle through the minibuffer
history (<a href="#h:25765797-27a5-431e-8aa4-cc890a6a913a">The <code>prot-emacs-completion.el</code> settings for saving the history (<code>savehist-mode</code>)</a>).
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(use-package dired
  :ensure nil
  :commands (dired)
  :config
  (setq dired-dwim-target t))
</pre>
</div>
</div>
</div>
<div id="outline-container-h:d7d5e619-3d50-4d9e-a951-7262462a60c9" class="outline-4">
<h4 id="h:d7d5e619-3d50-4d9e-a951-7262462a60c9"><span class="section-number-4">5.6.4.</span> The <code>prot-emacs-dired.el</code> settings to open files externally</h4>
<div class="outline-text-4" id="text-h:d7d5e619-3d50-4d9e-a951-7262462a60c9">
<p>
From inside a Dired buffer, we can type <code>!</code> (<code>M-x dired-do-shell-command</code>)
or <code>&amp;</code> (<code>M-x dired-do-async-shell-command</code>) to run an arbitrary
command with the given file (or marked files) as an argument. These
commands will produce a minibuffer prompt, which expects us to type in
the name of the command. Emacs already tries to guess some relevant
defaults, though we can make it do what we want by configuring the
<code>dired-guess-shell-alist-user</code> user option.
</p>

<p>
This variable takes an alist value: a list of lists. Each element
(each list) has the first item in the list as a regular expression to
match file names. We normally want to have file type extensions here,
though we can also target the full name of a file. The remaining
entries in the list are strings that specify the name of the external
program to use. We can have as many as we want and cycle between them
using the familiar <code>M-p</code> and <code>M-n</code> keys inside the minibuffer (which
call the commands <code>previous-history-element</code> and <code>next-history-element</code>,
respectively).
</p>

<p>
On Linux, the generic &ldquo;open with default app&rdquo; call is <code>xdg-open</code>, so
we always want that as a fallback.
</p>

<p>
Note that Emacs 30 (current development target as of this writing on
2023-12-30 16:12 +0200), we have the command <code>dired-do-open</code>, which is
the equivalent of typing <code>&amp;</code> and then specifying the <code>xdg-open</code> command.
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(use-package dired
  :ensure nil
  :commands (dired)
  :config
  (setq dired-guess-shell-alist-user ; those are the suggestions for ! and &amp; in Dired
        '(("\\.\\(png\\|jpe?g\\|tiff\\)" "feh" "xdg-open")
          ("\\.\\(mp[34]\\|m4a\\|ogg\\|flac\\|webm\\|mkv\\)" "mpv" "xdg-open")
          (".*" "xdg-open"))))
</pre>
</div>
</div>
</div>
<div id="outline-container-h:6327e6ba-a468-416f-ad26-b530c32fe235" class="outline-4">
<h4 id="h:6327e6ba-a468-416f-ad26-b530c32fe235"><span class="section-number-4">5.6.5.</span> The <code>prot-emacs-dired.el</code> miscellaneous tweaks</h4>
<div class="outline-text-4" id="text-h:6327e6ba-a468-416f-ad26-b530c32fe235">
<p>
These are some minor tweaks that I do not really care about. The only
one which is really nice in my opinion is the hook that involves the
<code>dired-hide-details-mode</code>. This is the command that hides the noisy
output of the <code>ls</code> <code>-l</code> flag, leaving only the file names in the list
(<a href="#h:679e4460-b306-450f-aa20-497243057e02">The <code>prot-emacs-dired.el</code> switches for <code>ls</code> (how files are listed)</a>).
We can toggle this effect at any time with the <code>(</code> key, by default.
</p>

<p>
I disable the repetition of the <code>j</code> key as I do use <code>repeat-mode</code>
(<a href="#h:fbe6f9da-25ee-46a3-bb03-8fa7c1d48dab">The <code>prot-emacs-essentials.el</code> settings for <code>repeat-mode</code></a>).
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(use-package dired
  :ensure nil
  :commands (dired)
  :config
  (setq dired-auto-revert-buffer #'dired-directory-changed-p) ; also see `dired-do-revert-buffer'
  (setq dired-make-directory-clickable t) ; Emacs 29.1
  (setq dired-free-space nil) ; Emacs 29.1
  (setq dired-mouse-drag-files t) ; Emacs 29.1

  (add-hook 'dired-mode-hook #'dired-hide-details-mode)
  (add-hook 'dired-mode-hook #'hl-line-mode)

  ;; In Emacs 29 there is a binding for `repeat-mode' which lets you
  ;; repeat C-x C-j just by following it up with j.  For me, this is a
  ;; problem as j calls `dired-goto-file', which I often use.
  (define-key dired-jump-map (kbd "j") nil))
</pre>
</div>
</div>
</div>
<div id="outline-container-h:6758bf16-e47e-452e-b39d-9d67c2b9aa4b" class="outline-4">
<h4 id="h:6758bf16-e47e-452e-b39d-9d67c2b9aa4b"><span class="section-number-4">5.6.6.</span> The <code>prot-emacs-dired.el</code> section about various conveniences</h4>
<div class="outline-text-4" id="text-h:6758bf16-e47e-452e-b39d-9d67c2b9aa4b">
<p>
The <code>dired-aux.el</code> and <code>dired-x.el</code> are two built-in libraries that
provide useful extras for Dired. The highlights from what I have here
are:
</p>

<ul class="org-ul">
<li>the user option <code>dired-create-destination-dirs</code> and
<code>dired-create-destination-dirs-on-trailing-dirsep</code>, which offer to
create the specified directory path if it is missing.</li>

<li>the user options <code>dired-clean-up-buffers-too</code> and
<code>dired-clean-confirm-killing-deleted-buffers</code> which cover the
deletion of buffers related to files that we delete from Dired.</li>

<li>the key binding for <code>dired-do-open</code>, which opens the file or
directory externally (<a href="#h:d7d5e619-3d50-4d9e-a951-7262462a60c9">The <code>prot-emacs-dired.el</code> settings to open files externally</a>).</li>
</ul>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(use-package dired-aux
  :ensure nil
  :after dired
  :bind
  ( :map dired-mode-map
    ("C-+" . dired-create-empty-file)
    ("M-s f" . nil)
    ("C-&lt;return&gt;" . dired-do-open) ; Emacs 30
    ("C-x v v" . dired-vc-next-action)) ; Emacs 28
  :config
  (setq dired-isearch-filenames 'dwim)
  (setq dired-create-destination-dirs 'ask) ; Emacs 27
  (setq dired-vc-rename-file t)             ; Emacs 27
  (setq dired-do-revert-buffer (lambda (dir) (not (file-remote-p dir)))) ; Emacs 28
  (setq dired-create-destination-dirs-on-trailing-dirsep t)) ; Emacs 29

(use-package dired-x
  :ensure nil
  :after dired
  :bind
  ( :map dired-mode-map
    ("I" . dired-info))
  :config
  (setq dired-clean-up-buffers-too t)
  (setq dired-clean-confirm-killing-deleted-buffers t)
  (setq dired-x-hands-off-my-keys t)    ; easier to show the keys I use
  (setq dired-bind-man nil)
  (setq dired-bind-info nil))
</pre>
</div>
</div>
</div>
<div id="outline-container-h:933b156a-3be2-4025-96e9-e14687c8dcf1" class="outline-4">
<h4 id="h:933b156a-3be2-4025-96e9-e14687c8dcf1"><span class="section-number-4">5.6.7.</span> The <code>prot-emacs-dired.el</code> section about my extras (<code>prot-dired.el</code>)</h4>
<div class="outline-text-4" id="text-h:933b156a-3be2-4025-96e9-e14687c8dcf1">
<p>
Dired is excellent out-of-the-box. What I provide are a few minor
commands that make it more convenient for me to perform common
actions (<a href="#h:92cfefcf-8c20-43cd-b47c-ffe0c5fe1887">The <code>prot-dired.el</code> library</a>). Chief among them is the
<code>prot-dired-limit-regexp</code> (bound to <code>C-c C-l</code>), which is an easier way
to do this in standard Dired:
</p>

<ul class="org-ul">
<li>Type <code>% m</code> (<code>dired-mark-files-regexp</code>) to mark files you want to
keep seeing. Provide a regular expression or simply a common word.</li>
<li>Toggle the mark so that you now cover everything you do not want to
see.</li>
<li>Invoke <code>dired-do-kill-lines</code> (bound to <code>k</code> by default) to remove the
marked files from the view until the buffer is generated again (with
<code>g</code> by default (<code>revert-buffer</code>)).</li>
</ul>

<p>
All this is fine, but with <code>prot-dired-limit-regexp</code> I simply provide
the regexp I want to see.
</p>

<p>
Another common use-case for me is to create a flat listing of all
files that match a regular expression, found recursively from the
current directory. I do this with <code>prot-dired-search-flat-list</code>.
</p>

<p>
The other commands have situational uses. For example, the
<code>prot-dired-grep-marked-files</code> is something I have only used a few
times where <code>prot-search-grep</code> would produce too many results in a
given directory (<a href="#h:b902e6a3-cdd2-420f-bc99-3d973c37cd20">The <code>prot-emacs-search.el</code> extras provided by the <code>prot-search.el</code> library</a>).
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(use-package prot-dired
  :ensure nil
  :hook (dired-mode . prot-dired-setup-imenu)
  :bind
  ( :map dired-mode-map
    ("i" . prot-dired-insert-subdir) ; override `dired-maybe-insert-subdir'
    ("/" . prot-dired-limit-regexp)
    ("C-c C-l" . prot-dired-limit-regexp)
    ("M-n" . prot-dired-subdirectory-next)
    ("C-c C-s" . prot-dired-search-flat-list)
    ("C-c C-n" . prot-dired-subdirectory-next)
    ("C-c C-p" . prot-dired-subdirectory-previous)
    ("M-s G" . prot-dired-grep-marked-files) ; M-s g is `prot-search-grep'
    ("M-p" . prot-dired-subdirectory-previous)))
</pre>
</div>
</div>
</div>
<div id="outline-container-h:3a4a29bc-3491-4d01-9d64-1cef63b3116a" class="outline-4">
<h4 id="h:3a4a29bc-3491-4d01-9d64-1cef63b3116a"><span class="section-number-4">5.6.8.</span> The <code>prot-emacs-dired.el</code> section about <code>dired-subtree</code></h4>
<div class="outline-text-4" id="text-h:3a4a29bc-3491-4d01-9d64-1cef63b3116a">
<p>
The <code>dired-subtree</code> package by Matúš Goljer provides the convenience
of quickly revealing the contents of the directory at point. We do not
have to insert its contents below the current listing, as we would
normally do in Dired, nor do we have to open it in another buffer just
to check if we need to go further.
</p>

<p>
I do not use this feature frequently, though I appreciate it when I do
need it.
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(use-package dired-subtree
  :ensure t
  :after dired
  :bind
  ( :map dired-mode-map
    ("&lt;tab&gt;" . dired-subtree-toggle)
    ("TAB" . dired-subtree-toggle)
    ("&lt;backtab&gt;" . dired-subtree-remove)
    ("S-TAB" . dired-subtree-remove))
  :config
  (setq dired-subtree-use-backgrounds nil))
</pre>
</div>
</div>
</div>
<div id="outline-container-h:1b53bc10-8b1b-4f68-bbec-165909761e43" class="outline-4">
<h4 id="h:1b53bc10-8b1b-4f68-bbec-165909761e43"><span class="section-number-4">5.6.9.</span> The <code>prot-emacs-dired.el</code> section about <code>wdired</code> (writable Dired)</h4>
<div class="outline-text-4" id="text-h:1b53bc10-8b1b-4f68-bbec-165909761e43">
<p>
As noted in the introduction, Dired can be made writable
(<a href="#h:f8b08a77-f3a8-42fa-b1a9-f940348889c3">The <code>prot-emacs-dired.el</code> module</a>). This way, we can quickly rename
multiple files using Emacs&rsquo; panoply of editing capabilities.
</p>

<p>
Both of the variables I configure here have situational usage. I
cannot remember the last time I benefited from them.
</p>

<p>
Note that we have a variant of <code>wdired</code> for <code>grep</code> buffers
(<a href="#h:9a3581df-ab18-4266-815e-2edd7f7e4852">The <code>prot-emacs-search.el</code> setup for editable grep buffers (<code>wgrep</code>)</a>).
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(use-package wdired
  :ensure nil
  :commands (wdired-change-to-wdired-mode)
  :config
  (setq wdired-allow-to-change-permissions t)
  (setq wdired-create-parent-directories t))
</pre>
</div>
</div>
</div>
<div id="outline-container-h:198cdda8-fc3f-4672-8fd6-dfc795cea9e0" class="outline-4">
<h4 id="h:198cdda8-fc3f-4672-8fd6-dfc795cea9e0"><span class="section-number-4">5.6.10.</span> The <code>prot-emacs-dired.el</code> section about <code>image-dired</code></h4>
<div class="outline-text-4" id="text-h:198cdda8-fc3f-4672-8fd6-dfc795cea9e0">
<p>
The built-in <code>image-dired</code> feature is one of those tools that I like
when I use, but never remember exactly how to use because of how
infrequent my need for it is. The gist is that we put thumbnails in a
buffer and can browse through them in a file listing. It is okay,
though if I really have to rely on image previewing, I might just open
the graphical file manager. It is not a sin to use something outside
of Emacs and, anyway, I don&rsquo;t think Emacs&rsquo; editing capabilities are of
any relevance when we are just previewing a picture.
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(use-package image-dired
  :ensure nil
  :commands (image-dired)
  :bind
  ( :map image-dired-thumbnail-mode-map
    ("&lt;return&gt;" . image-dired-thumbnail-display-external))
  :config
  (setq image-dired-thumbnail-storage 'standard)
  (setq image-dired-external-viewer "xdg-open")
  (setq image-dired-thumb-size 80)
  (setq image-dired-thumb-margin 2)
  (setq image-dired-thumb-relief 0)
  (setq image-dired-thumbs-per-row 4))
</pre>
</div>
</div>
</div>
<div id="outline-container-h:c345ff72-d905-482a-a885-fc111252aacf" class="outline-4">
<h4 id="h:c345ff72-d905-482a-a885-fc111252aacf"><span class="section-number-4">5.6.11.</span> The <code>prot-emacs-dired.el</code> section about <code>dired-preview</code></h4>
<div class="outline-text-4" id="text-h:c345ff72-d905-482a-a885-fc111252aacf">
<p>
The <code>dired-preview</code> is a package of mine that, unfortunately, I have
not had the time to develop beyond the original release: it coincided
with my relocation to the hut and I still am busy doing all sorts of
work here. Once I get the opportunity, I will resume development of
this package.
</p>

<p>
At any rate, <code>dired-preview</code> previews the file at point in an Emacs
window. The goal is to make this work for large files, so that we
never experience any lag. I will expand this section once I feel we
are where we need to be.
</p>

<ul class="org-ul">
<li>Package name (GNU ELPA): <code>dired-preview</code></li>
<li>Official manual: <a href="https://protesilaos.com/emacs/dired-preview">https://protesilaos.com/emacs/dired-preview</a></li>
<li>Git repositories:
<ul class="org-ul">
<li>GitHub: <a href="https://github.com/protesilaos/dired-preview">https://github.com/protesilaos/dired-preview</a></li>
<li>GitLab: <a href="https://gitlab.com/protesilaos/dired-preview">https://gitlab.com/protesilaos/dired-preview</a></li>
</ul></li>
<li>Backronym: Directories Invariably Render Everything Decently; PDFs
Require Extra Viewing Instructions for Emacs to Work.</li>
</ul>

<div class="org-src-container">
<pre class="src src-emacs-lisp">;;; Automatically preview Dired file at point (dired-preview.el)
;; One of my packages: &lt;https://protesilaos.com/emacs&gt;
(use-package dired-preview
  :ensure t
  ;; :hook (dired-mode . (lambda ()
  ;;                       (when (string-match-p "Pictures" default-directory)
  ;;                         (dired-preview-mode 1))))
  :defer 1
  :hook (after-init . dired-preview-global-mode)
  :config
  (setq dired-preview-max-size (* (expt 2 20) 10))
  (setq dired-preview-delay 0.5)
  (setq dired-preview-ignored-extensions-regexp
        (concat "\\."
                "\\(gz\\|"
                "zst\\|"
                "tar\\|"
                "xz\\|"
                "rar\\|"
                "zip\\|"
                "iso\\|"
                "epub"
                "\\)"))

  ;; (setq dired-preview-display-action-alist
  ;;       '((display-buffer-in-side-window)
  ;;         (side . bottom)
  ;;         (window-height . 0.2)
  ;;         (preserve-size . (t . t))
  ;;         (window-parameters . ((mode-line-format . none)
  ;;                               (header-line-format . none)))))
  )
</pre>
</div>
</div>
</div>
<div id="outline-container-h:8a92d9db-b35a-4ec3-8b37-f42a80a67854" class="outline-4">
<h4 id="h:8a92d9db-b35a-4ec3-8b37-f42a80a67854"><span class="section-number-4">5.6.12.</span> The <code>prot-emacs-dired.el</code> section about multimedia previews (<code>ready-player</code>)</h4>
<div class="outline-text-4" id="text-h:8a92d9db-b35a-4ec3-8b37-f42a80a67854">
<p>
This is a neat package by Alvaro Ramirez which produces a previewable
representation of multimedia file when we try to visit them in an
Emacs buffer. Without <code>ready-player-major-mode</code>, we get a bunch of
gibberish from the binary data.
</p>

<p>
While this is a standalone package, it synergises with my
<code>dired-preview</code> without the need to add any glue code between the two
packages (<a href="#h:c345ff72-d905-482a-a885-fc111252aacf">The <code>prot-emacs-dired.el</code> section about <code>dired-preview</code></a>).
When I move the cursor over a multimedia file, the Dired preview
buffer tries to visit the file at point, which is in turn rendered
using <code>ready-player</code>.
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(use-package ready-player
  :ensure t
  :mode
  ("\\.\\(mp3\\|m4a\\|mp4\\|mkv\\|webm\\)\\'" . ready-player-major-mode)
  :config
  (setq ready-player-autoplay nil)
  (setq ready-player-repeat nil))
</pre>
</div>
</div>
</div>
<div id="outline-container-h:2e005bd1-d098-426d-91f9-2a31a6e55caa" class="outline-4">
<h4 id="h:2e005bd1-d098-426d-91f9-2a31a6e55caa"><span class="section-number-4">5.6.13.</span> The <code>prot-emacs-dired.el</code> section about <code>trashed.el</code></h4>
<div class="outline-text-4" id="text-h:2e005bd1-d098-426d-91f9-2a31a6e55caa">
<p>
The <code>trashed</code> package by Shingo Tanaka provides a Dired-like interface
to the system&rsquo;s virtual trash directory. The few times I need to
restore a file, I do <code>M-x dired</code>, then type <code>r</code> to mark the file to be
restored (<code>M-x trashed-flag-restore</code>), and then type <code>x</code> (<code>M-x trashed-do-execute</code>)
to apply the effect.
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">;;; dired-like mode for the trash (trashed.el)
(use-package trashed
  :ensure t
  :commands (trashed)
  :config
  (setq trashed-action-confirmer 'y-or-n-p)
  (setq trashed-use-header-line t)
  (setq trashed-sort-key '("Date deleted" . t))
  (setq trashed-date-format "%Y-%m-%d %H:%M:%S"))
</pre>
</div>
</div>
</div>
<div id="outline-container-h:bdea93a8-f420-400c-ac3a-9663cb10dbd2" class="outline-4">
<h4 id="h:bdea93a8-f420-400c-ac3a-9663cb10dbd2"><span class="section-number-4">5.6.14.</span> The <code>prot-emacs-dired.el</code> section about <code>mandoura</code> (<code>mpv</code> media player)</h4>
<div class="outline-text-4" id="text-h:bdea93a8-f420-400c-ac3a-9663cb10dbd2">
<p>
The <code>mandoura</code> package is an experiment of mine to use Dired as a
starting point to play back some media files (or directory containing
such files) using the <code>mpv</code> program. I use it daily and it works fine
for just playback, but I do need/want to develop it further as it
really is nothing but a prototype right now. You will thus notice that
the package declaration is actually installing the file from source:
this is a feature built into Emacs 30, though it also is available as
a package for Emacs 29.
</p>

<ul class="org-ul">
<li>Package name (GNU ELPA): <code>mandoura</code> (⛔ not available yet)</li>
<li>Git repositories:
<ul class="org-ul">
<li>GitHub: <a href="https://github.com/protesilaos/mandoura">https://github.com/protesilaos/mandoura</a></li>
<li>GitLab: <a href="https://gitlab.com/protesilaos/mandoura">https://gitlab.com/protesilaos/mandoura</a></li>
</ul></li>
<li>Backronym: MPV Access Needs Dired to Output User&rsquo;s Requested Audio.</li>
</ul>

<div class="org-src-container">
<pre class="src src-emacs-lisp">;;; Play back media with Dired (mandoura.el)
;; This is yet another package of mine: &lt;https://protesilaos.com/emacs&gt;
(use-package mandoura
  ;; The :vc keyword is part of Emacs 30.  Read the manual for what keywords it reads: (info "(emacs) Fetching Package Sources")
  :vc ( :url "https://github.com/protesilaos/mandoura")
  :commands (mandoura-play-playlist)
  :after dired
  :bind
  ( :map global-map
    ("M-&lt;AudioPlay&gt;" . mandoura-return-track-title-and-time)
    ("M-&lt;XF86AudioPlay&gt;" . mandoura-return-track-title-and-time)
    :map dired-mode-map
    ("M-&lt;return&gt;" . mandoura-play-playlist)
    ("M-RET" . mandoura-play-playlist))
  :config
  (setq mandoura-saved-playlist-directory "~/Music/playlists/"))
</pre>
</div>
</div>
</div>
<div id="outline-container-h:c8b2f021-fe5a-4f6b-944c-20340f764fb2" class="outline-4">
<h4 id="h:c8b2f021-fe5a-4f6b-944c-20340f764fb2"><span class="section-number-4">5.6.15.</span> The <code>prot-emacs-dired.el</code> call to <code>provide</code></h4>
<div class="outline-text-4" id="text-h:c8b2f021-fe5a-4f6b-944c-20340f764fb2">
<p>
Finally, we <code>provide</code> the module. This is the mirror function of
<code>require</code> (<a href="#h:e6c4acf5-5b51-4b38-a86a-bf3f698ac872">The init.el final part to load the individual modules</a>).
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(provide 'prot-emacs-dired)
</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-h:b5fa481d-8549-4424-869e-91091cdf730b" class="outline-3">
<h3 id="h:b5fa481d-8549-4424-869e-91091cdf730b"><span class="section-number-3">5.7.</span> The <code>prot-emacs-window.el</code> module</h3>
<div class="outline-text-3" id="text-h:b5fa481d-8549-4424-869e-91091cdf730b">
<p>
This module is all about buffers and windows. How they are managed and
displayed.
</p>
</div>
<div id="outline-container-h:bf93a881-e885-4b83-bd30-35bd888fe199" class="outline-4">
<h4 id="h:bf93a881-e885-4b83-bd30-35bd888fe199"><span class="section-number-4">5.7.1.</span> The <code>prot-emacs-window.el</code> section about running commands in popup frames</h4>
<div class="outline-text-4" id="text-h:bf93a881-e885-4b83-bd30-35bd888fe199">
<p>
Sometimes we want to call a command from outside Emacs. I have
arranged for this to happen so that a new frame pops up, I do the
command, and then the frame is deleted. This requires that we use the
Emacs daemon process or <code>server-mode</code> (<a href="#h:7709b7e9-844f-49f3-badf-784aacec4bca">The <code>prot-emacs-essentials.el</code> arrangement to run Emacs as a server</a>).
We can thus call <code>emacsclient</code> from outside Emacs and instruct it to
run any arbitrary Emacs Lisp code.
</p>

<p>
My <code>prot-window.el</code> provides the <code>prot-window-define-with-popup-frame</code>
macro which streamlines the creation of commands that have the desired
behaviour (<a href="#h:35b8a0a5-c447-4301-a404-bc274596238d">The <code>prot-window.el</code> library</a>). All we need is to call the
macro and tell it which command should be empowered to run in such a
popup frame. I did a video demonstrating this functionality: <a href="https://protesilaos.com/codelog/2024-09-19-emacs-command-popup-frame-emacsclient/">Emacs: commands in popup frames with <code>emacsclient</code></a>
(2024-09-19).
</p>

<p>
All we need here is the hooks that close the frame after the commands
run succesfully. The commands I configure are for <code>org-capture</code> and
<code>tmr</code>:
</p>

<ul class="org-ul">
<li><a href="#h:f8f06938-0dfe-45c3-b4cf-996d36cba82d">The <code>prot-emacs-org.el</code> Org capture templates (<code>org-capture</code>)</a></li>
<li><a href="#h:6dce278e-86c7-4620-9271-d5af5499f0cc">The <code>prot-emacs-essentials.el</code> section about <code>tmr</code> (set timers)</a></li>
</ul>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(with-eval-after-load 'org-capture
  (add-hook 'org-capture-after-finalize-hook #'prot-window-delete-popup-frame))

(with-eval-after-load 'tmr
  (add-hook 'tmr-timer-created-functions #'prot-window-delete-popup-frame))
</pre>
</div>

<p>
At my system level I also have keybindings bound to call the following
(you can try those on the command line&#x2014;remember they depend on the
daemon or <code>server-mode</code>):
</p>

<pre class="example" id="org79e580d">
# Run `org-capture` in a popup frame that is deleted after you are done.
emacsclient -e '(prot-window-popup-org-capture)'
</pre>

<pre class="example" id="orgb435614">
# Same idea for the `tmr` command.
emacsclient -e '(prot-window-popup-tmr)'
</pre>
</div>
</div>
<div id="outline-container-h:cfbea29c-3290-4fd1-a02a-d7e887c15674" class="outline-4">
<h4 id="h:cfbea29c-3290-4fd1-a02a-d7e887c15674"><span class="section-number-4">5.7.2.</span> The <code>prot-emacs-window.el</code> section about uniquifying buffer names</h4>
<div class="outline-text-4" id="text-h:cfbea29c-3290-4fd1-a02a-d7e887c15674">
<p>
When a buffer name is reserved, Emacs tries to produce the new buffer
by finding a suitable variant of the original name. The doc string of
the variable <code>uniquify-buffer-name-style</code> does a good job at
explaining the various patterns:
</p>

<pre class="example" id="org822d315">
For example, the files ‘/foo/bar/mumble/name’ and ‘/baz/quux/mumble/name’
would have the following buffer names in the various styles:

  forward                       bar/mumble/name    quux/mumble/name
  reverse                       name\mumble\bar    name\mumble\quux
  post-forward                  name|bar/mumble    name|quux/mumble
  post-forward-angle-brackets   name&lt;bar/mumble&gt;   name&lt;quux/mumble&gt;
  nil                           name               name&lt;2&gt;
</pre>

<p>
I use the <code>forward</code> style, which is the closest to the actual file
name.
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">;;; General window and buffer configurations
(use-package uniquify
  :ensure nil
  :config
;;;; `uniquify' (unique names for buffers)
  (setq uniquify-buffer-name-style 'forward)
  (setq uniquify-strip-common-suffix t)
  (setq uniquify-after-kill-buffer-p t))
</pre>
</div>
</div>
</div>
<div id="outline-container-h:ec156866-3d25-42e7-8247-b190103b6f17" class="outline-4">
<h4 id="h:ec156866-3d25-42e7-8247-b190103b6f17"><span class="section-number-4">5.7.3.</span> The <code>prot-emacs-window.el</code> section about line highlighting (<code>hl-line-mode</code>)</h4>
<div class="outline-text-4" id="text-h:ec156866-3d25-42e7-8247-b190103b6f17">
<p>
The built-in <code>hl-line-mode</code> highlights the current line by adding a
background colour to it. I normally do not use this functionality. I
do it only when I need to draw attention to something I am demonstrating.
</p>

<p>
The <code>nil</code> value for <code>hl-line-sticky-flag</code> makes the line highlight not
show up in unfocused windows. I prefer to keep highlights at a
minimum, because I then find it harder to focus on where I am. The
<code>hl-line-overlay-priority</code> is a more obscure aspect of how Emacs
decides which background should take precedence. You most probably do
not need this, though I had a case for it a while ago: the specifics
do not matter.
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">;;;; Line highlight
(use-package hl-line
  :ensure nil
  :commands (hl-line-mode)
  :config
  (setq hl-line-sticky-flag nil)
  (setq hl-line-overlay-priority -50)) ; emacs28
</pre>
</div>
</div>
</div>
<div id="outline-container-h:ad2945c5-992d-4c82-a8b8-652f47ebdbea" class="outline-4">
<h4 id="h:ad2945c5-992d-4c82-a8b8-652f47ebdbea"><span class="section-number-4">5.7.4.</span> The <code>prot-emacs-window.el</code> section about negative space highlighting (<code>whitespace-mode</code>)</h4>
<div class="outline-text-4" id="text-h:ad2945c5-992d-4c82-a8b8-652f47ebdbea">
<p>
Much like <code>hl-line-mode</code>, I normally do not use the <code>whitespace-mode</code>
(<a href="#h:ec156866-3d25-42e7-8247-b190103b6f17">The <code>prot-emacs-window.el</code> section about line highlighting (<code>hl-line-mode</code>)</a>).
I do it only when I have to demonstrate something, or to quickly check
that my spacing is correct in some context where that matters.
</p>

<p>
The changes I have made to <code>whitespace-style</code> are experimental and I
do not recommend you copy them. I basically tried to make it less
busy, by highlighting fewer elements. For example, I do not highlight
newline characters (represented as a <code>$</code>) because these are easy to
infer in most cases.
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">;;;; Negative space highlight
(use-package whitespace
  :ensure nil
  :bind
  (("&lt;f6&gt;" . whitespace-mode)
   ("C-c z" . delete-trailing-whitespace))
  :config
  ;; NOTE 2023-08-14: This is experimental.  I am not sure I like it.
  (setq whitespace-style
        '(face
          tabs
          spaces
          tab-mark
          space-mark
          trailing
          missing-newline-at-eof
          space-after-tab::tab
          space-after-tab::space
          space-before-tab::tab
          space-before-tab::space)))
</pre>
</div>
</div>
</div>
<div id="outline-container-h:f45ea51c-8129-41bd-8d6e-4b66e7f35a49" class="outline-4">
<h4 id="h:f45ea51c-8129-41bd-8d6e-4b66e7f35a49"><span class="section-number-4">5.7.5.</span> The <code>prot-emacs-window.el</code> section about line numbers (<code>display-line-numbers-mode</code>)</h4>
<div class="outline-text-4" id="text-h:f45ea51c-8129-41bd-8d6e-4b66e7f35a49">
<p>
As with the two previous sections, I do not like to see line numbers
by default and seldom use <code>display-line-numbers-mode</code>. They do not
help me navigate a buffer, nor are they relevant in most cases. I
enable the mode only when I need to compare buffers or to get a sense
of how far apart two relevant sections are in a file.
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">;;; Line numbers on the side of the window
(use-package display-line-numbers
  :ensure nil
  :bind
  ("&lt;f7&gt;" . display-line-numbers-mode)
  :config
  (setq-default display-line-numbers-type t)
  ;; Those two variables were introduced in Emacs 27.1
  (setq display-line-numbers-major-tick 0)
  (setq display-line-numbers-minor-tick 0)
  ;; Use absolute numbers in narrowed buffers
  (setq-default display-line-numbers-widen t))
</pre>
</div>
</div>
</div>
<div id="outline-container-h:50f8b1e4-b14e-453f-a37e-1c0e495ab80f" class="outline-4">
<h4 id="h:50f8b1e4-b14e-453f-a37e-1c0e495ab80f"><span class="section-number-4">5.7.6.</span> The <code>prot-emacs-window.el</code> rules for displaying buffers (<code>display-buffer-alist</code>)</h4>
<div class="outline-text-4" id="text-h:50f8b1e4-b14e-453f-a37e-1c0e495ab80f">
<p>
[ Watch: <a href="https://protesilaos.com/codelog/2024-02-08-emacs-window-rules-display-buffer-alist/">control where buffers are displayed (the <code>display-buffer-alist</code>)</a> (2024-02-08). ]
</p>

<p>
The <code>display-buffer-alist</code> is a powerful user option and somewhat hard
to get started with. The reason for its difficulty comes from the
knowledge required to understand the underlying <code>display-buffer</code>
mechanism.
</p>

<p>
Here is the gist of what we do with it:
</p>

<ul class="org-ul">
<li>The alist is a list of lists.</li>
<li><p>
Each element of the alist (i.e. one of the lists) is of the
following form:
</p>

<pre class="example" id="org28b4c7d">
  (BUFFER-MATCHER
   FUNCTIONS-TO-DISPLAY-BUFFER
   OTHER-PARAMETERS)
</pre></li>

<li>The <code>BUFFER-MATCHER</code> is either a regular expression to match the
buffer by its name or a method to get the buffer whose major mode is
the one specified. In the latter case, you will see the use of cons
cells (like <code>(one . two)</code>) involving the <code>derived-mode</code> symbol
(remember that I build Emacs from source, so <code>derived-mode</code> may not
exist in your version of Emacs).</li>

<li>The <code>FUNCTIONS-TO-DISPLAY-BUFFER</code> is a list of <code>display-buffer</code>
functions that are tried in the order they appear in until one
works. The list can be of one element, as you will notice with some
of my entries.</li>

<li><p>
The <code>OTHER-PARAMETERS</code> are enumerated in the Emacs Lisp Reference
Manual. Evaluate:
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">  (info "(elisp) Buffer Display Action Alists")
</pre>
</div></li>
</ul>

<p>
In my <code>prot-window.el</code> library, I define functions that determine how
a buffer should be displayed, given size considerations (<a href="#h:35b8a0a5-c447-4301-a404-bc274596238d">The <code>prot-window.el</code> library</a>).
You will find the functions <code>prot-window-shell-or-term-p</code> to determine
what a shell or terminal is, <code>prot-window-display-buffer-below-or-pop</code>
to display the buffer below the current one or to its side depending
on how much width is available, and <code>prot-window-select-fit-size</code> to
perform the two-fold task of selecting a window and making it fit up
to a certain height.
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">  ;;;; `window', `display-buffer-alist', and related
  (use-package prot-window
    :ensure nil
    :demand t
    :config
    ;; NOTE 2023-03-17: Remember that I am using development versions of
    ;; Emacs.  Some of my `display-buffer-alist' contents are for Emacs
    ;; 29+.
    (setq display-buffer-alist
          `(;; no window
            ("\\`\\*Async Shell Command\\*\\'"
             (display-buffer-no-window))
            ("\\`\\*\\(Warnings\\|Compile-Log\\|Org Links\\)\\*\\'"
             (display-buffer-no-window)
             (allow-no-window . t))
            ;; bottom side window
            ("\\*\\(Org \\(Select\\|Note\\)\\|Agenda Commands\\)\\*" ; the `org-capture' key selection and `org-add-log-note'
             (display-buffer-in-side-window)
             (dedicated . t)
             (side . bottom)
             (slot . 0)
             (window-parameters . ((mode-line-format . none))))
            ;; bottom buffer (NOT side window)
            ((or . ((derived-mode . flymake-diagnostics-buffer-mode)
                    (derived-mode . flymake-project-diagnostics-mode)
                    (derived-mode . messages-buffer-mode)
                    (derived-mode . backtrace-mode)))
             (display-buffer-reuse-mode-window display-buffer-at-bottom)
             (window-height . 0.3)
             (dedicated . t)
             (preserve-size . (t . t)))
            ("\\*Embark Actions\\*"
             (display-buffer-reuse-mode-window display-buffer-below-selected)
             (window-height . fit-window-to-buffer)
             (window-parameters . ((no-other-window . t)
                                   (mode-line-format . none))))
            ("\\*\\(Output\\|Register Preview\\).*"
             (display-buffer-reuse-mode-window display-buffer-at-bottom))
            ;; below current window
            ("\\(\\*Capture\\*\\|CAPTURE-.*\\)"
             (display-buffer-reuse-mode-window display-buffer-below-selected))
            ((derived-mode . reb-mode) ; M-x re-builder
             (display-buffer-reuse-mode-window display-buffer-below-selected)
             (window-height . 4) ; note this is literal lines, not relative
             (dedicated . t)
             (preserve-size . (t . t)))
            ((or . ((derived-mode . occur-mode)
                    (derived-mode . grep-mode)
                    (derived-mode . Buffer-menu-mode)
                    (derived-mode . log-view-mode)
                    (derived-mode . help-mode) ; See the hooks for `visual-line-mode'
                    "\\*\\(|Buffer List\\|Occur\\|vc-change-log\\|eldoc.*\\).*"
                    "\\*\\vc-\\(incoming\\|outgoing\\|git : \\).*"
                    prot-window-shell-or-term-p
                    ;; ,world-clock-buffer-name
                    ))
             (prot-window-display-buffer-below-or-pop)
             (body-function . prot-window-select-fit-size))
            ("\\*\\(Calendar\\|Bookmark Annotation\\|ert\\).*"
             (display-buffer-reuse-mode-window display-buffer-below-selected)
             (dedicated . t)
             (window-height . fit-window-to-buffer))
            ;; NOTE 2022-09-10: The following is for `ispell-word', though
            ;; it only works because I override `ispell-display-buffer'
            ;; with `prot-spell-ispell-display-buffer' and change the
            ;; value of `ispell-choices-buffer'.
            ("\\*ispell-top-choices\\*.*"
             (display-buffer-reuse-mode-window display-buffer-below-selected)
             (window-height . fit-window-to-buffer))
            ;; same window

            ;; NOTE 2023-02-17: `man' does not fully obey the
            ;; `display-buffer-alist'.  It works for new frames and for
            ;; `display-buffer-below-selected', but otherwise is
            ;; unpredictable.  See `Man-notify-method'.
            ((or . ((derived-mode . Man-mode)
                    (derived-mode . woman-mode)
                    "\\*\\(Man\\|woman\\).*"))
             (display-buffer-same-window)))))
</pre>
</div>

<p>
The following settings are relevant for the <code>display-buffer-alist</code> we
saw right above. Notice, in particular, the <code>split-height-threshold</code>
and <code>split-width-threshold</code> which determine when to split the frame by
height or width. These are relevant for <code>prot-window-display-buffer-below-or-pop</code>
and the other more basic functions I have defined for this purpose.
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(use-package prot-window
  :ensure nil
  :demand t
  :config
  (setq window-combination-resize t)
  (setq even-window-sizes 'height-only)
  (setq window-sides-vertical nil)
  (setq switch-to-buffer-in-dedicated-window 'pop)
  (setq split-height-threshold 85)
  (setq split-width-threshold 125)
  (setq window-min-height 3)
  (setq window-min-width 30))
</pre>
</div>
</div>
</div>
<div id="outline-container-h:bf3f50d5-c5db-4704-9498-9e8bfe1b45a8" class="outline-4">
<h4 id="h:bf3f50d5-c5db-4704-9498-9e8bfe1b45a8"><span class="section-number-4">5.7.7.</span> The <code>prot-emacs-window.el</code> setting to enable <code>visual-line-mode</code> in some contexts</h4>
<div class="outline-text-4" id="text-h:bf3f50d5-c5db-4704-9498-9e8bfe1b45a8">
<p>
I normally do not use <code>visual-line-mode</code>. What it does is to break
long lines to span multiple lines without actually affecting the
underlying text. In other words, we still have one long line only its
visualisation is as a paragraph.
</p>

<p>
For the cases where I am fine with <code>visual-line-mode</code>, I enable the
mode by adding it to these mode hooks.
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(use-package prot-window
  :ensure nil
  :demand t
  :hook
  ((epa-info-mode help-mode custom-mode) . visual-line-mode))
</pre>
</div>
</div>
</div>
<div id="outline-container-h:b6754236-3d08-4448-9c86-3e5923737e4b" class="outline-4">
<h4 id="h:b6754236-3d08-4448-9c86-3e5923737e4b"><span class="section-number-4">5.7.8.</span> The <code>prot-emacs-window.el</code> settings to truncate some buffers silently</h4>
<div class="outline-text-4" id="text-h:b6754236-3d08-4448-9c86-3e5923737e4b">
<p>
This here is the opposite of what we saw above (<a href="#h:bf3f50d5-c5db-4704-9498-9e8bfe1b45a8">The <code>prot-emacs-window.el</code> setting to enable <code>visual-line-mode</code> in some contexts</a>).
Unlike <code>visual-line-mode</code> where long lines are made to look like
paragraphs, &ldquo;truncation&rdquo; means to let the line cover its natural
length and simply cut it off screen.
</p>

<p>
I have a custom library that defines a function which performs line
truncation without displaying a message about the fact (<a href="#h:3fccfadf-22e9-457f-b9fd-ed1b48600d23">The <code>prot-common.el</code> library</a>).
Why do we need this? Check the output of <code>M-x calendar</code> in a tiny
window and you will see the reason. In short, it is better to have
lines not show their full contents than to have something that looks
completely broken.
</p>

<p>
The whole point of using hooks is to make these decisions on a
case-by-case basis.
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(use-package prot-window
  :ensure nil
  :demand t
  :hook
  ((world-clock-mode calendar-mode) . prot-common-truncate-lines-silently))
</pre>
</div>
</div>
</div>
<div id="outline-container-h:49ad5448-2ccd-4f47-82fd-17819ffdbdf3" class="outline-4">
<h4 id="h:49ad5448-2ccd-4f47-82fd-17819ffdbdf3"><span class="section-number-4">5.7.9.</span> The <code>prot-emacs-window.el</code> section key bindings</h4>
<div class="outline-text-4" id="text-h:49ad5448-2ccd-4f47-82fd-17819ffdbdf3">
<p>
Here I simply define some key bindings. The commands I use the most in
this list are <code>delete-other-windows-vertically</code>, <code>previous-buffer</code>,
and <code>next-buffer</code>. I rarely resize windows, though I am happy to use
the mouse for such a case.
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(use-package prot-window
  :ensure nil
  :demand t
  :bind
  ( :map global-map
    ;; NOTE 2022-09-17: Also see `prot-simple-swap-window-buffers'.
    ("C-x &lt;down&gt;" . next-buffer)
    ("C-x &lt;up&gt;" . previous-buffer)
    ("C-x C-n" . next-buffer)     ; override `set-goal-column'
    ("C-x C-p" . previous-buffer) ; override `mark-page'
    ("C-x !" . delete-other-windows-vertically)
    ("C-x _" . balance-windows)      ; underscore
    ("C-x -" . fit-window-to-buffer) ; hyphen
    ("C-x +" . balance-windows-area)
    ("C-x }" . enlarge-window)
    ("C-x {" . shrink-window)
    ("C-x &gt;" . enlarge-window-horizontally) ; override `scroll-right'
    ("C-x &lt;" . shrink-window-horizontally) ; override `scroll-left'
    :map resize-window-repeat-map
    ("&gt;" . enlarge-window-horizontally)
    ("&lt;" . shrink-window-horizontally)))
</pre>
</div>
</div>
</div>
<div id="outline-container-h:77e4f174-0c86-460d-8a54-47545f922ae9" class="outline-4">
<h4 id="h:77e4f174-0c86-460d-8a54-47545f922ae9"><span class="section-number-4">5.7.10.</span> The <code>prot-emacs-window.el</code> section about <code>beframe</code></h4>
<div class="outline-text-4" id="text-h:77e4f174-0c86-460d-8a54-47545f922ae9">
<p>
[ Also see: <a href="#h:7dcbcadf-8af6-487d-b864-e4ce56d69530">The <code>prot-emacs-git.el</code> section about <code>project.el</code></a>. ]
</p>

<p>
My <code>beframe</code> package enables a frame-oriented Emacs workflow where
each frame has access to the list of buffers visited therein. In the
interest of brevity, we call buffers that belong to frames &ldquo;beframed&rdquo;.
Check the video demo I did and note that I consider this one of the
best changes I ever did to boost my productivity:
<a href="https://protesilaos.com/codelog/2023-02-28-emacs-beframe-demo/">https://protesilaos.com/codelog/2023-02-28-emacs-beframe-demo/</a>.
</p>

<ul class="org-ul">
<li>Package name (GNU ELPA): <code>beframe</code></li>
<li>Official manual: <a href="https://protesilaos.com/emacs/beframe">https://protesilaos.com/emacs/beframe</a></li>
<li>Change log: <a href="https://protesilaos.com/emacs/beframe-changelog">https://protesilaos.com/emacs/beframe-changelog</a></li>
<li>Git repositories:
<ul class="org-ul">
<li>GitHub: <a href="https://github.com/protesilaos/beframe">https://github.com/protesilaos/beframe</a></li>
<li>GitLab: <a href="https://gitlab.com/protesilaos/beframe">https://gitlab.com/protesilaos/beframe</a></li>
</ul></li>
<li>Backronym: Buffers Encapsulated in Frames Realise Advanced
Management of Emacs.</li>
</ul>

<div class="org-src-container">
<pre class="src src-emacs-lisp">;;; Frame-isolated buffers
;; Another package of mine.  Read the manual:
;; &lt;https://protesilaos.com/emacs/beframe&gt;.
(use-package beframe
  :ensure t
  :hook (after-init . beframe-mode)
  :config
  (setq beframe-functions-in-frames '(project-prompt-project-dir))

  ;; I use this instead of :bind because I am binding a keymap and the
  ;; way `use-package' does it is by wrapping a lambda around it that
  ;; then breaks `describe-key' for those keys.
  (prot-emacs-keybind global-map
    ;; Override the `set-fill-column' that I have no use for.
    "C-x f" #'other-frame-prefix
    ;; Bind Beframe commands to a prefix key. Notice the -map as I am
    ;; binding keymap here, not a command.
    "C-c b" #'beframe-prefix-map
    ;; Replace the generic `buffer-menu'.  With a prefix argument, this
    ;; commands prompts for a frame.  Call the `buffer-menu' via M-x if
    ;; you absolutely need the global list of buffers.
    "C-x C-b" #'beframe-buffer-menu
    ;; Not specific to Beframe, but since it renames frames (by means
    ;; of `beframe-mode') it is appropriate to have this here:
    "C-x B" #'select-frame-by-name))
</pre>
</div>
</div>
</div>
<div id="outline-container-h:2df15080-77f9-45f8-a3b5-1adddc70a512" class="outline-4">
<h4 id="h:2df15080-77f9-45f8-a3b5-1adddc70a512"><span class="section-number-4">5.7.11.</span> The <code>prot-emacs-window.el</code> configuration of <code>undelete-frame-mode</code> and <code>winner-mode</code></h4>
<div class="outline-text-4" id="text-h:2df15080-77f9-45f8-a3b5-1adddc70a512">
<p>
Since I am using my <code>beframe</code> package to isolate buffers per frame
(<a href="#h:77e4f174-0c86-460d-8a54-47545f922ae9">The <code>prot-emacs-window.el</code> section about <code>beframe</code></a>), I appreciate the
feature of Emacs 29 to undo the deletion of frames. Note the key
binding I use for this purpose. It overrides one of the alternatives
for the standard <code>undo</code> command, though I personally only ever use
<code>C-/</code>: everything else is free to use as I see fit.
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">;;; Frame history (undelete-frame-mode)
(use-package frame
  :ensure nil
  :bind ("C-x u" . undelete-frame) ; I use only C-/ for `undo'
  :hook (after-init . undelete-frame-mode))
</pre>
</div>

<p>
The <code>winner-mode</code> is basically the same idea as <code>undelete-frame-mode</code>
but for window layouts. Or maybe I should phrase this the other way
round, given that <code>winner</code> is the older package. But the point is that
we can quickly go back to an earlier arrangement of windows in a
frame.
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">;;; Window history (winner-mode)
(use-package winner
  :ensure nil
  :hook (after-init . winner-mode)
  :bind
  (("C-x &lt;right&gt;" . winner-redo)
   ("C-x &lt;left&gt;" . winner-undo)))
</pre>
</div>
</div>
</div>
<div id="outline-container-h:84a0d366-d4d7-42f4-a8b7-2ec1af08cee4" class="outline-4">
<h4 id="h:84a0d366-d4d7-42f4-a8b7-2ec1af08cee4"><span class="section-number-4">5.7.12.</span> The <code>prot-emacs-window.el</code> keys for window motions (<code>windmove</code>)</h4>
<div class="outline-text-4" id="text-h:84a0d366-d4d7-42f4-a8b7-2ec1af08cee4">
<p>
I usually cycle between windows with <code>C-x o</code> (<code>M-x other-window</code>).
This is because I use two or three windows at most. It is easier to
use the same key, especially with the addition of <code>repeat-mode</code>
(<a href="#h:fbe6f9da-25ee-46a3-bb03-8fa7c1d48dab">The <code>prot-emacs-essentials.el</code> settings for <code>repeat-mode</code></a>).
Nevertheless, the built-in <code>windmove</code> package provides a set of useful
commands to move focus directionally between windows but also to shift
the placement of a window in the given direction.
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">;;; Directional window motions (windmove)
(use-package windmove
  :ensure nil
  :bind
  ;; Those override some commands that are already available with
  ;; C-M-u, C-M-f, C-M-b.
  (("C-M-&lt;up&gt;" . windmove-up)
   ("C-M-&lt;right&gt;" . windmove-right)
   ("C-M-&lt;down&gt;" . windmove-down)
   ("C-M-&lt;left&gt;" . windmove-left)
   ("C-M-S-&lt;up&gt;" . windmove-swap-states-up)
   ("C-M-S-&lt;right&gt;" . windmove-swap-states-right) ; conflicts with `org-increase-number-at-point'
   ("C-M-S-&lt;down&gt;" . windmove-swap-states-down)
   ("C-M-S-&lt;left&gt;" . windmove-swap-states-left))
  :config
  (setq windmove-create-window nil)) ; Emacs 27.1
</pre>
</div>
</div>
</div>
<div id="outline-container-h:29ced61b-4b5a-4f63-af00-fe311468d1cd" class="outline-4">
<h4 id="h:29ced61b-4b5a-4f63-af00-fe311468d1cd"><span class="section-number-4">5.7.13.</span> The <code>prot-emacs-window.el</code> use of contextual header line (<code>breadcrumb</code>)</h4>
<div class="outline-text-4" id="text-h:29ced61b-4b5a-4f63-af00-fe311468d1cd">
<p>
The <code>breadcrumb</code> package by João Távora lets us display contextual
information about the current heading or code definition in the header
line. The header line is displayed above the contents of each buffer
in the given window. When we are editing an Org file, for example, we
see the path to the file, followed by a reference to the tree that
leads to the current heading. Same idea for programming modes. Neat!
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">;;; Header line context of symbol/heading (breadcrumb.el)
(use-package breadcrumb
  :ensure t
  :functions (prot/breadcrumb-local-mode)
  :hook ((text-mode prog-mode) . prot/breadcrumb-local-mode)
  :config
  (setq breadcrumb-project-max-length 0.5)
  (setq breadcrumb-project-crumb-separator "/")
  (setq breadcrumb-imenu-max-length 1.0)
  (setq breadcrumb-imenu-crumb-separator " &gt; ")

  (defun prot/breadcrumb-local-mode ()
    "Enable `breadcrumb-local-mode' if the buffer is visiting a file."
    (when buffer-file-name
      (breadcrumb-local-mode 1))))
</pre>
</div>
</div>
</div>
<div id="outline-container-h:2124c200-734d-49c4-aeb1-513caaf957ae" class="outline-4">
<h4 id="h:2124c200-734d-49c4-aeb1-513caaf957ae"><span class="section-number-4">5.7.14.</span> The <code>prot-emacs-window.el</code> <code>provide</code> form</h4>
<div class="outline-text-4" id="text-h:2124c200-734d-49c4-aeb1-513caaf957ae">
<p>
As always, we <code>provide</code> the module. This is the mirror function of
<code>require</code> (<a href="#h:e6c4acf5-5b51-4b38-a86a-bf3f698ac872">The init.el final part to load the individual modules</a>).
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(provide 'prot-emacs-window)
</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-h:65e3eff5-0bff-4e1f-b6c5-0d3aa1a0d232" class="outline-3">
<h3 id="h:65e3eff5-0bff-4e1f-b6c5-0d3aa1a0d232"><span class="section-number-3">5.8.</span> The <code>prot-emacs-git.el</code> module</h3>
<div class="outline-text-3" id="text-h:65e3eff5-0bff-4e1f-b6c5-0d3aa1a0d232">
<p>
[ Watch: <a href="https://protesilaos.com/codelog/2023-08-03-contribute-core-emacs/">Contribute to GNU Emacs core</a> (2023-08-03). ]
</p>

<p>
Emacs can handle several version control programs, though I only ever
use <code>git</code>. Version control is essential to any public-facing
programming project: the history of changes is stored persistently, so
the developer can retrace when a given snippet of code was introduced
or modified. Plus, it is integral to collaboration, which is what free
software (such as Emacs and all its packages) is all about.
</p>

<p>
This section covers my settings for version control per se, but more
widely for tools related to checking different versions of files and
working with so-called &ldquo;projects&rdquo;.
</p>
</div>
<div id="outline-container-h:89edea05-4d94-4ea1-b2a8-5ad01422618c" class="outline-4">
<h4 id="h:89edea05-4d94-4ea1-b2a8-5ad01422618c"><span class="section-number-4">5.8.1.</span> The <code>prot-emacs-git.el</code> section about ediff</h4>
<div class="outline-text-4" id="text-h:89edea05-4d94-4ea1-b2a8-5ad01422618c">
<p>
[ Watch: <a href="https://protesilaos.com/codelog/2023-11-17-emacs-ediff-basics/">Emacs: ediff basics</a> (2023-12-30) ]
</p>

<p>
The built-in <code>ediff</code> feature provides several commands that let us
compare files or buffers side-by-side. The defaults of <code>ediff</code> are bad,
in my opinion: it puts buffers one on top of the other and places the
&ldquo;control panel&rdquo; in a separate Emacs frame. The first time I tried to
use it, I thought I broke my setup because it is unlike anything we
normally interact with. As such, the settings I have for
<code>ediff-split-window-function</code> and <code>ediff-window-setup-function</code> are
what I would expect Emacs maintainers to adopt as the new default. I
strongly encourage everyone to start with them.
</p>

<p>
In my workflow, the points of entry to the <code>ediff</code> feature are the
commands <code>ediff-files</code>, <code>ediff-buffers</code>. Sometimes I use the 3-way
variants with <code>ediff-files3</code> and <code>ediff-buffers3</code>, though this is rare.
Do watch the video I link to in the beginning of this section, as it
covers the main functionality of this neat tool. I also show how it
integrates with <code>magit</code> (<a href="#h:b08af527-9ebf-4425-ac3a-24b4f371a4fd">The <code>prot-emacs-git.el</code> section about <code>magit</code> (great Git client)</a>).
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">;;;; `ediff'
(use-package ediff
  :ensure nil
  :commands (ediff-buffers ediff-files ediff-buffers3 ediff-files3)
  :init
  (setq ediff-split-window-function 'split-window-horizontally)
  (setq ediff-window-setup-function 'ediff-setup-windows-plain)
  :config
  (setq ediff-keep-variants nil)
  (setq ediff-make-buffers-readonly-at-startup nil)
  (setq ediff-merge-revisions-with-ancestor t)
  (setq ediff-show-clashes-only t))
</pre>
</div>
</div>
</div>
<div id="outline-container-h:7dcbcadf-8af6-487d-b864-e4ce56d69530" class="outline-4">
<h4 id="h:7dcbcadf-8af6-487d-b864-e4ce56d69530"><span class="section-number-4">5.8.2.</span> The <code>prot-emacs-git.el</code> section about <code>project.el</code></h4>
<div class="outline-text-4" id="text-h:7dcbcadf-8af6-487d-b864-e4ce56d69530">
<p>
In Emacs parlance, a &ldquo;project&rdquo; is a collection of files and/or
directories that share the same root. The root of a project is
identified by a special file or directory, with <code>.git/</code> being one of
the defaults as it is a version control system supported by the
built-in <code>vc.el</code> (<a href="#h:50add1d8-f0f4-49be-9e57-ab280a4aa300">The <code>prot-emacs-git.el</code> section about <code>vc.el</code> and related</a>).
</p>

<p>
We can specify more project roots as a list of strings in the user
option <code>project-vc-extra-root-markers</code>. I work exclusively with Git
repositories, so I just add there a <code>.project</code> file in case I ever
need to register a project without it being controlled by <code>git</code>. In
that case, the <code>.project</code> file is just an empty file in a directory
that I want to treat as the root of this project.
</p>

<p>
The common way to switch to a project is to type <code>C-x p p</code>, which
calls the command <code>project-switch-project</code>. It lists all registered
projects and also includes a <code>... (choose a dir)</code> option. By choosing
a new directory, we register it in our project list if it has a
recognisable root. Once we select a project, we are presented with a
list of common actions to start working on the project. These are
defined in the user option <code>project-switch-commands</code> and are activated
by the final key that accesses them from the <code>C-x p</code> prefix. As such,
do <code>M-x describe-keymap</code> and check the <code>project-prefix-map</code>. For
example, I bind <code>project-dired</code> to <code>C-x p RET</code>, so <code>RET</code> accesses this
command after <code>C-x p p</code> as well.
</p>

<p>
If any of the <code>project.el</code> commands is called from outside a project,
it first prompts for a project and then carries out its action. For
example, <code>project-find-file</code> will ask for a project to use, then
switch to it, and then prompt for a file inside of the specified
project.
</p>

<p>
While inside a project, we have many commands that operate on the
project level. For example, <code>C-x p f</code> (<code>project-find-file</code>) searches
for a file across the project, while <code>C-x p b</code> (<code>project-switch-to-buffer</code>)
switches to a buffer that is specific to the project. Again, check the
<code>project-prefix-map</code> for available commands.
</p>

<p>
If not inside a project, the project-related commands will first
prompt to select a project (same as typing <code>C-x p p</code>) and then carry
out their action.
</p>

<p>
I combine projects with my <code>beframe</code> package, so that when I switch to
a project I get a new frame that limits the buffers I visit there
limited to that frame (<a href="#h:77e4f174-0c86-460d-8a54-47545f922ae9">The <code>prot-emacs-window.el</code> section about <code>beframe</code></a>).
</p>

<p>
Note that <a href="#h:654cfe49-f59d-4a0d-84ee-094ddce06848">the <code>prot-project.el</code> library</a> defines functionality that is
useful, but which I personally do not need. I am thus not including it
here, but do take a look.
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">;;;; `project'
(use-package project
  :ensure nil
  :bind
  (("C-x p ." . project-dired)
   ("C-x p C-g" . keyboard-quit)
   ("C-x p &lt;return&gt;" . project-dired)
   ("C-x p &lt;delete&gt;" . project-forget-project))
  :config
  (setopt project-switch-commands
          '((project-find-file "Find file")
            (project-find-regexp "Find regexp")
            (project-find-dir "Find directory")
            (project-dired "Root dired")
            (project-vc-dir "VC-Dir")
            (project-shell "Shell")
            (keyboard-quit "Quit")))
  (setq project-vc-extra-root-markers '(".project")) ; Emacs 29
  (setq project-key-prompt-style t) ; Emacs 30

  (advice-add #'project-switch-project :after #'prot-common-clear-minibuffer-message))

(use-package prot-project
  :ensure nil
  ;; Also check the command `prot-project-in-tab'.  I do not use it
  ;; because I prefer to manage my buffers in frames, with my
  ;; `beframe' package.
  :bind
  ( :map project-prefix-map
    ("p" . prot-project-switch)))
</pre>
</div>
</div>
</div>
<div id="outline-container-h:8b426a69-e3cd-42ac-8788-f41f6629f879" class="outline-4">
<h4 id="h:8b426a69-e3cd-42ac-8788-f41f6629f879"><span class="section-number-4">5.8.3.</span> The <code>prot-emacs-git.el</code> section about <code>diff-mode</code></h4>
<div class="outline-text-4" id="text-h:8b426a69-e3cd-42ac-8788-f41f6629f879">
<p>
This built-in mode is an easy and effective way to interact with
diffs. A &ldquo;diff&rdquo; is a Unix tradition of showing line-wise differences
in a file. If you, say, edit a line to replace <code>this</code> with <code>that</code>, the
diff output will show the original line prefixed with a minus sign and
the new line prefixed with a plus sign.
</p>

<p>
Individual words can also be highlighted. This word-wise operation is
known as &ldquo;refining&rdquo; the diff. In my setup, this is handled by the
<code>agitate</code> package, which provides convenience functions for various
version control operations. The command is <code>agitate-diff-refine-cycle</code>,
bound to <code>C-c C-b</code> inside of diff buffers.
</p>

<p>
With <code>diff-mode</code>, we can also apply the &ldquo;diff hunk&rdquo; at point, if we
have the corresponding files. The diff hunk is the section of the diff
that pertains to a given region in the file and is delimited by a
heading that enumerates the affected range, like <code>@@ -6125,7 +6125,9 @@</code>.
Type <code>C-c C-a</code> (<code>diff-apply-hunk</code>).
</p>

<p>
The <code>diff-mode</code> buffers specify the <code>outline-regexp</code>, meaning that
they can be used with the built-in <code>outline-minor-mode</code> to, for
example, fold the invidual diff hunks and move between them (<a href="#h:ffff5f7b-a62b-4d4a-ae29-af75402e5c35">The <code>prot-emacs-langs.el</code> settings for <code>outline-minor-mode</code></a>).
Personally, I combine this feature with my <code>prot-search-outline</code>
command to quickly jump to an outline heading using minibuffer
completion (<a href="#h:b902e6a3-cdd2-420f-bc99-3d973c37cd20">The <code>prot-emacs-search.el</code> extras provided by the <code>prot-search.el</code> library</a>).
</p>

<p>
Outside of Emacs, I have settings for <code>git</code> which produce more
informative diff hunk headings in Elisp and Org buffers. I wrote about
it here: <a href="https://protesilaos.com/codelog/2021-01-26-git-diff-hunk-elisp-org/">https://protesilaos.com/codelog/2021-01-26-git-diff-hunk-elisp-org/</a>.
The configurations are part of my dotfiles (linked to at the opening
section of this file).
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">;;;; `diff-mode'
(use-package diff-mode
  :ensure nil
  :defer t
  :config
  (setq diff-default-read-only t)
  (setq diff-advance-after-apply-hunk t)
  (setq diff-update-on-the-fly t)
  ;; The following are from Emacs 27.1
  (setq diff-refine nil) ; I do it on demand, with my `agitate' package (more below)
  (setq diff-font-lock-prettify t) ; I think nil is better for patches, but let me try this for a while
  (setq diff-font-lock-syntax 'hunk-also))
</pre>
</div>
</div>
</div>
<div id="outline-container-h:50add1d8-f0f4-49be-9e57-ab280a4aa300" class="outline-4">
<h4 id="h:50add1d8-f0f4-49be-9e57-ab280a4aa300"><span class="section-number-4">5.8.4.</span> The <code>prot-emacs-git.el</code> section about <code>vc.el</code> and related</h4>
<div class="outline-text-4" id="text-h:50add1d8-f0f4-49be-9e57-ab280a4aa300">
<p>
The concept of &ldquo;version control&rdquo; pertains to a system of versioning
files, to track and visualise changes from record to record
(<a href="#h:8b426a69-e3cd-42ac-8788-f41f6629f879">The <code>prot-emacs-git.el</code> section about <code>diff-mode</code></a>).
These version-controlled files may be part of a project
(<a href="#h:7dcbcadf-8af6-487d-b864-e4ce56d69530">The <code>prot-emacs-git.el</code> section about <code>project.el</code></a>).
</p>

<p>
There are many programs that fall in the category of Version Control
Software (VCS). I only use <code>git</code>, simply because it is ubiquitous
though there are others which have technical merits as well.
</p>

<p>
VCSs have some common features, such as how they record a unit of
history, and how they handle the synchronisation of their state across
computers. Because of these commonalities, Emacs is able to provide a
layer of abstraction, known as &ldquo;Version Control&rdquo;, else <code>vc.el</code> and its
accoutrements.
</p>

<p>
[ Technically, the <code>vc.el</code> file is not the only one defining relevant
  functionality. There are VCS-specific variants, such as <code>vc-git.el</code>,
  as well as complementary features like <code>vc-annotate.el</code>. All these
  are hereinafter referred to as <code>vc</code>. ]
</p>

<p>
With <code>vc</code>, we can carry out all the common actions related to version
control, such as to commit (to make a record of) changes and pull/push
them from/to the remote (i.e. the server with which we sync our
project). Whatever VCS we use, the workflow is the same:
</p>

<ul class="org-ul">
<li>Make changes to a file.</li>
<li>Type <code>C-x v v</code> (<code>vc-next-action</code>).
<ul class="org-ul">
<li>If the file is already under version control, <code>vc</code> will produce a
&ldquo;log edit&rdquo; buffer to let you commit the changes.</li>
<li>If the file is not under version control, <code>vc</code> will use a
minibuffer prompt to ask which VCS to use. These are also known as
backends and are stored in the user option <code>vc-handled-backends</code>.</li>
<li>If the file is not under version control but is in a directory
which itself is version controlled, then the file will be added to
the list of tracked files.</li>
</ul></li>
<li>Type <code>C-x v v</code> again and <code>vc</code> will proceed to the next action, which
is to commit the changes to history. This is done in the new
<code>log-edit</code> buffer.</li>
<li>By convention, the message of each commit is separated into a
summary and the body of the message. An empty line divides them. The
summary is the first line of the message and should, as a matter of
best practices, be brief yet sufficiently descriptive. The rest is
free form text. In the <code>log-edit</code> buffer, the empty separator line
between the summary and the body is shown as a border, so there is
no need to add another line there.</li>
<li>Once the message is ready, type <code>C-c C-c</code> (<code>log-edit-done</code>) to
confirm it or <code>C-c C-k</code> (<code>log-edit-kill-buffer</code>) to cancel the
operation.</li>
<li>From the <code>log-edit</code> buffer, it is possible to see the underlying
changes in a diff buffer. Do it with <code>C-c C-d</code> (<code>log-edit-show-diff</code>).</li>
<li>The record of commits to the history of the entire project is
accessed with the command <code>vc-print-root-log</code>, while that of
individual files is handled by the command <code>vc-print-log</code>.</li>
<li>To pull from a remote, do <code>vc-update</code>. To push, invoke <code>vc-push</code>.</li>
<li>A Dired-like buffer is also available to perform these actions
across many edited files. Check the commands, <code>vc-dir</code>,
<code>vc-dir-root</code>, or even <code>project-vc-dir</code>.</li>
</ul>

<p>
Remember to use <code>C-h m</code> (<code>describe-mode</code>) to get help for the buffer
you are in and to learn the relevant key bindings.
</p>

<p>
There is more functionality, though this should already give you an
overview of what is on offer. The gist is that <code>vc</code> provides a fast
and minimalist way to accomplish the basic tasks related to version
control. For more demanding operations, there is either the
command-line or the wonderful <code>magit</code> Emacs package
(<a href="#h:b08af527-9ebf-4425-ac3a-24b4f371a4fd">The <code>prot-emacs-git.el</code> section about <code>magit</code> (great Git client)</a>).
</p>

<p>
Note that in the following code block I redefine lots of key bindings.
They make more sense to me. Furthermore, my <code>agitate</code> package defines
many extras on top of <code>vc</code> that I use daily in my workflow
(<a href="#h:257b9118-4407-410e-a56a-134fd5d1a3b4">The <code>prot-emacs-git.el</code> section about <code>agitate</code></a>).
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">  ;;; Version control framework (vc.el, vc-git.el, and more)
(use-package vc
  :ensure nil
  :bind
  (;; NOTE: I override lots of the defaults
   :map global-map
   ("C-x v B" . vc-annotate) ; Blame mnemonic
   ("C-x v e" . vc-ediff)
   ("C-x v k" . vc-delete-file) ; 'k' for kill==&gt;delete is more common
   ("C-x v G" . vc-log-search)  ; git log --grep
   ("C-x v t" . vc-create-tag)
   ("C-x v c" . vc-clone) ; Emacs 31
   ("C-x v d" . vc-diff)
   ("C-x v ." . vc-dir-root) ; `vc-dir-root' is from Emacs 28
   ("C-x v &lt;return&gt;" . vc-dir-root)
   :map vc-dir-mode-map
   ("t" . vc-create-tag)
   ("O" . vc-log-outgoing)
   ("o" . vc-dir-find-file-other-window)
   ("d" . vc-diff)         ; parallel to D: `vc-root-diff'
   ("k" . vc-dir-delete-file)
   ("G" . vc-revert)
   :map vc-git-stash-shared-map
   ("a" . vc-git-stash-apply-at-point)
   ("c" . vc-git-stash) ; "create" named stash
   ("k" . vc-git-stash-delete-at-point) ; symmetry with `vc-dir-delete-file'
   ("p" . vc-git-stash-pop-at-point)
   ("s" . vc-git-stash-snapshot)
   :map vc-annotate-mode-map
   ("M-q" . vc-annotate-toggle-annotation-visibility)
   ("C-c C-c" . vc-annotate-goto-line)
   ("&lt;return&gt;" . vc-annotate-find-revision-at-line)
   :map log-edit-mode-map
   ("M-s" . nil) ; I use M-s for my search commands
   ("M-r" . nil) ; I use `consult-history'
   :map log-view-mode-map
   ("&lt;tab&gt;" . log-view-toggle-entry-display)
   ("&lt;return&gt;" . log-view-find-revision)
   ("s" . vc-log-search)
   ("o" . vc-log-outgoing)
   ("f" . vc-log-incoming)
   ("F" . vc-update)
   ("P" . vc-push))
  :init
  (setq vc-follow-symlinks t)
  :config
  ;; Those offer various types of functionality, such as blaming,
  ;; viewing logs, showing a dedicated buffer with changes to affected
  ;; files.
  (require 'vc-annotate)
  (require 'vc-dir)
  (require 'vc-git)
  (require 'add-log)
  (require 'log-view)

  ;; I only use Git.  If I ever need another, I will include it here.
  ;; This may have an effect on performance, as Emacs will not try to
  ;; check for a bunch of backends.
  (setq vc-handled-backends '(Git))

  ;; This one is for editing commit messages.
  (require 'log-edit)
  (setq log-edit-confirm 'changed)
  (setq log-edit-keep-buffer nil)
  (setq log-edit-require-final-newline t)
  (setq log-edit-setup-add-author nil)
  ;; I can see the files from the Diff with C-c C-d
  (remove-hook 'log-edit-hook #'log-edit-show-files)

  (setq vc-find-revision-no-save t)
  (setq vc-annotate-display-mode 'scale) ; scale to oldest
  ;; I use a different account for git commits
  (setq add-log-mailing-address "info@protesilaos.com")
  (setq add-log-keep-changes-together t)
  (setq vc-git-diff-switches '("--patch-with-stat" "--histogram"))
  (setq vc-git-log-switches '("--stat"))
  (setq vc-git-print-log-follow t)
  (setq vc-git-revision-complete-only-branches nil) ; Emacs 28
  (setq vc-git-root-log-format
        `("%d %h %ai %an: %s"
          ;; The first shy group matches the characters drawn by --graph.
          ;; We use numbered groups because `log-view-message-re' wants the
          ;; revision number to be group 1.
          ,(concat "^\\(?:[*/\\|]+\\)\\(?:[*/\\| ]+\\)?"
                   "\\(?2: ([^)]+) \\)?\\(?1:[0-9a-z]+\\) "
                   "\\(?4:[0-9]\\{4\\}-[0-9-]\\{4\\}[0-9\s+:-]\\{16\\}\\) "
                   "\\(?3:.*?\\):")
          ((1 'log-view-message)
           (2 'change-log-list nil lax)
           (3 'change-log-name)
           (4 'change-log-date))))

  ;; These two are from Emacs 29
  (setq vc-git-log-edit-summary-target-len 50)
  (setq vc-git-log-edit-summary-max-len 70))
</pre>
</div>
</div>
</div>
<div id="outline-container-h:257b9118-4407-410e-a56a-134fd5d1a3b4" class="outline-4">
<h4 id="h:257b9118-4407-410e-a56a-134fd5d1a3b4"><span class="section-number-4">5.8.5.</span> The <code>prot-emacs-git.el</code> section about <code>agitate</code></h4>
<div class="outline-text-4" id="text-h:257b9118-4407-410e-a56a-134fd5d1a3b4">
<p>
This is an experimental package of mine whose role is to extend the
functionality provided by the <code>vc</code> suite of tools (<a href="#h:50add1d8-f0f4-49be-9e57-ab280a4aa300">The <code>prot-emacs-git.el</code> section about <code>vc.el</code> and related</a>),
as well as that of <code>diff-mode</code> (<a href="#h:8b426a69-e3cd-42ac-8788-f41f6629f879">The <code>prot-emacs-git.el</code> section about <code>diff-mode</code></a>).
What <code>agitate</code> does is define several commands that are in the spirit
of those built-in tools.
</p>

<p>
Because it is (i) an experimental package and (ii) <code>vc</code> is probably a
niche feature, I will not document much here.
</p>

<p>
Agitate is a collection of commands or potentially useful functions
that expand on the available version control features of Emacs.  Those
are meant to complement a workflow that relies on the built-in Version
Control framework and its accoutrements (`diff-mode.el`,
`log-view.el`, `log-edit.el`, `vc-git.el`, and potentially others).
</p>

<ul class="org-ul">
<li>Package name (GNU ELPA): <code>agitate</code></li>
<li>Official manual: <a href="https://protesilaos.com/emacs/agitate">https://protesilaos.com/emacs/agitate</a></li>
<li>Git repositories:
<ul class="org-ul">
<li>GitHub: <a href="https://github.com/protesilaos/agitate">https://github.com/protesilaos/agitate</a></li>
<li>GitLab: <a href="https://gitlab.com/protesilaos/agitate">https://gitlab.com/protesilaos/agitate</a></li>
</ul></li>
<li>Backronym: Another Git Interface Trying to Agitate Tranquil Emacsers</li>
</ul>

<div class="org-src-container">
<pre class="src src-emacs-lisp">;;; Agitate
;; A package of mine to complement VC and friends.  Read the manual
;; here: &lt;https://protesilaos.com/emacs/agitate&gt;.
(use-package agitate
  :ensure t
  :hook
  ((diff-mode . agitate-diff-enable-outline-minor-mode)
   (after-init . agitate-log-edit-informative-mode))
  :bind
  ( :map global-map
    ("C-x v =" . agitate-diff-buffer-or-file) ; replace `vc-diff'
    ("C-x v g" . agitate-vc-git-grep) ; replace `vc-annotate'
    ("C-x v f" . agitate-vc-git-find-revision)
    ("C-x v s" . agitate-vc-git-show)
    ("C-x v w" . agitate-vc-git-kill-commit-message)
    ("C-x v p p" . agitate-vc-git-format-patch-single)
    ("C-x v p n" . agitate-vc-git-format-patch-n-from-head)
    :map diff-mode-map
    ("C-c C-b" . agitate-diff-refine-cycle) ; replace `diff-refine-hunk'
    ("C-c C-n" . agitate-diff-narrow-dwim)
    ("L" . vc-print-root-log)
    ;; Emacs 29 can use C-x v v in diff buffers, which is great, but now I
    ;; need quick access to it...
    ("v" . vc-next-action)
    :map log-view-mode-map
    ("w" . agitate-log-view-kill-revision)
    ("W" . agitate-log-view-kill-revision-expanded)
    :map vc-git-log-view-mode-map
    ("c" . agitate-vc-git-format-patch-single)
    :map log-edit-mode-map
    ("C-c C-i C-n" . agitate-log-edit-insert-file-name)
    ;; See user options `agitate-log-edit-emoji-collection' and
    ;; `agitate-log-edit-conventional-commits-collection'.
    ("C-c C-i C-e" . agitate-log-edit-emoji-commit)
    ("C-c C-i C-c" . agitate-log-edit-conventional-commit))
  :config
  (advice-add #'vc-git-push :override #'agitate-vc-git-push-prompt-for-remote)

  (setq agitate-log-edit-informative-show-root-log nil
        agitate-log-edit-informative-show-files nil))
</pre>
</div>
</div>
</div>
<div id="outline-container-h:b08af527-9ebf-4425-ac3a-24b4f371a4fd" class="outline-4">
<h4 id="h:b08af527-9ebf-4425-ac3a-24b4f371a4fd"><span class="section-number-4">5.8.6.</span> The <code>prot-emacs-git.el</code> section about <code>magit</code> (great Git client)</h4>
<div class="outline-text-4" id="text-h:b08af527-9ebf-4425-ac3a-24b4f371a4fd">
<p>
The <code>magit</code> package, maintained by Jonas Bernoulli, is the best
front-end to <code>git</code> I have ever used. Not only is it excellent at
getting the job done, it also helps you learn more about what <code>git</code>
has to offer.
</p>

<p>
At the core of its interface is <code>transient</code>. This is a library that
was originally developed as Magit-specific code that was then
abstracted away and ultimately incorporated into Emacs version 29.
With <code>transient</code>, we get a window pop up with keys and commands
corresponding to them. The window is interactive, as the user can set
a value or toggle an option and have it take effect when the relevant
command is eventually invoked. For <code>git</code>, in particular, this
interface is a genious way to surface the plethora of options.
</p>

<p>
To start, call the command <code>magit-status</code>. It brings up a buffer that
shows information about the state of the repository. Sections include
an overview of the current <code>HEAD</code>, untracked files, unstaged changes,
staged changes, and recent commits. Each section&rsquo;s visibility state
can be cycled by pressing <code>TAB</code> (variations of this are available&#x2014;remember
to do <code>C-h m</code> (<code>describe-mode</code>) in an unfamiliar major mode to get
information about its key bindings).
</p>

<p>
From the status buffer, we can perform all the usual version control
operations. By typing <code>?</code> (<code>magit-dispatch</code>), we bring up the main
<code>transient</code> menu, with keys that then bring up their own submenus,
such as for viewing commit logs, setting the remotes, switching
branches, etc.
</p>

<p>
Before I used <code>magit</code>, I only knew the basics of adding files for a
commit, writing a commit message inline with the <code>-m</code> flag on the
command line, and pushing to the remote. Magit shows the staging
area in the status buffer and makes &ldquo;staging&rdquo; a key part of the
process of committing changes to history. To stage something, is to
make it a candidate for the next commit action: only the staged parts
are committed.
</p>

<p>
Magit has a refined understanding of context. We can target an
individual line, a single diff hunk, a single file, or a range of
files for staging or unstaging (among others). If the region is
active, then only the selection is affected. If the cursor is on or
somewhere inside a diff hunk, then that is targeted. If the cursor is
over a file, then the file is the target. Same idea for the section
heading, which then extends to everything under it.
</p>

<p>
This contextuality extends to every <code>git</code> command that accepts a
commit hash as an argument. For example, if we are in a Magit commit
log view and want to do a hard reset on the commit at point, Magit
knows what commit hash to use (and presents it as an option when we
choose where to reset to). Same principle for rebasing, cherry
picking, and more.
</p>

<p>
Magit is good for newer users but also for those who have experience
with <code>git</code> and the command-line in general. With it, I can easily
maintain a project that needs to track separate remotes and push/pull
between them in a fairly complicated manner. Partly supported by
<code>transient</code> and partly by the Emacs completion user interface, we have
all we need to select targets with ease (<a href="#h:15edf2c3-4419-4101-928a-6e224958a741">The <code>prot-emacs-completion.el</code> module</a>).
</p>

<p>
The only downside of this wonderful package is that it is slow on
Windows (based on what others have told me and showed me)&#x2026; In those
cases, a combination of <code>vc</code> and the command-line will suffice
(<a href="#h:50add1d8-f0f4-49be-9e57-ab280a4aa300">The <code>prot-emacs-git.el</code> section about <code>vc.el</code> and related</a>).
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">;;; Interactive and powerful git front-end (Magit)
(use-package transient
  :defer t
  :config
  (setq transient-show-popup 0.5))

(use-package magit
  :ensure t
  :bind ("C-c g" . magit-status)
  :init
  (setq magit-define-global-key-bindings nil)
  (setq magit-section-visibility-indicator '("⮧"))
  :config
  (setq git-commit-summary-max-length 50)
  ;; NOTE 2023-01-24: I used to also include `overlong-summary-line'
  ;; in this list, but I realised I do not need it.  My summaries are
  ;; always in check.  When I exceed the limit, it is for a good
  ;; reason.
  (setq git-commit-style-convention-checks '(non-empty-second-line))

  (setq magit-diff-refine-hunk t))

(use-package magit-repos
  :ensure nil ; part of `magit'
  :commands (magit-list-repositories)
  :init
  (setq magit-repository-directories
        '(("~/Git/Projects" . 1))))
</pre>
</div>
</div>
</div>
<div id="outline-container-h:4e7035c5-9350-4c51-be85-85f2539ed295" class="outline-4">
<h4 id="h:4e7035c5-9350-4c51-be85-85f2539ed295"><span class="section-number-4">5.8.7.</span> The <code>prot-emacs-git.el</code> call to <code>provide</code></h4>
<div class="outline-text-4" id="text-h:4e7035c5-9350-4c51-be85-85f2539ed295">
<p>
Finally, we <code>provide</code> the module. This is the mirror function of
<code>require</code> (<a href="#h:e6c4acf5-5b51-4b38-a86a-bf3f698ac872">The init.el final part to load the individual modules</a>).
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(provide 'prot-emacs-git)
</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-h:d799c3c0-bd6a-40bb-bd1a-ba4ea5367840" class="outline-3">
<h3 id="h:d799c3c0-bd6a-40bb-bd1a-ba4ea5367840"><span class="section-number-3">5.9.</span> The <code>prot-emacs-org.el</code> module</h3>
<div class="outline-text-3" id="text-h:d799c3c0-bd6a-40bb-bd1a-ba4ea5367840">
<p>
Watch:
</p>

<ul class="org-ul">
<li><a href="https://protesilaos.com/codelog/2023-12-18-emacs-org-advanced-literate-conf/">Advanced literate configuration with Org</a> (2023-12-18)</li>
<li><a href="https://protesilaos.com/codelog/2023-05-23-emacs-org-basics/">Basics of Org mode</a> (2023-05-23)</li>
<li><a href="https://protesilaos.com/codelog/2021-12-09-emacs-org-block-agenda/">Demo of my custom Org block agenda</a> (2021-12-09)</li>
<li><a href="https://protesilaos.com/codelog/2020-02-04-emacs-org-capture-intro/">Primer on &ldquo;org-capture&rdquo;</a> (2020-02-04)</li>
</ul>

<p>
At its core, Org is a plain text markup language. By &ldquo;markup
language&rdquo;, we refer to the use of common characters to apply styling,
such as how a word wrapped in asterisks acquires strong emphasis.
Check the video I link to above on the basics of Org mode.
</p>

<p>
Though what makes Org powerful is not the markup per se, but the fact
that it has a rich corpus of Emacs Lisp code that does a lot with this
otherwise plain text notation. Some of the headline features:
</p>

<ul class="org-ul">
<li>Cycle the visibility of any heading and its subheadings. This lets
you quickly fold a section you do not need to see (or reveal the one
you care about).</li>
<li>Mix prose with code in a single document to either make the whole
thing an actual program or to evaluate/demonstrate some snippets.</li>
<li>Convert (&ldquo;export&rdquo;) an Org file to a variety of formats, including
HTML and PDF.</li>
<li>Use LaTeX inside of Org files to produce a scientific paper without
all the markup of LaTeX.</li>
<li>Manage TODO lists and implement a concomitant methodology of
labelling task states.</li>
<li>Quickly shift a &ldquo;thing&rdquo; (heading, list item, paragraph, &#x2026;) further
up or down in the file.</li>
<li>Use tables with formulas as a lightweight alternative to spreadsheet
software.</li>
<li>Capture data or fleeting thoughts efficiently using templates.</li>
<li>Maintain an agenda for all your date-bound activities.</li>
<li>Clock in and out of tasks, to eventually track how you are spending
your time.</li>
<li>Link to files regardless of file type. This includes special links
such as to an Info manual or an email, if you also have that running
locally and integrated with Emacs (<a href="#h:755e195b-9471-48c7-963b-33055969b4e2">The <code>prot-emacs-email.el</code> module</a>).</li>
</ul>

<p>
In other words, Org is highly capable and widely considered one of the
killer apps of Emacs.
</p>

<p>
This section covers the relevant configurations. You will notice that
it is not limited to Org, as some other built-in features are also
relevant here.
</p>
</div>
<div id="outline-container-h:94d48381-1711-4d6b-8449-918bc1e3836c" class="outline-4">
<h4 id="h:94d48381-1711-4d6b-8449-918bc1e3836c"><span class="section-number-4">5.9.1.</span> The <code>prot-emacs-org.el</code> section on the <code>calendar</code></h4>
<div class="outline-text-4" id="text-h:94d48381-1711-4d6b-8449-918bc1e3836c">
<p>
The <code>calendar</code> is technically independent of Org, though it tightly
integrates with it. We witness this when we are setting timestamps,
such as while setting a <code>SCHEDULED</code> or <code>DEADLINE</code> entry for a given
heading. All I do here is set some stylistic preferences.
</p>

<p>
Note that Emacs also has a <code>diary</code> command. I used it for a while, but
Org is far more capable, so I switched to it completely.
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">;;; Calendar
(use-package calendar
  :ensure nil
  :commands (calendar)
  :config
  (setq calendar-mark-diary-entries-flag nil)
  (setq calendar-mark-holidays-flag t)
  (setq calendar-mode-line-format nil)
  (setq calendar-time-display-form
        '( 24-hours ":" minutes
           (when time-zone (format "(%s)" time-zone))))
  (setq calendar-week-start-day 1)      ; Monday
  (setq calendar-date-style 'iso)
  (setq calendar-time-zone-style 'numeric) ; Emacs 28.1

  (require 'solar)
  (setq calendar-latitude 35.17         ; Not my actual coordinates
        calendar-longitude 33.36)

  (require 'cal-dst)
  (setq calendar-standard-time-zone-name "+0200")
  (setq calendar-daylight-time-zone-name "+0300"))
</pre>
</div>
</div>
</div>
<div id="outline-container-h:bd4b0dcb-a925-4bd7-90db-6379a7ca6f5e" class="outline-4">
<h4 id="h:bd4b0dcb-a925-4bd7-90db-6379a7ca6f5e"><span class="section-number-4">5.9.2.</span> The <code>prot-emacs-org.el</code> section about appointment reminders (<code>appt.el</code>)</h4>
<div class="outline-text-4" id="text-h:bd4b0dcb-a925-4bd7-90db-6379a7ca6f5e">
<p>
The built in <code>appt.el</code> defines functionality for handling
notifications about appointments. It is originally designed to work
with the generic diary feature (the <code>M-x diary</code> one, I mean), which I
do not use anymore, but also integrates nicely with the Org agenda
(<a href="#h:7fe87b83-2815-4617-a5f9-d3417dd9d248">The <code>prot-emacs-org.el</code> Org agenda settings</a>). I deepen this
integration further, such that after adding a task or changing its
state, the appointments mechanism re-reads my data to register new
notifications. This is done via a series of hooks and with the use of
the advice feature of Emacs Lisp.
</p>

<p>
Here I am setting some simple settings to keep appointment notifations
minimal. I do not need them to inform me about the contents of my next
entry on the agenda: just show text on the mode line telling me how
many minutes are left until the event.
</p>

<p>
In Org files, every heading can have an <code>APPT_WARNTIME</code> property: it takes
a numeric value representing minutes for a forewarning from <code>appt.el</code>.
I use this in tandem with <code>org-capture</code> for tasks that need to be
done at a specific time, such as coaching sessions (<a href="#h:f8f06938-0dfe-45c3-b4cf-996d36cba82d">The <code>prot-emacs-org.el</code> Org capture templates (<code>org-capture</code>)</a>).
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">;;; Appt (appointment reminders which also integrate with Org agenda)
(use-package appt
  :ensure nil
  :commands (appt-activate)
  :config
  (setq appt-display-diary nil
        appt-display-format nil
        appt-display-mode-line t
        appt-display-interval 3
        appt-audible nil ; TODO 2023-01-25: t does nothing because I disable `ring-bell-function'?
        appt-warning-time-regexp "appt \\([0-9]+\\)" ; This is for the diary
        appt-message-warning-time 6)

  (with-eval-after-load 'org-agenda
    (appt-activate 1)

    ;; NOTE 2021-12-07: In my `prot-org.el' (see further below), I add
    ;; `org-agenda-to-appt' to various relevant hooks.
    ;;
    ;; Create reminders for tasks with a due date when this file is read.
    (org-agenda-to-appt)))
</pre>
</div>
</div>
</div>
<div id="outline-container-h:e03df1e0-b43e-49b5-978e-6a511165617c" class="outline-4">
<h4 id="h:e03df1e0-b43e-49b5-978e-6a511165617c"><span class="section-number-4">5.9.3.</span> The <code>prot-emacs-org.el</code> section with basic Org settings</h4>
<div class="outline-text-4" id="text-h:e03df1e0-b43e-49b5-978e-6a511165617c">
<p>
Org, also known as &ldquo;Org mode&rdquo;, is one of the potentially most useful
feature sets available to every Emacs user. At its core, Org is a
lightweight markup language: you can have headings and paragraphs,
mark a portion of text with emphasis, produce bullet lists, include
code blocks, and the like. Though what really sets Org apart from
other markup languages is the rich corpus of Emacs Lisp written around
it to do all sorts of tasks with this otherwise plain text format.
</p>

<p>
With Org you can write technical documents (e.g. the manuals of all my
Emacs packages), maintain a simple or highly sophisticated system for
task management, organise your life using the agenda, write tables
that can evaluate formulas to have spreadsheet functionality, have
embedded LaTeX, evaluate code blocks in a wide range of programming
languages and reuse their results for literate programming, include
the contents of other files into a singular file, use one file to
generate other files/directories with all their contents, and export
the Org document to a variety of formats like <code>.pdf</code> and <code>.odt</code>.
Furthermore, Org can be used as a lightweight, plain text database, as
each heading can have its own metadata. This has practical
applications in most of the aforementioned.
</p>

<p>
In short, if something can be done with plain text, Org probably does
it already or has all the elements for piecing it together. This
document, among many of my published works, is testament to Org&rsquo;s
sheer power, which I explained at greater length in a video
demonstration: <a href="https://protesilaos.com/codelog/2023-12-18-emacs-org-advanced-literate-conf/">Advanced literate configuration with Org</a> (2023-12-18).
</p>

<p>
This being Emacs, everything is customisable and Org is a good example
of this. There are a lot of user options for us to tweak things to our
liking. I do as much, though know that Org is perfectly usable without
any configuration. The following sections contain further commentary
on how I use Org.
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">;;; Org-mode (personal information manager)
(use-package org
  :ensure nil
  :init
  (setq org-directory (expand-file-name "~/Documents/org/"))
  (setq org-imenu-depth 7)

  (add-to-list 'safe-local-variable-values '(org-hide-leading-stars . t))
  (add-to-list 'safe-local-variable-values '(org-hide-macro-markers . t))
  :bind
  ( :map global-map
    ("C-c l" . org-store-link)
    ("C-c o" . org-open-at-point-global)
    :map org-mode-map
    ;; I don't like that Org binds one zillion keys, so if I want one
    ;; for something more important, I disable it from here.
    ("C-'" . nil)
    ("C-," . nil)
    ("M-;" . nil)
    ("&lt;C-return&gt;" . nil)
    ("&lt;C-S-return&gt;" . nil)
    ("C-M-S-&lt;right&gt;" . nil)
    ("C-M-S-&lt;left&gt;" . nil)
    ("C-c ;" . nil)
    ("C-c M-l" . org-insert-last-stored-link)
    ("C-c C-M-l" . org-toggle-link-display)
    ("M-." . org-edit-special) ; alias for C-c ' (mnenomic is global M-. that goes to source)
    :map org-src-mode-map
    ("M-," . org-edit-src-exit) ; see M-. above
    :map narrow-map
    ("b" . org-narrow-to-block)
    ("e" . org-narrow-to-element)
    ("s" . org-narrow-to-subtree)
    :map ctl-x-x-map
    ("i" . prot-org-id-headlines)
    ("r" . prot-org-id-headlines-readable)
    ("h" . prot-org-ox-html))
  :config
  ;; My custom extras, which I use for the agenda and a few other Org features.
  (require 'prot-org)

;;;; general settings
  (setq org-ellipsis "⮧")
  (setq org-adapt-indentation nil)      ; No, non, nein, όχι!
  (setq org-special-ctrl-a/e nil)
  (setq org-special-ctrl-k nil)
  (setq org-M-RET-may-split-line '((default . nil)))
  (setq org-hide-emphasis-markers nil)
  (setq org-hide-macro-markers nil)
  (setq org-hide-leading-stars nil)
  (setq org-cycle-separator-lines 0)
  (setq org-structure-template-alist
        '(("s" . "src")
          ("e" . "src emacs-lisp")
          ("E" . "src emacs-lisp :results value code :lexical t")
          ("t" . "src emacs-lisp :tangle FILENAME")
          ("T" . "src emacs-lisp :tangle FILENAME :mkdirp yes")
          ("x" . "example")
          ("X" . "export")
          ("q" . "quote")))
  (setq org-fold-catch-invisible-edits 'show)
  (setq org-return-follows-link nil)
  (setq org-loop-over-headlines-in-active-region 'start-level)
  (setq org-modules '(ol-info ol-eww))
  (setq org-use-sub-superscripts '{})
  (setq org-insert-heading-respect-content t)
  (setq org-read-date-prefer-future 'time)
  (setq org-highlight-latex-and-related nil) ; other options affect elisp regexp in src blocks
  (setq org-fontify-quote-and-verse-blocks t)
  (setq org-fontify-whole-block-delimiter-line t)
  (setq org-track-ordered-property-with-tag t)
  (setq org-highest-priority ?A)
  (setq org-lowest-priority ?C)
  (setq org-default-priority ?A)
  (setq org-priority-faces nil)

  ;; See my `pulsar' package, defined elsewhere in this setup.
  (with-eval-after-load 'pulsar
    (dolist (hook '(org-agenda-after-show-hook org-follow-link-hook))
      (add-hook hook #'pulsar-recenter-center)
      (add-hook hook #'pulsar-reveal-entry))))
</pre>
</div>
</div>
</div>
<div id="outline-container-h:024dd541-0061-4a10-b10b-b17dcd4794b9" class="outline-4">
<h4 id="h:024dd541-0061-4a10-b10b-b17dcd4794b9"><span class="section-number-4">5.9.4.</span> The <code>prot-emacs-org.el</code> Org to-do and refile settings</h4>
<div class="outline-text-4" id="text-h:024dd541-0061-4a10-b10b-b17dcd4794b9">
<p>
One of the many use-cases for Org is to maintain a plain text to-do
list. A heading that starts with a to-do keyword, such as <code>TODO</code> is
treated as a task and its state is considered not completed.
</p>

<p>
We can switch between the task states with shift and the left or right
arrow keys. Or we can select a keyword directly with <code>C-c C-t</code>, which
calls <code>org-todo</code> by default. I personally prefer the latter approach,
as it is more precise.
</p>

<p>
Whenever a task state changes, we can log that event in a special
<code>LOGBOOK</code> drawer. This is automatically placed right below the
heading, before any paragraph text. Logging data is an opt-in feature,
which I consider helpful (<a href="#h:0884658e-9eb5-47e3-9338-66e09004a1a0">The <code>prot-emacs-org.el</code> Org time/state logging</a>).
</p>

<p>
Tasks can be associated with timestamps, typically a scheduled
date+time or a deadline+time. This can be helpful when we are
reviewing the source Org file, though it really shines in tandem with
the agenda. Any heading that has a timestamp and which belongs to a
file in the <code>org-agenda-files</code> will show up on the agenda in the given
date (<a href="#h:7fe87b83-2815-4617-a5f9-d3417dd9d248">The <code>prot-emacs-org.el</code> Org agenda settings</a>).
</p>

<p>
By default, the <code>org-todo-keywords</code> are <code>TODO</code> and <code>DONE</code>. We can
write more keywords if we wish to implement a descriptive workflow.
For example, we can have a <code>WAIT</code> keyword for something that is to be
done but is not actionable yet. While the number of keywords is not
limited, the binary model is the same: we have words that represent
the incomplete state and those that count as the completion of the
task. For instance, both <code>CANCEL</code> and <code>DONE</code> mean that the task is not
actionable anymore and we move on to other things. As such, the extra
keywords are a way for the user to make tasks more descriptive and
easy to find. In the value of the <code>org-todo-keywords</code>, we use the bar
character to separate the incomplete state to the left from the
completed one to the right.
</p>

<p>
One of the agenda&rsquo;s headiline features is the ability to produce a
view that lists headings with the given keyword. So having the right
terms can make search and retrieval of data more easy. On the
flip-side, too many keywords add cognitive load and require more
explicit search terms to yield the desired results. I used to work
with a more descriptive set of keywords, but ultimately decided to
keep things simple.
</p>

<p>
The refile mechanism is how we can reparent a heading, by moving it
from one place to another. We do this with the command <code>org-refile</code>,
bound to <code>C-c C-w</code> by default. A common workflow where refiling is
essential is to have an &ldquo;inbox&rdquo; file or heading, where unprocessed
information is stored at, and periodically process its contents to
move the data where it belongs. Though it can also work fine without
any such inbox, in those cases where a heading should be stored
someplace else. The <code>org-refile-targets</code> specifies the files that are
available when we try to refile the current heading. With how I set it
up, all the agenda files plus the current file&rsquo;s headings up to level
2 are included as possible targets.
</p>

<p>
In terms of workflow, I have not done a refile in a very long time,
because my entries always stay in the same place as I had envisaged at
the capture phase (<a href="#h:f8f06938-0dfe-45c3-b4cf-996d36cba82d">The <code>prot-emacs-org.el</code> Org capture templates (<code>org-capture</code>)</a>).
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">;;;; refile, todo
(use-package org
  :ensure nil
  :config
  (setq org-refile-targets
        '((org-agenda-files . (:maxlevel . 2))
          (nil . (:maxlevel . 2))))
  (setq org-refile-use-outline-path t)
  (setq org-refile-allow-creating-parent-nodes 'confirm)
  (setq org-refile-use-cache t)
  (setq org-reverse-note-order nil)
  ;; ;; NOTE 2023-04-07: Leaving this here for demo purposes.
  ;; (setq org-todo-keywords
  ;;       '((sequence "TODO(t)" "MAYBE(m)" "WAIT(w@/!)" "|" "CANCEL(c@)" "DONE(d!)")
  ;;         (sequence "COACH(k)" "|" "COACHED(K!)")))
  (setq org-todo-keywords
        '((sequence "TODO(t)" "|" "CANCEL(c@)" "DONE(d!)")
          (sequence "COACH(k)" "|" "COACHED(K!)")))

  (defface prot/org-bold-done
    '((t :inherit (bold org-done)))
    "Face for bold DONE-type Org keywords.")

  (setq org-todo-keyword-faces
        '(("CANCEL" . prot/org-bold-done)))
  (setq org-use-fast-todo-selection 'expert)

  (setq org-fontify-done-headline nil)
  (setq org-fontify-todo-headline nil)
  (setq org-fontify-whole-heading-line nil)
  (setq org-enforce-todo-dependencies t)
  (setq org-enforce-todo-checkbox-dependencies t))
</pre>
</div>
</div>
</div>
<div id="outline-container-h:81de4e32-a1af-4e1f-9e10-90eb0c90afa2" class="outline-4">
<h4 id="h:81de4e32-a1af-4e1f-9e10-90eb0c90afa2"><span class="section-number-4">5.9.5.</span> The <code>prot-emacs-org.el</code> Org heading tags</h4>
<div class="outline-text-4" id="text-h:81de4e32-a1af-4e1f-9e10-90eb0c90afa2">
<p>
Each Org heading can have one or more tags associated with it, while
all headings inherit any potential <code>#+FILETAGS</code>. We can add tags to a
heading when the cursor is over it by typing the ever flexible <code>C-c C-c</code>.
Though the more specific <code>org-set-tags-command</code> also gets the job
done, plus it does not require that the cursor is positioned on the
heading text.
</p>

<p>
Tagging is useful for searching and retrieving the data we store. The
Org agenda, in particular, provides commands to filter tasks by tag:
</p>

<ul class="org-ul">
<li><a href="#h:024dd541-0061-4a10-b10b-b17dcd4794b9">The <code>prot-emacs-org.el</code> Org to-do and refile settings</a></li>
<li><a href="#h:7fe87b83-2815-4617-a5f9-d3417dd9d248">The <code>prot-emacs-org.el</code> Org agenda settings</a></li>
</ul>

<p>
The user option <code>org-tag-alist</code> lets us specify tags we always want to
use, though we can write tags per file as well by using the <code>#+TAGS</code>
keyword. I do the latter as a global list of tags is not useful in my
case. For example, when I wan checking my <code>coach.org</code> file for the
coaching sessions I provide, I do not need to see any of the tags that
make sense in my general <code>tasks.org</code>.
</p>

<p>
Note that in the settings below I disable the auto-alignment that Org
does where it shifts tags to the right of the heading. I do not like
it.
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">;;;; tags
(use-package org
  :ensure nil
  :config
  (setq org-tag-alist nil)
  (setq org-auto-align-tags nil)
  (setq org-tags-column 0))
</pre>
</div>
</div>
</div>
<div id="outline-container-h:0884658e-9eb5-47e3-9338-66e09004a1a0" class="outline-4">
<h4 id="h:0884658e-9eb5-47e3-9338-66e09004a1a0"><span class="section-number-4">5.9.6.</span> The <code>prot-emacs-org.el</code> Org time/state logging</h4>
<div class="outline-text-4" id="text-h:0884658e-9eb5-47e3-9338-66e09004a1a0">
<p>
Org can keep a record of state changes, such as when we set an entry
marked with the <code>TODO</code> keyword as <code>DONE</code> or when we reschedule an
appointment (<a href="#h:7fe87b83-2815-4617-a5f9-d3417dd9d248">The <code>prot-emacs-org.el</code> Org agenda settings</a>). This data
is stored in a <code>LOGBOOK</code> drawer right below the heading. I choose to
keep track of this information, as it is sometimes useful to capture
mistakes or figure out intent in the absence of further clarification
(though I do tend to write why something happened).
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">;;;; log
(use-package org
  :ensure nil
  :config
  (setq org-log-done 'time)
  (setq org-log-into-drawer t)
  (setq org-log-note-clock-out nil)
  (setq org-log-redeadline 'time)
  (setq org-log-reschedule 'time))
</pre>
</div>
</div>
</div>
<div id="outline-container-h:da8ce883-7f21-4a6e-a41f-d668ad762b41" class="outline-4">
<h4 id="h:da8ce883-7f21-4a6e-a41f-d668ad762b41"><span class="section-number-4">5.9.7.</span> The <code>prot-emacs-org.el</code> Org link settings</h4>
<div class="outline-text-4" id="text-h:da8ce883-7f21-4a6e-a41f-d668ad762b41">
<p>
One of the nice things about Org is its flexible linking mechanism. It
can produce links to a variety of file types or buffers and even
navigate to a section therein.
</p>

<p>
At its simplest form, we have the <code>file</code> link type, which points to a
file system path, with an optional extension for a match inside the
file, as documented in the manual. Evaluate this inside of Emacs:
</p>

<pre class="example" id="orgdee91cd">
(info "(org) Search Options")
</pre>

<p>
Links to buffers are also common and valuable. For example, we can
have a link to a page produced by the <code>man</code> command, which gives us
quick access to the documentation of some program. When Org follows
that link, it opens the buffer in the appropriate major mode. For me,
the most common scenario is a link to an email, which I typically
associate with a task that shows up in my agenda:
</p>

<ul class="org-ul">
<li><a href="#h:f8f06938-0dfe-45c3-b4cf-996d36cba82d">The <code>prot-emacs-org.el</code> Org capture templates (<code>org-capture</code>)</a></li>
<li><a href="#h:49890997-448e-408d-bebe-2003259bb125">The <code>prot-emacs-notmuch.el</code> glue code for <code>org-capture</code> (<code>ol-notmuch.el</code>)</a></li>
</ul>

<p>
Org supports lots of link types out-of-the-box, though more can be
added by packages. My Denote does this: it defines a <code>denote</code> link
type which behaves the same way as the <code>file</code> type except that it uses
the identifier of the file instead of its full path (so eve if the
file is renamed, the link will work for as long as the identifier
remains the same).
</p>

<p>
Links can be generated automatically as part of an <code>org-capture</code>
template. The command <code>org-store-link</code> produces one manually, storing
it to a special data structure from which it can be retrieved later
for insertion with the command <code>org-insert-link</code>. The latter command
can also create new links, simply by receiving data that is different
from what was already stored.
</p>

<p>
I bind <code>org-store-link</code> in main section of the Org configuration:
<a href="#h:e03df1e0-b43e-49b5-978e-6a511165617c">The <code>prot-emacs-org.el</code> section with basic Org settings</a>.
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">;;;; links
(use-package org
  :ensure nil
  :config
  (require 'prot-org) ; for the above commands

  (setq org-link-context-for-files t)
  (setq org-link-keep-stored-after-insertion nil)
  (setq org-id-link-to-org-use-id 'create-if-interactive-and-no-custom-id))
</pre>
</div>
</div>
</div>
<div id="outline-container-h:1f5a0d46-5202-48dd-8048-b48ce17f3df8" class="outline-4">
<h4 id="h:1f5a0d46-5202-48dd-8048-b48ce17f3df8"><span class="section-number-4">5.9.8.</span> The <code>prot-emacs-org.el</code> Org code block settings</h4>
<div class="outline-text-4" id="text-h:1f5a0d46-5202-48dd-8048-b48ce17f3df8">
<p>
This document benefits from Org&rsquo;s ability to combine prose with code,
by placing the latter inside of a block that is delimited by
<code>#+BEGIN_SRC</code> and <code>#+END_SRC</code> lines.
</p>

<p>
Code blocks can use the syntax highlighting (&ldquo;fontification&rdquo; in Emacs
parlance) of a given major mode. They can also have optional
parameters passed to their header, which expand the capabilities of
the block. For instance, the following code block with my actual
configuration uses the fontification of the <code>emacs-lisp-mode</code> and has
a <code>:tangle</code> parameter with a value of a file system path. When I
invoke the command <code>org-babel-tangle</code>, the contents of this block will
be added to that file, creating the file if necessary.
</p>

<p>
More generally, Org is capable of evaluating code blocks and passing
their return value to other code blocks. It is thus possible to write
a fully fledged program as an Org document. This paradigm is known as
&ldquo;literate programming&rdquo;. In the case of an Emacs configuration, such as
mine, it is called a &ldquo;literate configuration&rdquo; or variants thereof. I
did a video about my setup: <a href="https://protesilaos.com/codelog/2023-12-18-emacs-org-advanced-literate-conf/">Advanced literate configuration with Org</a> (2023-12-18).
</p>

<p>
Org can evaluate code blocks in many languages. This is known as &ldquo;Org
Babel&rdquo; and the files which implement support for a given language are
typically named <code>ob-LANG.el</code> where <code>LANG</code> is the name of the language.
We can load the requisite code for the languages we care about with
something like the following:
</p>

<pre class="example" id="orgeffbe41">
(require 'ob-python)

;; OR

(use-package ob-python)

;; OR for more control

(use-package ob-python
  :after org
  :config
  ;; Settings here
  )
</pre>

<p>
I seldom need to work with Org Babel, so I do not load any language
automatically. Note that Emacs Lisp is loaded by default.
</p>

<p>
To evaluate a code block, we type Org&rsquo;s omnipotent <code>C-c C-c</code>. The
results will be produced below the code block. There is an optional
parameter that controls how&#x2014;or even if&#x2014;the results are displayed.
</p>

<p>
There are many other types of block apart from <code>SRC</code>. Those do
different things, such as:
</p>

<dl class="org-dl">
<dt><code>#+BEGIN_QUOTE</code></dt><dd>Treat the contents as a block quote or equivalent.</dd>
<dt><code>#+BEGIN_VERSE</code></dt><dd>Do not reflow any like breaks (for poetry and such).</dd>
<dt><code>#+BEGIN_EXPORT</code></dt><dd>Evaluate the code for the given export target
(like <code>html</code> or <code>latex</code>), optionally replacing it with its results
or keeping both of them (<a href="#h:bd11d4d8-6e9f-4536-87a4-4018783bf8f5">The <code>prot-emacs-org.el</code> Org export settings</a>).</dd>
</dl>

<p>
This is a wonderful world of possibilities!
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">;;;; code blocks
(use-package org
  :ensure nil
  :config
  (setq org-confirm-babel-evaluate nil)
  (setq org-src-window-setup 'current-window)
  (setq org-edit-src-persistent-message nil)
  (setq org-src-fontify-natively t)
  (setq org-src-preserve-indentation t)
  (setq org-src-tab-acts-natively t)
  (setq org-edit-src-content-indentation 0))
</pre>
</div>
</div>
</div>
<div id="outline-container-h:bd11d4d8-6e9f-4536-87a4-4018783bf8f5" class="outline-4">
<h4 id="h:bd11d4d8-6e9f-4536-87a4-4018783bf8f5"><span class="section-number-4">5.9.9.</span> The <code>prot-emacs-org.el</code> Org export settings</h4>
<div class="outline-text-4" id="text-h:bd11d4d8-6e9f-4536-87a4-4018783bf8f5">
<p>
Org is a capable authoring tool in no small part because it can be
converted to other file formats. A typical example is to write a
technical document in Org and then export it to a PDF. Another
use-case is what I commonly do with the Emacs packages I maintain,
which I export to an Info manual (texinfo format) and an HTML web
page.
</p>

<p>
The default set of export targets is specified in the value of the
user option <code>org-export-backends</code>. It is one of those rare cases where
it has to be evaluated before the package is loaded. Other than that,
we can load an export backend by finding the correspond <code>ox-FORMAT.el</code>
file and either <code>require</code> it or load it with <code>use-package</code>, like what
I showed for Org Babel (<a href="#h:1f5a0d46-5202-48dd-8048-b48ce17f3df8">The <code>prot-emacs-org.el</code> Org code block settings</a>).
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">;;;; export
(use-package org
  :ensure nil
  :init
  ;; NOTE 2023-05-20: Must be evaluated before Org is loaded,
  ;; otherwise we have to use the Custom UI.  No thanks!
  (setq org-export-backends '(html texinfo md))
  :config
  (setq org-export-with-toc t)
  (setq org-export-headline-levels 8)
  (setq org-export-dispatch-use-expert-ui nil)
  (setq org-html-htmlize-output-type nil)
  (setq org-html-head-include-default-style nil)
  (setq org-html-head-include-scripts nil))
</pre>
</div>
</div>
</div>
<div id="outline-container-h:f8f06938-0dfe-45c3-b4cf-996d36cba82d" class="outline-4">
<h4 id="h:f8f06938-0dfe-45c3-b4cf-996d36cba82d"><span class="section-number-4">5.9.10.</span> The <code>prot-emacs-org.el</code> Org capture templates (<code>org-capture</code>)</h4>
<div class="outline-text-4" id="text-h:f8f06938-0dfe-45c3-b4cf-996d36cba82d">
<p>
The <code>org-capture</code> command allows us to quickly store data in some
structured way. This is done with the help of a templating system
where we can, for example, record the date the entry was recorded,
prompt for user input, automatically use the email&rsquo;s subject as the
title of the task, and the like. The documentation string of
<code>org-capture-templates</code> covers the technicalities.
</p>

<p>
I use two Org files for my tasks. The one is <code>tasks.org</code>, which
contains the bulk of my entries. The other is <code>coach.org</code>, which is
specific to my coaching work: <a href="https://protesilaos.com/coach">https://protesilaos.com/coach</a>.
</p>

<p>
The <code>tasks.org</code> consists of several top-level headings. Each contains
subheadings I need to review. You will notice how most of my
entries in <code>org-capture-templates</code> involve this file. With Org, it is
perfectly fine to work in a single file because we can fold headings
or narrow to them with <code>org-narrow-to-subtree</code>. Furthermore, we can
navigate directly to a heading using minibuffer completion, such as
with the general purpose command <code>prot-search-outline</code>
(<a href="#h:b902e6a3-cdd2-420f-bc99-3d973c37cd20">The <code>prot-emacs-search.el</code> extras provided by the <code>prot-search.el</code> library</a>).
</p>

<p>
Despite the fact that Org copes well with large files, I still choose
to keep my coaching work in a separate file as a contingency plan.
Because <code>coach.org</code> includes information about appointments, I need to
be able to read it with ease from anywhere. This includes different
types of hardware, but also any kind of generic text editor or
terminal pager. I do not want to depend on features like folding,
narrowing, and the like, in times when something has gone awry.
Granted, this has never happened, though the idea makes sense.
Besides, two files are not hard to manage in this case. The
<code>coach.org</code> has a simple structure: each appointment is stored as a
top-level heading.
</p>

<p>
As for my workflow, here is an overview:
</p>

<ul class="org-ul">
<li>When I want to capture data that I am not yet sure about, I add it
to the <code>tasks.org</code> &ldquo;Unprocessed&rdquo; heading. I periodically review
those to decide if I want to do something with them or not. If I do
not want them, I delete them. Otherwise, I file them under another
heading in the same file using the <code>org-refile</code> command (<a href="#h:024dd541-0061-4a10-b10b-b17dcd4794b9">The <code>prot-emacs-org.el</code> Org to-do and refile settings</a>).
Not everything goes into the &ldquo;Unprocessed&rdquo; headings, as I often
known in advance what an item is about. This is just a fallback for
those cases when I need more information to decide on the
appropriate action.</li>

<li>Tasks that have an inherent time component are given a <code>SCHEDULED</code>
or <code>DEADLINE</code> timestamp (set those on demand with the commands
<code>org-schedule</code> and <code>org-deadline</code>, respectively). These are the only
tasks I want to see on my daily agenda (<a href="#h:7fe87b83-2815-4617-a5f9-d3417dd9d248">The <code>prot-emacs-org.el</code> Org agenda settings</a>).
The difference between <code>SCHEDULED</code> and <code>DEADLINE</code> is that the former
has no strict start or end time and so is flexible, while the latter
is more rigid. For example, &ldquo;visit the vet today&rdquo; does not have a
strict time associated with it because the doctor often deals with
emergency situations and thus their agenda is fluid. While a
coaching session of mine like &ldquo;work on Emacs with PERSON&rdquo; has to
start at the agreed upon time.</li>

<li>I do not arbitrarily assign timestamps to tasks. If something does
not have a scheduled date or a deadline, then it does not belong on
the agenda. Otherwise, those arbitrarily defined &ldquo;events&rdquo; accumulate
in the agenda and crowd out the actual time-sensitive tasks. As a
result, the cognitive load is heavier and things will not be done.
So when I want to do something at some point, but have no specific
plan for it, I add is to the <code>tasks.org</code> &ldquo;Wishlist&rdquo;. When I have
free time, I review my wishlist and pick something to work on from
there depending on my available time and mood. This keeps my
workflow both focused and stress-free.</li>

<li>Finally, my <code>coach.org</code> only has time-sensitive appointments with a
<code>DEADLINE</code> associated with them. I organise the rest of my
activities in the given day based on those.</li>
</ul>

<div class="org-src-container">
<pre class="src src-emacs-lisp">;;;; capture
(use-package org-capture
  :ensure nil
  :bind ("C-c c" . org-capture)
  :config
  (require 'prot-org)

  (setq org-capture-templates
        `(("u" "Unprocessed" entry
           (file+headline "tasks.org" "Unprocessed")
           ,(concat "* %^{Title}\n"
                    ":PROPERTIES:\n"
                    ":CAPTURED: %U\n"
                    ":CUSTOM_ID: h:%(format-time-string \"%Y%m%dT%H%M%S\")\n"
                    ":END:\n\n"
                    "%a\n%i%?")
           :empty-lines-after 1)
          ("w" "Wishlist" entry
           (file+olp "tasks.org" "All tasks" "Wishlist")
           ,(concat "* %^{Title} %^g\n"
                    ":PROPERTIES:\n"
                    ":CAPTURED: %U\n"
                    ":CUSTOM_ID: h:%(format-time-string \"%Y%m%dT%H%M%S\")\n"
                    ":END:\n\n"
                    "%a\n%?")
           :empty-lines-after 1)
          ("t" "Task to do" entry
           (file+headline "tasks.org" "All tasks")
           ,(concat "* TODO %^{Title} %^g\n"
                    ":PROPERTIES:\n"
                    ":CAPTURED: %U\n"
                    ":CUSTOM_ID: h:%(format-time-string \"%Y%m%dT%H%M%S\")\n"
                    ":END:\n\n"
                    "%a\n%?")
           :empty-lines-after 1)
          ("s" "Select file and heading to add to" entry
           (function prot-org-select-heading-in-file)
           ,(concat "* TODO %^{Title}%?\n"
                    ":PROPERTIES:\n"
                    ":CAPTURED: %U\n"
                    ":CUSTOM_ID: h:%(format-time-string \"%Y%m%dT%H%M%S\")\n"
                    ":END:\n\n")
           :empty-lines-after 1)

          ;; NOTE 2024-11-24: I am not using this, but am keeping it
          ;; here because the approach is good.

          ;; ("c" "Clock in and do immediately" entry
          ;;  (file+headline "tasks.org" "Clocked tasks")
          ;;  ,(concat "* TODO %^{Title}\n"
          ;;           ":PROPERTIES:\n"
          ;;           ":EFFORT: %^{Effort estimate in minutes|5|10|15|30|45|60|90|120}\n"
          ;;           ":END:\n\n"
          ;;           "%a\n")
          ;;  :prepend t
          ;;  :clock-in t
          ;;  :clock-keep t
          ;;  :immediate-finish t
          ;;  :empty-lines-after 1)
          ("p" "Private lesson or service" entry
           (file "coach.org")
           #'prot-org-capture-coach
           :prepend t
           :empty-lines 1)
          ("P" "Private service clocked" entry
           (file+headline "coach.org" "Clocked services")
           #'prot-org-capture-coach-clock
           :prepend t
           :clock-in t
           :clock-keep t
           :immediate-finish t
           :empty-lines 1)))

  ;; NOTE 2024-11-10: I realised that I was not using this enough, so
  ;; I decided to simplify my setup.  Keeping it here, in case I need
  ;; it again.

  ;; (setq org-capture-templates-contexts
  ;;       '(("e" ((in-mode . "notmuch-search-mode")
  ;;               (in-mode . "notmuch-show-mode")
  ;;               (in-mode . "notmuch-tree-mode")))))
  )
</pre>
</div>
</div>
</div>
<div id="outline-container-h:7fe87b83-2815-4617-a5f9-d3417dd9d248" class="outline-4">
<h4 id="h:7fe87b83-2815-4617-a5f9-d3417dd9d248"><span class="section-number-4">5.9.11.</span> The <code>prot-emacs-org.el</code> Org agenda settings</h4>
<div class="outline-text-4" id="text-h:7fe87b83-2815-4617-a5f9-d3417dd9d248">
<p>
[ Watch: <a href="https://protesilaos.com/codelog/2021-12-09-emacs-org-block-agenda/">Demo of my custom Org block agenda</a> (2021-12-09). It has
  changed a bit since then, but the idea is the same. ]
</p>

<p>
With the Org agenda, we can visualise the tasks we have collected in
our Org files or, more specifically, in the list of files specified in
the user option <code>org-agenda-files</code>. In my workflow, only the files in
the <code>org-directory</code> can feed data into the agenda. Though Org provides
commands to add/remove the current file on demand: <code>org-remove-file</code>,
and <code>org-agenda-file-to-front</code>. If I ever need to write a task that is
specific to a certain file or buffer, then I use Org&rsquo;s linking
mechanism to point to the relevant context, but otherwise store my
task in the usual place (<a href="#h:f8f06938-0dfe-45c3-b4cf-996d36cba82d">The <code>prot-emacs-org.el</code> Org capture templates (<code>org-capture</code>)</a>).
</p>

<p>
By default, Org provides many so-called &ldquo;views&rdquo; for the agenda. One of
the them is the daily/weekly agenda. Others show only the headings
with <code>TODO</code> keywords, or some other kind of search criteria. I
personally never use those views. I have my own custom agenda view,
which consolidates in a single buffer the following blocks on data, in
this order (<a href="#h:9974eac8-2167-45c4-90e0-12dd877403da">The <code>prot-org.el</code> library</a>).:
</p>

<dl class="org-dl">
<dt>Important tasks without a date</dt><dd>When I add a top priority to
something, but there is no inherent deadline to it.</dd>

<dt>Pending scheduled tasks</dt><dd>Tasks with a <code>SCHEDULED</code> date may
sometimes not be done when they ought to. So they need to be closer
to the top for me to do them as soon as I can.</dd>

<dt>Today&rsquo;s agenda</dt><dd>What I am actually working on. Because I only
assign a timestamp to tasks that are indeed time-sensitive, this
always reflects the commitments I have for the day.</dd>

<dt>Next three days</dt><dd>Like the above, but for the near future.</dd>

<dt>Upcoming deadlines (+14d)</dt><dd>These are the deadlines I need to be
aware of for the 14 days after the next three days I am only
informed about.</dd>
</dl>

<p>
The Org agenda has lots of other extras, such as to filter the view.
Though I never use them. My custom agenda does exactly what I need
from it and thus keeps me focused.
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">;;;; agenda
(use-package org-agenda
  :ensure nil
  :bind
  ;; I bind `org-agenda' to C-c A, so this one puts me straight into my
  ;; custom block agenda.
  ( :map global-map
    ("C-c A" . org-agenda)
    ("C-c a" . (lambda ()
                 "Call Org agenda with `prot-org-custom-daily-agenda' configuration."
                 (interactive)
                 (org-agenda nil "A"))))
  :config
;;;;; Custom agenda blocks

  (setq org-agenda-format-date #'prot-org-agenda-format-date-aligned)

  ;; Check the variable `prot-org-custom-daily-agenda' in prot-org.el
  (setq org-agenda-custom-commands
        `(("A" "Daily agenda and top priority tasks"
           ,prot-org-custom-daily-agenda
           ((org-agenda-fontify-priorities nil)
            (org-agenda-prefix-format "	 %t %s")
            (org-agenda-dim-blocked-tasks nil)))
          ("P" "Plain text daily agenda and top priorities"
           ,prot-org-custom-daily-agenda
           ((org-agenda-with-colors nil)
            (org-agenda-prefix-format "%t %s")
            (org-agenda-current-time-string ,(car (last org-agenda-time-grid)))
            (org-agenda-fontify-priorities nil)
            (org-agenda-remove-tags t))
           ("agenda.txt"))))

;;;;; Basic agenda setup
  (setq org-default-notes-file (make-temp-file "emacs-org-notes-")) ; send it to oblivion
  (setq org-agenda-files `(,org-directory))
  (setq org-agenda-span 'week)
  (setq org-agenda-start-on-weekday 1)  ; Monday
  (setq org-agenda-confirm-kill t)
  (setq org-agenda-show-all-dates t)
  (setq org-agenda-show-outline-path nil)
  (setq org-agenda-window-setup 'current-window)
  (setq org-agenda-skip-comment-trees t)
  (setq org-agenda-menu-show-matcher t)
  (setq org-agenda-menu-two-columns nil)
  (setq org-agenda-sticky nil)
  (setq org-agenda-custom-commands-contexts nil)
  (setq org-agenda-max-entries nil)
  (setq org-agenda-max-todos nil)
  (setq org-agenda-max-tags nil)
  (setq org-agenda-max-effort nil)

;;;;; General agenda view options
  ;; NOTE 2021-12-07: Check further below my `org-agenda-custom-commands'
  (setq org-agenda-prefix-format
        '((agenda . " %i %-12:c%?-12t% s")
          (todo . " %i %-12:c")
          (tags . " %i %-12:c")
          (search . " %i %-12:c")))
  (setq org-agenda-sorting-strategy
        '(((agenda habit-down time-up priority-down category-keep)
           (todo priority-down category-keep)
           (tags priority-down category-keep)
           (search category-keep))))
  (setq org-agenda-breadcrumbs-separator "-&gt;")
  (setq org-agenda-todo-keyword-format "%-1s")
  (setq org-agenda-fontify-priorities 'cookies)
  (setq org-agenda-category-icon-alist nil)
  (setq org-agenda-remove-times-when-in-prefix nil)
  (setq org-agenda-remove-timeranges-from-blocks nil)
  (setq org-agenda-compact-blocks nil)
  (setq org-agenda-block-separator ?—)

;;;;; Agenda marks
  (setq org-agenda-bulk-mark-char "#")
  (setq org-agenda-persistent-marks nil)

;;;;; Agenda diary entries
  (setq org-agenda-insert-diary-strategy 'date-tree)
  (setq org-agenda-insert-diary-extract-time nil)
  (setq org-agenda-include-diary nil)
  ;; I do not want the diary, but there is no way to disable it
  ;; altogether.  This creates a diary file in the /tmp directory.
  (setq diary-file (make-temp-file "emacs-diary-"))
  (setq org-agenda-diary-file 'diary-file) ; TODO 2023-05-20: review Org diary substitute

;;;;; Agenda follow mode
  (setq org-agenda-start-with-follow-mode nil)
  (setq org-agenda-follow-indirect t)

;;;;; Agenda multi-item tasks
  (setq org-agenda-dim-blocked-tasks t)
  (setq org-agenda-todo-list-sublevels t)

;;;;; Agenda filters and restricted views
  (setq org-agenda-persistent-filter nil)
  (setq org-agenda-restriction-lock-highlight-subtree t)

;;;;; Agenda items with deadline and scheduled timestamps
  (setq org-agenda-include-deadlines t)
  (setq org-deadline-warning-days 0)
  (setq org-agenda-skip-scheduled-if-done nil)
  (setq org-agenda-skip-scheduled-if-deadline-is-shown t)
  (setq org-agenda-skip-timestamp-if-deadline-is-shown t)
  (setq org-agenda-skip-deadline-if-done nil)
  (setq org-agenda-skip-deadline-prewarning-if-scheduled 1)
  (setq org-agenda-skip-scheduled-delay-if-deadline nil)
  (setq org-agenda-skip-additional-timestamps-same-entry nil)
  (setq org-agenda-skip-timestamp-if-done nil)
  (setq org-agenda-search-headline-for-time nil)
  (setq org-scheduled-past-days 365)
  (setq org-deadline-past-days 365)
  (setq org-agenda-move-date-from-past-immediately-to-today t)
  (setq org-agenda-show-future-repeats t)
  (setq org-agenda-prefer-last-repeat nil)
  (setq org-agenda-timerange-leaders
        '("" "(%d/%d): "))
  (setq org-agenda-scheduled-leaders
        '("Scheduled: " "Sched.%2dx: "))
  (setq org-agenda-inactive-leader "[")
  (setq org-agenda-deadline-leaders
        '("Deadline:  " "In %3d d.: " "%2d d. ago: "))
  ;; Time grid
  (setq org-agenda-time-leading-zero t)
  (setq org-agenda-timegrid-use-ampm nil)
  (setq org-agenda-use-time-grid t)
  (setq org-agenda-show-current-time-in-grid t)
  (setq org-agenda-current-time-string (concat "Now " (make-string 70 ?.)))
  (setq org-agenda-time-grid
        '((daily today require-timed)
          ( 0500 0600 0700 0800 0900 1000
            1100 1200 1300 1400 1500 1600
            1700 1800 1900 2000 2100 2200)
          "" ""))
  (setq org-agenda-default-appointment-duration nil)

;;;;; Agenda global to-do list
  (setq org-agenda-todo-ignore-with-date t)
  (setq org-agenda-todo-ignore-timestamp t)
  (setq org-agenda-todo-ignore-scheduled t)
  (setq org-agenda-todo-ignore-deadlines t)
  (setq org-agenda-todo-ignore-time-comparison-use-seconds t)
  (setq org-agenda-tags-todo-honor-ignore-options nil)

;;;;; Agenda tagged items
  (setq org-agenda-show-inherited-tags t)
  (setq org-agenda-use-tag-inheritance
        '(todo search agenda))
  (setq org-agenda-hide-tags-regexp nil)
  (setq org-agenda-remove-tags nil)
  (setq org-agenda-tags-column -100)

;;;;; Agenda entry
  ;; NOTE: I do not use this right now.  Leaving everything to its
  ;; default value.
  (setq org-agenda-start-with-entry-text-mode nil)
  (setq org-agenda-entry-text-maxlines 5)
  (setq org-agenda-entry-text-exclude-regexps nil)
  (setq org-agenda-entry-text-leaders "    &gt; ")

;;;;; Agenda logging and clocking
  ;; NOTE: I do not use these yet, though I plan to.  Leaving everything
  ;; to its default value for the time being.
  (setq org-agenda-log-mode-items '(closed clock))
  (setq org-agenda-clock-consistency-checks
        '((:max-duration "10:00" :min-duration 0 :max-gap "0:05" :gap-ok-around
                         ("4:00")
                         :default-face ; This should definitely be reviewed
                         ((:background "DarkRed")
                          (:foreground "white"))
                         :overlap-face nil :gap-face nil :no-end-time-face nil
                         :long-face nil :short-face nil)))
  (setq org-agenda-log-mode-add-notes t)
  (setq org-agenda-start-with-log-mode nil)
  (setq org-agenda-start-with-clockreport-mode nil)
  (setq org-agenda-clockreport-parameter-plist '(:link t :maxlevel 2))
  (setq org-agenda-search-view-always-boolean nil)
  (setq org-agenda-search-view-force-full-words nil)
  (setq org-agenda-search-view-max-outline-level 0)
  (setq org-agenda-search-headline-for-time t)
  (setq org-agenda-use-time-grid t)
  (setq org-agenda-cmp-user-defined nil)
  (setq org-agenda-sort-notime-is-late t) ; Org 9.4
  (setq org-agenda-sort-noeffort-is-high t) ; Org 9.4

;;;;; Agenda column view
  ;; NOTE I do not use these, but may need them in the future.
  (setq org-agenda-view-columns-initially nil)
  (setq org-agenda-columns-show-summaries t)
  (setq org-agenda-columns-compute-summary-properties t)
  (setq org-agenda-columns-add-appointments-to-effort-sum nil)
  (setq org-agenda-auto-exclude-function nil)
  (setq org-agenda-bulk-custom-functions nil)

  ;; ;;;;; Agenda habits
  ;;   (require 'org-habit)
  ;;   (setq org-habit-graph-column 50)
  ;;   (setq org-habit-preceding-days 9)
  ;;   ;; Always show the habit graph, even if there are no habits for
  ;;   ;; today.
  ;;   (setq org-habit-show-all-today t)
  )
</pre>
</div>
</div>
</div>
<div id="outline-container-h:62eb7ca3-2f79-45a6-a018-38238b486e98" class="outline-4">
<h4 id="h:62eb7ca3-2f79-45a6-a018-38238b486e98"><span class="section-number-4">5.9.12.</span> The <code>prot-emacs-org.el</code> call to <code>provide</code></h4>
<div class="outline-text-4" id="text-h:62eb7ca3-2f79-45a6-a018-38238b486e98">
<p>
Finally, we <code>provide</code> the module. This is the mirror function of
<code>require</code> (<a href="#h:e6c4acf5-5b51-4b38-a86a-bf3f698ac872">The init.el final part to load the individual modules</a>).
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(provide 'prot-emacs-org)
</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-h:f44afb76-a1d7-4591-934d-b698cc79a792" class="outline-3">
<h3 id="h:f44afb76-a1d7-4591-934d-b698cc79a792"><span class="section-number-3">5.10.</span> The <code>prot-emacs-langs.el</code> module</h3>
<div class="outline-text-3" id="text-h:f44afb76-a1d7-4591-934d-b698cc79a792">
<p>
This module encompasses a wide range of packages and built-in
configurations that relate to &ldquo;language&rdquo; in the wider sense. Settings
here include basic patterns of interaction, such as what the <code>TAB</code> key
does, to spell checking, code linting, and writing.
</p>
</div>
<div id="outline-container-h:559713c8-0e1e-44aa-bca8-0caae01cc8bb" class="outline-4">
<h4 id="h:559713c8-0e1e-44aa-bca8-0caae01cc8bb"><span class="section-number-4">5.10.1.</span> The <code>prot-emacs-langs.el</code> settings for TAB</h4>
<div class="outline-text-4" id="text-h:559713c8-0e1e-44aa-bca8-0caae01cc8bb">
<p>
When I first switched to Emacs, I found the behaviour of the <code>TAB</code> key
confusing. I was used to it inserting tabs or, at least, spaces.
Whereas in Emacs, <code>TAB</code> tries to be smarter, depending on the major
mode, as it tries to indent the current line to where it should be
given the context. This works best when we mark a region of text and
hit <code>TAB</code> there.
</p>

<p>
If we need to forcefully indent, we can use <code>C-x C-i</code> (<code>indent-rigidly</code>).
This command allows us to shift the region left or right using the
arrow keys. A common use-case for me is to paste some text I want to
indent, and then do <code>C-u C-x C-i</code>, which indents by four spaces the
implicit region. I have explained this in my video about mark and register basics:
<a href="https://protesilaos.com/codelog/2023-06-28-emacs-mark-register-basics/">https://protesilaos.com/codelog/2023-06-28-emacs-mark-register-basics/</a>.
</p>

<p>
To the settings I have here, the <code>tab-always-indent</code> makes the <code>TAB</code>
key assume the dual role of indenting text as well as triggering
completion at point (<a href="#h:804b858f-7913-47ef-aaf4-8eef5b59ecb4">The <code>prot-emacs-completion.el</code> for in-buffer completion popup (<code>corfu</code>)</a>).
When it can perform indentation, it does that, otherwise it starts a
completion loop. The <code>tab-first-completion</code> determines when not to
complete. Read its doc string for the technicalities.
</p>

<p>
Finally, the <code>tab-width</code> and <code>indent-tabs-mode</code> are about the use of
tabs. I never want them, as I only use spaces. Notice the <code>setq-default</code>
here: we need this form when the buffer&rsquo;s value automatically becomes
buffer-local. This is very important, otherwise we will be setting the
value only in the Emacs init file, which contradicts our intent. There
are a few cases where <code>setq-default</code> is needed, so keep this in mind.
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">;;;; Tabs, indentation, and the TAB key
(use-package emacs
  :ensure nil
  :demand t
  :config
  (setq tab-always-indent 'complete)
  (setq tab-first-completion 'word-or-paren-or-punct) ; Emacs 27
  (setq-default tab-width 4
                indent-tabs-mode nil))
</pre>
</div>
</div>
</div>
<div id="outline-container-h:ebbc4e05-3654-4fc4-9948-d29dffeb6356" class="outline-4">
<h4 id="h:ebbc4e05-3654-4fc4-9948-d29dffeb6356"><span class="section-number-4">5.10.2.</span> The <code>prot-emacs-langs.el</code> settings for &ldquo;electric&rdquo; behaviour</h4>
<div class="outline-text-4" id="text-h:ebbc4e05-3654-4fc4-9948-d29dffeb6356">
<p>
Emacs describes as &ldquo;electric&rdquo; any behaviour that tries to be smart
about how to handle a given action. The <code>electric-pair-mode</code>, for
example, automatically inserts a closing parenthesis when the user
inputs an opening parenthesis. Same idea with quotes, performed by the
<code>electric-quote-mode</code>. While the <code>electric-indent-mode</code> tries to be
smart about how to indent a line, which is fine for programming
purposes, it makes a mess of things in Org and related because you
have to delete back to the beginning of a line if you want to &ldquo;escape&rdquo;
from the indentation of a list or something.
</p>

<p>
If I need to manually wrap the symbol at point or a region in a pair
of characters, I use my <code>prot-pair-insert</code> command (<a href="#h:48d2bab5-241f-49dd-9554-8a4dcedce75e">The <code>prot-emacs-essentials.el</code> section about <code>prot-pair.el</code> (insert character pairs)</a>).
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">;;;; Disable "electric" behaviour
(use-package electric
  :ensure nil
  :hook
  (prog-mode . electric-indent-local-mode)
  :config
  ;; I don't like auto indents in Org and related.  They are okay for
  ;; programming.
  (electric-pair-mode -1)
  (electric-quote-mode -1)
  (electric-indent-mode -1))
</pre>
</div>
</div>
</div>
<div id="outline-container-h:7cd21ea6-c5d8-4258-999d-ad94cac2d8bf" class="outline-4">
<h4 id="h:7cd21ea6-c5d8-4258-999d-ad94cac2d8bf"><span class="section-number-4">5.10.3.</span> The <code>prot-emacs-langs.el</code> settings <code>show-paren-mode</code></h4>
<div class="outline-text-4" id="text-h:7cd21ea6-c5d8-4258-999d-ad94cac2d8bf">
<p>
The built-in <code>show-paren-mode</code> highlights the parenthesis on the
opposite end of the current symbolic expression. It also highlights
matching terms of control flow in programming languages that are not
using parentheses like Lisp: for instance, in a <code>bash</code> shell script it
highlights the <code>if</code> and <code>fi</code> keywords. This mode also works for prose
and I use it globally. Simple and effective!
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">;;;; Parentheses (show-paren-mode)
(use-package paren
  :ensure nil
  :hook (prog-mode . show-paren-local-mode)
  :config
  (setq show-paren-style 'parenthesis)
  (setq show-paren-when-point-in-periphery nil)
  (setq show-paren-when-point-inside-paren nil)
  (setq show-paren-context-when-offscreen 'overlay)) ; Emacs 29
</pre>
</div>
</div>
</div>
<div id="outline-container-h:c5fbd6dd-2982-4fca-aeed-d0e750d399bd" class="outline-4">
<h4 id="h:c5fbd6dd-2982-4fca-aeed-d0e750d399bd"><span class="section-number-4">5.10.4.</span> The <code>prot-emacs-langs.el</code> settings for plain text (no double spaces, <code>auto-fill-mode</code>)</h4>
<div class="outline-text-4" id="text-h:c5fbd6dd-2982-4fca-aeed-d0e750d399bd">
<p>
These are some basic settings for plain text files but also for any
major mode that inherits from <code>text-mode</code> (like Org and Markdown). For
a long time, I was using double spaces after a sentence, as this is
the Emacs default. I don&rsquo;t have a strong preference for or against it,
though I reverted to the single space convention as it is the norm
nowadays.
</p>

<p>
The technical benefit of double spaces is that it makes sentence
navigation less ambiguous as you do not get false positives like
&ldquo;Dr.&rdquo;. Though I realised I seldom use such language so why type more
spaces for a theoretical advantage?
</p>

<p>
I still need to use double spaces for Elisp programming, otherwise the
byte compiler produces warnings. It is annoyingly pedantic, but here
we are&#x2026;
</p>

<p>
The other setting that matters here is the use of &ldquo;auto fill&rdquo;, else
the <code>auto-fill-mode</code>. This is about the automatic break of long lines
so that they wrap at the <code>fill-column</code> length: it happens as you type.
This way, a paragraph is not a single long line, but several shorter
lines with newline characters between them. I find this much more
pleasant to work with than to have to rely on <code>visual-line-mode</code> to
visually wrap long lines. I want my text to be readable even if I do
not use Emacs (e.g. if I use <code>cat</code> or <code>less</code> on the command-line).
Auto-filled text does not affect published prose, as the relevant
programs strip away the newlines inside a paragraph.
</p>

<p>
To manually fill a region of text, mark it and type <code>M-q</code>. Or do <code>M-q</code>
to operate on the current paragraph without marking it. Depending on
the major mode you are in, this key binding calls a different command.
The generic one is <code>fill-paragraph</code>. I use <code>M-Q</code> to &ldquo;unfill&rdquo; text,
which corresponds to the <code>prot-simple-unfill-region-or-paragraph</code>
command (<a href="#h:f15bc843-2dd1-4792-95ec-9b7b6e561804">The <code>prot-emacs-essentials.el</code> section about <code>prot-simple.el</code> (custom basic commands)</a>).
</p>

<p>
Finally, notice how I am adding an association to the <code>auto-mode-alist</code>.
The file names specified in that regular expression will be using
<code>text-mode</code> when I visit them.
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">;;;; Plain text (text-mode)
(use-package text-mode
  :ensure nil
  :mode "\\`\\(README\\|CHANGELOG\\|COPYING\\|LICENSE\\)\\'"
  :hook
  ((text-mode . turn-on-auto-fill)
   (prog-mode . (lambda () (setq-local sentence-end-double-space t))))
  :config
  (setq sentence-end-double-space nil)
  (setq sentence-end-without-period nil)
  (setq colon-double-space nil)
  (setq use-hard-newlines nil)
  (setq adaptive-fill-mode t))
</pre>
</div>
</div>
</div>
<div id="outline-container-h:1a132701-9487-4af0-8759-a8d64d02bf1f" class="outline-4">
<h4 id="h:1a132701-9487-4af0-8759-a8d64d02bf1f"><span class="section-number-4">5.10.5.</span> The <code>prot-emacs-langs.el</code> settings for common file types</h4>
<div class="outline-text-4" id="text-h:1a132701-9487-4af0-8759-a8d64d02bf1f">
<p>
As I explained above about <code>auto-mode-alist</code> (<a href="#h:c5fbd6dd-2982-4fca-aeed-d0e750d399bd">The <code>prot-emacs-langs.el</code> settings for plain text</a>),
this is how we tell Emacs what major mode to use for files that match
the given regular expression. The <code>PKGBUILD</code> is for Arch Linux package
recipes, by the way.
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">;;;; Arch Linux and AUR package scripts (sh-mode)
(use-package sh-script
  :ensure nil
  :mode ("PKGBUILD" . sh-mode))

;;;; SystemD and other configuration files (conf-mode)
(use-package conf-mode
  :ensure nil
  :mode ("\\`dircolors\\'" "\\.\\(service\\|timer\\)\\'"))
</pre>
</div>
</div>
</div>
<div id="outline-container-h:a5773a39-a78f-43fa-8feb-669492c1d5a9" class="outline-4">
<h4 id="h:a5773a39-a78f-43fa-8feb-669492c1d5a9"><span class="section-number-4">5.10.6.</span> The <code>prot-emacs-langs.el</code> settings for <code>eldoc</code></h4>
<div class="outline-text-4" id="text-h:a5773a39-a78f-43fa-8feb-669492c1d5a9">
<p>
The built-in <code>eldoc</code> feature is especially useful in programming
modes. While we are in a function call, it produces an indicator in
the echo area (where the minibuffer appears upon invocation) that
shows the name of the function, the arguments it takes, if any, and
highlights the current argument we are positioned at. This way, we do
not have to go back to review the signature of the function just to
remember its arity. Same principle for variables, where <code>eldoc-mode</code>
puts the first line of their documentation string in the echo area.
</p>

<p>
Of course, this works out-of-the-box for Emacs Lisp code. Other modes
need to arrange how to use this feature.
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">;;;; Eldoc (Emacs live documentation feedback)
(use-package eldoc
  :ensure nil
  :hook (prog-mode . eldoc-mode)
  :config
  (setq eldoc-message-function #'message)) ; don't use mode line for M-x eval-expression, etc.
</pre>
</div>
</div>
</div>
<div id="outline-container-h:92258aa8-0d8c-4c12-91b4-5f44420435ce" class="outline-4">
<h4 id="h:92258aa8-0d8c-4c12-91b4-5f44420435ce"><span class="section-number-4">5.10.7.</span> The <code>prot-emacs-langs.el</code> settings for <code>eglot</code> (LSP client)</h4>
<div class="outline-text-4" id="text-h:92258aa8-0d8c-4c12-91b4-5f44420435ce">
<p>
The built-in <code>eglot</code> feature, developed and maintained by João Távora,
is Emacs&rsquo; own client for the Language Server Protocol (LSP). The LSP
technology is all about enhancing the ability of a text editor to work
with a given programming language. This works by installing a
so-called &ldquo;language server&rdquo; on your computer, which the &ldquo;LSP client&rdquo;
(i.e. <code>eglot</code>) will plug into. A typical language server provides the
following capabilities:
</p>

<dl class="org-dl">
<dt>Code completion</dt><dd>This can be visualised for in-buffer
automatic expansion of function calls, variables, and the like
(<a href="#h:804b858f-7913-47ef-aaf4-8eef5b59ecb4">The <code>prot-emacs-completion.el</code> for in-buffer completion popup (<code>corfu</code>)</a>).</dd>

<dt>Code linting</dt><dd>To display suggestions, warnings, or errors. These
are highlighted in the buffer, usually with an underline, and can
also be displayed in a standalone buffer with the commands
<code>flymake-show-buffer-diagnostics</code>, <code>flymake-show-project-diagnostics</code>
(<a href="#h:df6d1b52-0306-4ace-9099-17dded11fbed">The <code>prot-emacs-langs.el</code> settings for code linting (<code>flymake</code>)</a>).</dd>

<dt>Code navigation and cross-referencing</dt><dd><p>
While over a symbol, use a
command to jump directly to its definition. The default key bindings
for going forth and then back are <code>M-.</code> (<code>xref-find-definitions</code>)
and <code>M-,</code> (<code>xref-go-back</code>).
</p>

<p>
[ Features such as the definition of the outline should, in
  principle, be implemented by the major mode though I see no reason
  why a language server cannot also be involved in this task. You
  can use the built-in <code>outline-minor-mode</code> to provide Org-like
  folding capabilties for outline headings (<a href="#h:ffff5f7b-a62b-4d4a-ae29-af75402e5c35">The <code>prot-emacs-langs.el</code> settings for <code>outline-minor-mode</code></a>).
  I usually navigate the outline using minibuffer completion, with
  the help of my <code>prot-search-outline</code> command (<a href="#h:b902e6a3-cdd2-420f-bc99-3d973c37cd20">The <code>prot-emacs-search.el</code> extras provided by the <code>prot-search.el</code> library</a>). ]
</p></dd>
</dl>

<p>
Assuming the language server is installed, to start using the LSP
client in a given file, do <code>M-x eglot</code>. To make this happen
automatically for every newly visited file, add a hook like this:
</p>

<pre class="example" id="org6426e38">
(add-hook 'SOME-MAJOR-mode #'eglot-ensure)
</pre>

<p>
I only code in Emacs Lisp, so I am actually not using <code>eglot</code>
anywhere. Though I have tried it in Bash and JavaScript files and it
worked fine.
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">;;;; Eglot (built-in client for the language server protocol)
(use-package eglot
  :ensure nil
  :functions (eglot-ensure)
  :commands (eglot)
  :config
  (setq eglot-sync-connect nil)
  (setq eglot-autoshutdown t))
</pre>
</div>
</div>
</div>
<div id="outline-container-h:20948a81-858d-4b21-b221-3b24833f5ad8" class="outline-4">
<h4 id="h:20948a81-858d-4b21-b221-3b24833f5ad8"><span class="section-number-4">5.10.8.</span> The <code>prot-emacs-langs.el</code> settings for very long lines</h4>
<div class="outline-text-4" id="text-h:20948a81-858d-4b21-b221-3b24833f5ad8">
<p>
Emacs is notoriously bad at performing well when parsing long lines.
I believe this has to do with how syntax highlighting and code
navigation are implemented. The <code>global-so-long-mode</code> tries to
mitigate this problem by disabling such extras when we visit a file
with really long lines, such as minified JavaScript. I have not used
it enough to know how reliable this is, though it is nice to have just
in case.
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">;;;; Handle performance for very long lines (so-long.el)
(use-package so-long
  :ensure nil
  :hook (after-init . global-so-long-mode))
</pre>
</div>
</div>
</div>
<div id="outline-container-h:c9063898-07ae-4635-8853-bb5f4bbab421" class="outline-4">
<h4 id="h:c9063898-07ae-4635-8853-bb5f4bbab421"><span class="section-number-4">5.10.9.</span> The <code>prot-emacs-langs.el</code> settings for <code>markdown-mode</code></h4>
<div class="outline-text-4" id="text-h:c9063898-07ae-4635-8853-bb5f4bbab421">
<p>
The <code>markdown-mode</code> lets us edit Markdown files. We get syntax
highlighting and several extras, such as the folding of headings and
navigation between them. The mode actually provides lots of added
functionality for GitHub-flavoured Markdown and to preview a Markdown
file&rsquo;s HTML representation on a web page. Though I only use it for
basic text editing.
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">;;; Markdown (markdown-mode)
(use-package markdown-mode
  :ensure t
  :defer t
  :config
  (setq markdown-fontify-code-blocks-natively t))
</pre>
</div>
</div>
</div>
<div id="outline-container-h:bae58479-86c1-410f-867e-c548def65b1c" class="outline-4">
<h4 id="h:bae58479-86c1-410f-867e-c548def65b1c"><span class="section-number-4">5.10.10.</span> The <code>prot-emacs-langs.el</code> settings for <code>csv-mode</code></h4>
<div class="outline-text-4" id="text-h:bae58479-86c1-410f-867e-c548def65b1c">
<p>
The package <code>csv-mode</code> provides support for <code>.csv</code> files. I do need
this on occasion, even though my use-case is pretty basic. For me, the
killer feature is the ability to create a virtual tabulated listing
with the command <code>csv-align-mode</code>: it hides the field delimiter (comma
or space) and shows a tab stop in its stead.
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">;;; csv-mode
(use-package csv-mode
  :ensure t
  :commands (csv-align-mode))
</pre>
</div>
</div>
</div>
<div id="outline-container-h:88e36f15-4c74-4b7c-9ba6-cf5fb112ffd9" class="outline-4">
<h4 id="h:88e36f15-4c74-4b7c-9ba6-cf5fb112ffd9"><span class="section-number-4">5.10.11.</span> The <code>prot-emacs-langs.el</code> settings for <code>sxhkdrc-mode</code></h4>
<div class="outline-text-4" id="text-h:88e36f15-4c74-4b7c-9ba6-cf5fb112ffd9">
<p>
This is a major mode for editing <code>sxhkdrc</code> files. SXHKD is the Simple
X Hot Key Daemon which is commonly used in minimalist desktop sessions
on Xorg, such as with the Binary Space Partitioning Window Manager
(BSPWM). The <code>sxhkdrc</code> file configures key chords, binding them to
commands. For the technicalities, read the man page <code>sxhkd(1)</code>.
</p>

<ul class="org-ul">
<li>Package name (GNU ELPA): <code>sxhkdrc-mode</code></li>
<li>Git repositories:
<ul class="org-ul">
<li>GitHub: <a href="https://github.com/protesilaos/sxhkdrc-mode">https://github.com/protesilaos/sxhkdrc-mode</a></li>
<li>GitLab: <a href="https://gitlab.com/protesilaos/sxhkdrc-mode">https://gitlab.com/protesilaos/sxhkdrc-mode</a></li>
</ul></li>
<li>Backronym: Such Xenotropic Hot Keys Demonstrate Robustness and
Configurability &#x2026; mode.</li>
</ul>

<div class="org-src-container">
<pre class="src src-emacs-lisp">;;; SXHKDRC mode (one of my many packages)
(use-package sxhkdrc-mode
  :ensure t
  ;; By default, it only applies to the sxhkdrc file, but I have other
  ;; relevant entries as well.  I separate my keys into different
  ;; modules and load only what I need.
  :mode "sxhkdrc_.*")
</pre>
</div>
</div>
</div>
<div id="outline-container-h:115806c4-88b0-43c1-8db2-d9d8d20a5c17" class="outline-4">
<h4 id="h:115806c4-88b0-43c1-8db2-d9d8d20a5c17"><span class="section-number-4">5.10.12.</span> The <code>prot-emacs-langs.el</code> settings for spell checking</h4>
<div class="outline-text-4" id="text-h:115806c4-88b0-43c1-8db2-d9d8d20a5c17">
<p>
For spell checking on-demand, I rely on the built-in <code>flyspell</code>
feature that I complement with some small extras (<a href="#h:551718b7-fb2d-4a4a-804e-3118001b96ec">The <code>prot-spell.el</code> library</a>).
</p>

<p>
In terms of workflow, I do not like to see any spell checking while I
type. I prefer to write out the entire draft and then do a spell check
at the end. Whatever typos do not bother me (and I have commented many
times before about my &ldquo;alla prima&rdquo; approach to creativity). It is
harder to set up multilingual spell checking with <code>flyspell</code> and I do
not even bother trying as I seldom have that need.
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">;;; Flyspell and prot-spell.el (spell check)
(use-package flyspell
  :ensure nil
  :bind
  ( :map flyspell-mode-map
    ("C-;" . nil)
    :map flyspell-mouse-map
    ("&lt;mouse-3&gt;" . flyspell-correct-word)
    :map ctl-x-x-map
    ("s" . flyspell-mode)) ; C-x x s
  :config
  (setq flyspell-issue-message-flag nil)
  (setq flyspell-issue-welcome-flag nil)
  (setq ispell-program-name "aspell")
  (setq ispell-dictionary "en_GB"))

(use-package prot-spell
  :ensure nil
  :bind
  (("M-$" . prot-spell-spell-dwim)
   ("C-M-$" . prot-spell-change-dictionary)
   ("M-i" . prot-spell-spell-dwim) ; override `tab-to-tab-stop'
   ("C-M-i" . prot-spell-change-dictionary)) ; override `complete-symbol'
  :config
  (setq prot-spell-dictionaries
        '(("EN English" . "en")
          ("EL Ελληνικά" . "el")
          ("FR Français" . "fr")
          ("ES Espanõl" . "es")))

  ;; Also check prot-spell.el for what I am doing with
  ;; `prot-spell-ispell-display-buffer'.  Then refer to the
  ;; `display-buffer-alist' for the relevant entry.
  (setq ispell-choices-buffer "*ispell-top-choices*"))
</pre>
</div>
</div>
</div>
<div id="outline-container-h:df6d1b52-0306-4ace-9099-17dded11fbed" class="outline-4">
<h4 id="h:df6d1b52-0306-4ace-9099-17dded11fbed"><span class="section-number-4">5.10.13.</span> The <code>prot-emacs-langs.el</code> settings for code linting (<code>flymake</code>)</h4>
<div class="outline-text-4" id="text-h:df6d1b52-0306-4ace-9099-17dded11fbed">
<p>
The built-in <code>flymake</code> feature defines an interface for viewing the
output of linter programs. A &ldquo;linter&rdquo; parses a file and reports
possible notes/warnings/errors in it. With <code>flymake</code> we get these
diagnostics in the form of a standalone buffer as well as inline
highlights (typically underlines combined with fringe indicators) for
the portion of text in question. The linter report is displayed with
the command <code>flymake-show-buffer-diagnostics</code>, or <code>flymake-show-project-diagnostics</code>.
Highlights are shown in the context of the file.
</p>

<p>
The built-in <code>eglot</code> feature uses <code>flymake</code> internally to handle the
LSP linter output (<a href="#h:92258aa8-0d8c-4c12-91b4-5f44420435ce">The <code>prot-emacs-langs.el</code> settings for <code>eglot</code></a>).
</p>

<p>
As for what I have in this configuration block, the essentials for me
are the user options <code>flymake-start-on-save-buffer</code> and <code>flymake-start-on-flymake-mode</code>
as they make the linter update its report when the buffer is saved and
when <code>flymake-mode</code> is started, respectively. Otherwise, we have to
run it manually, which is cumbersome.
</p>

<p>
The <code>package-lint-flymake</code> package by Steve Purcell adds the glue code
to make <code>flymake</code> report issues with Emacs Lisp files for the purposes
of packaging. I use it whenever I work on my numerous Emacs packages.
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">;;; Flymake
(use-package flymake
  :ensure nil
  :preface
  (defvar prot/flymake-mode-projects-path
    (file-name-as-directory (expand-file-name "Projects" "~/Git/"))
    "Path to my Git projects.")

  (defun prot/flymake-mode-lexical-binding ()
    (when lexical-binding
      (flymake-mode 1)))

  (defun prot/flymake-mode-in-my-projects ()
    (when-let* ((file (buffer-file-name))
                ((string-prefix-p prot/flymake-mode-projects-path (expand-file-name file)))
                ((not (file-directory-p file)))
                ((file-regular-p file)))
      (add-hook 'find-file-hook #'prot/flymake-mode-lexical-binding nil t)))

  (add-hook 'emacs-lisp-mode-hook #'prot/flymake-mode-in-my-projects)
  :bind
  ( :map ctl-x-x-map
    ("m" . flymake-mode) ; C-x x m
    :map flymake-mode-map
    ("C-c ! s" . flymake-start)
    ("C-c ! d" . flymake-show-buffer-diagnostics) ; Emacs28
    ("C-c ! D" . flymake-show-project-diagnostics) ; Emacs28
    ("C-c ! n" . flymake-goto-next-error)
    ("C-c ! p" . flymake-goto-prev-error))
  :config
  (setq flymake-fringe-indicator-position 'left-fringe)
  (setq flymake-suppress-zero-counters t)
  (setq flymake-no-changes-timeout nil)
  (setq flymake-start-on-flymake-mode t)
  (setq flymake-start-on-save-buffer t)
  (setq flymake-proc-compilation-prevents-syntax-check t)
  (setq flymake-wrap-around nil)
  (setq flymake-mode-line-format
        '("" flymake-mode-line-exception flymake-mode-line-counters))
  ;; NOTE 2023-07-03: `prot-modeline.el' actually defines the counters
  ;; itself and ignores this.
  (setq flymake-mode-line-counter-format
        '("" flymake-mode-line-error-counter
          flymake-mode-line-warning-counter
          flymake-mode-line-note-counter ""))
  (setq flymake-show-diagnostics-at-end-of-line nil)) ; Emacs 30

;;; Elisp packaging requirements
(use-package package-lint-flymake
  :ensure t
  :after flymake
  :config
  (add-hook 'flymake-diagnostic-functions #'package-lint-flymake))
</pre>
</div>
</div>
</div>
<div id="outline-container-h:ffff5f7b-a62b-4d4a-ae29-af75402e5c35" class="outline-4">
<h4 id="h:ffff5f7b-a62b-4d4a-ae29-af75402e5c35"><span class="section-number-4">5.10.14.</span> The <code>prot-emacs-langs.el</code> settings for <code>outline-minor-mode</code></h4>
<div class="outline-text-4" id="text-h:ffff5f7b-a62b-4d4a-ae29-af75402e5c35">
<p>
The built-in <code>outline-minor-mode</code> defines folding and navigation
commands for the file&rsquo;s outline. The &ldquo;outline&rdquo; is the document&rsquo;s
discernible structure, defined by the local value of the variable
<code>outline-regexp</code>. Simply put, it is about the headings in the
document.
</p>

<p>
Any file can have its own outline. For example, in Emacs Lisp any
comment with three or more delimiters that starts at the beginning of
the line counts as a heading. Three delimiters make it a level 1
heading; four delimiters for level 2, and so on. You will notice that
I already use outlines in all my files. Sometimes I enable the
<code>outline-minor-mode</code>, though I do not really need the folding
capabilities. Plus, I can navigate the file using minibuffer
completion among outline entries without enabling
<code>outline-minor-mode</code>, courtesy of the command <code>prot-search-outline</code>
(<a href="#h:b902e6a3-cdd2-420f-bc99-3d973c37cd20">The <code>prot-emacs-search.el</code> extras provided by the <code>prot-search.el</code> library</a>).
</p>

<p>
A common question/remark about my literate configuration with Org is
why not use <code>outline-minor-mode</code> or the external <code>outshine</code> package to
get &ldquo;the same features&rdquo; without Org. The feature sets are not really
comparable. With Org we can comment at length without putting all that
in the actual code, whereas with <code>outline-minor-mode</code> you would be
reading all this commentary in the source code: now you only read it
in this Org document and its website counterpart. Furthermore, we have
links between headings, a convenient export mechanism to a website,
and the ability to easily redirect where the code blocks are tangled
to. On the latter point, if, for instance, I ever choose to
consolidate all my Emacs setup in a monolithic <code>init.el</code>, I just run a
quick replace for all the <code>:tangle</code> values in this document. Finally,
we have to consider the use-case: if you have a private config, then
<code>outline-minor-mode</code> may be enough. In my case, I maintain a massive
document which, I think, can be helpful for others in the community as
well.
</p>

<p>
[ Also read: <a href="#h:2d28a65c-bef6-4829-89d9-aef3581da7cd">Why use Org when you can have an outline in Elisp?</a> ]
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">;;; General configurations for prose/writing

;;;; `outline' (`outline-mode' and `outline-minor-mode')
(use-package outline
  :ensure nil
  :bind
  ("&lt;f10&gt;" . outline-minor-mode)
  :config
  (setq outline-minor-mode-highlight nil) ; emacs28
  (setq outline-minor-mode-cycle t) ; emacs28
  (setq outline-minor-mode-use-buttons nil) ; emacs29---bless you for the nil option!
  (setq outline-minor-mode-use-margins nil)) ; as above
</pre>
</div>
</div>
</div>
<div id="outline-container-h:f91563d8-f176-4555-b45b-ece56de03279" class="outline-4">
<h4 id="h:f91563d8-f176-4555-b45b-ece56de03279"><span class="section-number-4">5.10.15.</span> The <code>prot-emacs-langs.el</code> settings for <code>dictionary</code></h4>
<div class="outline-text-4" id="text-h:f91563d8-f176-4555-b45b-ece56de03279">
<p>
The built-in <code>dictionary</code> feature lets us access a webpage (or local
server) to read dictionary entries. The command <code>dictionary-search</code> is
also smart enough to use the word at point as the default value, so we
can type <code>RET</code> at the minibuffer prompt to select it without typing it
out. A neat package overall!
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">;;;; `dictionary'
(use-package dictionary
  :ensure nil
  :bind ("C-c d" . dictionary-search)
  :config
  (setq dictionary-server "dict.org"
        dictionary-default-popup-strategy "lev" ; read doc string
        dictionary-create-buttons nil
        dictionary-use-single-buffer t))
</pre>
</div>
</div>
</div>
<div id="outline-container-h:2a2728a9-e392-4fbe-bf2a-83e883387857" class="outline-4">
<h4 id="h:2a2728a9-e392-4fbe-bf2a-83e883387857"><span class="section-number-4">5.10.16.</span> The <code>prot-emacs-langs.el</code> settings for <code>altcaps</code> (alternating letter casing)</h4>
<div class="outline-text-4" id="text-h:2a2728a9-e392-4fbe-bf2a-83e883387857">
<p>
What follows is another package of mine. I wrote it to practice some
programming concepts, though I genuinely find it useful. How else are
we supposed to mock people when they say <i>wHy WoN&rsquo;t YoU sPoOnFeEd Me
AlL tHe AnSwErS?</i>
</p>

<p>
Technically, the <code>altcaps</code> package is a small, focused-in-scope tool
that helps users communicate mockery or sarcasm effectively. It does
this by alternating the letter casing of characters in the words it
affects.
</p>

<ul class="org-ul">
<li>Package name (GNU ELPA): <code>altcaps</code></li>
<li>Official manual: <a href="https://protesilaos.com/emacs/altcaps">https://protesilaos.com/emacs/altcaps</a></li>
<li>Change log: <a href="https://protesilaos.com/emacs/altcaps-changelog">https://protesilaos.com/emacs/altcaps-changelog</a></li>
<li>Git repositories:
<ul class="org-ul">
<li>GitHub: <a href="https://github.com/protesilaos/altcaps">https://github.com/protesilaos/altcaps</a></li>
<li>GitLab: <a href="https://gitlab.com/protesilaos/altcaps">https://gitlab.com/protesilaos/altcaps</a></li>
</ul></li>
<li>Backronyms: Alternating Letters Transform Casual Asides to Playful
Statements.  ALTCAPS Lets Trolls Convert Aphorisms to Proper
Shitposts.</li>
</ul>

<div class="org-src-container">
<pre class="src src-emacs-lisp">;;; aLtCaPs
;; Read the manual: &lt;https://protesilaos.com/emacs/altcaps&gt;.
(use-package altcaps
  :ensure t
  :bind
  ("C-x C-a" . altcaps-dwim)
  :config
  ;; Force letter casing for certain characters (for legibility).
  (setq altcaps-force-character-casing
        '(;; Greek theta
          (?θ . downcase))))
</pre>
</div>
</div>
</div>
<div id="outline-container-h:e86a66dc-7ef9-4f09-ad7e-946de2034e8d" class="outline-4">
<h4 id="h:e86a66dc-7ef9-4f09-ad7e-946de2034e8d"><span class="section-number-4">5.10.17.</span> The <code>prot-emacs-langs.el</code> settings for <code>denote</code> (notes and file-naming)</h4>
<div class="outline-text-4" id="text-h:e86a66dc-7ef9-4f09-ad7e-946de2034e8d">
<p>
This is another one of my packages and is extended by my
<code>consult-denote</code> package (<a href="#h:ee82e629-fb05-4c75-9175-48a760a25691">The <code>prot-emacs-langs.el</code> integration between Consult and Denote (<code>consult-denote</code>)</a>).
</p>

<p>
Denote is a simple note-taking tool for Emacs. It is based on the idea
that notes should follow a predictable and descriptive file-naming
scheme. The file name must offer a clear indication of what the note is
about, without reference to any other metadata. Denote basically
streamlines the creation of such files while providing facilities to
link between them.
</p>

<p>
Denote&rsquo;s file-naming scheme is not limited to &ldquo;notes&rdquo;. It can be used
for all types of file, including those that are not editable in Emacs,
such as videos. Naming files in a consistent way makes their
filtering and retrieval considerably easier. Denote provides relevant
facilities to rename files, regardless of file type.
</p>

<ul class="org-ul">
<li>Package name (GNU ELPA): <code>denote</code></li>
<li>Official manual: <a href="https://protesilaos.com/emacs/denote">https://protesilaos.com/emacs/denote</a></li>
<li>Change log: <a href="https://protesilaos.com/emacs/denote-changelog">https://protesilaos.com/emacs/denote-changelog</a></li>
<li>Git repositories:
<ul class="org-ul">
<li>GitHub: <a href="https://github.com/protesilaos/denote">https://github.com/protesilaos/denote</a></li>
<li>GitLab: <a href="https://gitlab.com/protesilaos/denote">https://gitlab.com/protesilaos/denote</a></li>
</ul></li>
<li>Video demo: <a href="https://protesilaos.com/codelog/2022-06-18-denote-demo/">https://protesilaos.com/codelog/2022-06-18-denote-demo/</a></li>
<li>Backronyms: Denote Everything Neatly; Omit The Excesses.  Don&rsquo;t Ever
Note Only The Epiphenomenal.</li>
</ul>

<div class="org-src-container">
<pre class="src src-emacs-lisp">;;; Denote (simple note-taking and file-naming)

;; Read the manual: &lt;https://protesilaos.com/emacs/denote&gt;.  This does
;; not include all the useful features of Denote.  I have a separate
;; private setup for those, as I need to test everything is in order.
(use-package denote
  :ensure t
  :hook
  ;; If you use Markdown or plain text files you want to fontify links
  ;; upon visiting the file (Org renders links as buttons right away).
  ((text-mode . denote-fontify-links-mode-maybe)

   ;; Highlight Denote file names in Dired buffers.  Below is the
   ;; generic approach, which is great if you rename files Denote-style
   ;; in lots of places as I do.
   ;;
   ;; If you only want the `denote-dired-mode' in select directories,
   ;; then modify the variable `denote-dired-directories' and use the
   ;; following instead:
   ;;
   ;;  (dired-mode . denote-dired-mode-in-directories)
   (dired-mode . denote-dired-mode))
  :bind
  ;; Denote DOES NOT define any key bindings.  This is for the user to
  ;; decide.  Here I only have a subset of what Denote offers.
  ( :map global-map
    ("C-c n n" . denote)
    ("C-c n N" . denote-type)
    ("C-c n o" . denote-sort-dired) ; "order" mnemonic
    ;; Note that `denote-rename-file' can work from any context, not
    ;; just Dired buffers.  That is why we bind it here to the
    ;; `global-map'.
    ;;
    ;; Also see `denote-rename-file-using-front-matter' further below.
    ("C-c n r" . denote-rename-file)
    ;; If you intend to use Denote with a variety of file types, it is
    ;; easier to bind the link-related commands to the `global-map', as
    ;; shown here.  Otherwise follow the same pattern for
    ;; `org-mode-map', `markdown-mode-map', and/or `text-mode-map'.
    :map text-mode-map
    ("C-c n i" . denote-link) ; "insert" mnemonic
    ("C-c n I" . denote-add-links)
    ("C-c n b" . denote-backlinks)
    ;; Also see `denote-rename-file' further above.
    ("C-c n R" . denote-rename-file-using-front-matter)
    :map org-mode-map
    ("C-c n d l" . denote-org-extras-dblock-insert-links)
    ("C-c n d b" . denote-org-extras-dblock-insert-backlinks)
    ;; Key bindings specifically for Dired.
    :map dired-mode-map
    ("C-c C-d C-i" . denote-dired-link-marked-notes)
    ("C-c C-d C-r" . denote-dired-rename-marked-files)
    ("C-c C-d C-k" . denote-dired-rename-marked-files-with-keywords)
    ("C-c C-d C-f" . denote-dired-rename-marked-files-using-front-matter))
  :config
  ;; Remember to check the doc strings of those variables.
  (setq denote-directory (expand-file-name "~/Documents/notes/"))
  (setq denote-file-type 'text) ; Org is the default file type

  ;; If you want to have a "controlled vocabulary" of keywords,
  ;; meaning that you only use a predefined set of them, then you want
  ;; `denote-infer-keywords' to be nil and `denote-known-keywords' to
  ;; have the keywords you need.
  (setq denote-known-keywords '("emacs" "philosophy" "politics" "economics"))
  (setq denote-infer-keywords t)
  (setq denote-sort-keywords t)

  (setq denote-excluded-directories-regexp nil)
  (setq denote-date-format nil) ; read its doc string
  (setq denote-rename-confirmations nil) ; CAREFUL with this if you are not familiar with Denote!

  (setq denote-backlinks-show-context nil)

  (setq denote-rename-buffer-format "[D] %t%b")
  (setq denote-buffer-has-backlinks-string " (&lt;---&gt;)")

  ;; Automatically rename Denote buffers when opening them so that
  ;; instead of their long file name they have a literal "[D]"
  ;; followed by the file's title.  Read the doc string of
  ;; `denote-rename-buffer-format' for how to modify this.
  (denote-rename-buffer-mode 1))
</pre>
</div>
</div>
<div id="outline-container-h:ee82e629-fb05-4c75-9175-48a760a25691" class="outline-5">
<h5 id="h:ee82e629-fb05-4c75-9175-48a760a25691"><span class="section-number-5">5.10.17.1.</span> The <code>prot-emacs-langs.el</code> integration between Consult and Denote (<code>consult-denote</code>)</h5>
<div class="outline-text-5" id="text-h:ee82e629-fb05-4c75-9175-48a760a25691">
<p>
This is another package of mine which extends my <code>denote</code> package
(<a href="#h:e86a66dc-7ef9-4f09-ad7e-946de2034e8d">The <code>prot-emacs-langs.el</code> settings for <code>denote</code> (notes and file-naming)</a>).
</p>

<p>
This is glue code to integrate <code>denote</code> with Daniel Mendler&rsquo;s
<code>consult</code> (<a href="#h:22e97b4c-d88d-4deb-9ab3-f80631f9ff1d">The <code>prot-emacs-completion.el</code> settings for <code>consult</code></a>). The
idea is to enhance minibuffer interactions, such as by providing a
preview of the file-to-linked/opened and by adding more sources to the
<code>consult-buffer</code> command.
</p>

<ul class="org-ul">
<li>Package name (GNU ELPA): <code>consult-denote</code></li>
<li>Official manual: not available yet.</li>
<li>Change log: not available yet.</li>
<li>Git repositories:
<ul class="org-ul">
<li>GitHub: <a href="https://github.com/protesilaos/consult-denote">https://github.com/protesilaos/consult-denote</a></li>
</ul></li>
<li>Backronym: Consult-Orchestrated Navigation and Selection of
Unambiguous Targets&#x2026;denote.</li>
</ul>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(when prot-emacs-completion-extras
  (use-package consult-denote
    :ensure t
    :bind
    (("C-c n f" . consult-denote-find)
     ("C-c n g" . consult-denote-grep))
    :config
    (consult-denote-mode 1)))
</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-h:137c67f1-b112-42b7-aec9-c44ef4a6241a" class="outline-4">
<h4 id="h:137c67f1-b112-42b7-aec9-c44ef4a6241a"><span class="section-number-4">5.10.18.</span> The <code>prot-emacs-langs.el</code> settings for <code>logos</code> (writing extras and buffer navigation)</h4>
<div class="outline-text-4" id="text-h:137c67f1-b112-42b7-aec9-c44ef4a6241a">
<p>
This package provides a simple approach to setting up a &ldquo;focus mode&rdquo;.
It uses the <code>page-delimiter</code> (typically <code>^L</code>) or the outline together
with some commands to move between pages whether narrowing is in effect
or not. It also provides some optional aesthetic tweaks which come into
effect when the buffer-local <code>logos-focus-mode</code> is enabled. The manual
shows how to extend the code to achieve the desired result.
</p>

<p>
I use <code>logos</code> to do video presentations that involve &ldquo;slides&rdquo;. Each
heading/section becomes its own &ldquo;slide&rdquo; simply by narrowing to it.
</p>

<ul class="org-ul">
<li>Package name (GNU ELPA): <code>logos</code></li>
<li>Official manual: <a href="https://protesilaos.com/emacs/logos">https://protesilaos.com/emacs/logos</a></li>
<li>Change log: <a href="https://protesilaos.com/emacs/logos-changelog">https://protesilaos.com/emacs/logos-changelog</a></li>
<li>Git repositories:
<ul class="org-ul">
<li>GitHub: <a href="https://github.com/protesilaos/logos">https://github.com/protesilaos/logos</a></li>
<li>GitLab: <a href="https://gitlab.com/protesilaos/logos">https://gitlab.com/protesilaos/logos</a></li>
</ul></li>
<li>Video demo: <a href="https://protesilaos.com/codelog/2022-03-11-emacs-logos-demo/">https://protesilaos.com/codelog/2022-03-11-emacs-logos-demo/</a></li>
<li>Backronyms: <code>^L</code> Only Generates Ostensible Slides; Logos Optionally Goes through Outline Sections</li>
</ul>

<div class="org-src-container">
<pre class="src src-emacs-lisp">;;; Custom extensions for "focus mode" (logos.el)
;; Read the manual: &lt;https://protesilaos.com/emacs/logos&gt;.
(use-package olivetti
  :ensure t
  :commands (olivetti-mode)
  :config
  (setq olivetti-body-width 0.7)
  (setq olivetti-minimum-body-width 80)
  (setq olivetti-recall-visual-line-mode-entry-state t))

(use-package logos
  :ensure t
  :bind
  (("C-x n n" . logos-narrow-dwim)
   ("C-x ]" . logos-forward-page-dwim)
   ("C-x [" . logos-backward-page-dwim)
   ;; I don't think I ever saw a package bind M-] or M-[...
   ("M-]" . logos-forward-page-dwim)
   ("M-[" . logos-backward-page-dwim)
   ("&lt;f9&gt;" . logos-focus-mode))
  :config
  (setq logos-outlines-are-pages t)
  (setq logos-outline-regexp-alist
        `((emacs-lisp-mode . ,(format "\\(^;;;+ \\|%s\\)" logos-page-delimiter))
          (org-mode . ,(format "\\(^\\*+ +\\|^-\\{5\\}$\\|%s\\)" logos-page-delimiter))
          (markdown-mode . ,(format "\\(^\\#+ +\\|^[*-]\\{5\\}$\\|^\\* \\* \\*$\\|%s\\)" logos-page-delimiter))
          (conf-toml-mode . "^\\[")))

  ;; These apply when `logos-focus-mode' is enabled.  Their value is
  ;; buffer-local.
  (setq-default logos-hide-mode-line t)
  (setq-default logos-hide-header-line t)
  (setq-default logos-hide-buffer-boundaries t)
  (setq-default logos-hide-fringe t)
  (setq-default logos-variable-pitch t) ; see my `fontaine' configurations
  (setq-default logos-buffer-read-only nil)
  (setq-default logos-scroll-lock nil)
  (setq-default logos-olivetti t)

  (add-hook 'enable-theme-functions #'logos-update-fringe-in-buffers)

;;;; Extra tweaks
  ;; place point at the top when changing pages, but not in `prog-mode'
  (defun prot/logos--recenter-top ()
    "Use `recenter' to reposition the view at the top."
    (unless (derived-mode-p 'prog-mode)
      (recenter 1))) ; Use 0 for the absolute top

  (add-hook 'logos-page-motion-hook #'prot/logos--recenter-top))
</pre>
</div>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(provide 'prot-emacs-langs)
</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-h:755e195b-9471-48c7-963b-33055969b4e2" class="outline-3">
<h3 id="h:755e195b-9471-48c7-963b-33055969b4e2"><span class="section-number-3">5.11.</span> The <code>prot-emacs-email.el</code> module</h3>
<div class="outline-text-3" id="text-h:755e195b-9471-48c7-963b-33055969b4e2">
<p>
[ Also see: <a href="#h:33151014-3621-4be6-9185-aacc34ee2d2c">Overview of my email setup (<code>mbsync</code>, <code>msmtp</code>, mail indexer, and MUA)</a>. ]
</p>

<p>
Email inside of Emacs is one of the best changes I have ever made to
my workflow. I consider it far better than the <code>mutt</code> setup I once
had. The benefits are down to the interconnectedness of the Emacs
environment (watch: <a href="https://protesilaos.com/codelog/2020-10-21-emacs-favourite-package/">Why Emacs itself is my &ldquo;favourite Emacs package&rdquo;</a>
(2020-10-21)). All text editing capabilities are available. Same for
buffer navigation. Same for themes and fonts. Then we have integration
with <code>org-capture</code> to quickly produce a task that shows up on the Org
agenda and has a link back to the original email (<a href="#h:f8f06938-0dfe-45c3-b4cf-996d36cba82d">The <code>prot-emacs-org.el</code> Org capture templates</a>).
And there is also the seamless connection between Emacs and GPG, so any
encrypted file/email is decrypted behind the scenes with us
experiencing it as every other regular file. Fantastic stuff!
</p>
</div>
<div id="outline-container-h:24f17614-ee3d-4cd1-bbe3-f53e4f39c281" class="outline-4">
<h4 id="h:24f17614-ee3d-4cd1-bbe3-f53e4f39c281"><span class="section-number-4">5.11.1.</span> The <code>prot-emacs-email.el</code> basic settings (including <code>authinfo</code>)</h4>
<div class="outline-text-4" id="text-h:24f17614-ee3d-4cd1-bbe3-f53e4f39c281">
<p>
Emacs reads login credentials from the list of files specified in the
user option <code>auth-sources</code>. I set it to a single GPG-encrypted entry.
The contents of that file look like this:
</p>

<pre class="example" id="orgc101654">
machine pub port 993 login SOME-USER-NAME-HERE-1 password SOME-PASSWORD-HERE
machine inf port 993 login SOME-USER-NAME-HERE-2 password SOME-PASSWORD-HERE

machine smtp.some-server.com port 465 login SOME-USER-NAME-HERE-1 password SOME-PASSWORD-HERE
machine mail.other-server.com port 465 login SOME-USER-NAME-HERE-2 password SOME-PASSWORD-HERE
</pre>

<p>
Each line can be read as a map of key-value pairs. Think of it like this:
</p>

<pre class="example" id="orgb6328b1">
machine pub
port 993
login SOME-USER-NAME-HERE-1
password SOME-PASSWORD-HERE-1
</pre>

<p>
Depending on the settings and the applicable program, Emacs reads this
file to establish a connection. This is not limited to emails, mind
you, as we can have credentials such as for running <code>sudo</code> via TRAMP
or logging in to IRC with the <code>rcirc</code> command (<a href="#h:f23d9cef-ab7b-4486-a070-9c7ae664eadf">The <code>prot-emacs-web.el</code> module</a>).
</p>

<p>
For my email purposes, Emacs does not read from the <code>auth-sources</code>,
though I do keep this in place for other programs to read from. These
programs include <code>mbsync</code> and <code>msmtp</code> (<a href="#h:33151014-3621-4be6-9185-aacc34ee2d2c">How I use email in Emacs</a>).
</p>

<p>
Other than that, all I do in this snippet is set the default name and
email, which are consulted by miscellaneous pieces Emacs functionality.
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">;;;; File with authentication credentials (`auth-source')
(use-package auth-source
  :ensure nil
  :defer t
  :config
  (setq auth-sources '("~/.authinfo.gpg")
        user-full-name "Protesilaos Stavrou"
        user-mail-address "public@protesilaos.com"))
</pre>
</div>
</div>
</div>
<div id="outline-container-h:49815c07-737f-4f10-95ee-63640f9ae18b" class="outline-4">
<h4 id="h:49815c07-737f-4f10-95ee-63640f9ae18b"><span class="section-number-4">5.11.2.</span> The <code>prot-emacs-email.el</code> message composition and encryption settings (<code>message.el</code>)</h4>
<div class="outline-text-4" id="text-h:49815c07-737f-4f10-95ee-63640f9ae18b">
<p>
Across all Emacs email clients that I have used (<code>gnus</code>, <code>mu4e</code>, and
<code>notmuch</code>) message composition is handled by the same built-in library:
<code>message.el</code>. It produces a buffer with email headers at the top,
followed by a separator line, and then the body of the message where
we write what we want. The body can have a signature automatically
appended to it.
</p>

<p>
Message buffers can integrate with the system&rsquo;s GPG agent to encrypt
the current message. This is done by inserting a special MIME tag at
the top of the message body. I do it by typing <code>C-c C-m C-e</code>, which
invokes the command <code>mml-secure-message-sign-encrypt</code>. If the GPG
agent is running and the password is already saved in the keyring, the
message is sent encrypted without any further prompts (Emacs generally
treats encrypted files transparently if everything is set up at the
environment level).
</p>

<p>
When replying to emails I receive, I normally comment inline by citing
the original message. Concretely, this looks like this:
</p>

<pre class="example" id="org7a57774">
&gt; Some text I am commenting on.

My comment on it.
</pre>

<p>
The settings I have for citing messages ensure that the top of the
message includes the <code>From</code> and <code>Date</code> headers, so the original email
I am replying to looks like this in my message composition buffer:
</p>

<pre class="example" id="org6732468">
&gt; From: Some Name &lt;name@domain.tld&gt;
&gt; Date: Tue,  9 Jan 2024 06:58:38 +0200
&gt;
&gt; Some text I am commenting on.

My comment on it.
</pre>

<p>
Check the documentation of the <code>format-time-string</code> function to
understand how the date is defined in the user option <code>message-citation-line-format</code>.
</p>

<p>
When citing a portion of text, I do not need to include the entirety
of it, but also the parts that are pertinent to the matter at hand. I
thus frequently elide text by marking it and then typing <code>C-c C-e</code>
(<code>message-elide-region</code>). The <code>message-elide-ellipsis</code> I specify here
turns the region into a cited snippet that references the line count, like:
</p>

<pre class="example" id="org7d8a721">
&gt; From: Some Name &lt;name@domain.tld&gt;
&gt; Date: Tue,  9 Jan 2024 06:58:38 +0200
&gt;
&gt; Some text I am commenting on.

My comment on it.

&gt; Something that shows lots of details I do not need to keep in place:
&gt;
&gt; [... 20 lines elided]

Another comment of mine here.
</pre>

<p>
To attach a file, type <code>C-c C-a</code> (<code>mml-attach-file</code>). This uses
minibuffer completion to select a single file. An alternative is to
use <code>dired</code> to produce a file listing, mark the relevant files, and
attach them from there (<a href="#h:deccd4f1-c1bd-4b02-993e-914f57ea0fac">The <code>prot-emacs-email.el</code> integration with Dired for email attachments (<code>gnus-dired-mode</code>)</a>)
</p>

<p>
Once the message is done, type <code>C-c C-c</code> to send it. The exact command
depends on the mail user agent. In my case, it is <code>notmuch-mua-send-and-exit</code>.
By default, Emacs prompts for confirmation before sending out the
message. I disable that by modifying <code>message-confirm-send</code>.
Similarly, I prefer to delete the buffer of a sent message, so I
change the value of <code>message-kill-buffer-on-exit</code>.
</p>

<p>
Between frictionless encryption and the ease of editing text in a
message composition buffer, the email setup I have in Emacs is the
most potent I have ever used (<a href="#h:33151014-3621-4be6-9185-aacc34ee2d2c">Overview of my email setup (<code>mbsync</code>, <code>msmtp</code>, mail indexer, and MUA)</a>).
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">;;;; Encryption settings (`mm-encode' and `mml-sec')

(use-package mm-encode
  :ensure nil
  :defer t
  :config
  (setq mm-encrypt-option nil ; use 'guided for both if you need more control
        mm-sign-option nil))

(use-package mml-sec
  :ensure nil
  :defer t
  :config
  (setq mml-secure-openpgp-encrypt-to-self t
        mml-secure-openpgp-sign-with-sender t
        mml-secure-smime-encrypt-to-self t
        mml-secure-smime-sign-with-sender t))

;;;; Message composition (`message')

(use-package message
  :ensure nil
  :defer t
  :hook
  (message-setup . message-sort-headers)
  :config
  (setq mail-user-agent 'message-user-agent
        message-mail-user-agent t) ; use `mail-user-agent'
  (setq mail-header-separator "--text follows this line--")
  (setq message-elide-ellipsis "\n&gt; [... %l lines elided]\n")
  (setq compose-mail-user-agent-warnings nil)
  (setq message-signature "Protesilaos Stavrou\nhttps://protesilaos.com\n"
        mail-signature message-signature)
  (setq message-citation-line-function #'message-insert-formatted-citation-line)
  (setq message-citation-line-format (concat "&gt; From: %f\n"
                                             "&gt; Date: %a, %e %b %Y %T %z\n"
                                             "&gt;")
        message-ignored-cited-headers "") ; default is "." for all headers
  (setq message-confirm-send nil)
  (setq message-kill-buffer-on-exit t)
  ;; (add-to-list 'mm-body-charset-encoding-alist '(utf-8 . base64))
  (setq message-wide-reply-confirm-recipients nil))
</pre>
</div>
</div>
</div>
<div id="outline-container-h:deccd4f1-c1bd-4b02-993e-914f57ea0fac" class="outline-4">
<h4 id="h:deccd4f1-c1bd-4b02-993e-914f57ea0fac"><span class="section-number-4">5.11.3.</span> The <code>prot-emacs-email.el</code> integration with Dired for email attachments (<code>gnus-dired-mode</code>)</h4>
<div class="outline-text-4" id="text-h:deccd4f1-c1bd-4b02-993e-914f57ea0fac">
<p>
The whole point of using Emacs is to draw linkages between different
specialised tools. One such case is to use the built-in file manager
to select some files and attach them to the currently open message
composition buffer (<a href="#h:f8b08a77-f3a8-42fa-b1a9-f940348889c3">The <code>prot-emacs-dired.el</code> module</a>). Do it by typing
<code>C-c C-m C-a</code> (<code>gnus-dired-attach</code>). This also works without an open
message composition buffer. In that case, it produces such a buffer,
with the attachments in place. Though I usually have the message buffer
in place before going to <code>dired</code> to find some attachments
(<a href="#h:49815c07-737f-4f10-95ee-63640f9ae18b">The <code>prot-emacs-email.el</code> message composition and encryption settings (<code>message.el</code>)</a>).
</p>

<p>
Note that the minor mode which sets up the relevant settings is called
<code>gnus-dired-mode</code>, although it does not require <code>gnus</code> and its
numerous accoutrements.
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">;;;; Add attachments from Dired (`gnus-dired' does not require `gnus')
(use-package gnus-dired
  :ensure nil
  :after message
  :hook
  (dired-mode . turn-on-gnus-dired-mode))
</pre>
</div>
</div>
</div>
<div id="outline-container-h:c7c9815c-e259-4810-816a-9ebc1a146004" class="outline-4">
<h4 id="h:c7c9815c-e259-4810-816a-9ebc1a146004"><span class="section-number-4">5.11.4.</span> The <code>prot-emacs-email.el</code> settings for <code>sendmail</code></h4>
<div class="outline-text-4" id="text-h:c7c9815c-e259-4810-816a-9ebc1a146004">
<p>
As I explain in the <a href="#h:33151014-3621-4be6-9185-aacc34ee2d2c">Overview of my email setup (<code>mbsync</code>, <code>msmtp</code>, mail indexer, and MUA)</a>,
I use the external <code>msmtp</code> program to handle email sending, else to
set up the Mail Transfer Agent (MTA). With <code>msmtp</code> and a compatibility
package installed (<code>msmtp-mta</code> on Arch Linux), the standard <code>sendmail</code>
executable becomes a symlink to the <code>msmtp</code> program.
</p>

<p>
I use this method because it is more portable and flexible. With the
standard built-in Emacs design to use the <code>smtpmail-send-it</code> function
as the value of <code>send-mail-function</code>, I also need to declare in Elisp
what the SMTP server is. I would rather encapsulate the login
credentials in a separate configuration file, independent of Emacs,
while also ensuring that different accounts can use their own SMTP
server.
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">;;;; `sendmail' (mail transfer agent)
(use-package sendmail
  :ensure nil
  :after message
  :config
  (setq send-mail-function 'sendmail-send-it
        ;; ;; NOTE 2023-08-08: We do not need this if we have the Arch
        ;; ;; Linux `msmtp-mta' package installed: it replaces the
        ;; ;; generic sendmail executable with msmtp.
        ;;
        ;; sendmail-program (executable-find "msmtp")
        message-sendmail-envelope-from 'header))
</pre>
</div>
</div>
</div>
<div id="outline-container-h:200bc618-678a-4dc8-9d30-876d89e1edae" class="outline-4">
<h4 id="h:200bc618-678a-4dc8-9d30-876d89e1edae"><span class="section-number-4">5.11.5.</span> The <code>prot-emacs-email.el</code> loading of the email client and call to <code>provide</code></h4>
<div class="outline-text-4" id="text-h:200bc618-678a-4dc8-9d30-876d89e1edae">
<p>
All the above are the client-agnostic settings. Now I have to put in
place the specifics of my mail user agent. I could have a user option
here to select one among <code>notmuch</code>, <code>mu4e</code>, or <code>gnus</code>, but it is not
practical to have two indexers check the same files, as I will need to
keep everything in sync for no apparent benefit. One MUA is more than
enough (<a href="#h:b26c6297-ebe8-4f99-b069-df53cfd90520">The <code>prot-emacs-email.el</code> submodule for <code>notmuch</code> (<code>prot-emacs-notmuch.el</code>)</a>).
</p>

<p>
Finally, we <code>provide</code> the module. This is the mirror function of
<code>require</code> (<a href="#h:e6c4acf5-5b51-4b38-a86a-bf3f698ac872">The init.el final part to load the individual modules</a>).
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(when (executable-find "notmuch")
  (require 'prot-emacs-notmuch))

(provide 'prot-emacs-email)
</pre>
</div>
</div>
</div>
<div id="outline-container-h:b26c6297-ebe8-4f99-b069-df53cfd90520" class="outline-4">
<h4 id="h:b26c6297-ebe8-4f99-b069-df53cfd90520"><span class="section-number-4">5.11.6.</span> The <code>prot-emacs-email.el</code> submodule for <code>notmuch</code> (<code>prot-emacs-notmuch.el</code>)</h4>
<div class="outline-text-4" id="text-h:b26c6297-ebe8-4f99-b069-df53cfd90520">
<p>
When we refer to <code>notmuch</code> we cover three distinct concepts:
</p>

<dl class="org-dl">
<dt>The command-line mail indexer</dt><dd>It produces a database out of our
local mail directory. We can then query the database to get to the
email we are looking for.</dd>

<dt>The Mail User Agent (MUA), else email client</dt><dd>It provides an
Emacs interface to the aforementioned indexer. This MUA also draws
linkages between other programs, to write and send messages. The
user does not need to know that under the hood it is not one
&ldquo;thing&rdquo; that gets the job done, though this is how it appears prima
facie.</dd>

<dt>The system package</dt><dd>At least on Arch Linux and Debian, the
<code>notmuch</code> package bundles together the above two. In fact, the
indexer and the Emacs MUA are maintained in tandem by the same
developers.</dd>
</dl>

<p>
I install the system package to get the command-line utility. Since it
ships with the Emacs files, I do not install the relevant Emacs
package, but arrange for the <code>notmuch</code> system path to be added to the
Emacs <code>load-path</code>. The <code>load-path</code> is where Emacs checks to find Elisp
programs (when we <code>require</code> some feature, it works because of its
directory being part of the <code>load-path</code>).
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">;;; Notmuch (mail indexer and mail user agent (MUA))

;; I install notmuch from the distro's repos because the CLI program is
;; not dependent on Emacs.  Though the package also includes notmuch.el
;; which is what we use here (they are maintained by the same people).
(use-package notmuch
  :load-path "/usr/share/emacs/site-lisp/"
  :defer t
  :commands (notmuch notmuch-mua-new-mail))
</pre>
</div>
</div>
<div id="outline-container-h:2fca749c-a84e-415c-9ac0-b1518d06fa51" class="outline-5">
<h5 id="h:2fca749c-a84e-415c-9ac0-b1518d06fa51"><span class="section-number-5">5.11.6.1.</span> The <code>prot-emacs-notmuch.el</code> section about the account settings</h5>
<div class="outline-text-5" id="text-h:2fca749c-a84e-415c-9ac0-b1518d06fa51">
<p>
To actually use the <code>notmuch</code> mail user agent (<a href="#h:b26c6297-ebe8-4f99-b069-df53cfd90520">The <code>prot-emacs-email.el</code> submodule for <code>notmuch</code> (<code>prot-emacs-notmuch.el</code>)</a>),
we need to specify (i) who we are and (ii) where should sent mail be
directed to. This is what the user options <code>notmuch-identities</code> and
<code>notmuch-fcc-dirs</code> are about.
</p>

<p>
Notice that I use the <code>prot-common-auth-get-field</code> function, which
reads data from my encrypted <code>~/.authinfo.gpg</code> file (<a href="#h:24f17614-ee3d-4cd1-bbe3-f53e4f39c281">The <code>prot-emacs-email.el</code> basic settings (including <code>authinfo</code>)</a>).
In <code>prot-common.el</code>, I define a few helper functions that are general
in nature and may be used by other Elisp snippets of mine (<a href="#h:3fccfadf-22e9-457f-b9fd-ed1b48600d23">The <code>prot-common.el</code> library</a>).
Doing things this way ensures that I do not share the details about
the accounts I set.
</p>

<p>
At any rate, the format of <code>notmuch-identities</code> is like this:
</p>

<pre class="example" id="org751944c">
(setq notmuch-identities '("Protesilaos Stavrou &lt;someone@somewhere.com&gt;" "Prot &lt;just-my-nickname@somewhere.com&gt;"))
</pre>

<p>
While the corresponding <code>notmuch-fcc-dirs</code> map those accounts to the
relative path of their local sent mail folder (it is relative to the
root of the directory that <code>notmuch</code> indexes, so something like
<code>~/.mail/pub/Sent</code> needs to be written as <code>pub/Sent</code>). The data
structure looks like this:
</p>

<pre class="example" id="orgc0a838d">
(setq notmuch-fcc-dirs
      '(("someone@somewhere.com" . "someone/Sent")
        ("nickname@somewhere.com" . "nickname/Sent")))
</pre>

<p>
Now the actual code I use:
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">;;; Account settings
(use-package notmuch
  :defer t
  :config
  (let ((prv (prot-common-auth-get-field "prv-gandi" :user))
        (pub (prot-common-auth-get-field "pub-gandi" :user))
        (inf (prot-common-auth-get-field "inf-gandi" :user))
        (box (prot-common-auth-get-field "prot-gandi" :user)))
    (setq notmuch-identities
          (mapcar (lambda (str)
                    (format "%s &lt;%s&gt;" user-full-name str))
                  (list prv pub inf box))
          notmuch-fcc-dirs
          `((,prv . "gandi/Sent")
            (,inf . "gandi/Sent")
            (,pub . "gandi/Sent")
            (,box . "gandi/Sent")))))
</pre>
</div>
</div>
</div>
<div id="outline-container-h:2c9a555f-d3ec-4d0e-bad6-6c26b576a49a" class="outline-5">
<h5 id="h:2c9a555f-d3ec-4d0e-bad6-6c26b576a49a"><span class="section-number-5">5.11.6.2.</span> The <code>prot-emacs-notmuch.el</code> section about the general user interface</h5>
<div class="outline-text-5" id="text-h:2c9a555f-d3ec-4d0e-bad6-6c26b576a49a">
<p>
When we use the <code>notmuch</code> Emacs command to get into the mail user
agent (<a href="#h:b26c6297-ebe8-4f99-b069-df53cfd90520">The <code>prot-emacs-email.el</code> submodule for <code>notmuch</code> (<code>prot-emacs-notmuch.el</code>)</a>),
we are presented in the &ldquo;hello&rdquo; buffer. It contains a set of
pseudo-graphical widgets to check the available tags, view recent
searches, perform a new search, and the like. I find it too busy and
not useful, as all that functionality is already available directly
with key bindings. Why nagivate all the way to the search box when <code>s</code>
(<code>notmuch-search</code>) initiates a new search? As always, use <code>M-x
describe-mode</code> (or type <code>C-h m</code>) to learn about the keys and commands
of the current major mode (as well as to check all the minor modes
that are effective therein).
</p>

<p>
My &ldquo;hello&rdquo; buffer is a single vertical listing of my saved searches.
Those include the name of the search, such as <code>inbox</code>, followed by a
total message count. Everything else is removed. As such, the values
of <code>notmuch-hello-recent-searches-max</code> and <code>notmuch-show-all-tags-list</code>
are not relevant.
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">;;;; General UI
(use-package notmuch
  :defer t
  :config
  (setq notmuch-show-logo nil
        notmuch-column-control 1.0
        notmuch-hello-auto-refresh t
        notmuch-hello-recent-searches-max 20
        notmuch-hello-thousands-separator ""
        notmuch-hello-sections '(notmuch-hello-insert-saved-searches)
        notmuch-show-all-tags-list t))
</pre>
</div>
</div>
</div>
<div id="outline-container-h:eddc38d8-d1c1-48a4-8fa1-ce9ab2820ee3" class="outline-5">
<h5 id="h:eddc38d8-d1c1-48a4-8fa1-ce9ab2820ee3"><span class="section-number-5">5.11.6.3.</span> The <code>prot-emacs-notmuch.el</code> section about the presentation of search buffers</h5>
<div class="outline-text-5" id="text-h:eddc38d8-d1c1-48a4-8fa1-ce9ab2820ee3">
<p>
The search buffers are the interface I work with the most. They
provide a listing of all message threads that match the given search
terms.
</p>

<p>
Most of the configurations I have here are stylistic in nature. The
one that defines necessary functionality is the value of the user
option <code>notmuch-saved-searches</code>. The <code>:query</code> of those saved searches
is what we would normally pass at the command line on the <code>notmuch
search</code> invocation, or inside of the mail user agent by typing <code>s</code>
(<code>notmuch-search</code>).
</p>

<p>
The emoji spotted here and elsewhere are purely cosmetic: they do not
form part of the search terms or tags.
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">;;;; Search
(use-package notmuch
  :defer t
  :config
  (setq notmuch-search-oldest-first nil)
  (setq notmuch-search-result-format
        '(("date" . "%12s  ")
          ("count" . "%-7s  ")
          ("authors" . "%-20s  ")
          ("subject" . "%-80s  ")
          ("tags" . "(%s)")))
  (setq notmuch-tree-result-format
        '(("date" . "%12s  ")
          ("authors" . "%-20s  ")
          ((("tree" . "%s")
            ("subject" . "%s"))
           . " %-80s  ")
          ("tags" . "(%s)")))
  (setq notmuch-search-line-faces
        '(("unread" . notmuch-search-unread-face)
          ;; ;; NOTE 2022-09-19: I disable this because I add a cosmeic
          ;; ;; emoji via `notmuch-tag-formats'.  This way I do not get
          ;; ;; an intense style which is very distracting when I filter
          ;; ;; my mail to include this tag.
          ;;
          ;; ("flag" . notmuch-search-flagged-face)
          ;;
          ;; Using `italic' instead is just fine.  Though I also tried
          ;; it without any face and I was okay with it.  The upside of
          ;; having a face is that you can identify the message even
          ;; when the window is split and you don't see the tags.
          ("flag" . italic)))
  (setq notmuch-show-empty-saved-searches t)
  (setq notmuch-saved-searches
        `(( :name "📥 inbox"
            :query "tag:inbox"
            :sort-order newest-first
            :key ,(kbd "i"))
          ( :name "📚 all unread (inbox)"
            :query "tag:unread and tag:inbox"
            :sort-order newest-first
            :key ,(kbd "u"))
          ( :name "💬 unread other (inbox)"
            :query "tag:unread and tag:inbox and not tag:package and not tag:coach"
            :sort-order newest-first
            :key ,(kbd "o"))
          ( :name "🗂️ unread packages"
            :query "tag:unread and tag:package"
            :sort-order newest-first
            :key ,(kbd "p"))
          ;; My coaching job: &lt;https://protesilaos.com/coach/&gt;.
          ( :name "🏆 unread coaching"
            :query "tag:unread and tag:coach"
            :sort-order newest-first
            :key ,(kbd "c")))))
</pre>
</div>
</div>
</div>
<div id="outline-container-h:f19e7ef2-9a90-4fbd-879b-8ee0acfa1b5a" class="outline-5">
<h5 id="h:f19e7ef2-9a90-4fbd-879b-8ee0acfa1b5a"><span class="section-number-5">5.11.6.4.</span> The <code>prot-emacs-notmuch.el</code> section about tag settings</h5>
<div class="outline-text-5" id="text-h:f19e7ef2-9a90-4fbd-879b-8ee0acfa1b5a">
<p>
Part of the value of using a mail indexer is the ability to tag
messages. These help with data retrieval and filtering. For <code>notmuch</code>,
tags are a purely indexing construct, meaning that they are not
written to the underlying file. An exception to this are the standard
IMAP tags for read/unread, seen, attachments, and deleted (I think
that&rsquo;s all, but please double check).
</p>

<p>
The <code>+</code> or <code>-</code> prefix indicates whether a tag is added or removed from
the list. The same characters work as key bindings in all <code>notmuch</code>
buffers to bring up a minibuffer interface for adding/removing tags.
This interface accepts multiple entries, so even if we start with a
<code>-</code> we can still continue with an addition.
</p>

<p>
Otherwise, tagging operations follow a predefined scheme, specified in
the user option <code>notmuch-tagging-keys</code>. I do not specify its value
here because I give some of my custom functions, hence its
incorporation in the subsequent section about setting up
<code>prot-notmuch.el</code> (<a href="#h:dbd2b775-8f51-451a-8e24-9c8424fd2e89">The <code>prot-emacs-notmuch.el</code> custom extensions (per <code>prot-notmuch.el</code>)</a>).
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">;;;; Tags
(use-package notmuch
  :defer t
  :config
  (setq notmuch-archive-tags nil ; I do not archive email
        notmuch-message-replied-tags '("+replied")
        notmuch-message-forwarded-tags '("+forwarded")
        notmuch-show-mark-read-tags '("-unread")
        notmuch-draft-tags '("+draft")
        notmuch-draft-folder "drafts"
        notmuch-draft-save-plaintext 'ask)

  ;; Also see `notmuch-tagging-keys' in the `prot-notmuch' section
  ;; further below.
  ;;
  ;; All emoji are cosmetic.  The tags are just the text.
  (setq notmuch-tag-formats
        '(("unread" (propertize tag 'face 'notmuch-tag-unread))
          ("flag" (propertize tag 'face 'notmuch-tag-flagged)
           (concat tag "🚩")))
        notmuch-tag-deleted-formats
        '(("unread" (notmuch-apply-face bare-tag 'notmuch-tag-deleted)
           (concat "👁️‍🗨️" tag))
          (".*" (notmuch-apply-face tag 'notmuch-tag-deleted)
           (concat "🚫" tag)))
        notmuch-tag-added-formats
        '(("del" (notmuch-apply-face tag 'notmuch-tag-added)
           (concat "💥" tag))
          (".*" (notmuch-apply-face tag 'notmuch-tag-added)
           (concat "🏷️" tag)))))
</pre>
</div>
</div>
</div>
<div id="outline-container-h:b91c062d-add7-42e6-b425-4fa287763b1b" class="outline-5">
<h5 id="h:b91c062d-add7-42e6-b425-4fa287763b1b"><span class="section-number-5">5.11.6.5.</span> The <code>prot-emacs-notmuch.el</code> section about email composition settings</h5>
<div class="outline-text-5" id="text-h:b91c062d-add7-42e6-b425-4fa287763b1b">
<p>
Most of the settings here are stylistic. I would not mind having them
differently. They are complementary to those germane to the built-in
<code>message.el</code> (<a href="#h:49815c07-737f-4f10-95ee-63640f9ae18b">The <code>prot-emacs-email.el</code> message composition and encryption settings (<code>message.el</code>)</a>).
</p>

<p>
The <code>notmuch-mua-attachment-regexp</code> is a neat little helper to prevent
me from sending out a message without its stipulated attachment. It
can give false positives, as I may write something that is about
&ldquo;emotional attachment&rdquo;, but on the balance I do like being asked for
confirmation where needed.
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">;;;; Email composition
(use-package notmuch
  :defer t
  :config
  (setq notmuch-mua-compose-in 'current-window)
  (setq notmuch-mua-hidden-headers nil)
  (setq notmuch-address-command 'internal)
  (setq notmuch-address-use-company nil)
  (setq notmuch-always-prompt-for-sender t)
  (setq notmuch-mua-cite-function 'message-cite-original-without-signature)
  (setq notmuch-mua-reply-insert-header-p-function 'notmuch-show-reply-insert-header-p-never)
  (setq notmuch-mua-user-agent-function nil)
  (setq notmuch-maildir-use-notmuch-insert t)
  (setq notmuch-crypto-process-mime t)
  (setq notmuch-crypto-get-keys-asynchronously t)
  (setq notmuch-mua-attachment-regexp   ; see `notmuch-mua-send-hook'
        (concat "\\b\\(attache\?ment\\|attached\\|attach\\|"
                "pi[èe]ce\s+jointe?\\|"
                "συνημμ[εέ]νο\\|επισυν[αά]πτω\\)\\b"))

  (defun prot-notmuch-message-tab ()
    "Override for `message-tab' to enforce header line check.
More specifically, perform address completion when on a relevant header
line, because `message-tab' sometimes (not sure when/how) fails to do
that and instead tries to complete against dictionary entries."
    (interactive nil message-mode)
    (cond
     ((save-excursion
        (goto-char (line-beginning-position))
        (looking-at notmuch-address-completion-headers-regexp))
      (notmuch-address-expand-name)
      ;; Completion was performed; nothing else to do.
      nil)
     (message-tab-body-function (funcall message-tab-body-function))
     (t (funcall (or (lookup-key text-mode-map "\t")
                     (lookup-key global-map "\t")
                     'indent-relative)))))

  (advice-add #'message-tab :override #'prot-notmuch-message-tab))
</pre>
</div>
</div>
</div>
<div id="outline-container-h:f2b7a39e-fb10-4886-9765-4be8a1701c67" class="outline-5">
<h5 id="h:f2b7a39e-fb10-4886-9765-4be8a1701c67"><span class="section-number-5">5.11.6.6.</span> The <code>prot-emacs-notmuch.el</code> section about reading messages</h5>
<div class="outline-text-5" id="text-h:f2b7a39e-fb10-4886-9765-4be8a1701c67">
<p>
Some simple tweaks here to get the presentation I like while reading
messages. Everything here is valueble to me, though note the &ldquo;wash&rdquo;
parts. These pertain to a behaviour where long quotes are hidden
behind a button. The idea is to hide most of the text and reveal it on
demand. I never want that: if there is a long section of text there, I
need to see it.
</p>

<p>
Note that the presentation of HTML messages is affected by the state of
the built-in Simple HTML Renderer (<a href="#h:60483672-aeb6-427b-bbef-54a5c31e39ab">The <code>prot-emacs-web.el</code> settings about the Simple HTML Renderer (<code>shr</code>)</a>).
Concretely, there is the <code>shr-use-colors</code> option, which I disable
because I do not want hardcoded values to mess up my theme. As such,
newletters, receipts, etc., which are usually rendered on a white
background will be dark while using a dark theme. This is considerably
nicer.
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">;;;; Reading messages
(use-package notmuch
  :defer t
  :config
  (setq notmuch-show-relative-dates t)
  (setq notmuch-show-all-multipart/alternative-parts nil)
  (setq notmuch-show-indent-messages-width 0)
  (setq notmuch-show-indent-multipart nil)
  (setq notmuch-show-part-button-default-action 'notmuch-show-view-part)
  (setq notmuch-show-text/html-blocked-images ".") ; block everything
  (setq notmuch-wash-wrap-lines-length 120)
  (setq notmuch-unthreaded-show-out nil)
  (setq notmuch-message-headers '("To" "Cc" "Subject" "Date"))
  (setq notmuch-message-headers-visible t)

  (let ((count most-positive-fixnum)) ; I don't like the buttonisation of long quotes
    (setq notmuch-wash-citation-lines-prefix count
          notmuch-wash-citation-lines-suffix count)))
</pre>
</div>
</div>
</div>
<div id="outline-container-h:6148eea6-7859-4b53-95ce-7e198fc831e0" class="outline-5">
<h5 id="h:6148eea6-7859-4b53-95ce-7e198fc831e0"><span class="section-number-5">5.11.6.7.</span> The <code>prot-emacs-notmuch.el</code> section about hooks and key bindings</h5>
<div class="outline-text-5" id="text-h:6148eea6-7859-4b53-95ce-7e198fc831e0">
<p>
Here I set up the following:
</p>

<ul class="org-ul">
<li>Remind me when I am mentioning an attachment but do not include one.
This is done by reading the contents of the message in search for
the <code>notmuch-mua-attachment-regexp</code> (<a href="#h:b91c062d-add7-42e6-b425-4fa287763b1b">The <code>prot-emacs-notmuch.el</code> section about email composition settings</a>).</li>

<li>Do not use a <code>header-line</code> when showing a message. It adds visual
clutter.</li>

<li>Do not activate the <code>notmuch-hl-line-mode</code> because I want the
generic <code>hl-line-mode</code> to take effect instead. This is because I use
my <code>lin</code> package to remap buffer-locally the line highlight to be a
bit more noticeable in major modes where line selection is the main
action (<a href="#h:bf5b4d08-8f33-4a8c-8ecd-fca19bf2497a">The <code>prot-emacs-theme.el</code> section for <code>lin</code></a>).</li>

<li>Define key bindings that make sense to me. The most important change
here is the flipped meaning of the <code>r</code> and <code>R</code> keys, as I want to
reply to all recipients by default. I define some more key bindings
in the section about my custom extensions for Notmuch (<a href="#h:dbd2b775-8f51-451a-8e24-9c8424fd2e89">The <code>prot-emacs-notmuch.el</code> custom extensions (per <code>prot-notmuch.el</code>)</a>).</li>
</ul>

<div class="org-src-container">
<pre class="src src-emacs-lisp">;;;; Hooks and key bindings
(use-package notmuch
  :hook
  (notmuch-mua-send . notmuch-mua-attachment-check) ; also see `notmuch-mua-attachment-regexp'
  (notmuch-show . (lambda () (setq-local header-line-format nil)))
  :config
  (remove-hook 'notmuch-show-hook #'notmuch-show-turn-on-visual-line-mode)
  (remove-hook 'notmuch-search-hook #'notmuch-hl-line-mode) ; Check my `lin' package
  :bind
  ( :map global-map
    ("C-c m" . notmuch)
    ("C-x m" . notmuch-mua-new-mail) ; override `compose-mail'
    :map notmuch-search-mode-map ; I normally don't use the tree view, otherwise check `notmuch-tree-mode-map'
    ("a" . nil) ; the default is too easy to hit accidentally and I do not archive stuff
    ("A" . nil)
    ("/" . notmuch-search-filter) ; alias for l
    ("r" . notmuch-search-reply-to-thread) ; easier to reply to all by default
    ("R" . notmuch-search-reply-to-thread-sender)
    :map notmuch-show-mode-map
    ("a" . nil) ; the default is too easy to hit accidentally and I do not archive stuff
    ("A" . nil)
    ("r" . notmuch-show-reply) ; easier to reply to all by default
    ("R" . notmuch-show-reply-sender)
    :map notmuch-hello-mode-map
    ("C-&lt;tab&gt;" . nil)))
</pre>
</div>
</div>
</div>
<div id="outline-container-h:dbd2b775-8f51-451a-8e24-9c8424fd2e89" class="outline-5">
<h5 id="h:dbd2b775-8f51-451a-8e24-9c8424fd2e89"><span class="section-number-5">5.11.6.8.</span> The <code>prot-emacs-notmuch.el</code> custom extensions (per <code>prot-notmuch.el</code>)</h5>
<div class="outline-text-5" id="text-h:dbd2b775-8f51-451a-8e24-9c8424fd2e89">
<p>
My <code>prot-notmuch.el</code> extension defines a few useful extras for my
email setup (<a href="#h:92ee86b8-0ead-4080-963f-3fbc9f931e3e">The <code>prot-notmuch.el</code> library</a>). These are commands to
quickly perform a tagging operation, such as to mark a messge for
deletion and remove it from the inbox. The key bindings here extend
those that are for the base Notmuch package (<a href="#h:6148eea6-7859-4b53-95ce-7e198fc831e0">The <code>prot-emacs-notmuch.el</code> section about hooks and key bindings</a>).
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">;;; My own tweaks for notmuch (prot-notmuch.el)
(use-package prot-notmuch
  :ensure nil
  :after notmuch
  :bind
  ( :map notmuch-search-mode-map
    ("D" . prot-notmuch-search-delete-thread)
    ("S" . prot-notmuch-search-spam-thread)
    ("g" . prot-notmuch-refresh-buffer)
    :map notmuch-show-mode-map
    ("D" . prot-notmuch-show-delete-message)
    ("S" . prot-notmuch-show-spam-message)
    :map notmuch-show-stash-map
    ("S" . prot-notmuch-stash-sourcehut-link))
  :config
  ;; Those are for the actions that are available after pressing 'k'
  ;; (`notmuch-tag-jump').  For direct actions, refer to the key
  ;; bindings below.
  (setq notmuch-tagging-keys
        `((,(kbd "d") prot-notmuch-mark-delete-tags "💥 Mark for deletion")
          (,(kbd "f") prot-notmuch-mark-flag-tags "🚩 Flag as important")
          (,(kbd "s") prot-notmuch-mark-spam-tags "🔥 Mark as spam")
          (,(kbd "r") ("-unread") "👁️‍🗨️ Mark as read")
          (,(kbd "u") ("+unread") "🗨️ Mark as unread")))

  ;; These emoji are purely cosmetic.  The tag remains the same: I
  ;; would not like to input emoji for searching.
  (add-to-list 'notmuch-tag-formats '("encrypted" (concat tag "🔒")))
  (add-to-list 'notmuch-tag-formats '("attachment" (concat tag "📎")))
  (add-to-list 'notmuch-tag-formats '("coach" (concat tag "🏆")))
  (add-to-list 'notmuch-tag-formats '("package" (concat tag "🗂️"))))
</pre>
</div>
</div>
</div>
<div id="outline-container-h:49890997-448e-408d-bebe-2003259bb125" class="outline-5">
<h5 id="h:49890997-448e-408d-bebe-2003259bb125"><span class="section-number-5">5.11.6.9.</span> The <code>prot-emacs-notmuch.el</code> glue code for <code>org-capture</code> (<code>ol-notmuch.el</code>)</h5>
<div class="outline-text-5" id="text-h:49890997-448e-408d-bebe-2003259bb125">
<p>
This package provides the glue code between Notmuch and Org capture:
</p>

<ul class="org-ul">
<li><a href="#h:b26c6297-ebe8-4f99-b069-df53cfd90520">The <code>prot-emacs-email.el</code> submodule for <code>notmuch</code> (<code>prot-emacs-notmuch.el</code>)</a>.</li>
<li><a href="#h:f8f06938-0dfe-45c3-b4cf-996d36cba82d">The <code>prot-emacs-org.el</code> Org capture templates (<code>org-capture</code>)</a>.</li>
</ul>

<p>
In simple terms, I can create links that point to emails. When I
follow the link, it opens in a fully fledged Notmuch buffer. This is
how I build up my agenda of appointments. It highlights the power of
Emacs&rsquo; interconnectedness, as I go from my email to the agenda, to
editing, file management, and related.
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">;;; Glue code for notmuch and org-link (ol-notmuch.el)
(use-package ol-notmuch
  :ensure t
  :after notmuch)
</pre>
</div>
</div>
</div>
<div id="outline-container-h:0f12f144-ca9f-4d07-8563-c33b3521bfb5" class="outline-5">
<h5 id="h:0f12f144-ca9f-4d07-8563-c33b3521bfb5"><span class="section-number-5">5.11.6.10.</span> The <code>prot-emacs-notmuch.el</code> section about the <code>notmuch-indicator</code></h5>
<div class="outline-text-5" id="text-h:0f12f144-ca9f-4d07-8563-c33b3521bfb5">
<p>
This is a simple package of mine that renders an indicator with an
email count of the <code>notmuch</code> index on the Emacs mode line. The
underlying mechanism is that of <code>notmuch-count(1)</code>, which is used to
find the number of items that match the given search terms. In
practice, the user can define one or more searches and display their
counters. These form a listing which realistically is like: <code>@50
😱1000 💕0</code> for unread messages, bills, and love letters,
respectively.
</p>

<ul class="org-ul">
<li>Package name (GNU ELPA): <code>notmuch-indicator</code></li>
<li>Official manual: <a href="https://protesilaos.com/emacs/notmuch-indicator">https://protesilaos.com/emacs/notmuch-indicator</a></li>
<li>Change log: <a href="https://protesilaos.com/emacs/notmuch-indicator-changelog">https://protesilaos.com/emacs/notmuch-indicator-changelog</a></li>
<li>Git repositories:
<ul class="org-ul">
<li>GitHub: <a href="https://github.com/protesilaos/notmuch-indicator">https://github.com/protesilaos/notmuch-indicator</a></li>
<li>GitLab: <a href="https://gitlab.com/protesilaos/notmuch-indicator">https://gitlab.com/protesilaos/notmuch-indicator</a></li>
</ul></li>
<li>Backronym: notmuch-&#x2026; Interested in Notmuch Data Indicators that
Count Any Terms Ordinarily Requested.</li>
</ul>

<div class="org-src-container">
<pre class="src src-emacs-lisp">;;; notmuch-indicator (another package of mine)
(use-package notmuch-indicator
  :ensure t
  :after notmuch
  :config
  (setq notmuch-indicator-args
        '(( :terms "tag:unread and tag:inbox"
            ;; :label "[A] "
            :label "📥 "
            :label-face prot-modeline-indicator-green
            :counter-face prot-modeline-indicator-green)
          ( :terms "tag:unread and tag:inbox and not tag:package and not tag:coach"
            ;; :label "[U] "
            :label "💬 "
            :label-face prot-modeline-indicator-cyan
            :counter-face prot-modeline-indicator-cyan)
          ( :terms "tag:unread and tag:package and tag:inbox"
            ;; :label "[P] "
            :label "📦 "
            :label-face prot-modeline-indicator-magenta
            :counter-face prot-modeline-indicator-magenta)
          ( :terms "tag:unread and tag:coach and tag:inbox"
            ;; :label "[C] "
            :label "🏆 "
            :label-face prot-modeline-indicator-red
            :counter-face prot-modeline-indicator-red))

        notmuch-indicator-refresh-count (* 60 3)
        notmuch-indicator-hide-empty-counters t
        notmuch-indicator-force-refresh-commands '(notmuch-refresh-this-buffer))

  ;; I control its placement myself.  See prot-emacs-modeline.el where
  ;; I set the `mode-line-format'.
  (setq notmuch-indicator-add-to-mode-line-misc-info nil)

  (notmuch-indicator-mode 1))
</pre>
</div>
</div>
</div>
<div id="outline-container-h:340e745d-544c-4473-969e-ade21ae7710d" class="outline-5">
<h5 id="h:340e745d-544c-4473-969e-ade21ae7710d"><span class="section-number-5">5.11.6.11.</span> The <code>prot-emacs-notmuch.el</code> call to <code>provide</code></h5>
<div class="outline-text-5" id="text-h:340e745d-544c-4473-969e-ade21ae7710d">
<p>
Finally, we <code>provide</code> the submodule. This is the mirror function of
<code>require</code> (<a href="#h:200bc618-678a-4dc8-9d30-876d89e1edae">The <code>prot-emacs-email.el</code> loading of the email client and call to <code>provide</code></a>).
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(provide 'prot-emacs-notmuch)
</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-h:97282c11-475c-4ad3-9399-cb2cd12f93b7" class="outline-4">
<h4 id="h:97282c11-475c-4ad3-9399-cb2cd12f93b7"><span class="section-number-4">5.11.7.</span> The deprecated <code>prot-emacs-mail.el</code> submodule for <code>mu4e</code> (<code>prot-emacs-mu4e.el</code>)</h4>
<div class="outline-text-4" id="text-h:97282c11-475c-4ad3-9399-cb2cd12f93b7">
<p>
I did use Mu4e in the past as my email client. Its setup is similar to
the one I have now with Notmuch (<a href="#h:33151014-3621-4be6-9185-aacc34ee2d2c">Overview of my email setup (<code>mbsync</code>, <code>msmtp</code>, mail indexer, and MUA)</a>).
The <code>mu4e</code> package is the Emacs interface, or &ldquo;Mail User Agent&rdquo;, for
the user&rsquo;s email: this is where one reads messages and responds to
them, moves files to different folders, changes email tags, and so on.
All email is indexed by the the external <code>mu</code> executable: it is an
indexer of one&rsquo;s local copy of their email. The indexer maintains a
database that the user can query. This search facility can be accessed
both from the command line and insider Emacs via <code>mu4e</code>.
</p>

<p>
I prefer Notmuch over Mu4e due to stylistic choices and the overall
workflow. I keep this setup around for two reasons: (i) to be able to
test it for my themes and (ii) help others who are using it.
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">;; This is deprecated code as I stopped using mu4e a long time ago.  I
;; keep it here for when I need to test it for my themes (`ef-themes',
;; `modus-themes', `standard-themes').

(use-package mu4e
  :ensure nil
  ;; This is an exception because I install it from the system
  ;; distribution's package archives (depends on non-Emacs code)
  :load-path "/usr/share/emacs/site-lisp/elpa/mu4e-1.8.14"
  :config
  (setq mu4e-maildir "~/.20240226-mail-mu4e")
  (setq mu4e-attachment-dir (expand-file-name "~/Downloads/mail-attachments/"))
  (setq mu4e-confirm-quit nil)
  (setq mu4e-mu-allow-temp-file t) ; mu 1.12.0

  (setq mu4e-use-fancy-chars t ; Cool idea, but they create misalignments
        mu4e-headers-draft-mark     '("D" . "⚒️")
        mu4e-headers-flagged-mark   '("F" . "🚩")
        mu4e-headers-new-mark       '("N" . "🔥")
        mu4e-headers-passed-mark    '("P" . "📨")
        mu4e-headers-replied-mark   '("R" . "✏️")
        mu4e-headers-seen-mark      '("S" . "👁️‍🗨️")
        mu4e-headers-trashed-mark   '("T" . "🚫")
        mu4e-headers-attach-mark    '("a" . "📎")
        mu4e-headers-encrypted-mark '("x" . "🔒")
        mu4e-headers-signed-mark    '("s" . "🔑")
        mu4e-headers-unread-mark    '("u" . "💬")
        mu4e-headers-list-mark      '("l" . "📬")
        mu4e-headers-personal-mark  '("p" . "🦚")
        mu4e-headers-calendar-mark  '("c" . "📅"))

  (setq mu4e-marks
        '((refile
           :char ("r" . "▶")
           :prompt "refile"
           :dyn-target (lambda (target msg) (mu4e-get-refile-folder msg))
           :action (lambda (docid msg target)
                     (mu4e--server-move docid (mu4e--mark-check-target target) "-N")))
          (delete
           :char ("D" . "🚫")
           :prompt "Delete"
           :show-target (lambda (target) "delete")
           :action (lambda (docid msg target) (mu4e--server-remove docid)))
          (flag
           :char ("+" . "🚩")
           :prompt "+flag"
           :show-target (lambda (target) "flag")
           :action (lambda (docid msg target)
                     (mu4e--server-move docid nil "+F-u-N")))
          (move
           :char ("m" . "▷")
           :prompt "move"
           :ask-target  mu4e--mark-get-move-target
           :action (lambda (docid msg target)
                     (mu4e--server-move docid (mu4e--mark-check-target target) "-N")))
          (read
           :char    ("!" . "👁️‍🗨️")
           :prompt "!read"
           :show-target (lambda (target) "read")
           :action (lambda (docid msg target) (mu4e--server-move docid nil "+S-u-N")))
          (trash
           :char ("d" . "🚫")
           :prompt "dtrash"
           :dyn-target (lambda (target msg) (mu4e-get-trash-folder msg))
           :action (lambda (docid msg target)
                     (mu4e--server-move docid
                                        (mu4e--mark-check-target target) "+T-N")))
          (unflag
           :char    ("-" . "➖")
           :prompt "-unflag"
           :show-target (lambda (target) "unflag")
           :action (lambda (docid msg target) (mu4e--server-move docid nil "-F-N")))
          (untrash
           :char   ("=" . "▲")
           :prompt "=untrash"
           :show-target (lambda (target) "untrash")
           :action (lambda (docid msg target) (mu4e--server-move docid nil "-T")))
          (unread
           :char    ("?" . "💬")
           :prompt "?unread"
           :show-target (lambda (target) "unread")
           :action (lambda (docid msg target) (mu4e--server-move docid nil "-S+u-N")))
          (unmark
           :char  " "
           :prompt "unmark"
           :action (mu4e-error "No action for unmarking"))
          (action
           :char ( "a" . "◯")
           :prompt "action"
           :ask-target  (lambda () (mu4e-read-option "Action: " mu4e-headers-actions))
           :action  (lambda (docid msg actionfunc)
                      (save-excursion
                        (when (mu4e~headers-goto-docid docid)
                          (mu4e-headers-action actionfunc)))))
          (something
           :char  ("*" . "✱")
           :prompt "*something"
           :action (mu4e-error "No action for deferred mark"))))

  (setq mu4e-modeline-support t
        mu4e-modeline-unread-items '("U:" . "[U]")
        mu4e-modeline-all-read '("R:" . "[R]")
        mu4e-modeline-all-clear '("C:" . "[C]")
        mu4e-modeline-max-width 42)

  (setq mu4e-notification-support t
        ;; TODO 2024-02-26: Write custom mu4e notification function.
        mu4e-notification-filter #'mu4e--default-notification-filter)

  (setq mu4e-headers-advance-after-mark nil)
  (setq mu4e-headers-auto-update t)
  (setq mu4e-headers-date-format "%F %a, %T")
  (setq mu4e-headers-time-format "%R")
  (setq mu4e-headers-long-date-format "%F, %R")
  (setq mu4e-headers-leave-behavior 'apply)

  (setq mu4e-headers-fields
        '((:date . 26)
          (:flags . 8)
          (:from . 20)
          (:subject)))

  (setq mu4e-get-mail-command "true" ; I auto-fetch with a systemd timer
        mu4e-update-interval nil)
  (setq mu4e-hide-index-messages t)

  (setq mu4e-read-option-use-builtin nil
        mu4e-completing-read-function 'completing-read)

  (setq mu4e-search-results-limit -1
        mu4e-search-sort-field :date
        mu4e-search-sort-direction 'descending)

  (setq mu4e-org-support t)

  (setq mu4e-sent-messages-behavior 'sent)
  (setq mu4e-view-show-addresses t)
  (setq mu4e-split-view 'horizontal)

  (setq mu4e-index-lazy-check t)
  (setq mu4e-change-filenames-when-moving t) ; better for `mbsync'?
  (setq mu4e-display-update-status-in-modeline nil)
  (setq mu4e-view-show-images nil)
  (setq mu4e-headers-include-related nil)
  (setq mu4e-view-auto-mark-as-read t)

  (setq mu4e-compose-complete-addresses nil
        mu4e-compose-complete-only-personal t)

  (setq mu4e-compose-signature "Protesilaos Stavrou\nprotesilaos.com\n")
  (setq mu4e-compose-signature-auto-include t)

  (setq mu4e-context-policy 'pick-first
        mu4e-compose-context-policy nil)

  (setq mu4e-contexts
        `(,@(mapcar
             (lambda (context)
               (let ((address (prot-common-auth-get-field context :user)))
                 (make-mu4e-context
                  :name context
                  :match-func `(lambda (msg)
                                 (when msg
                                   (mu4e-message-contact-field-matches msg :to ,address)))
                  :vars `((user-mail-address . ,address)
                          (mu4e-trash-folder . ,(format "/%s/Trash" context))
                          (mu4e-sent-folder . ,(format "/%s/Sent" context))))))
             '("pub" "inf" "prv"))))

  ;; 2024-02-26 10:34 +0200 WORK-IN-PROGRESS
  (setq mu4e-bookmarks
        `((:name "All unread messages" :query "g:unread AND NOT g:trashed" :key ?a)
          (:name "All messages" :query "*" :key ?A)
          ( :name "Personal unread"
            :query "contact:/@protesilaos/ or contact:protesilaos AND g:unread AND NOT contact:/@.*gnu/"
            :key ?u
            :favorite t)
          ( :name "Personal inbox"
            :query "contact:/@protesilaos/ or contact:protesilaos AND NOT contact:/@.*gnu/"
            :key ?U
            :favorite t)
          ( :name "Mailing list unread"
            :query "contact:/@.*gnu/ AND g:unread"
            :key ?m)
          ( :name "Mailing list inbox"
            :query "contact:/@.*gnu/"
            :key ?M)))

  (defun prot/mu4e (&amp;rest args)
    (cl-letf (((symbol-function 'display-buffer-full-frame) #'display-buffer-same-window))
      (apply args)))

  (advice-add #'mu4e-display-buffer :around #'prot/mu4e)

  (defun prot/mu4e-no-header-line ()
    (setq-local header-line-format nil))

  (add-hook 'mu4e-headers-mode-hook #'prot/mu4e-no-header-line)

  (prot-emacs-keybind global-map
    "C-c m" #'mu4e
    "C-x m" #'mu4e-compose-new) ; override `compose-mail'

  (prot-emacs-keybind mu4e-headers-mode-map
    "!" #'mu4e-headers-mark-for-flag
    "?" #'mu4e-headers-mark-for-unflag
    "r" #'mu4e-headers-mark-for-read
    "d" #'mu4e-headers-mark-for-delete ; I do not use the trash
    "u" #'mu4e-headers-mark-for-unread
    "m" #'mu4e-headers-mark-for-unmark
    "M" #'mu4e-mark-unmark-all)

  (prot-emacs-keybind mu4e-headers-mode-map
    "!" #'mu4e-headers-mark-for-flag
    "?" #'mu4e-headers-mark-for-unflag
    "r" #'mu4e-headers-mark-for-read
    "u" #'mu4e-headers-mark-for-unread
    "m" #'mu4e-headers-mark-for-unmark
    "M" #'mu4e-mark-unmark-all)

  (prot-emacs-keybind mu4e-view-mode-map
    ;; NOTE 2024-02-26: with mu 1.12.0 there is a "wide" reply that I
    ;; would bind to r and the regular reply to R.
    "r" #'mu4e-compose-reply
    "w" #'mu4e-copy-thing-at-point
    "s" #'mu4e-view-save-attachments
    "S" #'mu4e-view-raw-message ; "source" mnemonic
    "u" #'mu4e-view-mark-for-unread
    "U" #'mu4e-view-mark-for-read
    "d" #'mu4e-view-mark-for-delete ; overwrite mu4e-view-mark-for-trash
    "!" #'mu4e-view-mark-for-flag
    "?" #'mu4e-view-mark-for-unflag))

(provide 'prot-emacs-mu4e)
</pre>
</div>
</div>
</div>
<div id="outline-container-h:ae0a1c85-8412-48d3-94a9-7d6dbd801126" class="outline-4">
<h4 id="h:ae0a1c85-8412-48d3-94a9-7d6dbd801126"><span class="section-number-4">5.11.8.</span> The deprecated <code>prot-emacs-mail.el</code> submodule for Gnus (<code>prot-emacs-gnus.el</code>)</h4>
<div class="outline-text-4" id="text-h:ae0a1c85-8412-48d3-94a9-7d6dbd801126">
<p>
I have long now stopped using Gnus (<a href="#h:33151014-3621-4be6-9185-aacc34ee2d2c">Overview of my email setup (<code>mbsync</code>, <code>msmtp</code>, mail indexer, and MUA)</a>).
I keep this here in case I need to test the setup.
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">;; This is deprecated code as I stopped using Gnus a long time ago.  I
;; keep it here for when I need to test it for my themes (`ef-themes',
;; `modus-themes', `standard-themes').


(use-package gnus
  :ensure nil
  :config
  (require 'gnus-sum)
  (require 'gnus-dired)
  (require 'gnus-topic)

;;; accounts
  (setq gnus-select-method '(nnnil ""))
  (setq gnus-secondary-select-methods
        '((nntp "news.gwene.org")
          ;; ;;  NOTE 2021-05-13: Switched to notmuch.
          ;; (nnmaildir "prv" (directory "~/.mail/prv")
          ;;  (gnus-search-engine gnus-search-notmuch ; this feature is from Emacs 28
 		  ;;   		           (remove-prefix "~/.mail/prv")))
          ;; (nnmaildir "inf" (directory "~/.mail/inf")
          ;;  (gnus-search-engine gnus-search-notmuch
 		  ;;   		           (remove-prefix "~/.mail/inf")))
          ;; (nnmaildir "pub" (directory "~/.mail/pub")
          ;;  (gnus-search-engine gnus-search-notmuch
 		  ;;   		           (remove-prefix "~/.mail/pub")))
          ))

  (setq gnus-search-use-parsed-queries nil) ; Emacs 28

  ;; ;;  NOTE 2021-05-13: Switched to notmuch.
  ;; (setq gnus-parameters
  ;;       '((".*"                         ; fallback option
  ;;          (posting-style
  ;;           (gcc "nnmaildir+inf:Sent")
  ;;           (From
  ;;            (format "%s &lt;%s&gt;" user-full-name
  ;;                    (prot-mail-auth-get-field "inf" :user)))))
  ;;         ("prv"
  ;;          (posting-style
  ;;           (gcc "nnmaildir+prv:Sent")
  ;;           (From
  ;;            (format "%s &lt;%s&gt;" user-full-name
  ;;                    (prot-mail-auth-get-field "prv" :user)))))
  ;;         ("pub"
  ;;          (posting-style               ; Uses default name+mail
  ;;           (gcc "nnmaildir+pub:Sent")))))

  (setq gnus-gcc-mark-as-read t)
  (setq gnus-agent t)
  (setq gnus-novice-user nil)           ; careful with this
  ;; checking sources
  (setq gnus-check-new-newsgroups 'ask-server)
  (setq gnus-read-active-file 'some)
  ;; dribble
  (setq gnus-use-dribble-file t)
  (setq gnus-always-read-dribble-file t)
;;; agent
  (setq gnus-agent-article-alist-save-format 1)  ; uncompressed
  (setq gnus-agent-cache t)
  (setq gnus-agent-confirmation-function 'y-or-n-p)
  (setq gnus-agent-consider-all-articles nil)
  (setq gnus-agent-directory "~/News/agent/")
  (setq gnus-agent-enable-expiration 'ENABLE)
  (setq gnus-agent-expire-all nil)
  (setq gnus-agent-expire-days 30)
  (setq gnus-agent-mark-unread-after-downloaded t)
  (setq gnus-agent-queue-mail t)        ; queue if unplugged
  (setq gnus-agent-synchronize-flags nil)
;;; article
  (setq gnus-article-browse-delete-temp 'ask)
  (setq gnus-article-over-scroll nil)
  (setq gnus-article-show-cursor t)
  (setq gnus-article-sort-functions
        '((not gnus-article-sort-by-number)
          (not gnus-article-sort-by-date)))
  (setq gnus-article-truncate-lines nil)
  (setq gnus-html-frame-width 80)
  (setq gnus-html-image-automatic-caching t)
  (setq gnus-inhibit-images t)
  (setq gnus-max-image-proportion 0.7)
  (setq gnus-treat-display-smileys nil)
  (setq gnus-article-mode-line-format "%G %S %m")
  (setq gnus-visible-headers
        '("^From:" "^To:" "^Cc:" "^Subject:" "^Newsgroups:" "^Date:"
          "Followup-To:" "Reply-To:" "^Organization:" "^X-Newsreader:"
          "^X-Mailer:"))
  (setq gnus-sorted-header-list gnus-visible-headers)
  (setq gnus-article-x-face-too-ugly ".*") ; all images in headers are outright annoying---disabled!
;;; async
  (setq gnus-asynchronous t)
  (setq gnus-use-article-prefetch 15)
;;; group
  (setq gnus-level-subscribed 6)
  (setq gnus-level-unsubscribed 7)
  (setq gnus-level-zombie 8)
  (setq gnus-activate-level 1)
  (setq gnus-list-groups-with-ticked-articles nil)
  (setq gnus-group-sort-function
        '((gnus-group-sort-by-unread)
          (gnus-group-sort-by-alphabet)
          (gnus-group-sort-by-rank)))
  (setq gnus-group-line-format "%M%p%P%5y:%B%(%g%)\n")
  (setq gnus-group-mode-line-format "%%b")
  (setq gnus-topic-display-empty-topics nil)
;;; summary
  (setq gnus-auto-select-first nil)
  (setq gnus-summary-ignore-duplicates t)
  (setq gnus-suppress-duplicates t)
  (setq gnus-save-duplicate-list t)
  (setq gnus-summary-goto-unread nil)
  (setq gnus-summary-make-false-root 'adopt)
  (setq gnus-summary-thread-gathering-function
        'gnus-gather-threads-by-subject)
  (setq gnus-summary-gather-subject-limit 'fuzzy)
  (setq gnus-thread-sort-functions
        '((not gnus-thread-sort-by-date)
          (not gnus-thread-sort-by-number)))
  (setq gnus-subthread-sort-functions
        'gnus-thread-sort-by-date)
  (setq gnus-thread-hide-subtree nil)
  (setq gnus-thread-ignore-subject nil)
  (setq gnus-user-date-format-alist
        '(((gnus-seconds-today) . "Today at %R")
          ((+ (* 60 60 24) (gnus-seconds-today)) . "Yesterday, %R")
          (t . "%Y-%m-%d %R")))

  ;; When the %f specifier in `gnus-summary-line-format' matches my
  ;; name, this will use the contents of the "To:" field, prefixed by
  ;; the string I specify.  Useful when checking your "Sent" summary or
  ;; a mailing list you participate in.
  (setq gnus-ignored-from-addresses "Protesilaos Stavrou")
  (setq gnus-summary-to-prefix "To: ")

  (setq gnus-summary-line-format "%U%R %-18,18&amp;user-date; %4L:%-25,25f %B%s\n")
  (setq gnus-summary-mode-line-format "[%U] %p")
  (setq gnus-sum-thread-tree-false-root "")
  (setq gnus-sum-thread-tree-indent " ")
  (setq gnus-sum-thread-tree-single-indent "")
  (setq gnus-sum-thread-tree-leaf-with-other "+-&gt; ")
  (setq gnus-sum-thread-tree-root "")
  (setq gnus-sum-thread-tree-single-leaf "\\-&gt; ")
  (setq gnus-sum-thread-tree-vertical "|")

  (add-hook 'dired-mode-hook #'gnus-dired-mode) ; dired integration
  (add-hook 'gnus-group-mode-hook #'gnus-topic-mode)
  (add-hook 'gnus-select-group-hook #'gnus-group-set-timestamp)

  (dolist (mode '(gnus-group-mode-hook gnus-summary-mode-hook gnus-browse-mode-hook))
    (add-hook mode #'hl-line-mode))

  ;; ;;  NOTE 2021-05-13: Switched to notmuch.
  ;; (define-key global-map (kbd "C-c m") #'gnus)
  (let ((map gnus-article-mode-map))
    (define-key map (kbd "i") #'gnus-article-show-images)
    (define-key map (kbd "s") #'gnus-mime-save-part)
    (define-key map (kbd "o") #'gnus-mime-copy-part))
  (let ((map gnus-group-mode-map))       ; I always use `gnus-topic-mode'
    (define-key map (kbd "n") #'gnus-group-next-group)
    (define-key map (kbd "p") #'gnus-group-prev-group)
    (define-key map (kbd "M-n") #'gnus-topic-goto-next-topic)
    (define-key map (kbd "M-p") #'gnus-topic-goto-previous-topic))
  (let ((map gnus-summary-mode-map))
    (define-key map (kbd "&lt;delete&gt;") #'gnus-summary-delete-article)
    (define-key map (kbd "n") #'gnus-summary-next-article)
    (define-key map (kbd "p") #'gnus-summary-prev-article)
    (define-key map (kbd "N") #'gnus-summary-next-unread-article)
    (define-key map (kbd "P") #'gnus-summary-prev-unread-article)
    (define-key map (kbd "M-n") #'gnus-summary-next-thread)
    (define-key map (kbd "M-p") #'gnus-summary-prev-thread)
    (define-key map (kbd "C-M-n") #'gnus-summary-next-group)
    (define-key map (kbd "C-M-p") #'gnus-summary-prev-group)
    (define-key map (kbd "C-M-^") #'gnus-summary-refer-thread)))

(use-package nnmail
  :ensure nil
  :config
  (setq nnmail-expiry-wait 30))         ; careful with this

(provide 'prot-emacs-gnus)
</pre>
</div>
</div>
</div>
<div id="outline-container-h:33151014-3621-4be6-9185-aacc34ee2d2c" class="outline-4">
<h4 id="h:33151014-3621-4be6-9185-aacc34ee2d2c"><span class="section-number-4">5.11.9.</span> Overview of my email setup (<code>mbsync</code>, <code>msmtp</code>, mail indexer, and MUA)</h4>
<div class="outline-text-4" id="text-h:33151014-3621-4be6-9185-aacc34ee2d2c">
<p>
I have a regular IMAP email setup. This is the protocol that allows
the server to retain messages, which is of practical benefit for
accessing mail on multiple machines.
</p>

<p>
A copy of my server&rsquo;s contents needs to be stored locally. This is
valuable for backup purposes. It also provides the option to move to
another email service provider by just syncing the local data to the
new location while deleting the old one. More importantly though,
local files can be indexed, granting us access to a powerful search
mechanism (more below).
</p>

<p>
The program that stores email locally is called <code>mbsync</code>. For whatever
reason, the system package is <code>isync</code>. This is true for Arch Linux and
Debian. (I also heard it is the case with <code>homebrew</code>, but please check.)
</p>

<p>
With <code>mbsync</code> we synchronise the state from the server (known as the
&ldquo;far&rdquo; side) to our computer (the &ldquo;near&rdquo; side). The directionality can
be one-way, far to near or near to far. Or it can be two-way, as is
the case on my end. Concretely, what I have on my computer is mirrored
on the server.
</p>

<p>
The format <code>mbsync</code> uses is called <code>maildir</code>. This is in contrast to
the Unix <code>mbox</code>. I do not know about the pros and cons of each format,
other than the fact that <code>maildir</code> has been working flawlessly for me
for years&#x2014;and email is my primary medium of communication online
(<a href="#h:bf540a85-12a6-4005-bf00-2ff3370e5adb">Contents of my <code>.mbsyncrc</code></a>).
</p>

<p>
The local files are indexed with a &ldquo;mail indexer&rdquo; system program.
There are a few of those. The ones I have used are <code>mu</code> and <code>notmuch</code>.
Both are built on top of the <code>xapian</code> search engine software and both
offer the same features. The noticeable differences exist at the level
of the email client, else the Mail User Agent (MUA), which I cover
further below.
</p>

<p>
Mail indexers create a database out of a local email directory for the
purposes of retrieving data from it. In practical terms, we can run a
search like <code>notmuch search from:protesilaos</code> (with <code>notmuch</code>) or <code>mu
find from:protesilaos</code> (with <code>mu</code>) to produce a list of all messages
whose <code>From</code> mail header matches the given name. The search terms are
quite sophisticated, accepting tags, date ranges, and even queries for
message contents.
</p>

<p>
Indexation is an archiving process. We do not need a Mail User Agent
(MUA) to handle all the interactivity involved. There are cases where
we can have some old messages in such a read-only state. Though we
most probably need to deal with email in present time, hence the need
for a MUA.
</p>

<p>
The MUA is responsible for all the interactive aspects of dealing with
email: show a list of messages, display an individual email, handle
message composition, and others such as tagging, searching,
downloading&#x2026; In short, the mail user agent is what we normally
understand as the &ldquo;email app&rdquo;.
</p>

<p>
The <code>mu</code> and <code>notmuch</code> indexers both come with their own Emacs MUA as
part of their system package. For the former, the Emacs package is known
as <code>mu4e</code> (<a href="#h:97282c11-475c-4ad3-9399-cb2cd12f93b7">The deprecated <code>prot-emacs-mail.el</code> submodule for <code>mu4e</code> (<code>prot-emacs-mu4e.el</code>)</a>), while the
latter&rsquo;s is <code>notmuch</code> or <code>notmuch.el</code> to differentiate it from the
system program (<a href="#h:b26c6297-ebe8-4f99-b069-df53cfd90520">The <code>prot-emacs-email.el</code> submodule for <code>notmuch</code> (<code>prot-emacs-notmuch.el</code>)</a>).
</p>

<p>
I have used both MUAs extensively and settled with <code>notmuch.el</code> simply
because it has a threaded view: <code>mu4e</code> uses a tree view, which is fine
if you are not dealing with lots of emails, but is harder to spot what
you need when conversations start getting longer and you have plenty
of them. I never use the tree view provided by <code>notmuch.el</code>, unless I
am testing something.
</p>

<p>
Behind the scenes, the MUA needs some other program to actually send
messages. For this purpose, I set up the <code>msmtp</code> system package, which
defines a handler for the standard <code>sendmail</code> system utility. Not to
bother you with the technicalities: <code>msmtp</code> is basically the same as
<code>mbsync</code> but for sending instead of fetching.
</p>

<p>
This all sounds complex to anyone who expects email to be encapsulated
in a single application. What we have here is the Unix paradigm in
action. Need another program for mail indexing? Good, just swap out
<code>mbsync</code> for <code>offlineimap</code> and continue using the rest of the tool
kit. This is the sort of idea.
</p>

<p>
Overall, I am happy with my setup. Email is integral to my online
communications: I need it to be reliable and efficient. Having the MUA
in Emacs is extra nice because it integrates an essential part of my
daily computing with the rest of what I do (<a href="#h:755e195b-9471-48c7-963b-33055969b4e2">The <code>prot-emacs-email.el</code> module</a>).
</p>
</div>
<div id="outline-container-h:bf540a85-12a6-4005-bf00-2ff3370e5adb" class="outline-5">
<h5 id="h:bf540a85-12a6-4005-bf00-2ff3370e5adb"><span class="section-number-5">5.11.9.1.</span> Contents of my <code>.mbsyncrc</code></h5>
<div class="outline-text-5" id="text-h:bf540a85-12a6-4005-bf00-2ff3370e5adb">
<p>
This file is stored in the home directory at <code>~/.mbsyncrc</code> (it can be
placed elsewhere, but I do not mind it there). Notice that the user
name and password are not written in the file directly but are instead
retrieved by a system call that reads the encrypted <code>~/.authinfo.gpg</code>
file (<a href="#h:24f17614-ee3d-4cd1-bbe3-f53e4f39c281">The <code>prot-emacs-email.el</code> basic settings (including <code>authinfo</code>)</a>).
</p>

<p>
What you see there is three separate email accounts.
</p>

<pre class="example" id="orgca2a398">
# Gandi
####################################################################################################
IMAPAccount gandi
Host mail.gandi.net
UserCmd "gpg -q --for-your-eyes-only -d ~/.authinfo.gpg | awk -F ' ' '/gandi/ { print $(NF-2); exit; }'"
PassCmd "gpg -q --for-your-eyes-only -d ~/.authinfo.gpg | awk -F ' ' '/gandi/ { print $NF; exit; }'"
SSLType IMAPS

IMAPStore gandi-remote
Account gandi

MaildirStore gandi-local
Subfolders Verbatim
# The trailing "/" is important
Path ~/.mail/gandi/
Inbox ~/.mail/gandi/Inbox

Channel gandi
Far :gandi-remote:
Near :gandi-local:
# Include everything
Patterns *
Sync All
Create Both
Remove Both
Expunge Both
SyncState *

# # Gmail
# ####################################################################################################
# IMAPAccount gmail
# Host imap.gmail.com
# UserCmd "gpg -q --for-your-eyes-only -d ~/.authinfo.gpg | awk -F ' ' '/gmail/ { print $(NF-2); exit; }'"
# PassCmd "gpg -q --for-your-eyes-only -d ~/.authinfo.gpg | awk -F ' ' '/gmail/ { print $NF; exit; }'"
# SSLType IMAPS
#
# IMAPStore gmail-remote
# Account gmail
#
# MaildirStore gmail-local
# Subfolders Verbatim
# # The trailing "/" is important
# Path ~/.mail/gmail/
# Inbox ~/.mail/gmail/Inbox
#
# Channel gmail
# Far :gmail-remote:
# Near :gmail-local:
# # Include everything
# Patterns *
# Sync All
# Create Near
# Remove Near
# Expunge Near
# SyncState *

# # Mailbox
# ####################################################################################################
# IMAPAccount mailbox
# Host imap.mailbox.org
# UserCmd "gpg -q --for-your-eyes-only -d ~/.authinfo.gpg | awk -F ' ' '/mailbox/ { print $(NF-2); exit; }'"
# PassCmd "gpg -q --for-your-eyes-only -d ~/.authinfo.gpg | awk -F ' ' '/mailbox/ { print $NF; exit; }'"
# SSLType IMAPS
#
# IMAPStore mailbox-remote
# Account mailbox
#
# MaildirStore mailbox-local
# Subfolders Verbatim
# # The trailing "/" is important
# Path ~/.mail/mailbox/
# Inbox ~/.mail/mailbox/Inbox
#
# Channel mailbox
# Far :mailbox-remote:
# Near :mailbox-local:
# # Include everything
# Patterns *
# Sync All
# Create Near
# Remove Near
# Expunge Near
# SyncState *
</pre>
</div>
</div>
<div id="outline-container-h:c7b8940b-7452-429e-ba2d-dd39da5e9cd9" class="outline-5">
<h5 id="h:c7b8940b-7452-429e-ba2d-dd39da5e9cd9"><span class="section-number-5">5.11.9.2.</span> Contents of my <code>msmtp</code> configuration file</h5>
<div class="outline-text-5" id="text-h:c7b8940b-7452-429e-ba2d-dd39da5e9cd9">
<p>
This file is stored at <code>~/.config/msmtp/config</code> (well, unless you
change the XDG directory but then you know what you are doing). Just
as with <code>mbsync</code>, I retrieve the user name and password via commands
that read from the <code>~/.authinfo</code> file (<a href="#h:bf540a85-12a6-4005-bf00-2ff3370e5adb">Contents of my <code>.mbsyncrc</code></a>).
</p>

<pre class="example" id="org0285f01">
# See my mbsync config, which is reflected here.
# https://github.com/protesilaos/dotfiles

defaults
auth on
protocol smtp
tls on
tls_starttls on

# Gandi
####################################################################################################
account gandi
host mail.gandi.net
port 587
eval echo from $(gpg -q --for-your-eyes-only -d ~/.authinfo.gpg | awk -F ' ' '/gandi/ { print $(NF-2); exit; }')
eval echo user $(gpg -q --for-your-eyes-only -d ~/.authinfo.gpg | awk -F ' ' '/gandi/ { print $(NF-2); exit; }')
passwordeval "gpg -q --for-your-eyes-only -d ~/.authinfo.gpg | awk -F ' ' '/gandi/ { print $NF; exit; }'"

# # Gmail
# ####################################################################################################
# account gmail
# host smtp.gmail.com
# port 587
# eval echo from $(gpg -q --for-your-eyes-only -d ~/.authinfo.gpg | awk -F ' ' '/gmail/ { print $(NF-2); exit; }')
# eval echo user $(gpg -q --for-your-eyes-only -d ~/.authinfo.gpg | awk -F ' ' '/gmail/ { print $(NF-2); exit; }')
# passwordeval "gpg -q --for-your-eyes-only -d ~/.authinfo.gpg | awk -F ' ' '/gmail/ { print $NF; exit; }'"

# # Mailbox
# ####################################################################################################
# account mailbox
# host smtp.mailbox.org
# port 465
# eval echo from $(gpg -q --for-your-eyes-only -d ~/.authinfo.gpg | awk -F ' ' '/mailbox/ { print $(NF-2); exit; }')
# eval echo user $(gpg -q --for-your-eyes-only -d ~/.authinfo.gpg | awk -F ' ' '/mailbox/ { print $(NF-2); exit; }')
# passwordeval "gpg -q --for-your-eyes-only -d ~/.authinfo.gpg | awk -F ' ' '/mailbox/ { print $NF; exit; }'"


# Set a default account (I copied from man msmtp)
account default : gandi
</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-h:f23d9cef-ab7b-4486-a070-9c7ae664eadf" class="outline-3">
<h3 id="h:f23d9cef-ab7b-4486-a070-9c7ae664eadf"><span class="section-number-3">5.12.</span> <span class="todo TODO">TODO</span> The <code>prot-emacs-web.el</code> module</h3>
<div class="outline-text-3" id="text-h:f23d9cef-ab7b-4486-a070-9c7ae664eadf">
</div>
<div id="outline-container-h:edb70963-d590-4959-bc59-1e5435c8e78a" class="outline-4">
<h4 id="h:edb70963-d590-4959-bc59-1e5435c8e78a"><span class="section-number-4">5.12.1.</span> <span class="todo TODO">TODO</span> The <code>prot-emacs-web.el</code> settings about following links (<code>browse-url</code>)</h4>
<div class="outline-text-4" id="text-h:edb70963-d590-4959-bc59-1e5435c8e78a">
<div class="org-src-container">
<pre class="src src-emacs-lisp">;;;; `browse-url'
(use-package browse-url
  :ensure nil
  :defer 1
  :config
  (setq browse-url-browser-function 'eww-browse-url)
  (setq browse-url-secondary-browser-function 'browse-url-default-browser))
</pre>
</div>
</div>
</div>
<div id="outline-container-h:7639683b-4b6f-42ee-9ae0-76eeec6fee9a" class="outline-4">
<h4 id="h:7639683b-4b6f-42ee-9ae0-76eeec6fee9a"><span class="section-number-4">5.12.2.</span> <span class="todo TODO">TODO</span> The <code>prot-emacs-web.el</code> settings about buttonising links (<code>goto-addr</code>)</h4>
<div class="outline-text-4" id="text-h:7639683b-4b6f-42ee-9ae0-76eeec6fee9a">
<div class="org-src-container">
<pre class="src src-emacs-lisp">;;;; `goto-addr'
(use-package goto-addr
  :ensure nil
  :defer t
  :config
  (setq goto-address-url-face 'link)
  (setq goto-address-url-mouse-face 'highlight)
  (setq goto-address-mail-face nil)
  (setq goto-address-mail-mouse-face 'highlight))
</pre>
</div>
</div>
</div>
<div id="outline-container-h:60483672-aeb6-427b-bbef-54a5c31e39ab" class="outline-4">
<h4 id="h:60483672-aeb6-427b-bbef-54a5c31e39ab"><span class="section-number-4">5.12.3.</span> <span class="todo TODO">TODO</span> The <code>prot-emacs-web.el</code> settings about the Simple HTML Renderer (<code>shr</code>)</h4>
<div class="outline-text-4" id="text-h:60483672-aeb6-427b-bbef-54a5c31e39ab">
<div class="org-src-container">
<pre class="src src-emacs-lisp">;;;; `shr' (Simple HTML Renderer)
(use-package shr
  :ensure nil
  :defer t
  :config
  (setq shr-use-colors nil)             ; t is bad for accessibility
  (setq shr-use-fonts nil)              ; t is not for me
  (setq shr-max-image-proportion 0.6)
  (setq shr-image-animate nil)          ; No GIFs, thank you!
  (setq shr-width fill-column)          ; check `prot-eww-readable'
  (setq shr-max-width fill-column)
  (setq shr-discard-aria-hidden t)
  (setq shr-fill-text nil)              ; Emacs 31
  (setq shr-cookie-policy nil))
</pre>
</div>
</div>
</div>
<div id="outline-container-h:399f1ec8-30e6-40c3-931b-e7c7409716c8" class="outline-4">
<h4 id="h:399f1ec8-30e6-40c3-931b-e7c7409716c8"><span class="section-number-4">5.12.4.</span> <span class="todo TODO">TODO</span> The <code>prot-emacs-web.el</code> settings about browser cookies</h4>
<div class="outline-text-4" id="text-h:399f1ec8-30e6-40c3-931b-e7c7409716c8">
<div class="org-src-container">
<pre class="src src-emacs-lisp">;;;; `url-cookie'
(use-package url-cookie
  :ensure nil
  :defer t
  :config
  (setq url-cookie-untrusted-urls '(".*")))
</pre>
</div>
</div>
</div>
<div id="outline-container-h:b09b4fce-31fe-4381-a49a-6a7206ac5f1b" class="outline-4">
<h4 id="h:b09b4fce-31fe-4381-a49a-6a7206ac5f1b"><span class="section-number-4">5.12.5.</span> <span class="todo TODO">TODO</span> The <code>prot-emacs-web.el</code> settings about the web browser (<code>eww</code>)</h4>
<div class="outline-text-4" id="text-h:b09b4fce-31fe-4381-a49a-6a7206ac5f1b">
<div class="org-src-container">
<pre class="src src-emacs-lisp">;;;; `eww' (Emacs Web Wowser)
(use-package eww
  :ensure nil
  :commands (eww)
  :bind
  ( :map eww-link-keymap
    ("v" . nil) ; stop overriding `eww-view-source'
    :map eww-mode-map
    ("L" . eww-list-bookmarks)
    :map dired-mode-map
    ("E" . eww-open-file) ; to render local HTML files
    :map eww-buffers-mode-map
    ("d" . eww-bookmark-kill)   ; it actually deletes
    :map eww-bookmark-mode-map
    ("d" . eww-bookmark-kill)) ; same
  :config
  (setq eww-restore-desktop t)
  (setq eww-desktop-remove-duplicates t)
  (setq eww-header-line-format nil)
  (setq eww-search-prefix "https://duckduckgo.com/html/?q=")
  (setq eww-download-directory (expand-file-name "~/Documents/eww-downloads"))
  (setq eww-suggest-uris
        '(eww-links-at-point
          thing-at-point-url-at-point))
  (setq eww-bookmarks-directory (locate-user-emacs-file "eww-bookmarks/"))
  (setq eww-history-limit 150)
  (setq eww-use-external-browser-for-content-type
        "\\`\\(video/\\|audio\\)") ; On GNU/Linux check your mimeapps.list
  (setq eww-browse-url-new-window-is-tab nil)
  (setq eww-form-checkbox-selected-symbol "[X]")
  (setq eww-form-checkbox-symbol "[ ]")
  ;; NOTE `eww-retrieve-command' is for Emacs28.  I tried the following
  ;; two values.  The first would not render properly some plain text
  ;; pages, such as by messing up the spacing between paragraphs.  The
  ;; second is more reliable but feels slower.  So I just use the
  ;; default (nil), though I find wget to be a bit faster.  In that case
  ;; one could live with the occasional errors by using `eww-download'
  ;; on the offending page, but I prefer consistency.
  ;;
  ;; '("wget" "--quiet" "--output-document=-")
  ;; '("chromium" "--headless" "--dump-dom")
  (setq eww-retrieve-command nil))
</pre>
</div>
</div>
</div>
<div id="outline-container-h:1fcd7008-b7ed-4441-8a7b-82db43a05775" class="outline-4">
<h4 id="h:1fcd7008-b7ed-4441-8a7b-82db43a05775"><span class="section-number-4">5.12.6.</span> <span class="todo TODO">TODO</span> The <code>prot-emacs-web.el</code> extras for <code>eww</code> (<code>prot-eww.el</code>)</h4>
<div class="outline-text-4" id="text-h:1fcd7008-b7ed-4441-8a7b-82db43a05775">
<div class="org-src-container">
<pre class="src src-emacs-lisp">;;;; `prot-eww' extras
(use-package prot-eww
  :ensure nil
  :after eww
  :config
  (setq prot-eww-save-history-file
        (locate-user-emacs-file "prot-eww-visited-history"))
  (setq prot-eww-save-visited-history t)
  (setq prot-eww-bookmark-link nil)

  (add-hook 'prot-eww-history-mode-hook #'hl-line-mode)

  (define-prefix-command 'prot-eww-map)
  (define-key global-map (kbd "C-c w") 'prot-eww-map)

  (prot-emacs-keybind prot-eww-map
    "b" #'prot-eww-visit-bookmark
    "e" #'prot-eww-browse-dwim
    "s" #'prot-eww-search-engine)
  (prot-emacs-keybind eww-mode-map
    "B" #'prot-eww-bookmark-page
    "D" #'prot-eww-download-html
    "F" #'prot-eww-find-feed
    "H" #'prot-eww-list-history
    "b" #'prot-eww-visit-bookmark
    "e" #'prot-eww-browse-dwim
    "o" #'prot-eww-open-in-other-window
    "E" #'prot-eww-visit-url-on-page
    "J" #'prot-eww-jump-to-url-on-page
    "R" #'prot-eww-readable
    "Q" #'prot-eww-quit))
</pre>
</div>
</div>
</div>
<div id="outline-container-h:adc258d3-f444-4bb5-8a8d-43025a689167" class="outline-4">
<h4 id="h:adc258d3-f444-4bb5-8a8d-43025a689167"><span class="section-number-4">5.12.7.</span> <span class="todo TODO">TODO</span> The <code>prot-emacs-web.el</code> RSS/Atom reader (<code>elfeed</code>)</h4>
<div class="outline-text-4" id="text-h:adc258d3-f444-4bb5-8a8d-43025a689167">
<div class="org-src-container">
<pre class="src src-emacs-lisp">;;; Elfeed feed/RSS reader
(use-package elfeed
  :ensure t
  :hook
  (elfeed-show-mode . visual-line-mode)
  :bind
  ("C-c e" . elfeed)
  :config
  (setq elfeed-use-curl nil)
  (setq elfeed-curl-max-connections 10)
  (setq elfeed-db-directory (concat user-emacs-directory "elfeed/"))
  (setq elfeed-enclosure-default-dir "~/Downloads/")
  (setq elfeed-search-filter "@2-weeks-ago +unread")
  (setq elfeed-sort-order 'descending)
  (setq elfeed-search-clipboard-type 'CLIPBOARD)
  (setq elfeed-search-title-max-width 100)
  (setq elfeed-search-title-min-width 30)
  (setq elfeed-search-trailing-width 25)
  (setq elfeed-show-truncate-long-urls t)
  (setq elfeed-show-unique-buffers t)
  (setq elfeed-search-date-format '("%F %R" 16 :left))

  (prot-emacs-keybind elfeed-search-mode-map
    "w" #'elfeed-search-yank
    "g" #'elfeed-update
    "G" #'elfeed-search-update--force)

  (define-key elfeed-show-mode-map (kbd "w") #'elfeed-show-yank))

(use-package prot-elfeed
  :ensure nil
  :after elfeed
  :bind
  ( :map elfeed-search-mode-map
    ("s" . prot-elfeed-search-tag-filter)
    ("+" . prot-elfeed-toggle-tag)
    :map elfeed-show-mode-map
    ("+" . prot-elfeed-toggle-tag))
  :hook
  (elfeed-search-mode . prot-elfeed-load-feeds)
  :config
  (setq prot-elfeed-tag-faces t)
  (prot-elfeed-fontify-tags))
</pre>
</div>
</div>
</div>
<div id="outline-container-h:b9e6834b-e636-414e-8c50-9e04ba77a0a3" class="outline-4">
<h4 id="h:b9e6834b-e636-414e-8c50-9e04ba77a0a3"><span class="section-number-4">5.12.8.</span> <span class="todo TODO">TODO</span> The <code>prot-emacs-web.el</code> settings for the IRC client</h4>
<div class="outline-text-4" id="text-h:b9e6834b-e636-414e-8c50-9e04ba77a0a3">
<div class="org-src-container">
<pre class="src src-emacs-lisp">;;; Rcirc (IRC client)
(use-package rcirc
  :ensure nil
  :bind ("C-c i" . irc)
  :config
  (setq rcirc-server-alist
        `(("irc.libera.chat"
           :channels ("#emacs" "#rcirc")
           :port 6697
           :encryption tls
           :password ,(prot-common-auth-get-field "libera" :secret))))

  (setq rcirc-prompt "%t&gt; ") ; Read the docs or use (customize-set-variable 'rcirc-prompt "%t&gt; ")

  (setq rcirc-default-nick "protesilaos"
        rcirc-default-user-name rcirc-default-nick
        rcirc-default-full-name "Protesilaos Stavrou")

  ;; ;; NOTE 2021-11-28: demo from the days of EmacsConf 2021.  I don't
  ;; ;; actually need this.
  ;; (setq rcirc-bright-nicks '("bandali" "sachac" "zaeph"))

  ;; NOTE 2021-11-28: Is there a canonical way to disable this?
  (setq rcirc-timeout-seconds most-positive-fixnum)

  (rcirc-track-minor-mode 1))
</pre>
</div>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(provide 'prot-emacs-web)
</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-h:ddb1070d-2f91-4224-ad43-ef03f038f787" class="outline-3">
<h3 id="h:ddb1070d-2f91-4224-ad43-ef03f038f787"><span class="section-number-3">5.13.</span> The <code>prot-emacs-which-key.el</code> module</h3>
<div class="outline-text-3" id="text-h:ddb1070d-2f91-4224-ad43-ef03f038f787">
<p>
There is a user option in my setup to load this module
(<a href="#h:24324854-1f8c-4d8b-aa7c-291de968cbf4">The <code>init.el</code> option to enable <code>which-key</code></a>).
</p>

<p>
When the <code>which-key-mode</code> is enabled, any incomplete key sequence will
produce a popup at the lower part of the Emacs frame showing keys that
complete the current sequence together with the name of the command
they are invoking.
</p>

<p>
I personally do not use this, except when I need to do a
demonstration.
</p>

<p>
Note that <code>which-key</code> is built into Emacs 30. If you are on a previous
version, use <code>:ensure t</code> to install it from a package archive.
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(use-package which-key
  :ensure nil ; built into Emacs 30
  :hook (after-init . which-key-mode)
  :config
  (setq which-key-separator "  ")
  (setq which-key-prefix-prefix "... ")
  (setq which-key-max-display-columns 3)
  (setq which-key-idle-delay 1.5)
  (setq which-key-idle-secondary-delay 0.25)
  (setq which-key-add-column-padding 1)
  (setq which-key-max-description-length 40))

(provide 'prot-emacs-which-key)
</pre>
</div>
</div>
</div>
<div id="outline-container-h:4efde779-3ef0-40b7-82e4-70f71b321428" class="outline-3">
<h3 id="h:4efde779-3ef0-40b7-82e4-70f71b321428"><span class="section-number-3">5.14.</span> The <code>prot-emacs-icons.el</code> module (<code>nerd-icons</code> for various packages)</h3>
<div class="outline-text-3" id="text-h:4efde779-3ef0-40b7-82e4-70f71b321428">
<p>
I define a user option to conditionally load icons in various parts of
the Emacs interface (<a href="#h:a75444e3-527e-4525-84f8-0a43771966a6">The <code>init.el</code> option to load icons (<code>nerd-icons.el</code>)</a>).
These are purely cosmetic. I normally work without them, though I do
enable them for video demonstrations because they communicate more
information, which some people may find helpful.
</p>

<p>
Remember that these packages do not automatically install any font
files. The user must handle this step by invoking the command
<code>nerd-icons-install-fonts</code>.
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">;;; Icons
(use-package nerd-icons
  :ensure t)

(use-package nerd-icons-completion
  :ensure t
  :if (display-graphic-p)
  :after marginalia
  ;; FIXME 2024-09-01: For some reason this stopped working because it
  ;; macroexpands to `marginalia-mode' instead of
  ;; `marginalia-mode-hook'.  What is more puzzling is that this does
  ;; not happen in the next :hook...
  ;; :hook (marginalia-mode . nerd-icons-completion-marginalia-setup))
  :config
  (add-hook 'marginalia-mode-hook #'nerd-icons-completion-marginalia-setup))

(use-package nerd-icons-corfu
  :ensure t
  :if (display-graphic-p)
  :after corfu
  :config
  (add-to-list 'corfu-margin-formatters #'nerd-icons-corfu-formatter))

(use-package nerd-icons-dired
  :ensure t
  :if (display-graphic-p)
  :hook
  (dired-mode . nerd-icons-dired-mode))

(provide 'prot-emacs-icons)
</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-h:fc1ea247-5ef6-4c4e-a807-6c7b2482af90" class="outline-2">
<h2 id="h:fc1ea247-5ef6-4c4e-a807-6c7b2482af90"><span class="section-number-2">6.</span> The custom libraries of my configuration</h2>
<div class="outline-text-2" id="text-h:fc1ea247-5ef6-4c4e-a807-6c7b2482af90">
<p>
Each of the following subsections is dedicated to an individual custom
library. These are &ldquo;packages&rdquo; of mine that are only relevant to my
Emacs configuration, even though they are designed in accordance with
best practices for packaging Emacs Lisp code. Many of my public-facing
packages for Emacs started out as custom libraries like these
(<a href="#h:e289a614-4f17-4d6c-a028-42fe45aebe66">The init.el arrangements for my own modules and custom libraries</a>).
</p>

<p>
Please bear in mind that the code I write here is not necessarily as
high quality as what I put in my public packages, meaning that I do
not test it as much and do not try to make it perfect.
</p>
</div>
<div id="outline-container-h:ddb9c32c-2114-4347-9f76-5160e590b5dc" class="outline-3">
<h3 id="h:ddb9c32c-2114-4347-9f76-5160e590b5dc"><span class="section-number-3">6.1.</span> The <code>prot-abbrev.el</code> library</h3>
<div class="outline-text-3" id="text-h:ddb9c32c-2114-4347-9f76-5160e590b5dc">
<div class="org-src-container">
<pre class="src src-emacs-lisp">;;; prot-abbrev.el --- Functions for use with abbrev-mode -*- lexical-binding: t -*-

;; Copyright (C) 2024-2024  Protesilaos Stavrou

;; Author: Protesilaos Stavrou &lt;info@protesilaos.com&gt;
;; URL: https://protesilaos.com/emacs/dotemacs
;; Version: 0.1.0
;; Package-Requires: ((emacs "30.1"))

;; This file is NOT part of GNU Emacs.

;; This program is free software; you can redistribute it and/or modify
;; it under the terms of the GNU General Public License as published by
;; the Free Software Foundation, either version 3 of the License, or (at
;; your option) any later version.
;;
;; This program is distributed in the hope that it will be useful,
;; but WITHOUT ANY WARRANTY; without even the implied warranty of
;; MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
;; GNU General Public License for more details.
;;
;; You should have received a copy of the GNU General Public License
;; along with this program.  If not, see &lt;https://www.gnu.org/licenses/&gt;.

;;; Commentary:
;;
;; Functions for use with `abbrev-mode'.
;;
;; Remember that every piece of Elisp that I write is for my own
;; educational and recreational purposes.  I am not a programmer and I
;; do not recommend that you copy any of this if you are not certain of
;; what it does.

;;; Code:

(defgroup prot-abbrev ()
  "Functions for use with `abbrev-mode'."
  :group 'editing)

(defcustom prot-abbrev-time-specifier "%R"
  "Time specifier for `format-time-string'."
  :type 'string
  :group 'prot-abbrev)

(defcustom prot-abbrev-date-specifier "%F"
  "Date specifier for `format-time-string'."
  :type 'string
  :group 'prot-abbrev)

(defun prot-abbrev-current-time ()
  "Insert the current time per `prot-abbrev-time-specifier'."
  (insert (format-time-string prot-abbrev-time-specifier)))

(defun prot-abbrev-current-date ()
  "Insert the current date per `prot-abbrev-date-specifier'."
  (insert (format-time-string prot-abbrev-date-specifier)))

(defun prot-abbrev-jitsi-link ()
  "Insert a Jitsi link."
  (insert (concat "https://meet.jit.si/" (format-time-string "%Y%m%dT%H%M%S"))))

(defvar prot-abbrev-update-html-history nil
  "Minibuffer history for `prot-abbrev-update-html-prompt'.")

(defun prot-abbrev-update-html-prompt ()
  "Minibuffer prompt for `prot-abbrev-update-html'.
Use completion among previous entries, retrieving their data from
`prot-abbrev-update-html-history'."
  (completing-read
   "Insert update for manual: "
   prot-abbrev-update-html-history
   nil nil nil 'prot-abbrev-update-html-history))

(defun prot-abbrev-update-html ()
  "Insert message to update NAME.html page, by prompting for NAME."
  (insert (format "Update %s.html" (prot-abbrev-update-html-prompt))))

(provide 'prot-abbrev)
;;; prot-abbrev.el ends here
</pre>
</div>
</div>
</div>
<div id="outline-container-h:7affcbca-0808-4159-8eab-faa7973aefc7" class="outline-3">
<h3 id="h:7affcbca-0808-4159-8eab-faa7973aefc7"><span class="section-number-3">6.2.</span> The <code>prot-comment.el</code> library</h3>
<div class="outline-text-3" id="text-h:7affcbca-0808-4159-8eab-faa7973aefc7">
<div class="org-src-container">
<pre class="src src-emacs-lisp">;;; prot-comment.el --- Extensions newcomment.el for my dotemacs -*- lexical-binding: t -*-

;; Copyright (C) 2021-2024  Protesilaos Stavrou

;; Author: Protesilaos Stavrou &lt;info@protesilaos.com&gt;
;; URL: https://protesilaos.com/emacs/dotemacs
;; Version: 0.1.0
;; Package-Requires: ((emacs "30.1"))

;; This file is NOT part of GNU Emacs.

;; This program is free software; you can redistribute it and/or modify
;; it under the terms of the GNU General Public License as published by
;; the Free Software Foundation, either version 3 of the License, or
;; (at your option) any later version.
;;
;; This program is distributed in the hope that it will be useful,
;; but WITHOUT ANY WARRANTY; without even the implied warranty of
;; MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
;; GNU General Public License for more details.
;;
;; You should have received a copy of the GNU General Public License
;; along with this program.  If not, see &lt;https://www.gnu.org/licenses/&gt;.

;;; Commentary:
;;
;; This covers my newcomment.el extras, for use in my Emacs setup:
;; https://protesilaos.com/emacs/dotemacs.
;;
;; Remember that every piece of Elisp that I write is for my own
;; educational and recreational purposes.  I am not a programmer and I
;; do not recommend that you copy any of this if you are not certain of
;; what it does.

;;; Code:

(require 'newcomment)
(require 'prot-common)

(defgroup prot-comment ()
  "Extensions for newcomment.el."
  :group 'comment)

(defcustom prot-comment-keywords
  '("TODO" "NOTE" "XXX" "REVIEW" "FIXME")
  "List of strings with keywords used by `prot-comment-timestamp-keyword'."
  :type '(repeat string)
  :group 'prot-comment)

(defcustom prot-comment-timestamp-format-concise "%F"
  "Specifier for date in `prot-comment-timestamp-keyword'.
Refer to the doc string of `format-time-string' for the available
options."
  :type 'string
  :group 'prot-comment)

(defcustom prot-comment-timestamp-format-verbose "%F %T %z"
  "Like `prot-comment-timestamp-format-concise', but longer."
  :type 'string
  :group 'prot-comment)

;;;###autoload
(defun prot-comment (n)
  "Comment N lines, defaulting to the current one.
When the region is active, comment its lines instead."
  (interactive "p")
  (if (use-region-p)
      (comment-or-uncomment-region (region-beginning) (region-end))
    (comment-line n)))

(make-obsolete 'prot-comment-comment-dwim 'prot-comment "2023-09-28")

(defvar prot-comment--keyword-hist '()
  "Minibuffer history of `prot-comment--keyword-prompt'.")

(defun prot-comment--keyword-prompt (keywords)
  "Prompt for candidate among KEYWORDS (per `prot-comment-timestamp-keyword')."
  (let ((def (car prot-comment--keyword-hist)))
    (completing-read
     (format "Select keyword [%s]: " def)
     keywords nil nil nil 'prot-comment--keyword-hist def)))

(defun prot-comment--format-date (verbose)
  "Format date using `format-time-string'.
VERBOSE has the same meaning as `prot-comment-timestamp-keyword'."
  (format-time-string
   (if verbose
       prot-comment-timestamp-format-verbose
     prot-comment-timestamp-format-concise)))

(defun prot-comment--timestamp (keyword &amp;optional verbose)
  "Format string using current time and KEYWORD.
VERBOSE has the same meaning as `prot-comment-timestamp-keyword'."
  (format "%s %s: " keyword (prot-comment--format-date verbose)))

(defun prot-comment--format-comment (string)
  "Format comment STRING per `prot-comment-timestamp-keyword'.
STRING is a combination of a keyword and a time stamp."
  (concat comment-start
          (make-string comment-add (string-to-char comment-start))
          comment-padding
          string
          comment-end))

(defun prot-comment--maybe-newline ()
  "Call `newline' if current line is not empty.
Check `prot-comment-timestamp-keyword' for the rationale."
  (unless (prot-common-line-regexp-p 'empty 1)
    (save-excursion (newline))))

;;;###autoload
(defun prot-comment-timestamp-keyword (keyword &amp;optional verbose)
  "Add timestamped comment with KEYWORD.

When called interactively, the list of possible keywords is that
of `prot-comment-keywords', though it is possible to input
arbitrary text.

If point is at the beginning of the line or if line is empty (no
characters at all or just indentation), the comment is started
there in accordance with `comment-style'.  Any existing text
after the point will be pushed to a new line and will not be
turned into a comment.

If point is anywhere else on the line and the line is not empty,
the comment is appended to the line with `comment-indent'.

The comment is always formatted as DELIMITER KEYWORD DATE:, with
the date format being controlled by the variable
`prot-comment-timestamp-format-concise'.  DELIMITER is the value
of `comment-start', as defined by the current major mode.

With optional VERBOSE argument (such as a prefix argument), use
an alternative date format, as specified by
`prot-comment-timestamp-format-verbose'."
  (interactive
   (list
    (prot-comment--keyword-prompt prot-comment-keywords)
    current-prefix-arg))
  (let ((string (prot-comment--timestamp keyword verbose))
        (beg (point)))
    (cond
     ((prot-common-line-regexp-p 'empty)
      (insert (prot-comment--format-comment string)))
     ((eq beg (line-beginning-position))
      (insert (prot-comment--format-comment string))
      (indent-region beg (point))
      (prot-comment--maybe-newline))
     (t
      (comment-indent t)
      (insert (concat " " string))))))

(provide 'prot-comment)
;;; prot-comment.el ends here
</pre>
</div>
</div>
</div>
<div id="outline-container-h:3fccfadf-22e9-457f-b9fd-ed1b48600d23" class="outline-3">
<h3 id="h:3fccfadf-22e9-457f-b9fd-ed1b48600d23"><span class="section-number-3">6.3.</span> The <code>prot-common.el</code> library</h3>
<div class="outline-text-3" id="text-h:3fccfadf-22e9-457f-b9fd-ed1b48600d23">
<div class="org-src-container">
<pre class="src src-emacs-lisp">;;; prot-common.el --- Common functions for my dotemacs -*- lexical-binding: t -*-

;; Copyright (C) 2020-2024  Protesilaos Stavrou

;; Author: Protesilaos Stavrou &lt;info@protesilaos.com&gt;
;; URL: https://protesilaos.com/emacs/dotemacs
;; Version: 0.1.0
;; Package-Requires: ((emacs "30.1"))

;; This file is NOT part of GNU Emacs.

;; This program is free software; you can redistribute it and/or modify
;; it under the terms of the GNU General Public License as published by
;; the Free Software Foundation, either version 3 of the License, or (at
;; your option) any later version.
;;
;; This program is distributed in the hope that it will be useful,
;; but WITHOUT ANY WARRANTY; without even the implied warranty of
;; MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
;; GNU General Public License for more details.
;;
;; You should have received a copy of the GNU General Public License
;; along with this program.  If not, see &lt;https://www.gnu.org/licenses/&gt;.

;;; Commentary:
;;
;; Common functions for my Emacs: &lt;https://protesilaos.com/emacs/dotemacs/&gt;.
;;
;; Remember that every piece of Elisp that I write is for my own
;; educational and recreational purposes.  I am not a programmer and I
;; do not recommend that you copy any of this if you are not certain of
;; what it does.

;;; Code:

(eval-when-compile
  (require 'subr-x)
  (require 'cl-lib))

(defgroup prot-common ()
  "Auxiliary functions for my dotemacs."
  :group 'editing)

;;;###autoload
(defun prot-common-number-even-p (n)
  "Test if N is an even number."
  (if (numberp n)
      (= (% n 2) 0)
    (error "%s is not a number" n)))

;;;###autoload
(defun prot-common-number-integer-p (n)
  "Test if N is an integer."
  (if (integerp n)
      n
    (error "%s is not an integer" n)))

;;;###autoload
(defun prot-common-number-integer-positive-p (n)
  "Test if N is a positive integer."
  (if (prot-common-number-integer-p n)
      (&gt; n 0)
    (error "%s is not a positive integer" n)))

;; Thanks to Gabriel for providing a cleaner version of
;; `prot-common-number-negative': &lt;https://github.com/gabriel376&gt;.
;;;###autoload
(defun prot-common-number-negative (n)
  "Make N negative."
  (if (and (numberp n) (&gt; n 0))
      (* -1 n)
    (error "%s is not a valid positive number" n)))

;;;###autoload
(defun prot-common-reverse-percentage (number percent change-p)
  "Determine the original value of NUMBER given PERCENT.

CHANGE-P should specify the increase or decrease.  For simplicity,
nil means decrease while non-nil stands for an increase.

NUMBER must satisfy `numberp', while PERCENT must be `natnump'."
  (unless (numberp number)
    (user-error "NUMBER must satisfy numberp"))
  (unless (natnump percent)
    (user-error "PERCENT must satisfy natnump"))
  (let* ((pc (/ (float percent) 100))
         (pc-change (if change-p (+ 1 pc) pc))
         (n (if change-p pc-change (float (- 1 pc-change)))))
    ;; FIXME 2021-12-21: If float, round to 4 decimal points.
    (/ number n)))

;;;###autoload
(defun prot-common-percentage-change (n-original n-final)
  "Find percentage change between N-ORIGINAL and N-FINAL numbers.

When the percentage is not an integer, it is rounded to 4
floating points: 16.666666666666664 =&gt; 16.667."
  (unless (numberp n-original)
    (user-error "N-ORIGINAL must satisfy numberp"))
  (unless (numberp n-final)
    (user-error "N-FINAL must satisfy numberp"))
  (let* ((difference (float (abs (- n-original n-final))))
         (n (* (/ difference n-original) 100))
         (round (floor n)))
    ;; FIXME 2021-12-21: Any way to avoid the `string-to-number'?
    (if (&gt; n round) (string-to-number (format "%0.4f" n)) round)))

;; REVIEW 2023-04-07 07:43 +0300: I just wrote the conversions from
;; seconds.  Hopefully they are correct, but I need to double check.
(defun prot-common-seconds-to-minutes (seconds)
  "Convert a number representing SECONDS to MM:SS notation."
  (let ((minutes (/ seconds 60))
        (seconds (% seconds 60)))
    (format "%.2d:%.2d" minutes seconds)))

(defun prot-common-seconds-to-hours (seconds)
  "Convert a number representing SECONDS to HH:MM:SS notation."
  (let* ((hours (/ seconds 3600))
         (minutes (/ (% seconds 3600) 60))
         (seconds (% seconds 60)))
    (format "%.2d:%.2d:%.2d" hours minutes seconds)))

;;;###autoload
(defun prot-common-seconds-to-minutes-or-hours (seconds)
  "Convert SECONDS to either minutes or hours, depending on the value."
  (if (&gt; seconds 3599)
      (prot-common-seconds-to-hours seconds)
    (prot-common-seconds-to-minutes seconds)))

;;;###autoload
(defun prot-common-rotate-list-of-symbol (symbol)
  "Rotate list value of SYMBOL by moving its car to the end.
Return the first element before performing the rotation.

This means that if `sample-list' has an initial value of `(one
two three)', this function will first return `one' and update the
value of `sample-list' to `(two three one)'.  Subsequent calls
will continue rotating accordingly."
  (unless (symbolp symbol)
    (user-error "%s is not a symbol" symbol))
  (when-let* ((value (symbol-value symbol))
              (list (and (listp value) value))
              (first (car list)))
    (set symbol (append (cdr list) (list first)))
    first))

;;;###autoload
(defun prot-common-empty-buffer-p ()
  "Test whether the buffer is empty."
  (or (= (point-min) (point-max))
      (save-excursion
        (goto-char (point-min))
        (while (and (looking-at "^\\([a-zA-Z]+: ?\\)?$")
                    (zerop (forward-line 1))))
        (eobp))))

;;;###autoload
(defun prot-common-minor-modes-active ()
  "Return list of active minor modes for the current buffer."
  (let ((active-modes))
    (mapc (lambda (m)
            (when (and (boundp m) (symbol-value m))
              (push m active-modes)))
          minor-mode-list)
    active-modes))

;;;###autoload
(defun prot-common-truncate-lines-silently ()
  "Toggle line truncation without printing messages."
  (let ((inhibit-message t))
    (toggle-truncate-lines t)))

;; NOTE 2023-08-12: I tried the `clear-message-function', but it did
;; not work.  What I need is very simple and this gets the job done.
;;;###autoload
(defun prot-common-clear-minibuffer-message (&amp;rest _)
  "Print an empty message to clear the echo area.
Use this as advice :after a noisy function."
  (message ""))

;;;###autoload
(defun prot-common-disable-hl-line ()
  "Disable Hl-Line-Mode (for hooks)."
  (hl-line-mode -1))

;;;###autoload
(defun prot-common-window-bounds ()
  "Return start and end points in the window as a cons cell."
  (cons (window-start) (window-end)))

;;;###autoload
(defun prot-common-page-p ()
  "Return non-nil if there is a `page-delimiter' in the buffer."
  (or (save-excursion (re-search-forward page-delimiter nil t))
      (save-excursion (re-search-backward page-delimiter nil t))))

;;;###autoload
(defun prot-common-window-small-p ()
  "Return non-nil if window is small.
Check if the `window-width' or `window-height' is less than
`split-width-threshold' and `split-height-threshold',
respectively."
  (or (and (numberp split-width-threshold)
           (&lt; (window-total-width) split-width-threshold))
      (and (numberp split-height-threshold)
           (&gt; (window-total-height) split-height-threshold))))

(defun prot-common-window-narrow-p ()
  "Return non-nil if window is narrow.
Check if the `window-width' is less than `split-width-threshold'."
  (and (numberp split-width-threshold)
       (&lt; (window-total-width) split-width-threshold)))

;;;###autoload
(defun prot-common-three-or-more-windows-p (&amp;optional frame)
  "Return non-nil if three or more windows occupy FRAME.
If FRAME is non-nil, inspect the current frame."
  (&gt;= (length (window-list frame :no-minibuffer)) 3))

;;;###autoload
(defun prot-common-read-data (file)
  "Read Elisp data from FILE."
  (with-temp-buffer
    (insert-file-contents file)
    (read (current-buffer))))

;;;###autoload
(defun prot-common-completion-category ()
  "Return completion category."
  (when-let* ((window (active-minibuffer-window)))
    (with-current-buffer (window-buffer window)
      (completion-metadata-get
       (completion-metadata (buffer-substring-no-properties
                             (minibuffer-prompt-end)
                             (max (minibuffer-prompt-end) (point)))
                            minibuffer-completion-table
                            minibuffer-completion-predicate)
       'category))))

;; Thanks to Omar Antolín Camarena for providing this snippet!
;;;###autoload
(defun prot-common-completion-table (category candidates)
  "Pass appropriate metadata CATEGORY to completion CANDIDATES.

This is intended for bespoke functions that need to pass
completion metadata that can then be parsed by other
tools (e.g. `embark')."
  (lambda (string pred action)
    (if (eq action 'metadata)
        `(metadata (category . ,category))
      (complete-with-action action candidates string pred))))

;;;###autoload
(defun prot-common-completion-table-no-sort (category candidates)
  "Pass appropriate metadata CATEGORY to completion CANDIDATES.
Like `prot-common-completion-table' but also disable sorting."
  (lambda (string pred action)
    (if (eq action 'metadata)
        `(metadata (category . ,category)
                   (display-sort-function . ,#'identity))
      (complete-with-action action candidates string pred))))

;; Thanks to Igor Lima for the `prot-common-crm-exclude-selected-p':
;; &lt;https://github.com/0x462e41&gt;.
;; This is used as a filter predicate in the relevant prompts.
(defvar crm-separator)

;;;###autoload
(defun prot-common-crm-exclude-selected-p (input)
  "Filter out INPUT from `completing-read-multiple'.
Hide non-destructively the selected entries from the completion
table, thus avoiding the risk of inputting the same match twice.

To be used as the PREDICATE of `completing-read-multiple'."
  (if-let* ((pos (string-match-p crm-separator input))
            (rev-input (reverse input))
            (element (reverse
                      (substring rev-input 0
                                 (string-match-p crm-separator rev-input))))
            (flag t))
      (progn
        (while pos
          (if (string= (substring input 0 pos) element)
              (setq pos nil)
            (setq input (substring input (1+ pos))
                  pos (string-match-p crm-separator input)
                  flag (when pos t))))
        (not flag))
    t))

;; The `prot-common-line-regexp-p' and `prot-common--line-regexp-alist'
;; are contributed by Gabriel: &lt;https://github.com/gabriel376&gt;.  They
;; provide a more elegant approach to using a macro, as shown further
;; below.
(defvar prot-common--line-regexp-alist
  '((empty . "[\s\t]*$")
    (indent . "^[\s\t]+")
    (non-empty . "^.+$")
    (list . "^\\([\s\t#*+]+\\|[0-9]+[^\s]?[).]+\\)")
    (heading . "^[=-]+"))
  "Alist of regexp types used by `prot-common-line-regexp-p'.")

(defun prot-common-line-regexp-p (type &amp;optional n)
  "Test for TYPE on line.
TYPE is the car of a cons cell in
`prot-common--line-regexp-alist'.  It matches a regular
expression.

With optional N, search in the Nth line from point."
  (save-excursion
    (goto-char (line-beginning-position))
    (and (not (bobp))
         (or (beginning-of-line n) t)
         (save-match-data
           (looking-at
            (alist-get type prot-common--line-regexp-alist))))))

;; The `prot-common-shell-command-with-exit-code-and-output' function is
;; courtesy of Harold Carr, who also sent a patch that improved
;; `prot-eww-download-html' (from the `prot-eww.el' library).
;;
;; More about Harold: &lt;http://haroldcarr.com/about/&gt;.
(defun prot-common-shell-command-with-exit-code-and-output (command &amp;rest args)
  "Run COMMAND with ARGS.
Return the exit code and output in a list."
  (with-temp-buffer
    (list (apply 'call-process command nil (current-buffer) nil args)
          (buffer-string))))

(defvar prot-common-url-regexp
  (concat
   "~?\\&lt;\\([-a-zA-Z0-9+&amp;@#/%?=~_|!:,.;]*\\)"
   "[.@]"
   "\\([-a-zA-Z0-9+&amp;@#/%?=~_|!:,.;]+\\)\\&gt;/?")
  "Regular expression to match (most?) URLs or email addresses.")

(autoload 'auth-source-search "auth-source")

;;;###autoload
(defun prot-common-auth-get-field (host prop)
  "Find PROP in `auth-sources' for HOST entry."
  (when-let* ((source (auth-source-search :host host)))
    (if (eq prop :secret)
        (funcall (plist-get (car source) prop))
      (plist-get (flatten-list source) prop))))

;;;###autoload
(defun prot-common-parse-file-as-list (file)
  "Return the contents of FILE as a list of strings.
Strings are split at newline characters and are then trimmed for
negative space.

Use this function to provide a list of candidates for
completion (per `completing-read')."
  (split-string
   (with-temp-buffer
     (insert-file-contents file)
     (buffer-substring-no-properties (point-min) (point-max)))
   "\n" :omit-nulls "[\s\f\t\n\r\v]+"))

(defun prot-common-ignore (&amp;rest _)
  "Use this as override advice to make a function do nothing."
  nil)

;; NOTE 2023-06-02: The `prot-common-wcag-formula' and
;; `prot-common-contrast' are taken verbatim from my `modus-themes'
;; and renamed to have the prefix `prot-common-' instead of
;; `modus-themes-'.  This is all my code, of course, but I do it this
;; way to ensure that this file is self-contained in case someone
;; copies it.

;; This is the WCAG formula: &lt;https://www.w3.org/TR/WCAG20-TECHS/G18.html&gt;.
(defun prot-common-wcag-formula (hex)
  "Get WCAG value of color value HEX.
The value is defined in hexadecimal RGB notation, such #123456."
  (cl-loop for k in '(0.2126 0.7152 0.0722)
           for x in (color-name-to-rgb hex)
           sum (* k (if (&lt;= x 0.03928)
                        (/ x 12.92)
                      (expt (/ (+ x 0.055) 1.055) 2.4)))))

;;;###autoload
(defun prot-common-contrast (c1 c2)
  "Measure WCAG contrast ratio between C1 and C2.
C1 and C2 are color values written in hexadecimal RGB."
  (let ((ct (/ (+ (prot-common-wcag-formula c1) 0.05)
               (+ (prot-common-wcag-formula c2) 0.05))))
    (max ct (/ ct))))

;;;; EXPERIMENTAL macros (not meant to be used anywhere)

;; TODO 2023-09-30: Try the same with `cl-defmacro' and &amp;key
(defmacro prot-common-if (condition &amp;rest consequences)
  "Separate the CONSEQUENCES of CONDITION semantically.
Like `if', `when', `unless' but done by using `:then' and `:else'
keywords.  The forms under each keyword of `:then' and `:else'
belong to the given subset of CONSEQUENCES.

- The absence of `:else' means: (if CONDITION (progn CONSEQUENCES)).
- The absence of `:then' means: (if CONDITION nil CONSEQUENCES).
- Otherwise: (if CONDITION (progn then-CONSEQUENCES) else-CONSEQUENCES)."
  (declare (indent 1))
  (let (then-consequences else-consequences last-kw)
    (dolist (elt consequences)
      (let ((is-keyword (keywordp elt)))
        (cond
         ((and (not is-keyword) (eq last-kw :then))
          (push elt then-consequences))
         ((and (not is-keyword) (eq last-kw :else))
          (push elt else-consequences))
         ((and is-keyword (eq elt :then))
          (setq last-kw :then))
         ((and is-keyword (eq elt :else))
          (setq last-kw :else)))))
    `(if ,condition
         ,(if then-consequences
              `(progn ,@(nreverse then-consequences))
            nil)
       ,@(nreverse else-consequences))))

(provide 'prot-common)
;;; prot-common.el ends here
</pre>
</div>
</div>
</div>
<div id="outline-container-h:92cfefcf-8c20-43cd-b47c-ffe0c5fe1887" class="outline-3">
<h3 id="h:92cfefcf-8c20-43cd-b47c-ffe0c5fe1887"><span class="section-number-3">6.4.</span> The <code>prot-dired.el</code> library</h3>
<div class="outline-text-3" id="text-h:92cfefcf-8c20-43cd-b47c-ffe0c5fe1887">
<div class="org-src-container">
<pre class="src src-emacs-lisp">;;; prot-dired.el --- Extensions to dired.el for my dotemacs -*- lexical-binding: t -*-

;; Copyright (C) 2020-2024  Protesilaos Stavrou

;; Author: Protesilaos Stavrou &lt;info@protesilaos.com&gt;
;; URL: https://protesilaos.com/emacs/dotemacs
;; Version: 0.1.0
;; Package-Requires: ((emacs "30.1"))

;; This file is NOT part of GNU Emacs.

;; This program is free software; you can redistribute it and/or modify
;; it under the terms of the GNU General Public License as published by
;; the Free Software Foundation, either version 3 of the License, or
;; (at your option) any later version.
;;
;; This program is distributed in the hope that it will be useful,
;; but WITHOUT ANY WARRANTY; without even the implied warranty of
;; MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
;; GNU General Public License for more details.
;;
;; You should have received a copy of the GNU General Public License
;; along with this program.  If not, see &lt;https://www.gnu.org/licenses/&gt;.

;;; Commentary:
;;
;; This covers my dired.el extensions, for use in my Emacs setup:
;; https://protesilaos.com/emacs/dotemacs.
;;
;; Remember that every piece of Elisp that I write is for my own
;; educational and recreational purposes.  I am not a programmer and I
;; do not recommend that you copy any of this if you are not certain of
;; what it does.

;;; Code:

(require 'prot-common)
(require 'dired)
(require 'dired-aux)

(defgroup prot-dired ()
  "Extensions for Dired."
  :group 'dired)

;;;; Flat Dired listing

(defvar prot-dired-regexp-history nil
  "Minibuffer history of `prot-dired-regexp-prompt'.")

(defun prot-dired-regexp-prompt ()
  (let ((default (car prot-dired-regexp-history)))
    (read-regexp
     (format-prompt "Files matching REGEXP" default)
     default 'prot-dired-regexp-history)))

(defun prot-dired--get-files (regexp)
  "Return files matching REGEXP, recursively from `default-directory'."
  (directory-files-recursively default-directory regexp nil))

;;;###autoload
(defun prot-dired-search-flat-list (regexp)
  "Return a Dired buffer for files matching REGEXP.
Perform the search recursively from the current directory."
  (interactive (list (prot-dired-regexp-prompt)))
  (if-let* ((files (prot-dired--get-files regexp))
            (relative-paths (mapcar #'file-relative-name files)))
      (dired (cons (format "prot-flat-dired for `%s'" regexp) relative-paths))
    (error "No files matching `%s'" regexp)))

;;;; General commands

;; NOTE 2023-06-27: This user option is quick-and-dirty.  I prefer not
;; to have an option at all and simply do the right thing based on
;; `dired-guess-shell-alist-user'.
(defcustom prot-dired-always-external-regexp
  "\\(mkv\\|mp4\\|mp4\\|ogg\\|m4a\\|webm\\)"
  "Regular expression of file extensions to open externally.
The test is performed by `prot-dired-open-dwim', which then
defers to the `dired-guess-shell-alist-user'."
  :group 'prot-dired
  :type 'string)

;; NOTE 2023-06-27: This is a proof-of-concept.  See the previous
;; note.
(defun prot-dired-open-dwim (files)
  "Open FILES using the appropriate program."
  (interactive (list (dired-get-marked-files)))
  (if-let* ((extension (file-name-extension (car files)))
            ((string-match-p extension prot-dired-always-external-regexp))
            (guess (dired-guess-default files))
            (program (if (listp guess) (car guess) guess)))
      (dired-do-async-shell-command program nil files)
    (find-file (car files))))

(defvar prot-dired--limit-hist '()
  "Minibuffer history for `prot-dired-limit-regexp'.")

;;;###autoload
(defun prot-dired-limit-regexp (regexp omit)
  "Limit Dired to keep files matching REGEXP.

With optional OMIT argument as a prefix (\\[universal-argument]),
exclude files matching REGEXP.

Restore the buffer with \\&lt;dired-mode-map&gt;`\\[revert-buffer]'."
  (interactive
   (list
    (read-regexp
     (concat "Files "
             (when current-prefix-arg
               (propertize "NOT " 'face 'warning))
             "matching PATTERN: ")
     nil 'prot-dired--limit-hist)
    current-prefix-arg))
  (dired-mark-files-regexp regexp)
  (unless omit (dired-toggle-marks))
  (dired-do-kill-lines)
  (add-to-history 'prot-dired--limit-hist regexp))

(defvar prot-dired--find-grep-hist '()
  "Minibuffer history for `prot-dired-grep-marked-files'.")

;; Also see `prot-search-grep' from prot-search.el.
;;;###autoload
(defun prot-dired-grep-marked-files (regexp &amp;optional arg)
  "Run `find' with `grep' for REGEXP on marked files.
When no files are marked or when just a single one is marked,
search the entire directory instead.

With optional prefix ARG target a single marked file.

We assume that there is no point in marking a single file and
running find+grep on its contents.  Visit it and call `occur' or
run grep directly on it without the whole find part."
  (interactive
   (list
    (read-string "grep for PATTERN (marked files OR current directory): " nil 'prot-dired--find-grep-hist)
    current-prefix-arg)
   dired-mode)
  (when-let* ((marks (dired-get-marked-files 'no-dir))
              (files (mapconcat #'identity marks " "))
              (args (if (or arg (length&gt; marks 1))
                        ;; Thanks to Sean Whitton for pointing out an
                        ;; earlier superfluity of mine: we do not need
                        ;; to call grep through find when we already
                        ;; know the files we want to search in.  Check
                        ;; Sean's dotfiles:
                        ;; &lt;https://git.spwhitton.name/dotfiles&gt;.
                        ;;
                        ;; Any other errors or omissions are my own.
                        (format "grep -nH --color=auto %s %s" (shell-quote-argument regexp) files)
                      (concat
                       "find . -not " (shell-quote-argument "(")
                       " -wholename " (shell-quote-argument "*/.git*")
                       " -prune " (shell-quote-argument ")")
                       " -type f"
                       " -exec grep -nHE --color=auto " regexp " "
                       (shell-quote-argument "{}")
                       " " (shell-quote-argument ";") " "))))
    (compilation-start
     args
     'grep-mode
     (lambda (mode) (format "*prot-dired-find-%s for '%s'" mode regexp))
     t)))

;;;; Subdir extras and Imenu setup

(defvar prot-dired--directory-header-regexp "^ +\\(.+\\):\n"
  "Pattern to match Dired directory headings.")

;;;###autoload
(defun prot-dired-subdirectory-next (&amp;optional arg)
  "Move to next or optional ARGth Dired subdirectory heading.
For more on such headings, read `dired-maybe-insert-subdir'."
  (interactive "p")
  (let ((pos (point))
        (subdir prot-dired--directory-header-regexp))
    (goto-char (line-end-position))
    (if (re-search-forward subdir nil t (or arg nil))
        (progn
          (goto-char (match-beginning 1))
          (goto-char (line-beginning-position)))
      (goto-char pos))))

;;;###autoload
(defun prot-dired-subdirectory-previous (&amp;optional arg)
  "Move to previous or optional ARGth Dired subdirectory heading.
For more on such headings, read `dired-maybe-insert-subdir'."
  (interactive "p")
  (let ((pos (point))
        (subdir prot-dired--directory-header-regexp))
    (goto-char (line-beginning-position))
    (if (re-search-backward subdir nil t (or arg nil))
        (goto-char (line-beginning-position))
      (goto-char pos))))

(autoload 'dired-current-directory "dired")
(autoload 'dired-kill-subdir "dired-aux")

;;;###autoload
(defun prot-dired-remove-inserted-subdirs ()
  "Remove all inserted Dired subdirectories."
  (interactive)
  (goto-char (point-max))
  (while (and (prot-dired-subdirectory-previous)
              (not (equal (dired-current-directory)
                          (expand-file-name default-directory))))
    (dired-kill-subdir)))

(autoload 'cl-remove-if-not "cl-seq")

(defun prot-dired--dir-list (list)
  "Filter out non-directory file paths in LIST."
  (cl-remove-if-not
   (lambda (dir)
     (file-directory-p dir))
   list))

(defun prot-dired--insert-dir (dir &amp;optional flags)
  "Insert DIR using optional FLAGS."
  (dired-maybe-insert-subdir (expand-file-name dir) (or flags nil)))

(autoload 'dired-get-filename "dired")
(autoload 'dired-get-marked-files "dired")
(autoload 'dired-maybe-insert-subdir "dired-aux")
(defvar dired-subdir-switches)
(defvar dired-actual-switches)

;;;###autoload
(defun prot-dired-insert-subdir (&amp;optional arg)
  "Generic command to insert subdirectories in Dired buffers.

When items are marked, insert those which are subsirectories of
the current directory.  Ignore regular files.

If no marks are active and point is on a subdirectory line,
insert it directly.

If no marks are active and point is not on a subdirectory line,
prompt for a subdirectory using completion.

With optional ARG as a single prefix (`\\[universal-argument]')
argument, prompt for command line flags to pass to the underlying
ls program.

With optional ARG as a double prefix argument, remove all
inserted subdirectories."
  (interactive "p")
  (let* ((name (dired-get-marked-files))
         (flags (when (eq arg 4)
                  (read-string "Flags for `ls' listing: "
                               (or dired-subdir-switches dired-actual-switches)))))
    (cond  ; NOTE 2021-07-20: `length&gt;', `length=' are from Emacs28
     ((eq arg 16)
      (prot-dired-remove-inserted-subdirs))
     ((and (length&gt; name 1) (prot-dired--dir-list name))
      (mapc (lambda (file)
              (when (file-directory-p file)
                (prot-dired--insert-dir file flags)))
            name))
     ((and (length= name 1) (file-directory-p (car name)))
      (prot-dired--insert-dir (car name) flags))
     (t
      (let ((selection (read-directory-name "Insert directory: ")))
        (prot-dired--insert-dir selection flags))))))

(defun prot-dired--imenu-prev-index-position ()
  "Find the previous file in the buffer."
  (let ((subdir prot-dired--directory-header-regexp))
    (re-search-backward subdir nil t)))

(defun prot-dired--imenu-extract-index-name ()
  "Return the name of the file at point."
  (file-relative-name
   (buffer-substring-no-properties (+ (line-beginning-position) 2)
                                   (1- (line-end-position)))))

;;;###autoload
(defun prot-dired-setup-imenu ()
  "Configure imenu for the current Dired buffer.
Add this to `dired-mode-hook'."
  (set (make-local-variable 'imenu-prev-index-position-function)
       'prot-dired--imenu-prev-index-position)
  (set (make-local-variable 'imenu-extract-index-name-function)
       'prot-dired--imenu-extract-index-name))

(provide 'prot-dired)
;;; prot-dired.el ends here
</pre>
</div>
</div>
</div>
<div id="outline-container-h:98c313d7-62c2-48c1-b6ad-28cc25f22092" class="outline-3">
<h3 id="h:98c313d7-62c2-48c1-b6ad-28cc25f22092"><span class="section-number-3">6.5.</span> The <code>prot-elfeed.el</code> library</h3>
<div class="outline-text-3" id="text-h:98c313d7-62c2-48c1-b6ad-28cc25f22092">
<div class="org-src-container">
<pre class="src src-emacs-lisp">;;; prot-elfeed.el --- Elfeed extensions for my dotemacs -*- lexical-binding: t -*-

;; Copyright (C) 2021-2024  Protesilaos Stavrou

;; Author: Protesilaos Stavrou &lt;info@protesilaos.com&gt;
;; URL: https://protesilaos.com/emacs/dotemacs
;; Version: 0.1.0
;; Package-Requires: ((emacs "30.1"))

;; This file is NOT part of GNU Emacs.

;; This program is free software; you can redistribute it and/or modify
;; it under the terms of the GNU General Public License as published by
;; the Free Software Foundation, either version 3 of the License, or
;; (at your option) any later version.
;;
;; This program is distributed in the hope that it will be useful,
;; but WITHOUT ANY WARRANTY; without even the implied warranty of
;; MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
;; GNU General Public License for more details.
;;
;; You should have received a copy of the GNU General Public License
;; along with this program.  If not, see &lt;https://www.gnu.org/licenses/&gt;.

;;; Commentary:

;; NOTE 2022-06-08: This is old code.  There are things I would like to
;; improve.

;;
;; Extensions for Elfeed, intended for use in my Emacs setup:
;; https://protesilaos.com/emacs/dotemacs.
;;
;; Remember that every piece of Elisp that I write is for my own
;; educational and recreational purposes.  I am not a programmer and I
;; do not recommend that you copy any of this if you are not certain of
;; what it does.

;;; Code:

(eval-when-compile (require 'subr-x))
(require 'elfeed nil t)
(require 'url-util)
(require 'prot-common)

(defgroup prot-elfeed ()
  "Personal extensions for Elfeed."
  :group 'elfeed)

(defcustom prot-elfeed-feeds-file
  (thread-last user-emacs-directory (expand-file-name "feeds.el.gpg"))
  "Path to file with `elfeed-feeds'."
  :type 'string
  :group 'prot-elfeed)

(defcustom prot-elfeed-archives-directory "~/Documents/feeds/"
  "Path to directory for storing Elfeed entries."
  :type 'string
  :group 'prot-elfeed)

(defcustom prot-elfeed-tag-faces nil
  "Add faces for certain tags.
The tags are: critical, important, personal."
  :type 'boolean
  :group 'prot-elfeed)

(defcustom prot-elfeed-search-tags '(critical important personal)
  "List of user-defined tags.
Used by `prot-elfeed-toggle-tag'."
  :type 'list
  :group 'prot-elfeed)

(defface prot-elfeed-entry-critical '((t :inherit font-lock-warning-face))
  "Face for Elfeed entries tagged with `critical'.")

(defface prot-elfeed-entry-important '((t :inherit font-lock-constant-face))
  "Face for Elfeed entries tagged with `important'.")

(defface prot-elfeed-entry-personal '((t :inherit font-lock-variable-name-face))
  "Face for Elfeed entries tagged with `personal'.")

;;;; Utilities

;;;###autoload
(defun prot-elfeed-load-feeds ()
  "Load file containing the `elfeed-feeds' list.
Add this to `elfeed-search-mode-hook'."
  (let ((feeds prot-elfeed-feeds-file))
    (if (file-exists-p feeds)
        (load-file feeds)
      (user-error "Missing feeds' file"))))

(defvar elfeed-search-face-alist)

;;;###autoload
(defun prot-elfeed-fontify-tags ()
  "Expand Elfeed faces if `prot-elfeed-tag-faces' is non-nil."
  (if prot-elfeed-tag-faces
      (setq elfeed-search-face-alist
            '((critical prot-elfeed-entry-critical)
              (important prot-elfeed-entry-important)
              (personal prot-elfeed-entry-personal)
              (unread elfeed-search-unread-title-face)))
    (setq elfeed-search-face-alist
          '((unread elfeed-search-unread-title-face)))))

(defvar prot-elfeed--tag-hist '()
  "History of inputs for `prot-elfeed-toggle-tag'.")

(defun prot-elfeed--character-prompt (tags)
  "Helper of `prot-elfeed-toggle-tag' to read TAGS."
  (let ((def (car prot-elfeed--tag-hist)))
    (completing-read
     (format "Toggle tag [%s]: " def)
     tags nil t nil 'prot-elfeed--tag-hist def)))

(defvar elfeed-show-entry)
(declare-function elfeed-tagged-p "elfeed")
(declare-function elfeed-search-toggle-all "elfeed")
(declare-function elfeed-show-tag "elfeed")
(declare-function elfeed-show-untag "elfeed")

;;;###autoload
(defun prot-elfeed-toggle-tag (tag)
  "Toggle TAG for the current item.

When the region is active in the `elfeed-search-mode' buffer, all
entries encompassed by it are affected.  Otherwise the item at
point is the target.  For `elfeed-show-mode', the current entry
is always the target.

The list of tags is provided by `prot-elfeed-search-tags'."
  (interactive
   (list
    (intern
     (prot-elfeed--character-prompt prot-elfeed-search-tags))))
  (if (derived-mode-p 'elfeed-show-mode)
      (if (elfeed-tagged-p tag elfeed-show-entry)
          (elfeed-show-untag tag)
        (elfeed-show-tag tag))
    (elfeed-search-toggle-all tag)))

(defvar elfeed-show-truncate-long-urls)
(declare-function elfeed-entry-title "elfeed")
(declare-function elfeed-show-refresh "elfeed")

;;;; General commands

(defvar elfeed-search-filter-active)
(defvar elfeed-search-filter)
(declare-function elfeed-db-get-all-tags "elfeed")
(declare-function elfeed-search-update "elfeed")
(declare-function elfeed-search-clear-filter "elfeed")

(defun prot-elfeed--format-tags (tags sign)
  "Prefix SIGN to each tag in TAGS."
  (mapcar (lambda (tag)
            (format "%s%s" sign tag))
          tags))

;;;###autoload
(defun prot-elfeed-search-tag-filter ()
  "Filter Elfeed search buffer by tags using completion.

Completion accepts multiple inputs, delimited by `crm-separator'.
Arbitrary input is also possible, but you may have to exit the
minibuffer with something like `exit-minibuffer'."
  (interactive)
  (unwind-protect
      (elfeed-search-clear-filter)
    (let* ((elfeed-search-filter-active :live)
           (db-tags (elfeed-db-get-all-tags))
           (plus-tags (prot-elfeed--format-tags db-tags "+"))
           (minus-tags (prot-elfeed--format-tags db-tags "-"))
           (all-tags (delete-dups (append plus-tags minus-tags)))
           (tags (completing-read-multiple
                  "Apply one or more tags: "
                  all-tags #'prot-common-crm-exclude-selected-p t))
           (input (string-join `(,elfeed-search-filter ,@tags) " ")))
      (setq elfeed-search-filter input))
    (elfeed-search-update :force)))

(provide 'prot-elfeed)
;;; prot-elfeed.el ends here
</pre>
</div>
</div>
</div>
<div id="outline-container-h:fb034be5-c316-4c4f-a46f-cebcab332a47" class="outline-3">
<h3 id="h:fb034be5-c316-4c4f-a46f-cebcab332a47"><span class="section-number-3">6.6.</span> The <code>prot-embark.el</code> library</h3>
<div class="outline-text-3" id="text-h:fb034be5-c316-4c4f-a46f-cebcab332a47">
<div class="org-src-container">
<pre class="src src-emacs-lisp">;;; prot-embark.el --- Custom Embark keymaps -*- lexical-binding: t -*-

;; Copyright (C) 2023-2024  Protesilaos Stavrou

;; Author: Protesilaos Stavrou &lt;info@protesilaos.com&gt;
;; URL: https://protesilaos.com/emacs/dotemacs
;; Version: 0.1.0
;; Package-Requires: ((emacs "30.1") (embark "0.23"))

;; This file is NOT part of GNU Emacs.

;; This program is free software; you can redistribute it and/or modify
;; it under the terms of the GNU General Public License as published by
;; the Free Software Foundation, either version 3 of the License, or (at
;; your option) any later version.
;;
;; This program is distributed in the hope that it will be useful,
;; but WITHOUT ANY WARRANTY; without even the implied warranty of
;; MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
;; GNU General Public License for more details.
;;
;; You should have received a copy of the GNU General Public License
;; along with this program.  If not, see &lt;https://www.gnu.org/licenses/&gt;.

;;; Commentary:
;;
;; Remember that every piece of Elisp that I write is for my own
;; educational and recreational purposes.  I am not a programmer and I
;; do not recommend that you copy any of this if you are not certain of
;; what it does.

;;; Code:

(require 'embark)

(defvar-keymap prot-embark-general-map
  :parent embark-general-map
  "i" #'embark-insert
  "w" #'embark-copy-as-kill
  "E" #'embark-export
  "S" #'embark-collect
  "A" #'embark-act-all
  "DEL" #'delete-region)

(defvar-keymap prot-embark-url-map
  :parent embark-general-map
  "b" #'browse-url
  "d" #'embark-download-url
  "e" #'eww)

(defvar-keymap prot-embark-buffer-map
  :parent embark-general-map
  "k" #'prot-simple-kill-buffer
  "o" #'switch-to-buffer-other-window
  "e" #'ediff-buffers)

(add-to-list 'embark-post-action-hooks (list 'prot-simple-kill-buffer 'embark--restart))

(defvar-keymap prot-embark-file-map
  :parent embark-general-map
  "f" #'find-file
  "j" #'embark-dired-jump
  "c" #'copy-file
  "e" #'ediff-files)

(defvar-keymap prot-embark-identifier-map
  :parent embark-general-map
  "h" #'display-local-help
  "." #'xref-find-definitions
  "o" #'occur)

(defvar-keymap prot-embark-command-map
  :parent embark-general-map
  "h" #'describe-command
  "." #'embark-find-definition)

(defvar-keymap prot-embark-expression-map
  :parent embark-general-map
  "e" #'pp-eval-expression
  "m" #'pp-macroexpand-expression)

(defvar-keymap prot-embark-function-map
  :parent embark-general-map
  "h" #'describe-function
  "." #'embark-find-definition)

(defvar-keymap prot-embark-package-map
  :parent embark-general-map
  "h" #'describe-package
  "i" #'package-install
  "d" #'package-delete
  "r" #'package-reinstall
  "u" #'embark-browse-package-url
  "w" #'embark-save-package-url)

(defvar-keymap prot-embark-symbol-map
  :parent embark-general-map
  "h" #'describe-symbol
  "." #'embark-find-definition)

(defvar-keymap prot-embark-variable-map
  :parent embark-general-map
  "h" #'describe-variable
  "." #'embark-find-definition)

(defvar-keymap prot-embark-region-map
  :parent embark-general-map
  "a" #'align-regexp
  "D" #'delete-duplicate-lines
  "f" #'flush-lines
  "i" #'epa-import-keys-region
  "d" #'epa-decrypt-armor-in-region
  "r" #'repunctuate-sentences
  "s" #'sort-lines
  "u" #'untabify)

;; The minimal indicator shows cycling options, but I have no use
;; for those.  I want it to be silent.
(defun prot-embark-no-minimal-indicator ())
(advice-add #'embark-minimal-indicator :override #'prot-embark-no-minimal-indicator)

(defun prot-embark-act-no-quit ()
  "Call `embark-act' but do not quit after the action."
  (interactive)
  (let ((embark-quit-after-action nil))
    (call-interactively #'embark-act)))

(defun prot-embark-act-quit ()
  "Call `embark-act' and quit after the action."
  (interactive)
  (let ((embark-quit-after-action t))
    (call-interactively #'embark-act))
  (when (and (&gt; (minibuffer-depth) 0)
             (derived-mode-p 'completion-list-mode))
    (abort-recursive-edit)))

(provide 'prot-embark)
;;; prot-embark.el ends here
</pre>
</div>
</div>
</div>
<div id="outline-container-h:abc20037-7a4f-4555-809a-dc4165c5db6a" class="outline-3">
<h3 id="h:abc20037-7a4f-4555-809a-dc4165c5db6a"><span class="section-number-3">6.7.</span> The <code>prot-eww.el</code> library</h3>
<div class="outline-text-3" id="text-h:abc20037-7a4f-4555-809a-dc4165c5db6a">
<div class="org-src-container">
<pre class="src src-emacs-lisp">;;; prot-eww.el --- Extensions for EWW -*- lexical-binding: t -*-

;; Copyright (C) 2021-2024  Protesilaos Stavrou, Abhiseck Paira

;; Author: Protesilaos Stavrou &lt;info@protesilaos.com&gt;
;;         Abhiseck Paira &lt;abhiseckpaira@disroot.org&gt;
;; Maintainer: Protesilaos Stavrou &lt;info@protesilaos.com&gt;
;; URL: https://protesilaos.com/emacs/dotemacs
;; Version: 0.1.0
;; Package-Requires: ((emacs "30.1"))

;; This file is NOT part of GNU Emacs.

;; This program is free software; you can redistribute it and/or modify
;; it under the terms of the GNU General Public License as published by
;; the Free Software Foundation, either version 3 of the License, or (at
;; your option) any later version.
;;
;; This program is distributed in the hope that it will be useful,
;; but WITHOUT ANY WARRANTY; without even the implied warranty of
;; MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
;; GNU General Public License for more details.
;;
;; You should have received a copy of the GNU General Public License
;; along with this program.  If not, see &lt;https://www.gnu.org/licenses/&gt;.

;;; Commentary:
;;
;; Extensions for the eww, intended for my Emacs setup:
;; &lt;https://protesilaos.com/emacs/dotemacs/&gt;.
;;
;; Remember that every piece of Elisp that I write is for my own
;; educational and recreational purposes.  I am not a programmer and I
;; do not recommend that you copy any of this if you are not certain of
;; what it does.

;; XXX NOTE XXX 2023-05-19: Much of this code is severely out of date.
;; I plan to review it.  DO NOT USE!!!

;;; Code:

(require 'shr)
(require 'eww)
(require 'url-parse)
(require 'prot-common)

(defgroup prot-eww ()
  "Tweaks for EWW."
  :group 'eww)

;;;; Basic setup

;; TODO 2021-10-15: Deprecate this in favour of what we added to Emacs29.
;; &lt;https://protesilaos.com/codelog/2021-10-15-emacs-29-eww-rename-buffers/&gt;.

(defun prot-eww--rename-buffer ()
  "Rename EWW buffer using page title or URL.
To be used by `eww-after-render-hook'."
  (let ((name (if (equal "" (plist-get eww-data :title))
                  (plist-get eww-data :url)
                (plist-get eww-data :title))))
    (rename-buffer (format "*%s # eww*" name) t)))

(add-hook 'eww-after-render-hook #'prot-eww--rename-buffer)
(advice-add 'eww-back-url :after #'prot-eww--rename-buffer)
(advice-add 'eww-forward-url :after #'prot-eww--rename-buffer)

;;;; History extras

(defvar prot-eww-visited-history '()
  "History of visited URLs.")

(defcustom prot-eww-save-history-file
  (locate-user-emacs-file "prot-eww-visited-history")
  "File to save the value of `prot-eww-visited-history'."
  :type 'file
  :group 'prot-eww)

(defcustom prot-eww-save-visited-history nil
  "Whether to save `prot-eww-visited-history'.
If non-nil, save the value of `prot-eww-visited-history' in
`prot-eww-save-history-file'."
  :type 'boolean
  :group 'prot-eww)

(defcustom prot-eww-list-history-buffer "*prot-eww-history*"
  "Name of buffer for `prot-eww-list-history'."
  :type 'string
  :group 'prot-eww)

;; These history related functions are adapted from eww.
(defun prot-eww--save-visited-history ()
  "Save the value of `prot-eww-visited-history' in a file.
The file is determined by the variable `prot-eww-save-history-file'."
  (when prot-eww-save-visited-history
    (with-temp-file prot-eww-save-history-file
      (insert (concat ";; Auto-generated file;"
                      " don't edit -*- mode: lisp-data -*-\n"))
      (pp prot-eww-visited-history (current-buffer)))))

(defun prot-eww--read-visited-history (&amp;optional error-out)
  "Read history from `prot-eww-save-history-file'.
If ERROR-OUT, signal `user-error' if there is no history."
  (when prot-eww-save-visited-history
    (let ((file prot-eww-save-history-file))
      (setq prot-eww-visited-history
            (unless (zerop
                     (or (file-attribute-size (file-attributes file))
                         0))
              (with-temp-buffer
                (insert-file-contents file)
                (read (current-buffer)))))
      (when (and error-out (not prot-eww-visited-history))
        (user-error "No history is defined")))))

(unless prot-eww-visited-history
  (prot-eww--read-visited-history t))

(defun prot-eww--history-prepare ()
  "Prepare dedicated buffer for browsing history."
  (set-buffer (get-buffer-create prot-eww-list-history-buffer))
  (prot-eww-history-mode)
  (let ((inhibit-read-only t)
        start)
    (erase-buffer)
    (setq-local header-line-format
                "EWW Browsing History (prot-eww)")
    (dolist (history prot-eww-visited-history)
      (setq start (point))
      (insert (format "%s" history) "\n")
      (put-text-property start (1+ start) 'prot-eww-history history))
    (goto-char (point-min))))

;;;###autoload
(defun prot-eww-list-history ()
  "Display `prot-eww-visited-history' in a dedicated buffer.
This is a replacement for `eww-list-histories' (or equivalent),
as it can combine URLs in the Gopher or Gemini protocols."
  (interactive)
  (when prot-eww-visited-history
    (prot-eww--save-visited-history))
  (prot-eww--read-visited-history t)
  (pop-to-buffer prot-eww-list-history-buffer)
  (prot-eww--history-prepare))

(defvar prot-eww-history-kill-ring nil
  "Store the killed history element.")

(defun prot-eww-history-kill ()
  "Kill the current history."
  (interactive)
  (let* ((start (line-beginning-position))
         (history (get-text-property start 'prot-eww-history))
         (inhibit-read-only t))
    (unless history
      (user-error "No history on the current line"))
    (forward-line 1)
    (push (buffer-substring start (point))
          prot-eww-history-kill-ring)
    (delete-region start (point))
    (setq prot-eww-visited-history (delq history
                                         prot-eww-visited-history))
    (prot-eww--save-visited-history)))

(defun prot-eww-history-yank ()
  "Yank a previously killed history to the current line."
  (interactive)
  (unless prot-eww-history-kill-ring
    (user-error "No previously killed history"))
  (beginning-of-line)
  (let ((inhibit-read-only t)
        (start (point))
        history)
    (insert (pop prot-eww-history-kill-ring))
    (setq history (get-text-property start 'prot-eww-history))
    (if (= start (point-min))
        (push history prot-eww-visited-history)
      (let ((line (count-lines start (point))))
        (setcdr (nthcdr (1- line) prot-eww-visited-history)
                (cons history (nthcdr line
                                      prot-eww-visited-history)))))
    (prot-eww--save-visited-history)))

(defun prot-eww-history-browse ()
  "Browse the history under point."
  (interactive)
  (let ((history (get-text-property (line-beginning-position)
                                     'prot-eww-history)))
    (unless history
      (user-error "No history on the current line"))
    (quit-window)
    (prot-eww history)))

(defvar prot-eww-history-mode-map
  (let ((map (make-sparse-keymap)))
    (define-key map (kbd "C-k") 'prot-eww-history-kill)
    (define-key map (kbd "C-y") 'prot-eww-history-yank)
    (define-key map (kbd "&lt;RET&gt;") 'prot-eww-history-browse)

    (easy-menu-define nil map
      "Menu for `prot-eww-history-mode-map'."
      '("prot-eww history"
        ["Exit" quit-window t]
        ["Browse" prot-eww-history-browse
         :active (get-text-property (line-beginning-position)
                                    'prot-eww-history)]
        ["Kill" prot-eww-history-kill
         :active (get-text-property (line-beginning-position)
                                    'prot-eww-history)]
        ["Yank" prot-eww-history-yank
         :active prot-eww-history-kill-ring]))
    map))

(define-derived-mode prot-eww-history-mode
  special-mode
  "prot-eww-history"
  "Mode for listing history.

\\{prot-eww-history-mode-map}"
  (buffer-disable-undo)
  (setq truncate-lines t))

(defun prot-eww--record-history ()
  "Store URL in `prot-eww-visited-history'.
To be used by `eww-after-render-hook'."
  (let ((url (plist-get eww-data :url)))
    (add-to-history 'prot-eww-visited-history url)))

(add-hook 'eww-after-render-hook #'prot-eww--record-history)
(advice-add 'eww-back-url :after #'prot-eww--record-history)
(advice-add 'eww-forward-url :after #'prot-eww--record-history)
;; Is there a better function to add this advice?

;;;; Commands

;; handler that browse-url calls.

(defun prot-eww--get-current-url ()
  "Return the current-page's URL."
  (when (eq major-mode 'eww-mode)
    (plist-get eww-data :url)))

;;;###autoload
(defun prot-eww (url &amp;optional arg)
  "Pass URL to appropriate client.
With optional ARG, use a new buffer."
  (interactive (list (browse-url-interactive-arg "URL: ") current-prefix-arg))
  (eww url arg))

;;;###autoload
(defun prot-eww-browse-dwim (url &amp;optional arg)
  "Visit a URL, maybe from `eww-prompt-history', with completion.

With optional prefix ARG (\\[universal-argument]) open URL in a
new eww buffer.  If URL does not look like a valid link, run a
web query using `eww-search-prefix'.

When called from an eww buffer, provide the current link as
\\&lt;minibuffer-local-map&gt;\\[next-history-element]."
  (interactive
   (let ((all-history (delete-dups
                       (append prot-eww-visited-history
                               eww-prompt-history)))
         (current-url (prot-eww--get-current-url)))
     (list
      (completing-read "Run EWW on: " all-history
                       nil nil current-url 'eww-prompt-history current-url)
      (prefix-numeric-value current-prefix-arg))))
  (prot-eww url arg))

;; NOTE 2021-09-08: This uses the EWW-specific bookmarks, NOT those of
;; bookmark.el.  Further below I provide integration with the latter,
;; meaning that we must either make this obsolete or make it work with
;; the new system.
;;;###autoload
(defun prot-eww-visit-bookmark (&amp;optional arg)
  "Visit bookmarked URL.

With optional prefix ARG (\\[universal-argument]) open URL in a
new EWW buffer."
  (interactive "P")
  (eww-read-bookmarks)
  (let ((list (gensym)))
    (dolist (bookmark eww-bookmarks)
      (push (plist-get bookmark :url) list))
    (if eww-bookmarks
        (eww (completing-read "Visit EWW bookmark: " list)
             (when arg 4))
      (user-error "No bookmarks"))))

(defun prot-eww--capture-url-on-page (&amp;optional position)
  "Capture all the links on the current web page.

Return a list of strings.  Strings are in the form LABEL @ URL.
When optional argument POSITION is non-nil, include position info
in the strings too, so strings take the form
LABEL @ URL ~ POSITION."
  (let (links match)
    (save-excursion
      (goto-char (point-max))
      ;; NOTE 2021-07-25: The first clause in the `or' is meant to
      ;; address a bug where if a URL is in `point-min' it does not get
      ;; captured.
      (while (setq match (text-property-search-backward 'shr-url))
        (let* ((raw-url (prop-match-value match))
               (start-point-prop (prop-match-beginning match))
               (end-point-prop (prop-match-end match))
               (url (when (stringp raw-url)
                      (propertize raw-url 'face 'link)))
               (label (replace-regexp-in-string "\n" " " ; NOTE 2021-07-25: newlines break completion
                                                (buffer-substring-no-properties
                                                 start-point-prop end-point-prop)))
               (point start-point-prop)
               (line (line-number-at-pos point t))
               (column (save-excursion (goto-char point) (current-column)))
               (coordinates (propertize
                             (format "%d,%d (%d)" line column point)
                             'face 'shadow)))
          (when url
            (if position
                (push (format "%-15s ~ %s  @ %s"
                              coordinates label url)
                      links)
              (push (format "%s  @ %s"
                            label url)
                    links))))))
    links))

(defmacro prot-eww-act-visible-window (&amp;rest body)
  "Run BODY within narrowed-region.
If region is active run BODY within active region instead.
Return the value of the last form of BODY."
  `(save-restriction
     (if (use-region-p)
         (narrow-to-region (region-beginning) (region-end))
       (narrow-to-region (window-start) (window-end)))
     ,@body))

;;;###autoload
(defun prot-eww-visit-url-on-page (&amp;optional arg)
  "Visit URL from list of links on the page using completion.

With optional prefix ARG (\\[universal-argument]) open URL in a
new EWW buffer."
  (interactive "P")
  (when (derived-mode-p 'eww-mode)
    (let* ((links (prot-eww--capture-url-on-page))
           (selection (completing-read "Browse URL from page: " links nil t))
           (url (replace-regexp-in-string ".*@ " "" selection)))
      (eww url (when arg 4)))))

;;;###autoload
(defun prot-eww-jump-to-url-on-page (&amp;optional arg)
  "Jump to URL position on the page using completion.

When called without ARG (\\[universal-argument]) get URLs only
from the visible portion of the buffer.  But when ARG is provided
consider whole buffer."
  (interactive "P")
  (when (derived-mode-p 'eww-mode)
    (let* ((links
            (if arg
                (prot-eww--capture-url-on-page t)
              (prot-eww-act-visible-window
               (prot-eww--capture-url-on-page t))))
           (prompt-scope (if arg
                             (propertize "URL on the page" 'face 'warning)
                           "visible URL"))
           (prompt (format "Jump to %s: " prompt-scope))
           (selection (completing-read prompt links nil t))
           (position (replace-regexp-in-string "^.*(\\([0-9]+\\))[\s\t]+~" "\\1" selection))
           (point (string-to-number position)))
      (goto-char point))))

(defvar prot-eww--occur-feed-regexp
  (concat "\\(rss\\|atom\\)\\+xml.\\(.\\|\n\\)"
          ".*href=[\"']\\(.*?\\)[\"']")
  "Regular expression to match web feeds in HTML source.")

;;;###autoload
(defun prot-eww-find-feed ()
  "Produce bespoke buffer with RSS/Atom links from XML source."
  (interactive)
  (let* ((url (or (plist-get eww-data :start)
                  (plist-get eww-data :contents)
                  (plist-get eww-data :home)
                  (plist-get eww-data :url)))
         (title (or (plist-get eww-data :title) url))
         (source (plist-get eww-data :source))
         (buf-name (format "*feeds: %s # eww*" title)))
    (with-temp-buffer
      (insert source)
      (occur-1 prot-eww--occur-feed-regexp "\\3" (list (current-buffer)) buf-name))
    ;; Handle relative URLs, so that we get an absolute URL out of them.
    ;; Findings like "rss.xml" are not particularly helpful.
    ;;
    ;; NOTE 2021-03-31: the base-url heuristic may not always be
    ;; correct, though it has worked in all cases I have tested it on.
    (when (get-buffer buf-name)
      (with-current-buffer (get-buffer buf-name)
        (let ((inhibit-read-only t)
              (base-url (replace-regexp-in-string "\\(.*/\\)[^/]+\\'" "\\1" url)))
          (goto-char (point-min))
          (unless (re-search-forward prot-common-url-regexp nil t)
            (re-search-forward ".*")
            (replace-match (concat base-url "\\&amp;"))))))))

;;TODO: Add this variable as user-option, that is, define it with
;;`defcustom' so that users can use the customization interface to
;;modify it.

(defvar prot-eww-search-engines
  '((debbugs . (debbugs
                "https://debbugs.gnu.org/cgi/bugreport.cgi?bug="
                hist-var prot-eww--debbugs-hist))
    (wikipedia . (wikipedia
                  "https://en.m.wikipedia.org/w/index.php?search="
                  hist-var prot-eww--wikipedia-hist))
    (archwiki . (archwiki
                 "https://wiki.archlinux.org/index.php?search="
                 hist-var prot-eww--archwiki-hist))
    (aur . (aur "https://aur.archlinux.org/packages/?K="
                hist-var prot-eww--aur-hist)))
  "Alist of Plist of web search engines related data.
From now on refer to this type of data as APLIST.  Each element
of APLIST is (KEY . VALUE) pair.  KEY is a symbol specifying
search engine name.  The VALUE is property list.

The plist has two key-value pairs.  K1 is the same symbol has KEY
and V1 is search string of the search engine.

K2 is the symbol 'hist-var', V2 is also a symbol that has a format
'prot-eww--K1-hist'.

NOTE: If you modify this variable after `prot-eww' is loaded you
need to run the following code after modification:

    (prot-eww--define-hist-var prot-eww-search-engines)")

;; Below 's-string' is short for 'search-string'. For wikipedia which
;; is this string: "https://en.m.wikipedia.org/w/index.php?search=". I
;; use this name because I don't know it's proper name.

;; Define constructor and selectors functions to access
;; `prot-eww-search-engines'.
;; the constructor
(defun prot-eww--cons-search-engines (name s-string)
  "Include a new Alist element.
The alist element is added to variable `prot-eww-search-engines'.

NAME should be symbol representing the search engine.  S-STRING
should be string, which is specific to named search engine."
  (let ((my-plist `(,name ,s-string))
        (hist-var-name (format "prot-eww--%s-hist"
                               (symbol-name name))))
    (plist-put my-plist 'hist-var (intern hist-var-name))
    (let ((my-alist (cons name my-plist)))
      (add-to-list 'prot-eww-search-engines my-alist))))

;; Selectors definitions start
(defun prot-eww--select-hist-name (aplist engine-name)
  "Get hist-var-name from APLIST of ENGINE-NAME."
  (let ((hist-var-name (plist-get
                        (alist-get engine-name aplist)
                        'hist-var)))
    hist-var-name))

(defun prot-eww--select-engine-names (aplist)
  "Return a list of search-engine names from APLIST.
Each value of the list is a string."
  (mapcar (lambda (x) (format "%s" (car x)))
          aplist))

(defun prot-eww--select-s-string (aplist engine-name)
  "Return the search-string for specified ENGINE-NAME from APLIST."
  (plist-get
   (alist-get engine-name aplist)
   engine-name))
;; Selector definitions end here.

(defun prot-eww--define-hist-var (aplist)
  "Initialize APLIST hist-variables to empty list; return nil."
  (let ((engine-names
         (prot-eww--select-engine-names aplist)))
    (dolist (engine engine-names)
      (let ((hist-var-name
             (prot-eww--select-hist-name aplist
                                         (intern engine))))
        (set hist-var-name '())))))

(prot-eww--define-hist-var prot-eww-search-engines)

;;;###autoload
(defun prot-eww-search-engine (engine s-term &amp;optional arg)
  "Search S-TERM using ENGINE.
ENGINE is an assossiation defined in `prot-eww-search-engines'.

With optional prefix ARG (\\[universal-argument]) open the search
result in a new buffer."
  (interactive
   (let* ((engine-list (prot-eww--select-engine-names
                        prot-eww-search-engines))
          (engine-name (completing-read
                        "Search with: " engine-list nil t nil
                        'prot-eww--engine-hist))
          (history-list (prot-eww--select-hist-name
                         prot-eww-search-engines
                         (intern engine-name)))
          (search-term (read-string
                        "Search for: " nil history-list)))
     (list engine-name search-term
           (prefix-numeric-value current-prefix-arg))))
  (let* ((s-string
          (prot-eww--select-s-string prot-eww-search-engines
                                     (intern engine)))
         (eww-pass (format "%s%s" s-string s-term))
         (history-list (prot-eww--select-hist-name
                        prot-eww-search-engines
                        (intern engine))))
    (add-to-history history-list s-term)
    (eww eww-pass arg)))

;;;###autoload
(defun prot-eww-open-in-other-window ()
  "Use `eww-open-in-new-buffer' in another window."
  (interactive)
  (other-window-prefix)       ; For emacs28 -- it's a hack, but why not?
  (eww-open-in-new-buffer))

;;;###autoload
(defun prot-eww-readable ()
  "Use more opinionated `eww-readable'.

Set width is set to `current-fill-column'.  Adjust size of
images."
  (interactive)
  (let ((shr-width (current-fill-column))
        (shr-max-image-proportion 0.35))
    (eww-readable)))

;; NOTE 2021-09-08: This uses the EWW-specific bookmarks, NOT those of
;; bookmark.el.  Further below I provide integration with the latter,
;; meaning that we must either make this obsolete or make it work with
;; the new system.
;;;###autoload
(defun prot-eww-bookmark-page (title)
  "Add eww bookmark named with TITLE."
  (interactive
   (list
    (read-string "Set bookmark title: " (plist-get eww-data :title))))
  (plist-put eww-data :title title)
  (eww-add-bookmark))

(defvar prot-eww--punctuation-regexp "[][{}!@#$%^&amp;*()_=+'\"?,.\|;:~`‘’“”]*"
  "Regular expression of punctionation that should be removed.")

(defun prot-eww--slug-no-punct (str)
  "Convert STR to a file name slug."
  (replace-regexp-in-string prot-eww--punctuation-regexp "" str))

(defun prot-eww--slug-hyphenate (str)
  "Replace spaces with hyphens in STR.
Also replace multiple hyphens with a single one and remove any
trailing hyphen."
  (replace-regexp-in-string
   "-$" ""
   (replace-regexp-in-string
    "-\\{2,\\}" "-"
    (replace-regexp-in-string "--+\\|\s+" "-" str))))

(defun prot-eww--sluggify (str)
  "Make STR an appropriate file name slug."
  (downcase (prot-eww--slug-hyphenate (prot-eww--slug-no-punct str))))

;;;###autoload
(defun prot-eww-download-html (name)
  "Download web page and call the file with NAME."
  (interactive
   (list
    (prot-eww--sluggify
     (read-string "Set downloaded file name: " (plist-get eww-data :title)))))
  (let* ((path (thread-last eww-download-directory
                 (expand-file-name
                  (concat (format-time-string "%Y%m%d_%H%M%S") "--" name ".html"))))
         (out (prot-common-shell-command-with-exit-code-and-output
               "wget" "-q" (format "%s" (plist-get eww-data :url))
               "-O" (format "%s" (shell-quote-argument path)))))
    (if (= (car out) 0)
        (message "Downloaded page at %s" path)
      (message "Error downloading page: %s" (cdr out)))))

(defun prot-eww--kill-buffers-when (predicate)
  "Kill buffers when PREDICATE is non-nil.

Loop through the buffer list, calling PREDICATE with each buffer.
When calling PREDICATE with a buffer returns non-nil, kill that
buffer.

PREDICATE must be function that takes buffer-object as the one
and only argument.  It should return nil or non-nil."
  (let ((list-buffers (buffer-list)))
    (dolist (buffer list-buffers)
      (when (funcall predicate buffer)
        (kill-buffer buffer)))))

(defun prot-eww--kill-eww-buffers-p (buffer)
  "Predicate function.  Return nil or non-nil.

Take BUFFER, make it current, check if it has 'eww-mode' as the
`major-mode' or if its major mode is derived from `special-mode'
and has \"eww\" in the buffer-name. Then return non-nil."
  (let ((case-fold-search t))  ; ignore case
    (with-current-buffer buffer
      (or (eq major-mode 'eww-mode)
          (and (derived-mode-p 'special-mode)
               (string-match "\\*.*eww.*\\*" (buffer-name)))))))

(defun prot-eww-kill-eww-buffers ()
  "Kill all EWW buffers.
Also kill special buffers made by EWW for example buffers like
\"*eww-bookmarks*\", \"*eww-history*\" etc."
  (prot-eww--kill-buffers-when 'prot-eww--kill-eww-buffers-p))

(defcustom prot-eww-delete-cookies t
  "If non-nil delete cookies when `prot-eww-quit' is called."
  :type 'boolean
  :group 'prot-eww)

(defun prot-eww-delete-cookies ()
  "Delete cookies from the cookie file."
  (when prot-eww-delete-cookies
    (url-cookie-delete-cookies)))

;; TODO: Make it defcustom
(defvar prot-eww-quit-hook nil
  "Run this hook when `prot-eww-quit' is called.")

;; Populate the hook with these functions.
(dolist (func '(prot-eww-delete-cookies
                prot-eww-kill-eww-buffers
                prot-eww--save-visited-history))
  (add-hook 'prot-eww-quit-hook func))

;;;###autoload
(defun prot-eww-quit ()
  "Quit eww, kill all its buffers, delete all cookies.
As a final step, save `prot-eww-visited-history' to a file (see
`prot-eww-save-history-file')."
  (interactive)
  (if prot-eww-save-visited-history
      (when (y-or-n-p "Are you sure you want to quit eww? ")
        (run-hooks 'prot-eww-quit-hook))
    ;;
    ;; Now users have full control what `prot-eww-quit' does, by
    ;; modifying `prot-eww-quit-hook'.
    (when (yes-or-no-p "Are you sure you want to quit eww?")
      (run-hooks 'prot-eww-quit-hook))))

(provide 'prot-eww)
;;; prot-eww.el ends here
</pre>
</div>
</div>
</div>
<div id="outline-container-h:92085a6d-213f-400d-be83-763eb80a3877" class="outline-3">
<h3 id="h:92085a6d-213f-400d-be83-763eb80a3877"><span class="section-number-3">6.8.</span> The <code>prot-marginalia.el</code> library</h3>
<div class="outline-text-3" id="text-h:92085a6d-213f-400d-be83-763eb80a3877">
<div class="org-src-container">
<pre class="src src-emacs-lisp">;;; prot-marginalia.el --- Code for my custom mode line -*- lexical-binding: t -*-

;; Copyright (C) 2023-2024  Protesilaos Stavrou

;; Author: Protesilaos Stavrou &lt;info@protesilaos.com&gt;
;; URL: https://protesilaos.com/emacs/dotemacs
;; Version: 0.1.0
;; Package-Requires: ((emacs "30.1"))

;; This file is NOT part of GNU Emacs.

;; This program is free software; you can redistribute it and/or modify
;; it under the terms of the GNU General Public License as published by
;; the Free Software Foundation, either version 3 of the License, or (at
;; your option) any later version.
;;
;; This program is distributed in the hope that it will be useful,
;; but WITHOUT ANY WARRANTY; without even the implied warranty of
;; MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
;; GNU General Public License for more details.
;;
;; You should have received a copy of the GNU General Public License
;; along with this program.  If not, see &lt;https://www.gnu.org/licenses/&gt;.

;;; Commentary:
;;
;; Remember that every piece of Elisp that I write is for my own
;; educational and recreational purposes.  I am not a programmer and I
;; do not recommend that you copy any of this if you are not certain of
;; what it does.

;;; Code:

(require 'bookmark)
(require 'package)

(defun prot-marginalia-truncate (string)
  "Truncate STRING to `fill-column', if necessary."
  (if (&gt; (length string) fill-column)
      (concat (substring string 0 fill-column) "...")
    string))

(defun prot-marginalia-display (string)
  "Propertize the display of STRING for completion annotation purposes."
  (when (stringp string)
    (format "%s%s"
            (propertize " " 'display `(space :align-to 40))
            (propertize (prot-marginalia-truncate string)
                        'face 'completions-annotations))))

(defun prot-marginalia-bookmark (bookmark)
  "Annotate BOOKMARK with its file path."
  (when-let* ((bm (assoc bookmark (bound-and-true-p bookmark-alist)))
              (path (bookmark-get-filename bookmark)))
    (prot-marginalia-display path)))

(defun prot-marginalia-buffer (buffer)
  "Annotate BUFFER with the return value of function `buffer-file-name'."
  (if-let* ((name (buffer-file-name (get-buffer buffer))))
      (prot-marginalia-display (abbreviate-file-name name))
    (prot-marginalia-display (format "%s" (buffer-local-value 'major-mode (get-buffer buffer))))))

(defun prot-marginalia-package (package)
  "Annotate PACKAGE with its summary."
  (when-let* ((pkg-alist (bound-and-true-p package-alist))
              (pkg (intern-soft package))
              (desc (or (when (package-desc-p pkg) pkg)
                        (car (alist-get pkg pkg-alist))
                        (if-let* ((built-in (assq pkg package--builtins)))
                            (package--from-builtin built-in)
                          (car (alist-get pkg package-archive-contents))))))
    (prot-marginalia-display (package-desc-summary desc))))

(defun prot-marginalia--get-symbol-doc (symbol)
  "Return documentation string according to SYMBOL type."
  (cond
   ((or (functionp symbol) (macrop symbol))
    (documentation symbol))
   (t
    (get symbol 'variable-documentation))))

(defun prot-marginalia--first-line-documentation (symbol)
  "Return first line of SYMBOL documentation string."
  (when-let* ((doc-string (prot-marginalia--get-symbol-doc symbol))
              ((stringp doc-string))
              ((not (string-empty-p doc-string))))
    (car (split-string doc-string "[?!.\n]"))))

(defun prot-marginalia-symbol (symbol)
  "Annotate SYMBOL with its documentation string."
  (when-let* ((sym (intern-soft symbol))
              (doc-string (prot-marginalia--first-line-documentation sym)))
    (prot-marginalia-display doc-string)))

(provide 'prot-marginalia)
;;; prot-marginalia.el ends here
</pre>
</div>
</div>
</div>
<div id="outline-container-h:935adc09-abaa-4413-a5ab-a7a562081c20" class="outline-3">
<h3 id="h:935adc09-abaa-4413-a5ab-a7a562081c20"><span class="section-number-3">6.9.</span> The <code>prot-modeline.el</code> library</h3>
<div class="outline-text-3" id="text-h:935adc09-abaa-4413-a5ab-a7a562081c20">
<p>
[ Watch: <a href="https://protesilaos.com/codelog/2023-07-29-emacs-custom-modeline-tutorial/">write a custom mode line</a> (2023-07-29) and <a href="https://protesilaos.com/codelog/2024-01-13-customize-emacs-mode-line/">customise mode line colours</a> (2024-01-13). ]
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">;;; prot-modeline.el --- Code for my custom mode line -*- lexical-binding: t -*-

;; Copyright (C) 2023-2024  Protesilaos Stavrou

;; Author: Protesilaos Stavrou &lt;info@protesilaos.com&gt;
;; URL: https://protesilaos.com/emacs/dotemacs
;; Version: 0.1.0
;; Package-Requires: ((emacs "30.1"))

;; This file is NOT part of GNU Emacs.

;; This program is free software; you can redistribute it and/or modify
;; it under the terms of the GNU General Public License as published by
;; the Free Software Foundation, either version 3 of the License, or (at
;; your option) any later version.
;;
;; This program is distributed in the hope that it will be useful,
;; but WITHOUT ANY WARRANTY; without even the implied warranty of
;; MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
;; GNU General Public License for more details.
;;
;; You should have received a copy of the GNU General Public License
;; along with this program.  If not, see &lt;https://www.gnu.org/licenses/&gt;.

;;; Commentary:
;;
;; Remember that every piece of Elisp that I write is for my own
;; educational and recreational purposes.  I am not a programmer and I
;; do not recommend that you copy any of this if you are not certain of
;; what it does.

;;; Code:

(require 'prot-common)

(defgroup prot-modeline nil
  "Custom modeline that is stylistically close to the default."
  :group 'mode-line)

(defgroup prot-modeline-faces nil
  "Faces for my custom modeline."
  :group 'prot-modeline)

(defcustom prot-modeline-string-truncate-length 9
  "String length after which truncation should be done in small windows."
  :type 'natnum)

;;;; Faces

(defface prot-modeline-indicator-button nil
  "Generic face used for indicators that have a background.
Modify this face to, for example, add a :box attribute to all
relevant indicators (combines nicely with my `spacious-padding'
package).")

(defface prot-modeline-indicator-red
  '((default :inherit bold)
    (((class color) (min-colors 88) (background light))
     :foreground "#880000")
    (((class color) (min-colors 88) (background dark))
     :foreground "#ff9f9f")
    (t :foreground "red"))
  "Face for modeline indicators (e.g. see my `notmuch-indicator')."
  :group 'prot-modeline-faces)

(defface prot-modeline-indicator-red-bg
  '((default :inherit (bold prot-modeline-indicator-button))
    (((class color) (min-colors 88) (background light))
     :background "#aa1111" :foreground "white")
    (((class color) (min-colors 88) (background dark))
     :background "#ff9090" :foreground "black")
    (t :background "red" :foreground "black"))
  "Face for modeline indicators with a background."
  :group 'prot-modeline-faces)

(defface prot-modeline-indicator-green
  '((default :inherit bold)
    (((class color) (min-colors 88) (background light))
     :foreground "#005f00")
    (((class color) (min-colors 88) (background dark))
     :foreground "#73fa7f")
    (t :foreground "green"))
  "Face for modeline indicators (e.g. see my `notmuch-indicator')."
  :group 'prot-modeline-faces)

(defface prot-modeline-indicator-green-bg
  '((default :inherit (bold prot-modeline-indicator-button))
    (((class color) (min-colors 88) (background light))
     :background "#207b20" :foreground "white")
    (((class color) (min-colors 88) (background dark))
     :background "#77d077" :foreground "black")
    (t :background "green" :foreground "black"))
  "Face for modeline indicators with a background."
  :group 'prot-modeline-faces)

(defface prot-modeline-indicator-yellow
  '((default :inherit bold)
    (((class color) (min-colors 88) (background light))
     :foreground "#6f4000")
    (((class color) (min-colors 88) (background dark))
     :foreground "#f0c526")
    (t :foreground "yellow"))
  "Face for modeline indicators (e.g. see my `notmuch-indicator')."
  :group 'prot-modeline-faces)

(defface prot-modeline-indicator-yellow-bg
  '((default :inherit (bold prot-modeline-indicator-button))
    (((class color) (min-colors 88) (background light))
     :background "#805000" :foreground "white")
    (((class color) (min-colors 88) (background dark))
     :background "#ffc800" :foreground "black")
    (t :background "yellow" :foreground "black"))
  "Face for modeline indicators with a background."
  :group 'prot-modeline-faces)

(defface prot-modeline-indicator-blue
  '((default :inherit bold)
    (((class color) (min-colors 88) (background light))
     :foreground "#00228a")
    (((class color) (min-colors 88) (background dark))
     :foreground "#88bfff")
    (t :foreground "blue"))
  "Face for modeline indicators (e.g. see my `notmuch-indicator')."
  :group 'prot-modeline-faces)

(defface prot-modeline-indicator-blue-bg
  '((default :inherit (bold prot-modeline-indicator-button))
    (((class color) (min-colors 88) (background light))
     :background "#0000aa" :foreground "white")
    (((class color) (min-colors 88) (background dark))
     :background "#77aaff" :foreground "black")
    (t :background "blue" :foreground "black"))
  "Face for modeline indicators with a background."
  :group 'prot-modeline-faces)

(defface prot-modeline-indicator-magenta
  '((default :inherit bold)
    (((class color) (min-colors 88) (background light))
     :foreground "#6a1aaf")
    (((class color) (min-colors 88) (background dark))
     :foreground "#e0a0ff")
    (t :foreground "magenta"))
  "Face for modeline indicators (e.g. see my `notmuch-indicator')."
  :group 'prot-modeline-faces)

(defface prot-modeline-indicator-magenta-bg
  '((default :inherit (bold prot-modeline-indicator-button))
    (((class color) (min-colors 88) (background light))
     :background "#6f0f9f" :foreground "white")
    (((class color) (min-colors 88) (background dark))
     :background "#e3a2ff" :foreground "black")
    (t :background "magenta" :foreground "black"))
  "Face for modeline indicators with a background."
  :group 'prot-modeline-faces)

(defface prot-modeline-indicator-cyan
  '((default :inherit bold)
    (((class color) (min-colors 88) (background light))
     :foreground "#004060")
    (((class color) (min-colors 88) (background dark))
     :foreground "#30b7cc")
    (t :foreground "cyan"))
  "Face for modeline indicators (e.g. see my `notmuch-indicator')."
  :group 'prot-modeline-faces)

(defface prot-modeline-indicator-cyan-bg
  '((default :inherit (bold prot-modeline-indicator-button))
    (((class color) (min-colors 88) (background light))
     :background "#006080" :foreground "white")
    (((class color) (min-colors 88) (background dark))
     :background "#40c0e0" :foreground "black")
    (t :background "cyan" :foreground "black"))
  "Face for modeline indicators with a background."
  :group 'prot-modeline-faces)

(defface prot-modeline-indicator-gray
  '((t :inherit shadow))
  "Face for modeline indicators (e.g. see my `notmuch-indicator')."
  :group 'prot-modeline-faces)

(defface prot-modeline-indicator-gray-bg
  '((default :inherit (bold prot-modeline-indicator-button))
    (((class color) (min-colors 88) (background light))
     :background "#808080" :foreground "white")
    (((class color) (min-colors 88) (background dark))
     :background "#a0a0a0" :foreground "black")
    (t :inverse-video t))
  "Face for modeline indicatovrs with a background."
  :group 'prot-modeline-faces)

;;;; Common helper functions

(defun prot-modeline--string-truncate-p (str)
  "Return non-nil if STR should be truncated."
  (cond
   ((or (not (stringp str))
        (string-empty-p str)
        (string-blank-p str))
    nil)
   ((and (prot-common-window-narrow-p)
         (&gt; (length str) prot-modeline-string-truncate-length)
         (not (one-window-p :no-minibuffer))))))

(defun prot-modeline--truncate-p ()
  "Return non-nil if truncation should happen.
This is a more general and less stringent variant of
`prot-modeline--string-truncate-p'."
  (and (prot-common-window-narrow-p)
       (not (one-window-p :no-minibuffer))))

(defun prot-modeline-string-cut-end (str)
  "Return truncated STR, if appropriate, else return STR.
Cut off the end of STR by counting from its start up to
`prot-modeline-string-truncate-length'."
  (if (prot-modeline--string-truncate-p str)
      (concat (substring str 0 prot-modeline-string-truncate-length) "...")
    str))

(defun prot-modeline-string-cut-beginning (str)
  "Return truncated STR, if appropriate, else return STR.
Cut off the beginning of STR by counting from its end up to
`prot-modeline-string-truncate-length'."
  (if (prot-modeline--string-truncate-p str)
      (concat "..." (substring str (- prot-modeline-string-truncate-length)))
    str))

(defun prot-modeline-string-cut-middle (str)
  "Return truncated STR, if appropriate, else return STR.
Cut off the middle of STR by counting half of
`prot-modeline-string-truncate-length' both from its beginning
and end."
  (let ((half (floor prot-modeline-string-truncate-length 2)))
    (if (prot-modeline--string-truncate-p str)
        (concat (substring str 0 half) "..." (substring str (- half)))
      str)))

(defun prot-modeline--first-char (str)
  "Return first character from STR."
  (substring str 0 1))

(defun prot-modeline-string-abbreviate (str)
  "Abbreviate STR individual hyphen or underscore separated words.
Also see `prot-modeline-string-abbreviate-but-last'."
  (if (prot-modeline--string-truncate-p str)
      (mapconcat #'prot-modeline--first-char (split-string str "[_-]") "-")
    str))

(defun prot-modeline-string-abbreviate-but-last (str nthlast)
  "Abbreviate STR, keeping NTHLAST words intact.
Also see `prot-modeline-string-abbreviate'."
  (if (prot-modeline--string-truncate-p str)
      (let* ((all-strings (split-string str "[_-]"))
             (nbutlast-strings (nbutlast (copy-sequence all-strings) nthlast))
             (last-strings (nreverse (ntake nthlast (nreverse (copy-sequence all-strings)))))
             (first-component (mapconcat #'prot-modeline--first-char nbutlast-strings "-"))
             (last-component (mapconcat #'identity last-strings "-")))
        (if (string-empty-p first-component)
            last-component
          (concat first-component "-" last-component)))
    str))

;;;; Keyboard macro indicator

(defvar-local prot-modeline-kbd-macro
    '(:eval
      (when (and (mode-line-window-selected-p) defining-kbd-macro)
        (propertize " KMacro " 'face 'prot-modeline-indicator-blue-bg)))
  "Mode line construct displaying `mode-line-defining-kbd-macro'.
Specific to the current window's mode line.")

;;;; Narrow indicator

(defvar-local prot-modeline-narrow
    '(:eval
      (when (and (mode-line-window-selected-p)
                 (buffer-narrowed-p)
                 (not (derived-mode-p 'Info-mode 'help-mode 'special-mode 'message-mode)))
        (propertize " Narrow " 'face 'prot-modeline-indicator-cyan-bg)))
  "Mode line construct to report the narrowed state of the current buffer.")

;;;; Input method

(defvar-local prot-modeline-input-method
    '(:eval
      (when current-input-method-title
        (propertize (format " %s " current-input-method-title)
                    'face 'prot-modeline-indicator-green-bg
                    'mouse-face 'mode-line-highlight)))
  "Mode line construct to report the multilingual environment.")

;;;; Buffer status

;; TODO 2023-07-05: What else is there beside remote files?  If
;; nothing, this must be renamed accordingly.
(defvar-local prot-modeline-buffer-status
    '(:eval
      (when (file-remote-p default-directory)
        (propertize " @ "
                    'face 'prot-modeline-indicator-red-bg
                    'mouse-face 'mode-line-highlight)))
  "Mode line construct for showing remote file name.")

;;;; Dedicated window

(defvar-local prot-modeline-window-dedicated-status
    '(:eval
      (when (window-dedicated-p)
        (propertize " = "
                    'face 'prot-modeline-indicator-gray-bg
                    'mouse-face 'mode-line-highlight)))
  "Mode line construct for dedicated window indicator.")

;;;; Buffer name and modified status

(defun prot-modeline-buffer-identification-face ()
  "Return appropriate face or face list for `prot-modeline-buffer-identification'."
  (let ((file (buffer-file-name)))
    (cond
     ((and (mode-line-window-selected-p)
           file
           (buffer-modified-p))
      '(italic mode-line-buffer-id))
     ((and file (buffer-modified-p))
      'italic)
     ((mode-line-window-selected-p)
      'mode-line-buffer-id))))

(defun prot-modeline--buffer-name ()
  "Return `buffer-name', truncating it if necessary.
See `prot-modeline-string-cut-middle'."
  (when-let* ((name (buffer-name)))
    (prot-modeline-string-cut-middle name)))

(defun prot-modeline-buffer-name ()
  "Return buffer name, with read-only indicator if relevant."
  (let ((name (prot-modeline--buffer-name)))
    (if buffer-read-only
        (format "%s %s" (char-to-string #xE0A2) name)
      name)))

(defun prot-modeline-buffer-name-help-echo ()
  "Return `help-echo' value for `prot-modeline-buffer-identification'."
  (concat
   (propertize (buffer-name) 'face 'mode-line-buffer-id)
   "\n"
   (propertize
    (or (buffer-file-name)
        (format "No underlying file.\nDirectory is: %s" default-directory))
    'face 'font-lock-doc-face)))

(defvar-local prot-modeline-buffer-identification
    '(:eval
      (propertize (prot-modeline-buffer-name)
                  'face (prot-modeline-buffer-identification-face)
                  'mouse-face 'mode-line-highlight
                  'help-echo (prot-modeline-buffer-name-help-echo)))
  "Mode line construct for identifying the buffer being displayed.
Propertize the current buffer with the `mode-line-buffer-id'
face.  Let other buffers have no face.")

;;;; Major mode

(defun prot-modeline-major-mode-indicator ()
  "Return appropriate propertized mode line indicator for the major mode."
  (let ((indicator (cond
                    ((derived-mode-p 'text-mode) "§")
                    ((derived-mode-p 'prog-mode) "λ")
                    ((derived-mode-p 'comint-mode) "&gt;_")
                    (t "◦"))))
    (propertize indicator 'face 'shadow)))

(defun prot-modeline-major-mode-name ()
  "Return capitalized `major-mode' without the -mode suffix."
  (capitalize (string-replace "-mode" "" (symbol-name major-mode))))

(defun prot-modeline-major-mode-help-echo ()
  "Return `help-echo' value for `prot-modeline-major-mode'."
  (if-let* ((parent (get major-mode 'derived-mode-parent)))
      (format "Symbol: `%s'.  Derived from: `%s'" major-mode parent)
    (format "Symbol: `%s'." major-mode)))

(defvar-local prot-modeline-major-mode
    (list
     (propertize "%[" 'face 'prot-modeline-indicator-red)
     '(:eval
       (concat
        (prot-modeline-major-mode-indicator)
        " "
        (propertize
         (prot-modeline-string-abbreviate-but-last
          (prot-modeline-major-mode-name)
          2)
         'mouse-face 'mode-line-highlight
         'help-echo (prot-modeline-major-mode-help-echo))))
     (propertize "%]" 'face 'prot-modeline-indicator-red))
  "Mode line construct for displaying major modes.")

(defvar-local prot-modeline-process
    (list '("" mode-line-process))
  "Mode line construct for the running process indicator.")

;;;; Git branch and diffstat

(declare-function vc-git--symbolic-ref "vc-git" (file))

(defun prot-modeline--vc-branch-name (file backend)
  "Return capitalized VC branch name for FILE with BACKEND."
  (when-let* ((rev (vc-working-revision file backend))
              (branch (or (vc-git--symbolic-ref file)
                          (substring rev 0 7))))
    (capitalize branch)))

;; NOTE 2023-07-27: This is a good idea, but it hardcodes Git, whereas
;; I want a generic VC method.  Granted, I only use Git but I still
;; want it to work as a VC extension.

;; (defun prot-modeline-diffstat (file)
;;   "Return shortened Git diff numstat for FILE."
;;   (when-let* ((output (shell-command-to-string (format "git diff --numstat %s" file)))
;;               (stats (split-string output "[\s\t]" :omit-nulls "[\s\f\t\n\r\v]+"))
;;               (added (nth 0 stats))
;;               (deleted (nth 1 stats)))
;;     (cond
;;      ((and (equal added "0") (equal deleted "0"))
;;       "")
;;      ((and (not (equal added "0")) (equal deleted "0"))
;;       (propertize (format "+%s" added) 'face 'shadow))
;;      ((and (equal added "0") (not (equal deleted "0")))
;;       (propertize (format "-%s" deleted) 'face 'shadow))
;;      (t
;;       (propertize (format "+%s -%s" added deleted) 'face 'shadow)))))

(declare-function vc-git-working-revision "vc-git" (file))

(defvar prot-modeline-vc-map
  (let ((map (make-sparse-keymap)))
    (define-key map [mode-line down-mouse-1] 'vc-diff)
    (define-key map [mode-line down-mouse-3] 'vc-root-diff)
    map)
  "Keymap to display on VC indicator.")

(defun prot-modeline--vc-help-echo (file)
  "Return `help-echo' message for FILE tracked by VC."
  (format "Revision: %s\nmouse-1: `vc-diff'\nmouse-3: `vc-root-diff'"
          (vc-working-revision file)))

(defun prot-modeline--vc-text (file branch &amp;optional face)
  "Prepare text for Git controlled FILE, given BRANCH.
With optional FACE, use it to propertize the BRANCH."
  (concat
   (propertize (char-to-string #xE0A0) 'face 'shadow)
   " "
   (propertize branch
               'face face
               'mouse-face 'mode-line-highlight
               'help-echo (prot-modeline--vc-help-echo file)
               'local-map prot-modeline-vc-map)
   ;; " "
   ;; (prot-modeline-diffstat file)
   ))

(defun prot-modeline--vc-details (file branch &amp;optional face)
  "Return Git BRANCH details for FILE, truncating it if necessary.
The string is truncated if the width of the window is smaller
than `split-width-threshold'."
  (prot-modeline-string-cut-end
   (prot-modeline--vc-text file branch face)))

(defvar prot-modeline--vc-faces
  '((added . vc-locally-added-state)
    (edited . vc-edited-state)
    (removed . vc-removed-state)
    (missing . vc-missing-state)
    (conflict . vc-conflict-state)
    (locked . vc-locked-state)
    (up-to-date . vc-up-to-date-state))
  "VC state faces.")

(defun prot-modeline--vc-get-face (key)
  "Get face from KEY in `prot-modeline--vc-faces'."
  (alist-get key prot-modeline--vc-faces 'up-to-date))

(defun prot-modeline--vc-face (file backend)
  "Return VC state face for FILE with BACKEND."
  (prot-modeline--vc-get-face (vc-state file backend)))

(defvar-local prot-modeline-vc-branch
    '(:eval
      (when-let* (((mode-line-window-selected-p))
                  (file (buffer-file-name))
                  (backend (vc-backend file))
                  ;; ((vc-git-registered file))
                  (branch (prot-modeline--vc-branch-name file backend))
                  (face (prot-modeline--vc-face file backend)))
        (prot-modeline--vc-details file branch face)))
  "Mode line construct to return propertized VC branch.")

;;;; Flymake errors, warnings, notes

(declare-function flymake--severity "flymake" (type))
(declare-function flymake-diagnostic-type "flymake" (diag))

;; Based on `flymake--mode-line-counter'.
(defun prot-modeline-flymake-counter (type)
  "Compute number of diagnostics in buffer with TYPE's severity.
TYPE is usually keyword `:error', `:warning' or `:note'."
  (let ((count 0))
    (dolist (d (flymake-diagnostics))
      (when (= (flymake--severity type)
               (flymake--severity (flymake-diagnostic-type d)))
        (cl-incf count)))
    (when (cl-plusp count)
      (number-to-string count))))

(defvar prot-modeline-flymake-map
  (let ((map (make-sparse-keymap)))
    (define-key map [mode-line down-mouse-1] 'flymake-show-buffer-diagnostics)
    (define-key map [mode-line down-mouse-3] 'flymake-show-project-diagnostics)
    map)
  "Keymap to display on Flymake indicator.")

(defmacro prot-modeline-flymake-type (type indicator &amp;optional face)
  "Return function that handles Flymake TYPE with stylistic INDICATOR and FACE."
  `(defun ,(intern (format "prot-modeline-flymake-%s" type)) ()
     (when-let* ((count (prot-modeline-flymake-counter
                         ,(intern (format ":%s" type)))))
       (concat
        (propertize ,indicator 'face 'shadow)
        (propertize count
                    'face ',(or face type)
                    'mouse-face 'mode-line-highlight
                    ;; FIXME 2023-07-03: Clicking on the text with
                    ;; this buffer and a single warning present, the
                    ;; diagnostics take up the entire frame.  Why?
                    'local-map prot-modeline-flymake-map
                    'help-echo "mouse-1: buffer diagnostics\nmouse-3: project diagnostics")))))

(prot-modeline-flymake-type error "☣")
(prot-modeline-flymake-type warning "!")
(prot-modeline-flymake-type note "·" success)

(defvar-local prot-modeline-flymake
    `(:eval
      (when (and (bound-and-true-p flymake-mode)
                 (mode-line-window-selected-p))
        (list
         ;; See the calls to the macro `prot-modeline-flymake-type'
         '(:eval (prot-modeline-flymake-error))
         '(:eval (prot-modeline-flymake-warning))
         '(:eval (prot-modeline-flymake-note)))))
  "Mode line construct displaying `flymake-mode-line-format'.
Specific to the current window's mode line.")

;;;; Eglot

(with-eval-after-load 'eglot
  (setq mode-line-misc-info
        (delete '(eglot--managed-mode (" [" eglot--mode-line-format "] ")) mode-line-misc-info)))

(defvar-local prot-modeline-eglot
    `(:eval
      (when (and (featurep 'eglot) (mode-line-window-selected-p))
        '(eglot--managed-mode eglot--mode-line-format)))
  "Mode line construct displaying Eglot information.
Specific to the current window's mode line.")

;;;; Miscellaneous

(defvar-local prot-modeline-notmuch-indicator
    '(notmuch-indicator-mode
      (" "
       (:eval (when (mode-line-window-selected-p)
                notmuch-indicator--counters))))
  "The equivalent of `notmuch-indicator-mode-line-construct'.
Display the indicator only on the focused window's mode line.")

(defvar-local prot-modeline-misc-info
    '(:eval
      (when (mode-line-window-selected-p)
        mode-line-misc-info))
  "Mode line construct displaying `mode-line-misc-info'.
Specific to the current window's mode line.")

;;;; Risky local variables

;; NOTE 2023-04-28: The `risky-local-variable' is critical, as those
;; variables will not work without it.
(dolist (construct '(prot-modeline-kbd-macro
                     prot-modeline-narrow
                     prot-modeline-input-method
                     prot-modeline-buffer-status
                     prot-modeline-window-dedicated-status
                     prot-modeline-buffer-identification
                     prot-modeline-major-mode
                     prot-modeline-process
                     prot-modeline-vc-branch
                     prot-modeline-flymake
                     prot-modeline-eglot
                     ;; prot-modeline-align-right
                     prot-modeline-notmuch-indicator
                     prot-modeline-misc-info))
  (put construct 'risky-local-variable t))

(provide 'prot-modeline)
;;; prot-modeline.el ends here
</pre>
</div>
</div>
</div>
<div id="outline-container-h:92ee86b8-0ead-4080-963f-3fbc9f931e3e" class="outline-3">
<h3 id="h:92ee86b8-0ead-4080-963f-3fbc9f931e3e"><span class="section-number-3">6.10.</span> The <code>prot-notmuch.el</code> library</h3>
<div class="outline-text-3" id="text-h:92ee86b8-0ead-4080-963f-3fbc9f931e3e">
<div class="org-src-container">
<pre class="src src-emacs-lisp">;;; prot-notmuch.el --- Tweaks for my notmuch.el configurations -*- lexical-binding: t -*-

;; Copyright (C) 2021-2024  Protesilaos Stavrou

;; Author: Protesilaos Stavrou &lt;info@protesilaos.com&gt;
;; URL: https://protesilaos.com/emacs/dotemacs
;; Version: 0.1.0
;; Package-Requires: ((emacs "30.1"))

;; This file is NOT part of GNU Emacs.

;; This program is free software; you can redistribute it and/or modify
;; it under the terms of the GNU General Public License as published by
;; the Free Software Foundation, either version 3 of the License, or
;; (at your option) any later version.
;;
;; This program is distributed in the hope that it will be useful,
;; but WITHOUT ANY WARRANTY; without even the implied warranty of
;; MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
;; GNU General Public License for more details.
;;
;; You should have received a copy of the GNU General Public License
;; along with this program.  If not, see &lt;https://www.gnu.org/licenses/&gt;.

;;; Commentary:
;;
;; This covers my tweaks for notmuch.el that are meant for use in my
;; Emacs setup: https://protesilaos.com/emacs/dotemacs.
;;
;; Remember that every piece of Elisp that I write is for my own
;; educational and recreational purposes.  I am not a programmer and I
;; do not recommend that you copy any of this if you are not certain of
;; what it does.

;;; Code:

(require 'prot-common)
(eval-when-compile (require 'cl-lib))

(defgroup prot-notmuch ()
  "Extensions for notmuch.el."
  :group 'notmuch)

(defcustom prot-notmuch-delete-tag "del"
  "Single tag that applies to mail marked for deletion.
This is used by `prot-notmuch-delete-mail'."
  :type 'string
  :group 'prot-notmuch)

(defcustom prot-notmuch-mark-delete-tags
  `(,(format "+%s" prot-notmuch-delete-tag) "-inbox" "-unread")
  "List of tags to mark for deletion.
To actually delete email, refer to `prot-notmuch-delete-mail'."
  :type '(repeat string)
  :group 'prot-notmuch)

(defcustom prot-notmuch-mark-flag-tags '("+flag" "-unread")
  "List of tags to mark as important (flagged).
This gets the `notmuch-tag-flagged' face, if that is specified in
`notmuch-tag-formats'."
  :type '(repeat string)
  :group 'prot-notmuch)

(defcustom prot-notmuch-mark-spam-tags '("+spam" "-inbox" "-unread")
  "List of tags to mark as spam."
  :type '(repeat string)
  :group 'prot-notmuch)

;;;; Commands

(autoload 'notmuch-interactive-region "notmuch")
(autoload 'notmuch-tag-change-list "notmuch")
(autoload 'notmuch-search-next-thread "notmuch")
(autoload 'notmuch-search-tag "notmuch")

(defmacro prot-notmuch-search-tag-thread (name tags)
  "Produce NAME function parsing TAGS."
  (declare (indent defun))
  `(defun ,name (&amp;optional untag beg end)
     ,(format
       "Mark with `%s' the currently selected thread.

Operate on each message in the currently selected thread.  With
optional BEG and END as points delimiting a region that
encompasses multiple threads, operate on all those messages
instead.

With optional prefix argument (\\[universal-argument]) as UNTAG,
reverse the application of the tags.

This function advances to the next thread when finished."
       tags)
     (interactive (cons current-prefix-arg (notmuch-interactive-region)))
     (when ,tags
       (notmuch-search-tag
        (notmuch-tag-change-list ,tags untag) beg end))
     (when (eq beg end)
       (notmuch-search-next-thread))))

(prot-notmuch-search-tag-thread
  prot-notmuch-search-delete-thread
  prot-notmuch-mark-delete-tags)

(prot-notmuch-search-tag-thread
  prot-notmuch-search-flag-thread
  prot-notmuch-mark-flag-tags)

(prot-notmuch-search-tag-thread
  prot-notmuch-search-spam-thread
  prot-notmuch-mark-spam-tags)

(defmacro prot-notmuch-show-tag-message (name tags)
  "Produce NAME function parsing TAGS."
  (declare (indent defun))
  `(defun ,name (&amp;optional untag)
     ,(format
       "Apply `%s' to message.

With optional prefix argument (\\[universal-argument]) as UNTAG,
reverse the application of the tags."
       tags)
     (interactive "P")
     (when ,tags
       (apply 'notmuch-show-tag-message
	          (notmuch-tag-change-list ,tags untag)))))

(prot-notmuch-show-tag-message
  prot-notmuch-show-delete-message
  prot-notmuch-mark-delete-tags)

(prot-notmuch-show-tag-message
  prot-notmuch-show-flag-message
  prot-notmuch-mark-flag-tags)

(prot-notmuch-show-tag-message
  prot-notmuch-show-spam-message
  prot-notmuch-mark-spam-tags)

(autoload 'notmuch-refresh-this-buffer "notmuch")
(autoload 'notmuch-refresh-all-buffers "notmuch")

(defun prot-notmuch-refresh-buffer (&amp;optional arg)
  "Run `notmuch-refresh-this-buffer'.
With optional prefix ARG (\\[universal-argument]) call
`notmuch-refresh-all-buffers'."
  (interactive "P")
  (if arg
      (notmuch-refresh-all-buffers)
    (notmuch-refresh-this-buffer)))

;;;###autoload
(defun prot-notmuch-delete-mail ()
  "Permanently delete mail marked as `prot-notmuch-delete-mail'.
Prompt for confirmation before carrying out the operation.

Do not attempt to refresh the index.  This will be done upon the
next invocation of 'notmuch new'."
  (interactive)
  (let* ((del-tag prot-notmuch-delete-tag)
         (count
          (string-to-number
           (with-temp-buffer
             (shell-command
              (format "notmuch count tag:%s" prot-notmuch-delete-tag) t)
             (buffer-substring-no-properties (point-min) (1- (point-max))))))
         (mail (if (&gt; count 1) "mails" "mail")))
    (unless (&gt; count 0)
      (user-error "No mail marked as `%s'" del-tag))
    (when (yes-or-no-p
           (format "Delete %d %s marked as `%s'?" count mail del-tag))
      (shell-command
       (format "notmuch search --output=files --format=text0 tag:%s | xargs -r0 rm" del-tag)
       t))))

;;;; SourceHut-related setup

(defconst prot-notmuch-patch-control-codes
  '("PROPOSED" "NEEDS_REVISION" "SUPERSEDED" "APPROVED" "REJECTED" "APPLIED")
  "Control codes for SourceHut patches.
See `prot-notmuch-patch-add-email-control-code' for how to apply
them.")

(defun prot-notmuch--rx-in-sourcehut-mail (rx-group string)
  "Return RX-GROUP of SourceHut mail in STRING."
  (when (string-match-p "lists\\.sr\\.ht" string)
    (string-clean-whitespace
     (replace-regexp-in-string
      ".*?[&lt;]?\\(\\([-a-zA-Z0-9=._+~/]+\\)@\\(lists\\.sr\\.ht\\)\\)[&gt;]?.*?"
      (format "\\%s" rx-group) string))))

(declare-function notmuch-show-get-header "notmuch-show" (header &amp;optional props))
(declare-function message-fetch-field "message" (header &amp;optional first))

(defun prot-notmuch--get-to-or-cc-header ()
  "Get appropriate To or Cc header."
  (cond
   ((derived-mode-p 'notmuch-message-mode)
    (concat (message-fetch-field "To") " " (message-fetch-field "Cc")))
   ((derived-mode-p 'notmuch-show-mode)
    (concat (notmuch-show-get-header :To) " " (notmuch-show-get-header :Cc)))))

;; NOTE 2022-04-19: This assumes that we only have one list...  I think
;; that is okay, but it might cause problems.
(defun prot-notmuch--extract-sourcehut-mail (rx-group)
  "Extract RX-GROUP from SourceHut mailing list address.
1 is the full email address, 2 is the local part, while 3 is the
domain."
  (prot-notmuch--rx-in-sourcehut-mail
   rx-group (prot-notmuch--get-to-or-cc-header)))

(declare-function message-add-header "message" (&amp;rest headers))

;; Read: &lt;https://man.sr.ht/lists.sr.ht/#email-controls&gt;.
;;;###autoload
(defun prot-notmuch-patch-add-email-control-code (control-code)
  "Add custom header for SourceHut email controls.
The CONTROL-CODE is among `prot-notmuch-patch-control-codes'."
  (interactive
   (list (completing-read "Select control code: " prot-notmuch-patch-control-codes nil t)))
  (if (member control-code prot-notmuch-patch-control-codes)
    (unless (message-fetch-field "X-Sourcehut-Patchset-Update")
      (message-add-header (format "X-Sourcehut-Patchset-Update: %s" control-code)))
    (user-error "%s is not specified in `prot-notmuch-patch-control-codes'" control-code)))

;;;###autoload
(defun prot-notmuch-ask-sourcehut-control-code ()
  "Use `prot-notmuch-patch-add-email-control-code' programmatically.
Add this to `notmuch-mua-send-hook'."
  (when-let* ((header (message-fetch-field "Subject"))
              (subject (when (&gt;= (length header) 6) (substring header 0 6)))
              ((string= "[PATCH" subject)) ; Is [ always there?
              ((prot-notmuch--extract-sourcehut-mail 1))
              ((not (message-fetch-field "X-Sourcehut-Patchset-Update")))
              ((y-or-n-p "Add control code for SourceHut PATCH?")))
    (call-interactively #'prot-notmuch-patch-add-email-control-code)))

;; NOTE 2022-04-19: Ideally we should be able to use the
;; `notmuch-show-stash-mlarchive-link-alist' for
;; `prot-notmuch-stash-sourcehut-link', but it assumes that the base URL
;; is fixed for all message IDs, whereas those on SourceHut are not.

(declare-function notmuch-show-get-message-id "notmuch-show" (&amp;optional bare))
(declare-function notmuch-show-message-top "notmuch-show")
(declare-function notmuch-common-do-stash "notmuch-lib" (text))

;;;###autoload
(defun prot-notmuch-stash-sourcehut-link (&amp;optional current)
  "Stash web link to current SourceHut thread.
With optional CURRENT argument, produce a link to the current
message, else use the topmost message (start of the thread).

Note that the topmost message is assumed to hold the id of the
base URL, though this is not necessarily true."
  (interactive "P")
  (let* ((ml (prot-notmuch--extract-sourcehut-mail 2))
         (base-id (save-excursion (goto-char (point-min))
                                  (notmuch-show-message-top)
                                  (notmuch-show-get-message-id t)))
         (current-id (notmuch-show-get-message-id t)))
    (notmuch-common-do-stash
     (if current
         (format "https://lists.sr.ht/%s/&lt;%s&gt;#&lt;%s&gt;" ml base-id current-id)
       (format "https://lists.sr.ht/%s/&lt;%s&gt;" ml base-id)))))

;;;###autoload
(defun prot-notmuch-check-valid-sourcehut-email ()
  "Check if SourceHut address is correct.
Add this to `notmuch-mua-send-hook'."
  (when-let* ((ml (prot-notmuch--extract-sourcehut-mail 1))
              ((not (string-match-p "^\\(~\\|\\.\\)" ml)))
              ((not (y-or-n-p "SourceHut address looks wrong.  Send anyway?"))))
    (user-error "Incorrect SourceHut address")))

(provide 'prot-notmuch)
;;; prot-notmuch.el ends here
</pre>
</div>
</div>
</div>
<div id="outline-container-h:114c6e8c-697a-43e9-8fd9-52872997e1c9" class="outline-3">
<h3 id="h:114c6e8c-697a-43e9-8fd9-52872997e1c9"><span class="section-number-3">6.11.</span> The <code>prot-orderless.el</code> library</h3>
<div class="outline-text-3" id="text-h:114c6e8c-697a-43e9-8fd9-52872997e1c9">
<div class="org-src-container">
<pre class="src src-emacs-lisp">;;; prot-orderless.el --- Extensions for Orderless -*- lexical-binding: t -*-

;; Copyright (C) 2020-2024  Protesilaos Stavrou

;; Author: Protesilaos Stavrou &lt;info@protesilaos.com&gt;
;; URL: https://protesilaos.com/emacs/dotemacs
;; Version: 0.1.0
;; Package-Requires: ((emacs "30.1"))

;; This file is NOT part of GNU Emacs.

;; This program is free software; you can redistribute it and/or modify
;; it under the terms of the GNU General Public License as published by
;; the Free Software Foundation, either version 3 of the License, or (at
;; your option) any later version.
;;
;; This program is distributed in the hope that it will be useful,
;; but WITHOUT ANY WARRANTY; without even the implied warranty of
;; MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
;; GNU General Public License for more details.
;;
;; You should have received a copy of the GNU General Public License
;; along with this program.  If not, see &lt;https://www.gnu.org/licenses/&gt;.

;;; Commentary:
;;
;; Extensions for the Orderless completion style for use in my Emacs
;; setup: &lt;https://protesilaos.com/emacs/dotemacs/&gt;.
;;
;; Remember that every piece of Elisp that I write is for my own
;; educational and recreational purposes.  I am not a programmer and I
;; do not recommend that you copy any of this if you are not certain of
;; what it does.

;;; Code:

;;;; Style dispatchers

(defun prot-orderless-literal (word _index _total)
  "Read WORD= as a literal string."
  (when (string-suffix-p "=" word)
    ;; The `orderless-literal' is how this should be treated by
    ;; orderless.  The `substring' form omits the `=' from the
    ;; pattern.
    `(orderless-literal . ,(substring word 0 -1))))

(defun prot-orderless-file-ext (word _index _total)
  "Expand WORD. to a file suffix when completing file names."
  (when (and minibuffer-completing-file-name
             (string-suffix-p "." word))
    `(orderless-regexp . ,(format "\\.%s\\'" (substring word 0 -1)))))

(defun prot-orderless-beg-or-end (word _index _total)
  "Expand WORD~ to \\(^WORD\\|WORD$\\)."
  (when-let* (((string-suffix-p "~" word))
              (word (substring word 0 -1)))
    `(orderless-regexp . ,(format "\\(^%s\\|%s$\\)" word word))))

(provide 'prot-orderless)
;;; prot-orderless.el ends here
</pre>
</div>
</div>
</div>
<div id="outline-container-h:9974eac8-2167-45c4-90e0-12dd877403da" class="outline-3">
<h3 id="h:9974eac8-2167-45c4-90e0-12dd877403da"><span class="section-number-3">6.12.</span> The <code>prot-org.el</code> library</h3>
<div class="outline-text-3" id="text-h:9974eac8-2167-45c4-90e0-12dd877403da">
<div class="org-src-container">
<pre class="src src-emacs-lisp">;;; prot-org.el --- Tweaks for my org-mode configurations -*- lexical-binding: t -*-

;; Copyright (C) 2021-2024  Protesilaos Stavrou

;; Author: Protesilaos Stavrou &lt;info@protesilaos.com&gt;
;; URL: https://protesilaos.com/emacs/dotemacs
;; Version: 0.1.0
;; Package-Requires: ((emacs "30.1"))

;; This file is NOT part of GNU Emacs.

;; This program is free software; you can redistribute it and/or modify
;; it under the terms of the GNU General Public License as published by
;; the Free Software Foundation, either version 3 of the License, or
;; (at your option) any later version.
;;
;; This program is distributed in the hope that it will be useful,
;; but WITHOUT ANY WARRANTY; without even the implied warranty of
;; MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
;; GNU General Public License for more details.
;;
;; You should have received a copy of the GNU General Public License
;; along with this program.  If not, see &lt;https://www.gnu.org/licenses/&gt;.

;;; Commentary:
;;
;; This covers my tweaks for Org that are meant for use in my
;; Emacs setup: https://protesilaos.com/emacs/dotemacs.
;;
;; Remember that every piece of Elisp that I write is for my own
;; educational and recreational purposes.  I am not a programmer and I
;; do not recommend that you copy any of this if you are not certain of
;; what it does.

;;; Code:

(require 'prot-common)
(require 'org)

(defgroup prot-org ()
  "Extensions for org.el."
  :group 'org)

;;;; org-capture

(defvar prot-org--capture-coach-person-history nil)

(declare-function message-fetch-field "message" (header &amp;optional first))
(declare-function notmuch-show-get-header "notmuch-show")

(defun prot-org--capture-coach-person-message-from ()
  "Return default value for `prot-org--capture-coach-person-prompt'."
  (when-let* ((from (cond
                     ((derived-mode-p 'message-mode)
                      (message-fetch-field "To"))
                     ((derived-mode-p 'notmuch-show-mode)
                      (notmuch-show-get-header :From)))))
    (string-clean-whitespace (car (split-string from "&lt;")))))

(defun prot-org--capture-coach-person-message-from-and-subject ()
  "Return default value for `prot-org--capture-coach-person-prompt'."
  (cond
   ((derived-mode-p 'message-mode)
    (message-fetch-field "Subject"))
   ((derived-mode-p 'notmuch-show-mode)
    (notmuch-show-get-header :Subject))))

(defun prot-org--capture-coach-person-prompt ()
  "Prompt for person for use in `prot-org-capture-coach'."
  (completing-read "Person to coach: "
                   prot-org--capture-coach-person-history
                   nil nil nil
                   'prot-org--capture-coach-person-history
                   (prot-org--capture-coach-person-message-from)))

(defvar prot-org--capture-coach-description-history nil)

(defun prot-org--capture-coach-description-prompt ()
  "Prompt for description in `prot-org-capture-coach'."
  (read-string "Description: "
               nil
               'prot-org--capture-coach-description-history
               (prot-org--capture-coach-person-message-from-and-subject)))

(defun prot-org--capture-coach-date-prompt-range ()
  "Prompt for Org date and return it as a +1h range.
For use in `prot-org-capture-coach'."
  (let ((date (org-read-date :with-time)))
    ;; We cannot use this here, unfortunately, as the Org agenda
    ;; interprets it both as a deadline and an event with the date
    ;; range.
    ;;
    ;; (format "DEADLINE: &lt;%s&gt;--&lt;%s&gt;\n" date
    (format "&lt;%s&gt;--&lt;%s&gt;\n" date
            (org-read-date
             :with-time nil "++1h" nil
             (org-encode-time (org-parse-time-string date))))))

(defun prot-org-capture-coach ()
  "Contents of an Org capture template for my coaching lessons."
  (let ((identifier (format-time-string "%Y%m%dT%H%M%S")))
    (format "* COACH %s %s :lesson:
DEADLINE: %%^T
:PROPERTIES:
:CAPTURED: %%U
:CUSTOM_ID: h:%s
:APPT_WARNTIME: 20
:END:

%%a%%?"
            (prot-org--capture-coach-person-prompt)
            (prot-org--capture-coach-description-prompt)
            identifier
            identifier)))

(defun prot-org-capture-coach-clock ()
  "Contents of an Org capture for my clocked coaching services."
  (format "* COACH %s %s :service:
:PROPERTIES:
:CAPTURED: %%U
:CUSTOM_ID: h:%s
:END:

%%a%%?"
          (prot-org--capture-coach-person-prompt)
          (prot-org--capture-coach-description-prompt)
          (format-time-string "%Y%m%dT%H%M%S")))

(declare-function cl-letf "cl-lib")

;; Adapted from source: &lt;https://stackoverflow.com/a/54251825&gt;.
;;
;; Thanks to Juanjo Presa (@uningan on GitHub) for discovering that the
;; original version was causing an error in `org-roam'.  I then figure
;; we were missing the `&amp;rest':
;; &lt;https://github.com/org-roam/org-roam/issues/2142#issuecomment-1100718373&gt;.
(defun prot-org--capture-no-delete-windows (&amp;rest args)
  "Apply ARGS while ignoring `delete-other-windows'."
  (cl-letf (((symbol-function 'delete-other-windows) 'ignore))
    (apply args)))

;; Same source as above
(advice-add 'org-capture-place-template :around 'prot-org--capture-no-delete-windows)
(advice-add 'org-add-log-note :around 'prot-org--capture-no-delete-windows)

;;;;; Custom function to select a project to add to

(defun prot-org--get-outline (&amp;optional file)
  "Return `outline-regexp' headings and line numbers of current file or FILE."
  (with-current-buffer (find-file-noselect file)
    (let ((outline-regexp (format "^\\(?:%s\\)" (or (bound-and-true-p outline-regexp) "[*\^L]+")))
          candidates)
      (save-excursion
        (goto-char (point-min))
        (while (if (bound-and-true-p outline-search-function)
                   (funcall outline-search-function)
                 (re-search-forward outline-regexp nil t))
          (push
           ;; NOTE 2024-11-24: The -5 (minimum width) is a sufficiently high number to keep the
           ;; alignment consistent in most cases.  Larger files will simply shift the heading text
           ;; in minibuffer, but this is not an issue anymore.
           (format "%-5s\t%s"
                   (line-number-at-pos (point))
                   (buffer-substring-no-properties (line-beginning-position) (line-end-position)))
           candidates)
          (goto-char (1+ (line-end-position)))))
      (if candidates
          (nreverse candidates)
        (user-error "No outline")))))

(defvar prot-org-outline-history nil
  "Minibuffer history for `prot-org-outline-prompt'.")

(defun prot-org-outline-prompt (&amp;optional file)
  "Prompt for outline among headings retrieved by `prot-org--get-outline'.
With optional FILE use the outline of it, otherwise use that of
the current file."
  (let ((current-file (or file buffer-file-name))
        (default (car prot-org-outline-history)))
    (completing-read
     (format-prompt
      (format "Select heading inside `%s': "
              (propertize (file-name-nondirectory current-file) 'face 'error))
      default)
     (prot-common-completion-table-no-sort 'imenu (prot-org--get-outline current-file))
     nil :require-match nil 'prot-org-outline-history default)))

(defvar prot-org-file-history nil
  "Minibuffer history of `prot-org-file-prompt'.")

(defun prot-org--not-useful-p (file)
  "Return non-nil if FILE is not a useful Org file for `org-capture'."
  (or (string-match-p "\\.org_archive\\'" file)
      (backup-file-name-p file)
      (not (string-match-p "\\.org\\'" file))))

(defun prot-org-file-prompt ()
  "Select a file in the `org-directory'."
  (if-let* ((dir org-directory)
            (files (directory-files-recursively org-directory ".*" nil))
            (files (seq-remove #'prot-org--not-useful-p files)))
      (let ((default (car prot-org-file-history)))
        (completing-read
         (format-prompt "Select file" default)
         (prot-common-completion-table 'file files)
         nil :require-match nil 'prot-org-file-history default))
    (user-error "There are no files in the `org-directory'")))

;;;###autoload
(defun prot-org-select-heading-in-file ()
  "Like `prot-org-select-project' but specifically for `org-capture'."
  (declare (interactive-only t))
  (interactive)
  (pcase-let* ((file (prot-org-file-prompt))
               (line-with-heading (prot-org-outline-prompt file))
               (`(,line ,text) (split-string line-with-heading "\t"))
               (line (string-to-number line)))
    ;; NOTE 2024-11-24: `with-current-buffer' does not work with `org-capture'.
    (find-file file)
    (goto-char (point-min))
    (forward-line (1- line))))

(defalias 'prot-org-goto-heading-in-file 'prot-org-select-heading-in-file
 "Alias for `prot-org-select-heading-in-file'.")

;;;; Org clock report

(defvar prot-org-clock--template-with-effort
  "#+BEGIN: clocktable :formula % :properties (\"Effort\") :timestamp t :sort (1 . ?a) :link t :scope nil :hidefiles t :maxlevel 8 :stepskip0 t
#+END:"
  "Clock table with effort estimate column to use for custom clock reports.")

(defvar prot-org-clock--template-no-effort
  "#+BEGIN: clocktable :formula % :timestamp t :sort (1 . ?a) :link nil :scope nil :hidefiles t :maxlevel 8 :stepskip0 t
#+END:"
  "Clock table to use for custom clock reports.")

(defvar prot-org-clock--ranges
  '( today yesterday thisweek lastweek thismonth
     lastmonth thisyear lastyear untilnow)
  "Time ranges of my interest for clock reports.")

(defvar prot-org-clock--report-range-history nil
  "Minibuffer history for `prot-org-clock--report-range-prompt'.")

(defun prot-org-clock--report-range-prompt ()
  "Prompt for a clock table range among `prot-org-clock--ranges'."
  (let ((default (car prot-org-clock--report-range-history)))
    (completing-read
     (format-prompt "Select a time range for the clock" default)
     prot-org-clock--ranges nil :require-match nil 'prot-org-clock--report-range-history
     default)))

(defun prot-org-clock--get-report (scope)
  "Produce clock report with current file SCOPE and return its buffer.
SCOPE is a symbol of either `file' or `subtree'.  If the former, then
use the entire file's contents.  Else use those of the current subtree."
  (let ((buffer (get-buffer-create "*prot-org-custom-clock-report*")))
    (save-restriction
      (unwind-protect
          (progn
            (pcase scope
              ('file nil)
              ('subtree (org-narrow-to-subtree))
              (_ (error "The scope `%s' is unknown" scope)))
            (let ((contents (buffer-substring (point-min) (point-max))))
              (with-current-buffer buffer
                (erase-buffer)
                (org-mode)
                (save-excursion
                  (insert (format "%s\n\n" prot-org-clock--template-with-effort))
                  (insert contents))
                (save-excursion
                  (let ((range (prot-org-clock--report-range-prompt)))
                    (goto-char (line-end-position))
                    (insert (concat " :block " range))))
                (org-dblock-update))))
        (widen)))
    buffer))

;;;###autoload
(defun prot-org-clock-report-current-subtree-or-file (&amp;optional whole-buffer)
  "Produce a clock report in a new buffer for the subtree at point.
With optional WHOLE-BUFFER as a non-nil value, operate on the entire file.
When called interactively WHOLE-BUFFER is a prefix argument."
  (interactive "P")
  (when-let* ((buffer (prot-org-clock--get-report (if whole-buffer 'file 'subtree))))
    (pop-to-buffer buffer)))

;;;###autoload
(defun prot-org-clock-select-heading-and-clock-report ()
  "Select a heading in a file and do a clock report for it in a new buffer."
  (interactive)
  (call-interactively 'prot-org-select-heading-in-file)
  (call-interactively 'prot-org-clock-report-current-subtree-or-file))

;;;;; Coaching-related Org custom clocking

;; TODO 2024-12-15: This sort of thing must exist in Org, but I did
;; not find it.
(defun prot-org--timestamp-to-time (string)
  "Return time object of STRING timestamp."
  (org-timestamp-to-time (org-timestamp-from-string string)))

(defun prot-org-coach--get-entries (todo-keyword string since)
  "Get Org entries matching TODO-KEYWORD followed by STRING in the heading.
Limit entries to those whole deadline/scheduled is equal or greater to
SINCE date.

Each entry is a plist of :heading, :contents, :started, :closed."
  (or (delq nil
            (org-map-entries
             (lambda ()
               (when-let* ((case-fold-search t)
                           (started (prot-org--timestamp-to-time (or (org-entry-get nil "DEADLINE") (org-entry-get nil "SCHEDULED"))))
                           (closed (prot-org--timestamp-to-time (org-entry-get nil "CLOSED")))
                           ((re-search-forward (format "\\&lt;%s\\&gt;.*\\&lt;%s\\&gt;" todo-keyword string) (line-end-position) t 1))
                           ((org-time-less-p since started)))
                 (list
                  :heading (org-get-heading :no-tags :no-todo :no-priority :no-comment)
                  :contents (org-get-entry)
                  :started started
                  :closed closed)))))
      (user-error "No entries with heading matching `\\&lt;%s\\&gt;.*\\&lt;%s\\&gt;'" todo-keyword string)))

(defvar prot-org-coach--name-history nil
  "Minibuffer history of `prot-org-coach--name-prompt'.")

(defun prot-org-coach--name-prompt ()
  "Prompt for name of person."
  (let ((default (car prot-org-coach--name-history)))
    (read-string
     (format-prompt "Name of person" default)
     nil 'prot-org-coach--name-history default)))

;;;###autoload
(defun prot-org-coach-report (name since)
  "Produce clock report for coaching with person of NAME.
SINCE is the date (of time 00:00) to count from until now."
  (interactive
   (list
    (prot-org-coach--name-prompt)
    (format "[%s]" (org-read-date))))
  (if-let* ((since-object (prot-org--timestamp-to-time since))
            (entries (prot-org-coach--get-entries "done" name since-object))
            (buffer (get-buffer-create "*prot-org-coach-entries*")))
      (with-current-buffer (pop-to-buffer buffer)
        (erase-buffer)
        (org-mode)
        (dolist (entry entries)
          (insert (format "* %s\n%s\n\n" (plist-get entry :heading) (plist-get entry :contents)))
          (org-clock-in nil (plist-get entry :started))
          (org-clock-out nil t (plist-get entry :closed)))
        (goto-char (point-min))
        (save-excursion
          (insert (format "%s\n\n" prot-org-clock--template-no-effort)))
        (save-excursion
          (goto-char (line-end-position))
          (insert (format " :tstart %S" since)))
        (org-dblock-update))
    (user-error "No entries for name `%s'" name)))

;;;; org-agenda

(declare-function calendar-day-name "calendar")
(declare-function calendar-day-of-week "calendar")
(declare-function calendar-month-name "calendar")
(declare-function org-days-to-iso-week "org")
(declare-function calendar-absolute-from-gregorian "calendar")

(defvar org-agenda-format-date)

;;;###autoload
(defun prot-org-agenda-format-date-aligned (date)
  "Format a DATE string for display in the daily/weekly agenda.
This function makes sure that dates are aligned for easy reading.

Slightly tweaked version of `org-agenda-format-date-aligned' that
produces dates with a fixed length."
  (require 'cal-iso)
  (let* ((dayname (calendar-day-name date t))
         (day (cadr date))
         (day-of-week (calendar-day-of-week date))
         (month (car date))
         (monthname (calendar-month-name month t))
         (year (nth 2 date))
         (iso-week (org-days-to-iso-week
                    (calendar-absolute-from-gregorian date)))
         ;; (weekyear (cond ((and (= month 1) (&gt;= iso-week 52))
         ;;                  (1- year))
         ;;                 ((and (= month 12) (&lt;= iso-week 1))
         ;;                  (1+ year))
         ;;                 (t year)))
         (weekstring (if (= day-of-week 1)
                         (format " (W%02d)" iso-week)
                       "")))
    (format "%s %2d %s %4d%s"
            dayname day monthname year weekstring)))

(defvar org-priority-highest)

(defun prot-org-agenda-include-priority-no-timestamp ()
  "Return nil if heading has a priority but no timestamp.
Otherwise, return the buffer position from where the search should
continue, per `org-agenda-skip-function'."
  (let ((point (point)))
    (if (and (eq (nth 3 (org-heading-components)) ?A)
             (not (org-get-deadline-time point))
             (not (org-get-scheduled-time point)))
        nil
      (line-beginning-position 2))))

(defvar prot-org-custom-daily-agenda
  ;; NOTE 2021-12-08: Specifying a match like the following does not
  ;; work.
  ;;
  ;; tags-todo "+PRIORITY=\"A\""
  ;;
  ;; So we match everything and then skip entries with
  ;; `org-agenda-skip-function'.
  `((tags-todo "*"
               ((org-agenda-overriding-header "Important tasks without a date\n")
                ;; NOTE 2024-10-31: Those used to work, but now the
                ;; query for the timestamp is ignored.  I thus wrote
                ;; `prot-org-agenda-include-priority-no-timestamp'.
                ;;
                ;; (org-agenda-skip-function '(org-agenda-skip-subtree-if nil '(timestamp)))
                ;; (org-agenda-skip-function
                ;;  `(org-agenda-skip-entry-if
                ;;    'notregexp ,(format "\\[#%s\\]" (char-to-string org-priority-highest))))
                (org-agenda-skip-function #'prot-org-agenda-include-priority-no-timestamp)
                (org-agenda-block-separator nil)))
    (agenda "" ((org-agenda-overriding-header "\nPending scheduled tasks")
                (org-agenda-time-grid nil)
                (org-agenda-start-on-weekday nil)
                (org-agenda-span 1)
                (org-agenda-show-all-dates nil)
                (org-scheduled-past-days 365)
                ;; Excludes today's scheduled items
                (org-scheduled-delay-days 1)
                (org-agenda-block-separator nil)
                (org-agenda-entry-types '(:scheduled))
                (org-agenda-skip-function '(org-agenda-skip-entry-if 'todo 'done))
                (org-agenda-skip-function '(org-agenda-skip-entry-if 'regexp "ROUTINE"))
                (org-agenda-day-face-function (lambda (date) 'org-agenda-date))
                (org-agenda-format-date "")))
    (agenda "" ((org-agenda-overriding-header "\nToday's agenda\n")
                (org-agenda-span 1)
                (org-deadline-warning-days 0)
                (org-agenda-block-separator nil)
                (org-scheduled-past-days 0)
                (org-agenda-skip-function '(org-agenda-skip-entry-if 'regexp "ROUTINE"))
                ;; We don't need the `org-agenda-date-today'
                ;; highlight because that only has a practical
                ;; utility in multi-day views.
                (org-agenda-day-face-function (lambda (date) 'org-agenda-date))
                (org-agenda-format-date "%A %-e %B %Y")))
    ;; (agenda "" ((org-agenda-overriding-header "\nRoutine")
    ;;             (org-agenda-time-grid nil)
    ;;             (org-agenda-start-on-weekday nil)
    ;;             (org-agenda-span 1)
    ;;             (org-agenda-show-all-dates nil)
    ;;             (org-scheduled-past-days 365)
    ;;             ;; Excludes today's scheduled items
    ;;             (org-scheduled-delay-days 1)
    ;;             (org-agenda-block-separator nil)
    ;;             (org-agenda-entry-types '(:scheduled))
    ;;             (org-agenda-skip-function '(org-agenda-skip-entry-if 'notregexp "ROUTINE"))
    ;;             (org-agenda-day-face-function (lambda (date) 'org-agenda-date))
    ;;             (org-agenda-format-date "")))
    (agenda "" ((org-agenda-overriding-header "\nNext three days\n")
                (org-agenda-start-on-weekday nil)
                (org-agenda-start-day nil)
                (org-agenda-start-day "+1d")
                (org-agenda-span 3)
                (org-deadline-warning-days 0)
                (org-agenda-block-separator nil)
                (org-agenda-skip-function '(org-agenda-skip-entry-if 'todo 'done))))
    (agenda "" ((org-agenda-overriding-header "\nUpcoming deadlines (+14d)\n")
                (org-agenda-time-grid nil)
                (org-agenda-start-on-weekday nil)
                ;; We don't want to replicate the previous section's
                ;; three days, so we start counting from the day after.
                (org-agenda-start-day "+4d")
                (org-agenda-span 14)
                (org-agenda-show-all-dates nil)
                (org-deadline-warning-days 0)
                (org-agenda-block-separator nil)
                (org-agenda-entry-types '(:deadline))
                (org-agenda-skip-function '(org-agenda-skip-entry-if 'todo 'done)))))
  "Custom agenda for use in `org-agenda-custom-commands'.")

;;;;; agenda appointments

(defvar prot-org-agenda-after-edit-hook nil
  "Hook that runs after select Org commands.
To be used with `advice-add'.")

(defun prot-org--agenda-after-edit (&amp;rest _)
  "Run `prot-org-agenda-after-edit-hook'."
  (run-hooks 'prot-org-agenda-after-edit-hook))

(defvar prot-org-after-deadline-or-schedule-hook nil
  "Hook that runs after `org--deadline-or-schedule'.
To be used with `advice-add'.")

(defvar prot-org--appt-agenda-commands
  '( org-agenda-archive org-agenda-deadline org-agenda-schedule
     org-agenda-todo org-archive-subtree)
  "List of commands that run `prot-org-agenda-after-edit-hook'.")

(dolist (fn prot-org--appt-agenda-commands)
  (advice-add fn :after #'prot-org--agenda-after-edit))

(defun prot-org--after-deadline-or-schedule (&amp;rest _)
  "Run `prot-org-after-deadline-or-schedule-hook'."
  (run-hooks 'prot-org-after-deadline-or-schedule-hook))

(defun prot-org-org-agenda-to-appt ()
  "Make `org-agenda-to-appt' always refresh appointment list."
  (org-agenda-to-appt :refresh))

(dolist (hook '(org-capture-after-finalize-hook
                org-after-todo-state-change-hook
                org-agenda-after-show-hook
                prot-org-agenda-after-edit-hook))
  (add-hook hook #'prot-org-org-agenda-to-appt))

(declare-function org--deadline-or-schedule "org" (arg type time))

(advice-add #'org--deadline-or-schedule :after #'prot-org--after-deadline-or-schedule)

(add-hook 'prot-org-after-deadline-or-schedule-hook #'prot-org-org-agenda-to-appt)

;;;; org-export

(declare-function org-html-export-as-html "org")
(declare-function org-texinfo-export-to-info "org")

;;;###autoload
(defun prot-org-ox-html ()
  "Streamline HTML export."
  (interactive)
  (org-html-export-as-html nil nil nil t nil))

;;;###autoload
(defun prot-org-ox-texinfo ()
  "Streamline Info export."
  (interactive)
  (org-texinfo-export-to-info))

;;;; org-id

(declare-function org-id-add-location "org")
(declare-function org-with-point-at "org")
(declare-function org-entry-get "org")
(declare-function org-id-new "org")
(declare-function org-entry-put "org")

;; Original idea:
;; &lt;https://writequit.org/articles/emacs-org-mode-generate-ids.html&gt;.
(defun prot-org--id-get ()
  "Get the CUSTOM_ID of the current entry.
If the entry already has a CUSTOM_ID, return it as-is, else
create a new one."
  (let* ((pos (point))
         (id (org-entry-get pos "CUSTOM_ID")))
    (or (and id (stringp id) (string-match-p "\\S-" id))
        (and (setq id (org-id-new "h")) (org-entry-put pos "CUSTOM_ID" id)))
    id))

(defun prot-org--heading-to-id ()
  "Convert current heading text to an ID for CUSTOM_ID purposes."
  (thread-last
    (org-get-heading :no-tags :no-todo :no-priority :no-comment)
    (replace-regexp-in-string "[][{}!@#$%^&amp;*()+'\"?,.\|;:~`‘’“”/=]*" "")
    (replace-regexp-in-string "\s" "-")
    (string-trim)
    (downcase)
    (concat "h:")))

(defun prot-org--id-get-readable ()
  "Like `prot-org--id-get' but use the heading wording to create and ID."
  (let* ((pos (point))
         (id (org-entry-get pos "CUSTOM_ID")))
    (or (and id (stringp id) (string-match-p "\\S-" id))
        (and (setq id (prot-org--heading-to-id))
             (org-entry-put pos "CUSTOM_ID" id)))
    id))

(declare-function org-map-entries "org")

;;;###autoload
(defun prot-org-id-headlines ()
  "Add missing CUSTOM_ID to all headlines in current file."
  (interactive)
  (org-map-entries (lambda () (prot-org--id-get))))

;;;###autoload
(defun prot-org-id-headlines-readable ()
  "Like `prot-org-id-headlines' but with readable IDs.
A readable identifier is one derived from the text of the heading.  In
theory, this may not be unique."
  (interactive)
  (org-map-entries (lambda () (prot-org--id-get-readable))))

;;;###autoload
(defun prot-org-id-headline (&amp;optional readable)
  "Add missing CUSTOM_ID to headline at point.
With optional prefix argument READABLE get a readable identifier derived
from the heading text instead of a UUID."
  (interactive "P")
  (funcall (if readable 'prot-org--id-get-readable 'prot-org--id-get)))

;;;###autoload
(defun prot-org-get-dotemacs-link ()
  "Get URL to current heading in my dotemacs file."
  (declare (interactive-only t))
  (interactive)
  (if (and (derived-mode-p 'org-mode)
           (string-match-p "prot-emacs\\.org\\'" buffer-file-name))
      (if-let* ((id (org-entry-get (point) "CUSTOM_ID"))
                (url (concat "https://protesilaos.com/emacs/dotemacs#" id)))
          (progn
            (kill-new url)
            (message "Copied %s" (propertize url 'face 'success)))
        (error "No CUSTOM_ID for the current entry"))
    (user-error "You are not in the right file")))

(provide 'prot-org)
;;; prot-org.el ends here
</pre>
</div>
</div>
</div>
<div id="outline-container-h:0a3f076d-386d-47e6-8af9-f17d02d507cf" class="outline-3">
<h3 id="h:0a3f076d-386d-47e6-8af9-f17d02d507cf"><span class="section-number-3">6.13.</span> The <code>prot-pair.el</code> library</h3>
<div class="outline-text-3" id="text-h:0a3f076d-386d-47e6-8af9-f17d02d507cf">
<div class="org-src-container">
<pre class="src src-emacs-lisp">;;; prot-pair.el --- Insert character pair around symbol or region -*- lexical-binding: t -*-

;; Copyright (C) 2023-2024  Protesilaos Stavrou

;; Author: Protesilaos Stavrou &lt;info@protesilaos.com&gt;
;; URL: https://protesilaos.com/emacs/dotemacs
;; Version: 0.1.0
;; Package-Requires: ((emacs "30.1"))

;; This file is NOT part of GNU Emacs.

;; This program is free software; you can redistribute it and/or modify
;; it under the terms of the GNU General Public License as published by
;; the Free Software Foundation, either version 3 of the License, or (at
;; your option) any later version.
;;
;; This program is distributed in the hope that it will be useful,
;; but WITHOUT ANY WARRANTY; without even the implied warranty of
;; MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
;; GNU General Public License for more details.
;;
;; You should have received a copy of the GNU General Public License
;; along with this program.  If not, see &lt;https://www.gnu.org/licenses/&gt;.

;;; Commentary:
;;
;; Insert character pair around symbol or region using minibuffer
;; completion.
;;
;; Remember that every piece of Elisp that I write is for my own
;; educational and recreational purposes.  I am not a programmer and I
;; do not recommend that you copy any of this if you are not certain of
;; what it does.

;;; Code:

(defgroup prot-pair nil
  "Insert character pair around symbol or region."
  :group 'editing)

(defcustom prot-pair-pairs
  '((?'  :description "Single quotes"           :pair (?' . ?'))
    (?\" :description "Double quotes"           :pair (?\" . ?\"))
    (?‘  :description "Single curly quotes"     :pair (?‘ . ?’))
    (?“  :description "Double curly quotes"     :pair (?“ . ?”))
    (?\&gt; :description "Natural language quotes" :pair prot-pair-insert-natural-language-quotes)
    (?\( :description "Parentheses"             :pair (?\( . ?\)))
    (?{  :description "Curly brackets"          :pair (?{ . ?}))
    (?\[ :description "Square brackets"         :pair (?\[ . ?\]))
    (?\&lt; :description "Angled brackets"         :pair (?\&lt; . ?\&gt;))
    (?@  :description "At signs"                :pair (?@ . ?@))
    (?=  :description "Equals signs"            :pair (?= . ?=))
    (?+  :description "Plus signs"              :pair (?+ . ?+))
    (?`  :description "Backticks"               :pair prot-pair-insert-backticks)
    (?~  :description "Tildes"                  :pair (?~ . ?~))
    (?*  :description "Asterisks"               :pair (?* . ?*))
    (?/  :description "Forward slashes"         :pair (?/ . ?/))
    (?_  :description "Underscores"             :pair (?_ . ?_)))
  "Alist of pairs for use with `prot-pair-insert'.
Each element in the list is a list whose `car' is a character and
the `cdr' is a plist with a `:description' and `:pair' keys.  The
`:description' is a string used to describe the character/pair in
interactive use, while `:pair' is a cons cell referencing the
opening and closing characters.

The value of `:pair' can also be the unquoted symbol of a
function.  The function is called with no arguments and must
return a cons cell of two characters.  Examples of such functions
are `prot-pair-insert-natural-language-quotes' and
`prot-pair-insert-backticks'"
  :type '(alist
          :key-type character
          :value-type (plist :options (((const :tag "Pair description" :description) string)
                                       ((const :tag "Characters" :pair)
                                        (choice (cons character character) function)))))
  :group 'prot-pair)

(defun prot-pair-insert-backticks ()
  "Return pair of backticks for `prot-pair-pairs'.
When the major mode is derived from `lisp-mode', return a pair of
backtick and single quote, else two backticks."
  (if (derived-mode-p 'lisp-mode 'lisp-data-mode)
      (cons ?` ?')
    (cons ?` ?`)))

(defun prot-pair-insert-natural-language-quotes ()
  "Return pair of quotes for `prot-pair-pairs', per natural language."
  ;; There are more here: &lt;https://en.wikipedia.org/wiki/Quotation_mark&gt;.
  ;; I cover the languages I might type in.
  (cond
   ((and current-input-method
         (string-match-p "\\(greek\\|french\\|spanish\\)" current-input-method))
    (cons ?« ?»))
   (t (cons ?\" ?\"))))

(defvar prot-pair--insert-history nil
  "Minibuffer history of `prot-pair--insert-prompt'.")

(defun prot-pair--annotate (character)
  "Annotate CHARACTER with its description in `prot-pair-pairs'."
  (when-let* ((char (if (characterp character) character (string-to-char character)))
              (plist (alist-get char prot-pair-pairs))
              (description (plist-get plist :description)))
    (format "  %s" description)))

(defun prot-pair--get-pair (character)
  "Get the pair of corresponding to CHARACTER."
  (when-let* ((char (if (characterp character) character (string-to-char character)))
              (plist (alist-get char prot-pair-pairs))
              (pair (plist-get plist :pair)))
    pair))

(defun prot-pair--insert-prompt ()
  "Prompt for pair among `prot-pair-pairs'."
  (let ((default (car prot-pair--insert-history))
        (candidates (mapcar (lambda (char) (char-to-string (car char))) prot-pair-pairs))
        (completion-extra-properties `(:annotation-function ,#'prot-pair--annotate)))
    (completing-read
     (format-prompt "Select pair" default)
     candidates nil :require-match
     nil 'prot-pair--insert-history default)))

(defun prot-pair--insert-bounds ()
  "Return boundaries of symbol at point or active region."
  (if (region-active-p)
      (cons (region-beginning) (region-end))
    (bounds-of-thing-at-point 'symbol)))

;;;###autoload
(defun prot-pair-insert (pair n)
  "Insert N number of PAIR around object at point.
PAIR is one among `prot-pair-pairs'.  The object at point is
either a symbol or the boundaries of the active region.  N is a
numeric prefix argument, defaulting to 1 if none is provided in
interactive use."
  (interactive
   (list
    (prot-pair--get-pair (prot-pair--insert-prompt))
    (prefix-numeric-value current-prefix-arg)))
  (let* ((bounds (prot-pair--insert-bounds))
         (beg (car bounds))
         (end (1+ (cdr bounds))) ; 1+ because we want the character after it
         (characters (if (functionp pair) (funcall pair) pair)))
    (dotimes (_ n)
      (save-excursion
        (goto-char beg)
        (insert (car characters))
        (goto-char end)
        (setq end (1+ end))
        (insert (cdr characters))))
    (goto-char (+ end (1- n)))))

;;;###autoload
(defun prot-pair-delete ()
  "Delete pair following or preceding point.
For Emacs version 28 or higher, the feedback's delay is
controlled by `delete-pair-blink-delay'."
  (interactive)
  (if (eq (point) (cdr (bounds-of-thing-at-point 'sexp)))
      (delete-pair -1)
    (delete-pair 1)))

(provide 'prot-pair)
;;; prot-pair.el ends here
</pre>
</div>
</div>
</div>
<div id="outline-container-h:f860bd85-671e-477e-8233-23a8ba43e1c6" class="outline-3">
<h3 id="h:f860bd85-671e-477e-8233-23a8ba43e1c6"><span class="section-number-3">6.14.</span> The <code>prot-prefix.el</code> library</h3>
<div class="outline-text-3" id="text-h:f860bd85-671e-477e-8233-23a8ba43e1c6">
<p>
[ Watch: <a href="https://protesilaos.com/codelog/2024-01-29-emacs-prefix-map/">define prefix/leader key (nested key maps)</a> (2024-01-29). ]
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">;;; prot-prefix.el --- Prefix keymap for my dotemacs -*- lexical-binding: t -*-

;; Copyright (C) 2023-2024  Protesilaos Stavrou

;; Author: Protesilaos Stavrou &lt;info@protesilaos.com&gt;
;; URL: https://protesilaos.com/emacs/dotemacs
;; Version: 0.1.0
;; Package-Requires: ((emacs "30.1"))

;; This file is NOT part of GNU Emacs.

;; This program is free software; you can redistribute it and/or modify
;; it under the terms of the GNU General Public License as published by
;; the Free Software Foundation, either version 3 of the License, or (at
;; your option) any later version.
;;
;; This program is distributed in the hope that it will be useful,
;; but WITHOUT ANY WARRANTY; without even the implied warranty of
;; MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
;; GNU General Public License for more details.
;;
;; You should have received a copy of the GNU General Public License
;; along with this program.  If not, see &lt;https://www.gnu.org/licenses/&gt;.

;;; Commentary:
;;
;; Prefix keymap for my custom keymaps.
;;
;; Remember that every piece of Elisp that I write is for my own
;; educational and recreational purposes.  I am not a programmer and I
;; do not recommend that you copy any of this if you are not certain of
;; what it does.

;;; Code:

(declare-function prot-simple-kill-buffer-current "prot-simple" (&amp;optional arg))
(declare-function prot-simple-rename-file-and-buffer "prot-simple" (name))
(declare-function prot-simple-buffers-major-mode "prot-simple")
(declare-function prot-simple-buffers-vc-root "prot-simple")
(declare-function beframe-buffer-menu "beframe" (&amp;optional frame &amp;key sort))

(defvar-keymap prot-prefix-buffer-map
  :doc "Prefix keymap for buffers."
  :name "Buffer"
  :prefix 'prot-prefix-buffer
  "m" #'beframe-buffer-menu
  "b" #'switch-to-buffer
  "B" #'prot-simple-buffers-major-mode
  "c" #'clone-indirect-buffer-other-window
  "f" #'fit-window-to-buffer
  "k" #'prot-simple-kill-buffer-current
  "g" #'revert-buffer-quick
  "r" #'prot-simple-rename-file-and-buffer
  "n" #'next-buffer
  "p" #'previous-buffer
  "v" #'prot-simple-buffers-vc-root)

(defvar-keymap prot-prefix-file-map
  :doc "Prefix keymaps for files."
  :name "File"
  :prefix 'prot-prefix-file
  "f" #'find-file
  "F" #'find-file-other-window
  "b" #'bookmark-jump
  "d" #'dired
  "l" #'find-library
  "m" #'man)

(defvar-keymap prot-prefix-insert-map
  :doc "Prefix keymap for character insertion."
  :name "Insert"
  :prefix 'prot-prefix-insert
  "i" #'insert-char
  "e" #'emoji-search
  "q" #'quoted-insert
  "s" #'emoji-search
  "l" #'emoji-list)

(declare-function logos-focus-mode "logos")
(declare-function keycast-mode-line-mode "keycast")
(declare-function rainbow-mode "rainbow")
(declare-function spacious-padding-mode "spacious-padding")

(defvar-keymap prot-prefix-mode-map
  :doc "Prefix keymap for minor mode toggles."
  :name "Toggle"
  :prefix 'prot-prefix-mode
  "f" #'flymake-mode
  "h" #'hl-line-mode
  "k" #'keycast-mode-line-mode
  "l" #'logos-focus-mode
  "m" #'menu-bar-mode
  "n" #'display-line-numbers-mode
  "t" #'toggle-truncate-lines
  "s" #'spacious-padding-mode
  "r" #'rainbow-mode
  "v" #'variable-pitch-mode)

(defvar-keymap prot-prefix-window-map
  :doc "Prefix keymap for windows."
  :name "Window"
  :prefix 'prot-prefix-window
  "u" #'winner-undo
  "r" #'winner-redo
  "b" #'balance-windows-area
  "d" #'toggle-window-dedicated
  "0" #'delete-window
  "1" #'delete-other-windows
  "!" #'delete-other-windows-vertically
  "2" #'split-window-below
  "@" #'split-root-window-below
  "3" #'split-window-right
  "#" #'split-root-window-right
  "o" #'other-window
  "^" #'tear-off-window
  "h" #'windmove-left
  "j" #'windmove-down
  "k" #'windmove-up
  "l" #'windmove-right
  "H" #'windmove-swap-states-left
  "J" #'windmove-swap-states-down
  "K" #'windmove-swap-states-up
  "L" #'windmove-swap-states-right)

(declare-function consult-find "consult" (&amp;optional dir initial))
(declare-function consult-ripgrep "consult" (&amp;optional dir initial))
(declare-function prot-search-grep "prot-search" (regexp &amp;optional recursive))
(declare-function prot-search-grep-todo-keywords "prot-search" (&amp;optional arg))
(declare-function prot-search-occur-browse-url "prot-search")
(declare-function prot-search-occur-outline "prot-search" (&amp;optional arg))
(declare-function prot-simple-flush-and-diff "prot-simple" (regexp beg end))

(defvar-keymap prot-prefix-search-map
  :doc "Prefix keymap for search (and replace) commands."
  :name "Search"
  :prefix 'prot-prefix-search
  "f" #'consult-find
  "d" #'prot-simple-flush-and-diff
  "g" #'prot-search-grep
  "o" #'prot-search-occur-outline
  "r" #'consult-ripgrep
  "t" #'prot-search-grep-todo-keywords
  "u" #'prot-search-occur-browse-url)

(declare-function prot-simple-transpose-chars "prot-simple")
(declare-function prot-simple-transpose-lines "prot-simple" (arg))
(declare-function prot-simple-transpose-paragraphs "prot-simple" (arg))
(declare-function prot-simple-transpose-sentences "prot-simple" (arg))
(declare-function prot-simple-transpose-words "prot-simple" (arg))
(declare-function prot-simple-transpose-sexps "prot-simple" (arg))

(defvar-keymap prot-prefix-transpose-map
  :doc "Prefix keymap for object transposition."
  :name "Transpose"
  :prefix 'prot-prefix-transpose
  "c" #'prot-simple-transpose-chars
  "l" #'prot-simple-transpose-lines
  "p" #'prot-simple-transpose-paragraphs
  "s" #'prot-simple-transpose-sentences
  "w" #'prot-simple-transpose-words
  "x" #'prot-simple-transpose-sexps)

(defvar-keymap prot-prefix-expression-map
  :doc "Prefix keymap for s-expression motions."
  :name "S-EXP"
  :prefix 'prot-prefix-expression
  "a" #'beginning-of-defun
  "e" #'end-of-defun
  "f" #'forward-sexp
  "b" #'backward-sexp
  "n" #'forward-list
  "p" #'backward-list
  "d" #'up-list ; confusing name for what looks "out and down" to me
  "t" #'transpose-sexps
  "u" #'backward-up-list ; the actual "up"
  "k" #'kill-sexp
  "DEL" #'backward-kill-sexp)

(declare-function winner-undo "winner")
(declare-function winner-redo "winner")
(declare-function magit-status "magit" (&amp;optional directory cache))
(declare-function prot-simple-other-windor-or-frame "prot-simple")

;; NOTE 2024-02-17: Some cons cells here have a symbol as a `cdr' and
;; some do not.  The former are those which define a prefix command
;; (per `define-prefix-command').  This is a symbol that references
;; the keymaps, thus making our binding an indirection: if we update
;; the key map, we automatically get the new key bindings.  Whereas
;; when we bind a key to the value of a variable, we have to update
;; the key map and then the binding for changes to propagate.
(defvar-keymap prot-prefix-map
  :doc "Prefix keymap with multiple subkeymaps."
  :name "Prot Prefix"
  :prefix 'prot-prefix
  "0" #'delete-window
  "1" #'delete-other-windows
  "!" #'delete-other-windows-vertically
  "^" #'tear-off-window
  "2" #'split-window-below
  "@" #'split-root-window-below
  "3" #'split-window-right
  "#" #'split-root-window-right
  "o" #'other-window
  "O" #'prot-simple-other-windor-or-frame
  "Q" #'save-buffers-kill-emacs
  "b" (cons "Buffer" 'prot-prefix-buffer)
  "c" #'world-clock
  "f" (cons "File" 'prot-prefix-file)
  "g" #'magit-status
  "h" (cons "Help" help-map)
  "i" (cons "Insert" 'prot-prefix-insert)
  "j" #'dired-jump
  "m" (cons "Minor modes" 'prot-prefix-mode)
  "n" (cons "Narrow" narrow-map)
  "p" (cons "Project" project-prefix-map)
  "r" (cons "Rect/Registers" ctl-x-r-map)
  "s" (cons "Search" 'prot-prefix-search)
  "t" (cons "Transpose" 'prot-prefix-transpose)
  "u" #'universal-argument
  "v" (cons "Version Control" 'vc-prefix-map)
  "w" (cons "Window" 'prot-prefix-window)
  "x" (cons "S-EXP" 'prot-prefix-expression))

;; ;; NOTE 2024-02-17: This is not needed anymore, because I bind a cons
;; ;; cell to the key.  The `car' of it is the description, which
;; ;; `which-key-mode' understands.
;;
;; (with-eval-after-load 'which-key
;;   (which-key-add-keymap-based-replacements prot-prefix-map
;;     "b" `("Buffer" . ,prot-prefix-buffer-map)
;;     "f" `("File" . ,prot-prefix-file-map)
;;     "h" `("Help" . ,help-map)
;;     "i" `("Insert" . ,prot-prefix-insert-map)
;;     "m" `("Mode" . ,prot-prefix-mode-map)
;;     "n" `("Narrow" . ,narrow-map)
;;     "p" `("Project" . ,project-prefix-map)
;;     "r" `("C-x r" . ,ctl-x-r-map)
;;     "s" `("Search" . ,prot-prefix-search-map)
;;     "t" `("Transpose" . ,prot-prefix-transpose-map)
;;     "v" `("C-x v" . ,vc-prefix-map)
;;     "w" `("Window" . ,prot-prefix-window-map)
;;     "x" `("S-EXP" . ,prot-prefix-expression-map)))

;; What follows is an older experiment with transient.  I like its
;; visuals, though find it hard to extend.  Keymaps are easier for me,
;; as I can add commands to one of the subkeymaps and they are readily
;; available without evaluating anything else.  Probably transient can
;; do this, though it is not obvious to me as to how.

;; (require 'transient)
;;
;; (transient-define-prefix prot-prefix-file nil
;;   "Transient with file commands."
;;   [["File or directory"
;;     ("f" "find-file" find-file)
;;     ("F" "find-file-other-window" find-file-other-window)]
;;    ["Directory only"
;;     ("d" "dired" dired)
;;     ("D" "dired-other-window" dired-other-window)]
;;    ["Documentation"
;;     ("l" "find-library" find-library)
;;     ("m" "man" man)]])
;;
;; (transient-define-prefix prot-prefix-buffer nil
;;   "Transient with buffer commands."
;;   [["Switch"
;;     ("b" "switch buffer" switch-to-buffer)
;;     ("B" "switch buf other window" switch-to-buffer-other-window)
;;     ("n" "next-buffer" next-buffer)
;;     ("p" "previous-buffer" previous-buffer)
;;     ("m" "buffer-menu" buffer-menu)
;;     ("q" "bury-buffer" bury-buffer)]
;;    ["Persist"
;;     ("c" "clone buffer" clone-indirect-buffer)
;;     ("C" "clone buf other window" clone-indirect-buffer-other-window)
;;     ("r" "rename-buffer" rename-buffer)
;;     ("R" "rename-uniquely" rename-uniquely)
;;     ("s" "save-buffer" save-buffer)
;;     ("w" "write-file" write-file)]
;;    ["Destroy"
;;     ("k" "kill-current-buffer" kill-current-buffer)
;;     ("K" "kill-buffer-and-window" kill-buffer-and-window)
;;     ("r" "revert-buffer" revert-buffer)]])
;;
;; (transient-define-prefix prot-prefix-search nil
;;   "Transient with search commands."
;;   [["Search"
;;     ("s" "isearch-forward" isearch-forward)
;;     ("S" "isearch-forward-regexp" isearch-forward-regexp)
;;     ("r" "isearch-backward" isearch-backward)
;;     ("R" "isearch-backward-regexp" isearch-backward-regexp)
;;     ("o" "occur" occur)]
;;    ["Edit"
;;     ("f" "flush-lines" flush-lines)
;;     ("k" "keep-lines" keep-lines)
;;     ("q" "query-replace" query-replace)
;;     ("Q" "query-replace-regexp" query-replace-regexp)]])
;;
;; (transient-define-prefix prot-prefix-window nil
;;   "Transient with window commands."
;;   [["Manage"
;;     ("b" "balance-windows" balance-windows)
;;     ("f" "fit-window-to-buffer" fit-window-to-buffer)
;;     ("t" "tear-off-window" tear-off-window)]
;;    ["Popup"
;;     ("c" "calc" calc)
;;     ("f" "list-faces-display" list-faces-display)
;;     ("r" "re-builder" re-builder)
;;     ("w" "world-clock" world-clock)]])
;;
;; ;; This is independent of the transient, though still useful.
;; (defvar-keymap prot-prefix-repeat-map
;;   :doc "Global prefix map for repeatable keybindings (per `repeat-mode')."
;;   :name "Repeat"
;;   :repeat t
;;   "n" #'next-buffer
;;   "p" #'previous-buffer
;;   "&lt;down&gt;" #'enlarge-window
;;   "&lt;right&gt;" #'enlarge-window-horizontally
;;   "&lt;up&gt;" #'shrink-window
;;   "&lt;left&gt;" #'shrink-window-horizontally)
;;
;; (transient-define-prefix prot-prefix-toggle nil
;;   "Transient with minor mode toggles."
;;   [["Interface"
;;     ("c" "context-menu-mode" context-menu-mode)
;;     ("m" "menu-bar-mode" menu-bar-mode)
;;     ("s" "scroll-bar-mode" scroll-bar-mode)
;;     ("C-t" "tool-bar-mode" tool-bar-mode)]
;;    ["Tools"
;;     ("d" "toggle-debug-on-error" toggle-debug-on-error)
;;     ("f" "follow-mode" follow-mode)
;;     ("l" "visual-line-mode" visual-line-mode)
;;     ("v" "variable-pitch-mode" variable-pitch-mode)
;;     ("t" "toggle-truncate-lines" toggle-truncate-lines)
;;     ("C-s" "window-toggle-side-windows" window-toggle-side-windows)]])
;;
;; (transient-define-prefix prot-prefix nil
;;   "Transient with common commands.
;; Commands that bring up transients have ... in their description."
;;   [["Common"
;;     ("b" "Buffer..." prot-prefix-buffer)
;;     ("f" "File..." prot-prefix-file)
;;     ("s" "Search..." prot-prefix-search)
;;     ("w" "Window..." prot-prefix-window)
;;     ("t" "Toggle..." prot-prefix-toggle)]
;;    ["Resize"
;;     ("   &lt;up&gt;" "Shrink vertically" shrink-window)
;;     (" &lt;down&gt;" "Enlarge vertically" enlarge-window)
;;     (" &lt;left&gt;" "Shrink horizontally" shrink-window-horizontally)
;;     ("&lt;right&gt;" "Enlarge horizontally" enlarge-window-horizontally)]
;;    ["Misc"
;;     ("e" "Emoji transient..." emoji-insert)
;;     ("E" "Emoji search" emoji-search)
;;     ("C-e" "Emoji buffer" emoji-list)
;;     ("RET" "Insert unicode" insert-char)
;;     ("\\" "toggle-input-method" toggle-input-method)]])

(provide 'prot-prefix)
;;; prot-prefix.el ends here
</pre>
</div>
</div>
</div>
<div id="outline-container-h:654cfe49-f59d-4a0d-84ee-094ddce06848" class="outline-3">
<h3 id="h:654cfe49-f59d-4a0d-84ee-094ddce06848"><span class="section-number-3">6.15.</span> The <code>prot-project.el</code> library</h3>
<div class="outline-text-3" id="text-h:654cfe49-f59d-4a0d-84ee-094ddce06848">
<div class="org-src-container">
<pre class="src src-emacs-lisp">;;; prot-project.el --- Extensions for project.el -*- lexical-binding: t -*-

;; Copyright (C) 2024-2024  Protesilaos Stavrou

;; Author: Protesilaos Stavrou &lt;info@protesilaos.com&gt;
;; URL: https://protesilaos.com/emacs/dotemacs
;; Version: 0.1.0
;; Package-Requires: ((emacs "30.1"))

;; This file is NOT part of GNU Emacs.

;; This program is free software; you can redistribute it and/or modify
;; it under the terms of the GNU General Public License as published by
;; the Free Software Foundation, either version 3 of the License, or (at
;; your option) any later version.
;;
;; This program is distributed in the hope that it will be useful,
;; but WITHOUT ANY WARRANTY; without even the implied warranty of
;; MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
;; GNU General Public License for more details.
;;
;; You should have received a copy of the GNU General Public License
;; along with this program.  If not, see &lt;https://www.gnu.org/licenses/&gt;.

;;; Commentary:
;;
;; Extensions for project.el.
;;
;; Remember that every piece of Elisp that I write is for my own
;; educational and recreational purposes.  I am not a programmer and I
;; do not recommend that you copy any of this if you are not certain of
;; what it does.

;;; Code:

(require 'project)
(require 'tab-bar)

;;;; Switch to a project root Dired outright

(defun prot-project--switch (directory &amp;optional command)
  "Do the work of `project-switch-project' in the given DIRECTORY.
With optional COMMAND, run it in DIRECTORY."
  (let ((command (or (when (functionp command) command)
                     (if (symbolp project-switch-commands)
                         project-switch-commands
                       (project--switch-project-command))))
        (buffer (current-buffer)))
    (unwind-protect
        (progn
          (setq-local project-current-directory-override directory)
          (call-interactively command))
      (with-current-buffer buffer
        (kill-local-variable 'project-current-directory-override)))))

(defun prot-project--frame-names ()
  "Return a list of frame names."
  (mapcar #'car (make-frame-names-alist)))

;;;###autoload
(defun prot-project-switch (directory)
  "Switch to project DIRECTORY.
If DIRECTORY exists in a frame, select it.  Otherwise switch to
the project in DIRECTORY using `project-dired'."
  (interactive (list (funcall project-prompter)))
  (project--remember-dir directory)
  (let ((name (file-name-nondirectory (directory-file-name directory))))
    (if (member name (prot-project--frame-names))
        (select-frame-by-name name)
      (prot-project--switch directory 'project-dired))))

;;;; Produce a VC root log for the project

(defun prot-project-rename-vc-root-log (&amp;rest _)
  "Rename the buffer of `vc-print-root-log' to mention the project."
  (when-let* ((root (vc-root-dir))
              ((consp project--list))
              ((member root (mapcar #'car project--list))))
    (rename-buffer (format "*vc-root-log: %s*" root))))

(advice-add #'vc-print-root-log :after #'prot-project-rename-vc-root-log)

;;;; One tab per project

;; NOTE 2024-01-15 07:07:52 +0200: I define the "in tab" functions as
;; a coding exercise.  I don't have a use for it, as I prefer to use
;; the approach of my `beframe' package instead.
(defun prot-project-in-tab--get-tab-names (&amp;optional frame)
  "Return list of tab names associated with FRAME.
If FRAME is nil, use the current frame."
  (mapcar
   (lambda (tab)
     (alist-get 'name tab))
   (frame-parameter frame 'tabs)))

(defun prot-project-in-tab--create-tab (directory name)
  "Create new tab visiting DIRECTORY and named NAME."
  (tab-new)
  (find-file directory)
  (unwind-protect
      (prot-project--switch directory)
    (tab-rename name)
    ;; NOTE 2024-01-15 06:52 +0200: I am adding this because
    ;; `tab-rename' is not persistent for some reason. Probably a bug...
    (let* ((tabs (funcall tab-bar-tabs-function))
           (tab-to-rename (nth (tab-bar--current-tab-index) tabs)))
      (setf (alist-get 'explicit-name tab-to-rename) name))))

;;;###autoload
(defun prot-project-in-tab (directory)
  "Switch to project DIRECTORY in a tab.
If a tab is named after the non-directory component of DIRECTORY,
switch to it.  Otherwise, create a new tab and name it after the
non-directory component of DIRECTORY.

Use this as an alternative to `project-switch-project'."
  (interactive (list (funcall project-prompter)))
  (project--remember-dir directory)
  (let ((name (file-name-nondirectory (directory-file-name directory))))
    (if (member name (prot-project-in-tab--get-tab-names))
        (tab-switch name)
      (prot-project-in-tab--create-tab directory name))))

;;;; Set up a project root

;; I don't actually have a use-case for `prot-project-find-root',
;; but I wrote it once so I keep it here in case I ever need it.
;; Use it like this: (prot-project-find-root c-mode "Makefile")
(defmacro prot-project-find-root (mode file)
  "Define project root check for MODE given FILE.
MODE must be the symbol of the major mode, without a quote.  FILE
is a string."
  (let ((project-find-fn (intern (format "project-find-%s-root" mode)))
        (major-mode-fn (intern (format "prot-%s-project-find-function" mode)))
        (file-symbol (intern file)))
    `(progn
       (defun ,project-find-fn (dir)
         (when-let* ((root (locate-dominating-file dir ,file)))
           (cons ',file-symbol root)))

       (cl-defmethod project-root ((project (head ,file-symbol)))
         (cdr project))

       (defun ,(intern (format "prot-%s-project-find-function" mode)) ()
         (add-hook 'project-find-functions #',project-find-fn :depth :local))

       (add-hook ',(intern (format "%s-hook" mode)) #',major-mode-fn))))

(provide 'prot-project)
;;; prot-project.el ends here
</pre>
</div>
</div>
</div>
<div id="outline-container-h:efebaec4-7273-4c5a-a4c4-9f99df0e46bb" class="outline-3">
<h3 id="h:efebaec4-7273-4c5a-a4c4-9f99df0e46bb"><span class="section-number-3">6.16.</span> The <code>prot-scratch.el</code> library</h3>
<div class="outline-text-3" id="text-h:efebaec4-7273-4c5a-a4c4-9f99df0e46bb">
<div class="org-src-container">
<pre class="src src-emacs-lisp">;;; prot-scratch.el --- Scratch buffers for editable major mode of choice -*- lexical-binding: t -*-

;; Copyright (C) 2023-2024  Protesilaos Stavrou

;; Author: Protesilaos Stavrou &lt;info@protesilaos.com&gt;
;; URL: https://protesilaos.com/emacs/dotemacs
;; Version: 0.1.0
;; Package-Requires: ((emacs "30.1"))

;; This file is NOT part of GNU Emacs.

;; This program is free software; you can redistribute it and/or modify
;; it under the terms of the GNU General Public License as published by
;; the Free Software Foundation, either version 3 of the License, or
;; (at your option) any later version.
;;
;; This program is distributed in the hope that it will be useful,
;; but WITHOUT ANY WARRANTY; without even the implied warranty of
;; MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
;; GNU General Public License for more details.
;;
;; You should have received a copy of the GNU General Public License
;; along with this program.  If not, see &lt;https://www.gnu.org/licenses/&gt;.

;;; Commentary:
;;
;; Set up a scratch buffer for an editable major mode of choice.  The
;; idea is based on the `scratch.el' package by Ian Eure:
;; &lt;https://github.com/ieure/scratch-el&gt;.
;;
;; Remember that every piece of Elisp that I write is for my own
;; educational and recreational purposes.  I am not a programmer and I
;; do not recommend that you copy any of this if you are not certain of
;; what it does.

;;; Code:

(require 'prot-common)

(defgroup prot-scratch ()
  "Scratch buffers for editable major mode of choice."
  :group 'editing)

(defcustom prot-scratch-default-mode 'text-mode
  "Default major mode for `prot-scratch-scratch-buffer'."
  :type 'symbol
  :group 'prot-scratch)

(defun prot-scratch--scratch-list-modes ()
  "List known major modes."
  (let (symbols)
    (mapatoms
     (lambda (symbol)
       (when (and (functionp symbol)
                  (or (provided-mode-derived-p symbol 'text-mode)
                      (provided-mode-derived-p symbol 'prog-mode)))
         (push symbol symbols))))
    symbols))

(defun prot-scratch--insert-comment ()
  "Insert comment for major mode, if appropriate.
Insert a comment if `comment-start' is non-nil and the buffer is
empty."
  (when (and (prot-common-empty-buffer-p) comment-start)
    (insert (format "Scratch buffer for: %s\n\n" major-mode))
    (goto-char (point-min))
    (comment-region (line-beginning-position) (line-end-position))))

(defun prot-scratch--prepare-buffer (region &amp;optional mode)
  "Add contents to scratch buffer and name it accordingly.

REGION is added to the contents to the new buffer.

Use the current buffer's major mode by default.  With optional
MODE use that major mode instead."
  (let ((major (or mode major-mode)))
    (with-current-buffer (pop-to-buffer (format "*%s scratch*" major))
      (funcall major)
      (prot-scratch--insert-comment)
      (goto-char (point-max))
      (unless (string-empty-p region)
        (when (prot-common-line-regexp-p 'non-empty)
          (insert "\n\n"))
        (insert region)))))

(defvar prot-scratch--major-mode-history nil
  "Minibuffer history of `prot-scratch--major-mode-prompt'.")

(defun prot-scratch--major-mode-prompt ()
  "Prompt for major mode and return the choice as a symbol."
  (intern
   (completing-read "Select major mode: "
                    (prot-scratch--scratch-list-modes)
                    nil
                    :require-match
                    nil
                    'prot-scratch--major-mode-history)))

(defun prot-scratch--capture-region ()
  "Capture active region, else return empty string."
  (if (region-active-p)
      (buffer-substring-no-properties (region-beginning) (region-end))
    ""))

;;;###autoload
(defun prot-scratch-buffer (&amp;optional arg)
  "Produce a scratch buffer matching the current major mode.

With optional ARG as a prefix argument (\\[universal-argument]),
use `prot-scratch-default-mode'.

With ARG as a double prefix argument, prompt for a major mode
with completion.  Candidates are derivatives of `text-mode' or
`prog-mode'.

If region is active, copy its contents to the new scratch
buffer.

Buffers are named as *MAJOR-MODE scratch*.  If one already exists
for the given MAJOR-MODE, any text is appended to it."
  (interactive "P")
  (let ((region (prot-scratch--capture-region)))
    (pcase (prefix-numeric-value arg)
      (16 (prot-scratch--prepare-buffer region (prot-scratch--major-mode-prompt)))
      (4 (prot-scratch--prepare-buffer region prot-scratch-default-mode))
      (_ (prot-scratch--prepare-buffer region)))))

(provide 'prot-scratch)
;;; prot-scratch.el ends here
</pre>
</div>
</div>
</div>
<div id="outline-container-h:0cab525d-fcbc-478c-b914-bbd69e33c635" class="outline-3">
<h3 id="h:0cab525d-fcbc-478c-b914-bbd69e33c635"><span class="section-number-3">6.17.</span> The <code>prot-search.el</code> library</h3>
<div class="outline-text-3" id="text-h:0cab525d-fcbc-478c-b914-bbd69e33c635">
<div class="org-src-container">
<pre class="src src-emacs-lisp">;;; prot-search.el --- Extensions to isearch, replace, grep for my dotemacs -*- lexical-binding: t -*-

;; Copyright (C) 2020-2024  Protesilaos Stavrou

;; Author: Protesilaos Stavrou &lt;info@protesilaos.com&gt;
;; URL: https://protesilaos.com/emacs/dotemacs
;; Version: 0.1.0
;; Package-Requires: ((emacs "30.1"))

;; This file is NOT part of GNU Emacs.

;; This program is free software; you can redistribute it and/or modify
;; it under the terms of the GNU General Public License as published by
;; the Free Software Foundation, either version 3 of the License, or
;; (at your option) any later version.
;;
;; This program is distributed in the hope that it will be useful,
;; but WITHOUT ANY WARRANTY; without even the implied warranty of
;; MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
;; GNU General Public License for more details.
;;
;; You should have received a copy of the GNU General Public License
;; along with this program.  If not, see &lt;https://www.gnu.org/licenses/&gt;.

;;; Commentary:
;;
;; This covers my isearch.el, replace.el, and grep.el extensions, for
;; use in my Emacs setup: &lt;https://protesilaos.com/emacs/dotemacs&gt;.
;;
;; Remember that every piece of Elisp that I write is for my own
;; educational and recreational purposes.  I am not a programmer and I
;; do not recommend that you copy any of this if you are not certain of
;; what it does.

;;; Code:

(require 'isearch)
(require 'replace)
(require 'grep)
(require 'prot-common)

(defgroup prot-search ()
  "Setup for Isearch, Occur, and related."
  :group 'search)

;; NOTE 2021-09-16: Based on my git config for headings in diffs.  Read:
;; &lt;https://protesilaos.com/codelog/2021-01-26-git-diff-hunk-elisp-org/&gt;.
(defcustom prot-search-outline-regexp-alist
  '((emacs-lisp-mode . "^\\((\\|;;;+ \\)")
    (org-mode . "^\\(\\*+ +\\|#\\+[Tt][Ii][Tt][Ll][Ee]:\\)"))
  "Alist of regular expressions per major mode.

For best results the key must be a symbol that corresponds to a
major mode.

To be used by `prot-search-occur-outline'."
  :type 'alist
  :group 'prot-search)

(defcustom prot-search-todo-keywords
  (concat "TODO\\|FIXME\\|NOTE\\|REVIEW\\|XXX\\|KLUDGE"
          "\\|HACK\\|WARN\\|WARNING\\|DEPRECATED\\|BUG")
  "Regexp with search to-do keywords."
  :type 'string
  :group 'prot-search)

;;;; Isearch

;;;###autoload
(defun prot-search-isearch-other-end ()
  "End current search in the opposite side of the match.
Particularly useful when the match does not fall within the
confines of word boundaries (e.g. multiple words)."
  (interactive)
  (isearch-done)
  (when isearch-other-end
    (goto-char isearch-other-end)))

;;;###autoload
(defun prot-search-isearch-abort-dwim ()
  "Delete failed `isearch' input, single char, or cancel search.

This is a modified variant of `isearch-abort' that allows us to
perform the following, based on the specifics of the case: (i)
delete the entirety of a non-matching part, when present; (ii)
delete a single character, when possible; (iii) exit current
search if no character is present and go back to point where the
search started."
  (interactive)
  (if (eq (length isearch-string) 0)
      (isearch-cancel)
    (isearch-del-char)
    (while (or (not isearch-success) isearch-error)
      (isearch-pop-state)))
  (isearch-update))

;;;###autoload
(defun prot-search-isearch-repeat-forward (&amp;optional arg)
  "Move forward, keeping point at the beginning of the match.
Optionally move to ARGth match in the given direction."
  (interactive "p")
  (when (and isearch-forward isearch-other-end)
    (goto-char isearch-other-end))
  (isearch-repeat-forward (or arg 1)))

;;;###autoload
(defun prot-search-isearch-repeat-backward (&amp;optional arg)
  "Move backward, keeping point at the beginning of the match.
Optionally move to ARGth match in the given direction."
  (interactive "p")
  (when (and (not isearch-forward) isearch-other-end)
    (goto-char isearch-other-end))
  (isearch-repeat-backward (or arg 1)))

(defmacro prot-search-isearch-occurrence (name edge &amp;optional doc)
  "Construct function for moving to `isearch' occurrence.
NAME is the name of the function.  EDGE is either the beginning
or the end of the buffer.  Optional DOC is the resulting
function's docstring."
  `(defun ,name (&amp;optional arg)
     ,doc
     (interactive "p")
     (let ((x (or arg 1))
           (command (intern (format "isearch-%s-of-buffer" ,edge))))
       (isearch-forward-symbol-at-point)
       (funcall command x))))

(prot-search-isearch-occurrence
 prot-search-isearch-beginning-of-buffer
 "beginning"
 "Run `isearch-beginning-of-buffer' for the symbol at point.
With numeric ARG, move to ARGth occurrence counting from the
beginning of the buffer.")

(prot-search-isearch-occurrence
 prot-search-isearch-end-of-buffer
 "end"
 "Run `isearch-end-of-buffer' for the symbol at point.
With numeric ARG, move to ARGth occurrence counting from the
end of the buffer.")

;;;; Replace/Occur

(defvar prot-search-markup-replacements
  '((elisp-to-org-code "`\\(.*?\\)'" "~\\1~")
    (elisp-to-org-verbatim "`\\(.*?\\)'" "=\\1=")
    (org-to-elisp-quote "[=~]\\(.*?\\)[=~]" "`\\1'")
    (org-to-markdown-code "[=~]\\(.*?\\)[=~]" "`\\1`"))
  "Common markup replacement patterns.")

(defvar prot-search--replace-markup-history '()
  "Minibuffer history of `prot-search-replace-markup'.")

(defun prot-search--replace-markup-prompt ()
  "Prompt for `prot-search-replace-markup'."
  (let* ((def (nth 0 prot-search--replace-markup-history))
         (prompt (if def
                     (format "Replace markup TYPE [%s]: " def)
                   "Replace markup TYPE: ")))
    (intern
     (completing-read
      prompt
      ;; TODO 2022-05-01: maybe older Emacs versions need to explicitly
      ;; map through the car of each list?
      prot-search-markup-replacements
      nil t nil 'prot-search--replace-markup-history def))))

(defun prot-search-replace-markup (type)
  "Perform TYPE of markup replacement.
TYPE is the car of a list in `prot-search-markup-replacements'.

When used interactively, prompt for completion among the
available types.

When the region is active, only perform replacements within its
boundaries, else start from point to the end of the buffer."
  (interactive (list (prot-search--replace-markup-prompt)))
  (if-let* ((types prot-search-markup-replacements)
            ((memq type (mapcar #'car types)))
            (association (alist-get type types))
            (search (nth 0 association))
            (replace (nth 1 association)))
      (if (use-region-p)
          (replace-regexp-in-region search replace (region-beginning) (region-end))
        (while (re-search-forward search nil t)
          (replace-match replace)))
    (user-error "`%s' is not part of `prot-search-markup-replacements'" type)))

;; NOTE 2023-01-14: See my `substitute' package instead of the
;; following: &lt;https://github.com/protesilaos/substitute&gt;.

;; (defun prot-search-isearch-replace-symbol ()
;;   "Run `query-replace-regexp' for the symbol at point."
;;   (interactive)
;;   (isearch-forward-symbol-at-point)
;;   (isearch-query-replace-regexp))

(autoload 'goto-address-mode "goto-addr")

;;;###autoload
(defun prot-search-occur-urls ()
  "Produce buttonised list of all URLs in the current buffer."
  (interactive)
  (let ((buf-name (format "*links in &lt;%s&gt;*" (buffer-name))))
    (add-hook 'occur-hook #'goto-address-mode)
    (occur-1 prot-common-url-regexp "\\&amp;" (list (current-buffer)) buf-name)
    (remove-hook 'occur-hook #'goto-address-mode)))

;;;###autoload
(defun prot-search-occur-browse-url ()
  "Point browser at a URL in the buffer using completion.
Which web browser to use depends on the value of the variable
`browse-url-browser-function'.

Also see `prot-search-occur-urls'."
  (interactive)
  (let ((matches nil))
    (save-excursion
      (goto-char (point-min))
      (while (search-forward-regexp prot-common-url-regexp nil t)
        (push (match-string-no-properties 0) matches)))
    (funcall browse-url-browser-function
             (completing-read "Browse URL: " matches nil t))))

(defvar prot-search--occur-outline-hist '()
  "Minibuffer history of `prot-search-occur-outline'.")

(defun prot-search--occur-outline-prompt ()
  "Helper prompt for `prot-search-occur-outline'."
  (let* ((alist prot-search-outline-regexp-alist)
         (key (car (assoc major-mode alist)))
         (default (or key (nth 1 prot-search--occur-outline-hist))))
    (completing-read
     (format "Outline style [%s]: " default)
     (mapcar #'car alist)
     nil nil nil 'prot-search--occur-outline-hist default)))

(defvar-local prot-search--remap-cookie nil
  "Current local value of `prot-search--remap-match-face'.")

(defface prot-search-match '((t :inherit default))
  "Face intended to override `match' buffer-locally.")

(defun prot-search--remap-match-face (buf)
  "Remap `match' to `prot-search-match' in BUF."
  (with-current-buffer buf
    (setq prot-search--remap-cookie
          (face-remap-add-relative 'match 'prot-search-match))))

;;;###autoload
(defun prot-search-occur-outline (&amp;optional arg)
  "Produce buffer outline from `prot-search-outline-regexp-alist'.

With optional prefix ARG (\\[universal-argument]), prompt for a
preset among the entries in `prot-search-outline-regexp-alist'.

ARG may also be a string (or regular expression) when called from
Lisp."
  (interactive "P")
  (let* ((regexp (when (and arg (not (stringp arg)))
                   (prot-search--occur-outline-prompt)))
         (rx (cond
              ((stringp arg)
               arg)
              ((and arg (string= major-mode regexp))
               (alist-get regexp prot-search-outline-regexp-alist))
              ((assoc major-mode prot-search-outline-regexp-alist)
               (alist-get major-mode prot-search-outline-regexp-alist))
              (t (user-error "Unknown outline style"))))
         (buf-name (format "*outline of &lt;%s&gt;*" (buffer-name))))
    (occur-1 rx nil (list (current-buffer)) buf-name)
    ;; Because we are producing an outline, we do not need to know what
    ;; the exact matches are.
    (prot-search--remap-match-face buf-name)
    (add-to-history 'prot-search--occur-outline-hist regexp)))

;;;###autoload
(defun prot-search-occur-todo-keywords (&amp;optional context)
  "Produce Occur buffer with `prot-search-todo-keywords'.
With optional numeric prefix argument for CONTEXT, show as many
lines before and after each match.

When called from Lisp CONTEXT must satisfy `natnump'.  A faulty
value is read as 0.

Also see `prot-search-grep-todo-keywords'."
  (interactive "P")
  (let* ((case-fold-search nil)
         (num (cond
               (current-prefix-arg
	            (prefix-numeric-value current-prefix-arg))
               (t (if (natnump context) context 0))))
         (buf-name (format "*keywords in &lt;%s&gt;*" (buffer-name))))
    (occur-1 prot-search-todo-keywords num (list (current-buffer)) buf-name)))

;;;; Outline

(defun prot-search--get-outline ()
  "Return alist of outline outline-regexp and positions."
  (let* ((outline-regexp (format "^\\(?:%s\\)" (or (bound-and-true-p outline-regexp) "[*\^L]+")))
         (heading-alist (bound-and-true-p outline-heading-alist))
         (level-fun (or (bound-and-true-p outline-level)
                        (lambda () ;; as in the default from outline.el
                          (or (cdr (assoc (match-string 0) heading-alist))
                              (- (match-end 0) (match-beginning 0))))))
         candidates)
    (save-excursion
      (goto-char (point-min))
      (while (if (bound-and-true-p outline-search-function)
                 (funcall outline-search-function)
               (re-search-forward outline-regexp nil t))
        (push
         (format "%-5s %s"
                 (line-number-at-pos (point))
                 (buffer-substring-no-properties (line-beginning-position) (line-end-position)))
         candidates)
        (goto-char (1+ (line-end-position)))))
    (if candidates
        (nreverse candidates)
      (user-error "No outline"))))

(defun prot-search--outline-prompt ()
  "Prompt for outline among headings retrieved by `prot-search--get-outline'."
  (completing-read
   "Go to outline: "
   (prot-common-completion-table-no-sort 'imenu (prot-search--get-outline))
   nil :require-match))

(defvar prot-search-outline-hook nil
  "Normal hook to run at the end of `prot-search-outline'.")

;;;###autoload
(defun prot-search-outline ()
  "Go to the line of the given outline using completion."
  (interactive)
  (when-let* ((selection (prot-search--outline-prompt))
              (line (string-to-number (car (split-string selection "\t")))))
    (goto-line line)
    (run-hooks 'prot-search-outline-hook)))

;;;; Grep

(defvar prot-search--grep-hist nil
  "Input history of grep searches.")

(defun prot-search-grep-prompt (&amp;optional recursive)
  "Prompt for grep pattern.
With optional RECURSIVE, indicate that the search will be called
recursively."
  (read-regexp
   (concat (if recursive
               (propertize "Recursive" 'face 'warning)
             "Local")
           " grep for PATTERN: ")
   nil 'prot-search--grep-hist))

;;;###autoload
(defun prot-search-grep (regexp &amp;optional recursive)
  "Run grep for REGEXP.
Search in the current directory using `lgrep'.  With optional
prefix argument (\\[universal-argument]) for RECURSIVE, run a
search starting from the current directory with `rgrep'."
  (interactive
   (list
    (prot-search-grep-prompt current-prefix-arg)
    current-prefix-arg))
  (unless grep-command
    (grep-compute-defaults))
  (if recursive
      (rgrep regexp "*" default-directory)
    (lgrep regexp "*" default-directory)))

;;;###autoload
(defun prot-search-grep-todo-keywords (&amp;optional arg)
  "Use `prot-search-grep' to find `prot-search-todo-keywords'.

With optional prefix ARG use git-grep instead for the entire
repository (runs `prot-search-git-grep-todo-keywords').  If Git
is not available on the system, run `prot-search-grep'
recursively, starting from the current directory.

Also see `prot-search-occur-todo-keywords'."
  (interactive "P")
  (cond
   (arg
    (if (executable-find "git")
        (prot-search-git-grep-todo-keywords)
      (prot-search-grep prot-search-todo-keywords t)))
   (t
    (prot-search-grep prot-search-todo-keywords))))

;; NOTE 2022-01-30: We could use `project-find-regexp' but I prefer
;; grep's editable buffers.  Besides, where is the fun in that when we
;; can use `compilation-start' instead?
;;;###autoload
(defun prot-search-git-grep-todo-keywords ()
  "Use the git-grep mechanism for `prot-search-todo-keywords'."
  (interactive)
  (let ((regexp prot-search-todo-keywords)
        (default-directory (or (vc-root-dir)
                               (locate-dominating-file "." ".git")
                               default-directory)))
    (compilation-start
     (format "git --no-pager grep -n --color=auto -r -I -E -e %s" regexp)
     'grep-mode
     (lambda (mode) (format "*prot-search-git-%s for '%s'" mode regexp))
     t)))

(defun prot-search--add-revert-function (buffer mode fn regexp)
  "Append `revert-buffer-function' for FN with REGEXP to MODE BUFFER variables.
See `prot-search-find-grep-buffer' (or related) for the kind of
BUFFER this works with."
  (with-current-buffer buffer
    (setq-local revert-buffer-function
                (lambda (_ignore-auto _noconfirm)
                  (funcall fn regexp))
                ;; FIXME 2023-04-04: The `compile-command' does not
                ;; feel right here.  We do it because in grep-mode the
                ;; g key runs `recompile' which falls back to the
                ;; `compile-command'.  We want it to do the same thing
                ;; as `revert-buffer'.
                compile-command `(funcall ',fn ,regexp))
    (let ((inhibit-read-only t))
      (goto-char (point-min))
      (when (re-search-forward (format "-*- mode: %s;" mode) (line-end-position) :no-error 1)
        (insert
         (format " revert-buffer-function: %S; compile-command %S;"
                 `(lambda (_ignore-auto _noconfirm)
                    (,fn ,regexp))
                 `(funcall ,fn ,regexp)))))))

(defun prot-search--start-compilation (args mode buffer command query)
  "Run compilation with ARGS for MODE in BUFFER given COMMAND running QUERY."
  (compilation-start
   args
   (intern (format "%s-mode" mode))
   (lambda (_mode) buffer)
   :highlight-regexp)
  (prot-search--add-revert-function buffer mode command query))

(defvar prot-search--find-grep-hist '()
  "Minibuffer history for `prot-search-find-grep-buffer' and related.")

(defmacro prot-search-make-search (command docstring prompt function mode)
  "Produce COMMAND with DOCSTRING given PROMPT, FUNCTION, and MODE."
  `(defun ,command (query)
     ,(format
       "%s.

Place the output in a buffer that runs `%s'.  Store the
invocation of this command with REGEXP in a buffer-local
variable.  When the buffer is written to a file, per
`write-file', the `revert-buffer' command (typically bound to
`g') can be used to re-run the search.  The buffer contains
information about the search results, including the exact command
line flags that were used, the time the results were produced,
and the number of matches.  All matching entries are buttonized
and function as links to the context they reference."
       docstring mode)
     (interactive
      (list
       (read-regexp ,prompt nil 'prot-search--find-grep-hist)))
     (let ((args (,function query))
           (buffer-name (format "*prot-search-find for '%s'*" query)))
       (prot-search--start-compilation args ,mode buffer-name ',command query))))

(defun prot-search--find-grep-args (regexp)
  "Return find args to produce grep results for REGEXP."
  (concat
   "find " default-directory
   " -not " (shell-quote-argument "(")
   " -path " (shell-quote-argument "*/.git*")
   " -prune " (shell-quote-argument ")")
   " -type f"
   " -exec grep -nHE --color=auto " regexp " "
   (shell-quote-argument "{}")
   " " (shell-quote-argument ";") " "))

;;;###autoload (autoload 'prot-search-find-grep-buffer "prot-search")
(prot-search-make-search
 prot-search-find-grep-buffer
 "Combine find with grep to produce a buffer for REGEXP matches"
 "Find files matching REGEXP and show a grep buffer: "
 prot-search--find-grep-args
 "grep")

(defun prot-search--find-grep-files-args (regexp)
  "Return find args to produce file listing with contents matching REGEXP."
  (concat
   "find " default-directory
   " -not " (shell-quote-argument "(")
   " -path " (shell-quote-argument "*/.git*")
   " -prune " (shell-quote-argument ")")
   " -type f"
   " -exec grep -qo --color=auto " regexp " "
   (shell-quote-argument "{}")
   " "
   (shell-quote-argument ";") " "
   "-ls"))

;;;###autoload (autoload 'prot-search-find-grep-files-buffer "prot-search")
(prot-search-make-search
 prot-search-find-grep-files-buffer
 "Combine find with grep to produce a buffer for files matching REGEXP"
 "Find files with contents matching REGEXP and show a file listing: "
 prot-search--find-grep-files-args
 "dired")

(defun prot-search--find-file-names-args (regexp)
  "Return find args to produce file listing with file names matching REGEXP."
  (concat
   "find " default-directory
   " -not " (shell-quote-argument "(")
   " -path " (shell-quote-argument "*/.git*")
   " -prune " (shell-quote-argument ")")
   " -type f"
   " -iname '*" regexp "*'"
   " -exec ls -AFhldvN --group-directories-first --time-style=long-iso --color=auto --hyperlink=never "
   (shell-quote-argument "{}")
   " "
   (shell-quote-argument ";")))

;;;###autoload (autoload 'prot-search-find-files-buffer "prot-search")
(prot-search-make-search
 prot-search-find-files-buffer
 "Use find to produce a buffer for file names matching REGEXP"
 "Find files with name matching REGEXP and show a file listing: "
 prot-search--find-file-names-args
 "dired")

;; (defun prot-search-find-grep-file (regexp)
;;   "Use find to produce list of files that include REGEXP."
;;   (interactive
;;    (list
;;     (read-regexp "Find and grep for REGEXP: " nil 'prot-search--find-grep-hist)))
;;   (let ((files (process-lines "find"
;;                               "-type" "f"
;;                               "-exec" "grep" "-nHE" "--color=auto" (format "'%s" regexp) " "
;;                               "-ls" " "
;;                               "{};")
;;                ))
;;     (find-file (completing-read "Find file: "files))))

(provide 'prot-search)
;;; prot-search.el ends here
</pre>
</div>
</div>
</div>
<div id="outline-container-h:32f6fe0f-23c4-44cc-97cc-3e5372bd484e" class="outline-3">
<h3 id="h:32f6fe0f-23c4-44cc-97cc-3e5372bd484e"><span class="section-number-3">6.18.</span> The <code>prot-shell.el</code> library</h3>
<div class="outline-text-3" id="text-h:32f6fe0f-23c4-44cc-97cc-3e5372bd484e">
<div class="org-src-container">
<pre class="src src-emacs-lisp">;;; prot-shell.el --- M-x shell extensions for my dotemacs -*- lexical-binding: t -*-

;; Copyright (C) 2023-2024  Protesilaos Stavrou

;; Author: Protesilaos Stavrou &lt;info@protesilaos.com&gt;
;; URL: https://protesilaos.com/emacs/dotemacs
;; Version: 0.1.0
;; Package-Requires: ((emacs "30.1"))

;; This file is NOT part of GNU Emacs.

;; This program is free software; you can redistribute it and/or modify
;; it under the terms of the GNU General Public License as published by
;; the Free Software Foundation, either version 3 of the License, or
;; (at your option) any later version.
;;
;; This program is distributed in the hope that it will be useful,
;; but WITHOUT ANY WARRANTY; without even the implied warranty of
;; MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
;; GNU General Public License for more details.
;;
;; You should have received a copy of the GNU General Public License
;; along with this program.  If not, see &lt;https://www.gnu.org/licenses/&gt;.

;;; Commentary:
;;
;; This covers my shell.el extensions, for use in my Emacs setup:
;; &lt;https://protesilaos.com/emacs/dotemacs&gt;.
;;
;; Remember that every piece of Elisp that I write is for my own
;; educational and recreational purposes.  I am not a programmer and I
;; do not recommend that you copy any of this if you are not certain of
;; what it does.

;;; Code:

(require 'shell)

;;;; Helper functions

(defun prot-shell--beginning-of-prompt-p ()
  "Return non-nil if point is at the beginning of a shell prompt."
  (if comint-use-prompt-regexp
      (looking-back comint-prompt-regexp (line-beginning-position))
    (eq (point) (comint-line-beginning-position))))

(defun prot-shell--insert-and-send (&amp;rest args)
  "Insert and execute ARGS in the last shell prompt.
ARGS is a list of strings."
  (if (prot-shell--beginning-of-prompt-p)
      (progn
        (insert (mapconcat #'identity args " "))
        (comint-send-input))
    (user-error "Not at the beginning of prompt; won't insert: %s" args)))

(defun prot-shell--last-input ()
  "Return last input as a string."
  (buffer-substring-no-properties
   comint-last-input-start
   comint-last-input-end))

;;;; Input from shell command history using completion

(defun prot-shell--build-input-history ()
  "Return `comint-input-ring' as a list."
  (when (and (ring-p comint-input-ring)
	         (not (ring-empty-p comint-input-ring)))
    (let (history)
      ;; We have to build up a list ourselves from the ring vector.
      (dotimes (index (ring-length comint-input-ring))
        (push (ring-ref comint-input-ring index) history))
      (delete-dups history))))

(defvar prot-shell--input-history-completion-history nil
  "Minibuffer history of `prot-shell--input-history-prompt'.
Not to be confused with the shell input history, which is stored
in the `comint-input-ring' (see `prot-shell--build-input-history').")

(defun prot-shell--input-history-prompt ()
  "Prompt for completion against `prot-shell--build-input-history'."
  (let* ((history (prot-shell--build-input-history))
         (default (car history)))
    (completing-read
     (format-prompt "Insert input from history" default)
     history nil :require-match nil
     'prot-shell--input-history-completion-history
     default)))

;;;###autoload
(defun prot-shell-input-from-history ()
  "Insert command from shell input history.
Only account for the history Emacs knows about, ignoring
`comint-input-ring-file-name' (e.g. ~/.bash_history)."
  (declare (interactive-only t))
  (interactive)
  (prot-shell--insert-and-send
   (prot-shell--input-history-prompt)))

;;;; Directory navigation

;;;;; Directory tracking

(defvar prot-shell-cd-directories nil
  "List of accumulated `shell-last-dir'.")

(with-eval-after-load 'savehist
  (add-to-list 'savehist-additional-variables 'prot-shell-cd-directories))

(defun prot-shell-track-cd (&amp;rest _)
  "Track shell input of cd commands.
Push `shell-last-dir' to `prot-shell-cd-directories'."
  (when-let* ((input (prot-shell--last-input))
              ((string-match-p "cd " input)))
    (push shell-last-dir prot-shell-cd-directories)))

(defun prot-shell-update-name-on-cd (&amp;rest _)
  "Update the shell buffer name after a cd for use in `prot-shell'."
  (when-let* ((input (prot-shell--last-input))
              ((string-match-p "cd " input)))
    (rename-buffer (format "*prot-shell in %s*" default-directory) :make-unique)))

(defvar prot-shell--cd-history nil
  "Minibuffer history for `prot-shell-cd'.")

(defun prot-shell--cd-prompt ()
  "Prompt for a directory among `prot-shell-cd-directories'."
  (if-let* ((history prot-shell-cd-directories)
            (dirs (cons default-directory history))
            (def (if (listp dirs) (car dirs) shell-last-dir)))
      (completing-read
       (format-prompt "Select directory" def)
       dirs nil :require-match nil 'prot-shell--cd-history def)
    (user-error "No directories have been tracked")))

;;;###autoload
(defun prot-shell-cd ()
  "Switch to `prot-shell-cd-directories' using minibuffer completion."
  (declare (interactive-only t))
  (interactive)
  (prot-shell--insert-and-send
   "cd"
   (prot-shell--cd-prompt)))

;;;;; VC root directory

(defun prot-shell--get-vc-root-dir ()
  "Return `vc-root-dir' or root of present Git repository."
  (or (vc-root-dir)
      (locate-dominating-file "." ".git")))

;;;###autoload
(defun prot-shell-cd-vc-root-dir ()
  "Change into the `vc-root-dir'."
  (interactive)
  (if-let* ((root (prot-shell--get-vc-root-dir)))
      (prot-shell--insert-and-send "cd" root)
    (user-error "Cannot find the VC root of `%s'" default-directory)))

;;;; Bookmark support

;; NOTE 2023-08-18: I sent this to the Emacs maintainers as a patch
;; (bug#65039).  I received approval to proceed with the change, but I
;; did not do it because a user reported an issue with SSH (TRAMP).  I
;; do not have access to SSH and am not familiar with such workflows.
;; If/when that changes, I will try again.  In the meantime, this is
;; good code and it works for me.

;; Adapted from esh-mode.el
(declare-function bookmark-prop-get "bookmark" (bookmark prop))

(defun prot-shell-bookmark-name ()
  "Return name of bookmark based on currect directory."
  (format "prot-shell-%s"
          (file-name-nondirectory
           (directory-file-name
            (file-name-directory default-directory)))))

(defvar sh-shell-file)

(defun prot-shell-bookmark-make-record ()
  "Create a bookmark for the current Shell buffer."
  `(,(prot-shell-bookmark-name)
    (location . ,default-directory)
    (shell-file-name . ,sh-shell-file)
    (handler . prot-shell-bookmark-jump)))

;;;###autoload
(defun prot-shell-bookmark-jump (bookmark)
  "Default BOOKMARK handler for Shell buffers."
  (let ((default-directory (bookmark-prop-get bookmark 'location))
        (explicit-shell-file-name (bookmark-prop-get bookmark 'shell-file-name)))
    (shell (get-buffer-create (car bookmark)))))

(put 'prot-shell-bookmark-jump 'bookmark-handler-type "Shell")

;; ;;;; Convert YouTube links to Invidious
;;
;; (defvar prot-shell-invidious-domains
;;   '("invidious.io.lol"
;;     "invidious.lunar.icu"
;;     "iv.nboeck.de"
;;     "vid.priv.au"
;;     "invidious.tiekoetter.com"
;;     "inv.in.projectsegfau.lt"
;;     "onion.tube"
;;     "yt.artemislena.eu"
;;     "invidious.no-logs.com"
;;     "yewtu.be"
;;     "invidious.projectsegfau.lt"
;;     "yt.oelrichsgarcia.de"
;;     "invidious.0011.lt"
;;     "inv.zzls.xyz"
;;     "inv.bp.projectsegfau.lt"
;;     "invidious.flokinet.to"
;;     "iv.ggtyler.dev"
;;     "invidious.slipfox.xyz"
;;     "vid.puffyan.us"
;;     "inv.pistasjis.net"
;;     "inv.citw.lgbt"
;;     "invidious.protokolla.fi"
;;     "inv.makerlab.tech"
;;     "inv.tux.pizza"
;;     "invidious.privacydev.net")
;;   "List of Invidious domains.")
;;
;; (defvar prot-shell-youtube-domains
;;   '("www.youtube.com"
;;     "youtu.be")
;;   "List of YouTube domains.")
;;
;; (defvar prot-shell-yt-invidious-domains
;;   (append prot-shell-youtube-domains
;;           prot-shell-invidious-domains)
;;   "List of YouTube and Invidious domains.")
;;
;; (defun prot-shell--get-random-invidious-instance ()
;;   "Return `random' index from `prot-shell-invidious-domains'."
;;   (nth
;;    (random (length prot-shell-invidious-domains))
;;    prot-shell-invidious-domains))
;;
;; ;;;###autoload
;; (defun prot-shell-invidious ()
;;   "Convert `prot-shell-yt-invidious-domains' into a random Invidious instance."
;;   (interactive)
;;   (save-excursion
;;     (goto-char (line-beginning-position))
;;     (while (re-search-forward (regexp-opt prot-shell-yt-invidious-domains) (line-end-position) :no-error)
;;       (replace-match (prot-shell--get-random-invidious-instance)))))

;;;; Built-in Emacs commands

;; ;; `comint-input-filter-functions'
;; (defun prot-shell--intercept-input (input)
;;   (when (string-match-p "man " input)
;;     (comint-interrupt-subjob)
;;     ;; TODO 2023-08-18: The idea is to interrupt the input, and split
;;     ;; it such that, say, "man echo" becomes (man "echo")
;;     ;;
;;     ;; (let ((proc (get-buffer-process (current-buffer)))
;; 	;;       (inhibit-read-only t)
;; 	;;       replacement)
;;     ;;   (save-excursion
;;     ;;     (let ((pmark (progn (goto-char (process-mark proc))
;; 	;; 		                (forward-line 0)
;; 	;; 		                (point-marker))))
;; 	;;       (delete-region comint-last-input-end pmark)
;; 	;;       (goto-char (process-mark proc))
;; 	;;       (setq replacement (concat "*** Called command externally ***\n"
;; 	;; 			                    (buffer-substring pmark (point))))
;; 	;;       (delete-region pmark (point))))
;;     ;;   (comint-output-filter proc replacement))
;;     ))
;;
;; (add-hook 'comint-input-filter-functions #'prot-shell--intercept-input)

;;;; General commands

(defun prot-shell--history-or-motion (history-fn motion-fn arg)
  "Call HISTORY-FN or MOTION-FN with ARG depending on where point is.
If `prot-shell--beginning-of-prompt-p' returns non-nil call
HISTORY-FN, else MOTION-FN."
  (let ((fn (if (or (prot-shell--beginning-of-prompt-p)
                    (eq last-command 'comint-next-input)
                    (eq last-command 'comint-previous-input))
                history-fn
              motion-fn)))
    (funcall-interactively fn arg)
    (setq this-command fn)))

;;;###autoload
(defun prot-shell-up-dwim (arg)
  "Return previous ARGth history input or go ARGth lines up.
If point is at the beginning of a shell prompt, return previous
input, otherwise perform buffer motion."
  (interactive "^p")
  (prot-shell--history-or-motion 'comint-previous-input 'previous-line arg))

;;;###autoload
(defun prot-shell-down-dwim (arg)
  "Return next ARGth history input or or go ARGth lines down.
If point is at the beginning of a shell prompt, return previous
input, otherwise perform buffer motion."
  (interactive "^p")
  (prot-shell--history-or-motion 'comint-next-input 'next-line arg))

;;;###autoload
(defun prot-shell ()
  "Like `shell' but always start a new shell.
Name the shell buffer after the `default-directory'.  If the name of
that buffer already exists, then reuse it."
  (interactive)
  (with-current-buffer (shell (format "*prot-shell in %s*" default-directory))
    (add-hook 'comint-output-filter-functions #'prot-shell-update-name-on-cd nil :local)))

;;;; Minor mode setup

(defvar-keymap prot-shell-mode-map
  :doc "Key map for `prot-shell-mode'."
  "&lt;up&gt;" #'prot-shell-up-dwim
  "&lt;down&gt;" #'prot-shell-down-dwim
  "C-c C-d" #'prot-shell-cd
  ;; "C-c C-i" #'prot-shell-invidious
  "C-c C-j" #'prot-shell-input-from-history
  "C-c C-." #'prot-shell-cd-vc-root-dir
  "C-c C-r" #'prot-shell-cd-vc-root-dir)

(define-minor-mode prot-shell-mode
  "Provide extra functionality for the Emacs `shell'.
Add a bookmark handler for shell buffer and activate the
`prot-shell-mode-map':
\\{prot-shell-mode-map}"
  :init-value nil
  :global nil
  (if prot-shell-mode
      (progn
        (add-hook 'comint-output-filter-functions #'prot-shell-track-cd nil :local)
        (setq-local bookmark-make-record-function #'prot-shell-bookmark-make-record))
    (remove-hook 'comint-output-filter-functions #'prot-shell-track-cd :local)
    (setq-local bookmark-make-record-function nil)))

(provide 'prot-shell)
;;; prot-shell.el ends here
</pre>
</div>
</div>
</div>
<div id="outline-container-h:5f78e837-0d27-4390-bd9a-6d0bca57fa50" class="outline-3">
<h3 id="h:5f78e837-0d27-4390-bd9a-6d0bca57fa50"><span class="section-number-3">6.19.</span> The <code>prot-simple.el</code> library</h3>
<div class="outline-text-3" id="text-h:5f78e837-0d27-4390-bd9a-6d0bca57fa50">
<div class="org-src-container">
<pre class="src src-emacs-lisp">;;; prot-simple.el --- Common commands for my dotemacs -*- lexical-binding: t -*-

;; Copyright (C) 2020-2024  Protesilaos Stavrou

;; Author: Protesilaos Stavrou &lt;info@protesilaos.com&gt;
;; URL: https://protesilaos.com/emacs/dotemacs
;; Version: 0.1.0
;; Package-Requires: ((emacs "30.1"))

;; This file is NOT part of GNU Emacs.

;; This program is free software; you can redistribute it and/or modify
;; it under the terms of the GNU General Public License as published by
;; the Free Software Foundation, either version 3 of the License, or (at
;; your option) any later version.
;;
;; This program is distributed in the hope that it will be useful,
;; but WITHOUT ANY WARRANTY; without even the implied warranty of
;; MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
;; GNU General Public License for more details.
;;
;; You should have received a copy of the GNU General Public License
;; along with this program.  If not, see &lt;https://www.gnu.org/licenses/&gt;.

;;; Commentary:
;;
;; Common commands for my Emacs: &lt;https://protesilaos.com/emacs/dotemacs/&gt;.
;;
;; Remember that every piece of Elisp that I write is for my own
;; educational and recreational purposes.  I am not a programmer and I
;; do not recommend that you copy any of this if you are not certain of
;; what it does.

;;; Code:

(eval-when-compile
  (require 'cl-lib))
(require 'prot-common)

(defgroup prot-simple ()
  "Generic utilities for my dotemacs."
  :group 'editing)

(defcustom prot-simple-date-specifier "%F"
  "Date specifier for `format-time-string'.
Used by `prot-simple-inset-date'."
  :type 'string
  :group 'prot-simple)

(defcustom prot-simple-time-specifier "%R %z"
  "Time specifier for `format-time-string'.
Used by `prot-simple-inset-date'."
  :type 'string
  :group 'prot-simple)

;;; Commands

;;;; General commands

(defun prot-simple--mark (bounds)
  "Mark between BOUNDS as a cons cell of beginning and end positions."
  (push-mark (car bounds))
  (goto-char (cdr bounds))
  (activate-mark))

;;;###autoload
(defun prot-simple-sudo ()
  "Find the current file or directory using SUDO."
  (interactive)
  (let ((destination (or buffer-file-name default-directory)))
    (if (string= (file-remote-p destination 'method) "sudo")
        (user-error "Already using `sudo'")
      (find-file (format "/sudo::/%s" destination)))))

;;;###autoload
(defun prot-simple-mark-sexp ()
  "Mark symbolic expression at or near point.
Repeat to extend the region forward to the next symbolic
expression."
  (interactive)
  (if (and (region-active-p)
           (eq last-command this-command))
      (ignore-errors (forward-sexp 1))
    (when-let* ((thing (cond
                        ((thing-at-point 'url) 'url)
                        ((thing-at-point 'sexp) 'sexp)
                        ((thing-at-point 'string) 'string)
                        ((thing-at-point 'word) 'word))))
      (prot-simple--mark (bounds-of-thing-at-point thing)))))

;;;###autoload
(defun prot-simple-keyboard-quit-dwim ()
  "Do-What-I-Mean behaviour for a general `keyboard-quit'.

The generic `keyboard-quit' does not do the expected thing when
the minibuffer is open.  Whereas we want it to close the
minibuffer, even without explicitly focusing it.

The DWIM behaviour of this command is as follows:

- When the region is active, disable it.
- When a minibuffer is open, but not focused, close the minibuffer.
- When the Completions buffer is selected, close it.
- In every other case use the regular `keyboard-quit'."
  (interactive)
  (cond
   ((region-active-p)
    (keyboard-quit))
   ((derived-mode-p 'completion-list-mode)
    (delete-completion-window))
   ((&gt; (minibuffer-depth) 0)
    (abort-recursive-edit))
   (t
    (keyboard-quit))))

;; DEPRECATED 2023-12-26: I have not used `prot-simple-describe-symbol'
;; since a very long time.  The idea is fine, but having a key binding
;; to provide a shortcut for C-h o RET is wasteful.

;; (autoload 'symbol-at-point "thingatpt")
;;
;; ;;;###autoload
;; (defun prot-simple-describe-symbol ()
;;   "Run `describe-symbol' for the `symbol-at-point'."
;;   (interactive)
;;   (describe-symbol (symbol-at-point)))

;; DEPRECATED 2023-12-26: The `prot-simple-goto-definition' is a good
;; idea but it needs more work.  Ultimately though, it is easier to
;; just produce a Help buffer and just go to the source from there by
;; typing 's'.

;; (declare-function help--symbol-completion-table "help-fns" (string pred action))
;;
;; ;;;###autoload
;; (defun prot-simple-goto-definition (symbol)
;;   "Prompt for SYMBOL and go to its source.
;; When called from Lisp, SYMBOL is a string."
;;   (interactive
;;    (list
;;     (completing-read "Go to source of SYMBOL: "
;;                      #'help--symbol-completion-table
;;                      nil :require-match)))
;;   (xref-find-definitions symbol))

;; DEPRECATED 2023-12-26: I have no need for these commands.  I was
;; just experimenting with a simple implementation.  It is not robust.
;; I can fix it, but I will still not use it, so I am deprecating it
;; instead.

;; (autoload 'number-at-point "thingatpt")
;;
;; (defun prot-simple--number-operate (number amount operation)
;;   "Perform OPERATION on NUMBER given AMOUNT and return the result.
;; OPERATION is the keyword `:increment' or `:decrement' to perform
;; `1+' or `1-', respectively."
;;   (when (and (numberp number) (numberp amount))
;;     (let ((fn (pcase operation
;;                 (:increment #'+)
;;                 (:decrement #'-)
;;                 (_ (user-error "Unknown operation `%s' for number `%s'" operation number)))))
;;       (funcall fn number amount))))
;;
;; (defun prot-simple--number-replace (number amount operation)
;;   "Perform OPERATION on NUMBER at point by AMOUNT."
;;   (when-let* ((bounds (bounds-of-thing-at-point 'number))
;;               (replacement (prot-simple--number-operate number amount operation)))
;;     (delete-region (car bounds) (cdr bounds))
;;     (save-excursion
;;       (insert (number-to-string replacement)))))
;;
;; ;;;###autoload
;; (defun prot-simple-number-increment (number amount)
;;   "Increment NUMBER by AMOUNT.
;; When called interactively, NUMBER is the one at point, while
;; AMOUNT is either 1 or that of a number prefix argument."
;;   (interactive
;;    (list
;;     (number-at-point)
;;     (prefix-numeric-value current-prefix-arg)))
;;   (prot-simple--number-replace number amount :increment))
;;
;; ;;;###autoload
;; (defun prot-simple-number-decrement (number amount)
;;   "Decrement NUMBER by AMOUNT.
;; When called interactively, NUMBER is the one at point, while
;; AMOUNT is either 1 or that of a number prefix argument."
;;   (interactive
;;    (list
;;     (number-at-point)
;;     (prefix-numeric-value current-prefix-arg)))
;;   (prot-simple--number-replace number amount :decrement))

;;;; Commands for lines

;;;###autoload
(defun prot-simple-new-line-below (n)
  "Create N empty lines below the current one.
When called interactively without a prefix numeric argument, N is
1."
  (interactive "p")
  (goto-char (line-end-position))
  (dotimes (_ n) (insert "\n")))

;;;###autoload
(defun prot-simple-new-line-above (n)
  "Create N empty lines above the current one.
When called interactively without a prefix numeric argument, N is
1."
  (interactive "p")
  (let ((point-min (point-min)))
    (if (or (bobp)
            (eq (point) point-min)
            (eq (line-number-at-pos point-min) 1))
        (progn
          (goto-char (line-beginning-position))
          (dotimes (_ n) (insert "\n"))
          (forward-line (- n)))
      (forward-line (- n))
      (prot-simple-new-line-below n))))

;;;###autoload
(defun prot-simple-copy-line ()
  "Copy the current line to the `kill-ring'."
  (interactive)
  (copy-region-as-kill (line-beginning-position) (line-end-position)))

(make-obsolete 'prot-simple-copy-line-or-region 'prot-simple-copy-line "2023-09-26")

;;;###autoload
(defun prot-simple-kill-ring-save (beg end)
  "Copy the current region or line.
When the region is active, use `kill-ring-save' between the BEG and END
positions.  Otherwise, copy the current line."
  (interactive "r")
  (if (region-active-p)
      (kill-ring-save beg end)
    (prot-simple-copy-line)))

(defun prot-simple--duplicate-buffer-substring (boundaries)
  "Duplicate buffer substring between BOUNDARIES.
BOUNDARIES is a cons cell representing buffer positions."
  (unless (consp boundaries)
    (error "`%s' is not a cons cell" boundaries))
  (let ((beg (car boundaries))
        (end (cdr boundaries)))
    (goto-char end)
    (newline)
    (insert (buffer-substring-no-properties beg end))))

;;;###autoload
(defun prot-simple-duplicate-line-or-region ()
  "Duplicate the current line or active region."
  (interactive)
  (unless mark-ring                  ; needed when entering a new buffer
    (push-mark (point) t nil))
  (prot-simple--duplicate-buffer-substring
   (if (region-active-p)
       (cons (region-beginning) (region-end))
     (cons (line-beginning-position) (line-end-position)))))

;;;###autoload
(defun prot-simple-yank-replace-line-or-region ()
  "Replace line or region with latest kill.
This command can then be followed by the standard
`yank-pop' (default is bound to \\[yank-pop])."
  (interactive)
  (if (use-region-p)
      (delete-region (region-beginning) (region-end))
    (delete-region (line-beginning-position) (line-end-position)))
  (yank))

;;;###autoload
(defun prot-simple-multi-line-below ()
  "Move half a screen below."
  (interactive)
  (forward-line (floor (window-height) 2))
  (setq this-command 'scroll-up-command))

;;;###autoload
(defun prot-simple-multi-line-above ()
  "Move half a screen above."
  (interactive)
  (forward-line (- (floor (window-height) 2)))
  (setq this-command 'scroll-down-command))

;;;###autoload
(defun prot-simple-kill-line-backward ()
  "Kill from point to the beginning of the line."
  (interactive)
  (kill-line 0))

;;;###autoload
(define-minor-mode prot-simple-auto-fill-visual-line-mode
  "Enable `visual-line-mode' and disable `auto-fill-mode' in the current buffer."
  :global nil
  (if prot-simple-auto-fill-visual-line-mode
      (progn
        (auto-fill-mode -1)
        (visual-line-mode 1))
    (auto-fill-mode 1)
    (visual-line-mode -1)))

;;;; Commands for text insertion or manipulation

;;;###autoload
(defun prot-simple-insert-date (&amp;optional arg)
  "Insert the current date as `prot-simple-date-specifier'.

With optional prefix ARG (\\[universal-argument]) also append the
current time understood as `prot-simple-time-specifier'.

When region is active, delete the highlighted text and replace it
with the specified date."
  (interactive "P")
  (let* ((date prot-simple-date-specifier)
         (time prot-simple-time-specifier)
         (format (if arg (format "%s %s" date time) date)))
    (when (use-region-p)
      (delete-region (region-beginning) (region-end)))
    (insert (format-time-string format))))

(defun prot-simple--pos-url-on-line (char)
  "Return position of `prot-common-url-regexp' at CHAR."
  (when (integer-or-marker-p char)
    (save-excursion
      (goto-char char)
      (re-search-forward prot-common-url-regexp (line-end-position) :noerror))))

;;;###autoload
(defun prot-simple-escape-url-line (char)
  "Escape all URLs or email addresses on the current line.
When called from Lisp CHAR is a buffer position to operate from
until the end of the line.  In interactive use, CHAR corresponds
to `line-beginning-position'."
  (interactive
   (list
    (if current-prefix-arg
        (re-search-forward
         prot-common-url-regexp
         (line-end-position) :no-error
         (prefix-numeric-value current-prefix-arg))
      (line-beginning-position))))
  (when-let* ((regexp-end (prot-simple--pos-url-on-line char)))
    (goto-char regexp-end)
    (unless (looking-at "&gt;")
      (insert "&gt;")
      (when (search-backward "\s" (line-beginning-position) :noerror)
        (forward-char 1))
      (insert "&lt;"))
    (prot-simple-escape-url-line (1+ regexp-end)))
  (goto-char (line-end-position)))

;; Thanks to Bruno Boal for the original `prot-simple-escape-url-region'.
;; Check Bruno's Emacs config: &lt;https://github.com/BBoal/emacs-config&gt;.

;;;###autoload
(defun prot-simple-escape-url-region (&amp;optional beg end)
  "Apply `prot-simple-escape-url-line' on region lines between BEG and END."
  (interactive
   (if (region-active-p)
       (list (region-beginning) (region-end))
     (error "There is no region!")))
  (let ((beg (min beg end))
        (end (max beg end)))
    (save-excursion
      (goto-char beg)
      (setq beg (line-beginning-position))
      (while (&lt;= beg end)
        (prot-simple-escape-url-line beg)
        (beginning-of-line 2)
        (setq beg (point))))))

;;;###autoload
(defun prot-simple-escape-url-dwim ()
  "Escape URL on the current line or lines implied by the active region.
Call the commands `prot-simple-escape-url-line' and
`prot-simple-escape-url-region' ."
  (interactive)
  (if (region-active-p)
      (prot-simple-escape-url-region (region-beginning) (region-end))
    (prot-simple-escape-url-line (line-beginning-position))))

;;;###autoload
(defun prot-simple-zap-to-char-backward (char &amp;optional arg)
  "Backward `zap-to-char' for CHAR.
Optional ARG is a numeric prefix to match ARGth occurance of
CHAR."
  (interactive
   (list
    (read-char-from-minibuffer "Zap to char: " nil 'read-char-history)
    (prefix-numeric-value current-prefix-arg)))
  (zap-to-char (- arg) char t))

(defvar prot-simple-flush-and-diff-history nil
  "Minibuffer history for `prot-simple-flush-and-diff'.")

;;;###autoload
(defun prot-simple-flush-and-diff (regexp beg end)
  "Call `flush-lines' for REGEXP and produce diff if file is modified.
When region is active, operate between the region boundaries
demarcated by BEG and END."
  (interactive
   (let ((regionp (region-active-p)))
     (list
      (read-regexp "Flush lines using REGEXP: " nil 'prot-simple-flush-and-diff-history)
      (and regionp (region-beginning))
      (and regionp (region-end)))))
  (flush-lines regexp (or beg (point-min)) (or end (point-max)) :no-message)
  (when (and (buffer-modified-p) buffer-file-name)
    (diff-buffer-with-file (current-buffer))))

;; FIXME 2023-09-28: The line prefix is problematic.  I plan to rewrite it.

;; (defcustom prot-simple-line-prefix-strings '("&gt;" "+" "-")
;;   "List of strings used as line prefixes.
;; The command which serves as the point of entry is
;; `prot-simple-insert-line-prefix'."
;;   :type '(repeat string)
;;   :group 'prot-simple)
;;
;; (defun prot-simple--line-prefix-regexp (&amp;optional string)
;;   "Format regular expression for `prot-simple--line-prefix-p'.
;; With optional STRING use it directly.  Else format the regexp by
;; concatenating `prot-simple-line-prefix-strings'."
;;   (if string
;;       (format "^%s " string)
;;     (format "^[%s] " (apply #'concat prot-simple-line-prefix-strings))))
;;
;; (defun prot-simple--line-prefix-p (&amp;optional string)
;;   "Return non-nil if line beginning has an appropriate string prefix.
;; With optional STRING test that it is at the beginning of the line."
;;   (save-excursion
;;     (goto-char (line-beginning-position))
;;     (looking-at (prot-simple--line-prefix-regexp string))))
;;
;; (defun prot-simple--line-prefix-insert (string)
;;   "Insert STRING at the beginning of the line, followed by a space."
;;   (save-excursion
;;     (goto-char (line-beginning-position))
;;     (insert string)
;;     (insert " ")))
;;
;; (defun prot-simple--line-prefix-infer-string ()
;;   "Return line prefix string if it matches `prot-simple--line-prefix-p'."
;;   (when (prot-simple--line-prefix-p)
;;     (string-trim
;;      (buffer-substring-no-properties (match-beginning 0) (match-end 0)))))
;;
;; (defun prot-simple--line-prefix-toggle (string)
;;   "Insert or remove STRING at the beginning of the line."
;;   (if (prot-simple--line-prefix-p string)
;;       (delete-region (match-beginning 0) (match-end 0))
;;     (prot-simple--line-prefix-insert string)))
;;
;; (defvar prot-simple--line-prefix-history nil
;;   "Minibuffer history of `prot-simple--line-prefix-prompt'.")
;;
;; (defun prot-simple--line-prefix-prompt ()
;;   "Prompt for string to use as line prefix.
;; Provide `prot-simple-line-prefix-strings' as completion
;; candidates, though accept arbitrary input."
;;   (let ((default (car prot-simple--line-prefix-history)))
;;     (completing-read
;;      (format-prompt "Select line prefix" default)
;;      prot-simple-line-prefix-strings
;;      nil nil nil
;;      'prot-simple--line-prefix-history default)))
;;
;; (defun prot-simple-line-prefix-infer-or-prompt ()
;;   "Infer string for line prefix or prompt for one."
;;   (or (prot-simple--line-prefix-infer-string)
;;       (prot-simple--line-prefix-prompt)))
;;
;; ;;;###autoload
;; (defun prot-simple-insert-line-prefix-dwim (string)
;;   "Toggle presence of STRING at the beginning of the line.
;;
;; When called interactively try to infer STRING based on the line
;; prefix.  If one is found among `prot-simple-line-prefix-strings',
;; perform a removal outright.
;;
;; If no string can be inferred, prompt for STRING among
;; `prot-simple-line-prefix-strings'.  Accept arbitrary strings at
;; the prompt.
;;
;; When the region is active, toggle the presence of STRING for each
;; line in the region."
;;   (interactive (list (prot-simple-line-prefix-infer-or-prompt)))
;;   (if-let* ((region-p (region-active-p))
;;             (beg (region-beginning))
;;             (end (line-number-at-pos (region-end))))
;;       (progn
;;         (goto-char beg)
;;         (push-mark (point))
;;         (while (&lt;= (line-number-at-pos (point)) end)
;;           (prot-simple--line-prefix-toggle string)
;;           (forward-line 1)))
;;     (prot-simple--line-prefix-toggle string)))

;;;; Commands for object transposition

;; The "move" functions all the way to `prot-simple-move-below-dwim'
;; are courtesy of Bruno Boal: &lt;https://git.sr.ht/~bboal&gt;.  With minor
;; tweaks by me.
(defun prot-simple--move-line (count dir)
  "Move line or region COUNTth times in DIR direction."
  (let* ((start (pos-bol))
         (end (pos-eol))
         diff-eol-point
         diff-eol-mark)
    (when-let* (((use-region-p))
                (pos (point))
                (mrk (mark))
                (line-diff-mark-point (1+ (- (line-number-at-pos mrk)
                                             (line-number-at-pos pos)))))
      (if (&gt; pos mrk)
          (setq start (pos-bol line-diff-mark-point)) ; pos-bol of where the mark is
        (setq end (pos-eol line-diff-mark-point)))    ; pos-eol of the line where the mark is
      (setq diff-eol-mark (1+ (- end mrk))))          ; 1+ to get the \n
    ;; this is valid for region or a single line
    (setq diff-eol-point (1+ (- end (point))))
    (let* ((max (point-max))
           (end (1+ end))
           (end (if (&gt; end max) max end))
           (deactivate-mark)
           (lines (delete-and-extract-region start end)))
      (forward-line (* count dir))
      ;; Handle the special case when there isn't a newline as the eob.
      (when (and (eq (point) max)
                 (/= (current-column) 0))
        (insert "\n"))
      (insert lines)
      ;; if user provided a region
      (when diff-eol-mark
        (set-mark (- (point) diff-eol-mark)))
      ;; either way go to same point location reference initial motion
      (goto-char (- (point) diff-eol-point)))))

(defun prot-simple--move-line-user-error (boundary)
  "Return `user-error' with message accounting for BOUNDARY.
BOUNDARY is a buffer position, expected to be `point-min' or `point-max'."
  (when-let* ((bound (line-number-at-pos boundary))
              (scope (cond
                      ((and (use-region-p)
                            (or (= (line-number-at-pos (point)) bound)
                                (= (line-number-at-pos (mark)) bound)))
                       "region is ")
                      ((= (line-number-at-pos (point)) bound)
                       "")
                      (t nil))))
    (user-error (format "Warning: %salready in the last line!" scope))))

(defun prot-simple-move-above-dwim (arg)
  "Move line or region ARGth times up.
If ARG is nil, do it one time."
  (interactive "p")
  (unless (prot-simple--move-line-user-error (point-min))
    (prot-simple--move-line arg -1)))

(defun prot-simple-move-below-dwim (arg)
  "Move line or region ARGth times down.
If ARG is nil, do it one time."
  (interactive "p")
  (unless (prot-simple--move-line-user-error (point-max))
    (prot-simple--move-line arg 1)))

(defmacro prot-simple-define-transpose (scope)
  "Define transposition command for SCOPE.
SCOPE is the text object to operate on.  The command's name is
prot-simple-transpose-SCOPE."
  `(defun ,(intern (format "prot-simple-transpose-%s" scope)) (arg)
     ,(format "Transpose %s.
Transposition over an active region will swap the object at
the region beginning with the one at the region end." scope)
     (interactive "p")
     (let ((fn (intern (format "%s-%s" "transpose" ,scope))))
       (if (use-region-p)
           (funcall fn 0)
         (funcall fn arg)))))

;;;###autoload (autoload 'prot-simple-transpose-lines "prot-simple")
;;;###autoload (autoload 'prot-simple-transpose-paragraphs "prot-simple")
;;;###autoload (autoload 'prot-simple-transpose-sentences "prot-simple")
;;;###autoload (autoload 'prot-simple-transpose-sexps "prot-simple")
;;;###autoload (autoload 'prot-simple-transpose-words "prot-simple")
(prot-simple-define-transpose "lines")
(prot-simple-define-transpose "paragraphs")
(prot-simple-define-transpose "sentences")
(prot-simple-define-transpose "sexps")
(prot-simple-define-transpose "words")

;;;###autoload
(defun prot-simple-transpose-chars ()
  "Always transposes the two characters before point.
There is no dragging the character forward.  This is the
behaviour of `transpose-chars' when point is at the end of the
line."
  (interactive)
  (transpose-chars -1)
  (forward-char))

;;;; Commands for paragraphs

;;;###autoload
(defun prot-simple-unfill-region-or-paragraph (&amp;optional beg end)
  "Unfill paragraph or, when active, the region.
Join all lines in region delimited by BEG and END, if active,
while respecting any empty lines (so multiple paragraphs are not
joined, just unfilled).  If no region is active, operate on the
paragraph.  The idea is to produce the opposite effect of both
`fill-paragraph' and `fill-region'."
  (interactive "r")
  (let ((fill-column most-positive-fixnum))
    (if (use-region-p)
        (fill-region beg end)
      (fill-paragraph))))

;;;; Commands for windows and pages

;;;###autoload
(defun prot-simple-other-window ()
  "Wrapper for `other-window' and `next-multiframe-window'.
If there is only one window and multiple frames, call
`next-multiframe-window'.  Otherwise, call `other-window'."
  (interactive)
  (if (and (one-window-p) (length&gt; (frame-list) 1))
      (progn
        (call-interactively #'next-multiframe-window)
        (setq this-command #'next-multiframe-window))
    (call-interactively #'other-window)
    (setq this-command #'other-window)))

;;;###autoload
(defun prot-simple-narrow-visible-window ()
  "Narrow buffer to wisible window area.
Also check `prot-simple-narrow-dwim'."
  (interactive)
  (let* ((bounds (prot-common-window-bounds))
         (window-area (- (cdr bounds) (car bounds)))
         (buffer-area (- (point-max) (point-min))))
    (if (/= buffer-area window-area)
        (narrow-to-region (car bounds) (cdr bounds))
      (user-error "Buffer fits in the window; won't narrow"))))

;;;###autoload
(defun prot-simple-narrow-dwim ()
  "Do-what-I-mean narrowing.
If region is active, narrow the buffer to the region's
boundaries.

If pages are defined by virtue of `prot-common-page-p', narrow to
the current page boundaries.

If no region is active and no pages exist, narrow to the visible
portion of the window.

If narrowing is in effect, widen the view."
  (interactive)
  (unless mark-ring                  ; needed when entering a new buffer
    (push-mark (point) t nil))
  (cond
   ((and (use-region-p)
         (null (buffer-narrowed-p)))
    (narrow-to-region (region-beginning) (region-end)))
   ((prot-common-page-p)
    (narrow-to-page))
   ((null (buffer-narrowed-p))
    (prot-simple-narrow-visible-window))
   ((widen))))

(defun prot-simple--narrow-to-page (count &amp;optional back)
  "Narrow to COUNTth page with optional BACK motion."
  (if back
      (narrow-to-page (or (- count) -1))
    (narrow-to-page (or (abs count) 1)))
  ;; Avoids the problem of skipping pages while cycling back and forth.
  (goto-char (point-min)))

;;;###autoload
(defun prot-simple-forward-page-dwim (&amp;optional count)
  "Move to next or COUNTth page forward.
If buffer is narrowed to the page, keep the effect while
performing the motion.  Always move point to the beginning of the
narrowed page."
  (interactive "p")
  (if (buffer-narrowed-p)
      (prot-simple--narrow-to-page count)
    (forward-page count)
    (setq this-command 'forward-page)))

;;;###autoload
(defun prot-simple-backward-page-dwim (&amp;optional count)
  "Move to previous or COUNTth page backward.
If buffer is narrowed to the page, keep the effect while
performing the motion.  Always move point to the beginning of the
narrowed page."
  (interactive "p")
  (if (buffer-narrowed-p)
      (prot-simple--narrow-to-page count t)
    (backward-page count)
    (setq this-command 'backward-page)))

;;;###autoload
(defun prot-simple-delete-page-delimiters (&amp;optional beg end)
  "Delete lines with just page delimiters in the current buffer.
When region is active, only operate on the region between BEG and
END, representing the point and mark."
  (interactive "r")
  (let (b e)
    (if (use-region-p)
        (setq b beg
              e end)
      (setq b (point-min)
            e (point-max)))
    (widen)
    (flush-lines (format "%s$" page-delimiter) b e)
    (setq this-command 'flush-lines)))

;; NOTE 2023-06-18: The idea of narrowing to a defun in an indirect
;; buffer is still experimental.
(defun prot-simple-narrow--guess-defun-symbol ()
  "Try to return symbol of current defun as a string."
  (save-excursion
    (beginning-of-defun)
    (search-forward " ")
    (thing-at-point 'symbol :no-properties)))

;;;###autoload
(defun prot-simple-narrow-to-cloned-buffer ()
  "Narrow to defun in cloned buffer.
Name the buffer after the defun's symbol."
  (interactive)
  (clone-indirect-buffer-other-window
   (format "%s -- %s"
           (buffer-name)
           (prot-simple-narrow--guess-defun-symbol))
   :display)
  (narrow-to-defun))

;;;; Commands for buffers

(defun prot-simple--display-unsaved-buffers (buffers buffer-menu-name)
  "Produce buffer menu listing BUFFERS called BUFFER-MENU-NAME."
  (let ((old-buf (current-buffer))
        (buf (get-buffer-create buffer-menu-name)))
    (with-current-buffer buf
      (Buffer-menu-mode)
      (setq-local Buffer-menu-files-only nil
                  Buffer-menu-buffer-list buffers
                  Buffer-menu-filter-predicate nil)
      (list-buffers--refresh buffers old-buf)
      (tabulated-list-print))
    (display-buffer buf)))

(defun prot-simple--get-unsaved-buffers ()
  "Get list of unsaved buffers."
  (seq-filter
   (lambda (buffer)
     (and (buffer-file-name buffer)
          (buffer-modified-p buffer)))
   (buffer-list)))

;;;###autoload
(defun prot-simple-display-unsaved-buffers ()
  "Produce buffer menu listing unsaved file-visiting buffers."
  (interactive)
  (if-let* ((unsaved-buffers (prot-simple--get-unsaved-buffers)))
      (prot-simple--display-unsaved-buffers unsaved-buffers "*Unsaved buffers*")
    (message "No unsaved buffers")))

(defun prot-simple-display-unsaved-buffers-on-exit (&amp;rest _)
  "Produce buffer menu listing unsaved file-visiting buffers.
Add this as :before advice to `save-buffers-kill-emacs'."
  (when-let* ((unsaved-buffers (prot-simple--get-unsaved-buffers)))
    (prot-simple--display-unsaved-buffers unsaved-buffers "*Unsaved buffers*")))

;;;###autoload
(defun prot-simple-copy-current-buffer-name ()
  "Add the current buffer's name to the `kill-ring'."
  (declare (interactive-only t))
  (interactive)
  (kill-new (buffer-name (current-buffer))))

;;;###autoload
(defun prot-simple-copy-current-buffer-file ()
  "Add the current buffer's file path to the `kill-ring'."
  (declare (interactive-only t))
  (interactive)
  (if buffer-file-name
      (kill-new buffer-file-name)
    (user-error "%s is not associated with a file" (buffer-name (current-buffer)))))

;;;###autoload
(defun prot-simple-kill-buffer (buffer)
  "Kill current BUFFER without confirmation.
When called interactively, prompt for BUFFER."
  (interactive (list (read-buffer "Select buffer: ")))
  (let ((kill-buffer-query-functions nil))
    (kill-buffer (or buffer (current-buffer)))))

;;;###autoload
(defun prot-simple-kill-buffer-current (&amp;optional arg)
  "Kill current buffer.
With optional prefix ARG (\\[universal-argument]) delete the
buffer's window as well.  Kill the window regardless of ARG if it
satisfies `prot-common-window-small-p' and it has no previous
buffers in its history."
  (interactive "P")
  (let ((kill-buffer-query-functions nil))
    (if (or (and (prot-common-window-small-p)
                 (null (window-prev-buffers)))
            (and arg (not (one-window-p))))
        (kill-buffer-and-window)
      (kill-buffer))))

;;;###autoload
(defun prot-simple-rename-file-and-buffer (name)
  "Apply NAME to current file and rename its buffer.
Do not try to make a new directory or anything fancy."
  (interactive
   (list (read-string "Rename current file: " (buffer-file-name))))
  (let ((file (buffer-file-name)))
    (if (vc-registered file)
        (vc-rename-file file name)
      (rename-file file name))
    (set-visited-file-name name t t)))

(defun prot-simple--buffer-major-mode-prompt ()
  "Prompt of `prot-simple-buffers-major-mode'.
Limit list of buffers to those matching the current
`major-mode' or its derivatives."
  (let ((read-buffer-function nil)
        (current-major-mode major-mode))
    (read-buffer
     (format "Buffer for %s: " major-mode)
     nil
     :require-match
     (lambda (pair) ; pair is (name-string . buffer-object)
       (with-current-buffer (cdr pair)
         (derived-mode-p current-major-mode))))))

;;;###autoload
(defun prot-simple-buffers-major-mode ()
  "Select BUFFER matching the current one's major mode."
  (interactive)
  (switch-to-buffer (prot-simple--buffer-major-mode-prompt)))

(defun prot-simple--buffer-vc-root-prompt ()
  "Prompt of `prot-simple-buffers-vc-root'."
  (let ((root (or (vc-root-dir)
                  (locate-dominating-file "." ".git")))
        (read-buffer-function nil))
    (read-buffer
     (format "Buffers in %s: " root)
     nil t
     (lambda (pair) ; pair is (name-string . buffer-object)
       (with-current-buffer (cdr pair) (string-match-p root default-directory))))))

;;;###autoload
(defun prot-simple-buffers-vc-root ()
  "Select buffer matching the current one's VC root."
  (interactive)
  (switch-to-buffer (prot-simple--buffer-vc-root-prompt)))

;;;###autoload
(defun prot-simple-swap-window-buffers (counter)
  "Swap states of live buffers.
With two windows, transpose their buffers.  With more windows,
perform a clockwise rotation.  Do not alter the window layout.
Just move the buffers around.

With COUNTER as a prefix argument, do the rotation
counter-clockwise."
  (interactive "P")
  (when-let* ((winlist (if counter (reverse (window-list)) (window-list)))
              (wincount (count-windows))
              ((&gt; wincount 1)))
    (dotimes (i (- wincount 1))
      (window-swap-states (elt winlist i) (elt winlist (+ i 1))))))

;;;; Commands for files

(cl-defmethod register--type ((_regval vector)) 'vector)

(cl-defmethod register-val-describe ((val vector) _verbose)
  (if-let* ((pos (aref val 2))
            (file (aref val 1)))
      (princ (format "%s at position %s" file pos))
    (princ "Garbage data")))

;;;###autoload
(defun prot-simple-file-to-register (register)
  "Store current location of file's point in REGISTER."
  (interactive (list (register-read-with-preview "File with point to register: ")))
  (set-register register (vector 'file-with-point (buffer-file-name) (point))))

(defvar prot-simple-file-to-register-jump-hook nil
  "Normal hook called after jumping to a file register.
See `prot-simple-file-to-register'.")

;;;###autoload
(cl-defmethod register-val-jump-to ((val vector) delete)
  "Handle how to jump to a location register.
This is like the default, but does not ask to visit a file: it does it
outright."
  (cond
   ((eq (aref val 0) 'file-with-point)
    (find-file (aref val 1))
    (goto-char (aref val 2))
    (run-hooks 'prot-simple-file-to-register-jump-hook))
   (t (cl-call-next-method val delete))))

;;;; Commands of a general nature

(autoload 'color-rgb-to-hex "color")
(autoload 'color-name-to-rgb "color")

(defun prot-simple-accessible-colors (variant)
  "Return list of accessible `defined-colors'.
VARIANT is either `dark' or `light'."
  (let ((variant-color (if (eq variant 'black) "#000000" "#ffffff")))
    (seq-filter
     (lambda (c)
       (let* ((rgb (color-name-to-rgb c))
              (r (nth 0 rgb))
              (g (nth 1 rgb))
              (b (nth 2 rgb))
              (hex (color-rgb-to-hex r g b 2)))
         (when (&gt;= (prot-common-contrast variant-color hex) 4.5)
           c)))
     (defined-colors))))

(defun prot-simple--list-accessible-colors-prompt ()
  "Use `read-multiple-choice' to return white or black background."
  (intern
   (cadr
    (read-multiple-choice
     "Variant"
     '((?b "black" "Black background")
       (?w "white" "White background"))
     "Choose between white or black background."))))

;;;###autoload
(defun prot-simple-list-accessible-colors (variant)
  "Return buffer with list of accessible `defined-colors'.
VARIANT is either `dark' or `light'."
  (interactive (list (prot-simple--list-accessible-colors-prompt)))
  (list-colors-display (prot-simple-accessible-colors variant)))

(provide 'prot-simple)
;;; prot-simple.el ends here
</pre>
</div>
</div>
</div>
<div id="outline-container-h:551718b7-fb2d-4a4a-804e-3118001b96ec" class="outline-3">
<h3 id="h:551718b7-fb2d-4a4a-804e-3118001b96ec"><span class="section-number-3">6.20.</span> The <code>prot-spell.el</code> library</h3>
<div class="outline-text-3" id="text-h:551718b7-fb2d-4a4a-804e-3118001b96ec">
<div class="org-src-container">
<pre class="src src-emacs-lisp">;;; prot-spell.el --- Spelling-related extensions for my dotemacs -*- lexical-binding: t -*-

;; Copyright (C) 2021-2024  Protesilaos Stavrou

;; Author: Protesilaos Stavrou &lt;info@protesilaos.com&gt;
;; URL: https://protesilaos.com/emacs/dotemacs
;; Version: 0.1.0
;; Package-Requires: ((emacs "30.1"))

;; This file is NOT part of GNU Emacs.

;; This program is free software; you can redistribute it and/or modify
;; it under the terms of the GNU General Public License as published by
;; the Free Software Foundation, either version 3 of the License, or
;; (at your option) any later version.
;;
;; This program is distributed in the hope that it will be useful,
;; but WITHOUT ANY WARRANTY; without even the implied warranty of
;; MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
;; GNU General Public License for more details.
;;
;; You should have received a copy of the GNU General Public License
;; along with this program.  If not, see &lt;https://www.gnu.org/licenses/&gt;.

;;; Commentary:
;;
;; This covers my spelling-related extensions, for use in my Emacs
;; setup: https://protesilaos.com/emacs/dotemacs.
;;
;; Remember that every piece of Elisp that I write is for my own
;; educational and recreational purposes.  I am not a programmer and I
;; do not recommend that you copy any of this if you are not certain of
;; what it does.

;;; Code:

(require 'ispell)

(defgroup prot-spell ()
  "Extensions for ispell and flyspell."
  :group 'ispell)

(defcustom prot-spell-dictionaries
  '(("EN English" . "en")
    ("EL Ελληνικά" . "el")
    ("FR Français" . "fr")
    ("ES Espanõl" . "es"))
  "Alist of strings with descriptions and dictionary keys.
Used by `prot-spell-change-dictionary'."
  :type 'alist
  :group 'prot-spell)

(defvar prot-spell--dictionary-hist '()
  "Input history for `prot-spell-change-dictionary'.")

(defun prot-spell--dictionary-prompt ()
  "Helper prompt to select from `prot-spell-dictionaries'."
  (let ((def (car prot-spell--dictionary-hist)))
    (completing-read
     (format "Select dictionary [%s]: " def)
     (mapcar #'car prot-spell-dictionaries)
     nil t nil 'prot-spell--dictionary-hist def)))

;;;###autoload
(defun prot-spell-change-dictionary (dictionary)
  "Select a DICTIONARY from `prot-spell-dictionaries'."
  (interactive
   (list (prot-spell--dictionary-prompt)))
  (let* ((key (cdr (assoc dictionary prot-spell-dictionaries)))
         (desc (car (assoc dictionary prot-spell-dictionaries))))
    (ispell-change-dictionary key)
    (message "Switched dictionary to %s" (propertize desc 'face 'bold))))

;;;###autoload
(defun prot-spell-spell-dwim (beg end)
  "Spell check between BEG END, current word, or select a dictionary.

Use `flyspell-region' on the active region and deactivate the
mark.

With point over a word and no active region invoke `ispell-word'.

Else call `prot-spell-change-dictionary'."
  (interactive "r")
  (cond
   ((use-region-p)
    (flyspell-region beg end)
    (deactivate-mark))
   ((thing-at-point 'word)
    (call-interactively 'ispell-word))
   (t
    (call-interactively 'prot-spell-change-dictionary))))

(defun prot-spell-ispell-display-buffer (buffer)
  "Function to override `ispell-display-buffer' for BUFFER.
Use this as `advice-add' to override the aforementioned Ispell
function.  Then you can control the buffer's specifics via
`display-buffer-alist' (how it ought to be!)."
  (pop-to-buffer buffer)
  (set-window-point (get-buffer-window buffer) (point-min)))

(advice-add #'ispell-display-buffer :override #'prot-spell-ispell-display-buffer)

(provide 'prot-spell)
;;; prot-spell.el ends here
</pre>
</div>
</div>
</div>
<div id="outline-container-h:3796a4c9-8659-4782-8aaa-3cf4e950927d" class="outline-3">
<h3 id="h:3796a4c9-8659-4782-8aaa-3cf4e950927d"><span class="section-number-3">6.21.</span> The <code>prot-vertico.el</code> library</h3>
<div class="outline-text-3" id="text-h:3796a4c9-8659-4782-8aaa-3cf4e950927d">
<div class="org-src-container">
<pre class="src src-emacs-lisp">;;; prot-vertico.el --- Custom Vertico extras -*- lexical-binding: t -*-

;; Copyright (C) 2023-2024  Protesilaos Stavrou

;; Author: Protesilaos Stavrou &lt;info@protesilaos.com&gt;
;; URL: https://protesilaos.com/emacs/dotemacs
;; Version: 0.1.0
;; Package-Requires: ((emacs "30.1"))

;; This file is NOT part of GNU Emacs.

;; This program is free software; you can redistribute it and/or modify
;; it under the terms of the GNU General Public License as published by
;; the Free Software Foundation, either version 3 of the License, or (at
;; your option) any later version.
;;
;; This program is distributed in the hope that it will be useful,
;; but WITHOUT ANY WARRANTY; without even the implied warranty of
;; MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
;; GNU General Public License for more details.
;;
;; You should have received a copy of the GNU General Public License
;; along with this program.  If not, see &lt;https://www.gnu.org/licenses/&gt;.

;;; Commentary:
;;
;; Remember that every piece of Elisp that I write is for my own
;; educational and recreational purposes.  I am not a programmer and I
;; do not recommend that you copy any of this if you are not certain of
;; what it does.

;;; Code:

(require 'vertico)

(defvar prot-vertico-multiform-minimal
  '(unobtrusive
    (vertico-flat-format . ( :multiple  ""
                             :single    ""
                             :prompt    ""
                             :separator ""
                             :ellipsis  ""
                             :no-match  ""))
    (vertico-preselect . prompt))
  "List of configurations for minimal Vertico multiform.
The minimal view is intended to be more private or less
revealing.  This is important when, for example, a prompt shows
names of people.  Of course, such a view also provides a minimal
style for general usage.

Toggle the vertical view with the `vertico-multiform-vertical'
command or use the commands `prot-vertico-private-next' and
`prot-vertico-private-previous', which toggle the vertical view
automatically.")

(defvar prot-vertico-multiform-maximal
  '((vertico-count . 10)
    (vertico-preselect . directory)
    (vertico-resize . t))
  "List of configurations for maximal Vertico multiform.")

(defun prot-vertico--match-directory (str)
  "Match directory delimiter in STR."
  (string-suffix-p "/" str))

;; From the Vertico documentation.
(defun prot-vertico-sort-directories-first (files)
  "Sort directories before FILES."
  (setq files (vertico-sort-alpha files))
  (nconc (seq-filter #'prot-vertico--match-directory files)
         (seq-remove #'prot-vertico--match-directory files)))

(defun prot-vertico-private-next ()
  "Like `vertico-next' but toggle vertical view if needed.
This is done to accommodate `prot-vertico-multiform-minimal'."
  (interactive)
  (if vertico-unobtrusive-mode
      (progn
        (vertico-multiform-vertical)
        (vertico-next 1))
    (vertico-next 1)))

(defun prot-vertico-private-previous ()
  "Like `vertico-previous' but toggle vertical view if needed.
This is done to accommodate `prot-vertico-multiform-minimal'."
  (interactive)
  (if vertico-unobtrusive-mode
      (progn
        (vertico-multiform-vertical)
        (vertico-previous 1))
    (vertico-previous 1)))

(defun prot-vertico-private-complete ()
  "Expand contents and show remaining candidates, if needed.
This is done to accommodate `prot-vertico-multiform-minimal'."
  (interactive)
  (if (and vertico-unobtrusive-mode (&gt; vertico--total 1))
      (progn
        (minibuffer-complete)
        (prot-vertico-private-next))
    (vertico-insert)))

(defun prot-vertico-private-exit ()
  "Exit with the candidate if `prot-vertico-multiform-minimal'.
If there are more candidates that match the given input, expand the
minibuffer to show the remaining candidates and select the first one.
Else do `vertico-exit'."
  (interactive)
  (cond
   ((= vertico--total 1)
    (minibuffer-complete)
    (vertico-exit))
   ((and vertico-unobtrusive-mode
         (not minibuffer--require-match)
         (or (string-empty-p (minibuffer-contents))
             minibuffer-default
             (eq vertico-preselect 'directory)
             (eq vertico-preselect 'prompt)))
    (vertico-exit-input))
   ((and vertico-unobtrusive-mode (&gt; vertico--total 1))
    (minibuffer-complete-and-exit)
    (prot-vertico-private-next))
   (t
    (vertico-exit))))

(provide 'prot-vertico)
;;; prot-vertico.el ends here
</pre>
</div>
</div>
</div>
<div id="outline-container-h:35b8a0a5-c447-4301-a404-bc274596238d" class="outline-3">
<h3 id="h:35b8a0a5-c447-4301-a404-bc274596238d"><span class="section-number-3">6.22.</span> The <code>prot-window.el</code> library</h3>
<div class="outline-text-3" id="text-h:35b8a0a5-c447-4301-a404-bc274596238d">
<div class="org-src-container">
<pre class="src src-emacs-lisp">;;; prot-window.el --- Display-buffer and window-related extensions for my dotemacs -*- lexical-binding: t -*-

;; Copyright (C) 2023-2024  Protesilaos Stavrou

;; Author: Protesilaos Stavrou &lt;info@protesilaos.com&gt;
;; URL: https://protesilaos.com/emacs/dotemacs
;; Version: 0.1.0
;; Package-Requires: ((emacs "30.1"))

;; This file is NOT part of GNU Emacs.

;; This program is free software; you can redistribute it and/or modify
;; it under the terms of the GNU General Public License as published by
;; the Free Software Foundation, either version 3 of the License, or
;; (at your option) any later version.
;;
;; This program is distributed in the hope that it will be useful,
;; but WITHOUT ANY WARRANTY; without even the implied warranty of
;; MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
;; GNU General Public License for more details.
;;
;; You should have received a copy of the GNU General Public License
;; along with this program.  If not, see &lt;https://www.gnu.org/licenses/&gt;.

;;; Commentary:
;;
;; This covers my window and display-buffer extensions, for use in my
;; Emacs setup: https://protesilaos.com/emacs/dotemacs.
;;
;; Remember that every piece of Elisp that I write is for my own
;; educational and recreational purposes.  I am not a programmer and I
;; do not recommend that you copy any of this if you are not certain of
;; what it does.

;;; Code:

(require 'prot-common)

(defvar prot-window-window-sizes
  '( :max-height (lambda () (floor (frame-height) 3))
     :min-height 10
     :max-width (lambda () (floor (frame-width) 4))
     :min-width 20)
  "Property list of maximum and minimum window sizes.
The property keys are `:max-height', `:min-height', `:max-width',
and `:min-width'.  They all accept a value of either a
number (integer or floating point) or a function.")

(defun prot-window--get-window-size (key)
  "Extract the value of KEY from `prot-window-window-sizes'."
  (when-let* ((value (plist-get prot-window-window-sizes key)))
    (cond
     ((functionp value)
      (funcall value))
     ((numberp value)
      value)
     (t
      (error "The value of `%s' is neither a number nor a function" key)))))

(defun prot-window-select-fit-size (window)
  "Select WINDOW and resize it.
The resize pertains to the maximum and minimum values for height
and width, per `prot-window-window-sizes'.

Use this as the `body-function' in a `display-buffer-alist' entry."
  (select-window window)
  (fit-window-to-buffer
   window
   (prot-window--get-window-size :max-height)
   (prot-window--get-window-size :min-height)
   (prot-window--get-window-size :max-width)
   (prot-window--get-window-size :min-width))
  ;; If we did not use `display-buffer-below-selected', then we must
  ;; be in a lateral window, which has more space.  Then we do not
  ;; want to dedicate the window to this buffer, because we will be
  ;; running out of space.
  (when (or (window-in-direction 'above) (window-in-direction 'below))
    (set-window-dedicated-p window t)))

(defun prot-window--get-display-buffer-below-or-pop ()
  "Return list of functions for `prot-window-display-buffer-below-or-pop'."
  (list
   #'display-buffer-reuse-mode-window
   (if (or (prot-common-window-small-p)
           (prot-common-three-or-more-windows-p))
       #'display-buffer-below-selected
     #'display-buffer-pop-up-window)))

(defun prot-window-display-buffer-below-or-pop (&amp;rest args)
  "Display buffer below current window or pop a new window.
The criterion for choosing to display the buffer below the
current one is a non-nil return value for
`prot-common-window-small-p'.

Apply ARGS expected by the underlying `display-buffer' functions.

This as the action function in a `display-buffer-alist' entry."
  (let ((functions (prot-window--get-display-buffer-below-or-pop)))
    (catch 'success
      (dolist (fn functions)
        (when (apply fn args)
          (throw 'success fn))))))

(defun prot-window-shell-or-term-p (buffer &amp;rest _)
  "Check if BUFFER is a shell or terminal.
This is a predicate function for `buffer-match-p', intended for
use in `display-buffer-alist'."
  (when (string-match-p "\\*.*\\(e?shell\\|v?term\\).*" (buffer-name (get-buffer buffer)))
    (with-current-buffer buffer
      ;; REVIEW 2022-07-14: Is this robust?
      (and (not (derived-mode-p 'message-mode 'text-mode))
           (derived-mode-p 'eshell-mode 'shell-mode 'comint-mode 'fundamental-mode)))))

(defun prot-window-remove-dedicated (&amp;rest _)
  "Remove dedicated window parameter.
Use this as :after advice to `delete-other-windows' and
`delete-window'."
  (when (one-window-p :no-mini)
    (set-window-dedicated-p nil nil)))

(mapc
 (lambda (fn)
   (advice-add fn :after #'prot-window-remove-dedicated))
 '(delete-other-windows delete-window))

(defmacro prot-window-define-full-frame (name &amp;rest args)
  "Define command to call ARGS in new frame with `display-buffer-full-frame' bound.
Name the function prot-window- followed by NAME.  If ARGS is nil,
call NAME as a function."
  (declare (indent 1))
  `(defun ,(intern (format "prot-window-%s" name)) ()
     ,(format "Call `prot-window-%s' in accordance with `prot-window-define-full-frame'." name)
     (interactive)
     (let ((display-buffer-alist '((".*" (display-buffer-full-frame)))))
       (with-selected-frame (make-frame)
         ,(if args
              `(progn ,@args)
            `(funcall ',name))
         (modify-frame-parameters nil '((buffer-list . nil)))))))

(defun prot-window--get-shell-buffers ()
  "Return list of `shell' buffers."
  (seq-filter
   (lambda (buffer)
     (with-current-buffer buffer
       (derived-mode-p 'shell-mode)))
   (buffer-list)))

(defun prot-window--get-new-shell-buffer ()
  "Return buffer name for `shell' buffers."
  (if-let* ((buffers (prot-window--get-shell-buffers))
            (buffers-length (length buffers))
            ((&gt;= buffers-length 1)))
      (format "*shell*&lt;%s&gt;" (1+ buffers-length))
    "*shell*"))

;;;###autoload (autoload 'prot-window-shell "prot-window")
(prot-window-define-full-frame shell
  (let ((name (prot-window--get-new-shell-buffer)))
    (shell name)
    (set-frame-name name)
    (when-let* ((buffer (get-buffer name)))
      (with-current-buffer buffer
        (add-hook
         'delete-frame-functions
         (lambda (_)
           ;; FIXME 2023-09-09: Works for multiple frames (per
           ;; `make-frame-command'), but not if the buffer is in two
           ;; windows in the same frame.
           (unless (&gt; (safe-length (get-buffer-window-list buffer nil t)) 1)
             (let ((kill-buffer-query-functions nil))
               (kill-buffer buffer))))
         nil
         :local)))))

;;;###autoload (autoload 'prot-window-coach "prot-window")
(prot-window-define-full-frame coach
  (let ((buffer (get-buffer-create "*scratch for coach*")))
    (with-current-buffer buffer
      (funcall initial-major-mode))
    (display-buffer buffer)
    (set-frame-name "Coach")))

;; REVIEW 2023-06-25: Does this merit a user option?  I don't think I
;; will ever set it to the left.  It feels awkward there.
(defun prot-window-scroll-bar-placement ()
  "Control the placement of scroll bars."
  (when scroll-bar-mode
    (setq default-frame-scroll-bars 'right)
    (set-scroll-bar-mode 'right)))

(add-hook 'scroll-bar-mode-hook #'prot-window-scroll-bar-placement)

(defun prot-window-no-minibuffer-scroll-bar (frame)
  "Remove the minibuffer scroll bars from FRAME."
  (set-window-scroll-bars (minibuffer-window frame) nil nil nil nil :persistent))

(add-hook 'after-make-frame-functions 'prot-window-no-minibuffer-scroll-bar)

;;;; Run commands in a popup frame (via emacsclient)

(defun prot-window-delete-popup-frame (&amp;rest _)
  "Kill selected selected frame if it has parameter `prot-window-popup-frame'.
Use this function via a hook."
  (when (frame-parameter nil 'prot-window-popup-frame)
    (delete-frame)))

(defmacro prot-window-define-with-popup-frame (command)
  "Define function which calls COMMAND in a new frame.
Make the new frame have the `prot-window-popup-frame' parameter."
  `(defun ,(intern (format "prot-window-popup-%s" command)) ()
     ,(format "Run `%s' in a popup frame with `prot-window-popup-frame' parameter.
Also see `prot-window-delete-popup-frame'." command)
     (interactive)
     (let ((frame (make-frame '((prot-window-popup-frame . t)))))
       (select-frame frame)
       (switch-to-buffer " prot-window-hidden-buffer-for-popup-frame")
       (condition-case nil
           (call-interactively ',command)
         ((quit error user-error)
          (delete-frame frame))))))

(declare-function org-capture "org-capture" (&amp;optional goto keys))
(defvar org-capture-after-finalize-hook)

;;;###autoload (autoload 'prot-window-popup-org-capture "prot-window")
(prot-window-define-with-popup-frame org-capture)

(declare-function tmr "tmr" (time &amp;optional description acknowledgep))
(defvar tmr-timer-created-functions)

;;;###autoload (autoload 'prot-window-popup-tmr "prot-window")
(prot-window-define-with-popup-frame tmr)

(provide 'prot-window)
;;; prot-window.el ends here
</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-h:cc8b8fac-b9d4-4a61-a69b-a0c93efa254d" class="outline-2">
<h2 id="h:cc8b8fac-b9d4-4a61-a69b-a0c93efa254d"><span class="section-number-2">7.</span> Frequently Asked Questions (FAQ)</h2>
<div class="outline-text-2" id="text-h:cc8b8fac-b9d4-4a61-a69b-a0c93efa254d">
</div>
<div id="outline-container-h:74c3a9e1-6852-4307-b7ba-925d8d2f61ff" class="outline-3">
<h3 id="h:74c3a9e1-6852-4307-b7ba-925d8d2f61ff"><span class="section-number-3">7.1.</span> Why many modules instead of one init.el?</h3>
<div class="outline-text-3" id="text-h:74c3a9e1-6852-4307-b7ba-925d8d2f61ff">
<p>
[ This question is in relation to the <a href="#h:103d6f5a-bdb1-4b49-946a-708a83c79a7d">the anatomy of my Emacs configuration</a>. ]
</p>

<p>
I prefer to keep things separate by splitting them into modules and
custom libraries. Smaller files are easier to work with, including
from the command line or with a generic text editor. They are also
easier to share with others, which I do frequently.
</p>

<p>
A large file is fully dependent on the capabilities of Emacs. This is
fine if you know your way around. But it does not work for people of
different skill levels. Remember that I am sharing my configuration
and keeping everything well documented to help others learn. The
target audience is not Emacs veterans. I cannot expect an
inexperienced user to already be familiar with how to navigate the
outline, narrow to a defun, jump back to a mark, and so on, just to
navigate one massive file.
</p>

<p>
Furthermore, I am not convinced by the argument that loading one large
<code>init.el</code> is more efficient than loading many smaller modules. The
reason is that the init file will anyway have multiple <code>require</code> calls
or use autoloaded functions which themselves load all those other
files. If, say, you are anyway loading a ~100 files through your
<code>init.el</code>, do a few extra files really affect performance at startup?
And if yes, is this enough to forgo the aforementioned usability and
accessibility considerations?
</p>

<p>
Thoe granted, my current setup <b>does not make me dependent on Org</b>
because I can at any moment stop editing this <code>prot-emacs.org</code> file
and continue my work in the many small files I already have.
</p>
</div>
</div>
<div id="outline-container-h:2d28a65c-bef6-4829-89d9-aef3581da7cd" class="outline-3">
<h3 id="h:2d28a65c-bef6-4829-89d9-aef3581da7cd"><span class="section-number-3">7.2.</span> Why use Org when you can have an outline in Elisp?</h3>
<div class="outline-text-3" id="text-h:2d28a65c-bef6-4829-89d9-aef3581da7cd">
<p>
[ Also read: <a href="#h:74c3a9e1-6852-4307-b7ba-925d8d2f61ff">Why many modules instead of one init.el?</a> ]
</p>

<p>
This question is about the use of the built-in <code>outline-minor-mode</code> or
the <code>outshine</code> package (<a href="#h:ffff5f7b-a62b-4d4a-ae29-af75402e5c35">The <code>prot-emacs-langs.el</code> settings for <code>outline-minor-mode</code></a>).
They provide folding capabilities like those of Org mode and can, in
principle, be enabled in any buffer (provided it has a recognisable
outline).
</p>

<p>
I am, in fact, using outlines in all my Elisp files. Not just here,
but also in all my public-facing Emacs packages. You can spot the
entries to the outline as comments that have three or more delimiters.
I can thus visit the <code>.el</code> file I am interested in and enable
<code>outline-minor-mode</code> to get the folding capabilities and extras.
Furthermore, I can use the <code>consult-outline</code> or <code>prot-search-outline</code>
command to navigate to a heading with minibuffer completion.
</p>

<p>
What the <code>prot-emacs.org</code> provides is an <i>optional single point of
entry</i> to my Emacs configuration. I use this to produce all the
individual files (<a href="#h:103d6f5a-bdb1-4b49-946a-708a83c79a7d">Anatomy of my Emacs configuration</a>). It allows me to
document my comprehensive corpus of work for the benefit of the Emacs
community at-large:
</p>

<ul class="org-ul">
<li>I can establish links between sections and use richer typography,
something that <code>outline-minor-mode</code> does not provide.</li>

<li>The extensive commentary included herein is not added to the source
code, thus making it easier for me or others to focus on the
programming parts when we want to.</li>

<li>This document is exported to my website as a standalone web page.
People can find what they need there and share it with friends,
regardless of their skill level.</li>

<li>Anyone may read the source of this file to learn more about the
technicalities of how this is done. And they can still use only the
<code>.el</code> files, if they do not want to deal with Org. Everybody is
covered.</li>
</ul>

<p>
The <code>prot-emacs.org</code> <b>does not introduce a dependency on Org mode</b>.
This file is not loaded at startup. I can remove <code>prot-emacs.org</code> at
any moment and my setup will continue to work. This arrangement is so
effective that I might actually convert the entirety of my dotfiles to
it (long-term though, as it is a lot of work to document everything).
</p>
</div>
</div>
<div id="outline-container-h:b35ab88e-3ce7-4412-a8ec-135eed9262d0" class="outline-3">
<h3 id="h:b35ab88e-3ce7-4412-a8ec-135eed9262d0"><span class="section-number-3">7.3.</span> Why do you use multiple <code>setq</code> instead of one?</h3>
<div class="outline-text-3" id="text-h:b35ab88e-3ce7-4412-a8ec-135eed9262d0">
<p>
This question is about the following pattern:
</p>

<pre class="example" id="org0914f64">
;; I usually have this:
(setq var-1 val-1)
(setq var-2 val-2)
(setq var-3 val-3)

;; But why not this for everything?
(setq var-1 val-1
      var-2 val-2
      var-3 val-3)
</pre>

<p>
I actually use both approaches. To me, the latter is better when I
want to say &ldquo;these go together&rdquo;, while the former makes it easier for
me to copy-paste what I need when communicating with someone.
</p>

<p>
Furthermore, the single <code>setq</code> call is harder to read when (i) there
are lots of variables involved and/or (ii) the values are longer lists
which themselves take some effort to figure out.
</p>
</div>
</div>
<div id="outline-container-h:6b6778af-8bd2-4f97-a794-e23774aa6cf3" class="outline-3">
<h3 id="h:6b6778af-8bd2-4f97-a794-e23774aa6cf3"><span class="section-number-3">7.4.</span> Why don&rsquo;t you remap keys?</h3>
<div class="outline-text-3" id="text-h:6b6778af-8bd2-4f97-a794-e23774aa6cf3">
<p>
This is about the following pattern:
</p>

<pre class="example" id="orga416296">
(define-key some-map [remap old-command] #'new-command)
</pre>

<p>
This is a good way to replace in situ a command you don&rsquo;t use for the
one you want. The problem is that it is not didactic for new users.
The person reading my code will not know which key binding I am
referencing. Sure, they can type <code>C-h w</code> (<code>where-is</code> command) to
search for the command <i>in the current major mode</i>, but this too
requires some experience. Whereas an explicit key binding is self
explanatory.
</p>
</div>
</div>
<div id="outline-container-h:893f3735-ecb9-4e50-bb24-8389872aa650" class="outline-3">
<h3 id="h:893f3735-ecb9-4e50-bb24-8389872aa650"><span class="section-number-3">7.5.</span> Why not use Org block arguments in the properties drawer?</h3>
<div class="outline-text-3" id="text-h:893f3735-ecb9-4e50-bb24-8389872aa650">
<p>
The code blocks I define in this document have directives to tangle
their contents to files. I do this for each code block, though it is
possible to set the same settings inside the parent heading&rsquo;s
<code>PROPERTIES</code> drawer and achieve the same result.
</p>

<p>
The problem I have with that approach is that it is less discoverable
in a massive file like this one. People are not expected to read this
document from start to end. Instead, they will jump directly to the
section that is of interest to them (perhaps by performing a search).
They will thus skip past whatever parent heading declares the
arguments. Whereas the code block encapsulates its own data and thus
is self-documenting.
</p>
</div>
</div>
<div id="outline-container-h:5668958c-2fc0-4a38-bd1f-3e0c6484977d" class="outline-3">
<h3 id="h:5668958c-2fc0-4a38-bd1f-3e0c6484977d"><span class="section-number-3">7.6.</span> What hardware and software do you use?</h3>
<div class="outline-text-3" id="text-h:5668958c-2fc0-4a38-bd1f-3e0c6484977d">
<p>
I have a Lenovo ThinkPad T470. It is a second-hand laptop that I got
from Ebay courtesy of a generous donation by Anush V. I run Debian on
this laptop. I do not mind having older versions of system packages.
The only program I need to run an up-to-date version of is Emacs&#x2014;and
I compile that from source.
</p>

<p>
During the summer of 2023, I used the laptop to experiment with the
GNU Guix system but I eventually abandoned that project. Guix solves
problems that I do not have, while it does things very differently to
how other Unix-like systems are doing them. I cannot justify spending
a considerable amount of time for something I do not really need,
especially with the busy schedule I have.
</p>

<p>
I also use a desktop computer that I built in 2021 with donations I
got from the Emacs community. At the time, I had a Lenovo ThinkPad
X220 laptop as my sole computer: it broke and I posted an announcement
to the effect that I would not be available for a while. Then
donations started coming in and I was able to be back online after a
month or so. It was a special moment.
</p>

<p>
The desktop computer is more powerful: it cost me a bit less than 600
EUR to build it. Back then I did not know enough about hardware and
was able to assemble it with the help of a local who knows more about
computer hardware than I do (I have learnt since then and I can do it
myself now). I installed Arch when I first got this computer and it
has been stable ever since (Arch is reliable if you know what you are
doing).
</p>

<p>
In early 2024 I migrated my desktop to Debian. I did it because the
Internet connection at my hut is metered (I moved to the hut at the
end of summer 2023) and I did not want to spend a lot of data on
system maintenance. Arch never caused me any issues. It is a top tier
distro, as is Debian. Those are the two I trust the most.
</p>

<p>
On the laptop, I use the GNOME desktop environment. It is good for
keyboard usage, plus it has excellent support for the trackpad. On the
desktop, I normally use a tiling window manager. Wayland still does
not work 100% for me, so I prefer to stay on Xorg until further notice.
</p>

<p>
For many years, the keyboard I had on my desktop was a generic,
toy-grade, Qwerty model (I literally bought it from a toy store,
together with the mouse for ~10 EUR). In autumn 2023, Arialdo Martini
bought me the Keychron K5 Pro, which is a programmable keyboard with a
traditional, full-key form factor. While in early spring 2024
&ldquo;Andreas&rdquo; got me the Iris keyboards from Keebio, which is a more
ergonomic split design with a columnar stagger for how the keys are
arranged. I discuss this at greater length here:
<a href="https://protesilaos.com/news/2024-04-11-my-rsi-keyboard-ergonomics/">https://protesilaos.com/news/2024-04-11-my-rsi-keyboard-ergonomics/</a>.
I also write about mechanical keyboards and ergonomics on this section
of my website: <a href="https://protesilaos.com/keeb/">https://protesilaos.com/keeb/</a>.
</p>

<p>
Finally, I have a mobile phone that Dmitry Matveyev bought for me. It
is a Samsung A53 model. I run the factory operating system on it. I
have removed all apps that can be removed and use it only for its
camera and phone capabilities. I know I could run Emacs on android
(Emacs 30 has an Android build), but that is the sort of rabbit hole
I need to avoid.
</p>
</div>
</div>
<div id="outline-container-h:2d3c8fb5-f29b-4740-8f66-3055701d9baf" class="outline-3">
<h3 id="h:2d3c8fb5-f29b-4740-8f66-3055701d9baf"><span class="section-number-3">7.7.</span> What is your desktop setup?</h3>
<div class="outline-text-3" id="text-h:2d3c8fb5-f29b-4740-8f66-3055701d9baf">
<p>
You can check my dotfiles to find all about the tiling window managers
and other programs I use:
</p>

<ul class="org-ul">
<li>Git repositories:
<ul class="org-ul">
<li>GitHub: <a href="https://github.com/protesilaos/dotfiles">https://github.com/protesilaos/dotfiles</a></li>
<li>GitLab: <a href="https://gitlab.com/protesilaos/dotfiles">https://gitlab.com/protesilaos/dotfiles</a></li>
</ul></li>
</ul>

<p>
I have been using tiling window managers for most of my time on Linux
(I switched to Linux in the summer of 2016 and I think I started with
i3wm in 2017).
</p>
</div>
</div>
</div>
